---
name: Конфиденциальность в биткойне
goal: Понять и освоить принципы защиты конфиденциальности при использовании Bitcoin
objectives: 

  - Определите теоретические концепции, необходимые для понимания важности защиты частной жизни
  - Знать, как выявлять и снижать риски, связанные с потерей конфиденциальности пользователей Bitcoin
  - Использование методов и инструментов для защиты конфиденциальности в Bitcoin
  - Понимание методов анализа цепей и разработка стратегий защиты

---
# Защитите свою конфиденциальность в биткойне

В мире, где конфиденциальность финансовых операций постепенно становится роскошью, понимание и освоение принципов защиты конфиденциальности при использовании Bitcoin крайне важно. В этом курсе вы получите все теоретические и практические ключи для самостоятельного достижения этой цели.

Сегодня в сети Bitcoin существуют компании, которые специализируются на анализе цепочек. Их основная деятельность заключается именно в том, чтобы вторгаться в вашу частную жизнь, чтобы нарушить конфиденциальность ваших транзакций. На самом деле, "права на конфиденциальность" в биткойне не существует. Поэтому именно вы, пользователь, должны отстаивать свои естественные права и защищать конфиденциальность своих транзакций, потому что никто другой не сделает этого за вас.

Этот тренинг представлен как всеобъемлющий, универсальный курс. Каждое техническое понятие подробно описано и подкреплено поясняющими диаграммами. Цель - сделать знания доступными для всех. Поэтому BTC204 доступен для начинающих и средних пользователей. Этот курс также предлагает дополнительную ценность для более опытных биткоинщиков, поскольку мы углубляемся в некоторые часто незнакомые технические концепции.

Присоединяйтесь к нам, чтобы изменить свое использование биткойна и стать информированным пользователем, способным понять проблемы, связанные с конфиденциальностью, и защитить свою частную жизнь.

+++
# Введение

<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## Введение в обучение

<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

В мире, где конфиденциальность финансовых операций постепенно становится роскошью, понимание и освоение принципов защиты конфиденциальности при использовании Bitcoin крайне важно. В этом курсе вы получите все теоретические и практические ключи для самостоятельного достижения этой цели.

Сегодня в экосистеме биткоина существуют компании, которые специализируются на анализе блокчейна. Их основной бизнес заключается именно в том, чтобы вторгаться в вашу частную жизнь, ставя под угрозу конфиденциальность ваших транзакций. На самом деле, "права на приватность" в биткойне не существует. Поэтому именно вы, пользователь, должны отстаивать свои естественные права и защищать конфиденциальность своих транзакций, потому что никто другой не сделает этого за вас.

Биткойн существует не только для "Number Go Up" и сохранения ценности сбережений. Благодаря своим уникальным свойствам и истории, он в первую очередь является инструментом альтернативной экономики. Благодаря этому замечательному изобретению вы можете свободно распоряжаться своими деньгами, тратить их и накапливать, и никто не сможет вам помешать.

Биткойн предлагает мирное освобождение от ига государств, позволяя вам в полной мере воспользоваться своими естественными правами, которые не могут быть оспорены установленными законами. Благодаря изобретению Сатоши Накамото у вас есть возможность реализовать свое право на частную собственность и вернуть себе свободу заключения договоров.

Однако по умолчанию биткоин не анонимен, что может представлять опасность для лиц, занимающихся альтернативной экономикой, особенно в регионах с деспотическими режимами. Но это не единственная опасность. Поскольку биткоин - ценный и нецензурный актив, он может привлечь внимание воров. Поэтому защита конфиденциальности также становится вопросом безопасности: она поможет вам предотвратить кибератаки и физические нападения.

Как мы увидим, несмотря на то, что протокол предлагает определенные встроенные средства защиты конфиденциальности, крайне важно использовать дополнительные инструменты для оптимизации и защиты этой конфиденциальности. Этот курс разработан как всеобъемлющий, универсальный путь к пониманию проблем конфиденциальности в Биткойне. Каждое техническое понятие рассматривается подробно и подкрепляется поясняющими диаграммами. Цель - сделать знания доступными для всех, включая новичков и пользователей среднего уровня. Для более опытных биткоинистов мы также рассмотрим очень технические и иногда менее известные концепции в этом курсе, чтобы углубить понимание каждой темы.

Цель этого курса - не сделать вас полностью анонимным при использовании биткойна, а предоставить вам необходимые инструменты, чтобы вы знали, как защитить свою конфиденциальность в соответствии с вашими личными целями. У вас будет свобода выбора из представленных концепций и инструментов для разработки собственных стратегий, отвечающих вашим конкретным целям и потребностям.

### Раздел 1: Определения и ключевые понятия

Для начала мы вместе рассмотрим основы работы биткойна, а затем спокойно перейдем к понятиям, связанным с приватностью. Очень важно освоить некоторые базовые понятия, такие как UTXO, адреса получения или скрипты, прежде чем мы сможем полностью понять концепции, которые мы рассмотрим в следующих разделах. Мы также представим общую модель конфиденциальности Биткойна, как ее представлял Сатоши Накамото, что позволит нам понять проблемы и связанные с ними риски.

![BTC204](assets/it/11/1.webp)

### Раздел 2: Понимание цепного анализа и способы самозащиты

Во втором разделе мы изучим методы, используемые компаниями, занимающимися анализом блокчейна, для отслеживания вашей активности в Биткойне. Понимание этих методов очень важно для улучшения защиты вашей конфиденциальности. Цель этой части - изучить стратегии злоумышленников, чтобы лучше понять риски и заложить основу для техник, которые мы будем изучать в последующих разделах. Мы проанализируем шаблоны транзакций, внутренние и внешние эвристики, а также правдоподобные интерпретации этих шаблонов. Помимо теоретической составляющей, на практических примерах и упражнениях мы научимся использовать проводник блоков для анализа цепочек.

![BTC204](assets/fr/002.webp)

### Раздел 3: Овладение передовыми методами защиты конфиденциальности

В третьем разделе нашего курса мы переходим к самому главному: практике! Цель - освоить все основные лучшие практики, которые должны стать естественными рефлексами для любого пользователя Bitcoin. Мы рассмотрим использование свежих адресов, маркировку, консолидацию, использование полных узлов, а также KYC и методы приобретения. Цель состоит в том, чтобы предоставить вам полный обзор подводных камней, которых следует избегать, чтобы заложить прочный фундамент в нашем стремлении к защите конфиденциальности. Для некоторых из этих практик вам будет предложено конкретное руководство по их применению.

![BTC204](assets/it/11/3.webp)

### Раздел 4: Понимание транзакций Coinjoin

Как можно говорить о конфиденциальности биткоинов, не обсудив coinjoin? В разделе 4 вы узнаете все, что нужно знать об этом способе смешивания. Вы узнаете, что такое коинджойн, его историю и цели, а также различные типы коинджойн, которые существуют. Наконец, для более опытных пользователей мы выясним, что такое анонсеты и энтропия, а также как рассчитать эти показатели.

![BTC204](assets/it/11/4.webp)

### Раздел 5: Понимание проблем, связанных с другими передовыми методами обеспечения конфиденциальности

В пятом разделе мы представим обзор всех других существующих техник для защиты конфиденциальности в Биткойне, помимо coinjoin. За прошедшие годы разработчики проявили немалую изобретательность в создании инструментов, предназначенных для защиты конфиденциальности. Мы рассмотрим все эти методы, такие как payjoin, совместные транзакции, Coin Swap и Atomic Swap, подробно описав, как они работают, их цели и потенциальные недостатки.

Мы также рассмотрим конфиденциальность на уровне сети узлов и распространение транзакций. Мы также обсудим различные протоколы, которые были предложены в течение многих лет для улучшения конфиденциальности пользователей Bitcoin, включая протоколы статических адресов.

![BTC204](assets/fr/005.webp)

# Определения и ключевые понятия

<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>

## Модель биткойна UTXO

<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>

Биткойн - это прежде всего валюта, но знаете ли вы, как конкретно BTC представлен в протоколе?

### UTXO биткоина: что это такое?

В протоколе биткойна управление денежными единицами основано на модели UTXO, которая расшифровывается как "_Unspent Transaction Output_"

Эта модель кардинально отличается от традиционных банковских систем, которые опираются на механизм счетов и балансов для отслеживания финансовых потоков. Фактически, в банковской системе индивидуальные балансы хранятся на счетах, привязанных к личности. Например, когда вы покупаете багет у пекаря, ваш банк просто списывает сумму покупки с вашего счета, тем самым уменьшая ваш баланс, а на счет пекаря зачисляется та же сумма, увеличивая его баланс. В этой системе нет понятия связи между деньгами, поступающими на ваш счет, и деньгами, уходящими с него, кроме записей о транзакциях.

В биткойне все работает по-другому. Понятия счета не существует, а денежные единицы управляются не через балансы, а через UTXO. UTXO представляет собой определенную сумму биткойнов, которая еще не была потрачена, образуя таким образом "часть биткойна", которая может быть большой или маленькой. Например, UTXO может стоить как `500 BTC`, так и всего `700 SATS`.

**> Напоминание:** Сатоши, часто сокращаемый до сата, - это наименьшая единица биткойна, сопоставимая с копейкой в фиатных валютах.

```plaintext
1 BTC = 100,000,000 SATS
```

Теоретически UTXO может представлять любую стоимость в биткоинах, начиная от сата и заканчивая теоретическим максимумом в 21 миллион BTC. Однако логически невозможно владеть всеми 21 млн биткоинов, и существует нижний экономический порог, называемый "пылью", ниже которого UTXO считается экономически невыгодным для расходования.

**>Знаете ли вы? ** Крупнейшая UTXO, когда-либо созданная на Bitcoin, имела стоимость `500 000 BTC`. Он был создан платформой MtGox во время операции по консолидации в ноябре 2011 года: [29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXO и условия расходования средств

UTXO - это средства обмена в Биткойне. Каждая транзакция включает в себя потребление UTXO в качестве входных данных и создание новых UTXO в качестве выходных данных. Когда транзакция совершается, UTXO, использованные в качестве входных данных, считаются "потраченными", а новые UTXO генерируются и назначаются получателям, указанным в выходных данных транзакции. Таким образом, UTXO просто представляет собой неизрасходованный выход транзакции и, следовательно, количество биткойнов, принадлежащих пользователю в данный момент времени.

![BTC204](assets/it/21/2.webp)

Все UTXO защищены сценариями, которые определяют условия, при которых они могут быть израсходованы. Чтобы израсходовать UTXO, пользователь должен продемонстрировать сети, что он или она соответствует условиям, установленным сценарием, защищающим этот UTXO. Как правило, UTXO защищены открытым ключом (или адресом получения, представляющим этот открытый ключ). Чтобы использовать UTXO, связанный с этим открытым ключом, пользователь должен доказать, что он владеет соответствующим закрытым ключом, предоставив цифровую подпись, сделанную с помощью этого ключа. Именно поэтому говорят, что ваш биткоин-кошелек на самом деле не содержит биткоинов, а скорее хранит ваши закрытые ключи, которые, в свою очередь, дают вам доступ к вашим UTXO и, соответственно, к биткоинам, которые они представляют.

![BTC204](assets/it/21/3.webp)

Поскольку понятие счета в Биткойне отсутствует, баланс кошелька - это просто сумма значений всех UTXO, которые он может потратить. Например, если ваш биткойн-кошелек может потратить следующие 4 UTXO:

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

Общий баланс вашего кошелька составит `17 BTC`.

![BTC204](assets/it/21/4.webp)

## Структура транзакций биткойна

<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>

### Входы и выходы транзакции

Биткойн-транзакция - это операция, записанная в блокчейне, которая позволяет передать право собственности на биткойны от одного лица к другому. Более конкретно, поскольку мы находимся в модели UTXO и не имеем счетов, транзакция удовлетворяет условиям расходования, которые защищали один или несколько UTXO, расходует их и, эквивалентно, создает новые UTXO, оснащенные новыми условиями расходования. Короче говоря, транзакция перемещает биткоины из сценария, который был удовлетворен, в новый сценарий, предназначенный для их защиты.

![BTC204](assets/it/22/1.webp)

Таким образом, каждая транзакция Bitcoin состоит из одного или нескольких входов и одного или нескольких выходов. Входы - это UTXO, потребляемые транзакцией для создания выходов. Выходы - это новые UTXO, которые будут использоваться в качестве входов для будущих транзакций.

![BTC204](assets/it/22/2.webp)

**> Знаете ли вы? ** Теоретически транзакция биткоина может иметь бесконечное количество входов и выходов. Только максимальный размер блока ограничивает это число. Каждый вход в биткойн-транзакции ссылается на предыдущий неизрасходованный UTXO (Unspent Transaction Output). Чтобы использовать UTXO в качестве входа, его владелец должен доказать, что он является законным владельцем, подтвердив связанную с ним крипту, т. е. выполнив наложенное условие расходования. Как правило, для этого необходимо предоставить цифровую подпись, созданную с помощью закрытого ключа, соответствующего открытому ключу, которым изначально был обеспечен данный UTXO. Затем сценарий проверяет соответствие подписи открытому ключу, использованному при получении средств.

В каждом выводе, с другой стороны, указывается сумма биткоина, которую необходимо перевести, а также получатель. Последний определяется новым скриптом, который обычно блокирует только что созданный UTXO с адресом получателя или новым открытым ключом.

Чтобы транзакция считалась действительной в соответствии с правилами консенсуса, общее количество выходов должно быть меньше или равно общему количеству входов. Другими словами, сумма новых UTXO, генерируемых транзакцией, не должна превышать сумму UTXO, потребляемых в качестве входов. Этот принцип логичен: если у вас есть только сумма в `500 000 SATS`, вы не можете совершить покупку на `700 000 SATS`.

### Обмен и консолидация в сделке с биткойнами

Таким образом, действие биткойн-транзакции на UTXO можно сравнить с переплавкой золотой монеты. На самом деле, UTXO не делится, а только объединяется. Это означает, что пользователь не может просто разделить UTXO, представляющий определенную сумму биткоинов, на несколько меньших UTXO. Он должен полностью израсходовать его в ходе транзакции, чтобы создать на выходе один или несколько новых UTXO произвольной стоимости, которая должна быть меньше или равна первоначальной.

Этот механизм похож на механизм золотой монеты. Представьте, что вы владеете монетой в 2 унции и хотите заплатить 1 унцию, предполагая, что продавец не может дать вам сдачу. Вам придется переплавить свою монету и отчеканить 2 новые монеты по 1 унции каждая.

С биткоином операция аналогична. Предположим, у Алисы есть UTXO в размере `10 000 SATS` и она хочет купить багет стоимостью `4 000 SATS`. Алиса совершит транзакцию с входом в 1 UTXO стоимостью `10 000 SATS`, который она полностью израсходует, а на выходе создаст 2 UTXO стоимостью `4 000 SATS` и `6 000 SATS`. UTXO в размере `4 000 SATS` будет отправлен пекарю в качестве оплаты за багет, а UTXO в размере `6 000 SATS` вернется к Алисе в качестве сдачи. Этот UTXO, который возвращается к первоначальному отправителю транзакции, на жаргоне биткойна называется "сдачей".

Теперь представьте, что у Алисы не один UTXO на `10 000 SATS`, а два UTXO на `3 000 SATS` каждый. В этой ситуации ни одного из отдельных UTXO не хватит, чтобы покрыть `4 000 SATS` за багет. Поэтому Алиса должна использовать оба UTXO по `3 000 SATS` в качестве входных данных для своей операции одновременно. Таким образом, общая сумма вложений достигнет `6 000 SATS`, что позволит ей покрыть платеж булочнику в размере `4 000 SATS`. Этот метод, предполагающий объединение нескольких UTXO во входы одной операции, часто называют `консолидацией`.

### Комиссионные за транзакции

Интуитивно можно подумать, что комиссия за транзакцию также представляет собой результат сделки. Но в действительности это не так. Комиссионные за транзакции представляют собой разницу между суммарными входами и суммарными выходами. Это означает, что после использования части стоимости входов для покрытия желаемых выходов в сделке определенная сумма входов остается неиспользованной. Эта оставшаяся сумма и составляет комиссионные за транзакцию.

```plaintext
Commissioni = input totali - output totali
```

Вернемся к примеру Алисы, у которой UTXO составляет `10 000 SATS` и которая хочет купить багет за `4 000 SATS`. Алиса создает транзакцию со своим UTXO в размере `10 000 SATS` в качестве входа. Затем она генерирует выходную сумму в `4 000 SATS`, предназначенную пекарю для оплаты багета. Чтобы побудить майнеров включить ее транзакцию в блок, Алиса назначает `200 SATS` в качестве комиссии. При этом она создает второй вывод, остаток, который будет ей возвращен, в размере `5 800 SATS`.

Применяя формулу комиссии, мы видим, что у шахтеров осталось `200 SATS`:

```plaintext
Commissioni = input totali - output totali
Spese = 10.000 - (4.000 + 5.800)
Spese = 10.000 - 9.800
Spese = 200
```

Когда майнер успешно подтверждает блок, он имеет право получить эти сборы за все транзакции, включенные в его блок, посредством так называемой транзакции "coinbase".

### Создание UTXO на биткойне

Если вы внимательно следили за предыдущими пунктами, то теперь знаете, что UTXO могут быть созданы только путем потребления других существующих UTXO. Таким образом, монеты Bitcoin образуют непрерывную цепочку. Однако вам может быть интересно, как в этой цепочке появились первые UTXO. В связи с этим возникает проблема, похожая на проблему курицы и яйца: откуда взялись эти первоначальные UTXO?

Ответ кроется в **транзакциях на базе криптовалюты **.

Coinbase - это особый тип транзакции биткоина, уникальный для каждого блока и всегда первый в нем. Она позволяет майнеру, нашедшему достоверное доказательство работы, получить вознаграждение за блок. Это вознаграждение состоит из двух элементов: **блокчейн-гранта** и **комиссии за транзакцию**, о которых мы говорили в предыдущей части.

Уникальность транзакции coinbase заключается в том, что она единственная способна создавать биткоины из ничего, без необходимости потреблять исходные данные для генерации своих результатов. Эти вновь созданные биткоины представляют собой то, что можно назвать "оригинальными UTXO"

Биткоины из блокчейна - это новые BTC, созданные из воздуха в соответствии с заранее определенным графиком эмиссии в правилах консенсуса. Субсидия на блокчейн уменьшается вдвое каждые 210 000 блоков, примерно раз в четыре года, в процессе, называемом "халвинг" Изначально за одну субсидию создавалось 50 биткоинов, но постепенно это количество уменьшилось; в настоящее время оно составляет 3 125 биткоинов за блок.

Что касается платы за транзакции, то, хотя она и представляет собой вновь созданные BTC, она не должна превышать разницу между суммарными входами и выходами всех транзакций в блоке. Ранее мы видели, что эти сборы представляют собой часть входных данных, которая не используется в выходных данных транзакций. Эта часть технически "теряется" во время транзакции, и майнер имеет право воссоздать эту стоимость в виде одного или нескольких новых UTXO. Таким образом, это передача стоимости от отправителя транзакции к майнеру, который добавляет ее в блокчейн.

**> Знаете ли вы? ** Биткоины, созданные в результате транзакции на coinbase, подлежат периоду созревания в 100 блоков, в течение которого они не могут быть потрачены майнером. Это правило призвано избежать осложнений, связанных с использованием только что созданных биткоинов в цепочке, которая впоследствии может устареть.

### Последствия модели UTXO

Во-первых, модель UTXO напрямую влияет на комиссию за транзакции в Биткойне. Поскольку емкость каждого блока ограничена, майнеры отдают предпочтение транзакциям, предлагающим наилучшую плату по отношению к месту, которое они займут в блоке. Фактически, чем больше UTXO включает в себя транзакция в качестве входных и выходных данных, тем она тяжелее и, следовательно, требует более высоких комиссий. Это одна из причин, почему часто предпринимаются попытки уменьшить количество UTXO в нашем портфеле, что также может повлиять на конфиденциальность, и эту тему мы подробно рассмотрим в третьей части этого курса.

Далее, как уже говорилось в предыдущих частях, монеты Bitcoin представляют собой цепочку UTXO. Каждая транзакция, таким образом, создает связь между прошлым UTXO и будущим UTXO. Таким образом, UTXO позволяют четко проследить путь биткоинов от их создания до расходования в настоящий момент. Такая прозрачность может рассматриваться положительно, поскольку позволяет каждому пользователю убедиться в подлинности полученных биткоинов. Однако именно на этом принципе отслеживаемости и проверяемости основан анализ цепочек - практика, призванная нарушить вашу конфиденциальность. Мы подробно рассмотрим эту практику во второй части обучения.

## Модель конфиденциальности биткойна

<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>

### Валюта: Подлинность, целостность и двойная трата

Одна из функций валюты - решение проблемы двойного совпадения желаний. В системе, основанной на бартере, для совершения обмена необходимо не только найти человека, предлагающего товар, удовлетворяющий мою потребность, но и предоставить ему товар эквивалентной стоимости, удовлетворяющий его потребность. Нахождение такого баланса оказывается сложной задачей.

Именно поэтому используется валюта, которая позволяет передавать стоимость как в пространстве, так и во времени.

Для того чтобы валюта решила эту проблему, необходимо, чтобы сторона, предоставляющая товар или услугу, была уверена в своей способности потратить эту сумму позже. Поэтому любой рациональный человек, желающий принять ту или иную форму валюты, будь то цифровая или физическая, убедится, что она соответствует двум основным критериям:


- Монета должна быть неповрежденной и подлинной;**- **и не должна быть потрачена дважды.**

При использовании физической валюты первая характеристика является наиболее сложной для подтверждения. В разные исторические периоды целостность металлических монет часто нарушалась в результате таких действий, как обрезание или пробивание. Например, в Древнем Риме граждане часто обдирали края золотых монет, чтобы собрать часть драгоценного металла и сохранить их для будущих сделок. Таким образом, внутренняя стоимость монеты уменьшалась, но ее номинал оставался прежним. Возможно, именно по этой причине позже по краю монет стали чеканить полосы.

Подлинность также трудно проверить физическими денежными средствами. Сегодня методы борьбы с подделками становятся все более сложными, что вынуждает торговцев вкладывать средства в дорогостоящие системы проверки.

С другой стороны, в силу своей природы двойная оплата не является проблемой для физических валют. Если я даю вам купюру в 10 евро, она безвозвратно покидает мое владение и переходит в ваше, что, разумеется, исключает любую возможность потратить одни и те же денежные единицы несколько раз. Короче говоря, я не смогу снова потратить эти 10 евро.

С цифровой валютой все обстоит иначе. Обеспечить подлинность и целостность монеты зачастую проще. Как мы видели в предыдущем разделе, модель UTXO в биткойне позволяет отследить происхождение монеты и тем самым убедиться, что она действительно была создана в соответствии с правилами консенсуса майнером.

Однако обеспечить отсутствие двойной оплаты сложнее, поскольку любой цифровой товар по сути является информацией. В отличие от физических товаров, информация не делится при обмене, а распространяется путем умножения. Например, если я отправляю вам документ по электронной почте, он дублируется. Со своей стороны, вы не можете с уверенностью убедиться, что я удалил оригинал документа.

### Предотвращение двойных платежей в биткойне

Единственный способ избежать дублирования цифровых активов - быть в курсе всех обменов в системе. Таким образом, вы сможете знать, кто чем владеет, и обновлять информацию о владении каждого на основе совершенных транзакций. Именно так, например, поступают с криптовалютными деньгами в банковской системе. Когда вы платите 10 евро торговцу с помощью кредитной карты, банк фиксирует этот обмен и обновляет бухгалтерскую книгу.

В биткойне предотвращение двойных платежей осуществляется аналогичным образом. Задача состоит в том, чтобы подтвердить отсутствие транзакции, в которой уже были потрачены соответствующие монеты. Если эти монеты никогда не использовались, то мы можем быть уверены, что двойного платежа не произойдет. Этот принцип был описан Сатоши Накамото в "Белой книге" знаменитым предложением:

**"Единственный способ подтвердить отсутствие транзакции - это быть в курсе всех транзакций "**

Однако, в отличие от банковской модели, в Bitcoin нет желания доверять центральному органу. Необходимо, чтобы все пользователи могли подтвердить отсутствие двойного платежа, не полагаясь на третью сторону. Поэтому все должны быть в курсе всех транзакций Bitcoin. Именно поэтому транзакции Bitcoin публично транслируются на всех узлах сети и записываются открытым текстом в блокчейн.

Именно такое публичное распространение информации усложняет защиту конфиденциальности в биткойне. В традиционной банковской системе, теоретически, только финансовое учреждение знает о совершенных транзакциях. С другой стороны, в Биткойне все пользователи получают информацию обо всех транзакциях через соответствующие узлы.

### Модель конфиденциальности: банковская система против биткойна

В традиционной системе банковский счет связан с вашей личностью. Банкир может знать, какому клиенту принадлежит тот или иной банковский счет и какие операции с ним связаны. Однако этот поток информации прерывается между банком и общественным достоянием. Другими словами, невозможно узнать баланс и операции по банковскому счету, который принадлежит другому человеку. Только банк имеет доступ к этой информации.

Например, ваш банкир знает, что вы каждое утро покупаете багет в соседней пекарне, но ваш сосед не знает об этой операции. Таким образом, поток информации доступен заинтересованным сторонам, в частности банку, но остается недоступным для посторонних.

Из-за ограничения публичного распространения транзакций, которое мы рассмотрели в предыдущей части, модель конфиденциальности Биткойна не может следовать модели банковской системы. В случае с биткойном, поскольку поток информации не может быть прерван между транзакциями и публичным достоянием, **модель конфиденциальности основана на разделении личности пользователя и самих транзакций**.

Например, если вы покупаете багет у булочника, расплачиваясь BTC, ваш сосед, владеющий собственным полным узлом, может видеть, как проходит ваша транзакция, точно так же, как и все остальные транзакции в системе. Однако при соблюдении принципов конфиденциальности он не должен иметь возможности связать эту конкретную транзакцию с вашей личностью.

Но поскольку транзакции биткоина являются публичными, становится возможным установить связи между ними, чтобы получить информацию об участниках. Это занятие даже представляет собой отдельную специальность под названием "анализ цепочек" В следующей части курса я предлагаю вам изучить основы анализа цепочек, чтобы понять, как отслеживаются ваши биткоины, и знать, как лучше защититься.

# Анализ цепей и способы защиты

<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## Что такое цепной анализ биткойна?

<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>

### Определение и работа

Анализ цепочек - это практика, которая включает в себя все методы, используемые для отслеживания потока биткоинов в блокчейне. Как правило, анализ цепочки основан на наблюдении особенностей в образцах предыдущих транзакций. Затем он предполагает выявление этих же особенностей в транзакции, которую необходимо проанализировать, и вывод правдоподобных интерпретаций. Этот метод решения проблем с практической точки зрения, позволяющий найти достаточно хорошее решение, называется "эвристикой"

Для упрощения анализ цепочки проводится в три основных этапа:

1. ** Наблюдение за блокчейном;**

2. **Определите известные характеристики;**

3. **Обучающие предположения.**

Анализ блокчейна может выполнить любой человек. Достаточно иметь доступ к публичной информации блокчейна через полноценный узел, чтобы наблюдать за движением транзакций и делать предположения. Существуют и бесплатные инструменты, облегчающие такой анализ, например сайт [OXT.me](https://oxt.me/), который мы подробно рассмотрим в двух последних главах этой части. Однако основной риск конфиденциальности исходит от компаний, специализирующихся на анализе цепочек. Эти компании довели анализ цепочек до промышленных масштабов и продают свои услуги финансовым учреждениям или правительствам. Среди таких компаний Chainalysis, пожалуй, самая известная.

### Цели цепного анализа

Одна из целей анализа цепочек - сгруппировать различные действия с Bitcoin, чтобы определить уникальность пользователя, который их совершил. Затем можно будет попытаться связать этот набор действий с реальной личностью.

Вспомните предыдущую главу. Я объяснил, почему модель конфиденциальности Биткойна изначально была основана на отделении личности пользователя от его транзакций. Поэтому было бы заманчиво считать, что анализ цепочки бесполезен, поскольку даже если вы можете сгруппировать действия на цепочке, они не могут быть связаны с реальной личностью.

Теоретически это утверждение верно. В первой части этого курса мы увидели, что для установления условий на UTXO используются пары криптографических ключей. По своей сути эти пары ключей не раскрывают никакой информации о личности их владельцев. Таким образом, даже если нам удастся сгруппировать действия, связанные с разными парами ключей, это ничего не скажет нам о субъекте, стоящем за этими действиями.

Однако практическая реальность гораздо сложнее. Существует множество моделей поведения, которые рискуют связать реальную личность с деятельностью в ончейн. В аналитике это называется точкой входа, и их очень много.

Самым распространенным, конечно, является KYC (_Know Your Customer_). Если вы выводите свои биткоины с регулируемой платформы на один из ваших личных адресов получения, то некоторые люди могут связать вашу личность с этим адресом. В более общем случае точкой входа может быть любая форма взаимодействия между вашей реальной жизнью и биткойн-транзакцией. Например, если вы публикуете адрес получения в своих социальных сетях, это может стать точкой входа для анализа. Если вы совершаете биткойн-платеж своему пекарю, он может связать ваше лицо (которое является частью вашей личности) с биткойн-адресом.

Эти точки входа практически неизбежны при использовании Bitcoin. Хотя вы можете попытаться ограничить сферу их действия, они все равно будут присутствовать. Поэтому очень важно сочетать методы, направленные на сохранение конфиденциальности. Хотя сохранение разделения между вашей реальной личностью и вашими транзакциями является привлекательным подходом, сегодня он остается недостаточным. Ведь если все ваши действия в ончейне можно сгруппировать, то малейшая точка проникновения, скорее всего, поставит под угрозу тот единственный уровень конфиденциальности, который вы создали.

### Защита от цепного анализа

Поэтому при использовании биткойна необходимо также уметь обращаться к анализу блокчейна. Действуя таким образом, мы сможем свести к минимуму агрегирование наших действий и ограничить влияние точки входа на нашу конфиденциальность.

На самом деле, чтобы лучше противостоять анализу блокчейна, что может быть лучше, чем ознакомиться с методами, используемыми в анализе блокчейна? Если вы хотите знать, как улучшить свою конфиденциальность в Биткойне, вам нужно понять эти методы. Это позволит вам лучше понять такие методы, как coinjoin или payjoin (методы, которые мы будем изучать в последних частях обучения), и уменьшить количество ошибок, которые вы можете совершить.

В этом контексте можно провести аналогию с криптографией и криптоанализом. Хороший криптограф - это прежде всего хороший криптоаналитик. Чтобы разработать новый криптографический алгоритм, необходимо знать, каким атакам он будет подвергаться, а также изучить, почему предыдущие алгоритмы были взломаны. Тот же принцип применим и к конфиденциальности в биткоине. Понимание методов анализа блокчейна - это ключ к защите от него. Именно поэтому я предлагаю целый раздел по анализу блокчейна в этом тренинге.

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/fr/tutorials/privacy/on-chain/payjoin-848b6a23-deb2-4c5f-a27e-93e2f842140f
### Методы анализа блокчейна

Важно понимать, что анализ блокчейна не является точной наукой. Он опирается на эвристику, полученную из предыдущих наблюдений или логических интерпретаций. Эти правила позволяют получить достаточно надежные результаты, но никогда - с абсолютной точностью. Другими словами, **анализ блокчейна всегда включает в себя измерение вероятности в выдаваемых выводах**. Например, можно с большей или меньшей степенью уверенности предположить, что два адреса принадлежат одному и тому же субъекту, но полная уверенность всегда будет недостижима.

Основная цель анализа блокчейна заключается именно в агрегировании различных эвристик с целью минимизации риска ошибки. Это, в некотором смысле, накопление доказательств, позволяющее приблизиться к реальности.

Эти знаменитые эвристики можно разделить на несколько категорий, о которых мы расскажем подробнее:


- Модели транзакций (или транзакционные модели);**
- Внутренняя эвристика сделки;**
- Эвристика, внешняя по отношению к сделке**

### Сатоши Накамото и анализ блокчейна

Следует отметить, что первые две эвристики для анализа цепочек были открыты самим Сатоши Накамото. Он обсуждает их в 10-й части "Белой книги биткойна". К ним относятся:


- эвристика общих входных свойств (CIOH);
- и повторное использование адресов.

![BTC204](assets/fr/031.webp)

Источник: С. Накамото, "Биткойн: одноранговая система электронных денег", https://bitcoin.org/bitcoin.pdf, 2009.

В следующих главах мы рассмотрим, что это такое, но уже сейчас интересно отметить, что эти две эвристики по-прежнему занимают важное место в анализе цепочек.

## Шаблоны транзакций

<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>

Модель транзакции - это просто общий шаблон или структура типичной транзакции, которую можно найти в блокчейне и интерпретация которой предположительно известна. Когда мы изучаем модели, мы фокусируемся на одной транзакции, которую мы анализируем на высоком уровне.

Другими словами, мы будем смотреть только на количество UTXO на входах и количество UTXO на выходах, не останавливаясь на более специфических деталях и условиях сделки. На основе наблюдаемого паттерна мы сможем интерпретировать природу транзакции. Затем мы будем искать особенности в ее структуре и делать выводы об интерпретации.

![BTC204](assets/it/32/01.webp)

В этой части мы вместе раскроем основные схемы транзакций, которые могут встречаться при анализе цепочек, и для каждой схемы я приведу вероятную интерпретацию этой структуры, а также конкретный пример.

### Простая отправка (или простая оплата)

Начнем с очень популярной модели, поскольку именно она встречается в большинстве биткойн-платежей. Простая модель платежа характеризуется потреблением одного или нескольких UTXO на входе и производством 2 UTXO на выходе. Таким образом, эта модель будет выглядеть следующим образом:

![BTC204](assets/it/32/02.webp)

Когда мы обнаруживаем эту структуру транзакций в блокчейне, мы уже можем сделать интерпретацию. Как следует из названия, этот паттерн указывает на то, что мы имеем дело с транзакцией отправки или оплаты. Пользователь израсходовал свои UTXO на входе, чтобы удовлетворить на выходе платежный UTXO и переменный UTXO (деньги, возвращенные тому же пользователю).

Таким образом, мы знаем, что наблюдаемый пользователь, вероятно, больше не владеет одним из двух выходных UTXO (платежным), но все еще владеет другим UTXO (сменным).

В настоящее время мы не можем определить, какой выход представляет какой UTXO, поскольку это не является целью исследования моделей. Для достижения этой цели мы будем опираться на эвристики, которые мы рассмотрим в следующих частях. На данном этапе наша цель сводится к определению природы рассматриваемой транзакции, которая в данном случае представляет собой простую отправку.

Например, вот транзакция Bitcoin, в которой используется модель простой отправки:

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/it/32/03.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

После этого первого примера вы должны лучше понимать, что значит изучать "модель транзакции" Мы изучаем транзакцию, фокусируясь только на ее структуре, не принимая во внимание ее окружение или специфические детали транзакции. На этом первом этапе мы рассматриваем ее только глобально.

Теперь, когда вы поняли, что такое модель, давайте перейдем к другим существующим моделям.

### Подметание

Эта вторая модель характеризуется потреблением одного UTXO в качестве входа и производством одного UTXO в качестве выхода.

![BTC204](assets/it/32/04.webp)

Интерпретация этой модели заключается в том, что мы имеем дело с автопереводом. Пользователь перевел свои биткоины самому себе, на другой адрес, принадлежащий ему. Поскольку в транзакции нет остатка, очень маловероятно, что мы имеем дело с платежом. На самом деле, когда производится платеж, практически невозможно, чтобы у плательщика был UTXO, точно соответствующий сумме, запрошенной продавцом, плюс комиссия за транзакцию. Поэтому, как правило, плательщик вынужден производить вывод остатка.

Таким образом, мы знаем, что наблюдаемый пользователь, вероятно, все еще владеет этим UTXO. В контексте цепного анализа, если мы знаем, что UTXO, используемый в качестве входа в транзакцию, принадлежит Алисе, мы можем предположить, что UTXO на выходе также принадлежит ей. В дальнейшем будет интересно найти эвристики внутри транзакции, которые могли бы усилить это предположение (мы рассмотрим эти эвристики в разделе 3.3).

Например, вот транзакция Bitcoin, в которой используется модель sweeping:

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/it/32/05.webp)

Источник:[Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d) Однако подобный паттерн может свидетельствовать и о самостоятельном переводе средств на счет криптовалютной платформы. Именно изучение известных адресов и контекста транзакции позволит нам понять, является ли это консолидацией на кошелек для самостоятельного хранения или выводом средств на платформу. Действительно, адреса обменных платформ зачастую легко идентифицируются.

Вернемся к примеру с Алисой: если консолидация ведет на известный адрес платформы (например, Binance), это может означать, что биткоины были переведены из непосредственного владения Алисы, вероятно, с намерением продать их или хранить на этой платформе. С другой стороны, если адрес назначения неизвестен, разумно предположить, что это просто другой кошелек, по-прежнему принадлежащий Алисе. Но этот тип исследования больше относится к категории эвристики, а не к изучению закономерностей.

### Консолидация

Эта модель характеризуется потреблением нескольких UTXO в качестве входа и производством одного UTXO в качестве выхода.

![BTC204](assets/it/32/06.webp)

Интерпретация этого паттерна заключается в том, что мы находимся в состоянии консолидации. Это распространенная практика среди пользователей биткоина - объединение нескольких UTXO в преддверии возможного повышения комиссии за транзакции. Выполняя эту операцию в период, когда комиссии низкие, можно сэкономить на будущих комиссиях. Подробнее об этой практике мы поговорим в главе 4.3.

Мы можем сделать вывод, что пользователь, стоящий за этой моделью транзакции, вероятно, владел всеми входными UTXO и все еще владеет выходными UTXO. Это определенно автотрансфер.

Как и консолидация, этот тип паттерна может также свидетельствовать о самостоятельном переводе средств на счет биржевой платформы. Именно изучение известных адресов и контекста транзакции позволит нам понять, является ли это консолидацией на кошелек для самостоятельного хранения или выводом средств на платформу.

Например, вот транзакция Bitcoin, в которой используется схема консолидации:

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/it/32/07.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)

В контексте цепного анализа эта модель может раскрыть много информации. Например, если мы знаем, что один из входов принадлежит Алисе, мы можем предположить, что все остальные входы и выходы этой транзакции принадлежат ей. Это предположение позволит нам проследить предыдущие цепочки транзакций, чтобы обнаружить и проанализировать другие транзакции, вероятно связанные с Алисой.

![BTC204](assets/it/32/08.webp)

### Группированные расходы

Для этой модели характерно потребление нескольких UTXO в качестве входа (часто только одного) и производство множества UTXO в качестве выхода.

![BTC204](assets/it/32/09.webp)

Интерпретация этого паттерна заключается в том, что мы имеем дело с пакетными расходами. Такая практика, скорее всего, свидетельствует о значительной экономической деятельности, например, обменной платформы. Групповые расходы позволяют этим организациям экономить на комиссиях, объединяя свои расходы в одну транзакцию.

Из этой модели можно сделать вывод, что вход UTXO поступает от компании со значительной экономической активностью и что выходы UTXO будут рассеиваться. Многие из них будут принадлежать клиентам компании, которые вывели биткоины с платформы. Другие могут достаться компаниям-партнерам. И наконец, обязательно будет один или несколько обменов, которые вернутся в компанию-эмитент.

Например, вот транзакция Bitcoin, в которой используется модель сгруппированных расходов (вероятно, это транзакция, выпущенная платформой Bybit):

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/it/32/10.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### Транзакции, специфичные для протокола

Среди паттернов транзакций мы также можем выявить паттерны, свидетельствующие об использовании определенного протокола. Например, коинджоины Whirlpool (о которых мы поговорим в части 5) имеют легко идентифицируемую структуру, которая позволяет отличить их от других, более традиционных транзакций.

![BTC204](assets/it/32/11.webp)

Анализ этого паттерна позволяет предположить, что мы, вероятно, имеем дело с совместной транзакцией. Также возможно, что мы наблюдаем коинджойнт. Если последняя гипотеза окажется верной, то количество выходов может дать нам приблизительную оценку числа участников коинджоина.

Например, здесь представлена транзакция Bitcoin, в которой используется модель типа совместной транзакции coinjoin:

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/it/32/12.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

Существует множество других протоколов, которые имеют свои специфические структуры. Так, например, можно выделить транзакции типа Wabisabi, транзакции Stamps или даже Runes.

Благодаря этим моделям транзакций мы уже можем интерпретировать определенный объем информации о той или иной транзакции. Но структура транзакции - не единственный источник информации для анализа. Мы также можем изучать ее детали. Эти детали, внутренние для транзакции, я люблю называть "внутренней эвристикой", и мы будем изучать их в следующей главе.

## Внутренняя эвристика

<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>

Внутренняя эвристика - это специфическая особенность, выявленная в самой транзакции, без необходимости изучения ее окружения, которая позволяет нам делать выводы. В отличие от моделей, которые фокусируются на общей структуре транзакции на высоком уровне, внутренние эвристики основаны на наборе извлекаемых данных. К ним относятся:


- Количество различных UTXO на входе и выходе;
- Все о скриптах: адреса получения, версионирование, время блокировки и т.д.

Как правило, такой тип эвристики позволяет нам определить остаток в конкретной транзакции. Таким образом, мы можем продолжать отслеживать объект в нескольких транзакциях. На самом деле, если мы идентифицируем UTXO, принадлежащий пользователю, которого мы хотим отследить, очень важно определить, когда он совершает транзакцию, какой вывод был передан другому пользователю, а какой представляет собой остаток, оставаясь в его владении.

![BTC204](assets/it/33/01.webp)

Еще раз напомню, что эти эвристики ни в коем случае не являются точными. Взятые по отдельности, они позволяют лишь определить правдоподобные сценарии. Именно накопление различных эвристик помогает уменьшить неопределенность, никогда не устраняя ее полностью.

### Внутренние сходства

Эта эвристика предполагает изучение сходства между входами и выходами одной и той же транзакции. Если мы наблюдаем один и тот же признак на входах и только на одном из выходов транзакции, то, скорее всего, этот выход составляет остальные.

Наиболее очевидной особенностью является повторное использование адреса приема в одной и той же транзакции.

![BTC204](assets/it/33/02.webp)

Эта эвристика оставляет мало места для сомнений. Если только закрытый ключ не был взломан, один и тот же адрес получения неизбежно раскрывает деятельность одного пользователя. Из этого следует, что остаток транзакции - это выход с тем же адресом, что и вход. Это позволяет непрерывно отслеживать человека по этому остатку.

Например, вот транзакция, к которой можно обоснованно применить эту эвристику:

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/fr/046.webp)

Fonte: [Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

Сходство между вводом и выводом не ограничивается повторным использованием адресов. Любое сходство в использовании скриптов может позволить применить эвристику. Например, иногда между входом и одним из выходов транзакции может наблюдаться одинаковая версионность.

![BTC204](assets/it/33/04.webp)

На этой диаграмме видно, что вход № 0 разблокирует скрипт P2WPKH (SegWit V0, начинающийся с `bc1q`). Выход № 0 использует тот же тип скрипта. Однако в выходе № 1 используется скрипт P2TR (SegWit V1, начинающийся с `bc1p`). Интерпретация этой особенности заключается в том, что, скорее всего, адрес с той же версией, что и входной, является адресом остатка. Таким образом, он будет принадлежать тому же пользователю.

Вот одна из сделок, к которой можно с полным основанием применить эту эвристику:

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/fr/048.webp)

Fonte: [Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)

В данном случае мы видим, что на входе № 0 и выходе № 1 используются скрипты P2WPKH (SegWit V0), а на выходе № 0 - другой тип скрипта, P2PKH (Legacy). В начале 2010-х годов эта эвристика, основанная на версии скрипта, была относительно бесполезной из-за ограничения доступных типов скриптов. Однако со временем и с последующими обновлениями Bitcoin появилось все большее разнообразие типов скриптов. Эта эвристика становится все более актуальной, поскольку при более широком спектре типов скриптов пользователи делятся на более мелкие группы, что повышает шансы на применение этой внутренней эвристики повторного использования версии. По этой причине, исключительно с точки зрения конфиденциальности, рекомендуется выбирать наиболее распространенный тип сценария. Например, сейчас, когда я пишу эти строки, скрипты Taproot (`bc1p`) используются реже, чем скрипты SegWit V0 (`bc1q`). Хотя первые имеют экономические и конфиденциальные преимущества в некоторых специфических контекстах, для более традиционного использования одной подписи, возможно, имеет смысл придерживаться более старого стандарта по соображениям конфиденциальности, пока новый стандарт не получит более широкого распространения.

### Платежи с округленными числами

Еще одна внутренняя эвристика, которая может помочь нам определить остаток, - это округленное число. Как правило, когда мы сталкиваемся с простой схемой оплаты (1 вход и 2 выхода), если на одном из выходов стоит округленная сумма, то она и представляет собой оплату.

![BTC204](assets/it/33/06.webp)

Если один вывод представляет собой платеж, то другой - изменение. Поэтому можно сделать вывод, что, скорее всего, пользователь, совершивший транзакцию, по-прежнему владеет выходом, обозначенным как change.

Следует отметить, что эта эвристика не всегда применима, так как большинство платежей по-прежнему осуществляется в фиатных валютах. На самом деле, когда торговец во Франции принимает биткойн, он, как правило, не показывает стабильные цены в сатах. Он предпочитает конвертировать цену в евро в сумму в биткойнах, которую необходимо заплатить. Поэтому в выводе транзакции не должно быть округленного числа.

Однако аналитик может попытаться произвести такое преобразование, приняв во внимание обменный курс, действовавший на момент передачи транзакции по сети. Возьмем пример транзакции с входом `97 552 сата` и двумя выходами, один из которых составляет `31 085 сатов`, а другой - `64 152 сата`. На первый взгляд, в этой операции не используются округленные суммы. Однако, применив обменный курс 64,339 на момент совершения операции, мы получим следующий пересчет в евро:


- Стоимость 62,76 евро;
- Производительность 20 евро;
- Выход 41,27 евро.

После конвертации в фиатную валюту эта транзакция позволяет применить эвристику платежей с округленными суммами. Выдача в размере 20 евро, вероятно, предназначалась торговцу или сменила владельца. Вывод - €41,27, вероятно, остался во владении первоначального пользователя.

![BTC204](assets/it/33/07.webp)

Если в один прекрасный день биткойн станет предпочтительной расчетной единицей в наших транзакциях, эта эвристика может стать еще более полезной для анализа.

Например, вот сделка, в которой, вероятно, можно применить эту эвристику:

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/fr/051.webp)

Fonte: [Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)

### Наибольшая производительность

Если в простой модели платежей разница между двумя результатами операции значительно велика, можно предположить, что более крупный результат, скорее всего, является остатком.

![BTC204](assets/it/33/09.webp)

Эвристика наибольшего выхода, вероятно, является самой неточной из всех. При самостоятельном определении она довольно слаба. Однако этот признак можно объединить с другими эвристиками, чтобы уменьшить неопределенность нашей интерпретации.

Например, если мы исследуем сделку, в которой один выход имеет круглую сумму, а другой - большую, совместное применение эвристики круглых платежей и эвристики, связанной с большим выходом, позволяет нам снизить уровень неопределенности.

Например, вот сделка, в которой, вероятно, можно применить эту эвристику:

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/fr/053.webp)

Fonte: [Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## Внешние эвристики

<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>

Изучение внешних эвристик предполагает анализ сходства, закономерностей и характеристик определенных элементов, которые не присущи самой сделке. Другими словами, если раньше мы ограничивались изучением элементов, присущих сделке, с помощью внутренних эвристик, то теперь мы расширяем область анализа до окружения сделки с помощью внешних эвристик.

### Повторное использование адресов

Это одна из самых известных эвристик среди энтузиастов Биткойна. Повторное использование адресов позволяет устанавливать связь между разными транзакциями и разными UTXO. Это наблюдается, когда адрес получения Биткойна используется несколько раз.

Таким образом, можно использовать повторное использование адресов в рамках одной транзакции в качестве внутренней эвристики для идентификации остатка (как мы видели в предыдущей главе). Однако повторное использование адресов может также служить внешней эвристикой для распознавания уникальности сущности за несколькими транзакциями.

Интерпретация повторного использования адреса заключается в том, что все UTXO, заблокированные на этом адресе, принадлежат (или принадлежали) одному и тому же субъекту. Эта эвристика оставляет мало места для неопределенности. Когда ее можно определить, последующая интерпретация с большой вероятностью будет соответствовать реальности. Таким образом, она позволяет группировать различные виды деятельности в цепочке.

![BTC204](assets/it/34/01.webp)

Как объясняется во введении к этой части 3, эта эвристика была обнаружена самим Сатоши Накамото. В "Белой книге" он специально упоминает решение для пользователей, чтобы избежать этого, - просто использовать новый адрес для каждой новой транзакции:

"_В качестве дополнительной защиты можно использовать новую пару ключей для каждой транзакции, чтобы предотвратить их привязку к общему владельцу._"

![BTC204](assets/fr/055.webp)

Источник: С. Накамото, "Биткойн: одноранговая система электронных денег", https://bitcoin.org/bitcoin.pdf, 2009.

Например, вот адрес, повторно используемый в нескольких транзакциях:

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

Источник:[Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### Сходство скриптов и отпечатков пальцев кошельков

Помимо повторного использования адресов, существует ряд других эвристик для привязки акций к одному портфелю или к кластеру адресов.

Прежде всего, аналитик может воспользоваться сходством в использовании скриптов. Например, некоторые скрипты меньшинств, такие как multisig, могут быть идентифицированы легче, чем скрипты SegWit V0. Чем больше группа, в которой мы прячемся, тем сложнее нас идентифицировать. Именно поэтому в хороших протоколах Coinjoin все участники используют совершенно одинаковые скрипты.

В более общем смысле аналитик может также сосредоточиться на характеристиках "отпечатков пальцев" портфеля. Это специфические процессы, связанные с использованием, которые можно попытаться идентифицировать с целью использования их в качестве эвристики отслеживания. Другими словами, если наблюдается накопление одних и тех же внутренних характеристик в сделках, приписываемых отслеживаемому субъекту, можно попытаться выявить эти же характеристики в других сделках.

Например, можно определить, что отслеженный пользователь систематически отправляет свои остатки на адреса P2TR (`bc1p...`). Если этот процесс повторяется, его можно использовать в качестве эвристики для продолжения анализа. Можно использовать и другие "отпечатки пальцев", такие как порядок UTXO, расположение остатков в выходах, сигнализация RBF (Replace-by-Fee) или даже номер версии, поле `nSequence` и поле `nLockTime`.

Как отмечает [@LaurentMT](https://twitter.com/LaurentMT) в [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji) (франкоязычный подкаст), полезность отпечатков кошельков для анализа цепочек значительно возрастает со временем. Действительно, растущее количество типов скриптов и все более постепенное развертывание этих новых возможностей программным обеспечением кошельков подчеркивают различия. Может даже случиться так, что можно будет точно определить программное обеспечение, используемое отслеживаемым субъектом. Поэтому важно понимать, что изучение цифрового следа кошелька особенно актуально для недавних транзакций, причем в большей степени, чем для тех, которые были начаты в начале 2010-х годов.

Подводя итог, можно сказать, что отпечаток пальца - это любая специфическая практика, выполняемая автоматически кошельком или вручную пользователем, которую можно найти в других транзакциях, чтобы помочь нам в анализе.

### Эвристика общего владения входами (CIOH)

CIOH, что в переводе с английского означает "эвристика владения общим входом", - это эвристика, которая гласит, что когда сделка включает в себя несколько входов, они, скорее всего, исходят от одного субъекта. Следовательно, их собственность является общей.

Чтобы применить эвристику общего владения входами (CIOH), мы сначала наблюдаем сделку, которая имеет несколько входов. Это может быть от минимума в 2 входа до максимума в 30 входов. Как только эта характеристика выявлена, мы проверяем, не соответствует ли сделка известной модели сделок. Например, если она имеет 5 входов с примерно равными суммами и 5 выходов с абсолютно одинаковыми суммами, мы знаем, что это структура coinjoin. Следовательно, мы не можем применить IOCH.

Однако если транзакция не соответствует ни одной из известных моделей совместных транзакций, то можно сделать вывод, что все входы, вероятно, исходят от одного и того же субъекта. Это может быть очень полезно для расширения известного кластера или для продолжения отслеживания.

CIOH была обнаружена Сатоши Накамото. Он рассказывает об этом в десятой части "Белой книги":

"_[...] связь неизбежна при многовходовых транзакциях, которые обязательно показывают, что их входы принадлежали одному и тому же владельцу. Риск заключается в том, что если владелец ключа будет раскрыт, связи могут выявить другие транзакции, принадлежавшие тому же владельцу._"

Особенно интересно отметить, что Сатоши Накамото еще до официального запуска биткоина определил две основные уязвимости конфиденциальности для пользователей, а именно IOCH и повторное использование адресов. Такое предсказание весьма примечательно, поскольку эти две эвристики и по сей день остаются наиболее полезными при анализе блокчейна.

В качестве примера можно привести сделку, к которой мы, вероятно, можем применить IOCH:

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

Fonte: [Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### Данные вне цепи

Конечно, анализ цепочки не ограничивается исключительно данными о цепочке. Данные из предыдущих анализов или доступные в Интернете также могут быть использованы для уточнения анализа.

Например, если будет замечено, что отслеживаемые транзакции систематически передаются с одного и того же узла Биткойна и его IP-адрес может быть идентифицирован, то можно будет идентифицировать другие транзакции от того же субъекта, а также частично определить личность отправителя. Хотя подобная практика не так проста, поскольку требует работы многих узлов, не исключено, что некоторые компании, специализирующиеся на анализе цепочек, будут ее использовать.

Аналитик также может опираться на результаты анализа, ранее выложенные в открытый доступ, или на свои собственные предыдущие анализы. Возможно, удастся найти результаты, указывающие на кластер адресов, который уже был идентифицирован. Иногда можно также опираться на результаты, указывающие на платформу обмена, адреса которой общеизвестны.

Аналогичным образом можно проводить анализ методом исключения. Например, если при анализе транзакции с двумя выходами один из них связан с кластером адресов, который уже известен, но отличается от отслеживаемого объекта, то можно сделать вывод, что другой выход, вероятно, представляет собой остаток.

Анализ цепочек также включает в себя часть OSINT (_Open Source Intelligence_), которая является более универсальной в отношении поиска информации в Интернете. Именно поэтому не рекомендуется публиковать адреса получателей непосредственно в социальных сетях или на веб-сайтах, будь то под псевдонимом или без него.

![BTC204](assets/fr/063.webp)

### Временные паттерны

Об этом не так часто задумываются, но некоторые виды поведения человека можно распознать по цепочке. Самым полезным для анализа может быть ваш режим сна! Да, когда вы спите, вы, предположительно, не передаете транзакции Биткойна. Поскольку вы обычно спите в одно и то же время, при анализе цепочки обычно используется временной анализ. Это просто включает в себя каталогизацию времени, когда транзакции данного субъекта передаются в сеть Биткойн. Анализ этих временных закономерностей позволяет сделать вывод о множестве информации.

Прежде всего, временной анализ иногда позволяет определить природу отслеживаемого объекта. Если наблюдается постоянная передача транзакций в течение 24 часов, то это свидетельствует об активной экономической деятельности. Скорее всего, за этими транзакциями стоит компания, возможно, международная, и, возможно, с внутренними автоматизированными процедурами.

Например, [я распознал эту закономерность несколько месяцев назад](https://twitter.com/Loic_Pandul/status/1701127409712452072), проанализировав [транзакцию, в которой ошибочно было выделено 19 биткоинов в качестве комиссии](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd). Простой временной анализ позволил мне предположить, что мы имеем дело с автоматизированным сервисом, а значит, вероятно, с крупной организацией, такой как биржевая платформа.

На самом деле через несколько дней выяснилось, что средства принадлежат PayPal через обменную платформу Paxos.

И наоборот, если мы видим, что временной график распределен на 16 определенных часов, то можно предположить, что мы имеем дело с отдельным пользователем или, возможно, местным предприятием, в зависимости от объемов торговли.

Помимо характера наблюдаемого объекта, временная модель также может дать нам приблизительное местоположение пользователя по часовым поясам. Затем мы можем связать другие транзакции и использовать их временные метки в качестве дополнительной эвристики, которую можно добавить к нашему анализу.

Например, на повторно используемом адресе, который я упоминал ранее, мы можем наблюдать, что транзакции, как входящие, так и исходящие, сосредоточены на 13-часовом интервале.

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/064.webp)

Источник: OXT.me

Этот диапазон, вероятно, соответствует Европе, Африке или Ближнему Востоку. Поэтому мы можем предположить, что пользователь, осуществляющий эти транзакции, живет именно там.

В другом регистре именно такой анализ времени позволил выдвинуть гипотезу о том, что Сатоши Накамото действовал не из Японии, а из Соединенных Штатов: [_The Time Zones of Satoshi Nakamoto_](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## Практическое применение с блочным исследователем

<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

В этой заключительной главе мы будем конкретно применять концепции, которые мы изучили до сих пор. Я приведу примеры реальных транзакций Bitcoin, а вы должны будете добыть информацию, которую я попрошу.

В идеале для этих упражнений предпочтительнее использовать профессиональный инструмент для анализа цепочек. Однако после закрытия создателей кошелька Samourai Wallet единственный бесплатный инструмент анализа OXT.me больше недоступен. Поэтому для этих упражнений мы выберем классический блокчейн-проводник. Я рекомендую использовать [Mempool.space](https://mempool.space/) за его широкие возможности и набор инструментов для анализа цепочек, но вы можете выбрать и другой проводник, например [Bitcoin Explorer](https://bitcoinexplorer.org/). Для начала я представлю вам упражнения. Выполните их с помощью вашего блокчейн-проводника и запишите ответы на листе бумаги. Затем, в конце этой главы, я приведу ответы, чтобы вы могли проверить и исправить свои результаты.

сделки, выбранные для этих упражнений, были выбраны исключительно по их характеристикам, причем несколько случайным образом. Эта глава предназначена только для образовательных и информационных целей. Хочу уточнить, что я не пропагандирую и не поощряю использование этих инструментов в злонамеренных целях. Цель состоит в том, чтобы научить вас защищаться от анализа цепочек, а не проводить анализ с целью раскрытия частной информации других людей._

### Упражнение 1

Идентификатор анализируемой транзакции:

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

Как называется модель этой транзакции и какие правдоподобные интерпретации можно сделать, изучив только ее модель, т. е. структуру транзакции?

### Упражнение 2

Идентификатор анализируемой транзакции:

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

Как называется модель этой транзакции и какие правдоподобные интерпретации можно сделать, изучив только ее модель, т. е. структуру транзакции?

### Упражнение 3

Идентификатор анализируемой транзакции:

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

Какова схема этой сделки?

После определения его модели, используя внутреннюю эвристику транзакции, какой вывод, скорее всего, будет представлять остальное?

### Упражнение 4

Идентификатор анализируемой транзакции:

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

Какова схема этой сделки?

После определения его модели, используя внутреннюю эвристику транзакции, какой вывод, скорее всего, будет представлять остальное?

### Упражнение 5

Представьте, что Лоик разместил один из своих биткойн-адресов для получения платежей в социальной сети Twitter:

![BTC204](assets/fr/065.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

Используя **только эвристику повторного использования адресов**, какие транзакции Bitcoin мы можем связать с личностью Лоика?

очевидно, что я не являюсь настоящим владельцем этого адреса получения и не публиковал его в социальных сетях. Это адрес, который я случайно выбрал из блокчейна._

### Упражнение 6

Выполнив упражнение 5, используя эвристику повторного использования адресов, вы смогли определить несколько транзакций Bitcoin, в которых, судя по всему, участвовал Лоик. Как правило, среди выявленных транзакций вы должны были определить эту:

Эта транзакция - самая первая, отправившая средства на адрес Лоика. Как вы думаете, откуда взялись биткоины, полученные Лоиком в результате этой транзакции?

### Упражнение 7

После выполнения упражнения 5, используя эвристику повторного использования адресов, вы смогли определить несколько транзакций Bitcoin, в которых, судя по всему, участвовал Лоик. Теперь вы хотите выяснить, откуда взялся Лоик. На основе найденных транзакций проведите анализ времени, чтобы определить часовой пояс, который, вероятно, использует Лоик. Исходя из этого часового пояса, определите место, где, по всей видимости, живет Лоик (страна, штат/регион, город...).

### Упражнение 8

Вот транзакция Bitcoin для изучения:

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

Какую информацию мы можем интерпретировать, глядя только на эту сделку?

### Решения к упражнениям

**_Упражнение 1:_**

Модель этой транзакции - это модель простого платежа. Если мы изучим только ее структуру, то сможем интерпретировать, что один выход представляет собой изменение, а другой - фактический платеж. Тогда мы знаем, что наблюдаемый пользователь, вероятно, больше не владеет одним из двух UTXO в выходах (тем, что для оплаты), но все еще владеет другим UTXO (тем, что для изменения).

**_Упражнение 2:_**

Эта транзакция имеет характер пакетных расходов. Такой паттерн, вероятно, указывает на значительную экономическую деятельность, например, обменной платформы. Мы можем сделать вывод, что входные UTXO поступают от компании со значительной экономической активностью и что выходные UTXO будут рассеиваться. Некоторые из них будут принадлежать клиентам компании, которые вывели свои биткоины на кошельки для самостоятельного хранения. Другие могут достаться компаниям-партнерам. И, наконец, обязательно будет остаток, который вернется в компанию-эмитент.

**_Упражнение 3:_**

Модель этой транзакции - это модель простого платежа. Поэтому мы можем применить к транзакции внутреннюю эвристику, чтобы попытаться определить остаток.

Лично я выявил как минимум две внутренние эвристики, которые подтверждают ту же гипотезу:


- Повторное использование одного и того же типа сценария;
- Самый большой объем производства.

Наиболее очевидной эвристикой является повторное использование одного и того же типа скрипта. На самом деле, выход `0` - это `P2SH`, узнаваемый по адресу приема, начинающемуся с `3`:

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

В то время как выход `1` - это `P2WPKH`, идентифицируемый по адресу, начинающемуся с `bc1q`:

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

UTXO, используемый в качестве входа для этой транзакции, также использует скрипт `P2WPKH`:

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

Таким образом, мы можем предположить, что выход `0` соответствует платежу, а выход `1` - остальной части транзакции, что означает, что пользователь входа по-прежнему владеет выходом `1`.

Чтобы поддержать или опровергнуть эту гипотезу, мы можем поискать другие эвристики, которые подтверждают наши мысли или уменьшают вероятность того, что наша гипотеза верна.

Я выявил еще как минимум одну эвристику. Это самый большой выход. Выход `0` измеряет `123 689 сатов`, а выход `1` измеряет `505 839 сатов`. Таким образом, между этими двумя выходами существует значительная разница. Эвристика более крупного вывода позволяет предположить, что более объемный вывод, вероятно, является остатком. Таким образом, эта эвристика еще больше укрепляет нашу первоначальную гипотезу.

Кажется вероятным, что пользователь, предоставивший вход UTXO, все еще владеет выходом `1`, который, похоже, представляет остальную часть транзакции.

**_Упражнение 4:_**

Модель этой транзакции - это модель простого платежа. Поэтому мы можем применить к транзакции внутреннюю эвристику, чтобы попытаться определить остаток.

Я лично выявил как минимум две внутренние эвристики, которые подтверждают ту же гипотезу:


- Повторное использование одного и того же типа сценария;
- Выход круглой суммы.

Наиболее очевидной эвристикой является повторное использование одного и того же типа скрипта. На самом деле, выход `0` - это `P2SH`, узнаваемый по адресу приема, начинающемуся с `3`:

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

В то время как выход `1` - это `P2WPKH`, идентифицируемый по адресу, начинающемуся с `bc1q`:

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

UTXO, используемый в качестве входа для этой транзакции, также использует скрипт `P2WPKH`:

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

Таким образом, мы можем предположить, что выход `0` соответствует платежу, а выход `1` - остальной части транзакции, что означает, что пользователь входа по-прежнему владеет выходом `1`.

Чтобы поддержать или опровергнуть эту гипотезу, мы можем поискать другие эвристики, которые подтверждают наши мысли или уменьшают вероятность того, что наша гипотеза верна.

Я выявил еще как минимум одну эвристику. Это вывод круглой суммы. Вывод `0` измеряет `70,000 сатов`, а вывод `1` измеряет `22,962 сата`. Таким образом, мы имеем дело с идеально круглым выводом в расчетных единицах BTC. Эвристика круглого вывода предполагает, что UTXO с одной круглой суммой, вероятно, является платежом, а вторая, путем исключения, представляет собой остаток. Таким образом, эта эвристика еще больше укрепляет нашу первоначальную гипотезу.

Однако в данном примере другая эвристика может опровергнуть наше первоначальное предположение. На самом деле, выход `0` больше, чем выход `1`. Если мы основываемся на эвристике, согласно которой наибольший выход обычно является остатком, мы можем сделать вывод, что выход `0` является остатком. Однако эта контргипотеза кажется неправдоподобной, поскольку две другие эвристики выглядят гораздо более убедительными, чем эвристика наибольшего выхода. Следовательно, представляется разумным сохранить нашу первоначальную гипотезу, несмотря на это кажущееся противоречие.

Поэтому кажется вероятным, что пользователь, предоставивший UTXO в качестве входа, по-прежнему владеет выходом `1`, который, по-видимому, представляет собой остальную часть транзакции.

**_Упражнение 5:_**

Мы видим, что с личностью Лоика можно связать 8 транзакций. Из них 4 связаны с получением биткоинов:

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
8b70bd322e6118b8a002dbdb731d16b59c4a729c2379af376ae230cf8cdde0dd
d5864ea93e7a8db9d3fb113651d2131567e284e868021e114a67c3f5fb616ac4
bc4dcf2200c88ac1f976b8c9018ce70f9007e949435841fc5681fd33308dd762
```

Остальные 4 - об отправке биткоина:

```plaintext
8b52fe3c2cf8bef60828399d1c776c0e9e99e7aaeeff721fff70f4b68145d540
c12499e9a865b9e920012e39b4b9867ea821e44c047d022ebb5c9113f2910ed6
a6dbebebca119af3d05c0196b76f80fdbf78f20368ebef1b7fd3476d0814517d
3aeb7ce02c35eaecccc0a97a771d92c3e65e86bedff42a8185edd12ce89d89cc
```

**_Упражнение 6:_**

Если мы рассмотрим структуру этой операции, то станет ясно, что это сгруппированные расходы. Фактически, транзакция имеет один вход и 51 выход, что свидетельствует о значительной экономической активности. Поэтому мы можем предположить, что Лоик снял биткоины с обменной платформы.

Несколько элементов подтверждают эту гипотезу. Во-первых, тип скрипта, используемого для защиты входного UTXO, - это скрипт P2SH multisig 2/3, что указывает на продвинутый уровень безопасности, характерный для биржевых платформ:

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```

Кроме того, анализируемый адрес `3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF` был повторно использован в более чем 220 000 различных транзакций, что часто характерно для обменных платформ, которые, как правило, не заботятся о своей конфиденциальности. Временная эвристика, примененная к этому адресу, также показывает регулярное распределение транзакций почти ежедневно в течение 3 месяцев, с продолжительностью более 24 часов, что говорит о непрерывной деятельности обменной платформы.

Наконец, объемы, обрабатываемые этой организацией, огромны. Фактически, адрес получил и отправил 44 BTC в ходе 222 262 транзакций в период с декабря 2022 года по март 2023 года. Такие значительные объемы еще раз подтверждают вероятный характер деятельности биржевой платформы.

**_Упражнение 7:_**

Анализируя время подтверждения транзакций, можно увидеть следующее время по Гринвичу:

```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

Анализируя эти данные, можно сделать вывод, что часовые пояса UTC-7 и UTC-8 в большинстве случаев соответствуют диапазону обычной деятельности человека (между 8 утра и 11 вечера):

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7
05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

Часовой пояс UTC-7 особенно актуален в летний период, поскольку в него входят такие штаты и регионы, как:


- Калифорния (с такими городами, как Лос-Анджелес, Сан-Франциско и Сан-Диего);
- Невада (с Лас-Вегасом);
- Орегон (вместе с Портлендом);
- Вашингтон (вместе с Сиэтлом);
- Канадский регион Британская Колумбия (с такими городами, как Ванкувер и Виктория).

Эта информация позволяет предположить, что Лоик может проживать на западном побережье США или Канады.

**_Упражнение 8:_**

Анализ этой операции показывает 5 входов и один выход, что, по-видимому, указывает на консолидацию. Применение эвристики CIOH позволяет предположить, что все UTXO на входах принадлежат одной организации, и что UTXO на выходе также принадлежит этой организации. Похоже, что пользователь решил объединить несколько принадлежащих ему UTXO в один UTXO на выходе с целью консолидации собственных монет. Вероятно, такой подход был продиктован желанием воспользоваться низкими комиссиями за транзакции на данный момент, чтобы снизить будущие комиссии.

---
при написании этой части 3, посвященной цепному анализу, я использовал следующие источники:_


- серия из четырех статей под названием: [Understanding Bitcoin Privacy with OXT](https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923), выпущенная Samourai Wallet в 2021 году;_
- различные отчеты [OXT Research](https://medium.com/oxt-research), а также их бесплатный инструмент для анализа цепочек (который в настоящее время больше не доступен после ареста основателей Samourai Wallet);_
- в целом, мои знания получены из различных твитов и контента [@LaurentMT](https://twitter.com/LaurentMT) и [@ErgoBTC](https://twitter.com/ErgoBTC);_
- \_В [Космический Кек #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji), в котором я участвовал вместе с [@louneskmt](https://twitter.com/louneskmt), [@TheoPantamis](https://twitter.com/TheoPantamis), [@Sosthene\_\_](https://twitter.com/Sosthene___), и [@LaurentMT](https://twitter.com/LaurentMT)\_

я хотел бы поблагодарить их авторов, разработчиков и продюсеров. Спасибо также рецензентам, которые тщательно выправили статью, послужившую основой для этой части 3, и оказали мне честь своими экспертными советами:_


- [Жиль Кадиньян] (https://twitter.com/gillesCadignan);_
- людовик Ларс (https://viresinnumeris.fr/)

# Освоение лучших практик для защиты конфиденциальности

<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## Повторное использование адресов

<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>

Изучив методы, которые могут нарушить вашу конфиденциальность в Bitcoin, в этой третьей части мы рассмотрим лучшие методы, которые вы можете применить, чтобы защитить себя. Целью этой части является не изучение методов улучшения конфиденциальности - эта тема будет рассмотрена позже, - а понимание того, как правильно взаимодействовать с Bitcoin, чтобы сохранить конфиденциальность, которую он естественным образом предлагает, не прибегая к дополнительным методам.

Конечно, чтобы начать эту третью часть, мы поговорим о повторном использовании адресов. Это явление представляет собой главную угрозу конфиденциальности пользователей. Поэтому данная глава является, пожалуй, самой важной во всем курсе.

### Что такое адрес получения?

Адрес получения биткоинов - это строка символов или идентификатор, используемый для получения биткоинов в кошелек.

Технически адрес получения биткоинов не "получает" биткоины в прямом смысле, а скорее определяет условия, при которых биткоины могут быть потрачены. В частности, когда вам отправляется платеж, транзакция отправителя создает новый UTXO, предназначенный для вас, на выходе из UTXO, которые он израсходовал на входе. К этому выходу применяется скрипт, определяющий, как этот UTXO может быть потрачен в дальнейшем. Этот скрипт известен как "_ScriptPubKey_" или "_Locking Script_" Ваш адрес получения, точнее, его полезная нагрузка, встроена в этот скрипт. Если упростить, то этот скрипт, по сути, гласит:

> "_Для расходования этого нового UTXO необходимо предоставить цифровую подпись с использованием закрытого ключа, связанного с этим адресом получения._"
![BTC204](assets/fr/067.webp)

Биткойн-адреса бывают разных типов в зависимости от используемой модели криптовалют. К первым моделям, известным как "_Legacy_", относятся адреса `P2PKH` (_Pay-to-PubKey-Hash_) и `P2SH` (_Pay-to-Script-Hash_). Адреса P2PKH всегда начинаются с `1`, а P2SH - с `3`. Хотя эти форматы по-прежнему безопасны, они уже устарели, так как влекут за собой более высокие комиссии за транзакции и обеспечивают меньшую конфиденциальность, чем новые стандарты.

Адреса SegWit V0 (`P2WPKH` и `P2WSH`) и Taproot / SegWit V1 (`P2TR`) представляют современные форматы. Адреса SegWit начинаются с `bc1q`, а адреса Taproot, представленные в 2021 году, начинаются с `bc1p`.

Например, вот адрес приема Taproot:

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

Способ создания ScriptPubKey зависит от используемого стандарта:

| Шаблон сценария | ScriptPubKey || ---------------- | ----------------------------------------------------------- | ----------------------------------------------------------- | ----------------------------------------------------------- |

| P2PKH | OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG |

| P2SH | OP_HASH160 `<scriptHash>` OP_EQUAL |

| P2WPKH | 0 `<pubKeyHash>` |

| P2WSH | 0 `<witnessScriptHash>` |

| P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL |

| P2SH - P2WSH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL |

| P2TR | 1 `<pubKey>` |

Что касается построения адресов приема, то оно также зависит от выбранного шаблона сценария:


- Для адресов `P2PKH` и `P2WPKH` полезная нагрузка, или ядро адреса, представляет собой хэш открытого ключа;
- Для адресов `P2SH` и `P2WSH` полезная нагрузка представляет собой хэш скрипта;
- Как и в случае с адресами `P2TR`, полезной нагрузкой является модифицированный открытый ключ. Выходы `P2TR` сочетают в себе аспекты _Pay-to-PubKey_ и _Pay-to-Script_. Модифицированный открытый ключ - это результат добавления классического расходного открытого ключа с "модификацией", полученной из корня Меркла набора скриптов, которые также могут быть использованы для траты биткойнов.

![BTC204](assets/it/67/01.webp)

Адреса, отображаемые в программном обеспечении вашего кошелька, также включают HRP (_Human-Readable Part_), обычно `bc` для пост-SegWit адресов, разделитель `1`, и номер версии `q` для SegWit V0 и `p` для Taproot/SegWit V1. Также добавляется контрольная сумма для обеспечения целостности и достоверности адреса во время его передачи.

Наконец, адреса приводятся к стандартному формату:


- Base58check для старых адресов Legacy;
- Bech32 для адресов SegWit;
- Bech32m для адресов Taproot.

Здесь приведена матрица сложения для форматов bech32 и bech32m (SegWit и Taproot) из базы 10:

| + | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |



| 0 | q | p | z | r | y | 9 | x | 8 | 8

| 8 | g | f | 2 | t | v | d | w | 0 |

| 16 | s | 3 | j | n | 5 | 4 | k | h | 24 | c | e | 6 | m | u | a | 7 | l | l

### Что такое повторное использование адресов?

Под повторным использованием адреса понимается практика использования одного и того же адреса приема для блокировки нескольких различных UTXO.

Как мы видели в предыдущем разделе, каждый UTXO имеет свой собственный ScriptPubKey, который блокирует его и должен быть удовлетворен, чтобы UTXO мог быть использован как вход в новой транзакции. Именно в этот ScriptPubKey встраиваются адреса приема (полезная нагрузка).

Когда несколько ScriptPubKeys содержат один и тот же адрес получения, это называется повторным использованием адреса. На практике это означает, что пользователь несколько раз предоставляет один и тот же адрес отправителям для получения биткоинов посредством нескольких платежей. И действительно, такая практика катастрофична для вашей конфиденциальности.

### Почему повторное использование адресов является проблемой?

Поскольку блокчейн является публичным, можно легко увидеть, какие адреса блокируют какие UTXO и сколько биткоинов. Если один и тот же адрес используется для нескольких транзакций, можно сделать вывод, что все биткоины, связанные с этим адресом, принадлежат одному и тому же человеку. Такая практика ставит под угрозу конфиденциальность пользователей, позволяя устанавливать детерминированные связи между различными транзакциями и отслеживать биткоины в блокчейне. Сатоши Накамото сам указал на эту проблему в "Белой книге биткойна":

> в качестве дополнительного защитного экрана для каждой транзакции можно использовать новую пару ключей, чтобы предотвратить их связь с общим владельцем._
![BTC204](assets/fr/055.webp)

Источник: С. Накамото, "Биткойн: одноранговая система электронных денег", https://bitcoin.org/bitcoin.pdf, 2009.

Цель, которую преследовал Сатоши этим заявлением, заключалась в создании дополнительного брандмауэра на случай связи между личностью пользователя и парой ключей в Bitcoin, чтобы избежать публичной привязки всей его деятельности к его личности. Сегодня, с распространением аналитических компаний, работающих с блокчейном, и правил KYC, использование уникальных адресов - это уже не "дополнительный брандмауэр", а необходимая практика для всех, кто хочет сохранить свою конфиденциальность на минимальном уровне.

При повторном использовании адреса вы создаете практически неоспоримую связь между всеми транзакциями, связанными с этим адресом. Хотя это не несет прямой угрозы вашим средствам, поскольку шифрование на эллиптических кривых обеспечивает безопасность ваших закрытых ключей, это облегчает наблюдение за вашей деятельностью. Фактически, любой человек, имеющий узел, может наблюдать за вашими транзакциями и балансом адресов, полностью нарушая вашу анонимность.

![BTC204](assets/it/34/01.webp)

Чтобы проиллюстрировать эту мысль, давайте рассмотрим пример Боба, пользователя, который регулярно покупает биткоины небольшими суммами через систему Dollar Cost Averaging (DCA) и всегда отправляет их на один и тот же адрес. Через два года на этом адресе оказывается значительная сумма биткоинов. Если Боб использует этот адрес для совершения платежа местному торговцу, торговец может увидеть все связанные с ним средства и вычесть богатство Боба. Это может привести к риску личной безопасности, включая попытки кражи или вымогательства. Если бы Боб использовал новый адрес для получения каждой периодической покупки, он бы раскрыл продавцу бесконечно меньше информации.

При анализе цепочек мы различаем два типа повторного использования адресов:


- Внешнее повторное использование;
- Внутреннее повторное использование в рамках транзакции.

Первая наблюдается, когда адрес повторно используется в нескольких разных транзакциях Bitcoin. Это то, о чем мы говорили ранее: данная эвристика позволяет сделать вывод, что все UTXO, проходящие через этот адрес, принадлежат одному субъекту.

Повторное использование внутренних адресов наблюдается не тогда, когда повторное использование происходит в нескольких транзакциях, а когда оно происходит в пределах одной транзакции. Действительно, если тот же адрес, который использовался для блокировки входа, используется в качестве выхода в транзакции, то мы можем сделать вывод, что этот выход по-прежнему принадлежит тому же пользователю (остатку), и что второй выход представляет собой фактический платеж. Эта другая эвристика позволяет отслеживать средства по нескольким транзакциям.

![BTC204](assets/it/33/02.webp)

Повторное использование адресов - настоящий бич для биткойна. По данным сайта OXT.me (в настоящее время недоступного), в 2022 году общий уровень повторного использования адресов в биткойне составлял около 52 %:

![BTC204](assets/fr/069.webp)

Этот показатель огромен, но в подавляющем большинстве случаев он исходит от обменных платформ, а не от отдельных пользователей.

### Как избежать повторного использования адресов?

Избежать повторного использования адресов довольно просто: **просто используйте свежий адрес для каждого нового входящего платежа в вашем кошельке**.

Благодаря BIP32 современные портфели стали детерминированными и иерархическими. Это означает, что пользователь может сгенерировать большое количество адресов на основе единственной исходной информации - seed. Сохранив эту информацию, можно восстановить все приватные ключи кошелька и получить доступ к средствам, закрепленным за соответствующими адресами.

![BTC204](assets/fr/070.webp)

Поэтому, когда вы нажимаете кнопку "_получить_" в программе вашего кошелька, вам каждый раз предлагается неиспользуемый адрес получения. После получения биткоина на этот адрес программа автоматически предлагает новый адрес.

> _PS: Недавно некоторые программы для создания кошельков объявили о своем намерении прекратить генерировать пустые адреса, опасаясь, что это может быть воспринято властями как форма отмывания денег. Если ваше программное обеспечение входит в их число, я настоятельно советую вам немедленно заменить его, поскольку это неприемлемо для пользователей._
Если вам нужен статический идентификатор для получения платежей, например, для приема пожертвований, использовать классический адрес Bitcoin не рекомендуется из-за риска повторного использования. Лучше использовать Lightning-адрес, а для статического платежного идентификатора на цепочке можно выбрать BIP47 или Silent Payments. О том, как работают эти протоколы, подробно рассказывается в части 6 этого тренинга.

## Маркировка и контроль монет

<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>

Как мы выяснили в разделе, посвященном анализу цепочек, существует множество эвристик и шаблонов, которые можно использовать для получения информации о транзакции. Пользователю важно знать об этих методах, чтобы лучше защитить себя.

Это в значительной степени предполагает строгое управление кошельком, находящимся на личном хранении, что включает в себя знание происхождения своих UTXO, а также продуманный выбор UTXO, которые будут расходоваться во время платежей. Такое эффективное управление кошельком опирается на две важные особенности хороших биткойн-кошельков: маркировку и контроль монет.

В этой главе мы изучим эти функции и посмотрим, как можно использовать их разумно, без лишней нагрузки, чтобы значительно оптимизировать вашу конфиденциальность в Bitcoin.

### Что такое маркировка?

Тегирование - это практика, которая заключается в присвоении аннотации или метки определенному UTXO в кошельке Биткойн. Эти аннотации хранятся локально в программном обеспечении кошелька и никогда не передаются по сети Биткойн. Таким образом, тегирование - это инструмент для персонального управления.

Например, если я владею UTXO в результате P2P-покупки на Bisq с Charles, я могу присвоить ему метку "`Non-KYC Bisq Charles`".

Пометка - это хорошая практика, которая помогает запомнить происхождение или целевое назначение UTXO, тем самым облегчая управление средствами и оптимизируя конфиденциальность. На самом деле в вашем биткойн-кошельке, скорее всего, содержится несколько UTXO. Если источники этих UTXO различны, вы не захотите объединять их в будущем, иначе вы можете раскрыть их общую собственность. Правильно маркируя все свои монеты, вы гарантируете, что вспомните их происхождение, когда они вам понадобятся, даже если это произойдет не раньше, чем через несколько лет.

### Что такое контроль монет?

Активное использование меток становится еще более привлекательным в сочетании с опцией управления монетами в программном обеспечении вашего кошелька.

Контроль монет - это функция в хорошем программном обеспечении для биткойн-кошелька, которая позволяет вручную выбирать определенные UTXO для использования в качестве входных данных при совершении транзакции. Фактически, чтобы удовлетворить исходящий платеж, вы должны потреблять входящий UTXO в ответ. По ряду причин, которые мы рассмотрим далее, вы можете захотеть точно выбрать, какие монеты использовать в качестве входных для удовлетворения данного платежа. Именно это и позволяет сделать управление монетами. Если привести аналогию, то эта функциональность похожа на выбор определенной монеты в вашем кошельке при оплате багета.

Использование программного обеспечения для кошельков, управляемых монетами, в сочетании с маркировкой UTXO позволяет пользователям точно различать и выбирать UTXO для своих транзакций.

### Как правильно маркировать UTXO?

Не существует универсального метода маркировки UTXO, который подходил бы всем. Вы сами должны определить систему маркировки, чтобы вам было легче ориентироваться в своем портфеле. В любом случае помните, что хорошая маркировка - это то, что вы сможете понять, когда вам это понадобится. Если ваш биткойн-кошелек предназначен в первую очередь для сбережений, то, возможно, этикетки пригодятся вам только через несколько десятилетий. Поэтому позаботьтесь о том, чтобы они были четкими, точными и всеобъемлющими.

Важно, чтобы ваши близкие могли легко определить источник средств, если в один прекрасный день им понадобится доступ к вашему портфелю. Это может помочь им как в целях конфиденциальности, так и в юридических целях, если им понадобится обосновать происхождение средств перед какой-либо инстанцией.

Наиболее важным аспектом маркировки является указание источника UTXO. Вы должны просто указать, как эта монета попала в ваш кошелек. Была ли она получена в результате покупки на биржевой площадке? Платеж от клиента? Пиринговый обмен? Или это остаток от покупки? Таким образом, вы можете указать:


- `Pickup Exchange.com`;
- `Платежный клиент Дэвид`;
- купить P2P Charles;
- `Возврат от покупки дивана`

Чтобы усовершенствовать управление UTXO и придерживаться стратегии разделения средств в портфеле, вы можете дополнить свои этикетки дополнительным маркером, отражающим это разделение. Если в вашем портфеле есть две категории UTXO, которые вы не хотите смешивать, вы можете включить в этикетки маркер, чтобы четко разграничить эти группы. Эти разделительные маркеры будут зависеть от ваших критериев, например, для разграничения UTXO в процессе приобретения, включающем KYC, или между профессиональными и личными фондами. Если взять ранее упомянутые примеры этикеток, то это может выглядеть следующим образом:


- `KYC - Exchange.com Withdrawal`;
- `KYC - Customer Payment David`;
- `NO KYC - Покупка P2P Charles`;
- `NO KYC - остаток от покупки дивана`

Также рекомендуется сохранять маркировку монеты во время транзакций. Например, при консолидации UTXO без KYC обязательно пометьте получившийся UTXO не только как `консолидацию`, но и как `консолидацию без KYC`, чтобы сохранить четкий след происхождения монеты.

Наконец, не обязательно указывать дату на этикетке. Большинство программ для кошельков уже показывают дату транзакции, и всегда можно получить эту информацию в блокчейн-проводнике по его TXID.

### Как правильно выбрать монеты?

Когда вы совершаете транзакцию, управление монетами позволяет вам выбрать, какие UTXO будут использоваться в качестве входных данных для удовлетворения платежного результата. При этом выборе следует учитывать два аспекта:


- Возможность для получателя платежа связать часть вашей личности с UTXO, используемыми в качестве входных данных;
- Способность стороннего наблюдателя устанавливать связи между всеми UTXO, используемыми в качестве входных данных.

Чтобы проиллюстрировать первый пункт, давайте рассмотрим конкретный пример. Предположим, вы покупаете багет за биткоины у местного пекаря. Вы используете один или несколько собственных UTXO в качестве входных данных, чтобы покрыть как минимум стоимость багета на выходе, плюс комиссионные за транзакцию. После этого пекарь может связать ваше лицо или любую другую известную ему часть вашей личности с монетами, используемыми в качестве входных данных. Зная о существовании такой связи, вы, возможно, предпочтете выбрать один конкретный UTXO, а не другой при совершении платежа.

Например, если один из ваших UTXO пришел с обменной платформы, и вы предпочитаете, чтобы пекарь не знал о вашем счете на этой платформе, вы избежите использования этого UTXO для оплаты. Если у вас есть UTXO с высокой стоимостью, который показывает значительную сумму биткоинов, вы также можете не использовать его, чтобы пекарь не узнал о вашем состоянии в BTC.

Поэтому выбор UTXO для этого первого пункта основывается на личном решении, на которое влияет то, что вы готовы раскрыть или не раскрыть. Ярлыки, которые вы присвоили своим UTXO при получении, помогут вам выбрать те, которые при расходовании будут отображать только ту информацию, которую вам удобно раскрыть получателю.

Помимо информации, которая потенциально может быть раскрыта получателю, ваш выбор входных данных также влияет на то, что вы раскрываете всем наблюдателям блокчейна. Фактически, используя несколько UTXO в качестве входных данных для своей транзакции, вы раскрываете, что они принадлежат одному и тому же субъекту, согласно эвристике общего владения входными данными (CIOH).

Поэтому, выбирая монеты, вы должны понимать, что транзакция, которую вы собираетесь передать, создаст связь между всеми используемыми UTXO. Эта связь может быть проблематичной для вашей личной конфиденциальности, особенно если UTXO получены из разных источников.

Вернемся к примеру с UTXO без KYC от Bisq; я хочу избежать объединения его с UTXO, скажем, от регулируемой биржевой платформы, которая знает мою личность. На самом деле, если бы я когда-нибудь использовал эти два UTXO в качестве входов в одной транзакции, регулируемая платформа смогла бы связать мою личность с UTXO, который я купил на Bisq, тогда как раньше он не был связан с моей личностью.

Наконец, чтобы правильно выбрать, какие UTXO использовать в качестве входных данных для транзакции, самое главное - избегать использования нескольких UTXO. По возможности выбирайте одну монету, достаточно крупную, чтобы покрыть платеж. Таким образом вы полностью избежите рисков, связанных с COINJOIN. Однако если ни одного UTXO не хватает для оплаты и вам необходимо использовать несколько, убедитесь, что они получены из похожих источников, чтобы минимизировать риски нежелательных связей. Кроме того, имейте в виду, что получатель может связать имеющуюся у него информацию о вас с историей монет, используемых в качестве исходных данных.

### Понимание автоматического выбора монет

В предыдущих разделах мы обсуждали ручной выбор UTXO для транзакции. Но что происходит, когда программа кошелька делает этот выбор автоматически? Существует несколько методов определения монет для потребления, и выбор UTXO - это настоящее поле для исследований в Биткойне. Основной целью этого автоматического процесса часто является минимизация транзакционных комиссий для пользователя.

Методы выбора UTXO, такие как FIFO (_First In First Out_) и LIFO (_Last In First Out_), являются одними из самых простых, но и наименее эффективных. При FIFO в первую очередь используются самые старые монеты в портфеле. Этот подход в целом неэффективен как для минимизации транзакционных сборов, так и для сохранения конфиденциальности, за исключением случаев, когда используются относительные временные часы, которые необходимо регулярно обновлять. В отличие от этого, LIFO предусматривает приоритетное использование самых последних UTXO. Несмотря на простоту, эти два метода часто оказываются неэффективными.

Более продвинутым методом является _Knapsack Solver_. Этот метод использовался в кошельке Bitcoin Core вплоть до версии 0.17. Он заключается в итеративном и случайном выборе UTXO из кошелька, суммировании их в подгруппы и сохранении решения, которое максимально снижает вес транзакции, чтобы уменьшить комиссию пользователя.

Метод _Branch-and-Bound_ (BNB), который часто называют "алгоритмом Мерча" в честь его изобретателя, заменил _Knapsack Solver_ в Bitcoin Core, начиная с версии 0.17. Этот более продвинутый метод нацелен на поиск набора UTXO, который точно соответствует сумме, необходимой для удовлетворения выходов транзакции. Цель BNB - минимизировать сумму остатка, а также комиссионные сборы за счет уменьшения так называемого критерия отходов, который учитывает как немедленные затраты, так и ожидаемые будущие затраты на остаток. Этот метод является производным от оригинальной концепции _Branch-and-Bound_, разработанной в 1960 году Эйлсой Лэнд и Элисон Харкорт, и предлагает более точную оптимизацию комиссионных, чем _Knapsack Solver_.

Все эти методы автоматического выбора UTXO могут быть эффективны для снижения транзакционных сборов, но они часто неэффективны для сохранения конфиденциальности пользователя. Фактически, эти алгоритмы могут объединить несколько UTXO на входе, тем самым выявив общее владение этими UTXO из-за COH. Очевидно, что эти методы не могут учитывать метки, прикрепленные к UTXO, которые имеют решающее значение для осознанного выбора монет, которые следует раскрыть получателю транзакции. В настоящее время единственным решением для оптимизации конфиденциальности при выборе монет является ручной выбор.

### Учебник по маркировке UTXO

Если вы хотите узнать, как пометить свои UTXO, мы подготовили исчерпывающее руководство по основным существующим программам для биткойн-кошельков:

https://planb.network/tutorials/privacy/on-chain/utxo-labelling-d997f80f-8a96-45b5-8a4e-a3e1b7788c52
## KYC и идентификация ключей

<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>

KYC расшифровывается как "Know Your Customer" ("Знай своего клиента"), что является нормативной процедурой, применяемой некоторыми компаниями, работающими в биткоин-индустрии. Эта процедура направлена на проверку и регистрацию личности своих клиентов с заявленной целью борьбы с отмыванием денег и финансированием терроризма.

Конкретно KYC подразумевает сбор различных личных данных клиента, которые могут отличаться в зависимости от юрисдикции, но обычно включают в себя удостоверение личности, фотографию и подтверждение места жительства. Затем эта информация проверяется и сохраняется для дальнейшего использования.

Эта процедура стала обязательной для всех регулируемых обменных платформ в большинстве западных стран. Это означает, что все желающие обменять фиатную валюту на биткоин через эти платформы должны соблюдать требования KYC.

Эта процедура не лишена рисков для конфиденциальности и безопасности пользователей. В этой главе мы подробно рассмотрим эти риски и проанализируем конкретное влияние процессов KYC и идентификации на конфиденциальность пользователей Биткойна.

### Облегчение отслеживания цепей

Первый риск, связанный с KYC, заключается в том, что он обеспечивает предпочтительную точку входа для анализа блокчейна. Как мы видели в предыдущем разделе, аналитики могут группировать и отслеживать активность в блокчейне, используя шаблоны транзакций и эвристику. Как только им удается сгруппировать активность пользователя на блокчейне, достаточно найти только одну точку входа среди всех его транзакций и ключей, чтобы полностью нарушить конфиденциальность.

![BTC204](assets/fr/078.webp)

Когда вы подаете заявку на KYC, вы предоставляете очень качественную точку входа для анализа цепочки, поскольку связываете адреса получения, используемые при выводе биткоинов с обменной платформы, с вашей полной, подтвержденной личностью. Теоретически эта информация известна только компании, которой вы ее предоставили, но, как мы увидим далее, риск потери данных вполне реален. Более того, сам факт того, что компания владеет этой информацией, может быть проблематичным, даже если она ею не делится.

Таким образом, если не будут приняты другие меры по ограничению объединения действий человека в блокчейне, любой, кто знает о точке входа, которой является KYC, потенциально может связать все его действия в Bitcoin с его личностью. С точки зрения этой компании, использование биткойна теряет всякую конфиденциальность.

![BTC204](assets/fr/079.webp)

Чтобы проиллюстрировать это сравнением, можно представить, как если бы банкир в _банке X_ имел доступ не только ко всем операциям, совершенным в _банке X_, но и мог наблюдать за операциями в _банке Y_ и всеми собственными денежными операциями.

Вспомните из первой части этого курса: модель конфиденциальности биткойна, разработанная Сатоши Накамото, основана на разделении личности пользователя и его пары ключей. Хотя сегодня этот уровень конфиденциальности уже недостаточен, все же разумно ограничить его деградацию, насколько это возможно.

### Подверженность государственному надзору

Вторая основная проблема KYC заключается в том, что она раскрывает государству информацию о том, что человек когда-то владел биткоином. Когда вы приобретаете биткоины через регулируемого игрока, государство получает возможность узнать об этом владении. В настоящее время это может показаться мелочью, но важно помнить, что политическое и экономическое будущее своей страны находится не в его собственных руках.

Во-первых, государство может быстро занять авторитарную позицию. История полна примеров, когда политика резко менялась. Сегодня в Европе энтузиасты биткойна могут писать о нем статьи, посещать конференции и управлять собственными кошельками. Но кто может сказать, что будет завтра? Если биткойн внезапно станет врагом общества номер один, то его ассоциирование с ним в государственных реестрах может оказаться проблематичным.

Позже, в условиях серьезного экономического кризиса, государство может задуматься о конфискации биткоинов, принадлежащих гражданам. Возможно, завтра биткоинщиков сочтут воспользовавшимися кризисом и обложат чрезмерными налогами из-за их прироста капитала в условиях девальвации фиатной валюты.

Вы можете подумать, что это не проблема, потому что ваши биткоины перемешиваются и поэтому их невозможно отследить. Однако отслеживание - это не проблема. Настоящая проблема заключается в том, что государство знает, что вы владеете биткоинами. Этой простой информации может быть достаточно, чтобы уличить вас или потребовать отчета. Вы можете попытаться заявить, что потратили свои биткоины, но это должно быть отражено в вашей налоговой декларации, и вы будете обнаружены. Вы также можете сказать, что потеряли ключи в результате несчастного случая на лодке, но, кроме шуток в Twitter, неужели вы думаете, что этого будет достаточно, чтобы оправдать вас?

Поэтому важно учитывать риск, связанный с тем, что государство может узнать о том, что вы владеете BTC, даже если сегодня этот риск может казаться далеким.

Еще одна проблема, связанная с KYC с точки зрения государственного надзора, - обязательная отчетность регулируемых платформ. Хотя я не знаком с правилами других юрисдикций, во Франции _провайдеры услуг цифровых активов_ (PSAN) обязаны сообщать финансовому надзору о любом движении средств, которое они считают подозрительным.

Так, во Франции в 2023 году PSAN сообщили о 1 449 подозрительных действиях. На данный момент большинство из этих действий связаны с преступностью. Однако власти также просят регулируемые платформы сообщать о любых подозрительных транзакциях с биткоинами, основанных исключительно на их структуре. Если вы проводите совместную транзакцию или даже просто транзакцию, которая имеет несколько нетипичную структуру, и эта транзакция происходит рядом с выводом ваших биткоинов с этих платформ, вы можете попасть в поле зрения властей. Даже в отсутствие правонарушений и при законном осуществлении ваших прав такое сообщение может привести к усилению контроля и слежки - неудобствам, которых вы могли бы избежать без KYC.

### Риск потери персональных данных

Еще одна проблема KYC заключается в том, что она требует хранения всех ваших личных данных на серверах частной компании. Недавние события напомнили нам, что никто не застрахован от неудач, будь то финансовые или связанные с ИТ. В 2022 году от последствий пострадали клиенты Celsius. В результате банкротства компании имена кредиторов и сумма их активов были обнародованы американской судебной системой в ходе административного разбирательства.

Чуть более двух лет назад одна из ведущих компаний в области кибербезопасности в криптовалютной сфере пострадала от кражи личных данных своих клиентов. Хотя этот инцидент не был напрямую связан с покупкой биткоина, подобный риск сохраняется и для обменных платформ. Таким образом, существует определенный риск, связанный с этими персональными данными.

Действительно, мы и так доверяем большую часть своих личных данных частным компаниям. Однако здесь риск двойной, поскольку эти данные не только позволяют вас идентифицировать, но и связаны с активностью в биткоине. Ведь если хакеру удается получить доступ к данным клиентов обменной платформы, он может обоснованно предположить, что эти клиенты владеют биткоином. Этот риск усугубляется тем, что биткоин, как и любой другой ценный актив, привлекает интерес воров.

В случае утечки данных в лучшем случае вы можете стать объектом целенаправленных фишинговых атак. В худшем случае вы можете оказаться в центре физической угрозы вашему дому.

Помимо специфических рисков, связанных с биткойном, необходимо также учитывать опасности, связанные с передачей документов, удостоверяющих личность. Ведь в случае утечки данных можно стать жертвой кражи личности. Таким образом, рассматриваемые вопросы не только ограничиваются защитой конфиденциальности транзакций, но и затрагивают личную безопасность каждого человека.

### Распространенные заблуждения относительно KYC

Важно развеять некоторые распространенные заблуждения о KYC, которые часто встречаются в Twitter или в наших обсуждениях среди биткоинщиков.

Прежде всего, ошибочно думать, что защита конфиденциальности биткоинов, приобретенных с помощью KYC (Know Your Customer), бесполезна. Инструменты и методы обеспечения конфиденциальности в биткоине разнообразны и служат разным целям. Например, использование транзакций coinjoin в биткоине с KYC - неплохая идея. Конечно, с регулируемыми обменными платформами нужно быть осторожным, чтобы избежать замораживания или запрета аккаунта, но с чисто технической точки зрения эти методы не являются несовместимыми. Coinjoin имеет эффект разрушения истории монеты, что помогает противостоять некоторым рискам анализа цепочки, связанным с KYC. Хотя это не устраняет все риски, это уже значительное преимущество.

Конфиденциальность биткоина не должна рассматриваться двоично, как различие между "анонимными" биткоинами и теми, которые таковыми не являются. Владение биткоинами, приобретенными через KYC, не означает, что все потеряно; напротив, использование инструментов конфиденциальности может оказаться даже более выгодным.

И наоборот, приобретение биткоина с помощью метода, не связанного с KYC, не гарантирует полной конфиденциальности и не освобождает вас от необходимости принимать другие меры защиты. Если вы владеете биткоином, не имеющим статуса KYC, но многократно используете адреса получения, ваши транзакции могут быть отслежены и сгруппированы. Малейшая связь с миром за пределами биткойна может поставить под угрозу единственный уровень конфиденциальности, который у вас был. Поэтому важно рассматривать все инструменты и методы, улучшающие конфиденциальность биткойна, как дополнительные. Каждый метод направлен на устранение конкретного риска и может добавить дополнительный уровень защиты. Таким образом, владение биткоином без KYC абсолютно не освобождает вас от принятия других мер предосторожности.

### Можно ли отменить KYC?

Меня иногда спрашивают, можно ли "вернуться назад" после завершения KYC, и, как вы можете понять из предыдущих абзацев, ответ на этот вопрос имеет свои нюансы. Чтобы избежать рисков, связанных с KYC, самый простой способ - не использовать его при приобретении биткоинов. Мы подробно остановимся на этой теме в следующей главе. Однако если KYC уже проведен и биткоины приобретены, существуют ли способы снизить возникающие риски?

Что касается риска отслеживания ваших транзакций, то одним из решений является использование coinjoin. Мы подробно обсудим этот метод позже в тренинге, но знайте, что coinjoin может нарушить историю монеты и помешать отслеживать ее прошлое-настоящее и настоящее-прошлое. Даже для BTC, полученных через регулируемую платформу, этот метод может помешать отследить их.

Однако coinjoin не устраняет второй риск, связанный с KYC: тот факт, что государство осведомлено о ваших биткоинах. На самом деле, даже если ваши монеты больше не отслеживаются, государство, в зависимости от юрисдикции, может иметь доступ к вашим криптоактивным заявлениям об отчуждении. Поскольку этот риск является не техническим, а административным, не существует специфических для биткоина решений для его устранения, кроме первоначального избежания воздействия KYC. Единственный законный подход к снижению этого риска - продать свои биткоины, приобретенные через регулируемые платформы, на регулируемых платформах, а затем выкупить их обратно с помощью средств, не требующих KYC. Продав и объявив о продаже, администрация должна отметить, что вы больше ими не владеете.

Что касается риска раскрытия ваших личных данных и документов, удостоверяющих личность, то это опасность, не связанная с биткойном, и не существует технического решения, позволяющего избежать ее. После того как ваши данные были раскрыты, это сложно изменить. Вы можете попытаться закрыть свой счет на платформе, но это не гарантирует удаления ваших KYC-данных, особенно если проверка личности передана на аутсорсинг. Проверить полное удаление вашей информации невозможно. Поэтому не существует решения, позволяющего полностью предотвратить этот риск и гарантировать, что его больше не существует.

### Разница между KYC и идентификацией ключей

Иногда некоторые биткойнеры склонны распространять термин "KYC" на любой обмен BTC, включающий перевод или оплату кредитной картой, поскольку эти способы также могут раскрыть происхождение платежа, как и KYC. Однако важно не путать KYC с идентификацией ключа. Лично я должен признать, что мое восприятие этой темы со временем изменилось.

KYC - это нормативная процедура, применяемая некоторыми компаниями для проверки и регистрации личности своих клиентов. Это бинарный вопрос: когда вы приобретаете биткоины, вы либо подчиняетесь KYC, либо нет. Однако ключевая идентификация, которая заключается в привязке какого-либо аспекта личности пользователя к ончейн-активности, не столь бинарна, а скорее представляет собой континуум. Действительно, в контексте покупки или продажи биткоина такая идентификация всегда возможна в той или иной степени.

Например, если вы покупаете биткоин на регулируемой платформе в Швейцарии, KYC (Know Your Customer) не требуется. Однако может произойти идентификация ваших ключей, поскольку покупка была совершена через ваш банковский счет. Именно здесь возникают первые два риска, связанные с KYC, - облегчение отслеживания на цепочке и подверженность правительственной слежке, - которые могут проявиться и при обмене без KYC. Если швейцарская компания сообщит о подозрительных транзакциях властям вашей страны, они могут просто проверить банковский счет, использованный для покупки, чтобы выяснить вашу личность. Таким образом, покупка без KYC на регулируемых платформах занимает довольно высокое место на шкале рисков для идентификации ключей.

Однако отказ от регулируемых платформ и выбор методов приобретения P2P (Peer-to-Peer) не устраняет полностью риск идентификации ключа, а лишь снижает его. Рассмотрим пример покупки на Bisq или другой P2P-платформе. Чтобы рассчитаться с контрагентом, вы, скорее всего, воспользуетесь своим банковским счетом. Если власти допросят человека, с которым вы торговались, и спросят ваше имя, мы столкнемся с рисками 1 и 2, о которых говорилось выше. Эти риски, конечно, гораздо ниже, чем при покупке на платформе без KYC, и даже ниже, чем при покупке с KYC, но все же они присутствуют в меньшей степени.

Наконец, даже если вы приобрели биткоины через физический обменник, вы не полностью анонимны. Человек, с которым вы имели дело, видел ваше лицо, которое является частью вашей личности. Хотя в данном примере вероятность наличия идентификационного ключа минимальна, она все же существует.

В заключение следует отметить, что при обмене биткоина на другие активы, будь то покупка фиатной валюты или продажа реального актива, всегда присутствует форма идентификации ключа. В зависимости от выбранного способа обмена эта идентификация может быть разной степени интенсивности. Важно не путать эту идентификацию с KYC, которая представляет собой четко определенный нормативный процесс. Однако между KYC и спектром идентификации существует связь, поскольку KYC находится в верхней части этого спектра, так как он систематически облегчает идентификацию ключей пользователей органами власти.

## Методы продаж и приобретения

<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>

Прочитав предыдущую главу, вы, возможно, зададитесь вопросом, как купить или продать биткоин, не проходя процедуру проверки личности, чтобы избежать рисков, связанных с KYC. Существует несколько способов совершения обмена.

### Обмен P2P на наличные

Как мы уже убедились, лучшим методом с точки зрения конфиденциальности остается P2P (peer-to-peer) обмен с наличным расчетом. Этот метод позволяет минимизировать оставляемые следы и значительно снижает возможность идентификации ключа, независимо от того, являетесь ли вы покупателем или продавцом.

Однако такая практика сопряжена с рисками для личной безопасности. Основная опасность заключается в том, что во время обмена контрагент узнает, что вы владеете значительной суммой либо наличными, либо биткоинами. Эта информация может привлечь внимание злоумышленников. Поэтому, как правило, рекомендуется сохранять сдержанность в отношении владения биткоином. Этот совет можно применить и к наличным. Однако при личном обмене неизбежно придется рассказать о том, что вы владеете биткоином, что может вызвать жадность.

Чтобы ограничить этот риск, я рекомендую вам отдавать предпочтение наличным операциям с доверенными людьми, такими как члены семьи или близкие друзья. Кроме того, вы можете рассмотреть возможность обмена на [локальных биткойн-встречах](https://btcmap.org/communities/map), посетив их несколько раз. Это позволит вам лучше узнать других участников и не оставаться в одиночестве во время физического обмена. Однако важно понимать, что P2P-обмен наличными по своей сути несет риски для вашей личной безопасности, которых нет при совершении покупок через регулируемую платформу и ваш банковский счет.

Кроме того, в зависимости от того, где вы живете, транспортировка и хранение крупных сумм денег, будь то биткоин или наличные, может представлять опасность.

Обмен наличных также может представлять юридический риск при полицейской или иной проверке. Хотя в большинстве стран нет ограничений на количество наличных денег, которые вы можете иметь при себе, слишком большие суммы могут вызвать подозрение. Поэтому будьте осторожны, особенно если вам приходится путешествовать на большие расстояния, и избегайте слишком крупных сделок сразу, чтобы не пришлось оправдываться за обладание значительными суммами.

Наконец, еще одним недостатком P2P-покупок является то, что цена зачастую выше, чем на регулируемых платформах. Продавцы часто взимают наценку от 1 % до более чем 10 %. Такая разница в цене объясняется несколькими причинами. Во-первых, это обычная практика среди продавцов P2P, которая установилась с течением времени. Кроме того, продавцы берут комиссию за транзакции, связанные с отправкой средств покупателю. Риск кражи при продажах через P2P также выше, чем при сделках на платформе, что оправдывает плату за риск. Наконец, премия может зависеть от спроса и качества обмена с точки зрения конфиденциальности. Для покупателя выгода от конфиденциальности закладывается в цену наценки, взимаемой продавцом. Некоторые биткойнеры также считают, что рост цен на BTC, приобретенные в P2P, отражает их истинную стоимость, и утверждают, что более низкие цены на регулируемых платформах - результат компромисса в отношении конфиденциальности вашей личной информации.

### P2P-обмен через платформу подбора

Менее рискованной альтернативой с точки зрения личной безопасности является проведение P2P-обменов исключительно онлайн, с помощью электронных методов оплаты, таких как PayPal, банковские переводы или Revolut.

Такой подход позволяет избежать многих рисков, связанных с операциями с наличными. Однако риск того, что контрагент не выполнит свои обязательства во время онлайн-обмена, выше. Ведь при физическом обмене, если вы передадите деньги продавцу, который не пришлет вам биткоины в ответ, вы можете сразу же его отчитать, поскольку он стоит перед вами. С другой стороны, в Интернете зачастую невозможно найти человека, который вас обманул.

Чтобы снизить этот риск, для P2P-обменов можно использовать специализированные платформы подбора. Эти платформы используют механизмы разрешения конфликтов для защиты пострадавших пользователей. Как правило, они предлагают систему эскроу, где биткоины хранятся до тех пор, пока продавец не подтвердит оплату в фиатной валюте.

С точки зрения личной безопасности этот способ покупки значительно безопаснее, чем физический обмен наличных. Однако, как упоминалось ранее, онлайн P2P-обменники оставляют больше следов, чем физический обмен, что может негативно сказаться на конфиденциальности Биткойна. Используя фиатные онлайн-платежи, например в банке, вы раскрываете больше информации, которая может облегчить идентификацию ключа.

Еще раз повторю, что я не рекомендую заключать на этих платформах крупные сделки в рамках одной транзакции. Разбивая сделки на части, вы распределяете риски, связанные с возможным хищением со стороны контрагента.

Еще одним недостатком P2P-покупок является то, что цена зачастую выше, чем на регулируемых платформах. Продавцы часто взимают наценку от 1 % до иногда более 10 %. Такая разница в цене объясняется несколькими причинами. Во-первых, это обычная практика среди продавцов P2P, которая установилась с течением времени. Кроме того, продавцы берут комиссию за транзакции, связанные с отправкой средств покупателю. Риск кражи при продажах через P2P также выше, чем при сделках на платформе, что оправдывает плату за риск. Наконец, премия может зависеть от спроса и качества обмена с точки зрения конфиденциальности. Для покупателя выгода от конфиденциальности закладывается в цену наценки, взимаемой продавцом. Некоторые биткойнеры также считают, что более высокая цена на BTC, купленные через P2P, отражает их истинную стоимость, и утверждают, что более низкие цены на регулируемых платформах являются результатом компромисса в отношении конфиденциальности вашей личной информации.

Что касается решений, то лично я всегда использовал [Bisq](https://bisq.network/) и был очень доволен. Их система хорошо отлажена и кажется надежной. Однако Bisq доступна только на ПК, и ее интерфейс может оказаться слишком сложным для новичков. Еще одним недостатком является то, что Bisq работает исключительно с транзакциями onchain, которые могут стать дорогостоящими в периоды высоких транзакционных сборов Bitcoin.

-> Узнайте о нашем учебном пособии по Bisq.

https://planb.network/tutorials/exchange/peer-to-peer/bisq-fe244bfa-dcc4-4522-8ec7-92223373ed04
Для более простого варианта вы можете попробовать [Peach](https://peachbitcoin.com/) - мобильное приложение, которое облегчает связь между продавцами и покупателями с помощью интегрированной системы разрешения споров. Процесс более интуитивен, чем у Bisq.

-> Узнайте о нашем учебном пособии по персику.

Еще один онлайн-опцион - [HodlHodl](https://hodlhodl.com/), хорошо зарекомендовавшая себя платформа, предлагающая хорошую ликвидность, хотя лично я ее не тестировал.

-> Узнайте о нашем учебном пособии по HodlHodl.

https://planb.network/tutorials/exchange/peer-to-peer/peach-wallet-db64fe42-17ca-4b24-abb8-e7d4c03b2028
https://planb.network/tutorials/exchange/peer-to-peer/hodlhodl-d7344cd5-6b18-40f5-8e78-2574a93a3879
Для решений на основе Lightning Network можно попробовать [RoboSats](https://learn.robosats.com/) и [LNP2PBot](https://lnp2pbot.com/). RoboSats доступен через веб-сайт и относительно прост в использовании. LNP2PBot более нетипичен, поскольку работает через систему обмена в приложении для обмена сообщениями Telegram.

-> Ознакомьтесь с нашим учебным пособием по RoboSats.

-> Ознакомьтесь с нашим учебным пособием по LNP2PBot.

https://planb.network/tutorials/exchange/peer-to-peer/robosats-b60e4f7c-533a-4295-9f6d-5368152e8c06
https://planb.network/tutorials/exchange/peer-to-peer/lnp2pbot-v2-e6bcb210-610b-487d-970c-7cce85273e3c
### Регулируемые платформы без KYC

В зависимости от страны, в которой вы живете, у вас может быть доступ к регулируемым платформам, которые не требуют процедуры KYC для покупки или продажи биткоина. В Швейцарии, например, вы можете использовать такие платформы, как [Relai](https://relai.app/) и [MtPelerin](https://www.mtpelerin.com/).

-> Узнайте о нашем учебнике по Relai.

Как мы видели в предыдущей главе, этот тип платформ избавляет вас от рисков, связанных с процедурами KYC, но они представляют более высокий уровень риска для идентификации ключей. Таким образом, с точки зрения конфиденциальности биткойна эти платформы обеспечивают лучшую защиту, чем методы покупки KYC, но менее привлекательны, чем P2P-биржи.

Однако с точки зрения личной безопасности использование этих платформ значительно менее рискованно, чем P2P-бирж. Кроме того, они зачастую проще в использовании, чем платформы, способствующие обмену P2P.

https://planb.network/tutorials/exchange/centralized/relai-v2-30a9671d-e407-459d-9203-4c3eae15b30e
### БАНКОМАТ

Еще один вариант купить или продать биткоин без KYC - криптовалютные банкоматы (ATM). Лично у меня не было возможности протестировать это решение, поскольку в моей стране их нет. Но этот способ может быть очень интересным в зависимости от того, где вы живете.

Проблема с банкоматами заключается в том, что в одних странах они запрещены, а в других - жестко регулируются. Если банкомат требует проверки личности, то он сталкивается с теми же рисками, что и регулируемые платформы KYC. Однако если банкомат позволяет проводить операции без проверки личности на небольшие суммы, то его использование может обеспечить уровень конфиденциальности, сопоставимый с уровнем конфиденциальности P2P-обмена наличными, избегая большинства рисков, связанных с этим типом обмена.

Основным недостатком банкоматов является часто высокая комиссия за обмен валюты, которая варьируется от нескольких процентов до 15 процентов от суммы обмена.

### Подарочные карты

Наконец, я также хотел представить решение, которое хорошо подходит для тех, кто хочет ежедневно использовать свои биткоины для покупок, а не продавать их за фиатную валюту.

Лучший способ потратить BTC - это, очевидно, использовать биткоин напрямую или через сеть Lightning Network для покупки товаров или услуг. Однако во многих странах количество торговых точек, принимающих биткоин, по-прежнему ограничено. Поэтому практичной альтернативой является использование подарочных карт.

Несколько платформ, не требующих прохождения процедуры KYC, предлагают возможность обмена биткоинов на подарочные карты, которые можно использовать в крупных магазинах. К таким платформам относятся [CoinsBee](https://www.coinsbee.com/), [The Bitcoin Company](https://thebitcoincompany.com/) и [Bitrefill](https://www.bitrefill.com/). Эти платформы значительно облегчают ежедневное использование ваших биткоинов, позволяя вам получить доступ к широкому спектру товаров и услуг без необходимости конвертации фиатной валюты.

https://planb.network/tutorials/exchange/centralized/bitrefill-8c588412-1bfc-465b-9bca-e647a647fbc1
### Другие способы приобретения

Среди других способов получения биткоинов при сохранении конфиденциальности - конечно же, майнинг. Чтобы начать добывать саты, вам не нужно раскрывать свою личность; просто найдите действительное подтверждение занятости и отправьте его в сеть. Если вы выбираете пул для майнинга, некоторые пулы требуют идентификации личности, например KYC, а другие - нет.

Другой способ - работа в обмен на биткоины. Этот способ приобретения может быть привлекательным, но степень необходимой идентификации сильно варьируется в зависимости от обстоятельств.

\ Для написания этой главы я использовал курс BTC205, созданный [@pivi\_\_](https://x.com/pivi___) в сети Plan ₿ (пока он доступен только на французском языке)\_

## Консолидация, управление UTXO и CIOH

<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>

Одним из самых сложных аспектов управления собственным портфелем складских помещений, несомненно, является консолидация. Нужно ли вам консолидироваться? С какой целью? Какого размера UTXO вы должны стремиться достичь? Каковы компромиссы с конфиденциальностью? Именно это мы и попытаемся выяснить в данном разделе.

### Что такое консолидация?

Работа Bitcoin похожа на аукционный рынок, где майнеры отдают предпочтение транзакциям, предлагающим наилучшую плату. Однако каждый блок имеет максимальный вес, ограничивающий количество транзакций, которые могут быть в него включены. Поскольку блок создается в среднем каждые 10 минут, свободное место в каждом блоке является редким ресурсом.

Майнеры, чья деятельность связана со значительными затратами на электроэнергию, капитал и обслуживание, естественно, стремятся к максимальной прибыльности. Они, как правило, отдают предпочтение сделкам, которые предлагают им самые высокие комиссии по отношению к их весу.

На самом деле, не все транзакции Биткойна имеют одинаковый вес. Те, в которых больше входов и выходов, весят больше. Например, рассмотрим 2 транзакции:


- Транзакция A включает 1 вход и 1 выход. Она присваивает 1 994 сата сборов, а ее вес составляет 141 vB;
- Более сложная транзакция B, с 2 входами и 2 выходами, выделяет 2 640 сатов комиссионных за вес 220 vB.

В примере, хотя транзакция B предлагает более высокую комиссию, майнеры предпочтут транзакцию A, потому что она предлагает лучшее соотношение комиссии к весу. Вот расчеты для каждой транзакции, выраженные в сатах за виртуальный байт (sat/vB):

```text
TXA: 1994 / 141 = 14 sat/vB
TXB: 2640 / 220 = 12 sat / vB
```

Это означает, что за каждую единицу веса транзакция A предлагает больше комиссионных, чем транзакция B, даже если последняя предлагает больше комиссионных в абсолютном выражении.

Поэтому для пользователя становится все более привлекательным потреблять минимально возможное количество входных данных в своих транзакциях. Однако необходимо потреблять достаточное количество, чтобы удовлетворить выходной платеж. Поэтому при управлении своим портфелем необходимо иметь достаточно большие UTXO.

Принцип консолидации как раз и заключается в том, чтобы воспользоваться периодами, когда комиссии на биткоин низкие, и объединить свои мелкие UTXO в один более крупный UTXO. Таким образом, когда сборы за биткойн вырастут, можно будет проводить транзакции с минимальными затратами и, соответственно, тратить меньше абсолютных сборов. Цель состоит в том, чтобы планировать обязательные транзакции в периоды высоких комиссий.

Помимо экономии на комиссии за транзакции, консолидация UTXO помогает избежать образования "пыли" Под "пылью" понимаются UTXO, чья стоимость в сатах настолько мала, что ее не хватает для покрытия транзакционных комиссий, необходимых для их расходования. Это делает использование таких UTXO экономически нерациональным до тех пор, пока транзакционные сборы остаются высокими. Проактивно группируя свои UTXO, вы предотвращаете их превращение в пыль, гарантируя, что все ваши средства останутся пригодными для использования.

### Каков минимальный размер для ваших UTXO?

Иногда меня спрашивают, каково минимальное рекомендуемое значение для UTXO. К сожалению, универсального ответа нет, так как это зависит от ваших предпочтений и рыночных условий для комиссий. Однако вот формула, которая поможет вам определить порог, соответствующий вашим потребностям:

$$
\frac {P \times F}T = M
$$

Где:


- $P$ - это вес транзакции;
- $F$ представляет собой максимальную ставку в сатоши за байт (sats/vB), которую вы готовы покрыть;
- $T$ - это процент комиссии за транзакцию, который вы готовы заплатить по отношению к общей стоимости UTXO;
- $M$ - минимальная сумма в сатоши для каждого UTXO.

Предположим, что вы хотите покрыть комиссионные за стандартную SegWit-транзакцию с 1 входом и 2 выходами, весом 141 vB. Если вы покрываете до 800 сатов/vB и готовы потратить на комиссии максимум 12 процентов от стоимости UTXO, то расчет будет таким:

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

В данном примере было бы разумно поддерживать минимальное значение UTXOs в портфеле на уровне 940 000 сат.

### Консолидация и ИСП

Одной из наиболее широко используемых эвристик при анализе блокчейна является эвристика COIH (_Common Input Ownership Heuristic_), которая позволяет предположить, что все входы в транзакцию биткойна принадлежат одному и тому же субъекту. Точнее, принцип консолидации заключается в том, чтобы потреблять несколько UTXO в качестве входа и создавать один UTXO в качестве выхода. Таким образом, консолидация позволяет применять COIH.

![BTC204](assets/fr/097.webp)

На практике это означает, что сторонний наблюдатель может сделать вывод, что все консолидированные UTXO, вероятно, принадлежат одному и тому же человеку и что единственный сгенерированный вывод также принадлежит ему. Такая ситуация может нарушить вашу конфиденциальность, связав различные истории транзакций. Например, допустим, я консолидирую 3 UTXO, приобретенных в P2P, с одним UTXO, полученным через платформу, которая требует KYC:

![BTC204](assets/fr/098.webp)

Таким образом, любая организация, имеющая доступ к данным биржевой платформы, в том числе и государственные органы, может определить, что я владею другими суммами в BTC. Ранее эти UTXO не были напрямую связаны с моей личностью, теперь же они связаны. Более того, это раскрывает всем источникам информацию о том, что я владею определенным количеством биткоинов.

При управлении UTXO экономические соображения, побуждающие к консолидации для снижения платы, вступают в противоречие с принципами конфиденциальности, которые рекомендуют никогда не объединять ваши UTXO. Таким образом, выбор между экономикой и конфиденциальностью зависит от приоритетов каждого пользователя.

Если вы можете избежать консолидации, сохранив при этом значительные размеры UTXO, это идеальный вариант. Для этого оптимизируйте методы приобретения. Если вы покупаете биткоины в DCA, постарайтесь как можно шире распределить свои разовые покупки, чтобы сгруппировать стоимость в меньшем количестве UTXO. Легче управлять единовременной покупкой на €1 000 раз в 2 месяца, чем покупкой на €120 каждую неделю. Это минимизирует количество генерируемых UTXO и упрощает управление вашим портфелем, сохраняя при этом конфиденциальность.

Если вы столкнулись с необходимостью консолидировать свои биткоины, отдавайте предпочтение консолидации UTXO из одного источника. Например, объединение 10 UTXO с одной платформы окажет меньшее влияние на вашу конфиденциальность, чем смешивание 5 UTXO с платформы A с 5 UTXO с платформы B. Если консолидация из разных источников неизбежна, постарайтесь разделить их по характеристикам. Например, сгруппируйте UTXO, полученные через KYC, в одну транзакцию, а полученные через P2P - в другую.

В любом случае помните, что любая консолидация неизбежно ведет к потере конфиденциальности. Поэтому тщательно оцените необходимость этого и потенциальные последствия для вашей частной жизни, принимая во внимание риск.

## Другие передовые практики

<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>

Давайте вместе рассмотрим некоторые другие лучшие практики, которые помогут вам оптимизировать конфиденциальность в Bitcoin.

### Полный узел

Хранить свои биткоины на личном хранении - это хорошо, но использовать собственный полноценный узел - еще лучше! Вот почему наличие собственного узла имеет решающее значение для полностью суверенного использования биткойна:


- Устойчивость к цензуре**: Ваши транзакции не могут быть заблокированы никем;
- Независимость от третьих сторон**: Вы больше не зависите от внешних сервисов для проверки данных блокчейна;
- Активное участие**: У вас есть возможность устанавливать собственные правила проверки и принимать непосредственное участие в консенсусе;
- Вклад в развитие сети**: Управляя узлом, вы помогаете укреплять и распространять сеть Биткойн;
- Техническое образование**: Запуск полной ноды - отличный способ углубить свои технические знания о Биткойне.

Помимо этих преимуществ, использование полного узла также повышает уровень конфиденциальности при передаче транзакций. Когда вы совершаете транзакцию, она сначала создается и подписывается через ваш кошелек. Чтобы передать ее в сети Биткойн, она должна быть известна хотя бы одному узлу. Используя свой собственный узел, вы напрямую контролируете эту передачу, что повышает вашу конфиденциальность и ограничивает риск потери данных.

![BTC204](assets/fr/099.webp)

Если у вас нет собственного узла биткоина, вы будете вынуждены использовать узел третьей стороны, например, предлагаемый поставщиком программного обеспечения для вашего кошелька. Помимо передачи транзакций, вашему кошельку требуется доступ к различной информации, такой как отложенные транзакции, балансы, связанные с вашими адресами, или количество подтверждений ваших транзакций. Чтобы получить доступ ко всем этим данным, вам необходимо запросить узел.

![BTC204](assets/fr/100.webp)

Основной риск, когда вы не используете свой узел Bitcoin, заключается в том, что сторонний оператор узла может наблюдать за вашими действиями в блокчейне или даже поделиться этой информацией с другими организациями. Чтобы ограничить этот риск, промежуточным решением является использование программного обеспечения для кошельков, которое позволяет маскировать ваши соединения через Tor. Это может уменьшить раскрытие ваших данных. Однако оптимальным решением остается наличие собственного узла Bitcoin и использование его для передачи транзакций. Конечно, вам также придется позаботиться о том, чтобы информация не просочилась за пределы вашего узла, но это уже другая тема, которую мы рассмотрим в следующих разделах.

Помимо очевидной пользы для конфиденциальности, наличие собственного узла гарантирует достоверность данных в блокчейне, защищает от цензуры и позволяет активно участвовать в управлении биткоином. Используя собственный узел, вы вносите свой экономический вес в выбранный вами блокчейн, что важно во время конфликтов внутри сообщества, например, во время войны размеров блоков в 2015-2017 годах. В случае форка использование узла третьей стороны может привести к тому, что вы поддержите цепь, которую не хотите поддерживать, поскольку оператор узла делает выбор за вас. Как вы понимаете, с точки зрения конфиденциальности и более общего индивидуального суверенитета очень важно запускать и использовать свой собственный полноценный узел!

### Эвристика обманного анализа

В целом, важно понимать эвристики, о которых мы говорили в предыдущем разделе, чтобы лучше их избегать или обманывать. Принятие ряда лучших практик может оказаться полезным, даже если они не являются обязательными. Они обеспечивают дополнительный уровень защиты, который может быть важен для сохранения конфиденциальности при использовании Биткойна.

Первый совет, который я могу дать, - это влиться в самую плотную толпу. В биткойне это означает использование наиболее распространенных шаблонов скриптов. Например, скрипты P2WSH, часто используемые для мультисиговых конфигураций SegWit V0, встречаются очень редко. Они не позволяют скрыться в большом наборе анонимности. То же самое справедливо и для старых моделей, таких как P2PKH или P2SH. Хотя они широко представлены в наборе UTXO, их все реже используют для новых транзакций.

В целом, безопаснее двигаться в сторону новейшего стандарта скриптов, если он достаточно принят. Так, если в 2022 году я бы не советовал использовать P2TR (Taproot) из-за его низкой распространенности, то к 2024 году я бы рекомендовал выбрать этот тип скрипта или, в противном случае, скрипт SegWit V0, поскольку количество транзакций с использованием P2TR начинает составлять очень значительную часть.

Источник:[txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)

Еще один совет по сохранению конфиденциальности - попытаться обойти внутреннюю эвристику транзакций. Например, когда вы совершаете платеж, вы можете попытаться избежать создания вывода с круглой суммой, так как это может сигнализировать о том, что другой вывод представляет собой изменение. Если вам нужно отправить другу 100 тысяч сатоши, подумайте о том, чтобы перевести немного большую сумму, чтобы избежать этой эвристики. Аналогично, старайтесь не создавать вывод остатка, который непропорционально велик по сравнению с произведенным платежом, так как это также может показать, какой из выводов представляет собой остаток.

Наконец, если вы регулярно проводите транзакции с биткоинами, убедитесь, что вы не всегда передаете их в одно и то же время. Распределяя передачу транзакций в течение дня и недели, вы не дадите сторонним наблюдателям возможности обнаружить временную закономерность, основанную на часовых поясах, которая могла бы улучшить их анализ.

Помимо всех этих лучших практик, которые следует применять на ежедневной основе, существуют и более эффективные методы, позволяющие полностью нарушить отслеживаемость ваших биткоинов. К ним, конечно же, относятся транзакции coinjoin, которые мы подробно рассмотрим в следующем разделе.

# Понимание транзакций Coinjoin

<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## Что такое транзакция Coinjoin?

<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>

Изучив основы защиты конфиденциальности, мы теперь обсудим более сложные техники, направленные на активную защиту вашей частной жизни, в частности, путем отключения вашей истории биткоинов. В следующей части мы рассмотрим множество небольших техник, но сначала я хочу рассказать вам о coinjoin.

Coinjoin часто считается самым эффективным способом защиты конфиденциальности пользователей Биткойна. Но что именно представляет собой транзакция coinjoin? Давайте узнаем это вместе.

### Основные принципы Coinjoin

Coinjoin - это техника, которая нарушает отслеживание биткоинов в блокчейне. В ее основе лежит совместная транзакция с одноименной структурой: coinjoin transaction.

Как мы видели в первых частях этого курса, транзакции в Bitcoin известны всем пользователям через их ноду. Поэтому можно легко проверить цепочку электронной подписи каждой монеты и проследить ее историю. Это означает, что все пользователи могут попытаться проанализировать транзакции других пользователей. В результате анонимность на уровне транзакций невозможна. Однако анонимность сохраняется на уровне индивидуальной идентификации. В отличие от традиционных банковских операций, где каждый счет связан с личностью, в биткойне средства ассоциируются с парами криптографических ключей (или скриптов), что обеспечивает пользователям псевдонимность за криптографическими идентификаторами.

![BTC204](assets/it/51/01.webp)

Таким образом, конфиденциальность биткоина нарушается, когда сторонние наблюдатели могут связать конкретные UTXO с определенными пользователями. Как только такая связь установлена, становится возможным отслеживать их транзакции и анализировать их биткоин-историю. Coinjoin - это именно та техника, которая была разработана для того, чтобы нарушить отслеживание UTXO и обеспечить некоторый уровень конфиденциальности пользователям биткоина на уровне транзакций.

Коинджоины повышают конфиденциальность пользователей Биткойна, усложняя анализ цепочки для сторонних наблюдателей. Их структура позволяет объединить несколько монет от разных пользователей в одну транзакцию, тем самым запутывая следы и затрудняя определение связей между входными и выходными адресами.

Важно понимать, что цель транзакции coinjoin - нарушить историю монеты. Эта техника не дает постоянной анонимности и не останавливает отслеживание биткоинов, как можно было бы подумать. Coinjoin стремится прервать историю только в тот момент, когда совершается транзакция coinjoin. Однако и до, и после этой транзакции монета остается подверженной тем же рискам конфиденциальности.

![BTC204](assets/fr/104.webp)

### Как работают коинджоины?

Принцип coinjoin основан на совместном подходе: несколько пользователей, желающих смешать свои биткоины, вносят одинаковые суммы на входы одной и той же транзакции. Затем эти суммы перераспределяются в выходы равной стоимости для каждого пользователя.

![BTC204](assets/fr/105.webp)

В конце транзакции становится невозможно связать конкретный выход с известным входом пользователя. Прямая связь между входами и выходами отсутствует, что нарушает связь между пользователями и их UTXO, а также историю каждой монеты.

![BTC204](assets/fr/106.webp)

Возьмем пример Алисы. Она хочет отправить около 100 000 сатоши (sats) своей сестре Еве на день рождения. Однако Алиса не хочет, чтобы Ева могла отследить историю ее транзакций, потому что она не хочет раскрывать, сколько биткоинов ей принадлежит и как она их получила. Для этого Алиса решает уничтожить свою историю UTXO с помощью транзакции coinjoin. Она договаривается с Бобом, Чарльзом, Дэвидом и Фрэнком о проведении совместной транзакции: Алиса, Боб, Чарльз, Дэвид и Фрэнк обещают, что UTXO в размере 105 000 сатов (с 5 000 сатов на оплату майнинга) будет использоваться в качестве исходных данных для транзакции:

![BTC204](assets/fr/107.webp)


- В обмен на использование этих входов каждый генерирует новый адрес для создания пяти идентичных выходов по 100 000 сат каждый. Каждый участник получает один выход:

![BTC204](assets/fr/108.webp)


- В итоге Алиса получает UTXO из 100 000 сатов, история которого неоднозначна. Она использует этот UTXO в новой транзакции, чтобы отправить сумму Еве на день рождения:

![BTC204](assets/fr/109.webp)


- Если Ева попытается проанализировать эту транзакцию, чтобы извлечь информацию, она наткнется на транзакцию coinjoin, в которой участвуют Алиса, Боб, Чарльз, Дэвид и Фрэнк. Поскольку Ева не может различить, кому принадлежит каждый вход из-за однородности сумм, она не может проследить историю UTXO Алисы или определить, сколько биткоинов принадлежит ее сестре и как она их приобрела:

![BTC204](assets/fr/110.webp)

В этом сценарии Алиса использовала технику объединения монет, чтобы повысить свою конфиденциальность от обратного анализа. Фактически, Алиса защищает себя от возможного анализа со стороны Евы, которая начнет с определенной транзакции, чтобы проследить историю UTXO в обратном направлении. Эту защиту от анализа из настоящего в прошлое мы называем ретроспективным анонсированием. Более подробно мы рассмотрим эту концепцию в последних главах данной части.

Однако коинджойн также предлагает возможность улучшить конфиденциальность от анализа прошлого к настоящему, что называется проспективным анонсетом. Давайте вернемся к нашему примеру, в котором Алиса отправила 98 000 сатов Еве в день ее рождения, но поменяем роли. Теперь представим, что именно Ева беспокоится о своей конфиденциальности. На самом деле у Алисы может возникнуть соблазн проследить за монетой, которую она отправила Еве, чтобы собрать информацию. Ева может объединить этот недавно полученный UTXO со всеми остальными своими UTXO, что может раскрыть Алисе количество биткоинов в ее кошельке. Чтобы избежать этого, Ева может также нарушить историю только что полученной монеты.


- Ева, Грейс, Мэллори, Оскар и Виктор ввели в транзакцию Bitcoin UTXO, равный 98 000 сат:

![BTC204](assets/fr/111.webp)


- В обмен на использование этих входов каждый предоставляет новый адрес для создания 5 выходов по 97 500 сат каждый, совершенно одинаковых. Каждый пользователь получает один выход:

![BTC204](assets/fr/112.webp)


- Теперь у Евы есть UTXO на 97 500 сатов с неработающей историей. Она может без опасений использовать его для будущих транзакций. На самом деле, если Алиса попытается проследить за биткоинами, которые она отправила Еве, она наткнется на транзакцию coinjoin. Она не сможет определить, к какому UTXO-выходу принадлежит Ева. Тогда анализ становится невозможным:

![BTC204](assets/fr/113.webp)

В первом примере мы увидели, как coinjoin может защитить конфиденциальность монеты в отношении ее прошлого, а во втором - как он может защитить историю монеты в отношении ее будущего. Именно поэтому я упомянул, что coinjoin следует рассматривать как одноразовое событие, которое сегментирует историю монеты в обоих направлениях:

![BTC204](assets/fr/104.webp)

### Микширование, коинджойнты, микшеры... В чем разница?

Термин "смешивание" иногда используется для описания коинджоинов - некоторые биткоинщики отвергают этот термин, поскольку опасаются путаницы с хранимыми миксерами. Однако я считаю это опасение необоснованным, поскольку в математическом контексте коинджойн точно воплощает концепцию смешивания.

В общей области математики под перемешиванием понимается свойство динамической системы, при котором через определенное время все части исходного пространства теоретически могут быть перемешаны с любой другой частью. Смешивание подразумевает, что положение частицы или состояние системы изменяется таким образом, что ее будущее распределение не зависит от ее начального распределения, и таким образом достигается состояние, когда характеристики начального состояния равномерно распределены в пространстве системы. Именно это и происходит в коинджоине с биткоинами. Поэтому, на мой взгляд, coinjoin - это действительно метод смешивания монет.

![BTC204](assets/fr/114.webp)

Однако важно отличать коинджоины от миксеров. Миксер - это сервис, куда пользователи отправляют свои биткоины для смешивания. Эти сервисы были популярны в 2010-х годах, но их использование сократилось из-за двух основных недостатков по сравнению с coinjoin:


- Они требуют, чтобы пользователи отказались от хранения своих средств в процессе смешивания, что подвергает их риску кражи;
- Нет никакой гарантии, что миксер не будет записывать детали транзакций или даже продавать эту информацию компаниям, занимающимся аналитикой блокчейна.

![BTC204](assets/fr/115.webp)

Поэтому сегодня пользователи предпочитают коинджоин, так как он позволяет им сохранять полный контроль над своими средствами на протяжении всего процесса. Участники coinjoin не рискуют, что их биткоины будут украдены другими участниками. Давайте вместе разберемся, как это возможно, в следующей главе.

## Союзы Зеролинка и Чаумиана

<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>

Конфиденциальность, обеспечиваемая объединением монет, зависит от размера группы, в которой спрятана наша часть. Поэтому необходимо найти как можно больше участников. Вполне возможно запустить коинджойн вручную, с самостоятельно найденными пользователями, но этот метод сложен и не позволяет получить большие наборы анонсов.

Именно поэтому в Биткойне появились координаторы coinjoin. Их роль заключается в том, чтобы соединять разных пользователей и передавать информацию, необходимую для успешного завершения совместной транзакции.

![BTC204](assets/fr/116.webp)

Но как мы можем гарантировать, что координатор никогда не будет иметь контроля над биткоинами пользователей, и хотя он или она является человеком, который создает транзакцию coinjoin, как мы можем гарантировать, что он или она не сможет связать входы и выходы пользователей, что может привести к потере конфиденциальности?

### Слепые подписи Чаума

Современные реализации coinjoin используют слепые подписи Дэвида Чаума для предотвращения утечки информации. Давайте вместе быстро изучим, как работают эти слепые подписи.

Слепые подписи Чаума - это разновидность цифровой подписи, при которой издатель подписи не знает содержимого подписываемого сообщения. Однако впоследствии подпись может быть проверена по оригиналу сообщения. Эта техника была разработана криптографом Дэвидом Чаумом в 1983 году.

Возьмем пример компании, которая хочет проверить подлинность конфиденциального документа, например контракта, не раскрывая его содержания. Компания применяет процесс маскировки, который криптографически преобразует исходный документ обратимым образом. Этот измененный документ отправляется в центр сертификации, который применяет слепую подпись, не зная основного содержания. После получения подписанного документа компания удаляет маскировку с подписи. В результате оригинальный документ подтверждается подписью центра, при этом он никогда не видел исходного содержимого.

Таким образом, слепые подписи Чаума позволяют подтвердить подлинность документа, не зная его содержимого, обеспечивая конфиденциальность данных пользователя и целостность подписанного документа.

### Чаумиан присоединяется

В "Chaumian CoinJoins" использование Tor и слепых подписей Дэвида Чаума сочетается для того, чтобы координатор не мог узнать, какому пользователю принадлежит каждый вывод. Процесс создания транзакций coinjoin состоит из 3 основных шагов: регистрация входа, регистрация выхода и подписание транзакции. Давайте рассмотрим этот процесс на примере Алисы, одного из участников коинджоина. Все остальные участники выполняют те же шаги, что и Алиса, каждый самостоятельно.

**Шаг 1: Регистрация входов.**


- Алиса отправляет координатору UTXO, который она хочет использовать в качестве входного для транзакции, а также маскированный адрес приема, который она хочет использовать в качестве выходного для получения своих биткоинов. Таким образом, координатор не может знать адрес Алисы. Он видит только ее замаскированную версию.
- Координатор проверяет достоверность входных данных, затем подписывает замаскированный адрес Алисы своим закрытым ключом. Затем он отправляет Алисе слепую подпись.

**Шаг 2: Запись выходов.**


- Теперь Алиса может снять маскарад со своего адреса, подписанного закрытым ключом координатора. Она устанавливает новое соединение под другим Tor-идентификатором. Координатор не может определить, что это Алиса, подключившаяся под этим новым именем.
- Алиса отправляет незамаскированный адрес и подпись координатору (который по-прежнему не знает, что это Алиса).

**Шаг 3: Подпишите сделку


- Координатор аналогичным образом получает незамаскированные выходные данные от всех участников. С помощью соответствующих подписей он может убедиться, что каждый выход, отправленный анонимно, действительно был ранее подписан его закрытым ключом, что гарантирует его легитимность. После этого он готов к созданию транзакции coinjoin и отправляет ее участникам для подписания.
- Алиса, как и другие участники, проверяет, правильно ли ее входные и выходные данные включены в транзакцию, созданную координатором. Если все удовлетворительно, она отправляет координатору подпись, которая разблокирует сценарий ее ввода.
- После сбора подписей всех участников coinjoin координатор может передать транзакцию по сети Биткойн, чтобы она была добавлена в блок.

В этой системе координатор не может связать вход с конкретным выходом. Кроме того, он не может завладеть средствами участников, поскольку у него нет доступа к закрытым ключам, необходимым для разблокировки их UTXO. На протяжении всего процесса и до конца шага 3 он даже не имеет доступа к подписям. Когда Алиса и другие участники подписывают глобальную транзакцию, проверив, все ли правильно, координатор уже не может изменить эту транзакцию, включая выходные данные, не аннулировав ее. Таким образом, координатор предотвращает кражу биткоинов.

В конечном итоге, регистрируя свой выход в транзакции, пользователь coinjoin хочет получить гарантии, аналогичные тем, что дает гражданин, голосующий на выборах. Существует двойственность между публичными и частными аспектами этих действий. С одной стороны, есть то, что вы хотите сохранить в тайне: избиратель не хочет, чтобы его бюллетень был связан с его личностью; пользователь coinjoin не хочет, чтобы его выход был связан с его входом. На самом деле, если координатору или любой другой стороне удастся установить связь между входом и выходом, коинджойн потеряет всю свою цель. Как объяснялось ранее, коинджойн должен функционировать как пауза в истории монеты. Эта пауза возникает именно из-за невозможности связать конкретный вход с конкретным выходом в транзакции коинджоина (проспективный анонсет) и наоборот (ретроспективный анонсет).

С другой стороны, есть и публичный аспект: избиратель хочет быть уверен, что его бюллетень включен в урну для голосования; точно так же пользователь коинджойна хочет быть уверен, что его вывод включен в транзакцию коинджойна. На самом деле, участникам coinjoin абсолютно необходимо иметь возможность проверить наличие своего вывода до подписания транзакции, иначе координатор может украсть средства.

Именно эти два аспекта - публичный и частный, ставшие возможными благодаря использованию слепых подписей Дэвида Чаума, - гарантируют участникам коинджойна Чаума, что их биткоины не будут украдены, а их средства не будут отслежены.

### Кто придумал концепцию coinjoin?

Трудно с уверенностью сказать, кто первым представил идею coinjoin в Биткойне и кто придумал использовать слепые подписи Дэвида Чаума в этом контексте. Часто считается, что первым об этом упомянул Грегори Максвелл в [посте на BitcoinTalk в 2013 году] (https://bitcointalk.org/index.php?topic=279249.0):

Использование слепых подписей Чаума: Пользователи подключаются и предоставляют входные данные (и адреса для остальных), а также криптографически скрытую версию адреса, на который они хотят отправить свои приватные монеты; сервер подписывает токены и возвращает их пользователям. Пользователи анонимно переподключаются, раскрывают адреса своих выходов и отправляют их обратно на сервер. Сервер видит, что все выходы были подписаны им и что, следовательно, все выходы исходят от действительных участников. Позже люди снова подключаются и подписываются.

Максвелл, Г. (2013, 22 августа). _CoinJoin: Конфиденциальность биткойна для реального мира_. Форум BitcoinTalk. https://bitcointalk.org/index.php?topic=279249.0

Однако ранее уже встречались упоминания о сигнатурах Чаума в контексте микширования и коинджоинов. [В июне 2011 года Дункан Таунсенд представил на BitcoinTalk](https://bitcointalk.org/index.php?topic=12751.0) микшер, который использует сигнатуры Чаума в манере, весьма похожей на современные коинджоины Чаума.

В этом же потоке есть [сообщение с хэш-коинами в ответ Дункану Таунсенду](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793) для улучшения его миксера. Процесс, описанный в этом сообщении, представляет собой именно то, что наиболее близко к коинджоинам. Похожая система также упоминается в [сообщении от Алекса Мизрахи в 2012 году](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry), когда он консультировал создателей Tenebrix, одного из первых альткоинов, послужившего впоследствии основой для создания Litecoin. Даже сам термин "coinjoin" был придуман не Грегом Максвеллом, а возник из идеи Питера Тодда.

![BTC204](assets/fr/125.webp)

### Zerolink

Zerolink - это комплексный протокол смешивания, который объединяет коинджоины Чаумиани и различные стратегии защиты анонимности пользователей от различных форм анализа цепочек, значительно сокращая ошибки, связанные с управлением кошельками. Этот протокол [был представлен nopara73 и TDevD в 2017 году] (https://github.com/nopara73/ZeroLink/blob/master/README.md).

![BTC204](assets/fr/126.webp)

Как следует из названия, принцип работы Zerolink заключается в выполнении операций coinjoin, которые гарантируют, что связи между входами и выходами не могут быть отслежены. Эта функция достигается за счет того, что все выходы имеют совершенно одинаковые суммы.

![BTC204](assets/fr/127.webp)

Важной превентивной мерой Zerolink является полное отделение несмешанных UTXO от смешанных UTXO с использованием отдельных наборов криптографических ключей или даже отдельных кошельков. Таким образом, кошелек "pre-mix", предназначенный для монет до смешивания, отделяется от кошелька "post-mix", предназначенного для монет, которые были смешаны.

![BTC204](assets/fr/128.webp)

Такое строгое разделение UTXO служит в первую очередь для предотвращения случайных связей между смешанным и несмешанным UTXO. На самом деле, если такие связи возникают, эффективность coinjoin на смешанном UTXO сводится на нет без ведома пользователя, что ставит под угрозу конфиденциальность UTXO, история которого считалась нарушенной. Такие связи могут возникать либо за счет повторного использования адресов для защиты смешанного UTXO от несмешанного, либо за счет применения эвристики владения общим входом (CIOH), если пользователь использует смешанные и несмешанные UTXO в качестве входов для одной и той же транзакции. Разделение портфелей до и после смешивания позволяет избежать таких случайных ассоциаций и защитить пользователя от непреднамеренных ошибок.

![BTC204](assets/fr/129.webp)

Такое разделение также дает возможность применять различные правила между портфелями до и после смешивания на уровне программного обеспечения портфеля. Например, в портфеле после смешивания программное обеспечение может запретить объединение входных UTXO, чтобы предотвратить применение CIOH, которое поставит под угрозу пользовательский anonset. Также можно стандартизировать использование скриптов и опций транзакций (например, RBF-сигнализации), чтобы предотвратить идентификацию по отпечаткам кошельков.

На данный момент Whirlpool является единственной реализацией coinjoin, которая строго соблюдает протокол Zerolink. В следующей главе мы рассмотрим различные существующие реализации coinjoin, а также преимущества и недостатки каждой из них.

## Реализации объединений

<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>

в 2024 году мы наблюдаем значительные изменения в инструментах, доступных пользователям, которые хотят запускать коинджоины на Биткойне. Сейчас мы находимся в переломном периоде, и рынок коинджоинов переживает серьезную реструктуризацию. Поэтому эта глава, вероятно, будет обновляться с течением времени._

На данный момент в Биткойне существует в основном 3 различных реализации coinjoin:


- Whirlpool;
- Вабисаби;
- JoinMarket.

Каждая из этих реализаций направлена на разрушение истории UTXO с помощью транзакций coinjoin. Однако их механизмы существенно различаются. Поэтому важно понимать, как работает каждая из них, чтобы выбрать вариант, наиболее подходящий для ваших нужд.

### JoinMarket

JoinMarket, созданная в 2015 году Адамом Гибсоном и Крисом Белчером, отличается от других реализаций coinjoin благодаря своей уникальной модели подбора пользователей. Эта система основана на P2P-бирже, где одни пользователи, "производители", предоставляют свои биткоины для смешивания, а другие, "принимающие", используют эти средства для выполнения коинджоинов в обмен на вознаграждение.

![BTC204](assets/fr/130.webp)

В этой модели "создатели" оставляют свои биткоины в распоряжении "принимающих" и получают плату за свои услуги. С другой стороны, "принимающие" платят за использование биткоинов "создателей" для проведения своих собственных транзакций coinjoin. Плата за услуги зависит от роли: "мейкеры" накапливают плату за свои предложения ликвидности, а "тейкеры" платят комиссионные. Эта торговая площадка работает свободно, без каких-либо условий использования.

Основным недостатком JoinMarket является сложность использования, которая требует некоторого знакомства с терминалами для эффективного использования. Хотя для опытного пользователя эта сложность не является препятствием, она может ограничить доступ широкой публики. Однако недавнее появление веб-интерфейса под названием JAM несколько облегчило его использование.

![BTC204](assets/fr/131.webp)

Источник: [JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

Тем не менее, технический барьер остается главным препятствием. В экосистеме коинджойнов, где конфиденциальность повышается за счет количества участников, любое ограничение, снижающее доступность, напрямую влияет на доступную ликвидность, которая является решающим фактором эффективности смешивания. Биткойн, уже занимающий нишу финансовых операций, рассматривает использование коинджоинов как субнишу, а JoinMarket представляет собой еще более специализированную фракцию, что ограничивает его потенциал в увеличении анонсов своих пользователей.

Несмотря на инновационную модель P2P-сопоставления для коинджоинов, JoinMarket имеет ряд существенных недостатков, особенно с точки зрения структуры транзакций. В отличие от других реализаций, таких как Whirlpool, JoinMarket не гарантирует идеального равенства между выходами, и между входами и выходами могут быть установлены детерминированные связи. В ней также отсутствуют инструменты для предотвращения повторного смешивания уже смешанных монет, что может нарушить конфиденциальность, к которой стремятся пользователи. Наконец, хотя концепция JoinMarket привлекательна, особенно для тех, кто заинтересован в динамичном рынке ликвидности, ее структурные недостатки и техническая сложность делают ее, на мой взгляд, менее привлекательной как для новичков, так и для экспертов, ищущих реализацию coinjoin.

### Вабисаби

Wabisabi - это еще одна реализация coinjoin с подходом, который централизует координацию транзакций. Эта модель была разработана Адамом Фиксором (nopara73), Ювалем Когманом, Лукасом Онтиверо и Иштваном Андрашем Сересом в 2021 году и в следующем году была интегрирована в программное обеспечение Wasabi 2.0. Wabisabi в точности представляет собой эволюцию модели coinjoin программного обеспечения Wasabi, запущенного в 2018 году.

В конце 2010-х годов компания Wasabi приняла транзакционную структуру для своих коинджоинов, которая радикально отличалась от структуры Whirlpool. Чтобы увеличить число анонсов участников, Wasabi использовала очень крупные транзакции, объединяющие десятки участников. В отличие от этого Whirlpool выбрала множество мелких транзакций, что позволило экспоненциально увеличивать количество анонсов с каждым циклом.

Методы работы с остатком также отличаются в этих двух реализациях. В Whirlpool остаток исключался и изолировался от UTXO перед циклами coinjoin с помощью TX0 - концепция, которую я объясню далее в следующей главе. В Wasabi, с другой стороны, остаток формировал один из выходов транзакции coinjoin, поддерживая детерминированные связи между некоторыми входами и выходами.

В Wabisabi версии 2.0 Wasabi адаптировала свой подход к коинджоинам, чтобы приблизить его к подходу Whirlpool. Хотя транзакции коинджойн остаются очень большими, теперь можно выстраивать цепочки из нескольких последовательных раундов, следуя модели Whirlpool. Особое внимание также было уделено управлению сдачей: в отличие от Wasabi 1.0, где сдача была напрямую связана с вводом пользователем, Wabisabi пытается разделить сдачу на несколько небольших сумм, распределяемых равными номиналами для всех участников.

Мы проиллюстрируем это на упрощенном примере с участием всего двух пользователей: Алиса хочет смешать 115 000 сатов, а Боб - 210 000 сатов. Если не учитывать комиссионные, то в Wasabi 1.0 транзакция coinjoin сгенерировала бы 3 выхода по 100 000 сатов, плюс 1 остаток в 15 000 сатов для Алисы и 1 остаток в 10 000 сатов для Боба. Выходы остатков всегда были бы связаны с входами:

Согласно "Вабисаби", в результате одной и той же операции будет произведено 3 выхода по 100 000 сат и 5 выходов по 5 000 сат, что позволит распределить остаток таким образом, чтобы его нельзя было напрямую связать с конкретным входом:

Лично я считаю, что управление изменениями в Wabisabi сопряжено с рядом рисков, которые могут снизить его эффективность с точки зрения конфиденциальности:


- Когда пользователь вносит UTXO, значительно больший, чем у других участников, он неизбежно получает количество изменений, которое будет связано с его вкладом. Это противоречит первоначальной цели протокола, который направлен на устранение любых идентифицируемых изменений;
- Умножение обозначений с целью фрагментации остальных может парадоксальным образом навредить эффективности смешивания. Этот процесс может привести к уменьшению количества анонсов для определенных выходов, так как они становятся более легко идентифицируемыми;
- Этот метод также генерирует малоценные UTXO, которые создают проблему управления для пользователя. Эти небольшие UTXO, если их тратить слишком дорого по сравнению с их стоимостью, могут превратиться в "пыль" Это явление побуждает пользователя объединять несколько входных UTXO в своих будущих транзакциях или консолидировать их. В любом случае, из-за COH, это может уменьшить количество полученных анонсов или полностью свести на нет преимущества конфиденциальности, полученные при первоначальном объединении монет.

В отличие от Whirlpool, которая реализует протокол ZeroLink, обеспечивая строгое разделение UTXO до и после смешивания, Wabisabi не поддерживает такое строгое разделение. Также были проблемы с повторным использованием адресов некоторыми клиентами Wasabi, что, безусловно, очень вредно для пользователей.

В версии 2.0 Wasabi была реализована новая ценовая политика присоединения монет. Теперь плата за координацию установлена на уровне 0,3 % для UTXO размером более 0,01 биткоина, а для меньших UTXO эта плата полностью обнулена. Кроме того, ремиксы для этих меньших UTXO бесплатны, хотя плата за майнинг остается для всех транзакций, включая ремиксы.

Эта политика отличается от политики Whirlpool, где комиссии остаются фиксированными, независимо от размера полученных анонсетов. В Wasabi 2.0, хотя комиссии координаторов обнуляются для небольших UTXO, пользователю все равно приходится платить комиссию за майнинг по всем транзакциям, включая ремиксы.

На момент написания статьи использование Вабисаби значительно усложнилось в результате последних событий. Так, после ареста основателей кошелька Samourai компания zkSNACKs, финансирующая и управляющая разработкой Васаби, объявила о прекращении работы своего сервиса координации коинджоинов 1 июня 2024 года. На этого координатора, который по умолчанию был настроен на Wasabi, приходилась подавляющая часть ликвидности.

После закрытия основного координатора пользователи теперь должны подключаться к новым независимым координаторам. Это изменение вызывает опасения: с одной стороны, новые координаторы могут не обладать достаточной ликвидностью, что снижает эффективность коинджойнтов с точки зрения конфиденциальности. С другой стороны, существует риск столкнуться со злонамеренным координатором. Эта ситуация добавляет новые значительные риски для тех, кто хочет использовать Wabisabi.

Помимо технических проблем, решение zkSNACKs, компании, стоящей за Wasabi, воспользоваться услугами аналитической компании, специализирующейся на блокчейне, для фильтрации участников коинджоинов вызывает серьезные этические и стратегические вопросы. Изначально идея заключалась в том, чтобы предотвратить использование коинджоинов на Wasabi преступниками, и этот шаг может показаться вполне законным. Однако он порождает парадокс: платить взносы координатору, чья основная задача - повысить уровень конфиденциальности пользователей, только для того, чтобы затем финансировать компанию, чья цель - нарушить эту самую конфиденциальность.

Еще большее беспокойство вызывает принцип фильтрации, который резко контрастирует с философией Биткойна, предполагающей создание открытой и неподцензурной финансовой системы. Хотя стремление исключить преступную деятельность может показаться оправданным, такая фильтрация может коснуться и людей, чьи действия, хотя и классифицируются как незаконные в некоторых контекстах, могут быть морально оправданными или социально полезными. Пример Эдварда Сноудена прекрасно иллюстрирует эту дихотомию: некоторые правительства считают его преступником за его разоблачения, другие же считают его информатором, действовавшим в интересах общества. Эта сложность подчеркивает потенциальную опасность фильтрации, которая, хотя и начинается с благих намерений, в конечном итоге может нанести ущерб правам и безопасности законных пользователей. Я также мог бы упомянуть преследуемых активистов и журналистов в некоторых авторитарных режимах. Как вы уже догадались, мое предпочтение, безусловно, отдается модели Whirlpool для проведения коинджоинов в Биткойне. Эта система отличается своей строгостью и предлагает превосходные гарантии в плане конфиденциальности. Кроме того, это единственная система, предлагающая смешение, которое считается идеальным в математическом контексте. По моему мнению, эта модель представляет собой будущее коинджоинов на Биткойне. Поэтому я приглашаю вас более подробно изучить эту модель в следующей главе.

## Работа компании Whirlpool

<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>

Whirlpool отличается от других методов объединения монет тем, что использует транзакции "_ZeroLink_", которые гарантируют, что между всеми входами и всеми выходами технически нет никакой связи. Это идеальное смешение достигается за счет структуры, в которой каждый участник вносит одинаковое количество входных данных (за исключением платы за майнинг), таким образом генерируя выходные данные совершенно одинакового объема.

Такой ограничительный подход к входам придает сделкам Whirlpool coinjoin уникальную особенность: полное отсутствие детерминированных связей между входами и выходами. Другими словами, каждый выход имеет равную вероятность быть приписанным любому участнику относительно всех других выходов в сделке.

![BTC204](assets/fr/136.webp)

### Общая эксплуатация Whirlpool

Изначально число участников каждого коинджоина Whirlpool было ограничено 5, из них 2 новых участника и 3 ремиксера (мы объясним эти понятия позже). Однако увеличение комиссий за транзакции внутри цепи, наблюдавшееся в 2023 году, заставило команды Самурая пересмотреть свою модель, чтобы повысить конфиденциальность и одновременно снизить расходы. Таким образом, принимая во внимание ситуацию на рынке комиссий и количество участников, координатор теперь может организовывать коинджоины, включающие 6, 7 или 8 участников. Эти расширенные сессии получили название "_Surge Cycles_" Важно отметить, что независимо от конфигурации, в коинджоинах Whirlpool всегда только 2 новых участника.

Таким образом, сделки Whirlpool характеризуются одинаковым количеством входов и выходов, которые могут быть:


- 5 входов и 5 выходов;

![BTC204](assets/fr/137.webp)


- 6 входов и 6 выходов;

![BTC204](assets/fr/138.webp)


- 7 входов и 7 выходов;

![BTC204](assets/fr/139.webp)


- 8 входов и 8 выходов.

![BTC204](assets/fr/140.webp)

Таким образом, предлагаемая Whirlpool модель основана на небольших транзакциях coinjoin. В отличие от Wabisabi и JoinMarket, где надежность анонсетов основана на объеме участников одного цикла (или нескольких циклов), Whirlpool опирается на объединение множества небольших циклов. В этой модели пользователи несут расходы только при первоначальном входе в пул, что позволяет им участвовать во множестве ремиксов без дополнительных затрат. Именно новые участники покрывают расходы на майнинг для ремиксеров.

С каждым новым объединением монет, в котором участвует монета, а также ее коллеги, встречавшиеся ранее, количество анонсетов будет расти в геометрической прогрессии. Задача состоит в том, чтобы воспользоваться этими бесплатными ремиксами, которые с каждым разом способствуют увеличению плотности анонсетов, связанных с каждым монетным миксом.

При разработке Whirlpool учитывались два важных требования:


- Доступность реализации на мобильных устройствах, поскольку Samourai Wallet - это в первую очередь приложение для смартфонов;
- Скорость циклов ремиксов способствует значительному увеличению количества анонсов.

Эти императивы определяли выбор разработчиков кошелька Samourai при создании Whirlpool, что привело к ограничению количества участников в каждом цикле. Слишком малое количество участников поставило бы под угрозу эффективность coinjoin, резко сократив количество анонсов, генерируемых в каждом цикле, а слишком большое количество участников создало бы проблемы с управлением мобильными приложениями и затруднило бы прохождение циклов.

В конечном итоге для коинджоинга на Whirlpool не обязательно иметь большое количество участников, поскольку анонсеты реализуются при накоплении нескольких циклов коинджоинга. Наиболее важным принципом здесь является однородность UTXO всех участников, так как это позволяет получить идеальный микс, а значит, в полной мере воспользоваться преимуществами циклов смешивания и ремиксинга.

### Соединяйте бассейны и тарифы

Чтобы эти многократные циклы эффективно увеличивали анонс смешанных монет, необходимо установить рамки, ограничивающие количество используемого UTXO. Поэтому Whirlpool определяет несколько пулов.

Пул представляет собой группу пользователей, желающих объединиться и договориться о количестве UTXO, которое будет использоваться для оптимизации процесса объединения монет при сохранении идеальной однородности монет. Каждый пул устанавливает фиксированную сумму UTXO, которую пользователь должен выполнить, чтобы принять участие. Таким образом, для проведения коинджоинов с помощью Whirlpool необходимо выбрать пул. В настоящее время доступны следующие пулы:


- 0.5 биткоинов;
- 0.05 биткоин;
- 0.01 биткоин;
- 0.001 биткоин (= 100 000 сатов).

Присоединившись к пулу со своими биткоинами, они будут разделены для создания UTXO, совершенно однородных с теми, что есть у других участников пула. Каждый пул имеет максимальный лимит, поэтому для сумм, превышающих этот лимит, вы будете вынуждены либо сделать два отдельных входа в один и тот же пул, либо обратиться к другому пулу с большей суммой:

| Пул (биткоин) | Максимальная сумма за вход (биткоин) |

|----------------|----------------------------------------|

| 0,5 | 35 |

| 0,05 | 3,5 |

| 0,01 | 0,7 |

| 0,001 | 0,025 |

UTXO считается принадлежащим пулу, когда он готов к интеграции в coinjoin. Однако это не означает, что пользователь теряет право владения им. Как мы видели в первых главах этой части, в ходе различных циклов смешивания вы сохраняете полный контроль над своими ключами и, следовательно, над своими биткоинами. Именно это отличает технику coinjoin от других централизованных методов смешивания.

Чтобы присоединиться к пулу coinjoin, необходимо оплатить сервисные сборы, а также плату за майнинг. Сервисные сборы фиксированы для каждого пула и предназначены для выплаты вознаграждения командам, отвечающим за разработку и обслуживание Whirlpool.

Плата за пользование Whirlpool должна быть внесена один раз при входе в бассейн. После этого вы сможете участвовать в неограниченном количестве ремиксов без дополнительной платы. Вот текущие фиксированные тарифы для каждого пула:

| Пул (биткойн) | Входная плата (биткойн)|

| -------------- | --------------------------------- |

| 0.5 | 0.0175 |

| 0.05 | 0.00175 |

| 0,01 | 0,0005 (50 000 сатов)|

| 0,001 | 0,00005 (5 000 сатов)|

Эти сборы, по сути, являются входным билетом в выбранный вами пул, независимо от суммы, которую вы вводите в coinjoin. Таким образом, независимо от того, введете ли вы в пул 0,01 BTC ровно 0,01 BTC или 0,5 BTC, сборы останутся одинаковыми по абсолютной величине.

Прежде чем приступить к работе с коинджоинами Whirlpool, пользователь может выбрать одну из двух стратегий:


- Выбирайте меньший пул, чтобы минимизировать плату за обслуживание, зная, что взамен они получат несколько меньших UTXO;
- Или предпочесть более крупный пул, согласившись заплатить более высокую комиссию, чтобы в итоге получить небольшое количество более дорогих UTXO.

Вообще, не рекомендуется объединять несколько смешанных UTXO после циклов coinjoin, так как это может нарушить конфиденциальность, особенно из-за эвристики владения общим входом (CIOH: _Common-Input-Ownership-Heuristic_). Поэтому, возможно, имеет смысл выбрать больший пул, даже если это означает большую оплату, чтобы не получить на выходе слишком много UTXO с малым значением. Пользователь должен оценить эти компромиссы, чтобы выбрать тот пул, который ему больше нравится.

Помимо платы за обслуживание, необходимо также учитывать плату за майнинг, присущую любой транзакции Биткойна. Как пользователь Whirlpool, вы должны будете оплатить майнинг за подготовительную транзакцию (`Tx0`), а также за первое присоединение к монете. Все последующие ремиксы будут бесплатными, поскольку модель Whirlpool предусматривает оплату новых участников.

На самом деле, в каждом Whirlpool coinjoin 2 пользователя среди входов являются новыми участниками. Остальные входы поступают от ремиксеров. В результате плата за майнинг для всех участников транзакции покрывается этими двумя новыми участниками, которые затем также получают выгоду от бесплатных ремиксов:

![BTC204](assets/it/54/07.webp)

Благодаря этой системе сборов Whirlpool действительно отличается от других реализаций coinjoin, поскольку анонсы UTXO не пропорциональны цене, которую платит пользователь. Таким образом, можно достичь значительно высокого уровня анонимности, заплатив только взнос за вход в пул и плату за майнинг за 2 транзакции (`Tx0` и начальный микс).

Важно отметить, что пользователь также должен будет оплатить майнинг для вывода своих UTXO из пула после выполнения нескольких coinjoin, если только он не выбрал опцию `mix to`, которая позволяет ему указать внешний адрес, который будет напрямую получать средства как результат coinjoin, без каких-либо дополнительных транзакций.

### Счета кошелька HD

Чтобы осуществить объединение монет через Whirlpool, кошелек должен сгенерировать несколько отдельных учетных записей. Таков принцип работы протокола ZeroLink. Аккаунт в контексте кошелька HD (_Hierarchical Deterministic_) представляет собой раздел, полностью изолированный от других, это разделение происходит на третьем уровне глубины иерархии кошелька, т.е. на уровне `xpub`.

![BTC204](assets/it/54/08.webp)

В кошельке HD теоретически может быть создано до `2^(32/2)` различных счетов. Начальный счет, используемый по умолчанию во всех кошельках Bitcoin, соответствует индексу `0`.

Для портфелей, адаптированных к Whirlpool, используются 4 счета, чтобы соответствовать требованиям процесса ZeroLink:


- Счет **депозита**, идентифицируемый индексом `0`;
- Счет **плохого банка** (или "токсичная биржа"), обозначенный индексом `2 147 483 644`;
- Счет **премикс**, идентифицируемый индексом `2 147 483 645`;
- Счет **постмикс**, идентифицируемый по индексу `2 147 483 646`.

Каждый из этих аккаунтов выполняет определенную функцию в процессе объединения, которую мы рассмотрим в следующих разделах.

Все эти аккаунты привязаны к одному семени, что позволяет пользователю восстановить доступ ко всем своим биткоинам, используя фразу восстановления и, при необходимости, парольную фразу. Однако во время этой операции восстановления необходимо указать программе различные индексы использованных аккаунтов.

Теперь давайте рассмотрим различные этапы совместного использования Whirlpool в рамках этих счетов.

### TX0

Отправной точкой любого монетоприемника Whirlpool является **депозитный счет**. Этот счет автоматически используется при создании нового биткоин-кошелька. На этот счет должны быть зачислены биткоины, которые вы хотите смешать.

`Tx0` представляет собой первый шаг в процессе смешивания Whirlpool. Он направлен на подготовку и выравнивание UTXO для коинджойнта, разделение их на единицы, соответствующие количеству выбранного пула, для обеспечения однородности смешивания. Уравненные UTXO затем отправляются на счет **премикса**. Что касается разницы, которая не может попасть в пул, то она отделяется на особый счет: **плохой банк** (или "токсичный обмен").

Эта начальная транзакция `Tx0` также служит для оплаты услуг координатора coinjoin. В отличие от последующих этапов, эта транзакция не является совместной, поэтому пользователь должен нести все расходы по оплате майнинга:

![BTC204](assets/it/54/09.webp)

В этом примере транзакции `Tx0` входное значение `372 000 сат` с нашего **депозитного счета** делится на несколько выходных UTXO, которые распределяются следующим образом:


- Сумма в размере `5,000 сат`, выделенная координатору на оплату услуг, соответствует вхождению в пул `100,000 сат`;
- 3 UTXO подготовлены к смешиванию, перенаправлены на наш **премикс-аккаунт** и зарегистрированы у координатора. Эти UTXO уравнены по цене `108 000 сат` каждый, чтобы покрыть плату за добычу для их будущего начального смешивания;
- Излишки, которые не могут попасть в пул, так как их слишком мало, считаются токсичным обменом. Он отправляется на свой конкретный счет. Здесь этот обмен составляет `40 000 сатов`;
- Наконец, есть `3 000 сатов`, которые не являются выходом, а представляют собой плату за добычу, необходимую для подтверждения `Tx0`.

Например, вот настоящий Tx0 Whirlpool (не мой):[edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/fr/145.webp)

### Токсичные изменения

Избыток, который не удалось интегрировать в пул, эквивалентный `40 000 сат`, перенаправляется на счет **bad bank**, также называемый "токсичным обменом", чтобы обеспечить строгое отделение от других UTXO в портфеле.

Этот UTXO опасен для конфиденциальности пользователей, поскольку он не только по-прежнему связан с прошлым пользователя, а значит, возможно, и с личностью его владельца, но и помечен как принадлежащий пользователю, который участвовал в coinjoin.

![BTC204](assets/fr/146.webp)

Если этот UTXO будет объединен с перетасованными выходами, они потеряют всю конфиденциальность, полученную во время циклов coinjoin, в значительной степени благодаря CIOH (_Common-Input-Ownership-Heuristic_). Если его объединить с другими токсичными изменениями, пользователь рискует потерять приватность, так как это свяжет различные входы из циклов coinjoin. Поэтому с ним следует обращаться осторожно. Более подробно мы обсудим управление этими токсичными UTXO в последнем разделе этой главы.

### Начальный микс

После завершения `Tx0` выровненные UTXO отправляются на счет **premix** в нашем портфеле, готовые к внедрению в свой первый цикл объединения монет, также называемый "начальным миксом" Если, как в нашем примере, `Tx0` генерирует несколько UTXO, предназначенных для смешивания, каждый из них будет интегрирован в отдельный начальный микс.

По окончании этих первых смешиваний счет **premix** будет пуст, а наши монеты, заплатив за добычу в рамках этого первого объединения, получат ровно столько, сколько определено выбранным пулом. В нашем примере, наши первоначальные UTXO в размере `108 000 сатов` будут уменьшены ровно до `100 000 сатов`.

![BTC204](assets/fr/147.webp)

### Ремиксы

После первоначального микширования UTXO передаются на аккаунт **postmix**. В этом аккаунте собраны как уже перемешанные UTXO, так и те, которые ожидают ремикса. Когда клиент Whirlpool активен, UTXO на аккаунте **postmix** автоматически становятся доступными для ремикса и будут случайным образом выбраны для участия в новых раундах.

Напоминаем, что ремиксы в этом случае совершенно бесплатны: не требуется никаких дополнительных платежей за обслуживание или майнинг. Таким образом, хранение UTXO на счете **postmix** сохраняет их ценность и одновременно улучшает их анонсы. Именно поэтому важно позволить этим монетам участвовать в нескольких циклах coinjoin. Это абсолютно ничего вам не стоит и повышает уровень их анонса.

Когда вы решите потратить смешанные UTXO, вы можете сделать это прямо с этого **postmix** аккаунта. Рекомендуется хранить смешанные UTXO на этом счете, чтобы воспользоваться бесплатными ремиксами и не дать им покинуть контур Whirlpool, что может снизить их конфиденциальность.

### Как правильно управлять своим аккаунтом на postmix?

После выполнения циклов coinjoin лучшей стратегией будет сохранение UTXO на счете **postmix** в ожидании их дальнейшего использования. Рекомендуется даже оставить их в ремиксе на неопределенное время, пока они не понадобятся.

Некоторые пользователи могут подумать о переводе смешанных биткоинов на защищенный аппаратный кошелек. Это возможно, но важно тщательно следовать рекомендациям Samourai Wallet, чтобы не нарушить достигнутую конфиденциальность.

Комбинирование UTXO - наиболее часто совершаемая ошибка. Вам необходимо избегать объединения смешанных UTXO с несмешанными UTXO в одной сделке, чтобы избежать эвристики Common-Input-Ownership (CIOH). Это требует тщательного управления UTXO в портфеле, особенно в плане маркировки.

![BTC204](assets/fr/148.webp)

Также важно с осторожностью подходить к объединению смешанных UTXO. Умеренные консолидации возможны, если ваши смешанные UTXO имеют значительные анонсы, но это неизбежно снизит конфиденциальность ваших монет. Следите за тем, чтобы консолидация не была слишком значительной или проводилась после недостаточного количества ремиксов, что чревато установлением предполагаемых связей между вашими UTXO до и после циклов объединения монет. Если вы сомневаетесь в правильности этих манипуляций, лучше всего не консолидировать UTXO после ремикса, а переводить их по одному на аппаратный кошелек, каждый раз генерируя новый пустой адрес. При этом не забывайте правильно маркировать каждый полученный UTXO.

Также не рекомендуется переводить свои постмиксы UTXO на кошелек, использующий нестандартные скрипты. Например, если вы заходите в Whirlpool с мультисигового кошелька, использующего скрипты `P2WSH`, есть небольшой шанс, что вы будете смешаны с другими пользователями, у которых изначально такой же тип кошелька. Если вы выведете свои постмиксы на этот же мультисиг-кошелек, уровень конфиденциальности ваших смешанных биткоинов будет значительно снижен. Помимо скриптов, существует множество других отпечатков кошельков, которые могут вас обмануть.

Как и в случае с любой транзакцией Bitcoin, важно не использовать адреса приема повторно. Каждая новая транзакция должна приниматься на новый, пустой адрес.

Самое простое и безопасное решение - позволить вашим смешанным UTXO лежать на их **постмиксном** счете, позволяя им ремиксировать и трогать их только для того, чтобы потратить. Портфели Samourai и Sparrow имеют дополнительные средства защиты от всех этих рисков, связанных с анализом цепочки. Эти средства защиты помогут вам избежать ошибок.

### Как правильно управлять токсичными изменениями?

Далее, вы должны быть осторожны в обращении с токсичной мелочью - мелочью, которая не смогла попасть в пул coinjoin. Эти токсичные UTXO, полученные в результате использования Whirlpool, представляют собой риск для вашей конфиденциальности, поскольку они устанавливают связь между вами и использованием coinjoin. Поэтому необходимо обращаться с ними с осторожностью и не объединять их с другими UTXO, особенно смешанными UTXO.

Вот несколько стратегий их использования:


- Смешивайте их в небольших бассейнах:** Если ваш токсичный UTXO достаточно велик, чтобы поместиться одному в небольшом бассейне, подумайте о его смешивании. Часто это лучший вариант. Однако смешивать несколько токсичных UTXO вместе, чтобы получить доступ к бассейну, не рекомендуется, так как это может связать ваши различные входы.
- Пометьте их как "неизрасходованные":** Другой подход - перестать их использовать, пометить их как "неизрасходованные" на специальном счете и просто выкинуть. Это гарантирует, что вы случайно не потратите их. Если стоимость биткоина вырастет, могут появиться новые пулы, более подходящие для ваших токсичных UTXO;
- Пожертвования:** Подумайте о том, чтобы сделать пожертвования, даже скромные, разработчикам, работающим над Биткойном и связанным с ним программным обеспечением. Вы также можете пожертвовать организациям, которые принимают BTC. Если управление токсичными UTXO кажется вам слишком сложным, вы можете просто избавиться от них, сделав пожертвование.
- Покупайте подарочные карты:** Такие платформы, как [Bitrefill](https://www.bitrefill.com/), позволяют обменивать биткоины на подарочные карты, которые можно использовать в различных торговых точках. Это может быть способом избавиться от токсичных UTXO без потери их стоимости.
- Консолидируйте их в Monero:** Кошелек Samourai предлагает услугу атомарного обмена между BTC и XMR. Это идеально подходит для управления токсичными UTXO, консолидируя их в Monero без ущерба для конфиденциальности через KYC, а затем отправляя их обратно в Bitcoin. Однако этот вариант может быть дорогостоящим с точки зрения платы за майнинг и премий из-за ограничений ликвидности.
- Отправьте их в Lightning Network:** Передача этих UTXO в Lightning Network для получения выгоды от снижения комиссии за транзакции - привлекательный вариант. Однако этот метод может раскрыть некоторую информацию в зависимости от того, как вы используете Lightning, поэтому его следует применять с осторожностью.

### Как использовать Whirlpool?

После ареста основателей Samourai Wallet и захвата их серверов 24 апреля 2024 года, инструмент Whirlpool больше не работает, даже для тех, у кого есть собственный Dojo. Ранее он был доступен на Samourai Wallet и Sparrow Wallet.

![BTC204](assets/fr/149.webp)

Однако остается вероятность того, что в ближайшие недели, в зависимости от результатов испытаний, этот инструмент может быть возвращен в эксплуатацию или запущен в другом виде. В любом случае я считаю, что рынок coinjoin на Bitcoin не останется без предложения надолго, так как на него есть очевидный спрос. Более того, модель Whirlpool, являющаяся наиболее продвинутой с точки зрения конфиденциальности, наверняка будет использоваться и в других реализациях в будущем.

Мы внимательно следим за развитием этого дела, а также за развитием событий, связанных с соответствующими инструментами. Будьте уверены, что мы будем обновлять этот курс по мере поступления новой информации.

В следующей главе мы узнаем, что такое "анонсеты", как рассчитываются эти показатели и как они могут помочь нам оценить эффективность циклов coinjoin.

https://planb.network/tutorials/privacy/on-chain/coinjoin-sparrow-wallet-84def86d-faf5-4589-807a-83be60720c8b
https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/tutorials/privacy/on-chain/coinjoin-dojo-c4b20263-5b30-4c74-ae59-dc8d0f8715c2
## Набор для анонимности

<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>

Изучив, как работают коинджоины, и проблемы, связанные с эффективным смешиванием, мы теперь узнаем, как измерить эту эффективность. Как определить, был ли процесс объединения монет эффективным и какую степень анонимности приобрела монета? Именно это мы и рассмотрим в этой главе с помощью наборов анонимности, или "анонсетами" по-английски.

### Напоминание о пользе Coinjoin

Полезность CoinJoin заключается в ее способности создавать правдоподобное отрицание, погружая вашу монету в группу неотличимых друг от друга монет. Цель этого действия - разрушить связи отслеживания, как от прошлого к настоящему, так и от настоящего к прошлому.

Другими словами, аналитик, который знает вашу начальную транзакцию (`Tx0`) на входе в циклы CoinJoin, не должен быть в состоянии с уверенностью определить ваш UTXO на выходе из циклов remix (анализ от входа в цикл до выхода из цикла).

![BTC204](assets/it/55/01.webp)

Напротив, аналитик, который знает ваш UTXO на выходе циклов CoinJoin, не сможет определить исходную транзакцию на входе циклов (анализ от выхода цикла до входа цикла).

![BTC204](assets/it/55/02.webp)

Чтобы оценить, насколько сложно аналитику связать прошлое с настоящим и наоборот, необходимо количественно определить размер групп однородных монет, в которых спрятана ваша монета. Эта мера говорит нам о количестве анализов, которые имеют одинаковую вероятность. Таким образом, если правильный анализ утоплен среди 3 других анализов равной вероятности, ваш уровень сокрытия очень низок. Однако если правильный анализ находится в наборе из 20 000 анализов с одинаковой вероятностью, ваша монета очень хорошо спрятана. И именно, размер этих наборов представляет собой индикаторы, называемые анонсетами.

### Понимание анонсов

Анонсеты служат индикаторами для оценки степени секретности конкретного UTXO. Более конкретно, они измеряют количество неразличимых UTXO в наборе, включающем исследуемую монету. Требование однородности набора UTXO означает, что анонсеты обычно рассчитываются на циклах CoinJoin. Использование этих показателей особенно актуально для монет Whirlpool CoinJoins из-за их однородности.

Анонсеты позволяют, в случае необходимости, судить о качестве CoinJoins. Большой размер анонсета означает высокий уровень анонимности, так как становится трудно выделить конкретный UTXO в однородном наборе.

Существует 2 типа анонсов:


- Перспективный анонсет;**
- Ретроспективный анонсет.**

### Перспективный анонс

Перспективный анонсет показывает размер группы, среди которой скрывается исследуемый UTXO на выходе из цикла, зная UTXO на входе, то есть количество неотличимых монет, присутствующих в этой группе. По-английски этот показатель называется "forward anonset", или "forward-looking metrics"

Этот показатель отражает устойчивость валюты к анализу прошлого и настоящего (вход и выход).

![BTC204](assets/it/55/03.webp)

Эта метрика оценивает степень защиты вашего UTXO от попыток восстановить его историю от точки входа до точки выхода в процессе объединения монет.

Например, если ваша транзакция участвовала в первом цикле объединения монет и было завершено еще два нисходящих цикла, то перспективный анонс вашей монеты будет `13`:

![BTC204](assets/fr/153.webp)

Например, представим, что наша монета на входе в цикл объединения монет имеет перспективный анонс `86 871`. Практически это означает, что она спрятана среди `86 871` неотличимых друг от друга монет. Сторонний наблюдатель, знающий об этой монете в начале цикла coinjoin и пытающийся отследить ее выход, столкнется с `86 871` возможными UTXO, каждый из которых с одинаковой вероятностью окажется искомой монетой.

![BTC204](assets/it/55/05.webp)

### Ретроспективный анонс

Ретроспективный анонсет показывает количество возможных источников для данной монеты, зная UTXO на выходе из цикла. Этот показатель измеряет устойчивость монеты к анализу "настоящее - прошлое" (от выхода до входа), то есть насколько сложно аналитику отследить происхождение вашей монеты до циклов объединения монет. По-английски этот показатель называется "backward anonset", или "ретроспективная метрика"

Зная ваш UTXO на выходе из циклов, ретроспективный анонс определяет количество потенциальных транзакций Tx0, которые могли бы составить ваш вход в циклы коинджойнта. На диаграмме ниже это соответствует сумме всех оранжевых пузырьков.

Например, представим, что наша монета на выходе из цикла coinjoin получает ретроспективный анонсет в `42,185`. Практически это означает, что существует `42,185` возможных источников для этого UTXO. Если сторонний наблюдатель обнаружит эту монету в конце цикла и попытается проследить ее происхождение, он столкнется с `42 185` возможными источниками, все из которых с равной вероятностью являются искомыми.

### Как конкретно вычислить анонсеты?

Для небольших наборов можно вручную рассчитать анонсеты с помощью проводника блоков. Однако для больших анонсетов использование специализированного инструмента становится необходимым. Насколько мне известно, единственным программным обеспечением, способным выполнить эту задачу, является _Whirlpool Stats Tool_, инструмент на языке Python, разработанный командами Samourai и OXT. К сожалению, в настоящее время этот инструмент не работает после ареста основателей Samourai и прекращения деятельности OXT, которая использовалась для извлечения данных из блокчейна.

Как мы видели в этой главе, анонсеты можно вычислить только при наличии определенной однородности в структуре коинджоина. И именно, в следующей главе мы узнаем, как количественно определить эту однородность в транзакции Биткойна, будь то коинджойн или более традиционная транзакция.

https://planb.network/tutorials/privacy/analysis/wst-anonsets-0354b793-c301-48af-af75-f87569756375
## Энтропия

<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>

Как мы уже видели в этой части, посвященной коинджоинам, однородность UTXO на входе и выходе играет важную роль в повышении конфиденциальности транзакции биткоина. Этот параметр позволяет правдоподобно отрицать возможность анализа цепочки. Измерить эту однородность можно несколькими методами, но одним из самых эффективных, на мой взгляд, является использование показателей, предоставляемых инструментом _Boltzmann_, разработанным командами OXT и Samourai Wallet, а именно энтропии транзакций. Именно ее мы подробно изучим в этой главе.

В отличие от анонсетов, которые рассчитываются по множеству транзакций, индикаторы, которые мы представим здесь, фокусируются исключительно на одной транзакции, будь то коинджойн или более традиционная транзакция.

### Количество интерпретаций

Первый показатель, который можно наблюдать в транзакции биткоина, - это общее количество возможных интерпретаций в глазах стороннего наблюдателя, анализирующего транзакцию. Принимая во внимание значения UTXO, участвующих в транзакции, этот показатель указывает на количество способов, которыми входы могут быть связаны с выходами. Другими словами, он определяет количество возможных интерпретаций, которые может породить транзакция в потоке биткоинов с точки зрения стороннего наблюдателя, анализирующего ее.

Например, простая платежная операция с 1 входом и 2 выходами будет иметь только одну интерпретацию, а именно, что вход #0 финансирует выход #0 и выход #1. Других возможных интерпретаций не существует:

![BTC204](assets/fr/159.webp)

В отличие от этого, коинджойн, структурированный в соответствии с моделью Whirlpool 5x5, имеет 1 496 возможных комбинаций:

![BTC204](assets/fr/160.webp)

Монетное соединение Whirlpool Surge Cycle 8x8 дает $9 934 563 возможных интерпретаций:

![BTC204](assets/fr/161.webp)

### Энтропия

Исходя из количества интерпретаций транзакции Bitcoin, мы можем вычислить ее энтропию.

В общем контексте криптографии и информации энтропия - это количественная мера неопределенности или непредсказуемости, связанная с источником данных или случайным процессом. Другими словами, энтропия - это способ измерить, насколько сложно предсказать или угадать информацию.

В конкретном контексте анализа цепочек энтропия также является названием показателя, полученного из энтропии Шеннона и [изобретенного ЛораномМТ](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf), который может быть рассчитан для транзакции Биткойна.

Когда транзакция имеет большое количество возможных интерпретаций, часто уместнее ссылаться на ее энтропию. Этот показатель позволяет оценить недостаток знаний аналитиков о точной конфигурации транзакции. Другими словами, чем выше энтропия, тем сложнее аналитикам определить потоки биткоинов между входами и выходами.

На практике энтропия показывает, имеет ли транзакция, с точки зрения стороннего наблюдателя, множество возможных интерпретаций, основанных исключительно на входных и выходных величинах, без учета других внешних или внутренних закономерностей и эвристик. Таким образом, высокая энтропия является синонимом высокой конфиденциальности транзакции.

Энтропия определяется как двоичный логарифм числа возможных комбинаций. Здесь используется формула, в которой $E$ представляет собой энтропию транзакции, а $C$ - количество возможных интерпретаций:

$$
E = \log_2(C)
$$

В математике двоичный логарифм (логарифм по основанию 2) соответствует обратной операции возведения 2 в определенную степень. Другими словами, двоичный логарифм $x$ - это экспонента, на которую нужно возвести $2$, чтобы получить $x$. Таким образом, этот показатель выражается в битах.

Возьмем пример расчета энтропии для транзакции coinjoin, структурированной в соответствии с моделью 5x5 Whirlpool, которая, как уже говорилось в предыдущем разделе, имеет число возможных интерпретаций $1,496:

$$
\begin{align*}
C &= 1.496 \\
E &= \log_2(1.496) \\
E &= 10.5469 \text{ bit}
\end{align*}
$$

Таким образом, энтропия этой транзакции coinjoin составляет 10,5469$ бит, что считается весьма удовлетворительным показателем. Чем выше это значение, тем больше различных интерпретаций допускает транзакция, что повышает уровень ее конфиденциальности.

Для транзакции 8x8 coinjoin, имеющей $9 934 563 интерпретации, энтропия будет равна:

$$
\begin{align*}
C &= 9.934.563 \\
E &= \log_2(9.934.563) \\
E &= 23,244 \text{ bit}
\end{align*}
$$

Рассмотрим другой пример со стандартной платежной транзакцией, имеющей 1 вход и 2 выхода: [1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/fr/162.webp)

В случае с этой транзакцией единственной возможной интерпретацией является: `(In.0) > (Out.0 ; Out.1)`. Следовательно, ее энтропия равна $0$:

$$
\begin{align*}
C &= 1 \\
E &= \log_2(1) \\
E &= 0 \text{ bit}
\end{align*}
$$

### Эффективность

Исходя из энтропии транзакции, мы также можем рассчитать эффективность ее конфиденциальности. Этот показатель оценивает эффективность транзакции, сравнивая ее с оптимальной транзакцией, возможной в идентичной конфигурации.

Это приводит нас к обсуждению концепции максимальной энтропии, которая соответствует наивысшей энтропии, которую теоретически может достичь конкретная структура транзакции. Эффективность транзакции рассчитывается путем сравнения этой максимальной энтропии с фактической энтропией анализируемой транзакции.

Используется следующая формула:


- $E_R$: фактическая энтропия транзакции, выраженная в битах;
- $E_M$: максимально возможная энтропия для транзакционной структуры, также выраженная в битах;
- $Ef$: эффективность транзакции в битах:

$$
Ef = E_R - E_M
$$

Например, для структуры coinjoin типа Whirlpool 5x5 максимальная энтропия составляет $10,5469$:

$$
\begin{align*}
E_R &= 10,5469 \\
E_M &= 10,5469 \\
Ef &= E_R - E_M \\
Ef &= 10,5469 - 10,5469 \\
Ef &= 0 \text{ bit}
\end{align*}
$$

Этот показатель также выражается в процентах. Используется следующая формула:


- $C_R$: количество возможных реальных интерпретаций;
- $C_M$: максимальное количество возможных интерпретаций с одинаковой структурой;
- $Ef$: эффективность, выраженная в процентах:

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1.496}{1.496} \\
E_f &= 100\%
\end{align*}
$$

Таким образом, эффективность $100\%$ означает, что транзакция максимизирует свой потенциал конфиденциальности, исходя из своей структуры.

### Плотность энтропии

Энтропия - хороший показатель для измерения конфиденциальности транзакции, но она частично зависит от количества входов и выходов в транзакции. Чтобы сравнить энтропию двух разных транзакций, которые не имеют одинакового количества входов и выходов, можно рассчитать плотность энтропии. Этот показатель дает представление об энтропии относительно каждого входа или выхода в транзакции. Плотность оказывается полезной при оценке и сравнении эффективности транзакций разного размера.

Чтобы рассчитать его, просто разделите общую энтропию транзакции на общее количество входов и выходов, задействованных в транзакции:


- $E_D$: плотность энтропии, выраженная в битах;
- $E$: энтропия транзакции, выраженная в битах;
- $T$: общее количество входов и выходов в транзакции:

$$
E_D = \frac{E}{T}
$$

Возьмем пример с объединением 5x5 Whirlpool:

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ bit}
\end{align*}
$$

Мы также рассчитали плотность энтропии для коинджоина 8x8 Whirlpool:

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
E_D &= 1.453 \text{ bit}
\end{align*}
$$

Анализируя плотность энтропии этих двух типов объединений, становится очевидным, что даже при нормировании энтропии на количество элементов объединение "Surge Cycle 8x8" создает больше неопределенности для анализа.

### Оценка Больцмана

Еще одна часть информации, анализируемая в транзакции, - оценка Больцмана каждого элемента относительно другого. Это таблица вероятностей соответствия между входами и выходами. Эта таблица показывает через показатель Больцмана условную вероятность того, что определенный вход связан с определенным выходом. Таким образом, это количественная мера условной вероятности возникновения связи между входом и выходом в транзакции, определяемая отношением числа благоприятных случаев наступления этого события к общему числу возможных случаев в наборе интерпретаций.

На примере соединения Whirlpool таблица условных вероятностей покажет возможности связи между каждым входом и выходом, обеспечивая количественную оценку неоднозначности ассоциаций в транзакции:

| % | Выход 0 | Выход 1 | Выход 2 | Выход 3 | Выход 4 |

| ------- | -------- | -------- | -------- | -------- | -------- |

Здесь очевидно, что каждый вход имеет одинаковую вероятность быть связанным с любым выходом, что повышает конфиденциальность транзакции.

Вычисление оценки Больцмана заключается в делении числа интерпретаций, в которых происходит определенное событие, на общее число доступных интерпретаций. Таким образом, чтобы определить балл, связав вход #0 с выходом #3 (событие, присутствующее в 512$ интерпретаций), процесс выглядит следующим образом:

$$
\begin{align*}
\text{Interpretazioni (IN.0 > OUT.3)} &= 512 \\
\text{Interpretazioni Totali} &= 1496 \\
\text{Punteggio} &= \frac{512}{1496} \\
\text{Punteggio} &= 34\%
\end{align*}
$$

Если мы пересмотрим пример с циклом объединения Surge 8x8 Whirlpool, то таблица Больцмана будет выглядеть следующим образом:

| | OUT.0 | OUT.1 | OUT.2 | OUT.3 | OUT.4 | OUT.5 | OUT.6 | OUT.7 | OUT.7 |

| ---- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |

| IN.0 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| В.1 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| В.2 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| В.3 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| В.4 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| В.5 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| В.6 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| В.7 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

Однако в случае простой транзакции с одним входом и двумя выходами ситуация иная:

| % | Выход 0 | Выход 1 |

| ------- | -------- | -------- |

| Вход 0 | 100% | 100% | 100% |

Здесь мы видим, что вероятность того, что каждый выход будет получен от входа #0, равна 100%. Таким образом, меньшая вероятность приводит к большей конфиденциальности за счет размывания прямых связей между входами и выходами.

### Детерминированные ссылки

Также можно рассчитать количество детерминированных связей в сделке. Этот показатель показывает, сколько связей между входами и выходами в анализируемой сделке являются неоспоримыми, с вероятностью 100 %. Этот показатель можно дополнить расчетом соотношения детерминированных связей. Соотношение дает представление о весе этих детерминированных связей среди всех связей в транзакции.

Например, в транзакции по соединению монет Whirlpool нет детерминированных связей между входами и выходами, поэтому индикатор показывает 0 связей и коэффициент 0 %. Напротив, во второй рассмотренной нами простой платежной транзакции (с одним входом и двумя выходами) индикатор говорит нам о наличии двух детерминированных связей, а соотношение достигает 100 %. Таким образом, нулевой показатель сигнализирует об отличной конфиденциальности из-за отсутствия прямых и неоспоримых связей между входами и выходами.

### Как рассчитать эти показатели?

Рассчитать эти показатели вручную по приведенным мною уравнениям относительно просто. Основная сложность заключается в определении количества возможных интерпретаций сделки. Для стандартной транзакции этот расчет можно выполнить вручную. Однако для коинджоина задача значительно усложняется.

Ранее существовал инструмент на языке Python под названием _Boltzmann Calculator_, разработанный командами OXT и Samourai, который позволял автоматически рассчитывать все эти показатели для транзакции биткоина:

![BTC204](assets/fr/163.webp)

Также для этих анализов можно было использовать веб-сайт KYCP.org:

![BTC204](assets/fr/164.webp)

К сожалению, после ареста основателей Samourai эти инструменты в настоящее время не работают.

Теперь, когда мы подробно обсудили коинджоины, в последнем разделе нашего тренинга мы рассмотрим другие методы обеспечения конфиденциальности, доступные в Биткойне. Мы рассмотрим транзакции payjoin, специфические типы транзакций pseudo-coinjoin, протоколы статических адресов, а также меры по повышению конфиденциальности не на уровне транзакций, а на уровне сети узлов.

https://planb.network/tutorials/privacy/analysis/boltzmann-entropy-738e45af-18a6-4ce6-af1a-1bf58e15f1fe
# Поймите преимущества других передовых методов обеспечения конфиденциальности

<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Транзакции Payjoin

<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>

В настоящее время объединение монет является наиболее эффективным методом внесения неопределенности в отслеживание монет при анализе цепочки. Как мы видели в предыдущих главах, для достижения эффективного смешивания входы и выходы должны быть как можно более однородными. Кроме того, очень важно, чтобы соединения монет были объединены в как можно большую группу, чтобы максимизировать анонсы. Таким образом, чтобы коинджойнты были эффективными, в них должно участвовать большое количество однородных монет. Это множество требований означает, что транзакции коинджойнтов имеют очень жесткую структуру: суммы заранее определены, и все участники должны их придерживаться, чтобы обеспечить единообразие процесса. Кроме того, коинджоины требуют синхронизации между всеми участниками и координатором во время создания транзакции.

Эти требования делают coinjoin непригодным для прямых платежей. Например, если вы владеете частью в 1 млн сатов в пуле coinjoin, использовать ее напрямую в качестве платежа будет сложно. Это потребовало бы синхронизации с другими участниками и координатором для создания именно в тот момент, когда вам нужно совершить платеж, совместной транзакции, а сумма покупки должна была бы точно соответствовать стоимости вашей части, что практически невыполнимо. Поэтому транзакция coinjoin по своей природе является совместной очищающей транзакцией, что означает, что, как правило, владельцами входов являются те же владельцы, что и выходов.

Однако было бы интересно иметь структуры транзакций, которые позволяют осуществлять практические платежи, внося сомнения в анализ цепочки. Именно это мы и рассмотрим в этой и следующей главах.

### Что такое транзакция payjoin?

Payjoin - это особая структура транзакций Bitcoin, которая повышает конфиденциальность пользователя во время трат, сотрудничая с получателем платежа.

В 2015 году ЛоранМТ впервые упомянул этот метод под названием "стеганографические транзакции", согласно доступной статье [здесь] (https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt). Позже эту технику перенял кошелек Samourai, который в 2018 году стал первым клиентом, реализовавшим ее с помощью инструмента Stowaway. Концепция payjoin также встречается в [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki) и [BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki). Таким образом, для обозначения payjoin используется несколько терминов:


- Payjoin;
- Безбилетник;
- P2EP (_Pay-to-End-Point_);
- Стеганографическая транзакция.

Уникальность payjoin заключается в его способности генерировать транзакцию, которая на первый взгляд кажется обычной, но на самом деле является мини-коинджоином между двумя людьми. Для этого в структуре транзакции получатель платежа указывается во входных данных вместе с фактическим отправителем. Затем получатель включает в середину транзакции платеж для себя, который позволяет ему получить оплату.

Давайте рассмотрим пример, чтобы лучше понять этот процесс. Алиса покупает багет за 4 000 сатов, используя UTXO в 10 000 сатов, и выбирает payjoin. Ее пекарь, Боб, добавляет на входе свой UTXO в 15 000 сатов, который он полностью возвращает на выходе, в дополнение к 4 000 сатов Алисы.

В примере Боб-пекарь вводит 15 000 сатов и получает на выходе 19 000 сатов, разница составляет ровно 4 000 сатов, что является ценой багета. Со своей стороны, Алиса вводит 10 000 сатов и получает на выходе 6 000 сатов, что представляет собой остаток в размере -4 000 сатов, то есть цену багета. Чтобы упростить пример, я намеренно опустил плату за добычу в этой сделке.

### С какой целью используется payjoin?

Транзакция payjoin решает две задачи, позволяющие пользователям повысить конфиденциальность платежей.

Во-первых, payjoin стремится обмануть стороннего наблюдателя, создавая отклонения в анализе цепочки. Это становится возможным благодаря эвристике _Общего владения входом_ (CIOH). Как мы видели в части 3, обычно, когда транзакция в блокчейне имеет несколько входов, предполагается, что все эти входы принадлежат одному и тому же субъекту или пользователю.

Таким образом, когда аналитик изучает транзакцию payjoin, у него создается впечатление, что все данные поступают от одного и того же лица. Однако такое восприятие неверно, поскольку получатель платежа также вносит вклад наряду с фактическим плательщиком. Таким образом, анализ цепочки перекошен в сторону интерпретации, которая оказывается ложной.

Давайте вернемся к нашему примеру с транзакцией payjoin для оплаты багета:

Увидев эту транзакцию в блокчейне, сторонний наблюдатель, руководствующийся обычной эвристикой анализа цепочек, интерпретировал бы ее так: "Алиса присоединила 2 UTXO к входной транзакции, чтобы заплатить Бобу 19 000 сатов"

Такая интерпретация явно неверна; как вы уже знаете, два UTXO на входе не принадлежат одному и тому же человеку. Один из них принадлежит Алисе, покупательнице багетов, а другой - Бобу, пекарю.

Таким образом, анализ внешнего наблюдателя направляется на ошибочный вывод, что обеспечивает сохранение конфиденциальности заинтересованных сторон.

### Стеганографическая транзакция

Вторая цель payjoin - обмануть стороннего наблюдателя относительно реальной суммы платежа. Изучив структуру транзакции, аналитик может поверить, что платеж эквивалентен сумме одного из выходов.

Если взять наш пример с покупкой багета, то аналитик решит, что сумма платежа соответствует либо UTXO в 6 000 сатов, либо UTXO в 19 000 сатов. В данном случае аналитик, скорее всего, решит, что сумма платежа равна 19 000 сат, потому что в выводе есть 2 UTXO, по крайней мере один из которых больше 6 000 сат (нет логической причины использовать 2 UTXO для оплаты 6 000 сат, когда для этого платежа было бы достаточно одного UTXO).

Но в действительности этот анализ неверен. Сумма платежа не совпадает ни с одним из выходов. На самом деле это разница между UTXO получателя на выходе и UTXO получателя на входе.

Таким образом, транзакция payjoin попадает в сферу стеганографии. Она позволяет скрыть реальную сумму транзакции в поддельной транзакции, которая служит для отвода глаз.

Стеганография - это техника сокрытия информации в других данных или объектах таким образом, чтобы присутствие скрытой информации не было заметно. Например, секретное сообщение может быть спрятано в точке несвязного текста, что делает его незаметным для невооруженного глаза (это техника [micropoint](https://fr.wikipedia.org/wiki/Micropoint)).

В отличие от шифрования, которое делает информацию неразборчивой без ключа для расшифровки, стеганография не изменяет ее. Они остаются на виду. Скорее, ее цель - скрыть само существование секретного сообщения, в то время как криптография ясно показывает наличие скрытой информации, хотя и недоступной без ключа. Вот почему первоначальное название payjoin было "стеганографические транзакции"

Можно провести аналогию между криптографией и coinjoin, а также между стеганографией и payjoin. Фактически, coinjoin имеет признаки, схожие с криптографией: метод узнаваем, но информация не поддается расшифровке. В отличие от этого, payjoin сродни стеганографии: информация теоретически доступна, но поскольку метод ее сокрытия не распознается, она становится недоступной.

### Как использовать payjoin?

Среди известных программ, поддерживающих payjoin, - Sparrow Wallet, Wasabi Wallet, Mutiny, BitMask, BlueWallet, JoinMarket, а также платежный процессор BTCPay.

Самой продвинутой реализацией payjoin был только Stowaway на кошельке Samourai. Однако после закрытия основателей программы этот инструмент теперь работает лишь частично. Преимущество Stowaway в том, что это полноценный и очень простой в использовании протокол, который поддерживает как получение, так и отправку payjoin. Частично подписанные транзакции можно обменивать вручную, сканируя несколько QR-кодов, или автоматически через Tor посредством Soroban. Именно последний вариант связи в настоящее время не работает.

Сложность использования payjoin заключается в его зависимости от участия продавца. Как покупатель, вы не сможете использовать payjoin, если торговец не поддерживает его. Это создает дополнительные трудности во время покупки: мало того, что сложно найти продавцов, принимающих биткоин, но если вы еще и ищете тех, кто поддерживает payjoin, все становится еще сложнее.

Одним из решений может стать использование транзакционных структур, которые вносят двусмысленность в анализ цепочки, не требуя сотрудничества со стороны получателя. Это позволило бы нам повысить уровень конфиденциальности платежей, не завися от активного участия продавцов. Именно это мы и будем изучать в следующей главе.

https://planb.network/tutorials/privacy/on-chain/payjoin-sparrow-wallet-087a0e49-61cd-41f5-8440-ac7b157bdd62
https://planb.network/tutorials/privacy/on-chain/payjoin-samourai-wallet-48a5c711-ee3d-44db-b812-c55913080eab
## Платеж с помощью мини-коинджоина

<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>

Если вы хотите совершить платежную операцию, сохранив при этом некоторую степень конфиденциальности, payjoin - хороший вариант. Но, как мы уже видели, payjoin требует участия получателя. Что же делать, если он отказывается участвовать в payjoin, или если вы просто предпочитаете не привлекать его? Одна из альтернатив - использовать транзакцию Stonewall или Stonewall x2. Давайте рассмотрим эти два типа транзакций подробнее.

### Стоунволлская сделка

Stonewall - это особая форма транзакции Bitcoin, направленная на повышение конфиденциальности пользователя во время шопинга, имитирующая псевдокоин-соединение между двумя людьми, но на самом деле не являющаяся таковым. На самом деле, эта транзакция не является совместной. Пользователь может создать ее самостоятельно, используя в качестве исходных данных только принадлежащие ему UTXO. Вы можете создать транзакцию Stonewall для любого случая, без необходимости синхронизации с другим пользователем или получателем.

Работа транзакции Stonewall заключается в следующем: на входе транзакции отправитель использует 2 UTXO, которые принадлежат ему. На выходе транзакция производит 4 UTXO, 2 из которых будут точно такого же количества. Остальные 2 UTXO составят остаток. Из двух выходов с одинаковой суммой только один действительно попадет к получателю платежа.

В сделке Stonewall есть только 2 роли:


- Отправитель, который осуществляет платеж;
- Получатель, который может не знать о характере операции и просто ожидает оплаты от отправителя.

Давайте рассмотрим пример, чтобы понять эту структуру транзакций. Алиса пришла к пекарю Бобу, чтобы купить багет, который стоит 4 000 сатов. Она хочет расплатиться биткойном, сохранив при этом некоторую степень конфиденциальности своего платежа. Поэтому она решает создать транзакцию Stonewall для оплаты.

Анализируя эту транзакцию, мы видим, что Боб-пекарь фактически получил 4 000 сатов в оплату за багет. Алиса использовала 2 UTXO в качестве входов: один из 10 000 сатов и один из 15 000 сатов. На выходе она получила 3 UTXO: один в размере 4 000 сатов, один в размере 6 000 сатов и один в размере 11 000 сатов. Таким образом, чистый баланс Алисы по этой сделке составляет -4 000 сатов, что в точности соответствует цене багета.

В этом примере я намеренно пренебрег комиссией за майнинг для простоты понимания. В реальности комиссии за транзакции полностью ложатся на отправителя.

### Каковы цели стоунволлской сделки?

Структура Stonewall вносит в транзакцию большую энтропию и запутывает следы цепного анализа. Со стороны такая транзакция может быть истолкована как мини-связь между двумя людьми. Но в действительности это платеж. Таким образом, этот метод порождает неопределенность в анализе цепочки или даже приводит к ложным следам.

Давайте вернемся к примеру Алисы в пекарне Боба. Транзакция в блокчейне будет выглядеть следующим образом:

![BTC204](assets/fr/174.webp)

Сторонний наблюдатель, полагающийся на общую эвристику анализа цепочек, может ошибочно заключить, что "_два человека совершили небольшое объединение монет, получив по одному UTXO на входе и по два UTXO на выходе_" Анализ этой транзакции извне не приводит к применению эвристики общего владения входом (CIOH), поскольку наличие двух выходов на одну и ту же сумму предполагает схему объединения монет. Поэтому с внешней точки зрения CIOH в данном конкретном случае не применяется.

![BTC204](assets/fr/175.webp)

Эта интерпретация неточна, поскольку, как вы знаете, один UTXO был отправлен Бобу-пекарю, 2 UTXO на входе поступили от Алисы, и она получила 3 остальных выхода.

![BTC204](assets/fr/176.webp)

И что особенно интересно в структуре сделки Stonewall, так это то, что с точки зрения стороннего наблюдателя она выглядит точно так же, как и сделка Stonewall x2.

### Стоунволлская сделка x2

Stonewall x2 - еще одна специфическая форма транзакции биткоина, которая также направлена на повышение конфиденциальности пользователя во время траты, но на этот раз за счет сотрудничества с третьей стороной, не участвующей в трате. Этот метод функционирует как псевдо-соединение двух участников при совершении платежа третьей стороне.

Операция Stonewall x2 довольно проста: для совершения платежа используется UTXO, находящийся в вашем распоряжении, и привлекается помощь третьей стороны, которая также вносит свой UTXO. В результате транзакция завершается четырьмя выходами: два из них равны по сумме, один отправляется на адрес получателя платежа, другой - на адрес, принадлежащий жертвователю. Третий UTXO отправляется на другой адрес жертвователя, позволяя ему вернуть первоначальную сумму (нейтральное действие для него, за вычетом платы за майнинг), а последний UTXO возвращается на принадлежащий нам адрес, что составляет остаток платежа.

Таким образом, в транзакциях Stonewall x2 определены три разные роли:


- Отправитель, который осуществляет фактический платеж;
- Получатель, который может не знать о характере операции и просто ожидает оплаты от отправителя;
- Сотрудник, предоставляющий биткоин для анализа транзакций, полностью возвращает свои средства в конце (нейтральное действие для него, за вычетом платы за майнинг).

Давайте вернемся к нашему примеру с Алисой, которая пришла к Бобу-булочнику, чтобы купить багет стоимостью 4 000 сатов. Она хочет расплатиться биткоинами, сохранив при этом некоторую конфиденциальность платежа. Поэтому она звонит своему другу Чарльзу, который поможет ей в этом процессе.

![BTC204](assets/fr/177.webp)

Анализируя эту транзакцию, мы видим, что Боб-пекарь фактически получил 4 000 сатов в оплату за багет. Алиса использовала 10 000 сатов на входе и получила 6 000 сатов на выходе, в результате чего чистый баланс составил -4 000 сатов, что соответствует цене багета. Что касается Чарльза, то он предоставил 15 000 сатов на входе и получил два выхода: один в размере 4 000 сатов, а другой - 11 000 сатов, в результате чего баланс составил 0.

В этом примере я намеренно пренебрег комиссиями, чтобы облегчить понимание. В действительности комиссии за майнинг обычно делятся поровну между эмитентом платежа и вкладчиком.

### Каковы цели сделки Stonewall x2?

Как и структура Stonewall, структура Stonewall x2 добавляет значительное количество энтропии в транзакцию и скрывает следы анализа цепочки. С внешней точки зрения такая транзакция может быть истолкована как небольшое объединение монет между двумя людьми. Но в действительности это платеж. Таким образом, этот метод порождает неопределенность в анализе цепочки, что также приводит к ложным следам.

Давайте рассмотрим пример с Алисой, Бобом-пекарем и Чарльзом. Транзакция в блокчейне будет выглядеть следующим образом:

![BTC204](assets/fr/178.webp)

Сторонний наблюдатель, полагающийся на общую эвристику анализа цепочек, может ошибочно заключить, что "_Элис и Чарльз совершили небольшое объединение монет, получив по одному UTXO на вход и по два UTXO на выход_" Опять же, анализ этой транзакции со стороны не приводит к применению эвристики общего владения входом (CIOH), поскольку наличие двух выходов в одинаковом количестве предполагает схему объединения монет. Поэтому с внешней точки зрения CIOH в данном конкретном случае не применяется.

![BTC204](assets/fr/179.webp)

Эта интерпретация неточна, потому что, как вы знаете, Бобу-пекарю был отправлен один UTXO, у Алисы есть только один выход покоя, а у Чарльза - два.

![BTC204](assets/fr/180.webp)

И опять же, что особенно интересно в структуре сделки Stonewall x2, так это то, что с точки зрения стороннего наблюдателя она выглядит точно так же, как и сделка Stonewall.

### В чем разница между Stonewall и Stonewall x2?

Транзакция StonewallX2 работает точно так же, как и транзакция Stonewall, за исключением того, что первая является совместной, а вторая - нет. Как мы уже видели, транзакция Stonewall x2 предполагает участие третьей стороны (Чарльза), которая не имеет отношения к платежу и предоставляет свои биткоины для повышения конфиденциальности транзакции. В классической транзакции Stonewall роль вкладчика берет на себя отправитель.

![BTC204](assets/fr/181.webp)

Таким образом, с внешней точки зрения модель транзакций абсолютно одинакова.

Тот факт, что эти две структуры транзакций имеют совершенно одинаковый паттерн, означает, что даже если сторонний наблюдатель сможет определить паттерн "Stonewall(x2)", он не будет обладать всей информацией. Он не сможет определить, какой из двух UTXO с одинаковыми суммами соответствует платежу. Он также не сможет определить, поступили ли два входных UTXO от двух разных людей (Stonewall x2) или они принадлежали одному человеку, который их объединил (Stonewall).

Последнее замечание связано с тем, что сделки Stonewall x2 проходят точно по той же схеме, что и сделки Stonewall. Со стороны, без дополнительной контекстной информации, невозможно отличить сделку Stonewall от сделки Stonewall x2. Однако первые не являются совместными сделками, а вторые - являются. Это вносит еще больше сомнений в анализ одной из таких сделок.

### Когда использовать транзакции Stonewall и Stonewall x2?

Когда вы хотите использовать инструмент конфиденциальности для транзакции, логика должна быть следующей:


- В качестве приоритета вы можете выбрать payjoin;
- Если продавец не поддерживает payjoins, совместную транзакцию можно совершить с другим человеком вне оплаты, используя структуру Stonewall x2;
- Если вы не можете найти никого, с кем можно было бы провести транзакцию Stonewall x2, вы можете провести транзакцию Stonewall самостоятельно, которая будет имитировать поведение транзакции Stonewall x2.

### Как использовать транзакции Stonewall и Stonewall x2?

Транзакции Stonewall и Stonewall x2 доступны как в приложении Samourai Wallet, так и в программном обеспечении Sparrow Wallet.

Однако, как и в случае с payjoins, после ареста основателей Samourai, транзакции Stonewall x2 теперь осуществляются только путем ручного обмена PSBT между участниками. Автоматический обмен через Soroban, к сожалению, в настоящее время недоступен.

Вы также можете выполнить этот тип транзакции вручную из любого программного обеспечения для биткойн-кошелька.

В следующей главе мы изучим еще одну относительно неизвестную, но очень полезную технику обеспечения конфиденциальности в дополнение к тем, что мы уже изучили.

https://planb.network/tutorials/privacy/on-chain/stonewall-033daa45-d42c-40e1-9511-cea89751c3d4
https://planb.network/tutorials/privacy/on-chain/stonewall-x2-05120280-f6f9-4e14-9fb8-c9e603f73e5b
## Подборы

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>

Использование структур транзакций Биткойна, которые вносят неоднозначность в анализ цепочки, таких как coinjoin, особенно полезно для защиты конфиденциальности. Однако, как мы уже говорили в главе о payjoins, транзакции coinjoin естественным образом идентифицируются в цепочке. Вспомните аналогию, которую мы провели между криптографией и коинджоинами: при шифровании файла третья сторона, обнаружившая этот зашифрованный файл, не может получить доступ к его содержимому, но может четко определить, что файл был модифицирован, чтобы скрыть его содержимое. То же самое верно и для коинджоинов: когда аналитик изучает транзакцию коинджоина, даже если он не может установить прямые связи между входами и выходами (и наоборот), он все равно может понять, что наблюдаемая транзакция является коинджоином.

В зависимости от предполагаемого использования вашей монеты после прохождения циклов coinjoin, тот факт, что она прошла этот процесс, может быть проблематичным. Например, если вы планируете продать свою монету на регулируемой биржевой платформе, но она недавно прошла через coinjoin, инструмент анализа цепочки платформы обнаружит этот факт. Платформа может отказаться принять вашу UTXO, которая подверглась коинджойнту, или даже потребовать от вас объяснений, что чревато приостановкой работы вашего счета или замораживанием средств. В некоторых случаях платформа может также сообщить о вашем поведении в государственные органы (например, этого требует TRACFIN от провайдеров услуг по работе с цифровыми активами (PSAN) во Франции).

Чтобы избежать этого, нам понадобится инструмент, способный размыть следы прошлого биткойн-монеты, чтобы восстановить некую форму взаимозаменяемости. Именно это и является целью рикошета.

### Что такое рикошет?

Рикошет - это техника, которая заключается в проведении нескольких фиктивных транзакций для себя (sweeping) с целью имитации передачи права собственности на биткоин. Этот инструмент отличается от других рассмотренных нами транзакционных структур тем, что он не обеспечивает проспективную анонимность, а скорее ретроспективную. Фактически, рикошет позволяет размыть специфику, которая может поставить под угрозу взаимозаменяемость биткойн-монеты из-за ее прошлого.

Чтобы скрыть отпечаток, оставленный прошлым событием на монете, например, циклом соединения монет, рикошет выполняет четыре последовательные транзакции, в которых пользователь переводит средства себе на разные адреса.

После этой последовательности операций инструмент ricochet наконец направляет биткоины к месту их конечного назначения - обменной платформе.

Цель состоит в том, чтобы создать расстояние, которое влияет на взаимозаменяемость монеты, например, транзакция coinjoin, и конечный акт траты, который может отвергнуть эту монету из-за ее прошлого. Таким образом, инструменты цепного анализа могут сделать вывод, что после события, вероятно, произошла смена владельца, и посчитать, что эта монета является взаимозаменяемой. В случае с coinjoin инструменты анализа цепочки могут предположить, что это не тот же человек, который отправил биткоины и выполнил coinjoin, и поэтому бесполезно инициировать действия против отправителя.

### Почему это работает?

Столкнувшись с таким методом рикошета, можно было бы предположить, что программное обеспечение для анализа цепочек будет углублять их изучение за пределы четырех хопов. Однако эти платформы сталкиваются с дилеммой при оптимизации порога обнаружения. Им необходимо установить предел количества переходов, после которого они признают, что, вероятно, произошла смена владельца и что связь с предыдущим событием (например, объединением монет) следует игнорировать.

Однако определение этого порога оказывается рискованным: каждое увеличение наблюдаемого числа пропусков экспоненциально увеличивает количество ложных срабатываний, то есть лиц, ошибочно отмеченных как участники события, когда транзакция была совершена кем-то другим. Такой сценарий представляет большую опасность для компаний, поскольку ложные срабатывания приводят к недовольству, что может побудить пострадавших клиентов уйти к конкурентам. В долгосрочной перспективе слишком большой порог обнаружения приводит к тому, что платформа теряет больше клиентов, чем ее конкуренты, что может поставить под угрозу ее выживание. Поэтому таким платформам сложно увеличить количество наблюдаемых скачков, и 4 часто является достаточным числом для противодействия их анализу.

Наблюдаемое здесь явление в некотором роде аналогично теории шести степеней разделения.

Теория шести степеней разделения предполагает, что любой человек на Земле связан с любым другим через цепочку знаний, включающую не более шести посредников. Достаточно пройти через ряд из шести человек, каждый из которых лично знает следующего, чтобы достичь любого человека в мире.

В случае с транзакциями Bitcoin наблюдается аналогичное явление. Отслеживая достаточное количество транзакций Bitcoin, неизбежно сталкиваешься с объединением монет. Метод рикошета использует этот принцип, используя большее количество транзакций, чем могут разумно отследить обменные платформы. Если платформы решат отслеживать больше транзакций, то можно просто добавить дополнительный прыжок, чтобы обойти эту меру.

### Когда и как использовать рикошет?

Чаще всего рикошет используется, когда необходимо скрыть предыдущее участие в коинджоине на принадлежащем вам UTXO. В идеале лучше всего избегать передачи биткоинов, прошедших коинджойн, регулируемым организациям. Однако в случае, если у вас нет других вариантов, особенно при необходимости срочно ликвидировать биткоин в фиатную валюту, рикошет предлагает эффективное решение.

Этот метод эффективен не только при соединении монет, но и при использовании любых других знаков, которые могут поставить под угрозу взаимозаменяемость монеты.

Идея метода рикошета изначально принадлежит команде кошелька Samourai, которая интегрировала его в свое приложение, чтобы автоматизировать процесс. Услуга на Samourai платная, так как за рикошет взимается плата в размере 100 000 сатов, помимо платы за майнинг. Поэтому его использование рекомендуется скорее для переводов значительных сумм.

Приложение Samourai предлагает две вариации рикошета:


- Усовершенствованный рикошет, или "ступенчатая доставка", преимущество которого заключается в том, что плата за услуги Samourai распределяется на пять последовательных транзакций. Этот вариант также гарантирует, что каждая транзакция передается в отдельное время и записывается в отдельный блок, что позволяет максимально точно имитировать поведение при смене владельца. Хотя этот метод более медленный, он предпочтительнее для тех, кто не торопится, поскольку максимально повышает эффективность рикошета, усиливая его устойчивость к анализу цепочки;
- Классический рикошет, который предназначен для быстрого выполнения операции путем передачи всех транзакций за короткий промежуток времени. Поэтому этот метод обеспечивает меньшую конфиденциальность и меньшую устойчивость к анализу, чем продвинутый метод. Его следует использовать только для срочных отправлений.

Рикошет заключается в простой отправке биткоина самому себе. Вполне возможно выполнить рикошет вручную на любом программном обеспечении кошелька, без использования специализированного инструмента. Просто переведите себе ту же монету позже, используя каждый раз новый пустой адрес.

В следующей главе мы рассмотрим несколько методов тайной передачи собственности. Эти методы радикально отличаются от тех, которые мы рассматривали до сих пор, как по принципу работы, так и по результатам.

https://planb.network/tutorials/privacy/on-chain/ricochet-e0bb1afe-becd-44a6-a940-88a463756589
## Тайные переводы имущества

<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>

Среди методов обеспечения конфиденциальности в биткоине - тайная передача прав собственности. Этот метод направлен на передачу прав собственности на биткоины от одного человека к другому и наоборот без явного отображения этой транзакции в блокчейне. Давайте вместе изучим различные доступные техники, а также их преимущества и недостатки.

### Обмен монет

В основе CoinSwap лежит относительно простая концепция: она использует смарт-контракты для облегчения передачи прав собственности на биткоины между двумя пользователями, без необходимости доверия и без явного отображения этой передачи в блокчейне.

Давайте представим упрощенный пример с Алисой и Бобом. Алиса владеет 1 BTC, защищенным закрытым ключом $A$, а Боб - также 1, защищенным закрытым ключом $B$. Теоретически они могут обменяться своими закрытыми ключами по внешнему каналу связи, чтобы выполнить секретную передачу.

Однако этот наивный метод сопряжен с большим риском с точки зрения доверия. Ничто не мешает Алисе сохранить копию закрытого ключа $A$ после обмена и использовать ее позже для кражи биткоинов, когда ключ окажется в распоряжении Боба.

Более того, нет никакой гарантии, что Алиса не получит закрытый ключ Боба $B$ и не отправит в ответ свой закрытый ключ $A$. Таким образом, этот обмен опирается на чрезмерное доверие между сторонами и оказывается неэффективным для обеспечения секретной передачи прав собственности безопасным способом.

Чтобы решить эти проблемы и разрешить обмен между сторонами, которые не доверяют друг другу, мы можем использовать системы смарт-контрактов. Смарт-контракт - это программа, которая запускается автоматически при выполнении заданных условий, что в нашем случае обеспечивает автоматический обмен имуществом, не требующий взаимного доверия.

Для этого мы можем использовать HTLC (_Hash Time-Locked Contracts_) или PTLC (_Point Time-Locked Contracts_). Эти два протокола работают одинаково, используя систему временной блокировки, которая гарантирует, что обмен будет успешно завершен или полностью отменен, защищая тем самым целостность средств обеих сторон. Основное различие между HTLC и PTLC заключается в том, что HTLC используют хэши и предварительные изображения для защиты транзакции, в то время как PTLC используют адаптивные подписи.

В сценарии обмена монетами с использованием HTLC или PTLC между Алисой и Бобом обмен происходит безопасным образом: либо он проходит успешно, и каждый получает BTC другого, либо он терпит неудачу, и каждый сохраняет свои собственные BTC. Поэтому ни одна из сторон не может обмануть или украсть BTC другой стороны.

> hTLC также являются механизмом, используемым для безопасной маршрутизации платежей по двусторонним каналам Lightning Network._
> Использование адаптивных подписей особенно интересно в этом контексте, поскольку позволяет обойтись без традиционных скриптов (этот механизм иногда называют "скриптами без скриптов"). Эта возможность помогает снизить комиссионные сборы, связанные с обменом. Еще одно важное преимущество адаптивных подписей заключается в том, что они не требуют использования общего хэша для обеих сторон транзакции, что позволяет избежать выявления прямой связи между ними при определенных видах обмена.
### Адаптивные подписи

Адаптивные подписи - это криптографический метод, который объединяет действительную подпись с дополнительной подписью, называемой "_адаптивной подписью_", чтобы раскрыть секретный фрагмент данных. Этот механизм разработан таким образом, что знание двух из трех следующих элементов: действительной подписи, адаптивной подписи и секрета, позволяет вывести третий недостающий элемент. Интересное свойство этого метода заключается в том, что если мы знаем адаптивную подпись нашего контрагента и конкретную точку на эллиптической кривой, связанную с секретом, который использовался для вычисления этой адаптивной подписи, мы можем вывести свою собственную адаптивную подпись, которая будет совместима с тем же секретом, не имея прямого доступа к самому секрету.

При обмене монетами использование адаптивных подписей позволяет одновременно раскрывать две части конфиденциальной информации между участниками, что избавляет от необходимости взаимного доверия. Давайте рассмотрим этот процесс на примере Алисы и Боба, которые хотят обменяться 1 BTC, но не доверяют друг другу. Они используют адаптивные подписи, чтобы устранить необходимость в доверии при этом обмене. Вот как они действуют:


- Алиса инициирует обмен, создавая транзакцию $m_A$, которая отправляет 1 BTC Бобу. Она генерирует подпись $s_A$, которая подтверждает эту транзакцию, используя свой закрытый ключ $p_A$ ($P_A = p_A \cdot G$), нецель $n_A$ ($N_A = n_A \cdot G$) и секрет $t$ ($T = t \cdot G$):

$$s_A = n_A + t + H(N_A + T \parallel P_A \parallel m_A) \cdot p_A$$


- Алиса вычисляет адаптивную подпись $s_A'$, вычитая секрет $t$ из своей истинной подписи $s_A$:

$$s_A' = s_A - t$$


- Алиса отправляет Бобу свою адаптивную подпись $s'_A$, свою неподписанную транзакцию $m_A$, точку, соответствующую секрету ($T$), и точку, соответствующую неце ($N_A$). Эти элементы образуют то, что называется "_адаптером_" Важно отметить, что, имея только эту информацию, Боб не может получить BTC Алисы.
- Однако у Боба есть возможность убедиться, что Алиса не пытается его обокрасть. Для этого он проверяет, действительно ли адаптивная подпись Алисы $s_A'$ соответствует предлагаемой транзакции $m_A$. Если следующее уравнение верно, он может быть уверен, что адаптивная подпись Алисы действительна:

$$s_A' \cdot G = N_A + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$


- Эта проверка дает Бобу достаточную уверенность, чтобы уверенно продолжить обмен. Затем он создает свою собственную транзакцию $m_B$, предназначенную для отправки 1 BTC Алисе, и генерирует свою адаптивную подпись $s_B'$, которая также будет связана с тем же секретом $t$. В этот момент только Алиса знает значение $t$; Боб знает только соответствующее значение $T$, которое передала ему Алиса:

$$s_B' = n_B + H(N_B + T \parallel P_B \parallel m_B)\cdot p_B$$


- Боб передает Алисе свою адаптивную подпись $s_B'$, неподписанную транзакцию $m_B$, а также точку, соответствующую секрету ($T$), и точку, соответствующую несекрету ($N_B$). Алиса, знающая секрет $t$, может теперь объединить адаптивную подпись Боба $s_B'$ с этим секретом, чтобы сгенерировать действительную подпись $s_B$ для транзакции $m_B$, которая переведет ей BTC Боба:

$$s_B = s_B' + t$$

$$(s_B' + t)\cdot G = N_B + T + H(N_B + T \parallel P_B \parallel m_B)\cdot P_B$$


- Алиса передает эту подписанную транзакцию $m_B$ в блокчейн Биткойна, чтобы получить BTC, обещанные Бобом. Когда Боб видит эту транзакцию в блокчейне, он может извлечь подпись $s_B = s_B' + t$. С помощью этой информации Боб может вычленить известный секрет $t$, который ему был нужен:

$$t = (s_B' + t) - s_B' = s_B - s_B'$$


- И на самом деле, этот секрет $t$ был единственным недостающим элементом для Боба, чтобы сгенерировать действительную подпись $s_A$ из адаптированной подписи Алисы $s_A'$. Эта подпись позволяет подтвердить транзакцию $m_A$, которая отправляет BTC от Алисы к Бобу. Затем Боб вычисляет $s_A$ и, в свою очередь, передает транзакцию $m_A$ в блокчейн:

$$s_A = s_A' + t$$

$$(s_A' + t)\cdot G = N_A + T + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$

Давайте вкратце расскажем, как адаптер подписи работает при обмене монет. Изначально Алиса отправляет Бобу неподписанную транзакцию вместе с адаптером, который позволяет Бобу проверить, что раскрытый позже секрет даст ему доступ к биткоинам. В ответ Боб отправляет Алисе свою неподписанную транзакцию и адаптер. Алиса может завершить транзакцию Боба и вернуть биткоины, передав действительную транзакцию с использованием секрета. Когда эта транзакция будет опубликована в блокчейне, Боб сможет извлечь секрет и таким образом разблокировать транзакцию Алисы. Следовательно, если Алиса инициирует перевод биткоинов Боба, он, в свою очередь, может получить доступ к биткоинам Алисы, не требуя взаимного доверия.

Важно отметить, что биржи монет впервые были предложены [Грегори Максвеллом в октябре 2013 года на BitcoinTalk](https://bitcointalk.org/index.php?topic=321228.0).

### Атомная биржа

По аналогии с обменом монет и с использованием тех же типов смарт-контрактов можно также осуществлять атомарный обмен. Атомарный обмен позволяет напрямую обменивать различные криптовалюты, например BTC и XMR, между двумя пользователями, не требуя доверия или вмешательства посредника. Такие обмены называются "атомарными", поскольку они имеют только два возможных исхода: либо обмен проходит успешно и обе стороны остаются довольны, либо он терпит неудачу, и каждый сохраняет свои первоначальные криптовалюты, что устраняет необходимость в доверии к другой стороне.

![BTC204](assets/fr/197.webp)

Атомарный обмен и обмен монет имеют схожий метод работы и предлагают одинаковые преимущества и недостатки с точки зрения конфиденциальности. Фактически, с точки зрения Биткойна, атомарный обмен сопоставим с обменом монет, осуществляемым в два этапа. Сначала мы обмениваем наши BTC на другую криптовалюту, а затем эта криптовалюта может быть обменена на другие BTC. И наконец, мы получаем BTC другого пользователя. Именно поэтому при анализе вопросов конфиденциальности я объединяю эти два протокола в категорию секретных обменов собственностью.

![BTC204](assets/fr/198.webp)

Однако, в отличие от обмена монет, на атомарных биржах может наблюдаться дисбаланс в плане доступной ликвидности, особенно на биржах BTC/XMR. Как правило, обменять биткоин на альткоины проще, поскольку на них существует большой спрос, что поддерживает низкие премии за конвертацию в этом направлении. Однако обмен альткоинов на BTC может быть более сложным из-за более низкого спроса, что часто приводит к очень высоким премиям.

Наконец, когда в атомарном обмене участвуют биткоин в сети onchain и биткоин в сети Lightning, мы называем его "_погружным обменом_"

### Действительно ли это полезно?

Тайные передачи прав собственности, такие как обмен монетами и атомарные биржи, имеют преимущество в том, что позволяют обмануть эвристику анализа цепочки. Эти методы позволяют создать впечатление, что в транзакциях участвует один и тот же пользователь, даже если на самом деле собственность перешла из рук в руки. Однако главный недостаток этих методов заключается в том, что они очень рискованны без использования дополнительной техники, позволяющей нарушить историю монет.

По сути, когда Алиса совершает обмен монетами или атомарный обмен с Бобом, она обменивает право собственности на свои биткоины на биткоины Боба. В случае атомарного обмена обмен включает альткоины, но принцип остается тем же. Таким образом, Алиса в итоге получает монету $B$, а Боб - монету $A$. Это добавляет сомнений в анализ цепочки, но история монет остается прослеживаемой. Если аналитик изучит монету $A$, он сможет проследить предыдущие действия Алисы, и наоборот, для монеты $B$.

С точки зрения Алисы, риск заключается в том, что история монеты $B$ может показаться подозрительной определенным организациям. Если, например, Боб приобрел монету $B$ в результате преступной деятельности, например взлома, то эта монета останется связанной с его незаконной деятельностью. Алиса может оказаться владельцем монеты, которую она не сможет перевести на регулируемые торговые платформы без риска заморозить свои средства или даже быть обвиненной в преступлениях Боба, хотя она не имеет к ним никакого отношения.

И конечно, такие методы обеспечения конфиденциальности, как обмен монетами или обмен атомами, предпочитают преступники, чьи средства находятся под наблюдением властей. Эти протоколы дают им возможность избавиться от своих биткоинов, находящихся под наблюдением, в обмен на вполне взаимозаменяемые биткоины. Это также позволяет им создавать диверсии, направляя власти на других пользователей. Таким образом, для этих людей существует двойная польза.

При coinjoin, даже если ваша монета смешивается с контролируемыми биткоинами, история монеты нарушается, что обеспечивает форму правдоподобного отрицания, которая не существует в секретных протоколах передачи собственности, таких как обмен монет или атомарный обмен.

Если Алиса хочет избежать какого-либо риска, она обязательно должна использовать метод, нарушающий историю монеты $B$, например, прогнать ее через coinjoins. В связи с этим возникает вопрос о целесообразности сочетания тайной передачи прав собственности и coinjoin. Коинджойн, прерывая историю монеты, уже обеспечивает достаточный уровень конфиденциальности для Алисы. Таким образом, я считаю, что если Алиса стремится защитить свою конфиденциальность, то разумнее будет прибегнуть непосредственно к коинджойнту, чем к обмену монет с последующим коинджойнтом.

Чтобы методы тайной передачи прав собственности были действительно эффективными и исключали риск связывания истории пользователя $A$ с пользователем $B$, необходимо, как это ни парадоксально, чтобы об их использовании было широко известно. Если обмен монет используется массово и власти знают об этой распространенной практике, то можно создать правдоподобную форму отрицания вины. Однако до тех пор, пока использование этих переводов остается незначительным, я считаю, что эти методы будут оставаться слишком рискованными для пользователей.

До сих пор мы в основном изучали методы обеспечения конфиденциальности на уровне самих транзакций. В следующей главе мы рассмотрим вопросы на уровне сети и распространения транзакций.

## Конфиденциальность в сети P2P

<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>

В части 4 мы обсудили важность использования полного узла для защиты конфиденциальности ваших транзакций. Однако важно понимать, что сам узел может быть подвержен атакам, направленным на получение информации о вашей деятельности. Поэтому в этой главе мы рассмотрим различные меры защиты конфиденциальности, но не на уровне самих транзакций или потоков биткоинов, а на уровне сети.

### Одуванчик

Одним из способов избежать различных атак деанонимизации является использование предложенного протокола Dandelion. Этот протокол передачи данных был формализован в BIP156, но никогда не был реализован в Биткойне. Идея Dandelion заключается в повышении конфиденциальности маршрутизации транзакций в сети Биткойн для противодействия различным формам атак. Ее основная цель - скрыть узел-источник, который первоначально передает транзакцию в сеть. Раскрытие этого узла может связать транзакцию Bitcoin с определенным IP-адресом (если узел работает в незашифрованной сети), тем самым обеспечивая точку входа для анализа цепочки.

Такая связь между действиями в Bitcoin и IP-адресом представляет собой значительный риск для конфиденциальности пользователей. На самом деле множество организаций могут легко связать IP-адрес с личностью пользователя. К ним, как ни странно, относятся правительства и интернет-провайдеры. Кроме того, эта информация может стать общедоступной, например, если ваш IP-адрес и личные данные окажутся в открытом доступе в результате утечки данных при взломе базы данных веб-сайта.

В стандартном режиме работы Bitcoin транзакции, созданные пользователем на его программном кошельке, передаются на его персональный узел. Этот узел немедленно передает новую транзакцию всем пирам, к которым он подключен.

Затем эти пиры проверяют транзакцию, чтобы убедиться, что она соответствует правилам консенсуса и локальным правилам стандартизации. После проверки каждый пир в свою очередь пересылает транзакцию своим пирам, и так далее.

Распределение транзакций, ожидающих интеграции в блок, происходит достаточно сбалансированно и статистически предсказуемо. Этой уязвимостью могут воспользоваться сговорившиеся узлы-шпионы, которые совместно следят и анализируют сеть, чтобы определить первый узел, передавший транзакцию. Если наблюдатель может определить местонахождение узла-источника, он может предположить, что транзакция поступила от оператора этого узла. Этот тип наблюдения может связать транзакции, обычно анонимные, с конкретными IP-адресами.

Цель BIP156 - решить эту проблему. Для этого он вводит дополнительный этап передачи новой транзакции, чтобы сохранить анонимность перед широкомасштабным публичным распространением. Сначала Dandelion использует этап "стебля", на котором транзакция отправляется через случайный путь узлов.

Затем транзакция передается всей сети на этапе "пуха" (blowhole).

Стебель и одуванчик - это отсылки к поведению распространения транзакции по сети, которое напоминает форму одуванчика.

Таким образом, узлы-шпионы потенциально могут отследить транзакцию до узла, инициировавшего фазу продувки (массовую передачу), но этот узел не является тем, кто первым передал транзакцию, поскольку он получил ее от последнего узла в стебле. Если узлы-шпионы не могут отследить ствол, они не могут определить и узел-источник.

Даже при наличии узлов-шпионов на этапе стебля сомнения всегда остаются, потому что, как только они встречают честный узел в графе распространения, шпионы не могут определить, является ли этот узел первоисточником или просто посредником.

Этот метод маршрутизации усложняет отслеживание до узла-источника, что усложняет отслеживание транзакции по сети до ее происхождения. Таким образом, Dandelion улучшает конфиденциальность, ограничивая возможности противников по деанонимизации сети. Этот метод еще более эффективен, когда транзакция на этапе "стебля" проходит через узел, который шифрует свои сетевые соединения, как, например, Tor или P2P Transport V2.

BIP156 не был интегрирован в Bitcoin Core и в настоящее время имеет статус "отклонен" Основная проблема этого протокола заключается в том, что на этапе стейблкоина транзакции должны пересылаться промежуточными узлами, прежде чем будут проверены. Как мы уже видели, в обычной модели Bitcoin каждый узел сначала проверяет транзакцию, прежде чем направить ее своим коллегам. Если транзакция не соответствует правилам консенсуса или локальной стандартизации узла, она игнорируется и не пересылается. Этот процесс важен для предотвращения DoS-атак, поскольку только действительные транзакции передаются всей сети. Недействительные транзакции, которые могут массово генерироваться для перегрузки сети, останавливаются на первом попавшемся узле и не распространяются. Основной риск, связанный с Dandelion, заключается в том, что этот новый протокол может создать новые векторы для DoS-атак, позволяя передавать недействительные транзакции через часть сети.

### P2P Transport V2

P2P Transport V2 - еще один сетевой протокол, представленный в BIP324. Это новая версия P2P-транспортного протокола Bitcoin, в которой используется оппортунистическая криптография для повышения конфиденциальности и безопасности связи между узлами.

Это усовершенствование призвано решить несколько проблем, связанных с базовой версией протокола P2P. В частности, он делает обмениваемые данные неотличимыми от других типов данных, циркулирующих в Интернете, для пассивного наблюдателя. Главная цель - не дать правительствам, интернет-провайдерам или VPN-провайдерам массово следить за пользователями биткоина. Это также усложняет задачу этих организаций по определению того, является ли пользователь Интернета также пользователем Биткойна, т. е. работает ли он с полноценным узлом.

P2P V2 также помогает снизить риски цензуры и атак за счет обнаружения специфических паттернов в пакетах данных. Это усложняет и удорожает проведение различных типов атак Sybil на сетевом уровне. Атака Sybil происходит, когда субъект создает несколько ложных идентификаторов, чтобы получить неоправданное преимущество. В контексте сети Биткойн это часто проявляется в том, что участник контролирует большое количество полных узлов и агрессивно использует их для увеличения количества соединений. Атаки Sybil могут быть пассивными, направленными на сбор информации и нарушение конфиденциальности пользователей, или активными, в виде атак Eclipse. Последние изолируют определенный узел от остальной сети, позволяя ему цензурировать пользователя или изменять получаемые данные. Наконец, P2P V2 делает атаки _Man-In-The-Middle_ (MITM) более дорогостоящими и легко обнаруживаемыми.

Шифрование, реализованное в P2P V2, не включает аутентификацию, чтобы не усложнять и не нарушать неразрешенный характер сетевого соединения. Однако этот новый транспортный протокол P2P обеспечивает лучшую защиту от пассивных атак и делает активные атаки значительно более дорогостоящими и обнаруживаемыми. Введение псевдослучайного потока данных в сетевые сообщения усложняет задачу злоумышленникам, желающим подвергнуть коммуникации цензуре или манипуляциям.

Транспорт P2P V2 был включен в качестве опции (отключен по умолчанию) в версию 26.0 Bitcoin Core, выпущенную в декабре 2023 года. Затем он был включен по умолчанию в версии 27.0 в апреле 2024 года. Его можно изменить с помощью опции `v2transport=` в конфигурационном файле.

### Тор

Относительно простое решение, позволяющее избежать риска потери конфиденциальности для узла сетевого уровня, - запустить его полностью под Tor. Tor - это сеть ретрансляционных серверов (узлов), которые анонимизируют происхождение TCP-соединений через Интернет. Он работает путем инкапсуляции данных в несколько слоев шифрования. Каждый ретрансляционный узел снимает один слой, чтобы раскрыть адрес следующего узла, пока не будет достигнут конечный пункт назначения. Сеть Tor обеспечивает анонимность за счет того, что промежуточные узлы не могут знать ни происхождения, ни назначения данных, что значительно затрудняет отслеживание действий пользователя наблюдателем.

Таким образом, Tor не только шифрует передаваемые данные, но и позволяет скрыть происхождение и назначение сообщений. Используя Tor для связи с личным узлом, мы повышаем конфиденциальность наших транзакций: интернет-провайдер (ISP) не может расшифровать сообщения, а другие узлы в сети Bitcoin не могут определить IP-адрес узла-источника. Кроме того, Tor скрывает использование биткойна от провайдера.

Основной риск, связанный с этим методом, заключается в том, что Tor - это независимый от Биткойна протокол. Если у вас есть узел Bitcoin под Tor и Tor перестанет работать, то ваш узел Bitcoin больше не сможет общаться.

Также важно отметить, что обмен данными в Tor происходит медленнее. Эта задержка особенно важна при первоначальном запуске узла, так как начальная загрузка блока (IBD) требует большого количества коммуникаций. В результате начальная синхронизация с сетью Биткойна может быть значительно дольше при использовании Tor. Также можно выполнить IBD в открытой сети, а затем активировать Tor. Хотя этот метод раскрывает существование вашего узла Bitcoin вашему провайдеру, он защищает вашу личную информацию о транзакциях после перехода на Tor.

Изучив различные методы обеспечения конфиденциальности на сетевом уровне, в следующих главах я хочу представить два элегантных решения, позволяющих избежать повторного использования адресов: BIP47 и Silent Payments.

## BIP47 и многоразовые платежные коды

<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>

Как мы видели в части 3, повторное использование адресов является серьезным препятствием для конфиденциальности пользователей в протоколе Биткойн. Чтобы снизить эти риски, настоятельно рекомендуется генерировать новый адрес получения для каждого нового платежа, поступившего в кошелек. Хотя сегодня генерация нового адреса упрощается благодаря использованию современного программного обеспечения и иерархических детерминированных кошельков, эта практика может показаться нелогичной.

В традиционной банковской системе, например, мы привыкли сообщать свой IBAN, который всегда остается неизменным. Как только мы сообщаем его кому-то, он может отправить нам несколько платежей без необходимости повторного взаимодействия с нами. Нео-банки также предлагают более современные возможности, такие как использование уникальных адресов электронной почты в PayPal или RevTags в Revolut. Даже за пределами финансовой сферы наши повседневные идентификаторы, такие как почтовый адрес, номер телефона и адрес электронной почты, уникальны и постоянны. Нам не нужно обновлять их при каждом новом взаимодействии.

Однако принцип работы Bitcoin отличается: для каждой входящей транзакции необходимо генерировать новый адрес получения. Этот компромисс между простотой использования и конфиденциальностью уходит корнями в самое начало "Белой книги" Биткойна. С момента публикации первой версии своего документа в конце 2008 года Сатоши Накамото уже предупреждал нас об этом риске:

**В качестве дополнительного защитного экрана для каждой транзакции можно использовать новую пару ключей, чтобы они не были связаны с общим владельцем

Существует множество методов получения нескольких платежей по одному идентификатору без повторного использования адреса. Каждый из этих методов имеет свои компромиссы и недостатки. Среди таких методов - BIP47, предложение, разработанное Юстусом Ранвье и опубликованное в 2015 году. Это предложение направлено на создание многоразовых платежных кодов, позволяющих осуществлять несколько транзакций одному и тому же лицу, избегая при этом повторного использования адресов. По сути, BIP47 стремится предложить интуитивно понятную платежную систему в качестве уникального идентификатора, сохраняя при этом конфиденциальность транзакций.

![BTC204](assets/fr/212.webp)

BIP47 не улучшает конфиденциальность пользователей напрямую, поскольку платеж BIP47 обеспечивает тот же уровень конфиденциальности, что и классическая транзакция Bitcoin с использованием свежих адресов. Однако он делает использование Биткойна более удобным и интуитивно понятным, что обычно приводит к нарушению конфиденциальности. Благодаря BIP47 эта простота использования достигает того же уровня конфиденциальности, что и при классической транзакции. Вот почему BIP47 является ценным инструментом для сохранения конфиденциальности.

Изначально BIP47 был предложением, сформулированным для интеграции в Bitcoin Core, но так и не был принят. Однако некоторые программы решили реализовать его самостоятельно на уровне приложений. Так, команда Samourai Wallet разработала собственную реализацию BIP47 под названием "PayNym"

### Общий принцип работы BIP47 и PayNym

Цель BIP47 - обеспечить возможность получения множества платежей без повторного использования адресов. Она основана на использовании многоразового платежного кода, который позволяет разным отправителям отправлять несколько платежей на один код, принадлежащий другому пользователю. Таким образом, получателю не нужно указывать новый адрес для каждой транзакции, что значительно облегчает обмен данными, сохраняя при этом конфиденциальность.

![BTC204](assets/it/66/4.webp)

Пользователь может свободно поделиться своим платежным кодом в социальных сетях или на собственном сайте, не рискуя потерять конфиденциальность, в отличие от классического адреса получения или открытого ключа.

Для проведения транзакции обе стороны должны иметь биткойн-кошелек с реализацией BIP47, например PayNym на Samourai Wallet или Sparrow Wallet. Совместное использование платежных кодов создает между ними секретный канал. Чтобы эффективно установить этот канал, отправитель должен выполнить определенную транзакцию в блокчейне Биткойна, известную как "транзакция с уведомлением" (подробнее об этом я расскажу позже).

Комбинация платежных кодов обоих пользователей генерирует общие секреты, которые, в свою очередь, позволяют создать большое количество уникальных адресов приема Bitcoin (ровно 2^32, или около 4 миллиардов). Таким образом, платежи, осуществляемые через BIP47, на самом деле адресованы не самому платежному коду, а классическим адресам получения, полученным из платежных кодов участвующих пользователей.

Код платежа служит виртуальным идентификатором, полученным из семени кошелька. В иерархической структуре портфеля код платежа располагается на третьем уровне, то есть на уровне счета.

![BTC204](assets/it/66/5.webp)

Цель деривации для BIP47 идентифицируется индексом `47'` (`0x8000002F`), который ссылается на BIP47. Пример пути деривации для многоразового платежного кода может быть следующим:

```plaintext
m/47'/0'/0'/
```

Чтобы дать вам представление о том, как выглядит код платежа, вот мой:

```plaintext
M8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Этот код также может быть закодирован в QR-код для удобства общения, как и классический адрес получения.

Что касается ботов PayNym, то эти роботы, которых иногда можно увидеть в Twitter, являются визуальным представлением платежного кода, созданного кошельком Samourai. Они генерируются с помощью функции хэширования, что придает им почти уникальность. Они появляются в виде небольшой строки символов, начинающихся с `+`:

```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

Эти аватары также могут быть представлены в виде изображений:

![BTC204](assets/fr/215.webp)

Хотя эти роботы не обладают конкретной технической функциональностью в рамках BIP47, они играют роль в облегчении взаимодействия между пользователями, предлагая легко узнаваемую визуальную идентичность.

---
*В следующих разделах этой главы, посвященных BIP47, мы подробно рассмотрим ее работу, в частности, сосредоточившись на используемых криптографических методах. Чтобы полностью понять эти довольно технические объяснения, сначала необходимо разобраться в структуре HD-кошельков, процессах выведения ключей и основных принципах криптографии на основе эллиптических кривых. Если вы хотите узнать больше об этих понятиях, в Plan ₿ Network доступен еще один бесплатный курс:*

https://planb.network/courses/46b0ced2-9028-4a61-8fbc-3b005ee8d70f
*Я настоятельно рекомендую вам проследить за этим, потому что понимание технической работы BIP47 поможет вам гораздо легче понять другие подобные предложения, которые мы обсудим в следующих главах*

---
### Код многоразового платежа

Как уже упоминалось ранее, многоразовый платежный код расположен на третьем уровне кошелька HD, что делает его сравнимым с `xpub`, как по его положению в структуре кошелька, так и по его роли.

80-байтовый код платежа делится следующим образом:


- Байт `0`: Версия**. Для первой версии BIP47 этот байт имеет значение `0x01`;
- Байт `1`: Битовое поле**. Это пространство зарезервировано для включения дополнительных признаков при определенном использовании. Для стандартного использования с PayNym этот байт определен как `0x00`;
- Байт `2`: Четность `y`**. Этот байт имеет значение `0x02` или `0x03`, указывающее на то, является ли ордината открытого ключа четной или нечетной, поскольку используется сжатый открытый ключ;
- От байта `3` до байта `34`: Значение `x`**. Эти байты представляют собой абсциссу открытого ключа. Конкатенация `x` и четности `y` образует полный сжатый открытый ключ;
- От байта `35` до байта `66`: Код цепочки**. Это пространство содержит код цепочки, связанный с открытым ключом;
- От байта `67` до байта `79`: Заполнение**. Это пространство предназначено для возможного будущего развития. В текущей версии здесь просто размещены нули, чтобы достичь размера 80 байт, необходимого для вывода `OP_RETURN`.

Вот шестнадцатеричное представление моего многоразового кода платежа, уже представленного в предыдущем разделе:

```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

![BTC204](assets/it/66/7.webp)

Прежде всего, необходимо добавить префиксный байт `P` в начале, чтобы четко указать, что это платежный код. Этот байт представлен в виде `0x47`:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

Наконец, для обеспечения целостности платежного кода выполняется расчет контрольной суммы с помощью `HASH256`, который заключается в двойном хэшировании с помощью функции `SHA256`. Первые четыре байта, полученные в результате такого хэширования, затем конкатенируются в конце платежного кода:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

Как только эти шаги будут выполнены, код платежа будет готов. Осталось преобразовать его в базу 58, чтобы получить окончательную версию:

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

В процессе создания платежного кода мы используем сжатый открытый ключ и код цепочки. Оба они получены путем детерминированного и иерархического деривации из семени кошелька. Для этого используется следующий путь деривации:

```plaintext
m/47'/0'/0'/
```

Чтобы сгенерировать сжатый открытый ключ и связанный с ним код цепочки для многоразового платежного кода, мы начинаем с вычисления основного закрытого ключа из семени кошелька. Затем мы получаем пару дочерних ключей, используя индекс `47 + 2^31` (усиленная деривация). За этим шагом следуют еще два последовательных вычисления пар дочерних ключей, каждое с использованием индекса `2^31` (усиленная деривация).

### Эллиптический кривой обмен ключами Диффи-Хеллмана (ECDH)

Криптографический протокол, лежащий в основе BIP47, обозначается аббревиатурой ECDH, то есть _Elliptic-Curve Diffie-Hellman_. Этот метод является вариантом оригинального обмена ключами Диффи-Хеллмана.

Протокол Диффи-Хеллмана, представленный в 1976 году, позволяет двум сторонам, каждая из которых имеет пару ключей (открытый и закрытый), договориться об общем секрете, даже если они общаются исключительно через открытый, небезопасный канал.

![BTC204](assets/it/66/10.webp)

Этот общий секрет (здесь - синий ключ) можно использовать для других операций. Как правило, этот общий секрет может использоваться для шифрования и дешифрования сообщений в незащищенной сети:

![BTC204](assets/fr/220.webp)

Чтобы выполнить этот обмен, Диффи-Хеллман использует модульную арифметику для вычисления общего секрета. Вот упрощенное объяснение того, как это работает:


- Алиса и Боб договариваются об общем цвете, в данном случае желтом, который представляет собой публичные данные (злоумышленники знают этот цвет);
- Алиса выбирает секретный цвет, например красный, и смешивает их, чтобы получить оранжевый;
- Боб также выбирает секретный цвет, синий, и смешивает его с желтым, чтобы получить зеленый;
- Затем они обмениваются полученными цветами, оранжевым и зеленым. Этот обмен может происходить в незащищенной, наблюдаемой сети;
- Смешав зеленый цвет Боба с его секретным цветом, Алиса получила коричневый;
- Боб, сделав то же самое с оранжевым цветом Алисы и ее секретным синим, также получает коричневый цвет.

![BTC204](assets/it/66/12.webp)

В этом упрощении коричневый цвет представляет собой секрет, которым поделились Алиса и Боб. Важно понимать, что в реальности злоумышленнику невозможно разделить оранжевый и зеленый цвета, чтобы узнать секретные цвета Алисы или Боба.

Теперь давайте рассмотрим, как этот протокол работает на самом деле, не с помощью цветовых аналогий, а с помощью вещественных чисел и модульной арифметики!

Прежде чем обсуждать механизмы Диффи-Хеллмана, позвольте мне кратко напомнить вам о двух важных математических понятиях, которые нам понадобятся:


- **Простое число** - это натуральное число, которое имеет только два делителя: 1$ и оно само. Например, $7$ - простое число, потому что оно может делиться только на $1$ и $7$. С другой стороны, $8$ не является простым числом, поскольку оно делится на $1$, $2$, $4$ и $8$. Таким образом, у него четыре целых положительных делителя вместо двух;
- **mod** (обозначается $mod$ или $\%$) - это математическая операция, которая для двух целых чисел возвращает остаток от евклидова деления первого на второе. Например, $16 \bmod 5 = 1$.

**Обмен ключами Диффи-Хеллмана между Алисой и Бобом происходит следующим образом:**


- Алиса и Боб договорились о двух общих числах: $p$ и $g$. $p$ - простое число, и чем больше это число, тем более безопасным будет метод Диффи-Хеллмана. $g$ - примитивный корень из $p$. Эти два числа можно открыто передавать по незащищенной сети. Они представляют собой эквивалент **желтого цвета** в приведенном выше упрощении. Поэтому важно, чтобы Алиса и Боб использовали абсолютно одинаковые значения для $p$ и $g$.

После определения этих параметров Алиса и Боб выбирают случайное секретное число. Алиса называет свое случайное секретное число $a$ (эквивалентно **красному цвету**), а Боб - $b$ (эквивалентно **синему цвету**). Эти числа должны оставаться строго конфиденциальными.

Вместо того чтобы напрямую обмениваться числами $a$ и $b$, каждая сторона вычисляет $A$ и $B$ следующим образом:

$A$ равно $g$, возведенному в степень $a$ по модулю $p$:

$$
A = g^a \bmod p
$$

$B$ равно $g$, возведенному в степень $b$ по модулю $p$:

$$
B = g^b \bmod p
$$

Между двумя сторонами происходит обмен значениями $A$ (эквивалент **оранжевого цвета**) и $B$ (эквивалент **зеленого цвета**). Этот обмен может происходить открыто по незащищенной сети;

Алиса, получив $B$, вычисляет значение $z$ следующим образом:

$z$ равно $B$, возведенному в степень $a$ по модулю $p$:

$$
z = B^a \bmod p
$$

Вспомните:

$$
B = g^b \bmod p
$$

Таким образом, мы получаем:

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

Применение правил экспоненты:

$$
(x^n)^m = x^{nm}
$$

Таким образом, мы получаем:

$$
z = g^{ba} \bmod p
$$


- Со своей стороны Боб, получив $A$, также вычисляет значение $z$ следующим образом:

$z$ равно $A$, возведенному в степень $b$ по модулю $p$:

$$
z = A^b \bmod p
$$

Таким образом, мы получаем:

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

Благодаря дистрибутивности оператора modulo Алиса и Боб получают одно и то же значение $z$. Это число представляет собой их общий секрет, эквивалентный **коричневому цвету** в предыдущем упрощении с горшками краски. Теперь они могут использовать этот общий секрет для симметричного шифрования своих сообщений в незащищенной сети.

Злоумышленник, даже имея $p$, $g$, $A$ и $B$ (открытые значения), не сможет вычислить $a$, $b$ или $z$ (закрытые значения). Для этого потребуется инвертировать экспоненту, что невозможно без поочередного перебора всех возможностей, поскольку это эквивалентно вычислению дискретного логарифма, то есть обратной экспоненты в конечной циклической группе.

Поэтому, пока значения $a$, $b$ и $p$ достаточно велики, протокол Диффи-Хеллмана безопасен. Как правило, при 2048-битных параметрах (число с 600 цифрами в десятичной системе счисления) проверка всех возможностей для $a$ и $b$ была бы нецелесообразной. На сегодняшний день при таких числах этот алгоритм считается безопасным.

Именно в этом кроется главный недостаток протокола Диффи-Хеллмана. Чтобы быть безопасным, алгоритм должен использовать большие числа. Именно поэтому сегодня люди предпочитают алгоритм ECDH (_Elliptic Curve Diffie-Hellman_) - вариант Диффи-Хеллмана, основанный на алгебраической кривой, точнее, на эллиптической кривой. Такой подход позволяет работать с гораздо меньшими числами при сохранении эквивалентной безопасности, что сокращает ресурсы, необходимые для вычислений и хранения.

Общий принцип алгоритма остался прежним. Однако вместо случайного числа $a$ и числа $A$, вычисленного из $a$ методом модульного экспонирования, мы используем ключевую пару, созданную на эллиптической кривой. Вместо того чтобы полагаться на дистрибутивность оператора modulo, мы используем групповой закон для эллиптических кривых, а точнее, ассоциативность этого закона.

Если кратко объяснить принцип криптографии на эллиптических кривых, то закрытый ключ представляет собой случайное число в диапазоне от $1$ до $n-1$, где $n$ - порядок кривой. Открытый ключ, с другой стороны, представляет собой определенную точку на этой кривой, полученную из закрытого ключа путем операций сложения и удвоения точек, начиная с порождающей точки, в соответствии с уравнением:

$$
K = k \cdot G
$$

В этой формуле $K$ обозначает открытый ключ, $k$ - закрытый ключ, а $G$ - точку генерации.

Одна из существенных особенностей этих ключей - простота вычисления $K$ из $k$ и $G$, в то время как найти $k$ из $K$ и $G$ практически невозможно. Эта асимметрия создает одностороннюю функцию. Другими словами, легко вычислить открытый ключ, если известен закрытый ключ, но найти закрытый ключ по открытому невозможно. Эта безопасность все еще опирается на вычислительную сложность дискретного логарифма.

Мы будем использовать это свойство для адаптации нашего алгоритма Диффи-Хеллмана. **Принцип работы ECDH заключается в следующем:**


- Алиса и Боб вместе договариваются о криптографически безопасной эллиптической кривой и ее параметрах. Эта информация является общедоступной;
- Алиса генерирует случайное число $ka$, которое будет ее закрытым ключом. Этот закрытый ключ должен оставаться в секрете. Она определяет свой открытый ключ $Ka$ путем сложения и удвоения точек на выбранной эллиптической кривой:

$$
K_a = k_a \cdot G
$$


- Боб также генерирует случайное число $kb$, которое будет его закрытым ключом. Он вычисляет соответствующий открытый ключ $kb$:

$$
K_b = k_b \cdot G
$$


- Алиса и Боб обмениваются своими открытыми ключами $Ka$ и $Kb$ в незащищенной публичной сети.
- Алиса вычисляет точку $(x,y)$ на кривой, применяя свой закрытый ключ $ka$ к открытому ключу Боба $Kb$:

$$
(x,y) = k_a \cdot K_b
$$


- Боб вычисляет точку $(x,y)$ на кривой, применяя свой закрытый ключ $kb$ к открытому ключу Алисы $Ka$:

$$
(x,y) = k_b \cdot K_a
$$


- Алиса и Боб получают одну и ту же точку на эллиптической кривой. Общим секретом будет координата $x$ этой точки.

На самом деле, они получают один и тот же общий секрет, потому что:

(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a

$$
Un attaccante che osserva la rete pubblica non protetta può ottenere solo le chiavi pubbliche di ciascuna parte e i parametri della curva ellittica scelta. Come precedentemente spiegato, queste informazioni da sole non sono sufficienti per determinare le chiavi private. Pertanto, l'attaccante non può trovare il segreto condiviso tra Alice e Bob.
ECDH è quindi un algoritmo che consente lo scambio di chiavi. È spesso utilizzato in combinazione con altri metodi crittografici per stabilire un protocollo completo. Ad esempio, ECDH è integrato nel nucleo di TLS (_Transport Layer Security_), un protocollo di crittografia e autenticazione utilizzato per il livello di trasporto di Internet. TLS utilizza ECDHE per lo scambio di chiavi, una variante di ECDH dove le chiavi sono effimere, per garantire la confidenzialità persistente. Inoltre, TLS utilizza algoritmi di autenticazione come ECDSA, algoritmi di crittografia come AES e funzioni hash come SHA256.
TLS è notevolmente responsabile della `s` in `https` così come del lucchetto visibile nella barra degli indirizzi del tuo browser, simboli delle comunicazioni criptate. Seguendo questo corso, stai quindi utilizzando ECDH, ed è molto probabile che lo usi quotidianamente senza nemmeno saperlo.
### La Transazione di Notifica
Come abbiamo visto nella sezione precedente, ECDH è una variante dello scambio Diffie-Hellman che utilizza coppie di chiavi stabilite su una curva ellittica. Convenientemente, possediamo già molte coppie di chiavi aderenti a questo standard nei nostri portafogli Bitcoin! L'idea di BIP47 è di utilizzare le coppie di chiavi dei portafogli Bitcoin gerarchici deterministici di entrambe le parti per stabilire segreti condivisi ed effimeri tra di loro. Nel contesto di BIP47, viene utilizzato ECDHE (_Elliptic Curve Diffie-Hellman Ephemeral_).
ECDHE viene utilizzato per la prima volta in BIP47 per trasmettere il codice di pagamento dal mittente al destinatario. Questo è il famoso **notification transaction**. Questo passaggio è essenziale perché affinché BIP47 funzioni efficacemente, entrambe le parti coinvolte (il mittente e il destinatario) devono conoscere il codice di pagamento dell'altro. Questa conoscenza consente la derivazione di chiavi pubbliche effimere e, di conseguenza, indirizzi di ricezione vuoti associati.
Prima di questo scambio, il mittente è logicamente già a conoscenza del codice di pagamento del destinatario poiché lo ha recuperato off-chain, ad esempio, dal loro sito web, una fattura o i loro social media. Tuttavia, il destinatario potrebbe non conoscere necessariamente il codice di pagamento del mittente. Eppure, questo codice deve essere trasmesso a loro; altrimenti, non saranno in grado di derivare le chiavi effimere necessarie per identificare gli indirizzi dove sono conservati i loro bitcoin, né accedere ai loro fondi. Sebbene questa trasmissione del codice del mittente possa tecnicamente essere effettuata off-chain attraverso altri mezzi di comunicazione, ciò pone un problema se il portafoglio deve essere recuperato solo dal seme.
Infatti, a differenza degli indirizzi convenzionali, gli indirizzi BIP47 non sono derivati direttamente dal seed del destinatario—utilizzare un `xpub` sarebbe più semplice in questo caso—ma risultano da un calcolo che combina i codici di pagamento di entrambi: quello del mittente e quello del destinatario. Pertanto, se il destinatario perde il proprio portafoglio e tenta di ripristinarlo dal proprio seed, recupererà il proprio codice di pagamento, che è derivato direttamente dal loro seed. Tuttavia, per trovare gli indirizzi effimeri, sarà essenziale per loro avere anche i codici di pagamento di tutti coloro che hanno inviato loro bitcoin tramite BIP47. Da qui l'importanza della transazione di notifica, che consente di salvare queste informazioni sulla blockchain di Bitcoin, pur essendo in grado di trovarle molto facilmente senza dover cercare tra il miliardo di transazioni eseguite dal suo lancio nel 2009.
![BTC204](assets/it/66/15.webp)
Pertanto, sarebbe possibile implementare BIP47 senza ricorrere alla transazione di notifica, a condizione che ogni utente conservi un backup dei codici di pagamento dei propri pari. Tuttavia, questo metodo si rivela complesso da gestire finché non viene sviluppata una soluzione semplice, robusta ed efficiente per creare, conservare e aggiornare questi backup. Nello stato attuale delle cose, la transazione di notifica diventa quasi indispensabile.
Nei capitoli seguenti, studieremo altri protocolli con obiettivi simili a quelli di BIP47, ma che non richiedono una transazione di notifica. Queste alternative, tuttavia, introducono i propri compromessi.
Oltre al suo ruolo nel backup dei codici di pagamento, la transazione di notifica serve anche una funzione di notifica per il destinatario, come suggerisce il suo nome. Segnala al client del destinatario che è stato stabilito un nuovo canale di pagamento e suggerisce quindi di monitorare gli indirizzi effimeri risultanti.
### Il Modello di Privacy di BIP47
Prima di dettagliare il funzionamento tecnico della transazione di notifica, è importante discutere il modello di privacy associato a BIP47, che giustifica alcune misure prese durante la creazione di questa transazione iniziale.
Il codice di pagamento, di per sé, non rappresenta un rischio diretto per la privacy. A differenza del modello Bitcoin tradizionale, che mira a rompere il collegamento tra l'identità di un utente e le sue transazioni (che sono pubbliche) preservando l'anonimato di chiavi e indirizzi, il codice di pagamento può essere apertamente associato a un'identità senza rappresentare una minaccia.
Infatti, il codice di pagamento non è utilizzato per derivare direttamente gli indirizzi che ricevono pagamenti BIP47. Questi indirizzi sono invece generati attraverso l'applicazione di ECDH tra le chiavi derivate dai codici di pagamento delle due parti coinvolte.
Così, un codice di pagamento di per sé non porta direttamente a una perdita di privacy, poiché solo l'indirizzo di notifica è derivato da esso. Sebbene questo indirizzo possa rivelare alcune informazioni, normalmente non consente di scoprire le parti con cui si stanno conducendo transazioni, a meno che non si effettui un'analisi approfondita della catena. Infatti, se il mittente utilizza UTXO che possono essere collegati alla loro identità per eseguire la transazione di notifica, allora diventa possibile dedurre che la loro identità è probabilmente collegata ai pagamenti BIP47 al tuo codice di pagamento. Questo non rivelerà le transazioni sottostanti, ma indicherà la loro probabile esistenza.
Pertanto, è essenziale mantenere questa stretta separazione tra i codici di pagamento degli utenti. Verso questo obiettivo, il passo iniziale di comunicazione del codice è un momento critico per la privacy del pagamento, ma obbligatorio per il corretto funzionamento del protocollo. Se uno dei codici di pagamento può essere ottenuto pubblicamente (come su un sito web), il secondo codice, quello del mittente, non deve essere collegato al primo in nessun caso.
Prendiamo un esempio concreto: voglio fare una donazione a un movimento politico tramite BIP47:
- L'organizzazione ha reso pubblico il suo codice di pagamento sul suo sito web o tramite i suoi social network;
- Questo codice è quindi collegato al movimento politico;
- Recupero questo codice di pagamento;
- Prima di procedere con un invio, devo assicurarmi che conoscano il mio codice di pagamento, che è anche collegato alla mia identità poiché lo uso per ricevere transazioni sui miei social network.
Come trasmettere il mio codice senza rischi? L'uso di mezzi di comunicazione convenzionali potrebbe portare a una fuga di informazioni e, di conseguenza, associarmi a questo movimento politico. La transazione di notifica offre una soluzione grazie a uno strato di crittografia che impedisce precisamente questa associazione tra due codici. Sebbene questo non sia l'unico metodo per trasmettere segretamente il codice di pagamento del mittente, si dimostra molto efficace.
Nel diagramma sottostante, le linee arancioni indicano i punti in cui il flusso di informazioni deve essere interrotto, e le frecce nere mostrano le connessioni che potrebbero potenzialmente essere osservate da terze parti:
![BTC204](assets/it/66/16.webp)
In realtà, all'interno del modello tradizionale di privacy di Bitcoin, è spesso complesso dissociare completamente il flusso di informazioni tra la coppia di chiavi e l'utente, specialmente durante le transazioni a distanza. Ad esempio, nel contesto di una campagna di donazione, il destinatario deve inevitabilmente divulgare un indirizzo o una chiave pubblica tramite il loro sito web o social network. L'uso corretto di BIP47, in particolare con la transazione di notifica, permette di aggirare questo problema grazie a ECDHE e allo strato di crittografia che studieremo ulteriormente.
Ovviamente, il modello classico di privacy di Bitcoin si applica ancora alle chiavi pubbliche effimere, che sono derivate dalla combinazione dei due codici di pagamento. I due modelli sono in realtà complementari. Quello che voglio evidenziare qui è che, contrariamente all'uso abituale di una chiave pubblica per ricevere bitcoin, il codice di pagamento può essere collegato a una specifica identità, perché l'informazione "_Alice effettua una transazione con Bob_" viene interrotta in un'altra fase. Il codice di pagamento viene utilizzato per generare indirizzi di pagamento, ma basandosi unicamente sull'osservazione della blockchain, è impossibile collegare una transazione di pagamento BIP47 ai codici di pagamento utilizzati per eseguirla, a meno che gli UTXO coinvolti non fossero già collegati a un'identità precedentemente e gli utenti non abbiano associato i loro codici di pagamento alle rispettive identità.
Per riassumere, il modello di privacy offerto dai pagamenti BIP47 potrebbe essere considerato superiore a quello della base di Bitcoin, anche se non è magico in alcun modo.
### Costruzione della Transazione di Notifica
Ora, vediamo come funziona questa transazione di notifica. Immaginiamo che Alice voglia inviare fondi a Bob con BIP47. Nel mio esempio, Alice agisce come mittente e Bob come destinatario. Quest'ultimo ha pubblicato il suo codice di pagamento sul suo sito web. Pertanto, Alice è già a conoscenza del codice di pagamento di Bob.
**1- Alice calcola un segreto condiviso con ECDH:**
- Seleziona una coppia di chiavi dal suo portafoglio HD situato su un ramo diverso dal suo codice di pagamento. Nota, questa coppia non dovrebbe essere facilmente associata all'indirizzo di notifica di Alice, né all'identità di Alice (vedi sezione precedente);
- Alice seleziona la chiave privata da questa coppia. La chiamiamo $a$ (minuscolo);
$$

a

$$
```text
- Alice recupera la chiave pubblica associata all'indirizzo di notifica di Bob. Questa chiave è la prima figlia derivata dal codice di pagamento di Bob (indice $/0$). Chiamiamo questa chiave pubblica $B$ (maiuscolo). La chiave privata associata a questa chiave pubblica è chiamata $b$ (minuscolo). $B$ è determinata dall'addizione e dal raddoppio dei punti sulla curva ellittica da $G$ (il punto generatore) con $b$ (la chiave privata):
$$ B = b \cdot G $$
- Alice calcola un punto segreto $S$ (maiuscolo) sulla curva ellittica tramite l'addizione e il raddoppio dei punti applicando la sua chiave privata $a$ dalla chiave pubblica di Bob $B$.
$$ S = a \cdot B $$
- Alice calcola il fattore di oscuramento $f$ che le permetterà di criptare il suo codice di pagamento. Per fare ciò, determinerà un numero pseudo-casuale con la funzione HMAC-SHA512. Nel secondo input di questa funzione, utilizza un valore che solo Bob potrà recuperare: $x$ che è l'ascissa del punto segreto precedentemente calcolato. Il primo input è $o$ che è l'UTXO consumato in input di questa transazione (outpoint).
$$ f = \text{HMAC-SHA512}(o, x) $$
**2- Alice converte il suo codice di pagamento personale in base 2 (binario).**
**3- Utilizza questo fattore di oscuramento come chiave per eseguire la crittografia simmetrica sul payload del suo codice di pagamento.** L'algoritmo di crittografia utilizzato è semplicemente un `XOR`. L'operazione eseguita è paragonabile alla cifratura di Vernam, anche denominata "One-Time Pad".
- Alice prima divide il suo fattore di oscuramento in due: i primi 32 byte sono denominati $f1$ e gli ultimi 32 byte sono denominati $f2$. Quindi, abbiamo:
$$ f = f1 || f2 $$
- Alice calcola l'$x'$ criptato dell'ascissa della chiave pubblica $x$ del suo codice di pagamento, e il $c'$ criptato del suo codice catena $c$ separatamente. $f1$ e $f2$ agiscono rispettivamente come chiavi di crittografia. L'operazione utilizzata è il `XOR` (o esclusivo).
$$ x' = x \oplus f1 $$
$$ c' = c \oplus f2 $$
- Alice sostituisce i valori reali dell'ascissa della chiave pubblica $x$ e del codice catena $c$ nel suo codice di pagamento con i valori criptati $x'$ e $c'$.
**4-** Alice ora ha il suo codice di pagamento con un payload criptato. Costruirà e trasmetterà una transazione che coinvolge la sua chiave pubblica $A$ come input, un output all'indirizzo di notifica di Bob, e un output `OP_RETURN` contenente il suo codice di pagamento con il payload criptato. **Questa transazione è la transazione di notifica**.
Un `OP_RETURN` è un opcode che segna un output di una transazione Bitcoin come non valido. Oggi, è utilizzato per trasmettere o ancorare informazioni sulla blockchain di Bitcoin. Fino a 80 byte di dati possono essere memorizzati, che sono scritti sulla catena e quindi visibili a tutti gli altri utenti.
Come abbiamo visto nelle sezioni precedenti, ECDH è utilizzato per generare un segreto condiviso tra due utenti che comunicano su una rete non sicura, potenzialmente osservata da attaccanti. In BIP47, ECDH è utilizzato per la comunicazione sulla rete Bitcoin, che per sua natura è una rete di comunicazione trasparente osservata da molti attaccanti. Il segreto condiviso calcolato tramite lo scambio di chiavi ECDH è poi utilizzato per criptare le informazioni segrete da trasmettere: il codice di pagamento del mittente (di Alice).
Ricapitoliamo i passaggi che abbiamo appena esaminato insieme per eseguire una transazione di notifica:
- Alice recupera il codice di pagamento e l'indirizzo di notifica di Bob;
- Alice seleziona un UTXO che possiede nel suo portafoglio HD con la corrispondente coppia di chiavi;
- Calcola un punto segreto sulla curva ellittica utilizzando ECDH;
- Utilizza questo punto segreto per calcolare un HMAC, che è il fattore di oscuramento;
- Utilizza questo fattore di oscuramento per criptare il payload del suo codice di pagamento personale.
- Lei utilizza un output di transazione `OP_RETURN` per comunicare il codice di pagamento mascherato a Bob.
![BTC204](assets/it/66/17.webp)
### Transazione di Notifica: Studio Concreto
Per comprendere meglio il suo funzionamento, in particolare l'uso di `OP_RETURN`, esaminiamo insieme una vera transazione di notifica. Ho eseguito tale transazione sulla testnet, che potete trovare [cliccando qui](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e).
![BTC204](assets/fr/227.webp)
Osservando questa transazione, possiamo vedere che ha un singolo input e 4 output:
- Il primo output è l'`OP_RETURN` che contiene il mio codice di pagamento mascherato;
- Il secondo output di 546 sats punta all'indirizzo di notifica del mio destinatario;
- Il terzo output di 15.000 sats rappresenta le commissioni di servizio, poiché ho utilizzato Samourai Wallet per costruire questa transazione;
- Il quarto output di 2 milioni di sats rappresenta il resto, ovvero la differenza rimanente dal mio input che ritorna a un altro indirizzo che mi appartiene.
Il più interessante da studiare è ovviamente l'output 0 che utilizza l'`OP_RETURN`. Vediamo più da vicino cosa contiene. Ecco lo `scriptPubKey` in esadecimale:
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

```text
In questo script, possiamo sezionare diverse parti. Prima di tutto, gli opcode:
6a4c
```

```text
Tra gli opcode, possiamo riconoscere `0x6a` che designa l'`OP_RETURN` e `0x4c` che designa l'`OP_PUSHDATA1`.
Il byte seguente questo ultimo opcode indica la dimensione del payload che segue. Indica `0x50`, ovvero 80 byte:
6a4c50
```

```text
Poi, abbiamo i metadati del mio codice di pagamento in chiaro:
010002
```

```text
La coordinata x criptata della chiave pubblica del mio codice di pagamento:
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

```text
Il codice catena criptato del mio codice di pagamento:
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

```text
E infine, il padding per raggiungere 80 byte, la dimensione standard di un `OP_RETURN`:
00000000000000000000000000
```

```
Per capire meglio, ecco il mio codice di pagamento in chiaro in base 58:
````text
PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU
Quando si confronta il mio codice di pagamento in chiaro con l'`OP_RETURN`, è evidente che l'HRP (`0x47`) e il checksum (`0x8604e4db`) non vengono trasmessi. Questo è previsto, poiché queste informazioni sono destinate agli esseri umani.
Successivamente, possiamo identificare la versione (`0x01`), il campo di bit (`0x00`) e la parità della chiave pubblica (`0x02`). E, alla fine del codice di pagamento, i byte vuoti (`0x00000000000000000000000000`) sono utilizzati per riempire il codice fino a un totale di 80 byte. Tutti questi metadati vengono trasmessi in chiaro (non criptati).
Infine, si può osservare che la coordinata x della chiave pubblica (`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`) e il codice catena (`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`) sono stati criptati. Questo costituisce il payload del codice di pagamento.
### Cos'è XOR?
Nelle sezioni precedenti, abbiamo visto che il codice di pagamento è stato trasmesso criptato utilizzando l'operazione XOR. Prendiamoci un momento per capire come funziona questo operatore, poiché è ampiamente utilizzato nella crittografia.
XOR è un operatore logico bit a bit basato sull'algebra booleana. Con due operandi bit, restituisce `1` se i bit dello stesso rango sono diversi, e restituisce `0` se i bit dello stesso rango sono uguali. Ecco la tabella di verità di XOR basata sui valori degli operandi `D` e `E`:
| D   | E   | D XOR E |
| --- | --- | ------- |
| 0   | 0   | 0       |
| 0   | 1   | 1       |
| 1   | 0   | 1       |
| 1   | 1   | 0       |
Per esempio:
$$

$$
0110 \oplus 1110 = 1000
Oppure:
$$

$$
010011 \oplus 110110 = 100101
Con ECDH, l'uso di XOR come strato di crittografia è particolarmente adatto. Innanzitutto, a causa di questo operatore, la crittografia è simmetrica. Questo consente al destinatario di decifrare il codice di pagamento con la stessa chiave utilizzata per la crittografia. La chiave di crittografia e decrittografia viene calcolata dal segreto condiviso grazie a ECDH. Questa simmetria è resa possibile dalle proprietà commutativa e associativa dell'operatore XOR:
- Altre proprietà:
$$

$$
D \oplus D = 0
D ⊕ 0 = D
- Commutatività:
$$

$$
D \oplus E = E \oplus D
- Associatività:
$$

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
Se:
$$

$$
D \oplus E = L
Allora:
$$

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
Successivamente, questo metodo di cifratura assomiglia molto al cifrario di Vernam (One-Time Pad), l'unico algoritmo di cifratura conosciuto fino ad oggi che possiede sicurezza incondizionata (o assoluta). Affinché il cifrario di Vernam abbia questa caratteristica, la chiave di cifratura deve essere perfettamente casuale, deve essere della stessa dimensione del messaggio e deve essere utilizzata una sola volta. Nel metodo di cifratura utilizzato qui per BIP47, la chiave è effettivamente della stessa dimensione del messaggio, il fattore di offuscamento è esattamente della stessa dimensione della concatenazione della coordinata x della chiave pubblica con il codice catena del codice di pagamento. Questa chiave di cifratura è effettivamente utilizzata una sola volta. Tuttavia, questa chiave non è il risultato di una casualità perfetta poiché è un HMAC. È piuttosto pseudo-casuale. Pertanto, non si tratta di un cifrario di Vernam, ma il metodo è simile.
### Ricezione della Transazione di Notifica
Ora che Alice ha inviato la transazione di notifica a Bob, vediamo come lui la interpreta. Come promemoria, Bob deve essere in grado di accedere al codice di pagamento di Alice. Senza queste informazioni, come vedremo nella sezione seguente, non sarà in grado di derivare le coppie di chiavi create da Alice e, quindi, non sarà in grado di accedere ai suoi bitcoin ricevuti tramite BIP47. Per ora, il payload del codice di pagamento di Alice è criptato. Vediamo come Bob lo decifra.
**1-** Bob monitora le transazioni che creano output con il suo indirizzo di notifica.
**2-** Quando una transazione ha un output sul suo indirizzo di notifica, Bob la analizza per vedere se contiene un output OP_RETURN che segue lo standard BIP47.
**3-** Se il primo byte del payload OP_RETURN è `0x01`, Bob inizia la sua ricerca di un possibile segreto condiviso con ECDH:
- Bob seleziona la chiave pubblica nell'input della transazione. Ovvero, la chiave pubblica di Alice denominata $A$ con:
$$ A = a \cdot G $$
- Bob seleziona la chiave privata $b$ associata al suo indirizzo di notifica personale:
$$ b $$
- Bob calcola il punto segreto $S$ (segreto condiviso ECDH) sulla curva ellittica sommando e raddoppiando i punti, applicando la sua chiave privata $b$ alla chiave pubblica di Alice $A$:
$$ S = b \cdot A $$
- Bob determina il fattore di offuscamento $f$ che gli permetterà di decifrare il payload del codice di pagamento di Alice. Nello stesso modo in cui Alice aveva precedentemente calcolato, Bob troverà $f$ applicando HMAC-SHA512 su $x$ la coordinata x del punto segreto $S$, e su $o$ l'UTXO consumato come input in questa transazione di notifica:
$$ f = \text{HMAC-SHA512}(o, x) $$
**4-** Bob interpreta i dati nell'OP_RETURN della transazione di notifica come un codice di pagamento. Egli semplicemente decifra il payload di questo potenziale codice di pagamento usando il fattore di offuscamento $f$:
- Bob divide il fattore di offuscamento $f$ in 2 parti: i primi 32 byte di $f$ saranno $f1$ e gli ultimi 32 byte saranno $f2$;
- Bob decifra la coordinata x cifrata $x'$ della chiave pubblica dal codice di pagamento di Alice:
$$ x = x' \oplus f1 $$
- Bob decifra il valore del codice catena cifrato $c'$ dal codice di pagamento di Alice:
$$ c = c' \oplus f2 $$
**5-** Bob verifica se il valore della chiave pubblica dal codice di pagamento di Alice è effettivamente parte del gruppo secp256k1. Se è così, lo interpreta come un codice di pagamento valido. Altrimenti, ignora questa transazione.
Ora che Bob è a conoscenza del codice di pagamento di Alice, lei può inviargli fino a `2^32` pagamenti, senza mai dover effettuare un'altra transazione di notifica di questo tipo.
Perché funziona? Come fa Bob a determinare lo stesso fattore di offuscamento di Alice, e quindi a decifrare il suo codice di pagamento? Esaminiamo più da vicino il ruolo di ECDH in quello che abbiamo appena descritto.
Prima di tutto, stiamo trattando con la crittografia simmetrica. Questo significa che la chiave di cifratura e la chiave di decifratura sono lo stesso valore. Questa chiave nella transazione di notifica è il fattore di offuscamento:
$$ f = f1 || f2 $$
Pertanto, Alice e Bob devono ottenere lo stesso valore per $f$, senza trasmetterlo direttamente poiché un attaccante potrebbe rubarlo e decifrare le informazioni segrete. Questo fattore di offuscamento si ottiene applicando HMAC-SHA512 su 2 valori:
- la coordinata x di un punto segreto;
- e l'UTXO consumato come input nella transazione.
Bob, quindi, ha bisogno di queste due informazioni per decifrare il payload del codice di pagamento di Alice. Per l'UTXO come input, Bob può semplicemente recuperarlo osservando la transazione di notifica. Per il punto segreto, Bob dovrà usare ECDH. Come visto nella sezione precedente su Diffie-Hellman, semplicemente scambiando le rispettive chiavi pubbliche e applicando segretamente le proprie chiavi private alla chiave pubblica dell'altro, Alice e Bob possono trovare un punto specifico e segreto sulla curva ellittica. La transazione di notifica si basa su questo meccanismo:
- Coppia di chiavi di Bob:
$$ B = b \cdot G $$
- Coppia di chiavi di Alice:
$$ A = a \cdot G $$
- Per un segreto $S (x, y)$:
$$ S = a \cdot B = a \cdot (b \cdot G) = (b \cdot a) \cdot G = b \cdot A $$
Ora che Bob conosce il codice di pagamento di Alice, sarà in grado di rilevare i suoi pagamenti BIP47, e può derivare le chiavi private che bloccano i bitcoin ricevuti.
Ricapitoliamo i passaggi che abbiamo appena esaminato per ricevere e interpretare una transazione di notifica:
- Bob monitora gli output delle transazioni al suo indirizzo di notifica;
- Quando ne rileva uno, recupera le informazioni contenute nell'OP_RETURN;
- Bob seleziona la chiave pubblica in input e calcola un punto segreto usando ECDH;
- Usa questo punto segreto per calcolare un HMAC che è il fattore di offuscamento;
- Usa questo fattore di offuscamento per decifrare il payload del codice di pagamento di Alice contenuto nell'OP_RETURN.
### La Transazione di Pagamento BIP47
Studiamo ora insieme il processo di pagamento con BIP47. Per ricordarvi lo stato attuale delle cose:
- Alice conosce il codice di pagamento di Bob, che ha semplicemente recuperato dal suo sito web;
- Bob conosce il codice di pagamento di Alice grazie alla transazione di notifica;
- Alice effettuerà un primo pagamento a Bob. Potrà effettuarne molti altri allo stesso modo.
Prima di spiegare questo processo, penso sia importante ricordare gli indici su cui stiamo attualmente lavorando. Il percorso di derivazione di un codice di pagamento è descritto come segue: `m/47'/0'/0'`. La profondità successiva distribuisce gli indici in questo modo:
- La prima coppia di chiavi figlio normali (non rinforzate) è quella utilizzata per generare l'indirizzo di notifica di cui abbiamo parlato nella parte precedente: `m/47'/0'/0'/0`;
- Le coppie di chiavi figlio normali sono utilizzate all'interno di ECDH per generare indirizzi di ricezione dei pagamenti BIP47 come vedremo in questa sezione: da `m/47'/0'/0'/0` a `m/47'/0'/0'/2 147 483 647`;
- Le coppie di chiavi figlio rinforzate sono codici di pagamento effimeri: da `m/47'/0'/0'/0'` a `m/47'/0'/0'/2 147 483 647'`.
Ogni volta che Alice desidera inviare un pagamento a Bob, deriva un nuovo indirizzo vergine unico, grazie ancora al protocollo ECDH:
- Alice seleziona la prima chiave privata derivata dal suo codice di pagamento personale riutilizzabile:
$$ a $$
- Alice seleziona la prima chiave pubblica inutilizzata derivata dal codice di pagamento di Bob. Questa chiave pubblica, la chiameremo $B$. È associata alla chiave privata $b$ che solo Bob conosce:
$$ B = b \cdot G $$
- Alice calcola un punto segreto $S$ sulla curva ellittica tramite addizione e raddoppio di punti applicando la sua chiave privata $a$ alla chiave pubblica $B$ di Bob:
$$ S = a \cdot B $$
- Da questo punto segreto, Alice calcolerà il segreto condiviso $s$ (minuscolo). Per fare ciò, seleziona la coordinata x del punto segreto $S$ denominata $Sx$, e passa questo valore attraverso la funzione hash SHA256:
$$ S = (Sx, Sy) $$
$$ s = \text{SHA256}(Sx) $$
- Alice utilizza questo segreto condiviso $s$ per calcolare un indirizzo Bitcoin di ricezione dei pagamenti. Inizialmente, verifica che $s$ sia contenuto nell'ordine della curva secp256k1. In caso contrario, incrementa l'indice della chiave pubblica di Bob per derivare un altro segreto condiviso;
- In secondo luogo, calcola una chiave pubblica $K0$ aggiungendo sulla curva ellittica i punti $B$ e $s·G$. In altre parole, Alice aggiunge la chiave pubblica derivata dal codice di pagamento di Bob $B$ con un altro punto calcolato sulla curva ellittica tramite addizione e raddoppio con il segreto condiviso $s$ dal punto generatore della curva secp256k1 $G$. Questo nuovo punto rappresenta una chiave pubblica, e lo chiamiamo $K0$:
$$ K0 = B + s \cdot G $$
- Con questa chiave pubblica $K0$, Alice può derivare un indirizzo vergine standard di ricezione (per esempio, SegWit V0 in bech32).
Una volta che Alice ha ottenuto l'indirizzo di ricezione di Bob $K0$, può eseguire una transazione Bitcoin in modo standard. Per fare ciò, seleziona un UTXO di sua proprietà, assicurato da una coppia di chiavi di un ramo diverso del suo portafoglio HD, e lo spende per soddisfare un output all'indirizzo di Bob $K0$. È importante notare che questo pagamento, una volta derivato l'indirizzo, segue un processo convenzionale e non dipende più dalle chiavi associate a BIP47.
Ricapitoliamo i passaggi che abbiamo appena eseguito insieme per inviare un pagamento BIP47:
- Alice seleziona la prima chiave privata derivata dal suo codice di pagamento personale;
- Calcola un punto segreto sulla curva ellittica utilizzando ECDH dalla prima chiave pubblica derivata non utilizzata dal codice di pagamento di Bob;
- Utilizza questo punto segreto per calcolare un segreto condiviso con SHA256;
- Utilizza questo segreto condiviso per calcolare un nuovo punto segreto sulla curva ellittica;
- Aggiunge questo nuovo punto segreto alla chiave pubblica di Bob;
- Ottiene una nuova chiave pubblica effimera per la quale solo Bob ha la chiave privata associata;
- Alice può effettuare una transazione standard a Bob con l'indirizzo di ricezione effimero derivato.
![BTC204](assets/it/66/21.webp)
Se Alice desidera effettuare un secondo pagamento, seguirà gli stessi passaggi di prima, eccetto che questa volta selezionerà la seconda chiave pubblica derivata dal codice di pagamento di Bob. Specificamente, utilizzerà la prossima chiave non utilizzata. Otterrà così un nuovo indirizzo di ricezione appartenente a Bob, designato $K1$:
![BTC204](assets/it/66/22.webp)
Può continuare in questo modo e derivare fino a `2^32` indirizzi non utilizzati appartenenti a Bob.
Da un punto di vista esterno, osservando la blockchain, è teoricamente impossibile differenziare un pagamento BIP47 da un pagamento standard. Ecco un esempio di transazione di pagamento BIP47 sul Testnet:
```

94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
````
Questo sembra una transazione standard con un input consumato, un output di pagamento e un resto:
![BTC204](assets/fr/232.webp)
### Ricevere il Pagamento BIP47 e Derivare la Chiave Privata
Alice ha appena effettuato il suo primo pagamento a un nuovo indirizzo BIP47 appartenente a Bob. Ora vediamo come Bob riceve questo pagamento. Vedremo anche perché Alice non ha accesso alla chiave privata dell'indirizzo che ha appena generato da sola, e come Bob recupera questa chiave per spendere i bitcoin che ha appena ricevuto.
Non appena Bob riceve la transazione di notifica da Alice, deriva la chiave pubblica BIP47 $K0$ anche prima che lei abbia inviato qualsiasi pagamento. Poi monitora qualsiasi pagamento all'indirizzo associato. Infatti, deriva immediatamente diversi indirizzi che monitorerà ($K0$, $K1$, $K2$, $K3$...). Ecco come deriva questa chiave pubblica $K0$:
- Bob seleziona la prima chiave privata derivata dal suo codice di pagamento. Questa chiave privata è denominata $b$. È associata alla chiave pubblica $B$ con cui Alice aveva fatto i suoi calcoli nel passaggio precedente:
$$ b $$
- Bob seleziona la prima chiave pubblica di Alice derivata dal suo codice di pagamento. Questa chiave è denominata $A$. È associata alla chiave privata $a$ con cui Alice aveva fatto i suoi calcoli, e di cui solo Alice è a conoscenza. Bob può eseguire questo processo poiché è a conoscenza del codice di pagamento di Alice che le è stato trasmesso con la transazione di notifica:
$$ A = a \cdot G $$
- Bob calcola il punto segreto $S$, mediante addizione e raddoppio di punti sulla curva ellittica, applicando la sua chiave privata $b$ alla chiave pubblica di Alice $A$. Qui troviamo l'uso di ECDH che garantisce che questo punto $S$ sarà lo stesso sia per Bob che per Alice:
$$ S = b \cdot A $$
- Proprio come ha fatto Alice, Bob isola la coordinata x di questo punto $S$. Abbiamo chiamato questo valore $Sx$. Egli passa questo valore attraverso la funzione SHA256 per trovare il segreto condiviso $s$ (minuscolo):
$$ s = \text{SHA256}(Sx) $$
- Proprio come Alice, Bob calcola il punto $s·G$ sulla curva ellittica. Poi, aggiunge questo punto segreto alla sua chiave pubblica $B$. Ottiene così un nuovo punto sulla curva ellittica che interpreta come una chiave pubblica $K0$:
$$ K0 = B + s \cdot G $$
Una volta che Bob ha questa chiave pubblica $K0$, può derivare la chiave privata associata per essere in grado di spendere i suoi bitcoin. È l'unico che può generare questa chiave privata:
- Bob aggiunge la sua chiave privata figlio $b$ derivata dal suo codice di pagamento personale. È l'unico che può ottenere il valore di $b$. Poi, aggiunge $b$ con il segreto condiviso $s$ per ottenere $k0$, la chiave privata di $K0$:
$$ k0 = b + s $$
Grazie alla legge di gruppo della curva ellittica, Bob ottiene esattamente la chiave privata corrispondente alla chiave pubblica usata da Alice. Abbiamo quindi:
$$ K0 = k0 \cdot G $$
Riassumerò i passaggi che abbiamo appena esaminato insieme per ricevere un pagamento BIP47 e calcolare la chiave privata corrispondente:
- Bob seleziona la prima chiave privata figlio derivata dal suo codice di pagamento personale;
- Calcola un punto segreto sulla curva ellittica usando ECDH dalla prima chiave pubblica figlio derivata dal codice catena di Alice;
- Usa questo punto segreto per calcolare un segreto condiviso con SHA256;
- Usa questo segreto condiviso per calcolare un nuovo punto segreto sulla curva ellittica;
- Aggiunge questo nuovo punto segreto alla sua chiave pubblica personale;
- Ottiene una nuova chiave pubblica effimera, alla quale Alice invierà il suo primo pagamento;
- Bob calcola la chiave privata associata a questa chiave pubblica effimera aggiungendo la sua chiave privata figlio derivata dal suo codice di pagamento e il segreto condiviso.
![BTC204](assets/it/66/24.webp)
Poiché Alice non può ottenere $b$ (la chiave privata di Bob), lei non è in grado di determinare $k0$ (la chiave privata associata all'indirizzo di ricezione BIP47 di Bob). Schematicamente, possiamo rappresentare il calcolo del segreto condiviso $S$ così:
![BTC204](assets/it/66/19.webp)
Una volta trovato il segreto condiviso con ECDH, Alice e Bob calcolano la chiave pubblica di pagamento BIP47 $K0$, e Bob calcola anche la chiave privata associata $k0$:
![BTC204](assets/it/66/25.webp)
### Rimborsare il Pagamento BIP47
Poiché Bob è a conoscenza del codice di pagamento riutilizzabile di Alice, ha già tutte le informazioni necessarie per inviarle un rimborso. Non avrà bisogno di contattare nuovamente Alice per chiedere informazioni. Dovrà semplicemente notificarla con una transazione di notifica, specialmente affinché lei possa recuperare i suoi indirizzi BIP47 con il suo seed, e poi potrà anche inviarle fino a `2^32` pagamenti.
La funzionalità di rimborso è specifica per BIP47 ed è uno dei suoi vantaggi rispetto ad altri metodi che studieremo nei prossimi capitoli, come i Pagamenti Silenziosi.
Bob può quindi rimborsare Alice nello stesso modo in cui lei gli ha inviato i pagamenti. I ruoli si invertono:
![BTC204](assets/it/66/26.webp)
_Un grande ringraziamento a [Fanis Michalakis](https://x.com/FanisMichalakis) per la sua revisione e preziosi consigli esperti sull'articolo che ha ispirato la scrittura di questo capitolo!_
https://planb.network/tutorials/privacy/on-chain/paynym-bip47-a492a70b-50eb-4f95-a766-bae2c5535093
## Pagamenti Silenziosi
<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>
Il BIP47 è stato criticato per la sua inefficienza sulla blockchain. Come spiegato nel capitolo precedente, richiede una transazione di notifica per ogni nuovo destinatario. Questo vincolo diventa trascurabile se si prevede di stabilire un canale di pagamento duraturo con questo destinatario. Infatti, una singola transazione di notifica apre la strada a un numero quasi infinito di pagamenti BIP47 successivi.
Tuttavia, in determinate situazioni, la transazione di notifica può rappresentare un ostacolo per l'utente. Prendiamo l'esempio di una donazione una tantum a un destinatario: con un indirizzo Bitcoin classico, una singola transazione è sufficiente per effettuare la donazione. Ma con il BIP47, sono necessarie due transazioni: una per la notifica e un'altra per il pagamento effettivo. Quando la domanda di spazio nel blocco è bassa e le commissioni di transazione sono minime, questo passaggio aggiuntivo generalmente non rappresenta un problema. Tuttavia, durante i periodi di congestione, le commissioni di transazione possono diventare esorbitanti per un singolo pagamento, potenzialmente raddoppiando il costo per l'utente rispetto a una transazione Bitcoin standard, il che può essere inaccettabile per l'utente.
Per situazioni in cui l'utente prevede di effettuare solo pochi pagamenti a un identificatore statico, sono state sviluppate altre soluzioni. Tra queste ci sono i Pagamenti Silenziosi, descritti nel [BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki). Questo protocollo consente l'uso di un identificatore statico per ricevere pagamenti senza generare riutilizzo dell'indirizzo e senza richiedere l'uso di transazioni di notifica. Esaminiamo come funziona questo protocollo.
---
_Per comprendere appieno questo capitolo, è essenziale essere familiari con il funzionamento di ECDH (Elliptic Curve Diffie-Hellman) e la derivazione delle chiavi crittografiche in un portafoglio HD. Questi concetti sono stati dettagliati nel capitolo precedente sul BIP47. Non li ripeterò qui. Se non sei ancora familiare con queste nozioni, ti consiglio di consultare il capitolo precedente prima di continuare con questo. Non riprenderò nemmeno i rischi associati al riutilizzo degli indirizzi di ricezione, né l'importanza di avere un identificatore unico per ricevere pagamenti._
---
### Perché non spostare la notifica?
Come discusso nel capitolo sul BIP47, la transazione di notifica svolge principalmente due funzioni:
- Notifica il destinatario;
- Trasmette il codice di pagamento del mittente.
Si potrebbe ingenuamente pensare che questo processo di notifica potrebbe essere effettuato off-chain. In teoria, ciò è completamente fattibile: sarebbe sufficiente per il destinatario indicare un mezzo di comunicazione per ricevere i codici di pagamento BIP47 dai mittenti. Tuttavia, questo approccio presenta due problemi principali:
- Primo, ciò sposterebbe il processo di trasmissione del codice su un altro protocollo di comunicazione. Le questioni relative ai costi e alla privacy dello scambio rimarrebbero, ma sarebbero semplicemente trasferite a questo nuovo protocollo. In termini di privacy, ciò potrebbe anche creare un collegamento tra l'identità di un utente e l'attività sulla blockchain, cosa che cerchiamo di evitare eseguendo la notifica direttamente sulla blockchain. Inoltre, effettuare la notifica fuori dalla blockchain introdurrebbe rischi di censura (come il blocco dei fondi) che non esistono su Bitcoin;
Successivamente, ciò porrebbe un problema di recupero. Con BIP47, il destinatario deve assolutamente conoscere i codici di pagamento dei mittenti per accedere ai fondi. Questo è vero al momento della ricezione, ma anche in caso di recupero dei fondi tramite il seed in caso di perdita del portafoglio. Con le notifiche onchain, questo rischio viene evitato, poiché l'utente può trovare e decifrare le transazioni di notifica semplicemente conoscendo il proprio seed. Tuttavia, se la notifica viene eseguita fuori dalla blockchain, l'utente dovrebbe mantenere un backup dinamico di tutti i codici di pagamento ricevuti, il che è impraticabile per l'utente medio.
Tutti questi vincoli rendono l'uso della notifica onchain indispensabile nel contesto di BIP47. Eppure, i Pagamenti Silenziosi cercano specificamente di evitare questo passaggio di notifica onchain a causa del suo costo. Pertanto, la soluzione adottata non è spostare la notifica, ma eliminarla completamente. Per raggiungere questo obiettivo, deve essere accettato un compromesso: quello della scansione. A differenza di BIP47, dove l'utente sa esattamente dove trovare i propri fondi grazie alle transazioni di notifica, nel contesto dei Pagamenti Silenziosi, l'utente deve esaminare tutte le transazioni Bitcoin esistenti per rilevare eventuali pagamenti che potrebbero essere destinati a loro. Per ridurre questo onere operativo, la ricerca di Pagamenti Silenziosi è limitata solo alle transazioni che probabilmente contengono tali pagamenti, ovvero quelle che includono almeno un output Taproot P2TR. La scansione si concentra esclusivamente anche sulle transazioni dalla data di creazione del portafoglio (non c'è bisogno di scandire transazioni risalenti al 2009 se il portafoglio è stato creato nel 2024).
Pertanto, potete vedere perché BIP47 e Pagamenti Silenziosi, sebbene mirino a un obiettivo simile, comportano compromessi diversi e **quindi si rivolgono effettivamente a casi d'uso distinti**. Per i pagamenti una tantum, come le donazioni occasionali, i Pagamenti Silenziosi sono più appropriati a causa del loro costo inferiore. Al contrario, per le transazioni regolari allo stesso destinatario, come nel caso delle piattaforme di scambio o dei pool di mining, BIP47 potrebbe essere preferito.
Esploriamo insieme il funzionamento tecnico dei Pagamenti Silenziosi per capirne meglio le implicazioni. Per fare ciò, suggerisco di adottare lo stesso approccio del documento esplicativo di BIP352. Scomporremo gradualmente i calcoli da eseguire, elemento per elemento, giustificando ogni nuova aggiunta.
### Alcuni concetti da comprendere
Prima di iniziare, è importante chiarire che i Pagamenti Silenziosi si basano esclusivamente sull'uso di tipi di script P2TR (_Pay to Taproot_). A differenza di BIP47, non è necessario derivare gli indirizzi di ricezione dalle chiavi pubbliche figlie tramite hashing. Infatti, nello standard P2TR, la chiave pubblica modificata viene utilizzata direttamente e apertamente nell'indirizzo. Così, un indirizzo di ricezione Taproot è essenzialmente una chiave pubblica accompagnata da alcuni metadati. Questa chiave pubblica modificata è l'aggregazione di altre due chiavi pubbliche: una che consente la spesa diretta e tradizionale tramite una semplice firma, e l'altra che rappresenta la radice di Merkle del MAST, che autorizza la spesa soggetta alla soddisfazione di una delle condizioni potenzialmente iscritte nell'albero di Merkle.
![BTC204](assets/it/67/01.webp)
La decisione di limitare i Pagamenti Silenziosi esclusivamente a Taproot è motivata da due ragioni principali:
- Primo, facilita significativamente l'implementazione e gli aggiornamenti futuri nel software del portafoglio, poiché è necessario aderire a un solo standard;
- In secondo luogo, questo approccio aiuta a migliorare l'insieme di anonimato degli utenti incoraggiandoli a non disperdersi tra diversi tipi di script, che generano impronte di portafoglio distinte nell'analisi della catena (per maggiori informazioni su questo concetto, vi invito a consultare il capitolo 4 della parte 2).
### Derivazione naive di una chiave pubblica di Pagamenti Silenziosi
Iniziamo con un semplice esempio che ti aiuterà a comprendere il funzionamento di base dei Pagamenti Silenziosi (SP, Silent Payments). Prendiamo Alice e Bob, due utenti Bitcoin. Alice vuole inviare bitcoin a Bob su un nuovo indirizzo di ricezione. Tre obiettivi devono essere raggiunti in questo processo:
- Alice deve essere in grado di generare un nuovo indirizzo;
- Bob deve essere in grado di identificare un pagamento inviato a questo specifico indirizzo;
- Bob deve essere in grado di ottenere la chiave privata associata a questo indirizzo per poter spendere i suoi fondi.
Alice ha un UTXO nel suo portafoglio Bitcoin protetto con la seguente coppia di chiavi:
- $a$: la chiave privata;
- $A$: la chiave pubblica ($A = a \cdot G$)
Bob ha un indirizzo SP che ha pubblicato su internet con:
- $b$: la chiave privata;
- $B$: la chiave pubblica ($B = b \cdot G$)
Recuperando l'indirizzo di Bob, Alice è in grado di calcolare un nuovo indirizzo vuoto che appartiene a Bob usando ECDH. Chiamiamo questo indirizzo $P$:
$$ P = B + \text{hash}(a \cdot B) \cdot G $$
In questa equazione, Alice ha semplicemente calcolato il prodotto scalare della sua chiave privata $a$ e della chiave pubblica di Bob $B$. Ha passato questo risultato attraverso una funzione hash conosciuta da tutti. Il valore di output è poi moltiplicato scalarmente per il punto generatore $G$ della curva ellittica `secp256k1`. Infine, Alice aggiunge il punto ottenuto alla chiave pubblica di Bob $B$. Una volta che Alice ha questo indirizzo $P$, lo usa come output in una transazione, il che significa che invia bitcoin ad esso.
> _Nel contesto dei Pagamenti Silenziosi, la funzione "hash" corrisponde a una funzione hash SHA256 etichettata specificamente con `BIP0352/SharedSecret`, assicurando che gli hash generati siano unici per questo protocollo e non possano essere riutilizzati in altri contesti, fornendo anche una protezione aggiuntiva contro il riutilizzo di nonce nelle firme. Questo standard corrisponde a quello [specificato nel BIP340 per le firme Schnorr](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) su `secp256k1`._
Grazie alle proprietà della curva ellittica su cui si basa ECDH, sappiamo che:
$$ a \cdot B = b \cdot A $$
Bob sarà quindi in grado di calcolare l'indirizzo di ricezione su cui Alice ha inviato i bitcoin. Per fare ciò, monitora tutte le transazioni Bitcoin che soddisfano i criteri dei Pagamenti Silenziosi e applica il seguente calcolo a ciascuna di esse per vedere se il pagamento è indirizzato a lui (_scanning_):
$$ P' = B + \text{hash}(b \cdot A) \cdot G $$
Quando esamina la transazione di Alice, si rende conto che $P'$ è uguale a $P$. Sa quindi che questo pagamento è indirizzato a lui:
$$ P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P $$
Da qui, Bob sarà in grado di calcolare la chiave privata $p$ che consente di spendere l'indirizzo $P$:
$$ p = (b + \text{hash}(b \cdot A)) \bmod n $$
Come puoi vedere, per calcolare questa chiave privata $p$, è necessario avere la chiave privata $b$. Solo Bob ha questa chiave privata $b$. Sarà quindi effettivamente l'unico in grado di spendere i bitcoin inviati al suo indirizzo di Pagamenti Silenziosi.
![BTC204](assets/fr/236.webp)
_Didascalia:_
- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s$: Il segreto comune ECDH
- $P$: La chiave pubblica / indirizzo unico per il pagamento a Bob
Ecco un approccio inizialmente piuttosto ingenuo nell'uso dell'indirizzo statico di Bob, denotato $B$, per derivare un indirizzo unico $P$ per inviare bitcoin. Tuttavia, questo metodo è troppo semplicistico e presenta diversi difetti che necessitano di correzione. Il primo problema è che, in questo schema, Alice non può creare molteplici output per Bob all'interno della stessa transazione.
### Come creare molteplici output?
Nell'esempio della sezione precedente, Alice crea un singolo output che andrà a Bob al suo indirizzo unico $P$. Con lo stesso input selezionato, è impossibile per Alice creare due indirizzi vergini distinti per Bob, poiché il metodo utilizzato porterebbe sempre allo stesso risultato per $P$, quindi allo stesso indirizzo. Tuttavia, ci possono essere molte situazioni in cui Alice desidera dividere il suo pagamento a Bob in diverse piccole somme, creando così molteplici UTXO. È quindi necessario trovare un metodo che permetta di farlo.
Per raggiungere questo obiettivo, modificheremo leggermente il calcolo che Alice esegue per derivare $P$, in modo che possa generare due indirizzi distinti per Bob, ovvero $P_0$ e $P_1$.
Per modificare il calcolo e ottenere 2 indirizzi diversi, è sufficiente aggiungere un intero che modifica il risultato. Così, Alice aggiungerà $0$ nel suo calcolo per ottenere l'indirizzo $P_0$ e $1$ per ottenere l'indirizzo $P_1$. Chiamiamo questo intero $i$:
$$ P_i = B + \text{hash}(a \cdot B \text{ ‖ } i) \cdot G $$
Il processo di calcolo rimane invariato rispetto al metodo precedente, eccetto che questa volta Alice concatenerà $a \cdot B$ con $i$ prima di procedere al hash. È quindi sufficiente cambiare $i$ per avere un nuovo indirizzo appartenente a Bob. Ad esempio:
$$ P_0 = B + \text{hash}(a \cdot B \text{ ‖ } 0) \cdot G $$
$$ P_1 = B + \text{hash}(a \cdot B \text{ ‖ } 1) \cdot G $$
Quando Bob esamina la blockchain per i Pagamenti Silenziosi destinati a lui, inizia utilizzando $i = 0$ per l'indirizzo $P_0$. Se non trova nessun pagamento su $P_0$, conclude che questa transazione non contiene nessun Pagamento Silenzioso per lui e smette di analizzarla. Tuttavia, se $P_0$ è valido e contiene un pagamento per lui, procede con $P_1$ nella stessa transazione per verificare se Alice ha effettuato un secondo pagamento. Se $P_1$ risulta essere invalido, interrompe la sua ricerca per questa transazione; altrimenti, continua a testare valori successivi di $i$.
$$ P_1 = B + \text{hash}(b \cdot A \text{ ‖ } 1) \cdot G $$
Poiché Bob si ferma immediatamente a $i = 0$ se $P_0$ non produce risultati, l'uso di questo intero aggiunge quasi nessun onere operativo aggiuntivo a Bob per la fase di scansione delle transazioni.
Bob può quindi calcolare le chiavi private nello stesso modo:
$$

p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n

$$
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n
$$

дидаскалия:_


- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: Публичная микросхема UTXO Алисы, используемая в качестве входного сигнала для транзакции
- $a$: La chiave privata di Alice
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hash SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $s_1$: Il secondo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
- $P_1$: La seconda chiave pubblica / indirizzo unico per il pagamento a Bob

С помощью этого метода можно создать прекрасный протокол, но есть и другие недостатки, которые необходимо устранить, в частности, предотвратить использование индиризи.

### Как предотвратить использование индиризи?

Как мы уже видели в предыдущих сериях, Алиса использует копию чиави, которые защищают ее UTXO, и тратит ее на вычисление сегмента ECDH с Бобом. Это сегрето позволяет вывести единое число $P_0$. В то же время, копия чиави ($a$, $A$), используемая Алисой, может защитить больше UTXO, если она будет использовать этот индириццо несколько раз. В случае, когда Алиса совершила два платежа по статическому индексу $B$ Боба, используя два UTXO, защищающих один и тот же чип $A$, это будет означать, что Боб использовал свой индексированный код.

> _Il riutilizzo degli indirizzi è una pratica molto negativa per la privacy degli utenti. Чтобы понять, почему, советуем ознакомиться с первыми частями этой статьи
Infatti, poiché l'indirizzo unico $P_0$ è derivato da $A$ e $B$, se Alice deriva a secondo indirizzo per un secondo pagamento a $B$, con la stessa chiave $A$, finirà per ottenere lo stesso indirizzo $P_0$. Чтобы избежать этого риска и предотвратить использование индирицци во внутренней части пагаментов Silenziosi, мы должны модифицировать наши расчеты.

Мы хотим, чтобы каждый UTXO, потребляемый Алисой при вводе одного платежа, имел единый индириццо от лато ди Боба, даже если более UTXO будут защищены от одной копии чиави. È quindi sufficiente aggiungere un riferimento all'UTXO nel calcolo dell'indirizzo unico $P_0$. Questo riferimento sarà semplicemente l'hash dell'UTXO consumato come input:

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$

В этом случае Алиса может использовать входные данные для расчета единой индифферентности $P_0$:

Во время своего сканирования Боб может еще добавить $\text{inputHash}$, потому что все, что нужно сделать, это сохранить транзакцию для вывода $\text{outpoint}$:

$$ P_0 = B + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0) \cdot G $$

Если найдено одно действительное значение $P_0$, можно рассчитать соответствующее частное значение $p_0$:

$$
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
$$

```text
_Legenda:_
- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $H$: L'hash dell'UTXO usato come input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hash SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
Al momento, i nostri calcoli presuppongono che Alice utilizzi un singolo input per la sua transazione. Tuttavia, dovrebbe essere in grado di utilizzare più input. Di conseguenza, da parte di Bob, per ogni transazione contenente più input, teoricamente avrebbe bisogno di calcolare l'ECDH per ogni input per determinare se un pagamento è destinato a lui. Questo metodo non è soddisfacente, quindi abbiamo bisogno di trovare una soluzione per ridurre il carico di lavoro!
### Modificare le chiavi pubbliche negli input
Per risolvere questo problema, invece di utilizzare la coppia di chiavi che protegge un input specifico da parte di Alice, useremo la somma di tutte le coppie di chiavi utilizzate negli input della transazione. Questa somma sarà quindi considerata come una nuova coppia di chiavi. Questa tecnica è nota come "tweak".
Per esempio, immagina che la transazione di Alice abbia 3 input, ognuno protetto con una coppia di chiavi diversa:
- $a_0$ protegge l'input #0;
- $a_1$ protegge l'input #1;
- $a_2$ protegge l'input #2.
Seguendo il metodo descritto sopra, Alice dovrebbe scegliere una singola coppia di chiavi tra $a_0$, $a_1$ e $a_2$ per calcolare il segreto ECDH e generare l'indirizzo di pagamento unico $P$ dall'indirizzo statico $B$ di Bob. Tuttavia, questo approccio richiede a Bob di testare ogni possibilità sequenzialmente, partendo da $a_0$, poi $a_1$, e così via, fino all'identificazione di una coppia che genera un indirizzo valido $P$. Questo processo richiede che Bob esegua il calcolo ECDH su tutti gli input di tutte le transazioni, aumentando significativamente il carico di lavoro operativo di scansione.
Per evitare ciò, chiederemo ad Alice di eseguire il suo calcolo di $P$ utilizzando la somma di tutte le chiavi in input. Prendendo il nostro esempio, la chiave privata modificata $a$ sarebbe calcolata come segue:
$$ a = a_0 + a_1 + a_2 $$
Allo stesso modo, Alice e Bob saranno in grado di calcolare la chiave pubblica modificata:
$$ A = A_0 + A_1 + A_2 $$
Grazie a questo metodo, a Bob basta calcolare la somma delle chiavi pubbliche della transazione, poi calcolare il segreto ECDH da $A$ soltanto, il che riduce notevolmente il numero di calcoli da fare per la fase di scansione. Tuttavia, ricorda dalla sezione precedente. Avevamo incluso nel nostro calcolo l'hash $\text{inputHash}$ che viene usato come nonce per prevenire il riutilizzo degli indirizzi:
$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$
Ma se ci sono più input in una transazione, è necessario determinare quale $\text{outpoint}$ viene scelto in questo calcolo. Secondo il BIP352, il criterio di selezione per $\text{outpoint}$ da usare è scegliere il più piccolo lessicograficamente, il che significa selezionare l'UTXO che appare per primo in ordine alfabetico. Questo metodo standardizza l'UTXO da scegliere in ogni transazione. Ad esempio, se questo $\text{outpoint}$ più piccolo lessicograficamente è $\text{outpoint}_L$, il calcolo di $\text{inputHash}$ sarà:
$$ \text{inputHash} = \text{hash}(\text{outpoint}\_L \text{ ‖ } A) $$
I calcoli rimangono quindi identici a quelli presentati nella sezione precedente, eccetto che la chiave privata $a$ e la sua corrispondente chiave pubblica $A$ non rappresentano più una coppia che protegge un singolo input, ma ora rappresentano la modifica di tutte le coppie di chiavi negli input.
### Separare le Chiavi di Spesa e di Scansione
Finora, abbiamo discusso dell'indirizzo statico di Pagamento Silenzioso $B$ come di una chiave pubblica unica. Ricorda, è questa chiave pubblica $B$ che viene usata da Alice per creare il segreto condiviso ECDH, che a sua volta viene usato per calcolare l'indirizzo di pagamento unico $P$. Bob usa questa chiave pubblica $B$ e la corrispondente chiave privata $b$ per la fase di scansione. Ma userà anche la chiave privata $b$ per calcolare la chiave privata $p$ che consente di spendere dall'indirizzo $P$.
Lo svantaggio di questo metodo è che la chiave privata $b$, che viene usata per calcolare tutte le chiavi private per gli indirizzi che ricevono Pagamenti Silenziosi, viene anche usata da Bob per scansionare le transazioni. Questo passaggio richiede che la chiave $b$ sia disponibile su un software di portafoglio connesso a Internet, il che la espone a un rischio maggiore di furto rispetto al mantenerla su un portafoglio freddo. Idealmente, sarebbe vantaggioso poter approfittare dei Pagamenti Silenziosi mantenendo la chiave privata $b$, che controlla l'accesso a tutte le altre chiavi private, al sicuro su un portafoglio hardware. Fortunatamente, il protocollo è stato adattato per permettere esattamente questo.
Per raggiungere questo obiettivo, il BIP352 specifica che il ricevente usa 2 diverse coppie di chiavi:
- $B_{\text{spend}}$: per calcolare le chiavi private degli indirizzi di pagamento unici;
- $B_{\text{scan}}$: per trovare indirizzi di pagamento unici.
In questo modo, Bob può mantenere la chiave privata $b_{\text{spend}}$ su un portafoglio hardware e usare la chiave privata $b_{\text{scan}}$ su software online per trovare i suoi Pagamenti Silenziosi, senza rivelare $b_{\text{spend}}$. Tuttavia, le chiavi pubbliche $B_{\text{scan}}$ e $B_{\text{spend}}$ sono entrambe pubblicamente rivelate, poiché si trovano nell'indirizzo statico di Bob $B$:
Per calcolare un indirizzo di pagamento unico $P_0$ appartenente a Bob, Alice eseguirà il seguente calcolo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot a \cdot B\_{\text{scan}} \text{ ‖ } 0) \cdot G $$
Per trovare i pagamenti indirizzati a lui, Bob eseguirà il seguente calcolo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$
Come puoi vedere, fino a questo momento, Bob non ha avuto bisogno di usare $b_{\text{spend}}$ che si trova sul suo portafoglio hardware. Quando desidera spendere $P_0$, può quindi eseguire il seguente calcolo per trovare la chiave privata $p_0$:
$$ p*0 = (b*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$
_Didascalia:_
- $B_{\text{scan}}$: Chiave pubblica di scansione di Bob (indirizzo statico)
- $b_{\text{scan}}$: Chiave privata di scansione di Bob
- $B_{\text{spend}}$: Chiave pubblica di spesa di Bob (indirizzo statico)
- $b_{\text{spend}}$: Chiave privata di spesa di Bob
- $A$: La somma delle chiavi pubbliche in input (tweak)
- $a$: La chiave privata corrispondente alla chiave pubblica modificata
- $H$: L'hash dell'UTXO più piccolo (lessicograficamente) usato in input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo di pagamento unico per Bob
### Utilizzando indirizzi SP con un'etichetta
Bob ha quindi un indirizzo statico $B$ per i Pagamenti Silenziosi come segue:
$$ B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}} $$
Il problema con questo metodo è che non permette di segregare i diversi pagamenti inviati a questo indirizzo. Ad esempio, se Bob ha 2 clienti diversi per la sua attività e vuole differenziare chiaramente i pagamenti da ciascuno, avrebbe bisogno di 2 indirizzi statici diversi. Una soluzione ingenua, con l'approccio attuale, sarebbe che Bob crei due portafogli separati, ognuno con il proprio indirizzo statico, o addirittura stabilisca due indirizzi statici diversi all'interno dello stesso portafoglio. Tuttavia, questa soluzione richiede la scansione dell'intera blockchain due volte (una per ciascun indirizzo) per rilevare rispettivamente i pagamenti destinati a ciascun indirizzo. Questa doppia scansione aumenta in modo irragionevole l'onere operativo per Bob.
Per risolvere questo problema, BIP352 utilizza un sistema di etichettatura che consente di avere diversi indirizzi statici senza aumentare in modo irragionevole il carico di lavoro per trovare Pagamenti Silenziosi sulla blockchain. Per fare ciò, viene aggiunto un intero $m$ alla chiave pubblica di spesa $B_{\text{spend}}$. Questo intero può assumere il valore di $1$ per il primo indirizzo statico, poi $2$ per il secondo, e così via. Le chiavi di spesa $B_{\text{spend}}$ saranno d'ora in poi chiamate $B_m$ e saranno costruite in questo modo:
$$ B*m = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } m) \cdot G $$
Per esempio, per la prima chiave di spesa con l'etichetta $1$:
$$ B*1 = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } 1) \cdot G $$
L'indirizzo statico pubblicato da Bob consisterà ora di $B_{\text{scan}}$ e $B_m$. Per esempio, il primo indirizzo statico con l'etichetta $1$ sarà:
$$ B = B\_{\text{scan}} \text{ ‖ } B_1 $$
> _Iniziamo solo dall'etichetta 1 perché l'etichetta 0 è riservata per il resto._
Alice, da parte sua, deriverà l'indirizzo di pagamento unico $P$ nello stesso modo di prima, ma utilizzando il nuovo $B_1$ invece di $B_{\text{spend}}$.
$$ P*0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B*{\text{scan}} \text{ ‖ } 0) \cdot G $$
In realtà, Alice potrebbe non sapere nemmeno che Bob ha un indirizzo etichettato, poiché lei semplicemente utilizza la seconda parte dell'indirizzo statico che lui le ha fornito, che in questo caso, è il valore $B_1$ piuttosto che $B_{\text{spend}}$.
Per scansionare i pagamenti, Bob utilizzerà sempre il valore del suo indirizzo statico iniziale con $B_{\text{spend}}$ in questo modo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$
Poi, semplicemente sottrae il valore che trova per $P_0$ da ogni output uno per uno. Poi controlla se uno dei risultati di queste sottrazioni corrisponde al valore di una delle etichette che usa nel suo portafoglio. Se corrisponde, per esempio, per l'output #4 con l'etichetta $1$, ciò significa che questo output è un Pagamento Silenzioso associato al suo indirizzo statico etichettato $B_1$:
$$ Out*4 - P_0 = \text{hash}(b*{\text{scan}} \text{ ‖ } 1) \cdot G $$
Questo funziona perché:
$$ B*1 = B*{\text{spend}} + \text{hash}(b*{\text{scan}} \text{ ‖ } 1) \cdot G $$
Grazie a questo metodo, Bob può utilizzare una moltitudine di indirizzi statici ($B_1$, $B_2$, $B_3$...), tutti derivati dal suo indirizzo statico base ($B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}}$), al fine di separare correttamente gli usi.
Tuttavia, questa separazione degli indirizzi statici è valida solo da una prospettiva di gestione personale del portafoglio e non consente la separazione delle identità. Poiché tutti hanno lo stesso $B*{\text{scan}}$, è molto facile associare tutti gli indirizzi statici insieme e dedurre che appartengono a una singola entità.
_Didascalia:_
- $B_{\text{scan}}$: chiave pubblica di scansione di Bob (indirizzo statico)
- $b_{\text{scan}}$: chiave privata di scansione di Bob
- $B_{\text{spend}}$: chiave pubblica di spesa di Bob (indirizzo iniziale)
- $B_m$: chiave pubblica di spesa etichettata di Bob (indirizzo statico)
- $b_m$: chiave privata di spesa etichettata di Bob
- $A$: La somma delle chiavi pubbliche in input (tweak)
- $a$: La chiave privata corrispondente alla chiave pubblica modificata
- $H$: L'hash del più piccolo UTXO (lessicograficamente) utilizzato come input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
- $p_0$: La chiave privata del primo indirizzo di pagamento unico a Bob
- $X$: L'hash della chiave privata di scansione con l'etichetta
### Come Costruire un Indirizzo per Pagamenti Silenziosi?
Per costruire un indirizzo dedicato ai Pagamenti Silenziosi, è necessario prima derivare 2 coppie di chiavi nel proprio portafoglio Bitcoin HD:
- La coppia $b_{\text{scan}}$, $B_{\text{scan}}$ per cercare i pagamenti indirizzati a noi;
- La coppia $b_{\text{spend}}$, $B_{\text{spend}}$ per spendere i bitcoin che abbiamo ricevuto.
Queste coppie sono derivate seguendo questi percorsi (_Bitcoin Mainnet_):
scan: m / 352' / 0' / 0' / 1' / 0
spend: m / 352' / 0' / 0' / 0' / 0
```

```text
Una volta disponibili queste 2 coppie di chiavi, si concatenano semplicemente (una di seguito all'altra) per creare il payload dell'indirizzo statico:
$$ B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}} $$
Se si desidera utilizzare etichette, $B_{\text{spend}}$ viene sostituito con $B_m$:
$$ B = B\_{\text{scan}} \text{ ‖ } B_m $$
Con l'etichetta $m$:
$$ B*m = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } m) \cdot G $$
Una volta disponibile questo payload, si aggiunge la HRP (_Human-Readable Part_) `sp` e la versione `q` (= versione 0). Viene anche aggiunto un checksum, e l'indirizzo è formattato in bech32m.
Ad esempio, ecco il mio indirizzo statico per i Pagamenti Silenziosi:
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```