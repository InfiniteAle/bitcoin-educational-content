---
name: Privacidade na Bitcoin
goal: Compreender e dominar os princípios de proteção da privacidade ao utilizar a Bitcoin
objectives: 

  - Definir os conceitos teóricos necessários para compreender os desafios da proteção da privacidade
  - Saber como identificar e atenuar os riscos associados à perda de privacidade do utilizador na Bitcoin
  - Utilizar métodos e ferramentas para proteger a sua privacidade na Bitcoin
  - Compreender os métodos de análise da cadeia e desenvolver estratégias de defesa

---
# Proteger a sua privacidade na bitcoin

Num mundo em que a privacidade das transacções financeiras se está a tornar gradualmente um luxo, é essencial compreender e dominar os princípios da proteção da privacidade na sua utilização da Bitcoin. Esta formação fornece-lhe todas as chaves, tanto teóricas como práticas, para atingir este objetivo por si próprio.

Atualmente, na Bitcoin, existem empresas especializadas na análise de cadeias. A sua atividade principal consiste precisamente em invadir a sua privacidade para comprometer a confidencialidade das suas transacções. De facto, o "direito à privacidade" no Bitcoin não existe. Cabe-lhe a si, o utilizador, fazer valer os seus direitos naturais e proteger a confidencialidade das suas transacções, porque ninguém o fará por si.

Esta formação é apresentada como um curso completo e generalista. Cada noção técnica é pormenorizada e apoiada por diagramas explicativos. O objetivo é tornar o conhecimento acessível a todos. O BTC204 é, portanto, acessível aos utilizadores principiantes e intermédios. Esta formação também oferece um valor acrescentado aos bitcoiners mais experientes, uma vez que aprofundamos alguns conceitos técnicos frequentemente desconhecidos.

Junte-se a nós para transformar a sua utilização da Bitcoin e tornar-se um utilizador informado, capaz de compreender as questões relacionadas com a confidencialidade e proteger a sua privacidade.

+++
# Introdução

<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## Introdução à formação

<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

Num mundo em que a privacidade das transacções financeiras se está a tornar gradualmente um luxo, é essencial compreender e dominar os princípios da proteção da privacidade na sua utilização da Bitcoin. Esta formação fornece-lhe todas as chaves, tanto teóricas como práticas, para atingir este objetivo por si próprio.

Atualmente, no ecossistema Bitcoin, existem empresas especializadas na análise de blockchain. A sua atividade principal consiste precisamente em invadir a sua privacidade, comprometendo a confidencialidade das suas transacções. De facto, o "direito à privacidade" no Bitcoin não existe. Cabe-lhe a si, o utilizador, fazer valer os seus direitos naturais e proteger a confidencialidade das suas transacções, porque ninguém o fará por si.

A Bitcoin não existe apenas para "Number Go Up" e para a preservação do valor das poupanças. Devido às suas caraterísticas únicas e à sua história, é sobretudo a ferramenta da economia alternativa. Graças a esta notável invenção, pode gerir livremente o seu dinheiro, gastá-lo e acumulá-lo, sem que ninguém o possa impedir.

Bitcoin oferece uma fuga pacífica do jugo dos estados, permitindo-lhe desfrutar plenamente dos seus direitos naturais, que não podem ser desafiados por leis estabelecidas. Graças à invenção de Satoshi Nakamoto, você tem o poder de fazer valer o seu direito à propriedade privada e recuperar a sua liberdade de contratar.

No entanto, a Bitcoin não é anónima por defeito, o que pode representar um risco para os indivíduos envolvidos na economia alternativa, especialmente em regiões sob regimes despóticos. Mas este não é o único perigo. Como a bitcoin é um ativo valioso e sem censura, pode atrair a atenção de ladrões. Por conseguinte, proteger a sua privacidade também se torna uma questão de segurança: pode ajudá-lo a evitar ataques informáticos e assaltos físicos.

Como veremos, embora o protocolo ofereça certas protecções de privacidade inerentes, é crucial utilizar ferramentas adicionais para otimizar e defender esta privacidade. Este curso foi concebido como um caminho abrangente e generalista para compreender as questões de privacidade no Bitcoin. Cada noção técnica é discutida em pormenor e apoiada por diagramas explicativos. O objetivo é tornar o conhecimento acessível a todos, incluindo utilizadores principiantes e intermédios. Para bitcoiners mais experientes, nós também cobrimos conceitos muito técnicos e às vezes menos conhecidos durante este curso para aprofundar a compreensão de cada tópico.

O objetivo deste curso não é torná-lo completamente anónimo na sua utilização do Bitcoin, mas sim fornecer-lhe as ferramentas essenciais para saber como proteger a sua privacidade de acordo com os seus objectivos pessoais. Terá a liberdade de escolher entre os conceitos e ferramentas apresentados para desenvolver as suas próprias estratégias, adaptadas aos seus objectivos e necessidades específicas.

### Secção 1: Definições e conceitos-chave

Para começar, vamos analisar juntos os fundamentos que regem o funcionamento do Bitcoin e, em seguida, abordar com calma as noções relacionadas com a privacidade. É essencial dominar alguns conceitos básicos, tais como UTXOs, receber endereços ou scripts, antes de podermos compreender completamente os conceitos que iremos abordar nas secções seguintes. Introduziremos também o modelo geral de privacidade do Bitcoin, tal como imaginado por Satoshi Nakamoto, que nos permitirá compreender as questões e os riscos associados.

![BTC204](assets/it/11/1.webp)

### Secção 2: Compreender a análise em cadeia e como se proteger

Na segunda secção, estudamos as técnicas utilizadas pelas empresas de análise de blockchain para rastrear a sua atividade na Bitcoin. Compreender estes métodos é fundamental para melhorar a proteção da sua privacidade. Esta parte visa examinar as estratégias dos atacantes para melhor compreender os riscos e lançar as bases para as técnicas que estudaremos nas secções seguintes. Analisaremos padrões de transação, heurísticas internas e externas, bem como interpretações plausíveis desses padrões. Para além de uma componente teórica, aprenderemos a utilizar um explorador de blocos para efetuar análises de cadeias através de exemplos práticos e exercícios.

![BTC204](assets/fr/002.webp)

### Secção 3: Domínio das melhores práticas para proteger a sua privacidade

Na terceira secção do nosso curso, vamos ao cerne da questão: a prática! O objetivo é dominar todas as melhores práticas essenciais que devem tornar-se reflexos naturais para qualquer utilizador de Bitcoin. Cobriremos o uso de novos endereços, etiquetagem, consolidação, o uso de nós completos, bem como KYC e métodos de aquisição. O objetivo é fornecer uma visão abrangente das armadilhas a evitar, a fim de estabelecer uma base sólida na nossa busca pela proteção da privacidade. Para algumas destas práticas, será orientado para um tutorial específico para as implementar.

![BTC204](assets/it/11/3.webp)

### Secção 4: Compreender as transacções Coinjoin

Como é que podemos falar de privacidade da bitcoin sem falar de coinjoin? Na secção 4, descobrirá tudo o que precisa de saber sobre este método de mistura. Aprenderá o que é uma coinjoin, a sua história e objectivos, bem como os diferentes tipos de coinjoins que existem. Finalmente, para os utilizadores mais experientes, vamos descobrir o que são anonsets e entropia e como calcular estes indicadores.

![BTC204](assets/it/11/4.webp)

### Secção 5: Compreender os problemas de outras técnicas avançadas de privacidade

Na quinta secção, iremos fornecer uma visão geral de todas as outras técnicas existentes para proteger a sua privacidade no Bitcoin para além do coinjoin. Ao longo dos anos, os programadores têm demonstrado uma criatividade considerável na conceção de ferramentas dedicadas à privacidade. Examinaremos todos estes métodos, tais como payjoin, transacções colaborativas, Coin Swap e Atomic Swap, detalhando como funcionam, os seus objectivos e potenciais fraquezas.

Abordaremos também a privacidade ao nível da rede de nós e a difusão de transacções. Discutiremos também os vários protocolos que têm sido propostos ao longo dos anos para melhorar a privacidade do utilizador na Bitcoin, incluindo protocolos de endereço estático.

![BTC204](assets/fr/005.webp)

# Definições e conceitos-chave

<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>

## O modelo UTXO da Bitcoin

<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>

A Bitcoin é sobretudo uma moeda, mas sabe concretamente como é que a BTC é representada no protocolo?

### UTXOs de Bitcoin: o que são?

No protocolo Bitcoin, a gestão das unidades monetárias baseia-se no modelo UTXO, que significa "_Unspent Transaction Output_"

Este modelo é profundamente diferente dos sistemas bancários tradicionais, que se baseiam num mecanismo de contas e saldos para acompanhar os fluxos financeiros. De facto, no sistema bancário, os saldos individuais são mantidos em contas ligadas a uma identidade. Por exemplo, quando compra uma baguete a um padeiro, o seu banco debita simplesmente o montante da compra na sua conta, reduzindo assim o seu saldo, enquanto a conta do padeiro é creditada com o mesmo montante, aumentando o seu saldo. Neste sistema, não existe qualquer noção de ligação entre o dinheiro que entra na sua conta e o dinheiro que sai dela, para além dos registos de transacções.

Na Bitcoin, as coisas funcionam de forma diferente. O conceito de conta não existe, e as unidades monetárias são geridas não através de saldos, mas através de UTXOs. Um UTXO representa uma quantidade específica de bitcoin que ainda não foi gasta, formando assim uma "peça de bitcoin", que pode ser grande ou pequena. Por exemplo, um UTXO pode valer `500 BTC` ou apenas `700 SATS`.

**> Lembrete:** O satoshi, muitas vezes abreviado para sat, é a unidade mais pequena de Bitcoin, comparável a um cêntimo nas moedas fiduciárias.

```plaintext
1 BTC = 100,000,000 SATS
```

Teoricamente, um UTXO pode representar qualquer valor em bitcoin, desde um sat até ao máximo teórico de cerca de 21 milhões de BTC. No entanto, é logicamente impossível possuir todos os 21 milhões de bitcoins, e existe um limiar económico inferior denominado "dust", abaixo do qual um UTXO é considerado economicamente não rentável para gastar.

**>Sabias? ** O maior UTXO alguma vez criado na Bitcoin tinha um valor de `500.000 BTC`. Foi criado pela plataforma MtGox durante uma operação de consolidação em novembro de 2011: [29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXO e condições de despesa

UTXOs são as ferramentas de troca no Bitcoin. Cada transação envolve o consumo de UTXOs como inputs e a criação de novos UTXOs como outputs. Quando uma transação é efectuada, os UTXOs utilizados como inputs são considerados "gastos" e são gerados novos UTXOs que são atribuídos aos destinatários indicados nos outputs da transação. Assim, um UTXO representa simplesmente uma saída de transação não gasta e, portanto, uma quantidade de bitcoin pertencente a um utilizador num determinado momento.

![BTC204](assets/it/21/2.webp)

Todos os UTXOs são protegidos por scripts que definem as condições em que podem ser gastos. Para consumir um UTXO, um utilizador deve demonstrar à rede que cumpre as condições definidas pelo script que protege esse UTXO. Geralmente, os UTXOs são protegidos por uma chave pública (ou um endereço de receção que representa essa chave pública). Para gastar um UTXO associado a esta chave pública, o utilizador deve provar que possui a chave privada correspondente, fornecendo uma assinatura digital feita com esta chave. É por isso que se diz que a sua carteira bitcoin não contém bitcoins, mas sim as suas chaves privadas, que por sua vez lhe dão acesso aos seus UTXOs e, por extensão, aos bitcoins que representam.

![BTC204](assets/it/21/3.webp)

Como o conceito de conta não existe no Bitcoin, o saldo de uma carteira é simplesmente a soma dos valores de todos os UTXOs que ela pode gastar. Por exemplo, se a sua carteira Bitcoin pode gastar os seguintes 4 UTXOs:

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

O saldo total da sua carteira seria de `17 BTC`.

![BTC204](assets/it/21/4.webp)

## A estrutura das transacções Bitcoin

<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>

### Os inputs e outputs de uma transação

Uma transação de bitcoin é uma transação registada na cadeia de blocos que permite a transferência da propriedade de bitcoins de uma pessoa para outra. Mais especificamente, como estamos num modelo UTXO e não existem contas, a transação satisfaz as condições de despesa que protegiam um ou mais UTXOs, consome-os e, de forma equivalente, cria novos UTXOs equipados com novas condições de despesa. Em suma, uma transação transfere bitcoins de um script que é satisfeito para um novo script destinado a protegê-los.

![BTC204](assets/it/22/1.webp)

Cada transação Bitcoin é assim composta por um ou mais inputs e um ou mais outputs. Os inputs são UTXOs consumidos pela transação para gerar os outputs. Os outputs são novos UTXOs que poderão ser utilizados como inputs para futuras transacções.

![BTC204](assets/it/22/2.webp)

**> Sabia que? Teoricamente, uma transação de bitcoin pode ter um número infinito de entradas e saídas. Apenas o tamanho máximo do bloco limita este número. Cada entrada numa transação de bitcoin refere-se a um UTXO (Unspent Transaction Output) anterior não gasto. Para utilizar um UTXO como input, o seu detentor deve provar que é o legítimo proprietário, validando o guião a ele associado, ou seja, satisfazendo a condição de gasto imposta. Geralmente, isto envolve o fornecimento de uma assinatura digital produzida com a chave privada correspondente à chave pública que inicialmente protegeu esse UTXO. O guião verifica então se a assinatura corresponde à chave pública utilizada aquando da receção dos fundos.

Cada saída, por outro lado, especifica a quantidade de bitcoin a ser transferida, bem como o destinatário. Este último é definido por um novo script que geralmente bloqueia o UTXO recém-criado com um endereço de receção ou uma nova chave pública.

Para que uma transação seja considerada válida de acordo com as regras de consenso, o total das saídas deve ser inferior ou igual ao total das entradas. Por outras palavras, a soma dos novos UTXOs gerados pela transação não deve exceder a soma dos UTXOs consumidos como entradas. Este princípio é lógico: se só tiver um montante de 500.000 SATS, não pode efetuar uma compra de 700.000 SATS.

### Troca e consolidação numa transação de Bitcoin

A ação de uma transação Bitcoin sobre UTXOs pode assim ser comparada à fusão de uma moeda de ouro. De facto, um UTXO não é divisível, mas apenas unificado. Isto significa que um utilizador não pode simplesmente dividir um UTXO que representa uma certa quantidade de bitcoin em vários UTXOs mais pequenos. Ele deve consumi-lo inteiramente numa transação para criar um ou mais novos UTXOs de valores arbitrários nos outputs, que devem ser menores ou iguais ao valor inicial.

Este mecanismo é semelhante ao de uma moeda de ouro. Imagine que possui uma moeda de 2 onças e pretende efetuar um pagamento de 1 onça, partindo do princípio que o vendedor não lhe pode dar troco. Teria de fundir a sua moeda e cunhar 2 novas moedas de 1 onça cada.

No bitcoin, a operação é semelhante. Suponhamos que Alice tem um UTXO de `10.000 SATS` e quer comprar uma baguete que custa `4.000 SATS`. Alice realizará uma transação com uma entrada de 1 UTXO de 10.000 SATS` que consumirá na totalidade e, nas saídas, criará 2 UTXOs no valor de 4.000 SATS` e 6.000 SATS`. O UTXO de `4.000 SATS` será enviado para o padeiro como pagamento pela baguete, enquanto o UTXO de `6.000 SATS` voltará para Alice como troco. Este UTXO que retorna ao remetente inicial da transação é o que é chamado de "troco" no jargão do Bitcoin.

Agora imagine que Alice não tem uma única UTXO de `10.000 SATS`, mas sim duas UTXOs de `3.000 SATS` cada. Nesta situação, nenhuma das UTXOs individuais é suficiente para cobrir os `4.000 SATS` da baguete. Portanto, Alice deve utilizar simultaneamente as duas UTXOs de `3.000 SATS` como entradas para a sua transação. Desta forma, a entrada total atingirá `6.000 SATS`, permitindo-lhe cobrir o pagamento de `4.000 SATS` ao padeiro. Este método, que envolve o agrupamento de vários UTXOs nos inputs de uma transação, é frequentemente designado por "consolidação".

### Taxas de transação

Intuitivamente, poder-se-ia pensar que as comissões de transação também representam um resultado de uma transação. Mas, na realidade, não é esse o caso. As comissões de transação representam a diferença entre o total dos inputs e o total dos outputs. Isto significa que, depois de utilizar parte do valor dos inputs para cobrir os outputs desejados numa transação, uma determinada soma dos inputs fica por utilizar. Esta soma restante constitui as comissões de transação.

```plaintext
Commissioni = input totali - output totali
```

Voltemos ao exemplo de Alice que tem um UTXO de `10.000 SATS` e quer comprar uma baguete por `4.000 SATS`. Alice cria uma transação com o seu UTXO de `10.000 SATS` como entrada. Em seguida, ela gera uma saída de `4.000 SATS` destinada ao padeiro para pagar a baguete. Para encorajar os mineiros a incluir a sua transação num bloco, Alice atribui `200 SATS` como comissão. Ao fazer isso, ela cria uma segunda saída, o restante, que será devolvido a ela, totalizando `5.800 SATS`.

Aplicando a fórmula da comissão, verificamos que restam `200 SATS` para os mineiros:

```plaintext
Commissioni = input totali - output totali
Spese = 10.000 - (4.000 + 5.800)
Spese = 10.000 - 9.800
Spese = 200
```

Quando um mineiro valida com sucesso um bloco, tem direito a cobrar estas taxas por todas as transacções incluídas no seu bloco, através do que é conhecido como uma transação "coinbase".

### A criação do UTXO na Bitcoin

Se seguiu atentamente os parágrafos anteriores, sabe agora que os UTXOs só podem ser criados consumindo outros UTXOs existentes. Assim, as moedas no Bitcoin formam uma cadeia contínua. No entanto, podes perguntar-te como é que os primeiros UTXOs apareceram nesta cadeia. Isto levanta um problema semelhante ao da galinha e do ovo: de onde vieram estes UTXOs originais?

A resposta está na transação **coinbase**.

A Coinbase é um tipo específico de transação Bitcoin, única em cada bloco e sempre a primeira. Permite ao mineiro que encontrou uma prova de trabalho válida receber a sua recompensa de bloco. Esta recompensa é composta por dois elementos: **a concessão do bloco** e **taxas de transação** discutidas na parte anterior.

A caraterística única da transação coinbase é que é a única que pode criar bitcoins a partir do nada, sem a necessidade de consumir inputs para gerar os seus outputs. Esses bitcoins recém-criados constituem o que pode ser chamado de "UTXOs originais"

Os Bitcoins da concessão de blocos são novos BTC criados a partir do nada, seguindo um calendário de emissão predefinido nas regras de consenso. O subsídio por bloco é reduzido para metade a cada 210 000 blocos, aproximadamente de quatro em quatro anos, num processo designado por "halving" Inicialmente, eram criados 50 bitcoins por subsídio, mas este montante foi diminuindo gradualmente; atualmente, são 3.125 bitcoins por bloco.

Quanto à parte das taxas de transação, embora represente BTC recém-criadas, estas não devem exceder a diferença entre o total de entradas e saídas de todas as transacções num bloco. Vimos anteriormente que estas taxas representam a parte dos inputs que não é utilizada nos outputs das transacções. Esta parte é tecnicamente "perdida" durante a transação, e o mineiro tem o direito de recriar este valor sob a forma de um ou mais novos UTXOs. Trata-se, portanto, de uma transferência de valor do remetente da transação para o mineiro que a adiciona à cadeia de blocos.

**> Os bitcoins gerados a partir de uma transação coinbase estão sujeitos a um período de maturação de 100 blocos durante o qual não podem ser gastos pelo mineiro. Esta regra destina-se a evitar complicações associadas à utilização de bitcoins recém-criados numa cadeia que pode mais tarde tornar-se obsoleta.

### As implicações do modelo UTXO

Em primeiro lugar, o modelo UTXO afecta diretamente as taxas de transação na Bitcoin. Como a capacidade de cada bloco é limitada, os mineiros favorecem as transações que oferecem as melhores taxas em relação ao espaço que ocuparão no bloco. Na verdade, quanto mais UTXO uma transação inclui como entrada e saída, mais pesada ela é e, portanto, exige taxas mais altas. Esta é uma das razões pelas quais existe frequentemente um esforço para reduzir o número de UTXOs na nossa carteira, o que também pode afetar a privacidade, um tópico que iremos explorar em pormenor na terceira parte desta formação.

Em seguida, como mencionado nas partes anteriores, as moedas em Bitcoin são essencialmente uma cadeia de UTXOs. Cada transação cria assim uma ligação entre um UTXO passado e um UTXO futuro. Os UTXO permitem assim seguir explicitamente o percurso dos bitcoins desde a sua criação até à sua utilização atual. Esta transparência pode ser vista de forma positiva, uma vez que permite a cada utilizador garantir a autenticidade das bitcoins recebidas. No entanto, é também neste princípio de rastreabilidade e auditabilidade que se baseia a análise da cadeia, uma prática destinada a comprometer a sua privacidade. Estudaremos esta prática em profundidade na segunda parte da formação.

## O modelo de privacidade da Bitcoin

<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>

### Moeda: Autenticidade, integridade e gastos duplos

Uma das funções da moeda é resolver o problema da dupla coincidência de desejos. Num sistema baseado na troca direta, fazer uma troca requer não só encontrar um indivíduo que ofereça um bem que satisfaça a minha necessidade, mas também fornecer-lhe um bem de valor equivalente que satisfaça a sua necessidade. Encontrar este equilíbrio revela-se complexo.

É por isso que se utiliza a moeda, que permite a transferência de valor tanto no espaço como no tempo.

Para que a moeda resolva este problema, é essencial que a parte que fornece um bem ou serviço esteja convencida da sua capacidade para gastar esse montante mais tarde. Por conseguinte, qualquer indivíduo racional que deseje aceitar uma forma de moeda, seja ela digital ou física, assegurar-se-á de que esta satisfaz dois critérios básicos:


- A moeda deve estar intacta e ser autêntica;**- **e não deve ser gasta duas vezes.**

Quando se utiliza moeda física, a primeira caraterística é a mais complexa de afirmar. Ao longo de diferentes períodos históricos, a integridade das moedas metálicas foi frequentemente comprometida por práticas como o corte ou a perfuração. Por exemplo, na Roma antiga, era comum os cidadãos rasparem os bordos das moedas de ouro para recolherem parte do metal precioso, preservando-as para futuras transacções. O valor intrínseco da moeda era assim reduzido, mas o seu valor facial permanecia o mesmo. Esta é a razão pela qual, mais tarde, foram cunhadas riscas no bordo das moedas.

A autenticidade é também uma caraterística difícil de verificar através de meios monetários físicos. Atualmente, as técnicas de combate à contrafação são cada vez mais complexas, obrigando os comerciantes a investir em sistemas de verificação dispendiosos.

Por outro lado, devido à sua natureza, o duplo pagamento não constitui um problema para as moedas físicas. Se eu lhe der uma nota de 10 euros, ela sai irrevogavelmente da minha posse para entrar na sua, excluindo, evidentemente, qualquer possibilidade de gastar as mesmas unidades monetárias várias vezes. Em suma, não poderei voltar a gastar essa nota de 10 euros.

No caso da moeda digital, a dificuldade é diferente. Garantir a autenticidade e a integridade de uma moeda é muitas vezes mais fácil. Como vimos na secção anterior, o modelo UTXO da Bitcoin permite que uma moeda seja rastreada até à sua origem, verificando assim que foi efetivamente criada de acordo com as regras de consenso por um mineiro.

No entanto, garantir a ausência de duplo pagamento é mais complexo, uma vez que qualquer bem digital é essencialmente informação. Ao contrário dos bens físicos, a informação não se divide durante as trocas, mas propaga-se através da multiplicação. Por exemplo, se eu lhe enviar um documento por correio eletrónico, este é duplicado. Pela sua parte, não pode verificar com certeza que eu apaguei o documento original.

### Evitar o duplo pagamento em Bitcoin

A única forma de evitar a duplicação de um ativo digital é estar ciente de todas as trocas dentro do sistema. Dessa forma, é possível saber quem possui o quê e atualizar a propriedade de todos com base nas transacções efectuadas. É o que se faz, por exemplo, com a moeda escritural no sistema bancário. Quando se paga 10 euros a um comerciante com um cartão de crédito, o banco regista essa troca e actualiza o livro-razão.

Na Bitcoin, a prevenção do duplo pagamento é efectuada da mesma forma. O objetivo é confirmar a ausência de uma transação que já tenha gasto as moedas em questão. Se essas moedas nunca foram utilizadas, então podemos ter a certeza de que não ocorrerá um duplo pagamento. Este princípio foi descrito por Satoshi Nakamoto no Livro Branco com esta famosa frase:

**"_A única forma de confirmar a ausência de uma transação é ter conhecimento de todas as transacções

No entanto, ao contrário do modelo bancário, não se pretende confiar numa entidade central na Bitcoin. É necessário que todos os utilizadores possam confirmar esta ausência de duplo pagamento, sem depender de um terceiro. Portanto, todos precisam de estar cientes de todas as transacções Bitcoin. É por isso que as transacções Bitcoin são transmitidas publicamente em todos os nós da rede e registadas em texto simples na cadeia de blocos.

É precisamente esta divulgação pública de informação que complica a proteção da privacidade na Bitcoin. No sistema bancário tradicional, em teoria, apenas a instituição financeira tem conhecimento das transacções efectuadas. Por outro lado, no Bitcoin, todos os utilizadores são informados de todas as transacções, através dos seus respectivos nós.

### O modelo de privacidade: sistema bancário vs. Bitcoin

No sistema tradicional, a conta bancária está ligada à identidade do cliente. O banqueiro pode saber que cliente pertence a que conta bancária e que transacções lhe estão associadas. No entanto, este fluxo de informação é interrompido entre o banco e o domínio público. Por outras palavras, é impossível saber o saldo e os movimentos de uma conta bancária que pertence a outra pessoa. Apenas o banco tem acesso a esta informação.

Por exemplo, o seu banqueiro sabe que você compra a sua baguete todas as manhãs na padaria do bairro, mas o seu vizinho não tem conhecimento desta transação. Assim, o fluxo de informação é acessível às partes interessadas, nomeadamente ao banco, mas permanece inacessível aos estranhos.

Devido ao constrangimento da divulgação pública das transacções que vimos na parte anterior, o modelo de privacidade da Bitcoin não pode seguir o modelo do sistema bancário. No caso da Bitcoin, como o fluxo de informação não pode ser interrompido entre as transacções e o domínio público, **o modelo de privacidade baseia-se na separação entre a identidade do utilizador e as transacções** propriamente ditas.

Por exemplo, se comprar uma baguete ao padeiro pagando em BTC, o seu vizinho, que possui o seu próprio nó completo, pode ver a sua transação, tal como pode ver todas as outras transacções no sistema. No entanto, se os princípios de privacidade forem respeitados, ele não deve poder associar esta transação específica à sua identidade.

Mas como as transacções Bitcoin são tornadas públicas, torna-se possível estabelecer ligações entre elas para inferir informações sobre as partes envolvidas. Esta atividade constitui mesmo uma especialidade em si mesma chamada "análise de cadeia" Na próxima parte do curso, convido-o a explorar os fundamentos da análise de cadeias para compreender como as suas bitcoins estão a ser seguidas e saber como se defender melhor.

# Compreender a análise da cadeia e como se proteger

<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## O que é a análise em cadeia da Bitcoin?

<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>

### Definição e funcionamento

A análise de cadeia é uma prática que engloba todos os métodos utilizados para rastrear o fluxo de bitcoin na blockchain. Geralmente, a análise da cadeia baseia-se na observação de caraterísticas em amostras de transacções anteriores. Em seguida, envolve a identificação dessas mesmas caraterísticas numa transação que se pretende analisar e a inferência de interpretações plausíveis. Este método de resolução de problemas a partir de uma abordagem prática para encontrar uma solução suficientemente boa é o que se designa por "heurística"

Para simplificar, a análise da cadeia é efectuada em três etapas principais:

1. **Observar a cadeia de blocos;**

2. **Identificar as caraterísticas conhecidas

3. **Hipóteses de educação

A análise da cadeia de blocos pode ser efectuada por qualquer pessoa. Basta ter acesso à informação pública da blockchain através de um nó completo para observar os movimentos das transacções e fazer suposições. Existem também ferramentas gratuitas que facilitam esta análise, como o sítio Web [OXT.me](https://oxt.me/), que exploraremos em pormenor nos dois últimos capítulos desta parte. No entanto, o principal risco para a privacidade vem das empresas especializadas em análise de cadeias. Estas empresas levaram a análise de cadeias a uma escala industrial e vendem os seus serviços a instituições financeiras ou governos. Entre estas empresas, a Chainalysis é provavelmente a mais conhecida.

### Os objectivos da análise em cadeia

Um dos objectivos da análise em cadeia é agrupar várias actividades na Bitcoin, a fim de determinar a singularidade do utilizador que as realizou. Em seguida, será possível tentar ligar este conjunto de actividades a uma identidade real.

Lembre-se do capítulo anterior. Expliquei por que razão o modelo de privacidade da Bitcoin se baseava originalmente na separação das identidades dos utilizadores das suas transacções. Por conseguinte, seria tentador pensar que a análise on-chain é inútil, uma vez que, mesmo que se possa agrupar as actividades on-chain, estas não podem ser associadas a uma identidade real.

Teoricamente, esta afirmação é exacta. Na primeira parte desta formação, vimos que os pares de chaves criptográficas são utilizados para estabelecer condições no UTXO. Por essência, estes pares de chaves não revelam qualquer informação sobre a identidade dos seus detentores. Assim, mesmo que consigamos agrupar actividades associadas a diferentes pares de chaves, isso não nos diz nada sobre a entidade por detrás dessas actividades.

No entanto, a realidade prática é muito mais complexa. Existe uma multiplicidade de comportamentos que podem associar uma identidade real a uma atividade onchain. Em análise, chama-se a isto um ponto de entrada, e há muitos.

O mais comum, claro, é o KYC (_Know Your Customer_). Se retirar os seus bitcoins de uma plataforma regulamentada para um dos seus endereços pessoais de receção, algumas pessoas podem associar a sua identidade a esse endereço. De uma forma mais geral, um ponto de entrada pode ser qualquer forma de interação entre a sua vida real e uma transação de bitcoin. Por exemplo, se publicar um endereço de receção nas suas redes sociais, este pode ser um ponto de entrada para análise. Se fizer um pagamento em bitcoin ao seu padeiro, ele pode associar o seu rosto (que faz parte da sua identidade) a um endereço Bitcoin.

Estes pontos de entrada são quase inevitáveis na utilização da Bitcoin. Embora se possa tentar limitar o seu alcance, eles continuarão presentes. É por isso que é crucial combinar métodos destinados a preservar a sua privacidade. Embora manter uma separação entre a sua identidade real e as suas transacções seja uma abordagem atraente, continua a ser insuficiente hoje em dia. De facto, se todas as suas actividades onchain puderem ser agrupadas, então o mais pequeno ponto de entrada é suscetível de comprometer a única camada de privacidade que estabeleceu.

### Defesa contra a análise da cadeia

Por conseguinte, é igualmente necessário poder abordar a análise da cadeia de blocos na nossa utilização da Bitcoin. Ao proceder desta forma, podemos minimizar a agregação das nossas actividades e limitar o impacto de um ponto de entrada na nossa privacidade.

De facto, para melhor contrariar a análise da cadeia de blocos, que melhor abordagem do que familiarizar-se com os métodos utilizados na análise da cadeia de blocos? Se quer saber como melhorar a sua privacidade na Bitcoin, precisa de compreender estes métodos. Isto permitir-lhe-á compreender melhor técnicas como coinjoin ou payjoin (técnicas que estudaremos nas últimas partes da formação) e reduzir os erros que poderá cometer.

Neste contexto, podemos fazer uma analogia com a criptografia e a criptanálise. Um bom criptógrafo é, antes de mais, um bom criptanalista. Para conceber um novo algoritmo criptográfico, é necessário saber quais os ataques que este irá enfrentar e também estudar porque é que os algoritmos anteriores foram pirateados. O mesmo princípio aplica-se à privacidade na Bitcoin. Compreender os métodos de análise da cadeia de blocos é a chave para se proteger contra eles. É por isso que proponho uma secção inteira sobre a análise da cadeia de blocos nesta formação.

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/fr/tutorials/privacy/on-chain/payjoin-848b6a23-deb2-4c5f-a27e-93e2f842140f
### Os métodos de análise da cadeia de blocos

É importante compreender que a análise da cadeia de blocos não é uma ciência exacta. Baseia-se em heurísticas derivadas de observações anteriores ou interpretações lógicas. Estas regras permitem obter resultados bastante fiáveis, mas nunca com uma precisão absoluta. Por outras palavras, a **análise da cadeia de blocos envolve sempre uma dimensão de probabilidade nas conclusões emitidas**. Por exemplo, é possível estimar com maior ou menor certeza que dois endereços pertencem à mesma entidade, mas a certeza total estará sempre fora de alcance.

O principal objetivo da análise de blockchain reside precisamente na agregação de várias heurísticas, de forma a minimizar o risco de erro. É, de certa forma, uma acumulação de evidências que nos permite aproximarmo-nos da realidade.

Estas famosas heurísticas podem ser agrupadas em várias categorias que iremos detalhar em conjunto:


- Modelos de transação (ou modelos de transação);**
- Heurística interna da transação;**
- Heurísticas externas à transação

### Satoshi Nakamoto e análise da cadeia de blocos

Deve-se notar que as duas primeiras heurísticas para análise de cadeias foram descobertas pelo próprio Satoshi Nakamoto. Ele discute-as na Parte 10 do Livro Branco do Bitcoin. São elas:


- a Heurística de Propriedade de Entrada Comum (CIOH);
- e a reutilização de endereços.

![BTC204](assets/fr/031.webp)

Fonte: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System," https://bitcoin.org/bitcoin.pdf, 2009.

Nos capítulos seguintes, iremos explorar o que está em causa, mas é já interessante notar que estas duas heurísticas continuam a ser proeminentes na análise de cadeias atualmente.

## Modelos de transação

<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>

Um modelo de transação é simplesmente um padrão ou estrutura geral de uma transação típica que pode ser encontrada na cadeia de blocos, cuja interpretação é presumivelmente conhecida. Quando estudamos padrões, concentramo-nos numa única transação que analisamos a um nível elevado.

Por outras palavras, vamos apenas olhar para o número de UTXOs nas entradas e o número de UTXOs nas saídas, sem nos determos nos detalhes mais específicos ou no ambiente da transação. A partir do padrão observado, poderemos interpretar a natureza da transação. Procuraremos então caraterísticas na sua estrutura e inferiremos uma interpretação.

![BTC204](assets/it/32/01.webp)

Nesta parte, descobriremos juntos os principais padrões de transação que podem ser encontrados na análise da cadeia e, para cada padrão, dar-lhe-ei a interpretação provável desta estrutura, juntamente com um exemplo concreto.

### Envio simples (ou pagamento simples)

Comecemos por um modelo muito popular, uma vez que é o que aparece na maioria dos pagamentos em bitcoin. O modelo de pagamento simples caracteriza-se por consumir um ou mais UTXOs nos inputs e produzir 2 UTXOs nos outputs. Este modelo terá, portanto, o seguinte aspeto:

![BTC204](assets/it/32/02.webp)

Quando identificamos esta estrutura de transação na cadeia de blocos, já podemos fazer uma interpretação. Como o nome sugere, este padrão indica que estamos perante uma transação de envio ou pagamento. O utilizador consumiu os seus UTXOs na entrada para satisfazer na saída um UTXO de pagamento e um UTXO de troco (dinheiro devolvido ao mesmo utilizador).

Assim, sabemos que o utilizador observado já não está provavelmente na posse de um dos dois UTXOs de saída (o de pagamento), mas ainda está na posse do outro UTXO (o de mudança).

Atualmente, é-nos impossível especificar que saída representa que UTXO, uma vez que não é esse o objetivo do estudo dos modelos. Alcançaremos este objetivo apoiando-nos nas heurísticas que estudaremos nas partes seguintes. Nesta fase, o nosso objetivo limita-se a identificar a natureza da transação em questão, que neste caso é um simples envio.

Por exemplo, aqui está uma transação Bitcoin que adopta o modelo de envio simples:

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/it/32/03.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

Após este primeiro exemplo, deverá ter uma melhor compreensão do que significa estudar um "modelo de transação" Examinamos uma transação centrando-nos apenas na sua estrutura, sem ter em conta o seu ambiente ou os detalhes específicos da transação. Nesta primeira etapa, apenas a analisamos globalmente.

Agora que já sabe o que é um modelo, vamos passar para os outros modelos existentes.

### Varrer

Este segundo modelo é caracterizado pelo consumo de um único UTXO como entrada e pela produção de um único UTXO como saída.

![BTC204](assets/it/32/04.webp)

A interpretação deste modelo é que estamos a lidar com uma transferência automática. O utilizador transferiu os seus bitcoins para si próprio, para outro endereço que lhe pertence. Uma vez que não há resto na transação, é muito improvável que estejamos perante um pagamento. De facto, quando um pagamento é feito, é quase impossível que o pagador tenha um UTXO que corresponda exatamente ao montante solicitado pelo vendedor, mais as taxas de transação. Geralmente, o pagador é, portanto, forçado a produzir um resto de saída.

Portanto, sabemos que o utilizador observado provavelmente ainda está na posse deste UTXO. No contexto de uma análise em cadeia, se soubermos que o UTXO utilizado como entrada na transação pertence a Alice, podemos assumir que o UTXO na saída também lhe pertence. O que se tornará interessante mais tarde é encontrar heurísticas internas à transação que possam reforçar este pressuposto (estudaremos estas heurísticas na Secção 3.3).

Por exemplo, aqui está uma transação Bitcoin que adopta o modelo de varrimento:

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/it/32/05.webp)

Fonte:[Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d) No entanto, este tipo de padrão pode também revelar uma auto-transferência para uma conta de uma plataforma de troca de criptomoedas. Será o estudo dos endereços conhecidos e do contexto da transação que nos permitirá saber se se trata de uma consolidação para uma carteira de auto-armazenamento ou de um levantamento para uma plataforma. De facto, os endereços das plataformas de câmbio são muitas vezes facilmente identificáveis.

Voltemos ao exemplo da Alice: se a consolidação levar a um endereço conhecido de uma plataforma (como a Binance, por exemplo), isso pode significar que os bitcoins foram transferidos para fora da posse direta da Alice, provavelmente com a intenção de os vender ou armazenar nessa plataforma. Por outro lado, se o endereço de destino for desconhecido, é razoável assumir que se trata simplesmente de outra carteira ainda pertencente a Alice. Mas este tipo de estudo enquadra-se mais na categoria de heurística e não no estudo de padrões.

### Consolidação

Este modelo é caracterizado por consumir vários UTXOs como entrada e produzir um único UTXO como saída.

![BTC204](assets/it/32/06.webp)

A interpretação deste padrão é que estamos na presença de consolidação. Esta é uma prática comum entre os utilizadores de Bitcoin para fundir várias UTXOs em antecipação de um possível aumento nas taxas de transação. Ao realizar esta operação durante um período em que as taxas são baixas, é possível economizar em taxas futuras. Discutiremos mais sobre essa prática no Capítulo 4.3.

Podemos inferir que o utilizador por detrás deste modelo de transação estava provavelmente na posse de todos os UTXOs de entrada e ainda está na posse do UTXO de saída. Trata-se definitivamente de uma autotransferência.

Tal como a consolidação, este tipo de padrão pode também revelar uma auto-transferência para uma conta de uma plataforma de câmbio. Será o estudo dos endereços conhecidos e o contexto da transação que nos permitirá saber se se trata de uma consolidação para uma carteira de autocustódia ou de um levantamento para uma plataforma.

Por exemplo, aqui está uma transação Bitcoin que adopta o esquema de consolidação:

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/it/32/07.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)

No contexto de uma análise em cadeia, este modelo pode revelar muita informação. Por exemplo, se soubermos que uma das entradas pertence à Alice, podemos assumir que todas as outras entradas e saídas desta transação lhe pertencem. Este pressuposto permitir-nos-ia, então, percorrer as cadeias de transacções anteriores para descobrir e analisar outras transacções provavelmente associadas à Alice.

![BTC204](assets/it/32/08.webp)

### Despesas agrupadas

Este modelo é caracterizado pelo consumo de alguns UTXOs como entrada (frequentemente apenas um) e a produção de numerosos UTXOs como saída.

![BTC204](assets/it/32/09.webp)

A interpretação deste padrão é que estamos a lidar com despesas agrupadas. Trata-se de uma prática suscetível de revelar uma atividade económica significativa, como é o caso de uma plataforma de intercâmbio. As despesas agrupadas permitem a estas entidades poupar em taxas, consolidando as suas despesas numa única transação.

Podemos inferir deste modelo que a entrada de UTXO provém de uma empresa com atividade económica significativa e que as saídas de UTXO se dispersarão. Muitos pertencerão aos clientes da empresa que retiraram bitcoin da plataforma. Outras poderão ir para empresas parceiras. Finalmente, haverá certamente uma ou mais trocas que regressam à empresa emissora.

Por exemplo, aqui está uma transação Bitcoin que adopta o modelo de despesas agrupadas (provavelmente, trata-se de uma transação emitida pela plataforma Bybit):

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/it/32/10.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### Transacções específicas do protocolo

Entre os padrões de transação, podemos também identificar padrões que revelam a utilização de um protocolo específico. Por exemplo, os coinjoins da Whirlpool (que discutiremos na Parte 5) terão uma estrutura facilmente identificável que permite diferenciá-los de outras transacções mais tradicionais.

![BTC204](assets/it/32/11.webp)

A análise deste padrão sugere que estamos provavelmente perante uma transação de colaboração. Também é possível observar um coinjoin. Se esta última hipótese for correta, então o número de saídas pode dar-nos uma estimativa aproximada do número de participantes no coinjoin.

Por exemplo, aqui está uma transação Bitcoin que adopta o modelo de tipo de transação colaborativa coinjoin:

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/it/32/12.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

Existem muitos outros protocolos que têm as suas próprias estruturas específicas. Assim, poderíamos distinguir transacções do tipo Wabisabi, transacções Stamps, ou mesmo Runes, por exemplo.

Graças a estes modelos de transação, já podemos interpretar uma certa quantidade de informação sobre uma determinada transação. Mas a estrutura da transação não é a única fonte de informação para análise. Podemos também estudar os seus pormenores. Estes detalhes, internos a uma transação, são aquilo a que gosto de chamar "heurística interna" e que estudaremos no capítulo seguinte.

## Heurística interna

<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>

Uma heurística interna é uma caraterística específica identificada na própria transação, sem necessidade de examinar o seu ambiente, que nos permite fazer inferências. Ao contrário dos modelos que se centram na estrutura global da transação a um nível elevado, as heurísticas internas baseiam-se no conjunto de dados extraíveis. Isto inclui:


- As quantidades de diferentes UTXOs que entram e saem;
- Tudo sobre scripts: endereços de receção, controlo de versões, tempos de bloqueio, etc.

Geralmente, este tipo de heurística permite-nos identificar o remanescente numa transação específica. Ao fazê-lo, podemos continuar a seguir uma entidade em várias transacções. De facto, se identificarmos um UTXO pertencente a um utilizador que pretendemos seguir, é crucial determinar, quando este efectua uma transação, qual o output que foi transferido para outro utilizador e qual o output que representa o remanescente, permanecendo assim na sua posse.

![BTC204](assets/it/33/01.webp)

Recordo mais uma vez que estas heurísticas não são de modo algum exactas. Tomadas individualmente, apenas nos permitem identificar cenários plausíveis. É a acumulação de diferentes heurísticas que ajuda a reduzir a incerteza, sem nunca a eliminar completamente.

### Semelhanças internas

Esta heurística consiste em estudar as semelhanças entre os inputs e os outputs da mesma transação. Se observarmos a mesma caraterística nos inputs e em apenas um dos outputs da transação, então é provável que este output constitua o resto.

A caraterística mais óbvia é a reutilização de um endereço de receção na mesma transação.

![BTC204](assets/it/33/02.webp)

Esta heurística deixa pouca margem para dúvidas. A menos que a chave privada de alguém tenha sido pirateada, o mesmo endereço de receção revela inevitavelmente a atividade de um único utilizador. A interpretação que se segue é que o resto da transação é a saída com o mesmo endereço de entrada. Isto permite o rastreio contínuo do indivíduo com base neste resto.

Por exemplo, eis uma transação em que esta heurística pode ser razoavelmente aplicada:

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/fr/046.webp)

Fonte: [Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

Estas semelhanças entre a entrada e a saída não se limitam à reutilização de endereços. Qualquer semelhança na utilização de scripts pode permitir a aplicação de heurísticas. Por exemplo, por vezes pode observar-se o mesmo versionamento entre um input e um dos outputs da transação.

![BTC204](assets/it/33/04.webp)

Neste diagrama, podemos ver que a entrada n.º 0 desbloqueia um script P2WPKH (SegWit V0 começando com `bc1q`). A saída nº 0 usa o mesmo tipo de script. No entanto, a saída nº 1 usa um script P2TR (SegWit V1 começando com `bc1p`). A interpretação desta caraterística é que é provável que o endereço com o mesmo versionamento que a entrada seja o endereço do resto. Portanto, ainda pertenceria ao mesmo utilizador.

Eis uma transação em que esta heurística pode ser razoavelmente aplicada:

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/fr/048.webp)

Fonte: [Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)

Neste caso, podemos ver que a entrada n.º 0 e a saída n.º 1 usam scripts P2WPKH (SegWit V0), enquanto a saída n.º 0 usa um tipo diferente de script, P2PKH (Legacy). No início da década de 2010, esta heurística baseada na versão do script era relativamente inútil devido à limitação dos tipos de script disponíveis. No entanto, ao longo do tempo e com as subsequentes actualizações da Bitcoin, foi introduzida uma diversidade crescente de tipos de scripts. Esta heurística está a tornar-se cada vez mais relevante porque, com uma maior variedade de tipos de scripts, os utilizadores estão divididos em grupos mais pequenos, aumentando assim as hipóteses de aplicar esta heurística interna de reutilização de versões. Por este motivo, apenas do ponto de vista da privacidade, é aconselhável optar pelo tipo de script mais comum. Por exemplo, no momento em que escrevo estas linhas, os scripts Taproot (`bc1p`) são menos utilizados do que os scripts SegWit V0 (`bc1q`). Embora os primeiros ofereçam vantagens económicas e de privacidade em certos contextos específicos, para utilizações mais tradicionais de assinatura única, pode ser sensato manter um padrão mais antigo por razões de privacidade até que o novo padrão seja mais amplamente adotado.

### Pagamentos com números arredondados

Outra heurística interna que nos pode ajudar a identificar o resto é a do número arredondado. Geralmente, perante um esquema de pagamento simples (1 entrada e 2 saídas), se uma das saídas gasta um valor arredondado, então representa o pagamento.

![BTC204](assets/it/33/06.webp)

Por eliminação, se uma saída representa o pagamento, a outra representa o troco. Pode, portanto, deduzir-se que é provável que o utilizador que entrou na transação ainda possua o resultado identificado como troco.

Note-se que esta heurística nem sempre é aplicável, uma vez que a maioria dos pagamentos ainda é efectuada em unidades monetárias fiduciárias. De facto, quando um comerciante em França aceita bitcoin, geralmente não apresenta preços estáveis em sats. Prefere optar por uma conversão entre o preço em euros e o montante em bitcoin a pagar. Por conseguinte, não deve haver um número arredondado no resultado da transação.

No entanto, um analista pode tentar efetuar esta conversão tendo em conta a taxa de câmbio em vigor no momento em que a transação foi transmitida através da rede. Tomemos o exemplo de uma transação com uma entrada de `97 552 sats` e duas saídas, uma de `31 085 sats` e outra de `64 152 sats`. À primeira vista, esta transação não parece envolver montantes arredondados. No entanto, aplicando a taxa de câmbio de `64,339 no momento da transação, obtemos uma conversão para euros que aparece da seguinte forma:


- Um contributo de 62,76 euros;
- Uma produção de 20 euros;
- Uma produção de 41,27 euros.

Uma vez convertida em moeda fiduciária, esta transação permite a aplicação da heurística dos pagamentos com montantes arredondados. A saída de 20 euros foi provavelmente destinada a um comerciante ou mudou de proprietário. Por inferência, a saída de 41,27 euros provavelmente permaneceu na posse do utilizador original.

![BTC204](assets/it/33/07.webp)

Se, um dia, a Bitcoin se tornar a unidade de conta preferida nas nossas transacções, esta heurística poderá tornar-se ainda mais útil para a análise.

Por exemplo, aqui está uma transação em que esta heurística pode provavelmente ser aplicada:

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/fr/051.webp)

Fonte: [Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)

### A maior produção

Quando existe uma diferença significativamente grande entre dois resultados de uma transação num modelo de pagamento simples, pode estimar-se que o resultado maior será provavelmente o remanescente.

![BTC204](assets/it/33/09.webp)

Esta heurística da maior produção é provavelmente a mais imprecisa de todas. Quando identificada isoladamente, é bastante fraca. No entanto, esta caraterística pode ser combinada com outras heurísticas para reduzir a incerteza da nossa interpretação.

Por exemplo, se examinarmos uma transação que tem uma saída com um montante redondo e outra saída com um montante maior, a aplicação conjunta da heurística dos pagamentos redondos e da heurística relacionada com a saída maior permite-nos reduzir o nosso nível de incerteza.

Por exemplo, aqui está uma transação em que esta heurística pode provavelmente ser aplicada:

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/fr/053.webp)

Fonte: [Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## Heurísticas externas

<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>

O estudo das heurísticas externas consiste em analisar as semelhanças, os padrões e as caraterísticas de certos elementos que não são intrínsecos à própria transação. Por outras palavras, se anteriormente nos limitávamos a explorar elementos intrínsecos à transação com heurísticas internas, estamos agora a alargar o nosso campo de análise ao ambiente da transação através de heurísticas externas.

### Reutilização de endereços

Esta é uma das heurísticas mais conhecidas entre os entusiastas do Bitcoin. A reutilização de endereços permite estabelecer uma ligação entre diferentes transacções e diferentes UTXOs. Observa-se quando um endereço de receção de Bitcoin é usado várias vezes.

Assim, é possível explorar a reutilização de endereços dentro da mesma transação como uma heurística interna para identificar o restante (como vimos no capítulo anterior). No entanto, a reutilização de endereços também pode servir como uma heurística externa para reconhecer a singularidade de uma entidade por detrás de várias transacções.

A interpretação da reutilização de endereços é que todos os UTXOs bloqueados neste endereço pertencem (ou pertenceram) à mesma entidade. Esta heurística deixa pouco espaço para a incerteza. Quando pode ser identificada, a interpretação que se segue tem mais probabilidades de corresponder à realidade. Permite assim o agrupamento de diferentes actividades em cadeia.

![BTC204](assets/it/34/01.webp)

Como explicado na introdução desta Parte 3, esta heurística foi descoberta pelo próprio Satoshi Nakamoto. No Livro Branco, ele menciona especificamente uma solução para os utilizadores a evitarem, que consiste simplesmente em utilizar um novo endereço para cada nova transação:

"_Como proteção adicional, pode ser utilizado um novo par de chaves para cada transação, para evitar que sejam associadas a um proprietário comum."

![BTC204](assets/fr/055.webp)

Fonte: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System," https://bitcoin.org/bitcoin.pdf, 2009.

Por exemplo, aqui está um endereço reutilizado em várias transacções:

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

Fonte:[Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### Semelhança de scripts e impressões digitais de carteiras

Para além da reutilização de endereços, há uma série de outras heurísticas para associar acções ao mesmo portfólio ou a um grupo de endereços.

Em primeiro lugar, um analista pode tirar partido das semelhanças na utilização de scripts. Por exemplo, certos scripts minoritários, como o multisig, podem ser identificados mais facilmente do que os scripts SegWit V0. Quanto maior for o grupo em que nos escondemos, mais difícil é identificar-nos. É por isso que, em bons protocolos Coinjoin, todos os participantes usam exatamente o mesmo tipo de scripts.

De um modo mais geral, um analista pode também concentrar-se nas caraterísticas da impressão digital de uma carteira. Trata-se de processos específicos relacionados com a utilização que se pode tentar identificar com o objetivo de os explorar como heurística de seguimento. Por outras palavras, se se observar uma acumulação das mesmas caraterísticas internas nas transacções atribuídas à entidade seguida, pode-se tentar identificar essas mesmas caraterísticas noutras transacções.

Por exemplo, pode ser identificado que o utilizador rastreado envia sistematicamente o seu resto para endereços P2TR (`bc1p...`). Se este processo se repetir, pode ser usado como uma heurística para a continuação da nossa análise. Outras impressões digitais podem ser utilizadas, tais como a ordem dos UTXOs, a colocação do resto nas saídas, a sinalização RBF (Replace-by-Fee), ou mesmo, o número da versão, o campo `nSequence` e o campo `nLockTime`.

Como [@LaurentMT](https://twitter.com/LaurentMT) especifica em [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji) (um podcast francófono), a utilidade das impressões digitais das carteiras na análise da cadeia aumenta significativamente com o tempo. De facto, o número crescente de tipos de scripts e a implementação cada vez mais gradual destas novas capacidades pelo software das carteiras acentuam as diferenças. Pode mesmo dar-se o caso de se poder identificar com precisão o software utilizado pela entidade que está a ser rastreada. Por conseguinte, é importante compreender que o estudo da pegada digital de uma carteira se revela particularmente relevante para as transacções recentes, mais do que para as iniciadas no princípio da década de 2010.

Em resumo, uma impressão digital pode ser qualquer prática específica, realizada automaticamente pela carteira ou manualmente pelo utilizador, que pode ser encontrada noutras transacções para ajudar na nossa análise.

### A Heurística da Propriedade Comum dos Inputs (CIOH)

CIOH, para "Common Input Ownership Heuristic" em inglês, é uma heurística que afirma que quando uma transação inclui vários inputs, é provável que estes provenham de uma única entidade. Consequentemente, a sua propriedade é comum.

Para aplicar a Heurística da Propriedade Comum dos Inputs (CIOH), começamos por observar uma transação que tem vários inputs. Pode ser desde um mínimo de 2 entradas até um máximo de 30 entradas. Uma vez identificada esta caraterística, verificamos se a transação não se enquadra num modelo de transação conhecido. Por exemplo, se tiver 5 entradas com montantes aproximadamente iguais e 5 saídas com exatamente o mesmo montante, sabemos que se trata da estrutura de um coinjoin. Por conseguinte, não podemos aplicar a IOCH.

No entanto, se a transação não se enquadrar em nenhum modelo conhecido de transação colaborativa, então podemos inferir que todas as entradas são provavelmente da mesma entidade. Isto pode ser muito útil para expandir um cluster conhecido ou para continuar o rastreio.

O CIOH foi descoberto por Satoshi Nakamoto. Ele discute este facto na parte 10 do Livro Branco:

"_[...] a ligação é inevitável com transacções de múltiplas entradas, que revelam necessariamente que as suas entradas pertenciam ao mesmo proprietário. O risco é que, se o proprietário de uma chave for revelado, as ligações podem revelar outras transacções que pertenciam ao mesmo proprietário

É particularmente fascinante notar que Satoshi Nakamoto, mesmo antes do lançamento oficial da Bitcoin, já tinha identificado as duas principais vulnerabilidades de privacidade para os utilizadores, nomeadamente a IOCH e a reutilização de endereços. Esta previsão é bastante notável, uma vez que estas duas heurísticas continuam a ser, até hoje, as mais úteis na análise da cadeia de blocos.

Para dar um exemplo, eis uma transação à qual podemos provavelmente aplicar a IOCH:

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

Fonte: [Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### Dados offchain

Naturalmente, a análise on-chain não se limita exclusivamente aos dados on-chain. Os dados de análises anteriores ou disponíveis na Internet também podem ser utilizados para aperfeiçoar uma análise.

Por exemplo, se for observado que as transacções rastreadas são sistematicamente transmitidas a partir do mesmo nó Bitcoin e o seu endereço IP puder ser identificado, poderá ser possível identificar outras transacções da mesma entidade, bem como determinar parte da identidade do remetente. Embora esta prática não seja fácil de realizar, uma vez que requer muitos nós para funcionar, é possível que algumas empresas especializadas em análise de cadeias a utilizem.

O analista também tem a opção de se basear em análises previamente tornadas de código aberto ou nas suas próprias análises anteriores. Talvez seja possível encontrar um output que aponte para um grupo de endereços já identificado. Por vezes, também é possível basear-se num output que aponta para uma plataforma de troca, sendo os endereços destas empresas geralmente conhecidos.

Do mesmo modo, é possível efetuar uma análise por eliminação. Por exemplo, se durante a análise de uma transação com duas saídas, uma delas estiver ligada a um grupo de endereços já conhecido mas distinto da entidade que está a ser rastreada, então pode ser interpretado que a outra saída representa provavelmente o resto.

A análise em cadeia inclui também uma parte de OSINT (_Open Source Intelligence_) que é um pouco mais generalista com as pesquisas na Internet. É por esta razão que não se recomenda a publicação de endereços de receção diretamente nas redes sociais ou num sítio Web, seja sob pseudónimo ou não.

![BTC204](assets/fr/063.webp)

### Padrões temporais

É menos comummente considerado, mas certos comportamentos humanos são reconhecíveis na cadeia. O mais útil na análise pode ser o seu padrão de sono! Sim, quando se dorme, presumivelmente não se está a transmitir transacções Bitcoin. Como você geralmente dorme nos mesmos horários, é comum usar a análise temporal na análise on-chain. Isso envolve simplesmente catalogar os horários em que as transações de uma determinada entidade são transmitidas para a rede Bitcoin. Analisar estes padrões temporais permite-nos inferir muita informação.

Em primeiro lugar, uma análise temporal permite, por vezes, identificar a natureza da entidade que está a ser seguida. Se se observar que as transacções são transmitidas de forma consistente ao longo de 24 horas, isso revelará uma forte atividade económica. A entidade por detrás destas transacções é provavelmente uma empresa, potencialmente internacional, e talvez com procedimentos automatizados internamente.

Por exemplo, [tinha reconhecido este padrão há alguns meses] (https://twitter.com/Loic_Pandul/status/1701127409712452072) ao analisar [a transação que tinha atribuído erradamente 19 bitcoins em taxas] (https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd). Uma simples análise temporal permitiu-me supor que se tratava de um serviço automatizado e, portanto, provavelmente de uma grande entidade, como uma plataforma de câmbio.

De facto, alguns dias depois, descobriu-se que os fundos pertenciam ao PayPal, através da plataforma de câmbio Paxos.

Por outro lado, se virmos que o padrão de tempo está bastante espalhado por 16 horas muito específicas, então podemos estimar que estamos a lidar com um utilizador individual, ou talvez com uma empresa local, dependendo dos volumes transaccionados.

Para além da natureza da entidade observada, o modelo temporal também nos pode dar uma localização aproximada do utilizador através dos fusos horários. Podemos então ligar outras transacções e utilizar os carimbos temporais destas como heurísticas adicionais que podem ser adicionadas à nossa análise.

Por exemplo, no endereço reutilizado que mencionei anteriormente, podemos observar que as transacções, tanto de entrada como de saída, estão concentradas num intervalo de 13 horas.

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/064.webp)

Fonte: OXT.me

Este intervalo corresponde provavelmente à Europa, África ou Médio Oriente. Podemos, portanto, inferir que o utilizador por detrás destas transacções vive aí.

Num registo diferente, foi também esta análise temporal que permitiu a hipótese de Satoshi Nakamoto não estar a operar a partir do Japão, mas sim dos Estados Unidos: [_The Time Zones of Satoshi Nakamoto_](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## Aplicação prática com um explorador de blocos

<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

Neste último capítulo, vamos aplicar concretamente os conceitos que estudámos até agora. Apresentarei exemplos de transacções reais de Bitcoin, e terá de extrair as informações que lhe peço.

Idealmente, para estes exercícios, seria preferível a utilização de uma ferramenta profissional de análise de cadeias. No entanto, após o encerramento dos criadores da Samourai Wallet, a única ferramenta de análise gratuita OXT.me não está mais disponível. Portanto, vamos optar por um explorador de blocos clássico para esses exercícios. Recomendo a utilização do [Mempool.space](https://mempool.space/) pelas suas muitas funcionalidades e variedade de ferramentas de análise de cadeias, mas também pode escolher outro explorador como o [Bitcoin Explorer](https://bitcoinexplorer.org/). Para começar, vou apresentar os exercícios. Utilize o seu explorador de blocos para os completar e escreva as suas respostas numa folha de papel. Depois, no final deste capítulo, vou fornecer as respostas para que possas verificar e corrigir os teus resultados.

_As transacções selecionadas para estes exercícios foram escolhidas apenas pelas suas caraterísticas, de forma algo aleatória. Este capítulo destina-se apenas a fins educativos e informativos. Quero deixar claro que não defendo nem encorajo a utilização destas ferramentas para fins maliciosos. O objetivo é ensiná-lo a proteger-se da análise de cadeias e não a realizar análises para expor informações privadas de terceiros

### Exercício 1

ID da transação a ser analisada:

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

Qual é o nome do modelo desta transação e que interpretações plausíveis podem ser extraídas examinando apenas o seu modelo, ou seja, a estrutura da transação?

### Exercício 2

ID da transação a ser analisada:

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

Qual é o nome do modelo desta transação e que interpretações plausíveis podem ser extraídas examinando apenas o seu modelo, ou seja, a estrutura da transação?

### Exercício 3

ID da transação a ser analisada:

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

Qual é o padrão desta transação?

Depois de identificar o seu modelo, utilizando as heurísticas internas da transação, qual é o output que provavelmente representará o resto?

### Exercício 4

ID da transação a ser analisada:

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

Qual é o padrão desta transação?

Depois de identificar o seu modelo, utilizando as heurísticas internas da transação, qual é o output que provavelmente representará o resto?

### Exercício 5

Imaginemos que Loïc colocava um dos seus endereços Bitcoin para receber pagamentos na rede social Twitter:

![BTC204](assets/fr/065.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

Usando **apenas a heurística de reutilização de endereços**, que transacções Bitcoin podemos associar à identidade de Loïc?

_Obviamente, não sou o verdadeiro proprietário deste endereço de receção e não o publiquei nas redes sociais. É um endereço que escolhi aleatoriamente na cadeia de blocos

### Exercício 6

Após o Exercício 5, utilizando a heurística de reutilização de endereços, conseguiu identificar várias transacções Bitcoin em que Loïc parece estar envolvido. Normalmente, entre as transacções identificadas, deveria ter identificado esta:

Esta transação é a primeira que envia fundos para o endereço de Loïc. De onde achas que vieram os bitcoins recebidos por Loïc através desta transação?

### Exercício 7

Após o Exercício 5, utilizando a heurística de reutilização de endereços, conseguiu identificar várias transacções Bitcoin em que Loïc parece estar envolvido. Agora deseja descobrir de onde Loïc veio. Com base nas transacções encontradas, efectue uma análise temporal para encontrar o fuso horário provável utilizado por Loïc. A partir deste fuso horário, determine o local onde Loïc parece viver (país, estado/região, cidade...).

### Exercício 8

Aqui está a transação Bitcoin para estudar:

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

Olhando apenas para esta transação, que informações podemos interpretar?

### Soluções para os exercícios

**Exercício 1:_**

O modelo desta transação é o de um simples pagamento. Se estudarmos apenas a sua estrutura, podemos interpretar que uma saída representa a mudança e a outra saída representa um pagamento efetivo. Sabemos então que o utilizador observado provavelmente já não está na posse de um dos dois UTXOs nos outputs (o do pagamento), mas ainda está na posse do outro UTXO (o do troco).

**Exercício 2:_**

O padrão desta transação é o de uma despesa em lote. Este padrão indica provavelmente uma atividade económica significativa, como uma plataforma de troca. Podemos inferir que o UTXO de entrada provém de uma empresa com uma atividade económica significativa e que os UTXOs de saída se dispersarão. Alguns pertencerão aos clientes da empresa que retiraram os seus bitcoins para carteiras de auto-armazenamento. Outros poderão ir para empresas parceiras. Por fim, haverá certamente um remanescente que regressará à empresa emissora.

**Exercício 3:_**

O modelo desta transação é o de um simples pagamento. Por conseguinte, podemos aplicar heurísticas internas à transação para tentar identificar o resto.

Pessoalmente, identifiquei pelo menos duas heurísticas internas que apoiam a mesma hipótese:


- A reutilização do mesmo tipo de guião;
- Maior produção.

A heurística mais óbvia é a reutilização do mesmo tipo de script. De facto, o output `0` é um `P2SH`, reconhecível pelo seu endereço de receção que começa por `3`:

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

Enquanto a saída `1` é um `P2WPKH`, identificável pelo seu endereço que começa por `bc1q`:

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

O UTXO utilizado como entrada para esta transação também utiliza um script `P2WPKH`:

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

Assim, podemos assumir que a saída `0` corresponde a um pagamento e a saída `1` é o resto da transação, o que significa que o utilizador de entrada ainda possui a saída `1`.

Para apoiar ou refutar esta hipótese, podemos procurar outras heurísticas que confirmem o nosso pensamento ou diminuam a probabilidade de a nossa hipótese estar correta.

Identifiquei pelo menos uma outra heurística. É a maior saída. A saída `0` mede `123.689 sats`, enquanto a saída `1` mede `505.839 sats`. Existe, portanto, uma diferença significativa entre estas duas saídas. A heurística da maior saída sugere que a saída mais volumosa é provavelmente a restante. Esta heurística reforça assim ainda mais a nossa hipótese inicial.

Parece provável que o utilizador que forneceu a entrada UTXO ainda tenha a saída `1`, que parece representar o resto da transação.

**Exercício 4:_**

O modelo desta transação é o de um simples pagamento. Por conseguinte, podemos aplicar heurísticas internas à transação para tentar identificar o resto.

Pessoalmente, identifiquei pelo menos duas heurísticas internas que apoiam a mesma hipótese:


- A reutilização do mesmo tipo de guião;
- A saída de um montante redondo.

A heurística mais óbvia é a reutilização do mesmo tipo de script. De facto, o output `0` é um `P2SH`, reconhecível pelo seu endereço de receção que começa por `3`:

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

Enquanto a saída `1` é um `P2WPKH`, identificável pelo seu endereço que começa por `bc1q`:

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

O UTXO utilizado como entrada para esta transação também utiliza um script `P2WPKH`:

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

Assim, podemos assumir que a saída `0` corresponde a um pagamento e a saída `1` é o resto da transação, o que significaria que o utilizador de entrada ainda detém a saída `1`.

Para apoiar ou refutar esta hipótese, podemos procurar outras heurísticas que confirmem o nosso pensamento ou diminuam a probabilidade de a nossa hipótese estar correta.

Identifiquei pelo menos uma outra heurística. É a saída de uma quantidade redonda. A saída `0` mede `70.000 sats`, enquanto a saída `1` mede `22.962 sats`. Portanto, estamos a lidar com uma saída perfeitamente redonda em unidades de conta BTC. A heurística da saída redonda sugere que o UTXO com um valor redondo é provavelmente o pagamento e, por eliminação, o outro representa o restante. Por conseguinte, esta heurística reforça ainda mais a nossa hipótese inicial.

No entanto, neste exemplo, outra heurística pode desafiar a nossa suposição inicial. De facto, o output `0` é maior que o output `1`. Se basearmos o nosso raciocínio na heurística de que o maior resultado é geralmente o resto, podemos inferir que o resultado `0` é o resto. No entanto, esta contra-hipótese parece pouco plausível, uma vez que as outras duas heurísticas parecem substancialmente mais convincentes do que a heurística do maior resultado. Por conseguinte, parece razoável manter a nossa hipótese inicial apesar desta aparente contradição.

Por conseguinte, parece provável que o utilizador que forneceu o UTXO como entrada ainda detenha a saída `1`, que parece representar o resto da transação.

**Exercício 5:_**

Podemos ver que 8 transacções podem ser associadas à identidade de Loïc. Destas, 4 envolvem a receção de bitcoin:

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
8b70bd322e6118b8a002dbdb731d16b59c4a729c2379af376ae230cf8cdde0dd
d5864ea93e7a8db9d3fb113651d2131567e284e868021e114a67c3f5fb616ac4
bc4dcf2200c88ac1f976b8c9018ce70f9007e949435841fc5681fd33308dd762
```

As outras 4 são sobre o envio de bitcoin:

```plaintext
8b52fe3c2cf8bef60828399d1c776c0e9e99e7aaeeff721fff70f4b68145d540
c12499e9a865b9e920012e39b4b9867ea821e44c047d022ebb5c9113f2910ed6
a6dbebebca119af3d05c0196b76f80fdbf78f20368ebef1b7fd3476d0814517d
3aeb7ce02c35eaecccc0a97a771d92c3e65e86bedff42a8185edd12ce89d89cc
```

**Exercício 6:_**

Se examinarmos o padrão desta transação, é evidente que se trata de uma despesa agrupada. De facto, a transação tem uma única entrada e 51 saídas, o que indica uma atividade económica significativa. Podemos, portanto, supor que Loïc fez um levantamento de bitcoin numa plataforma de câmbio.

Vários elementos reforçam esta hipótese. Em primeiro lugar, o tipo de script utilizado para proteger o UTXO de entrada é um script P2SH multisig 2/3, o que indica um nível avançado de segurança típico das plataformas de troca:

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```

Além disso, o endereço analisado `3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF` foi reutilizado em mais de 220.000 transacções diferentes, o que é muitas vezes caraterístico de plataformas de troca que geralmente não se preocupam com a sua privacidade. As heurísticas temporais aplicadas a este endereço também mostram uma propagação regular de transacções quase diárias ao longo de um período de 3 meses, com horas prolongadas ao longo de 24 horas, sugerindo a atividade contínua de uma plataforma de troca.

Finalmente, os volumes processados por esta entidade são enormes. Na verdade, o endereço recebeu e enviou 44 BTC durante 222.262 transações entre dezembro de 2022 e março de 2023. Esses volumes significativos confirmam ainda mais a natureza provável da atividade de uma plataforma de câmbio.

**Exercício 7:_**

Analisando as horas de confirmação da transação, podem ser observadas as seguintes horas UTC:

```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

Ao analisar estes horários, é evidente que os fusos horários UTC-7 e UTC-8 são consistentes com uma gama de actividades humanas comuns (entre as 8h00 e as 23h00) na maioria dos horários:

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7
05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

O fuso horário UTC-7 é particularmente relevante no verão, uma vez que inclui estados e regiões como


- Califórnia (com cidades como Los Angeles, São Francisco e San Diego);
- Nevada (com Las Vegas);
- Oregon (com Portland);
- Washington (com Seattle);
- A região canadiana da Colúmbia Britânica (com cidades como Vancouver e Victoria).

Estas informações sugerem que Loïc poderia residir na costa oeste dos Estados Unidos ou no Canadá.

**Exercício 8:_**

A análise desta transação revela 5 entradas e uma única saída, o que parece indicar consolidação. A aplicação da heurística CIOH sugere que todos os UTXOs nas entradas são detidos por uma única entidade, e que o UTXO na saída também pertence a esta entidade. Parece que o utilizador escolheu consolidar vários UTXOs que lhe pertencem num único UTXO na saída, com o objetivo de consolidar as suas próprias moedas. Esta abordagem foi provavelmente motivada por um desejo de tirar partido das baixas taxas de transação do momento para reduzir as taxas futuras.

---
_Para a redação desta Parte 3 sobre a análise em cadeia, baseei-me nos seguintes recursos


- _A série de quatro artigos intitulada: [Understanding Bitcoin Privacy with OXT] (https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923), produzida pela Samourai Wallet em 2021;_
- _Os vários relatórios da [OXT Research] (https://medium.com/oxt-research), bem como a sua ferramenta gratuita de análise da cadeia (que já não está disponível na sequência da detenção dos fundadores da Samourai Wallet)
- _De um modo mais geral, os meus conhecimentos provêm dos vários tweets e conteúdos de [@LaurentMT](https://twitter.com/LaurentMT) e [@ErgoBTC](https://twitter.com/ErgoBTC);_
- \_O [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji) no qual participei juntamente com [@louneskmt](https://twitter.com/louneskmt), [@TheoPantamis](https://twitter.com/TheoPantamis), [@Sosthene\_\_](https://twitter.com/Sosthene___) e [@LaurentMT](https://twitter.com/LaurentMT).\_

gostaria de agradecer aos seus autores, criadores e produtores. Obrigado também aos revisores que corrigiram meticulosamente o artigo que serviu de base a esta parte 3 e me honraram com os seus conselhos de especialistas:_


- _[Gilles Cadignan](https://twitter.com/gillesCadignan);_
- _[Ludovic Lars](https://viresinnumeris.fr/)._

# Dominar as melhores práticas para proteger a sua privacidade

<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## Reutilização de endereços

<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>

Tendo estudado as técnicas que podem comprometer a sua privacidade no Bitcoin, nesta terceira parte, vamos agora examinar as melhores práticas que pode adotar para se proteger. Esta parte não tem como objetivo explorar métodos para melhorar a privacidade, um tópico que será abordado mais tarde, mas sim entender como interagir corretamente com o Bitcoin para manter a privacidade que ele naturalmente oferece, sem recorrer a técnicas adicionais.

Naturalmente, para começar esta terceira parte, vamos falar da reutilização de endereços. Este fenómeno é a principal ameaça à privacidade dos utilizadores. Por isso, este capítulo é provavelmente o mais importante de todo o curso.

### O que é um endereço de receção?

Um endereço de receção de bitcoin é uma cadeia de caracteres ou um identificador utilizado para receber bitcoin numa carteira.

Tecnicamente, um endereço de receção de bitcoin não "recebe" bitcoin no sentido literal, mas define as condições em que os bitcoins podem ser gastos. Especificamente, quando um pagamento é enviado para si, a transação do remetente cria um novo UTXO destinado a si na saída dos UTXOs que consumiu nas entradas. Neste output, é aplicado um script que define como este UTXO pode ser gasto mais tarde. Este script é conhecido como "_ScriptPubKey_" ou "_Locking Script_" O teu endereço de receção, mais precisamente o seu payload, está incorporado neste script. Para simplificar, este script diz essencialmente o seguinte:

> "_Para gastar este novo UTXO, deve ser fornecida uma assinatura digital utilizando a chave privada associada a este endereço de receção
![BTC204](assets/fr/067.webp)

Os endereços Bitcoin vêm em diferentes tipos, dependendo do modelo de script utilizado. Os primeiros modelos, conhecidos como "_Legacy_", incluem endereços `P2PKH` (_Pay-to-PubKey-Hash_) e `P2SH` (_Pay-to-Script-Hash_). Os endereços P2PKH começam sempre com `1` e os P2SH com `3`. Embora ainda sejam seguros, estes formatos estão agora obsoletos, uma vez que implicam taxas de transação mais elevadas e oferecem menos privacidade do que as novas normas.

Os endereços SegWit V0 (`P2WPKH` e `P2WSH`) e Taproot / SegWit V1 (`P2TR`) representam formatos modernos. Os endereços SegWit começam com `bc1q` e os endereços Taproot, introduzidos em 2021, começam com `bc1p`.

Por exemplo, aqui está um endereço de receção Taproot:

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

A forma como a ScriptPubKey é construída dependerá da norma que estiver a ser utilizada:

| Script Template | ScriptPubKey || ---------------- | ----------------------------------------------------------- | ----------------------------------------------------------- |

| P2PKH | OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG |

| P2SH | OP_HASH160 `<scriptHash>` OP_EQUAL |

| P2WPKH | 0 `<pubKeyHash>` |

| P2WSH | 0 `<witnessScriptHash>` |

| P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL |

| P2SH - P2WSH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL |

| P2TR | 1 `<pubKey>` |

Quanto à construção dos endereços de receção, também depende do modelo de guião escolhido:


- Para os endereços `P2PKH` e `P2WPKH`, a carga útil, ou o núcleo do endereço, representa o hash da chave pública;
- Para os endereços `P2SH` e `P2WSH`, o payload representa o hash de um script;
- Quanto aos endereços `P2TR`, o payload é uma chave pública modificada. As saídas `P2TR` combinam aspectos de _Pay-to-PubKey_ e _Pay-to-Script_. A chave pública modificada é o resultado da adição de uma chave pública de gasto clássica com uma "modificação", derivada da raiz Merkle de um conjunto de scripts que também podem ser usados para gastar bitcoin.

![BTC204](assets/it/67/01.webp)

Os endereços exibidos no software da sua carteira também incluem um HRP (_Human-Readable Part_), tipicamente `bc` para endereços pós-SegWit, um separador `1`, e um número de versão `q` para SegWit V0 e `p` para Taproot/SegWit V1. Um checksum também é adicionado para garantir a integridade e validade do endereço durante sua transmissão.

Por fim, os endereços são colocados num formato normalizado:


- Base58check para endereços Legacy antigos;
- Bech32 para endereços SegWit;
- Bech32m para endereços Taproot.

Aqui está a matriz de adição para os formatos bech32 e bech32m (SegWit e Taproot) a partir da base 10:

| + | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| 0 | q | p | z | r | y | 9 | x | 8 | 8

| 8 | g | f | 2 | t | v | d | w | 0 |

| 16 | s | 3 | j | n | 5 | 4 | k | h | | 24 | c | e | 6 | m | u | a | 7 | l | l

### O que é a reutilização de endereços?

A reutilização de endereços refere-se à prática de utilizar o mesmo endereço de receção para bloquear vários UTXOs diferentes.

Como vimos na secção anterior, cada UTXO tem a sua própria ScriptPubKey que o bloqueia e que tem de ser satisfeita para que o UTXO possa ser consumido como entrada numa nova transação. É dentro desta ScriptPubKey que os endereços de receção (payloads) são incorporados.

Quando várias ScriptPubKeys contêm o mesmo endereço de receção, isto é conhecido como reutilização de endereço. Na prática, isto significa que um utilizador forneceu o mesmo endereço várias vezes a remetentes para receber bitcoin através de vários pagamentos. E, de facto, esta prática é catastrófica para a sua privacidade.

### Porque é que a reutilização de endereços é um problema?

Como a blockchain é pública, é fácil ver quais endereços bloqueiam quais UTXOs e quantos bitcoins. Se o mesmo endereço for utilizado para várias transacções, torna-se possível inferir que todos os bitcoins associados a esse endereço pertencem à mesma pessoa. Esta prática compromete a privacidade do utilizador ao permitir o estabelecimento de ligações determinísticas entre diferentes transacções e o rastreio de bitcoins na blockchain. O próprio Satoshi Nakamoto destacou este problema no Livro Branco da Bitcoin:

> _Como firewall adicional, pode ser utilizado um novo par de chaves para cada transação para evitar que sejam ligadas a um proprietário comum
![BTC204](assets/fr/055.webp)

Fonte: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System," https://bitcoin.org/bitcoin.pdf, 2009.

O objetivo pretendido por Satoshi com esta declaração era criar uma firewall adicional em caso de associação entre a identidade do utilizador e um par de chaves na Bitcoin, para evitar que toda a sua atividade fosse publicamente associada à sua identidade. Atualmente, com a proliferação de empresas de análise de blockchain e regulamentos KYC, a utilização de endereços únicos já não é uma "firewall adicional", mas sim uma prática necessária para qualquer pessoa que pretenda preservar, no mínimo, a sua privacidade.

Quando se reutiliza um endereço, cria-se uma ligação quase indiscutível entre todas as transacções associadas a esse endereço. Embora isto não ponha diretamente em perigo os seus fundos, porque a encriptação em curvas elípticas garante a segurança das suas chaves privadas, torna mais fácil monitorizar as suas actividades. De facto, qualquer pessoa com um nó pode observar as suas transacções e os saldos dos seus endereços, comprometendo completamente o seu anonimato.

![BTC204](assets/it/34/01.webp)

Para ilustrar este ponto, tomemos o exemplo do Bob, um utilizador que compra regularmente bitcoins em pequenas quantidades através do Dollar Cost Averaging (DCA) e os envia sempre para o mesmo endereço. Após dois anos, este endereço contém uma quantidade substancial de bitcoin. Se Bob utilizar este endereço para efetuar um pagamento a um comerciante local, o comerciante poderá ver todos os fundos associados e deduzir o património de Bob. Isto pode levar a riscos de segurança pessoal, incluindo tentativas de roubo ou extorsão. Se Bob tivesse usado um novo endereço para receber cada compra periódica, teria revelado infinitamente menos informações ao comerciante.

Na análise da cadeia, distinguimos dois tipos de reutilização de endereços:


- Reutilização externa;
- Reutilização interna numa transação.

A primeira é observada quando um endereço é reutilizado em várias transacções Bitcoin diferentes. É o que discutimos anteriormente: esta heurística permite-nos inferir que todos os UTXOs que passam por este endereço pertencem a uma única entidade.

A reutilização de endereços internos é observada não quando a reutilização ocorre em várias transacções, mas quando ocorre dentro da mesma transação. Com efeito, se o mesmo endereço que foi utilizado para bloquear uma entrada for utilizado como saída numa transação, então podemos inferir que esta saída ainda pertence ao mesmo utilizador (restante) e que a segunda saída representa o pagamento real. Esta outra heurística permite que os fundos sejam rastreados em várias transacções.

![BTC204](assets/it/33/02.webp)

A reutilização de endereços é um verdadeiro flagelo para a Bitcoin. De acordo com o sítio Web OXT.me (atualmente inacessível), a taxa global de reutilização de endereços na Bitcoin era de cerca de 52% em 2022:

![BTC204](assets/fr/069.webp)

Esta taxa é enorme, mas provém, na sua esmagadora maioria, de plataformas de intercâmbio e não de utilizadores individuais.

### Como evitar a reutilização de endereços?

Evitar a reutilização de endereços é bastante simples: **Basta utilizar um novo endereço para cada novo pagamento recebido na sua carteira**.

Graças ao BIP32, as carteiras modernas são agora determinísticas e hierárquicas. Isto significa que um utilizador pode gerar um grande número de endereços a partir de uma única informação inicial: a semente. Ao guardar esta informação única, todas as chaves privadas da carteira podem ser restauradas, acedendo assim aos fundos garantidos pelos endereços correspondentes.

![BTC204](assets/fr/070.webp)

É por isso que, quando prime o botão "_receive_" no software da sua carteira, é-lhe sempre oferecido um endereço de receção não utilizado. Depois de receber bitcoin neste endereço, o software sugere automaticamente um novo endereço.

> pS: Recentemente, alguns softwares de carteira anunciaram a sua intenção de deixar de gerar endereços em branco, receando que tal possa ser entendido como uma forma de branqueamento de capitais pelas autoridades. Se o seu software se encontra entre eles, aconselho-o vivamente a substituí-lo imediatamente, pois tal não é aceitável para o utilizador
Se precisar de um identificador estático para receber pagamentos, como para receber donativos, por exemplo, a utilização de um endereço Bitcoin clássico não é recomendada devido ao risco de reutilização. Prefere utilizar um endereço Lightning ou, para um identificador de pagamento onchain estático, pode optar por BIP47 ou Silent Payments. O funcionamento destes protocolos é detalhado na Parte 6 desta formação.

## Etiquetagem e controlo de moedas

<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>

Tal como descobrimos na secção sobre análise de cadeias, existe uma grande quantidade de heurísticas e padrões que podem ser utilizados para inferir informações sobre uma transação. Como utilizador, é importante estar ciente destas técnicas para se proteger melhor.

Isto implica uma gestão rigorosa da carteira sob custódia pessoal, que inclui o conhecimento da origem dos UTXOs, bem como uma seleção cuidadosa dos UTXOs a serem consumidos durante os pagamentos. Esta gestão eficaz da carteira assenta em duas caraterísticas importantes das boas carteiras Bitcoin: etiquetagem e controlo de moedas.

Neste capítulo, estudaremos essas caraterísticas e veremos como você pode usá-las de forma inteligente, sem adicionar muita carga de trabalho, para otimizar muito sua privacidade no Bitcoin.

### O que é a rotulagem?

A marcação é uma prática que envolve a atribuição de uma anotação ou etiqueta a um UTXO específico numa carteira Bitcoin. Estas anotações são armazenadas localmente pelo software da carteira e nunca são transmitidas através da rede Bitcoin. A marcação é, portanto, uma ferramenta de gestão pessoal.

Por exemplo, se eu possuir um UTXO de uma compra P2P no Bisq com Charles, posso atribuir-lhe a etiqueta "`Non-KYC Bisq Charles`".

A marcação é uma boa prática que ajuda a lembrar a origem ou o destino pretendido de um UTXO, facilitando assim a gestão de fundos e optimizando a privacidade. De facto, é provável que a sua carteira Bitcoin contenha vários UTXOs. Se as fontes destes UTXOs forem diferentes, pode não querer fundir estes UTXOs no futuro, caso contrário pode revelar a sua propriedade comum. Ao etiquetar corretamente todas as suas moedas, garante que se lembrará da sua origem quando precisar delas, mesmo que isso só aconteça daqui a vários anos.

### O que é o controlo de moedas?

A utilização ativa da marcação torna-se ainda mais atractiva quando combinada com a opção de controlo de moedas no software da carteira.

O controlo de moedas é uma caraterística encontrada num bom software de carteira Bitcoin que lhe dá a capacidade de selecionar manualmente UTXOs específicos para utilizar como entrada para realizar uma transação. De facto, para satisfazer um pagamento de saída, é necessário consumir um UTXO de entrada em troca. Por várias razões que veremos mais tarde, pode querer escolher exatamente quais as moedas a consumir como entrada para satisfazer um determinado pagamento. É exatamente isto que o controlo de moedas permite. Para fazer uma analogia, esta funcionalidade é semelhante à ação de escolher uma moeda específica na sua carteira quando paga a sua baguete.

A utilização de software de carteiras controladas por moedas, combinada com a etiquetagem dos UTXOs, permite aos utilizadores distinguir e selecionar com precisão os UTXOs para as suas transacções.

### Como rotular corretamente os seus UTXOs?

Não existe um método universal de rotulagem de UTXOs que sirva para todos. Cabe-lhe a si definir um sistema de rotulagem para que possa navegar facilmente na sua carteira. Em qualquer caso, tenha em mente que uma boa rotulagem é o que você será capaz de entender quando precisar. Se a sua carteira de Bitcoin é principalmente para poupança, pode ser que os rótulos não sejam úteis para si até várias décadas a partir de agora. Por isso, certifique-se de que são claras, precisas e inclusivas.

É importante que os seus entes queridos possam identificar facilmente a origem dos fundos se, um dia, precisarem de aceder à sua carteira. Isto pode ajudá-los por razões de privacidade, bem como por necessidades legais, caso tenham de justificar a origem dos fundos perante uma autoridade.

O aspeto mais importante da etiquetagem é indicar a origem da UTXO. Deve simplesmente indicar como esta moeda chegou à sua carteira. Veio de uma compra numa plataforma de troca? Um pagamento de um cliente? Uma troca peer-to-peer? Ou é o remanescente de uma compra? Assim, pode especificar:


- pickup Exchange.com";
- `Cliente de pagamento David`;
- comprar P2P Charles;
- `Retenção da compra do sofá`

Para aperfeiçoar a sua gestão de UTXOs e aderir às suas estratégias de segregação de fundos dentro da sua carteira, pode enriquecer os seus rótulos com um marcador adicional para refletir estas separações. Se a sua carteira contiver duas categorias de UTXOs que não deseja misturar, pode integrar um marcador nas suas etiquetas para distinguir claramente estes grupos. Estes marcadores de separação dependerão dos seus critérios, tais como a distinção entre UTXOs de um processo de aquisição que envolva KYC, ou entre fundos profissionais e pessoais. Tomando os exemplos de etiquetas mencionados anteriormente, isto poderia traduzir-se em:


- `KYC - Retirada da Exchange.com`;
- `KYC - Customer Payment David`;
- sem KYC - Compra P2P Charles;
- sem KYC - Restante da compra do sofá

Também é aconselhável perpetuar a rotulagem de uma moeda durante as transacções. Por exemplo, ao consolidar UTXOs sem KYC, certifique-se de marcar o UTXO resultante não apenas como `consolidação`, mas especificamente como `consolidação sem KYC` para manter um traço claro da origem da moeda.

Por último, não é obrigatório colocar uma data numa etiqueta. A maioria dos programas de carteira já mostra a data da transação e é sempre possível obter esta informação num explorador de blocos utilizando o seu TXID.

### Como escolher corretamente as suas moedas?

Quando se faz uma transação, o controlo de moedas permite-lhe escolher especificamente quais os UTXOs a consumir como entrada para satisfazer a saída do pagamento. Dois aspectos devem ser considerados nesta escolha:


- A possibilidade de o destinatário do pagamento associar uma parte da sua identidade aos UTXOs utilizados como entrada;
- A capacidade de um observador externo estabelecer ligações entre todos os UTXOs consumidos como entrada.

Para ilustrar o primeiro ponto, vejamos um exemplo concreto. Suponhamos que compra uma baguete com bitcoins ao seu padeiro local. Utiliza uma ou mais UTXOs suas como entrada para cobrir pelo menos o preço da baguete na saída, mais as taxas de transação. O padeiro pode então associar o seu rosto, ou qualquer outra parte da sua identidade que ele conheça, às moedas utilizadas como entrada. Sabendo da existência desta ligação, poderás preferir escolher um UTXO específico em vez de outro quando fizeres o pagamento.

Por exemplo, se um dos seus UTXOs for proveniente de uma plataforma de troca e preferir que o padeiro não tenha conhecimento da sua conta nesta plataforma, evitaria utilizar este UTXO para pagamento. Se tiver um UTXO de valor elevado que revele uma quantidade significativa de bitcoin, também pode optar por não o utilizar para evitar que o padeiro conheça a sua fortuna em BTC.

A escolha dos UTXOs a utilizar para este primeiro ponto baseia-se, portanto, numa decisão pessoal, influenciada pelo que está disposto a revelar ou não. Os rótulos que atribuiu aos seus UTXOs aquando da sua receção ajudá-lo-ão a selecionar aqueles que, quando gastos, mostram apenas a informação que se sente confortável em revelar ao destinatário.

Para além da informação potencialmente revelada ao destinatário, a sua escolha de inputs também afecta o que revela a todos os observadores da blockchain. De facto, ao utilizar múltiplos UTXOs como inputs para a sua transação, revela que são propriedade da mesma entidade, de acordo com a Heurística de Propriedade Comum de Inputs (CIOH).

Quando seleciona as suas moedas, deve, portanto, estar ciente de que a transação que está prestes a transmitir criará uma ligação entre todos os UTXOs utilizados. Esta ligação pode ser problemática para a sua privacidade pessoal, especialmente se os UTXOs forem provenientes de fontes diferentes.

Voltando ao exemplo do meu UTXO sem KYC da Bisq, quero evitar combiná-lo com um UTXO de, digamos, uma plataforma de troca regulamentada que conhece a minha identidade. De facto, se eu alguma vez utilizasse estes dois UTXOs como inputs na mesma transação, a plataforma regulamentada poderia associar a minha identidade ao UTXO que comprei no Bisq, quando antes não estava associado à minha identidade.

Finalmente, para escolher corretamente quais os UTXOs a consumir como entrada para uma transação, o mais importante é evitar utilizar vários UTXOs. Sempre que possível, selecione uma única moeda que seja suficientemente grande para cobrir o seu pagamento. Ao fazê-lo, evita completamente os riscos associados ao COINJOIN. No entanto, se nenhum UTXO individual for suficiente para o seu pagamento e tiver de consumir vários, certifique-se de que provêm de fontes semelhantes para minimizar os riscos de ligações indesejadas. Além disso, lembre-se de que o destinatário pode associar as informações que tem sobre si ao histórico das moedas utilizadas como entrada.

### Compreender a seleção automática de moedas

Nas secções anteriores, discutimos a seleção manual de UTXOs para uma transação. Mas o que acontece quando o software da carteira faz esta seleção automaticamente? Existem vários métodos para determinar quais moedas consumir, e a seleção de UTXOs é um verdadeiro campo de pesquisa em Bitcoin. O principal objetivo deste processo automático é frequentemente minimizar as taxas de transação para o utilizador.

Os métodos de seleção UTXO, como o FIFO (_First In First Out_) e o LIFO (_Last In First Out_), estão entre os mais simples, mas também são os menos eficientes. Com o FIFO, as moedas mais antigas da carteira são utilizadas em primeiro lugar. Esta abordagem é geralmente ineficiente tanto para minimizar as taxas de transação como para preservar a privacidade, exceto nos casos em que são utilizados timelocks relativos que têm de ser renovados regularmente. Em contrapartida, o LIFO dá prioridade à utilização dos UTXOs mais recentes. Embora simples, estes dois métodos revelam-se frequentemente ineficientes.

Um método mais avançado é o _Knapsack Solver_. Este foi o método usado na carteira Bitcoin Core até a versão 0.17. Envolve a seleção iterativa e aleatória de UTXOs da carteira, somando-os em subgrupos, e mantendo a solução que reduz o peso da transação tanto quanto possível, a fim de reduzir as taxas de utilização.

O _Branch-and-Bound_ (BNB), muitas vezes apelidado de "algoritmo de Murch" em referência ao seu inventor, substituiu o _Knapsack Solver_ no Bitcoin Core a partir da versão 0.17. Este método mais avançado visa encontrar um conjunto de UTXOs que corresponda exatamente ao montante necessário para satisfazer os outputs de uma transação. O objetivo do BNB é minimizar a quantidade de remanescente, bem como as taxas, reduzindo o que é chamado o critério de desperdício que tem em conta tanto os custos imediatos como os custos futuros esperados para o remanescente. Este método é derivado do conceito original _Branch-and-Bound_, concebido em 1960 por Ailsa Land e Alison Harcourt, e oferece uma otimização mais precisa das comissões do que o _Knapsack Solver_.

Todos estes métodos de seleção automática de UTXOs podem ser eficazes na redução das taxas de transação, mas são frequentemente ineficientes na preservação da privacidade do utilizador. De facto, estes algoritmos podem fundir vários UTXOs na entrada, revelando assim uma propriedade comum destes UTXOs devido ao COH. Obviamente, estes métodos não podem ter em conta as etiquetas associadas aos UTXOs, que são cruciais para escolher conscientemente quais as moedas a revelar ao destinatário da transação. Atualmente, a única solução para otimizar a privacidade na seleção de moedas é fazê-lo manualmente.

### Tutorial de etiquetagem UTXO

Se quiser saber como marcar os seus UTXOs, elaborámos um tutorial completo sobre o principal software de carteira Bitcoin existente:

https://planb.network/tutorials/privacy/on-chain/utxo-labelling-d997f80f-8a96-45b5-8a4e-a3e1b7788c52
## KYC e identificação de chaves

<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>

KYC significa "Know Your Customer" (Conheça o seu cliente), que é um procedimento regulamentar implementado por algumas empresas que operam no sector da Bitcoin. Este procedimento visa verificar e registar a identidade dos seus clientes com o objetivo declarado de combater o branqueamento de capitais e o financiamento do terrorismo.

Em termos concretos, o KYC envolve a recolha de várias informações pessoais do cliente, que podem variar consoante a jurisdição, mas geralmente incluem um documento de identificação, uma fotografia e um comprovativo de residência. Estas informações são depois verificadas e armazenadas para utilização futura.

Este procedimento tornou-se obrigatório para todas as plataformas de câmbio regulamentadas na maioria dos países ocidentais. Isto significa que qualquer pessoa que pretenda trocar moedas fiduciárias por bitcoin através destas plataformas deve cumprir os requisitos KYC.

Este procedimento não é isento de riscos para a privacidade e segurança do utilizador. Neste capítulo, examinaremos estes riscos em pormenor e analisaremos os impactos específicos do KYC e dos processos de identificação na privacidade dos utilizadores de Bitcoin.

### Facilitar o rastreio Onchain

O primeiro risco associado ao KYC é que ele fornece um ponto de entrada preferencial para a análise de blockchain. Como vimos na secção anterior, os analistas podem agrupar e rastrear a atividade na cadeia de blocos utilizando padrões de transação e heurística. Uma vez que tenham conseguido agrupar a atividade de um utilizador na cadeia, encontrar apenas um ponto de entrada entre todas as suas transacções e chaves é suficiente para comprometer completamente a sua privacidade.

![BTC204](assets/fr/078.webp)

Quando se submete ao KYC, fornece um ponto de entrada de qualidade muito elevada para a análise da cadeia, uma vez que liga os endereços de receção utilizados quando retira os seus bitcoins de uma plataforma de troca à sua identidade completa e verificada. Em teoria, esta informação só é conhecida pela empresa à qual a forneceu, mas, como veremos mais adiante, o risco de perda de dados é real. Além disso, o simples facto de uma empresa possuir esta informação pode ser problemático, mesmo que não a partilhe.

Assim, a menos que sejam tomadas outras medidas para limitar o agrupamento das actividades de uma pessoa na cadeia de blocos, qualquer pessoa que tenha conhecimento do ponto de entrada que é o KYC pode potencialmente ligar toda a sua atividade na Bitcoin à sua identidade. Na perspetiva desta empresa, a utilização da Bitcoin perde assim toda a confidencialidade.

![BTC204](assets/fr/079.webp)

Para ilustrar isto com uma comparação, é como se o banqueiro do _Banco X_ tivesse acesso não só a todas as transacções feitas com o _Banco X_, mas também pudesse observar as transacções com o _Banco Y_ e todas as suas próprias transacções em numerário.

Recorde-se da primeira parte desta formação: o modelo de privacidade da Bitcoin, tal como concebido por Satoshi Nakamoto, baseia-se na separação entre a identidade do utilizador e os seus pares de chaves. Embora esta camada de privacidade já não seja suficiente atualmente, continua a ser sensato limitar a sua degradação tanto quanto possível.

### Exposição à vigilância do Estado

O segundo grande problema do KYC é o facto de revelar ao Estado que se possuiu bitcoin em algum momento. Quando se compram bitcoins através de um ator regulamentado, torna-se possível ao Estado conhecer essa posse. Atualmente, isto pode parecer trivial, mas é importante lembrar que o futuro político e económico de um país não está nas suas próprias mãos.

Em primeiro lugar, o Estado pode adotar rapidamente uma posição autoritária. A história está cheia de exemplos em que as políticas mudaram abruptamente. Atualmente, na Europa, os entusiastas da Bitcoin podem escrever artigos sobre a Bitcoin, participar em conferências e gerir as suas próprias carteiras de auto-armazenamento. Mas quem pode dizer o que o futuro reserva? Se a Bitcoin se tornar subitamente o inimigo público número um, ser associado a ela nos registos estatais pode revelar-se problemático.

Mais tarde, em caso de crise económica grave, o Estado poderá considerar a possibilidade de confiscar bitcoins detidos pelos cidadãos. Talvez amanhã se considere que os bitcoiners estão a tirar partido da crise e que serão sobretaxados devido aos seus ganhos de capital face à desvalorização da moeda fiduciária.

Poderá pensar que isto não é um problema porque as suas bitcoins são baralhadas e, por isso, não são rastreáveis. No entanto, a rastreabilidade não é o problema aqui. O verdadeiro problema é o facto de o Estado saber que possui bitcoins. Esta simples informação pode ser suficiente para o incriminar ou exigir uma prestação de contas. Poderia tentar alegar que gastou os seus bitcoins, mas isso teria de ser refletido na sua declaração de impostos e seria descoberto. Também poderia dizer que perdeu as suas chaves num acidente de barco, mas para além da piada no Twitter, acha mesmo que isso seria suficiente para o ilibar?

Por conseguinte, é importante ter em conta o risco associado ao simples facto de o Estado poder saber que possui BTC, mesmo que esse risco possa parecer distante atualmente.

Outra questão colocada pelo KYC em termos de supervisão estatal é a obrigatoriedade de comunicação por parte das plataformas regulamentadas. Embora eu não esteja familiarizado com os regulamentos de outras jurisdições, em França, os _Provedores de Serviços de Activos Digitais_ (PSAN) são obrigados a comunicar aos supervisores financeiros qualquer movimento de fundos que considerem suspeito.

Assim, em França, em 2023, foram comunicados 1 449 actos suspeitos pelas PSAN. Por enquanto, a maioria desses atos está relacionada ao crime. No entanto, as autoridades também estão pedindo às plataformas regulamentadas que relatem quaisquer transações suspeitas de Bitcoin com base apenas em sua estrutura. Se realizar uma transação colaborativa, ou mesmo apenas uma transação que tenha um padrão algo atípico, e esta transação ocorrer perto da retirada dos seus bitcoins destas plataformas, poderá ser denunciado às autoridades. Mesmo na ausência de irregularidades e no exercício legítimo dos seus direitos, esta denúncia pode levar a um maior controlo e vigilância, inconvenientes que teria evitado sem o KYC.

### O risco de perda de dados pessoais

Outro problema com o KYC reside no facto de exigir o armazenamento de todos os seus dados pessoais nos servidores de uma empresa privada. Os acontecimentos recentes recordam-nos que ninguém está imune a falhas, sejam elas financeiras ou informáticas. Em 2022, os clientes da Celsius sofreram as consequências. Na sequência da falência da empresa, os nomes dos credores e o montante dos seus activos foram tornados públicos pela justiça americana durante um processo administrativo.

Há pouco mais de dois anos, uma entidade de cibersegurança líder no domínio das criptomoedas sofreu o roubo dos dados pessoais dos seus clientes. Embora este incidente não estivesse diretamente relacionado com a compra de bitcoin, este risco também se mantém para as plataformas de troca. Por conseguinte, existe um risco concreto associado a estes dados pessoais.

É verdade que já confiamos muitos dos nossos dados pessoais a empresas privadas. No entanto, o risco aqui é duplo, uma vez que estes dados não só permitem a sua identificação, como também estão ligados à atividade no bitcoin. Com efeito, quando um hacker consegue aceder aos dados dos clientes de uma plataforma de troca, pode razoavelmente partir do princípio de que esses clientes possuem bitcoin. Este risco é assim agravado pelo facto de a bitcoin, como qualquer outro bem valioso, atrair o interesse dos ladrões.

No caso de uma violação de dados, na melhor das hipóteses, pode ser alvo de tentativas de phishing direcionadas. Na pior das hipóteses, pode encontrar-se no centro de ameaças físicas à sua casa.

Para além dos riscos específicos associados à Bitcoin, é igualmente necessário ter em conta os perigos associados à transmissão de documentos de identidade. De facto, em caso de fuga de dados, é possível ser vítima de roubo de identidade. Por conseguinte, as questões em jogo não se limitam apenas à proteção da confidencialidade das transacções, mas afectam também a segurança pessoal de cada indivíduo.

### Mal-entendidos comuns sobre KYC

É importante dissipar alguns equívocos comuns sobre KYC que são frequentemente encontrados no Twitter ou nas nossas discussões entre bitcoiners.

Em primeiro lugar, é errado pensar que a proteção da privacidade das bitcoins adquiridas através do KYC (Know Your Customer) é inútil. As ferramentas e os métodos de proteção da privacidade na bitcoin são variados e servem diferentes objectivos. Utilizar transacções coinjoin em bitcoin a partir do KYC, por exemplo, não é uma má ideia. É claro que é necessário ter cuidado com as plataformas de câmbio regulamentadas para evitar que a sua conta seja congelada ou banida, mas de um ponto de vista estritamente técnico, estas práticas não são incompatíveis. O Coinjoin tem o efeito de interromper o histórico de uma moeda, o que ajuda a combater alguns dos riscos de análise de cadeia associados ao KYC. Embora não elimine todos os riscos, já é um benefício significativo.

A privacidade na bitcoin não deve ser vista de forma binária, como uma distinção entre bitcoins "anónimos" e outros que não o são. Possuir bitcoins adquiridos através do KYC não significa que tudo está perdido; pelo contrário, a utilização de ferramentas de privacidade pode revelar-se ainda mais benéfica.

Por outro lado, a aquisição de bitcoin através de um método nãoKYC não garante uma privacidade perfeita e não o isenta da necessidade de tomar outras medidas de proteção. Se detiver bitcoin nãoKYC mas reutilizar endereços de receção várias vezes, as suas transacções podem ser rastreadas e agrupadas. A mais pequena ligação ao mundo fora da bitcoin pode comprometer a única camada de privacidade que tinha. Portanto, é importante considerar todas as ferramentas e métodos que melhoram a privacidade no Bitcoin como complementares. Cada técnica aborda um risco específico e pode acrescentar uma camada adicional de proteção. Assim, possuir bitcoin não-KYC não o isenta absolutamente de tomar outras precauções.

### O KYC pode ser cancelado?

Por vezes, perguntam-me se é possível "voltar atrás" depois de completar o KYC e, como pode imaginar pelos parágrafos anteriores, a resposta é matizada. Para evitar os riscos associados ao KYC, o método mais simples é não o utilizar na aquisição de bitcoins. Iremos desenvolver este tópico no próximo capítulo. No entanto, se o KYC já foi efectuado e os bitcoins já foram adquiridos, existem formas de mitigar os riscos incorridos?

Quanto ao risco de rastrear as suas transacções, a utilização de coinjoin é uma solução. Discutiremos esse método em detalhes mais adiante no treinamento, mas saiba que o coinjoin pode interromper o histórico de uma moeda e impedir sua rastreabilidade passado-presente e presente-passado. Mesmo para o BTC obtido através de uma plataforma regulamentada, esta técnica pode impedir a sua rastreabilidade.

No entanto, o coinjoin não elimina o segundo risco associado ao KYC: o facto de o Estado ser informado das suas participações em bitcoins. Com efeito, mesmo que as suas moedas já não sejam rastreáveis, o Estado, consoante a jurisdição, pode ter acesso às suas declarações de alienação de criptoactivos. Uma vez que este risco não é técnico, mas administrativo, não existem soluções específicas para a bitcoin para o eliminar, para além de evitar inicialmente a exposição ao KYC. A única abordagem legal para mitigar este risco é vender os seus bitcoins adquiridos através de plataformas regulamentadas em plataformas regulamentadas, e depois comprá-los de volta através de meios sem KYC. Ao vender e declarar a alienação, a administração deve registar que já não é proprietário das bitcoins.

Quanto ao risco de divulgação dos seus dados pessoais e documentos de identidade, este é um perigo externo à Bitcoin e não existe uma solução técnica para o evitar. Uma vez que seus dados tenham sido divulgados, é difícil reverter a situação. Pode tentar fechar a sua conta na plataforma, mas isso não garante a eliminação dos seus dados KYC, especialmente quando a verificação de identidade é externalizada. É impossível verificar a eliminação completa das suas informações. Por conseguinte, não existe uma solução para prevenir completamente este risco e garantir que ele deixa de existir.

### A diferença entre KYC e identificação de chaves

Por vezes, alguns bitcoiners tendem a alargar o termo "KYC" a qualquer troca de BTC que envolva uma transferência ou pagamento com cartão de crédito, uma vez que estes meios também podem revelar a origem do pagamento, tal como o KYC faria. No entanto, é importante não confundir KYC com identificação de chaves. Pessoalmente, devo admitir que a minha perceção deste tópico evoluiu ao longo do tempo.

KYC refere-se especificamente a um procedimento regulamentar implementado por algumas empresas para verificar e registar a identidade dos seus clientes. É uma questão binária: quando adquire bitcoins, ou se submete ao KYC, ou não. No entanto, a identificação-chave, que consiste em associar um aspeto da identidade de um utilizador à atividade onchain, não é assim tão binária, representando antes um continuum. De facto, no contexto da compra ou venda de bitcoin, esta identificação é sempre possível em diferentes graus.

Por exemplo, se comprar bitcoin numa plataforma regulamentada na Suíça, o KYC (Know Your Customer) não é necessário. No entanto, pode haver uma identificação das suas chaves, uma vez que a compra foi efectuada através da sua conta bancária. É aqui que surgem os dois primeiros riscos associados ao KYC - facilitar o rastreio onchain e a exposição à vigilância governamental - que também se podem manifestar numa troca sem KYC. Se a entidade suíça comunicar transacções suspeitas às autoridades do seu país, estas podem simplesmente verificar a conta bancária utilizada para a compra para descobrir a sua identidade. Assim, comprar sem KYC em plataformas regulamentadas é bastante elevado na escala de risco para a identificação de chaves.

No entanto, evitar plataformas regulamentadas e optar por métodos de aquisição P2P (Peer-to-Peer) não elimina completamente o risco de identificação de chaves, mas simplesmente o reduz. Considere o exemplo de uma compra no Bisq ou noutra plataforma P2P. Para efetuar o pagamento à sua contraparte, utilizará provavelmente a sua conta bancária. Se as autoridades interrogarem a pessoa com quem transaccionou e pedirem o seu nome, deparamo-nos com os riscos 1 e 2 acima referidos. Estes riscos são certamente muito inferiores aos de uma compra sem KYC numa plataforma, e mesmo inferiores aos de uma compra com KYC, mas não deixam de estar presentes em menor grau.

Por último, mesmo que compre os seus bitcoins através de uma troca física de dinheiro, não é completamente anónimo. A pessoa com quem fez negócio viu o seu rosto, que faz parte da sua identidade. Embora mínima neste exemplo, a possibilidade de uma chave de identificação ainda existe.

Em conclusão, durante uma troca de bitcoin por outros activos, quer se trate de uma compra de moeda fiduciária ou de uma venda de um ativo real, existe sempre uma forma de identificação da chave. Dependendo do método de troca escolhido, esta identificação pode variar em intensidade. É importante não confundir esta identificação com o KYC, que é um processo regulamentar bem definido. No entanto, existe uma ligação entre o KYC e o espetro de identificação, uma vez que o KYC se encontra no extremo superior deste espetro, pois facilita sistematicamente a identificação das chaves dos utilizadores pelas autoridades.

## Métodos de venda e aquisição

<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>

Depois de ler o capítulo anterior, pode estar a perguntar-se como comprar ou vender bitcoin sem ter de se submeter a um processo de verificação de identidade para evitar os riscos associados ao KYC. Existem vários métodos para efetuar trocas.

### Trocas P2P em dinheiro

Como já vimos, o melhor método em termos de privacidade continua a ser a troca P2P (peer-to-peer) com liquidação em dinheiro. Este método permite-lhe minimizar os vestígios deixados e reduz significativamente a possibilidade de identificação da chave, quer seja um comprador ou um vendedor.

No entanto, esta prática comporta riscos de segurança pessoal. O principal perigo reside no facto de, durante a troca, a contraparte saber que possui um montante significativo, quer em dinheiro quer em bitcoin. Esta informação pode atrair a atenção de indivíduos mal-intencionados. De facto, é geralmente aconselhado manter-se discreto quanto à posse de bitcoin. Este conselho também pode ser aplicado ao dinheiro. No entanto, durante uma troca presencial, é inevitável revelar que se possui bitcoin, o que pode despertar a cobiça.

Para limitar este risco, recomendo que dê prioridade a transacções em dinheiro com pessoas de confiança, como familiares ou amigos próximos. Em alternativa, pode também considerar efetuar trocas em [encontros locais de Bitcoin] (https://btcmap.org/communities/map), depois de participar várias vezes. Isto permitir-lhe-á conhecer melhor os outros participantes e não estar sozinho durante a troca física. No entanto, é importante reconhecer que a troca de dinheiro P2P acarreta riscos para a sua segurança pessoal que não existem quando efectua compras através de uma plataforma regulamentada e da sua conta bancária.

Além disso, dependendo do local onde se vive, o transporte e o armazenamento de grandes somas de dinheiro podem representar riscos, quer se trate de bitcoin ou de dinheiro vivo.

A troca de dinheiro líquido pode também representar um risco jurídico durante os controlos policiais ou outros. Embora na maior parte dos países não haja restrições quanto à quantidade de dinheiro líquido que se pode transportar, somas demasiado elevadas podem levantar suspeitas. Por conseguinte, seja prudente, sobretudo se tiver de percorrer longas distâncias, e evite transacções demasiado importantes de uma só vez, para não ter de justificar a posse de somas significativas.

Por último, outra desvantagem das compras P2P é o facto de o preço ser frequentemente mais elevado do que o observado nas plataformas regulamentadas. Os vendedores impõem frequentemente uma sobretaxa que varia entre 1% e, por vezes, mais de 10%. Várias razões explicam esta diferença de preços. Em primeiro lugar, trata-se de uma prática comum entre os vendedores P2P que se foi estabelecendo ao longo do tempo. Além disso, os vendedores têm taxas de transação associadas ao envio de fundos para o comprador. Há também um risco maior de roubo nas vendas P2P do que nas transacções de plataforma, o que justifica uma taxa pelo risco assumido. Por último, o prémio pode ser relativo à procura e à qualidade da troca em termos de privacidade. Como comprador, o ganho de privacidade é incluído no preço da sobretaxa cobrada pelo vendedor. Alguns bitcoiners também acreditam que o aumento do preço dos BTC comprados em P2P reflecte o seu verdadeiro valor e argumentam que os preços mais baixos nas plataformas regulamentadas são o resultado de um compromisso com a privacidade das suas informações pessoais.

### Trocas P2P através de uma plataforma de correspondência

Uma alternativa menos arriscada em termos de segurança pessoal é efetuar trocas P2P exclusivamente online, através de métodos de pagamento electrónicos como o PayPal, transferências bancárias ou Revolut.

Esta abordagem ajuda a evitar muitos riscos associados às transacções em numerário. No entanto, o risco de a contraparte não honrar os seus compromissos durante uma transação online é maior. De facto, durante uma troca física, se entregar dinheiro ao vendedor que não lhe envia bitcoins em troca, pode imediatamente denunciá-lo, uma vez que ele está à sua frente. Na Internet, por outro lado, é muitas vezes impossível encontrar uma pessoa que o tenha roubado.

Para atenuar este risco, podem ser utilizadas plataformas de correspondência especializadas para trocas P2P. Estas plataformas utilizam mecanismos de resolução de conflitos para proteger os utilizadores lesados. Geralmente, oferecem um sistema de caução, onde os bitcoins são mantidos até que o pagamento em moeda fiduciária seja confirmado pelo vendedor.

Em termos de segurança pessoal, este método de compra é significativamente mais seguro do que as trocas físicas de dinheiro. No entanto, como mencionado anteriormente, as trocas P2P online deixam mais rastos do que uma troca física, o que pode ser prejudicial para a privacidade na Bitcoin. Ao utilizar um método de pagamento fiduciário online, como um banco, expõe mais informações que podem facilitar a identificação de chaves.

Mais uma vez, não recomendo a realização de grandes transacções numa única transação nestas plataformas. Dividindo as suas transacções, reparte os riscos associados a um potencial roubo por parte da contraparte.

Outra desvantagem das compras P2P é o facto de o preço ser frequentemente mais elevado do que o observado nas plataformas regulamentadas. Os vendedores impõem frequentemente uma sobretaxa que varia entre 1% e, por vezes, mais de 10%. Várias razões explicam esta diferença de preços. Em primeiro lugar, trata-se de uma prática comum entre os vendedores P2P que se foi estabelecendo ao longo do tempo. Além disso, os vendedores têm taxas de transação associadas ao envio de fundos para o comprador. Há também um risco maior de roubo nas vendas P2P do que nas transacções de plataforma, o que justifica uma taxa pelo risco assumido. Por último, o prémio pode ser relativo à procura e à qualidade da troca em termos de privacidade. Como comprador, o ganho de privacidade é incluído no preço da sobretaxa cobrada pelo vendedor. Alguns bitcoiners também acreditam que o preço mais elevado do BTC comprado por P2P reflecte o seu verdadeiro valor e argumentam que os preços mais baixos nas plataformas regulamentadas são o resultado de um compromisso com a privacidade das suas informações pessoais.

Quanto às soluções, pessoalmente sempre utilizei [Bisq] (https://bisq.network/) e estou muito satisfeito com eles. O seu sistema está bem estabelecido e parece fiável. No entanto, o Bisq só está disponível para PC e a sua interface pode ser demasiado complexa para principiantes. Outra desvantagem é que o Bisq opera exclusivamente com transacções onchain, o que pode tornar-se dispendioso durante períodos de elevadas taxas de transação na Bitcoin.

-> Conheça o nosso tutorial sobre o Bisq.

https://planb.network/tutorials/exchange/peer-to-peer/bisq-fe244bfa-dcc4-4522-8ec7-92223373ed04
Para uma opção mais fácil, pode experimentar a [Peach](https://peachbitcoin.com/), uma aplicação móvel que facilita a ligação entre compradores e vendedores com um sistema integrado de resolução de litígios. O processo é mais intuitivo do que o do Bisq.

-> Conheça o nosso tutorial sobre o Peach.

Outra opção online é [HodlHodl] (https://hodlhodl.com/), uma plataforma bem estabelecida que oferece boa liquidez, embora eu pessoalmente não a tenha testado.

-> Conheça o nosso tutorial sobre HodlHodl.

https://planb.network/tutorials/exchange/peer-to-peer/peach-wallet-db64fe42-17ca-4b24-abb8-e7d4c03b2028
https://planb.network/tutorials/exchange/peer-to-peer/hodlhodl-d7344cd5-6b18-40f5-8e78-2574a93a3879
Para soluções baseadas na Rede Lightning, pode experimentar [RoboSats](https://learn.robosats.com/) e [LNP2PBot](https://lnp2pbot.com/). O RoboSats é acessível através de um sítio Web e é relativamente simples de utilizar. O LNP2PBot é mais atípico, uma vez que funciona através de um sistema de troca na aplicação de mensagens Telegram.

-> Consulte o nosso tutorial sobre RoboSats.

-> Consulte o nosso tutorial sobre o LNP2PBot.

https://planb.network/tutorials/exchange/peer-to-peer/robosats-b60e4f7c-533a-4295-9f6d-5368152e8c06
https://planb.network/tutorials/exchange/peer-to-peer/lnp2pbot-v2-e6bcb210-610b-487d-970c-7cce85273e3c
### Plataformas regulamentadas sem KYC

Dependendo do país onde vive, pode ter acesso a plataformas regulamentadas que não requerem um procedimento KYC para comprar ou vender bitcoin. Na Suíça, por exemplo, pode utilizar plataformas como [Relai](https://relai.app/) e [MtPelerin](https://www.mtpelerin.com/).

-> Conheça o nosso tutorial sobre a Relai.

Como vimos no capítulo anterior, este tipo de plataforma poupa-lhe os riscos associados aos procedimentos KYC, mas apresenta um nível de risco mais elevado para a identificação das chaves. Em termos de privacidade no Bitcoin, estas plataformas oferecem, portanto, uma melhor proteção do que os métodos de compra KYC, mas são menos atractivas do que as bolsas P2P.

No entanto, em termos de segurança pessoal, a utilização destas plataformas é significativamente menos arriscada do que as trocas P2P. Além disso, são frequentemente mais fáceis de utilizar do que as plataformas que facilitam as trocas P2P.

https://planb.network/tutorials/exchange/centralized/relai-v2-30a9671d-e407-459d-9203-4c3eae15b30e
### ATM

Outra opção para comprar ou vender bitcoin sem KYC são as caixas automáticas de criptomoedas (ATM). Pessoalmente, nunca tive a oportunidade de testar esta solução, uma vez que não existe nenhuma no meu país. Mas este método pode ser muito interessante, dependendo do sítio onde se vive.

O problema das caixas automáticas é que são proibidas em alguns países ou fortemente regulamentadas noutros. Se um ATM exigir um processo de verificação de identidade, corre os mesmos riscos que os inerentes às plataformas KYC regulamentadas. No entanto, se o ATM permitir transacções sem verificação de identidade para pequenos montantes, então a sua utilização pode oferecer um nível de privacidade comparável ao de uma troca P2P baseada em dinheiro, evitando a maioria dos riscos associados a este tipo de troca.

A principal desvantagem das caixas automáticas reside nas suas taxas de câmbio frequentemente elevadas, que variam entre alguns por cento e 15 por cento do montante trocado.

### Cartões de oferta

Por último, gostaria também de apresentar uma solução que funciona bem para quem pretende utilizar os seus bitcoins diariamente para compras em vez de os vender por moedas fiduciárias.

A melhor forma de gastar BTC é, obviamente, utilizar a bitcoin diretamente ou a Lightning Network para comprar bens ou serviços. No entanto, em muitos países, o número de comerciantes que aceitam bitcoin continua a ser limitado. Uma alternativa prática é, portanto, a utilização de cartões de oferta.

Várias plataformas que não requerem um procedimento KYC oferecem a possibilidade de trocar bitcoin por cartões de oferta que podem ser utilizados nas principais lojas. Essas plataformas incluem [CoinsBee] (https://www.coinsbee.com/), [The Bitcoin Company] (https://thebitcoincompany.com/) e [Bitrefill] (https://www.bitrefill.com/). Estas plataformas facilitam muito a utilização diária dos seus bitcoins, permitindo-lhe aceder a uma vasta gama de produtos e serviços sem ter de passar por uma conversão em moeda fiduciária.

https://planb.network/tutorials/exchange/centralized/bitrefill-8c588412-1bfc-465b-9bca-e647a647fbc1
### Outros métodos de aquisição

Entre outros métodos de aquisição de bitcoin, protegendo a sua privacidade, está, naturalmente, a extração. Para começar a minerar sats, não precisa de revelar a sua identidade; basta encontrar uma prova de emprego válida e apresentá-la à rede. Se optar pela mineração em pool, alguns pools exigem uma forma de identificação, como o KYC, enquanto outros não.

Outro método é trabalhar em troca de bitcoin. Este método de aquisição pode ser atrativo, mas o grau de identificação exigido varia muito em função das circunstâncias.

\Para escrever este capítulo, utilizei o curso BTC205 criado por [@pivi\_\_](https://x.com/pivi___) na Rede Plan ₿ (disponível apenas em francês, por enquanto).\_

## Consolidação, UTXO e Gestão CIOH

<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>

Um dos aspectos mais complicados de gerir quando se tem a sua própria carteira de auto-armazenamento é, sem dúvida, a consolidação. Deve-se consolidar? Qual é o objetivo? Que tamanho de UTXO deve procurar atingir? Quais são as vantagens e desvantagens em termos de privacidade? É isto que tentaremos explorar nesta secção.

### O que é a consolidação?

O funcionamento do Bitcoin é semelhante a um mercado de leilões, onde as transacções que oferecem as melhores taxas são favorecidas pelos mineiros. No entanto, cada bloco tem um peso máximo, limitando o número de transacções que podem ser incluídas. Como um bloco é produzido, em média, a cada 10 minutos, o espaço disponível em cada bloco é um recurso raro.

Os mineiros, cuja atividade envolve custos significativos em termos de eletricidade, capital e manutenção, procuram naturalmente maximizar a sua rentabilidade. Tendem a favorecer as transacções que lhes oferecem as taxas mais elevadas em relação ao seu peso.

De facto, nem todas as transacções de Bitcoin têm o mesmo peso. Aquelas com mais entradas e saídas terão um peso maior. Por exemplo, considere 2 transacções:


- A transação A inclui 1 entrada e 1 saída. Ela atribui 1.994 sats de taxas e seu peso é 141 vB;
- A transação mais complexa B, com 2 entradas e 2 saídas, atribui 2.640 sats de comissões para um peso de 220 vB.

No exemplo, embora a transação B proponha um total de comissão mais elevado, os mineiros favorecerão a transação A porque oferece um melhor rácio comissão/peso. Aqui está o cálculo para cada transação, expresso em sats por byte virtual (sat/vB):

```text
TXA: 1994 / 141 = 14 sat/vB
TXB: 2640 / 220 = 12 sat / vB
```

Isto significa que, por cada unidade de peso, a transação A oferece mais taxas do que a transação B, embora esta última ofereça mais taxas em valor absoluto.

Por conseguinte, é cada vez mais atrativo para o utilizador consumir a menor quantidade possível de factores de produção nas suas transacções. No entanto, é necessário consumir quantidades suficientes para satisfazer o pagamento da produção. Assim, na gestão da carteira, é necessário ter UTXOs suficientemente grandes.

O princípio da consolidação é precisamente aproveitar os períodos em que as taxas sobre o Bitcoin são baixas para fundir os pequenos UTXOs de alguém num UTXO maior. Assim, quando as taxas sobre o Bitcoin aumentam, é possível efetuar transacções com um input mínimo, gastando assim menos em taxas absolutas. O objetivo é planear as transacções obrigatórias a serem feitas durante os períodos de comissões elevadas.

Para além de poupar nas taxas de transação, a consolidação de UTXOs ajuda a evitar a criação de "poeira" A poeira refere-se a UTXOs cujo valor em sats é tão baixo que não é suficiente para cobrir as taxas de transação necessárias para os gastar. Isto torna a utilização destes UTXOs economicamente irracional enquanto as taxas de transação se mantiverem elevadas. Ao agrupar proactivamente os seus UTXOs, evita que se transformem em pó, assegurando que todos os seus fundos permanecem utilizáveis.

### Qual é o tamanho mínimo dos vossos UTXOs?

Por vezes, perguntam-me qual é o valor mínimo recomendado para um UTXO. Infelizmente, não existe uma resposta universal, uma vez que depende das suas preferências e das condições de mercado para as comissões. No entanto, aqui está uma fórmula que o pode ajudar a determinar um limite que se adeqúe às suas necessidades:

$$
\frac {P \times F}T = M
$$

Onde:


- $P$ é o peso da transação;
- $F$ representa a taxa máxima em satoshi por vbyte (sats/vB) que está disposto a cobrir;
- $T$ é a percentagem da taxa de transação que está disposto a pagar em relação ao valor total do UTXO;
- $M$ é o montante mínimo em satoshi para cada UTXO.

Supondo que pretende cobrir as comissões de uma transação SegWit padrão com 1 entrada e 2 saídas, pesando 141 vB. Se cobrir até 800 sats/vB, e estiver disposto a gastar até 12% do valor do UTXO em comissões, no máximo, então o cálculo seria:

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

Neste exemplo, seria sensato manter um valor mínimo de 940.000 sat para UTXOs na sua carteira.

### A consolidação e a COIH

Uma das heurísticas mais utilizadas na análise da cadeia de blocos é a COIH (_Common Input Ownership Heuristic_), que nos permite assumir que todos os inputs de uma transação Bitcoin pertencem à mesma entidade. Precisamente, o princípio da consolidação é consumir vários UTXOs como entrada e criar um único UTXO como saída. Por conseguinte, a consolidação permite a aplicação da COIH.

![BTC204](assets/fr/097.webp)

Na prática, isto significa que um observador externo pode inferir que todos os UTXOs consolidados pertencem provavelmente à mesma pessoa e que a única saída gerada também lhe pertence. Esta situação pode comprometer a privacidade do utilizador ao associar diferentes históricos de transacções. Por exemplo, digamos que eu consolide 3 UTXOs adquiridos em P2P com um UTXO obtido através de uma plataforma que requer KYC:

![BTC204](assets/fr/098.webp)

Ao fazê-lo, qualquer entidade com acesso aos dados da plataforma de troca, potencialmente incluindo agências governamentais, pode identificar que possuo outros montantes em BTC. Anteriormente, estes UTXOs não estavam diretamente ligados à minha identidade; agora estão. Além disso, isto revela a todas as fontes que estou na posse de uma determinada quantidade de bitcoin.

Na gestão dos UTXOs, as considerações económicas, que favorecem a consolidação para reduzir as taxas, entram assim em conflito com as boas práticas de privacidade, que recomendariam nunca fundir os seus UTXOs. A escolha entre economia e privacidade depende assim das prioridades de cada utilizador.

Se for possível evitar a consolidação, mantendo dimensões substanciais de UTXOs, isso é o ideal. Para tal, optimize os seus métodos de aquisição. Se comprar bitcoins em DCA, tente espaçar as suas compras únicas o mais possível para agrupar o valor em menos UTXOs. Será mais fácil gerir uma compra única de 1000 euros a cada 2 meses do que uma compra de 120 euros todas as semanas. Isto minimiza o número de UTXOs gerados e simplifica a gestão da sua carteira, preservando a sua privacidade.

Se precisar de consolidar os seus bitcoins, dê prioridade à consolidação de UTXOs da mesma fonte. Por exemplo, a fusão de 10 UTXOs de uma única plataforma terá menos impacto na sua privacidade do que a mistura de 5 UTXOs da plataforma A com 5 UTXOs da plataforma B. Se a consolidação de várias fontes for inevitável, tente separá-las de acordo com as suas caraterísticas. Por exemplo, agrupe os UTXOs adquiridos através de KYC numa transação e os obtidos em P2P noutra.

Em qualquer caso, lembre-se que qualquer consolidação conduz inevitavelmente a uma perda de privacidade. Por conseguinte, avalie cuidadosamente a necessidade de o fazer e os potenciais impactos na sua privacidade, tendo em conta o risco.

## Outras boas práticas

<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>

Vamos explorar juntos algumas outras práticas recomendadas que podem ajudá-lo a otimizar a sua privacidade na Bitcoin.

### O nó completo

Ter os seus bitcoins sob custódia pessoal é bom, mas utilizar o seu próprio nó completo é melhor! É por isso que ter o seu próprio nó é crucial para uma utilização totalmente soberana da bitcoin:


- Resistência à censura**: As suas transacções não podem ser bloqueadas por ninguém;
- Independência de terceiros**: Já não depende de nenhum serviço externo para verificar os dados da cadeia de blocos;
- Participação ativa**: Tem a possibilidade de definir as suas próprias regras de validação e participar diretamente no consenso;
- Contribuição para a rede**: Ao gerir um nó, ajudas a fortalecer e distribuir a rede Bitcoin;
- Educação Técnica**: Executar um nó completo é uma ótima maneira de aprofundar seu conhecimento técnico sobre Bitcoin.

Para além destes benefícios, a utilização de um nó completo também melhora a sua privacidade quando transmite as suas transacções. Quando você emite uma transação, ela é primeiramente criada e assinada através de sua carteira. Para transmiti-la na rede Bitcoin, ela deve ser conhecida por pelo menos um nó. Ao usar seu próprio nó, você controla diretamente essa transmissão, melhorando assim sua privacidade e limitando o risco de perda de dados.

![BTC204](assets/fr/099.webp)

Se não tiver o seu próprio nó Bitcoin, será forçado a usar o de um terceiro, como o oferecido pelo seu fornecedor de software de carteira. Para além da transmissão de transacções, a sua carteira requer acesso a várias informações, tais como transacções pendentes, saldos associados aos seus endereços ou o número de confirmações das suas transacções. Para aceder a todos estes dados, é necessário consultar um nó.

![BTC204](assets/fr/100.webp)

O principal risco quando não se utiliza o seu nó Bitcoin é que o operador do nó de terceiros possa observar as suas actividades na blockchain, ou mesmo partilhar esta informação com outras entidades. Para limitar esse risco, uma solução intermediária é usar um software de carteira que permita mascarar suas conexões via Tor. Isto pode reduzir a exposição dos seus dados. No entanto, a solução ideal continua a ser ter o seu próprio nó Bitcoin e usá-lo para transmitir as suas transacções. Claro que também terá de se certificar de que não há fugas de informação do seu nó, mas esse é outro tópico que iremos explorar nas secções seguintes.

Para além do benefício óbvio para a sua privacidade, ter o seu próprio nó completo também garante a veracidade dos dados na blockchain, protege contra a censura e permite-lhe participar ativamente na governação da Bitcoin. Ao usar o seu próprio nó, contribui com o seu peso económico para a blockchain da sua escolha, o que é importante durante conflitos dentro da comunidade, como durante a Guerra do Tamanho do Bloco de 2015 a 2017, por exemplo. No caso de uma bifurcação, a utilização de um nó de terceiros pode levá-lo a apoiar uma cadeia que não deseja favorecer, uma vez que o operador do nó faz a escolha por si. Como pode compreender, do ponto de vista da privacidade e da soberania individual mais geral, é essencial executar e utilizar o seu próprio nó completo!

### Heurística de análise enganadora

De uma forma mais geral, é importante compreender as heurísticas que discutimos na secção anterior para melhor as evitar ou enganar. A adoção de uma série de boas práticas pode ser benéfica, mesmo que não sejam essenciais. Elas oferecem uma camada adicional de proteção que pode ser importante para manter uma boa privacidade ao usar o Bitcoin.

O primeiro conselho que posso dar é misturar-se com a multidão mais densa. No Bitcoin, isso significa usar os modelos de script mais amplamente adoptados. Por exemplo, os scripts P2WSH, frequentemente usados para configurações SegWit V0 multisig, são muito raros. Não permitem que se esconda num grande conjunto de anonimato. O mesmo se aplica aos modelos mais antigos, como o P2PKH ou o P2SH. Embora estejam amplamente presentes no conjunto UTXO, são cada vez menos utilizados para novas transacções.

Em geral, é mais seguro avançar para o padrão de script mais recente, desde que seja suficientemente adotado. Assim, se em 2022 eu teria desaconselhado a utilização do P2TR (Taproot) devido à sua fraca adoção, em 2024 eu recomendaria optar por este tipo de script ou, na sua falta, pelo script SegWit V0, uma vez que o número de transacções que utilizam o P2TR começa a representar uma parte muito significativa.

Fonte:[txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)

Outra dica para preservar a sua privacidade é tentar contornar a heurística interna da transação. Por exemplo, quando efectua um pagamento, pode tentar evitar criar uma saída com um montante redondo, uma vez que isso pode indicar que a outra saída representa uma alteração. Se tiveres de enviar 100k satoshi a um amigo, considera transferir um montante ligeiramente superior para escapar a esta heurística. Da mesma forma, tente não criar resultados remanescentes que sejam desproporcionalmente elevados em comparação com o pagamento efectuado, pois isso também pode revelar qual dos resultados representa o remanescente.

Finalmente, se realizar transacções de Bitcoin regularmente, certifique-se de que não as transmite sempre às mesmas horas. Ao distribuir a transmissão das suas transacções ao longo do dia e da semana, evita dar a observadores externos a capacidade de detetar um padrão de tempo baseado em fusos horários que poderia melhorar a sua análise.

Além de todas essas práticas recomendadas a serem adotadas diariamente, existem métodos ainda mais eficazes para quebrar completamente a rastreabilidade de seus bitcoins. Estes incluem, obviamente, as transacções coinjoin, que estudaremos em profundidade na secção seguinte.

# Compreender as transacções Coinjoin

<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## O que é uma transação Coinjoin?

<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>

Depois de termos estudado as noções básicas de proteção da privacidade, vamos agora discutir técnicas mais sofisticadas destinadas a defender ativamente a sua privacidade, nomeadamente desassociando o seu histórico de bitcoins. Na próxima parte, exploraremos muitas pequenas técnicas, mas primeiro quero falar-vos sobre coinjoin.

A Coinjoin é frequentemente considerada a forma mais eficaz de proteger a privacidade dos utilizadores de Bitcoin. Mas o que é exatamente uma transação coinjoin? Vamos descobrir juntos.

### Os princípios básicos do Coinjoin

Coinjoin é uma técnica que interrompe o rastreamento de bitcoins na blockchain. Baseia-se numa transação colaborativa com uma estrutura específica com o mesmo nome: a transação coinjoin.

Como vimos nas primeiras partes desta formação, as transacções em Bitcoin são conhecidas por todos os utilizadores através do seu nó. Assim, é fácil verificar a cadeia de assinatura eletrónica de cada moeda e observar o seu histórico. Isto significa que todos os utilizadores podem tentar analisar as transacções de outros utilizadores. Consequentemente, o anonimato ao nível da transação é impossível. No entanto, o anonimato é preservado ao nível da identificação individual. Ao contrário da banca tradicional, em que cada conta está ligada a uma identidade pessoal, na Bitcoin, os fundos estão associados a pares de chaves criptográficas (ou scripts), oferecendo assim aos utilizadores uma forma de pseudonimato por detrás de identificadores criptográficos.

![BTC204](assets/it/51/01.webp)

Assim, a confidencialidade da bitcoin fica comprometida quando observadores externos conseguem associar UTXOs específicos a utilizadores identificados. Uma vez estabelecida esta associação, torna-se possível seguir as suas transacções e analisar o seu histórico de bitcoin. A Coinjoin é precisamente uma técnica desenvolvida para interromper o rastreio de UTXOs, a fim de proporcionar algum nível de confidencialidade aos utilizadores de Bitcoin ao nível da transação.

Os Coinjoins melhoram a confidencialidade dos utilizadores de Bitcoin, complicando a análise da cadeia para observadores externos. A sua estrutura permite que várias moedas de diferentes utilizadores sejam fundidas numa única transação, ofuscando assim os vestígios e dificultando a determinação de ligações entre endereços de entrada e saída.

É importante compreender que o objetivo de uma transação coinjoin é interromper o histórico de uma moeda. Esta técnica não confere anonimato permanente nem interrompe permanentemente a rastreabilidade dos bitcoins, ao contrário do que se possa pensar. A Coinjoin apenas pretende interromper a história no momento em que a transação coinjoin é realizada. No entanto, antes e depois desta transação, a moeda continua sujeita aos mesmos riscos de privacidade.

![BTC204](assets/fr/104.webp)

### Como é que os coinjoins funcionam?

O princípio do coinjoin baseia-se numa abordagem colaborativa: vários utilizadores que desejam misturar as suas bitcoins depositam montantes idênticos nos inputs da mesma transação. Estes montantes são depois redistribuídos em outputs de valores iguais para cada utilizador.

![BTC204](assets/fr/105.webp)

No final da transação, torna-se impossível associar uma saída específica a uma entrada de utilizador conhecida. Não existe uma ligação direta entre entradas e saídas, o que quebra a associação entre os utilizadores e os seus UTXOs, bem como a história de cada moeda.

![BTC204](assets/fr/106.webp)

Vejamos o exemplo da Alice. Ela quer enviar cerca de 100.000 satoshi (sats) à sua irmã Eva pelo seu aniversário. No entanto, Alice não quer que Eva possa acompanhar o seu histórico de transacções porque não quer revelar quantos bitcoins possui ou como os obteve. Para isso, Alice decide interromper o seu histórico de UTXO com uma transação coinjoin. Ela combina com Bob, Charles, David e Frank a realização de uma transação colaborativa: Alice, Bob, Charles, David e Frank prometem, cada um, um UTXO de 105.000 sats (com 5.000 sats para taxas de mineração) como entrada para a transação:

![BTC204](assets/fr/107.webp)


- Em troca da utilização destes inputs, cada um gera um novo endereço para criar cinco outputs idênticos de 100.000 sats cada. Cada participante obtém uma saída:

![BTC204](assets/fr/108.webp)


- Alice acaba por ficar com um UTXO de 100.000 sats cujo historial é misto. Ela utiliza este UTXO numa nova transação para enviar o montante para a Eva pelo seu aniversário:

![BTC204](assets/fr/109.webp)


- Se Eva tentar analisar esta transação para extrair informação, irá deparar-se com a transação coinjoin envolvendo Alice, Bob, Carlos, David e Frank. Uma vez que Eva não consegue distinguir a quem pertence cada entrada devido à uniformidade das quantias, não pode traçar a história do UTXO de Alice ou determinar quantas bitcoins a sua irmã possui ou como as adquiriu:

![BTC204](assets/fr/110.webp)

Neste cenário, Alice utilizou a técnica coinjoin para aumentar a sua privacidade contra a análise retrospetiva. De facto, Alice protege-se contra uma possível análise por parte de Eva, que partiria de uma transação específica para traçar o histórico do UTXO para trás. Esta proteção contra a análise do presente para o passado é o que chamamos de anonset retrospetivo. Iremos explorar este conceito com mais pormenor nos últimos capítulos desta parte.

No entanto, o coinjoin também oferece a possibilidade de melhorar a privacidade contra a análise do passado para o presente, o que é chamado de anonset prospetivo. Voltemos ao nosso exemplo em que Alice enviou 98.000 sats a Eva no seu aniversário, mas invertendo os papéis. Imaginemos agora que é a Eva que está preocupada com a sua privacidade. De facto, Alice pode sentir-se tentada a seguir a moeda que enviou a Eva para recolher informações. A Eva poderia consolidar este UTXO recém-recebido com todos os seus outros UTXOs, o que poderia revelar à Alice a quantidade de bitcoin que ela tem na sua carteira. Para evitar isso, Eve também pode interromper o histórico da moeda recém recebida.


- Eve, Grace, Mallory, Oscar e Victor colocaram um UTXO de 98.000 sats como entrada numa transação Bitcoin:

![BTC204](assets/fr/111.webp)


- Em troca da utilização destes inputs, cada um fornece um novo endereço para criar 5 outputs de 97.500 sats cada, perfeitamente iguais. Cada utilizador obtém uma saída:

![BTC204](assets/fr/112.webp)


- A Eve tem agora um UTXO de 97.500 sats com um historial quebrado. Ela pode usá-lo sem medo para futuras transacções. De facto, se Alice tentar seguir os bitcoins que enviou para Eve, irá deparar-se com uma transação coinjoin. Ela não será capaz de determinar a que saída UTXO pertence Eve. A análise torna-se então impossível:

![BTC204](assets/fr/113.webp)

No primeiro exemplo, vimos como o coinjoin pode proteger a privacidade de uma moeda em relação ao seu passado e, no segundo exemplo, como pode também proteger o historial de uma moeda em relação ao seu futuro. Foi por isso que mencionei que a coinjoin deve ser vista como um evento único que segmenta a história de uma moeda em ambas as direcções:

![BTC204](assets/fr/104.webp)

### Mistura, coinjoins, misturadores... Qual é a diferença?

O termo "mixing" é por vezes utilizado para descrever coinjoins, um termo que alguns bitcoiners rejeitam por recearem confusão com custodial mixers. No entanto, penso que esta apreensão é infundada porque, num contexto matemático, coinjoin incorpora precisamente o conceito de mistura.

No domínio geral da matemática, a mistura refere-se à propriedade de um sistema dinâmico em que, após um certo tempo, todas as porções do espaço inicial podem teoricamente ser misturadas com qualquer outra porção. A mistura implica que a posição de uma partícula ou o estado de um sistema evolui de tal forma que a sua distribuição futura é independente da sua distribuição inicial, atingindo assim um estado em que as caraterísticas do estado inicial estão uniformemente distribuídas no espaço do sistema. É exatamente isto que acontece numa união de moedas com bitcoins. Por isso, na minha opinião, o coinjoin é de facto um método de mistura de moedas.

![BTC204](assets/fr/114.webp)

No entanto, é importante distinguir coinjoins de mixers. Um misturador é um serviço em que os utilizadores enviam os seus bitcoins para serem misturados. Estes serviços foram populares durante a década de 2010, mas a sua utilização diminuiu devido a duas grandes desvantagens em relação ao coinjoin:


- Exigem que os utilizadores abdiquem da custódia dos seus fundos durante o processo de mistura, expondo-os ao risco de roubo;
- Não há garantia de que o misturador não registe os detalhes da transação, ou mesmo que não venda esta informação a empresas de análise de cadeias de blocos.

![BTC204](assets/fr/115.webp)

Hoje em dia, os utilizadores preferem o coinjoin, uma vez que lhes permite manter o controlo total sobre os seus fundos durante todo o processo. Os participantes numa coinjoin não correm o risco de ver os seus bitcoins roubados por outras partes envolvidas. Vamos explorar juntos como isso é possível no próximo capítulo.

## Zerolink e Chaumian Coinjoins

<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>

A privacidade proporcionada por um coinjoin baseia-se no tamanho do grupo em que a nossa peça está escondida. Por isso, é necessário encontrar o maior número possível de participantes. É perfeitamente possível executar um coinjoin manualmente, com utilizadores encontrados de forma independente, mas este método é complexo e não permite grandes anonsets.

É por isso que os coordenadores de coinjoin se desenvolveram na Bitcoin. O seu papel é ligar diferentes utilizadores e transmitir a informação necessária para a conclusão bem sucedida da transação colaborativa.

![BTC204](assets/fr/116.webp)

Mas como podemos garantir que o coordenador nunca tem controlo sobre as bitcoins dos utilizadores e, embora seja a pessoa que constrói a transação coinjoin, como podemos garantir que não pode ligar as entradas e saídas dos utilizadores, o que poderia representar uma perda de privacidade?

### Assinaturas cegas de Chaum

As implementações modernas de coinjoin utilizam as assinaturas cegas de David Chaum para evitar a fuga de informação. Vamos estudar rapidamente como funcionam estas assinaturas cegas.

As assinaturas cegas de Chaum são uma forma de assinatura digital em que o emissor de uma assinatura não conhece o conteúdo da mensagem que está a assinar. No entanto, a assinatura pode ser verificada posteriormente com a mensagem original. Esta técnica foi desenvolvida pelo criptógrafo David Chaum em 1983.

Tomemos o exemplo de uma empresa que pretende autenticar um documento confidencial, como um contrato, sem revelar o seu conteúdo. A empresa aplica um processo de mascaramento que transforma criptograficamente o documento original de forma reversível. Este documento modificado é enviado para uma autoridade de certificação que aplica uma assinatura cega sem conhecer o conteúdo subjacente. Depois de receber o documento assinado, a empresa remove a máscara da assinatura. O resultado é um documento original autenticado pela assinatura da autoridade, sem que esta tenha visto o conteúdo original.

As assinaturas cegas de Chaum permitem assim certificar a autenticidade de um documento sem conhecer o seu conteúdo, garantindo tanto a confidencialidade dos dados do utilizador como a integridade do documento assinado.

### Chaumian Coinjoins

Em "Chaumian CoinJoins", a utilização do Tor e as assinaturas cegas de David Chaum são combinadas para garantir que o coordenador não pode saber a que utilizador pertence cada saída. O processo de construção de transacções coinjoin consiste em 3 passos principais: registo de entrada, registo de saída e assinatura da transação. Examinemos este processo através do exemplo de Alice, um dos participantes da coinjoin. Todos os outros participantes seguem os mesmos passos que a Alice, cada um por si.

**Passo 1: Registo das entradas


- Alice envia ao coordenador o UTXO que pretende utilizar como entrada para a transação, bem como o endereço de receção mascarado que pretende utilizar como saída para receber as suas bitcoins. Por conseguinte, o coordenador não pode conhecer o endereço de Alice. Apenas vê a sua versão mascarada.
- O coordenador verifica a validade das entradas e, em seguida, assina o endereço mascarado de Alice com a sua chave privada. Em seguida, envia à Alice a assinatura cega.

**Passo 2: Registar as saídas


- Alice pode agora remover a máscara do seu endereço assinado pela chave privada do coordenador. Ela estabelece uma nova ligação com uma identidade Tor diferente. O coordenador não pode identificar que é Alice que se está a ligar sob esta nova identidade.
- Alice envia o endereço e a assinatura não disfarçados ao coordenador (que continua a não saber que é Alice).

**Passo 3: Assinar a transação


- Da mesma forma, o coordenador obtém os resultados não identificados de todos os participantes. Com as assinaturas associadas, ele pode verificar que cada resultado enviado anonimamente foi efetivamente assinado pela sua chave privada anteriormente, garantindo a sua legitimidade. Está então pronto para construir a transação coinjoin e envia-a aos participantes para que a assinem.
- Alice, tal como os outros participantes, verifica se o seu input e output estão corretamente incluídos na transação construída pelo coordenador. Se tudo for satisfatório, envia ao coordenador a assinatura que desbloqueia o guião do seu input.
- Depois de recolher as assinaturas de todos os participantes da coinjoin, o coordenador pode transmitir a transação através da rede Bitcoin para que possa ser adicionada a um bloco.

Neste sistema, o coordenador não pode ligar uma entrada a uma saída específica. Para além disso, não pode tomar posse dos fundos dos participantes, uma vez que nunca tem acesso às chaves privadas necessárias para desbloquear os seus UTXOs. Durante todo o processo, e até ao final do passo 3, ele nem sequer tem acesso às assinaturas. Quando Alice e os outros participantes assinam a transação global, depois de verificarem que tudo está correto, o coordenador já não pode modificar esta transação, incluindo os outputs, sem a invalidar. Assim, evita-se o roubo de bitcoins pelo coordenador.

Em última análise, quando regista a sua produção na transação, o utilizador da coinjoin deseja garantias semelhantes às de um cidadão que vota numa eleição. Existe uma dualidade entre os aspectos públicos e privados destas acções. Por um lado, há o que se pretende manter privado: para o eleitor, não quer que o seu boletim de voto seja associado à sua identidade; para o utilizador do coinjoin, não quer que o seu output seja associado ao seu input. De facto, se o coordenador, ou qualquer outra parte, conseguir estabelecer uma ligação entre uma entrada e uma saída, o coinjoin perde todo o seu objetivo. Como explicado anteriormente, a coinjoin deve funcionar como uma pausa na história de uma moeda. Esta pausa ocorre precisamente devido à incapacidade de associar um input específico a um output específico na transação coinjoin (anonset prospetivo) e vice-versa (anonset retrospetivo).

Por outro lado, existe o aspeto público: o eleitor quer ter a certeza de que o seu boletim de voto está incluído na urna; da mesma forma, o utilizador da coinjoin quer ter a certeza de que a sua produção está incluída na transação da coinjoin. De facto, é absolutamente necessário que os participantes na coinjoin possam verificar a presença do seu output antes de assinarem a transação, caso contrário o coordenador poderia roubar os fundos.

São precisamente estes dois aspectos públicos e privados, possibilitados pela utilização das assinaturas cegas de David Chaum, que asseguram aos participantes da Chaumians coinjoin que as suas bitcoins não serão roubadas e que os seus fundos não podem ser rastreados.

### Quem inventou o conceito de coinjoin?

É difícil determinar com certeza quem foi o primeiro a introduzir a ideia de coinjoin no Bitcoin e quem teve a ideia de usar as assinaturas cegas de David Chaum neste contexto. Pensa-se frequentemente que foi Gregory Maxwell quem a mencionou pela primeira vez em [um post no BitcoinTalk em 2013] (https://bitcointalk.org/index.php?topic=279249.0):

Usando as assinaturas cegas de Chaum: Os utilizadores ligam-se e fornecem a entrada (e endereços para o resto), bem como uma versão criptograficamente oculta do endereço para o qual desejam enviar as suas moedas privadas; o servidor assina os tokens e devolve-os aos utilizadores. Os utilizadores voltam a ligar-se anonimamente, revelam os seus endereços de saída e enviam-nos novamente para o servidor. O servidor pode ver que todas as saídas foram assinadas por ele e que, como resultado, todas as saídas são de participantes válidos. Mais tarde, as pessoas voltam a ligar-se e a assinar.

Maxwell, G. (2013, 22 de agosto). _CoinJoin: A privacidade do Bitcoin para o mundo real_. Fórum BitcoinTalk. https://bitcointalk.org/index.php?topic=279249.0

No entanto, houve menções anteriores de ambas as assinaturas Chaum no contexto de misturas e coinjoins. [Em junho de 2011, Duncan Townsend apresentou no BitcoinTalk](https://bitcointalk.org/index.php?topic=12751.0) um misturador que usa assinaturas Chaum de uma forma bastante semelhante aos modernos Chaumians coinjoins.

No mesmo tópico, existe [uma mensagem de hashcoin em resposta a Duncan Townsend](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793) para melhorar o seu misturador. O processo descrito nesta mensagem representa exatamente o que está mais próximo das coinjoins. Um sistema semelhante é também mencionado em [uma mensagem de Alex Mizrahi em 2012](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry), quando ele estava a aconselhar os criadores da Tenebrix, uma das primeiras altcoins que serviu de base para a criação da Litecoin mais tarde. Até o próprio termo "coinjoin" não foi inventado por Greg Maxwell, mas surgiu de uma ideia de Peter Todd.

![BTC204](assets/fr/125.webp)

### Zerolink

O Zerolink é um protocolo de mistura abrangente que integra a junção de moedas Chaumiani e várias estratégias para proteger o anonimato do utilizador contra várias formas de análise de cadeias, reduzindo significativamente os erros relacionados com a gestão de carteiras. Este protocolo [foi introduzido por nopara73 e TDevD em 2017] (https://github.com/nopara73/ZeroLink/blob/master/README.md).

![BTC204](assets/fr/126.webp)

Como o nome sugere, o princípio do Zerolink consiste em realizar transacções coinjoin que asseguram que as ligações entre entradas e saídas não podem ser rastreadas. Esta caraterística é conseguida assegurando que todos os outputs têm montantes perfeitamente idênticos.

![BTC204](assets/fr/127.webp)

Uma importante medida preventiva do Zerolink consiste em separar completamente os UTXOs não misturados dos UTXOs misturados, utilizando conjuntos separados de chaves criptográficas, ou mesmo carteiras separadas. Desta forma, a carteira "pré-mistura", destinada às moedas antes da mistura, é diferenciada da carteira "pós-mistura", reservada às moedas que foram misturadas.

![BTC204](assets/fr/128.webp)

Esta separação rigorosa dos UTXOs serve principalmente para evitar associações acidentais entre um UTXO misturado e um não misturado. De facto, se tais ligações ocorrerem, a eficácia do coinjoin no UTXO misturado é anulada sem o conhecimento do utilizador, comprometendo assim a confidencialidade de um UTXO cujo historial se acreditava ter sido quebrado. Estas ligações podem surgir quer através da reutilização de endereços para proteger um UTXO misturado com um não misturado, quer através da aplicação da Heurística de Propriedade de Entrada Comum (CIOH) se o utilizador consumir UTXOs misturados e não misturados como entradas para a mesma transação. Ao separar as carteiras de pré-mistura e pós-mistura, estas associações acidentais são evitadas e o utilizador fica protegido contra erros não intencionais.

![BTC204](assets/fr/129.webp)

Esta separação também oferece a possibilidade de aplicar regras distintas entre as carteiras de pré-mistura e pós-mistura ao nível do software da carteira. Por exemplo, na carteira pós-mistura, o software pode proibir a fusão de UTXOs de entrada para evitar a aplicação de CIOH que comprometeria o anonset do utilizador. Também é possível normalizar a utilização de scripts e opções de transação (como a sinalização RBF, por exemplo) para evitar a identificação por impressão digital da carteira.

Atualmente, o Whirlpool é a única implementação de coinjoin que impõe rigorosamente o protocolo Zerolink. No capítulo seguinte, exploraremos as diferentes implementações de coinjoin existentes e as vantagens e desvantagens de cada uma.

## Implementações Coinjoin

<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>

em 2024, estamos a assistir a mudanças significativas nas ferramentas disponíveis para os utilizadores que desejam executar coinjoins em Bitcoin. Estamos atualmente num período crucial, e o mercado de coinjoins está a passar por uma grande reestruturação. Por conseguinte, este capítulo será provavelmente atualizado ao longo do tempo

Por enquanto, existem principalmente 3 implementações diferentes de coinjoin no Bitcoin:


- Hidromassagem;
- Wabisabi;
- JoinMarket.

Cada uma destas implementações visa quebrar a história dos UTXOs através de transacções coinjoin. No entanto, os seus mecanismos variam significativamente. Portanto, é essencial entender como cada um funciona para escolher a opção que melhor se adapta às suas necessidades.

### JoinMarket

O JoinMarket, criado em 2015 por Adam Gibson e Chris Belcher, difere de outras implementações de coinjoin devido ao seu modelo único de correspondência entre utilizadores. Este sistema baseia-se num mercado de troca P2P em que alguns utilizadores, os "makers", disponibilizam os seus bitcoins para mistura, enquanto outros, os "takers", utilizam estes fundos para executar coinjoins em troca de uma taxa.

![BTC204](assets/fr/130.webp)

Neste modelo, os "criadores" deixam os seus bitcoins disponíveis para os "tomadores" e recebem taxas em troca do seu serviço. Os "takers", por outro lado, pagam para utilizar os bitcoins dos "makers" para realizar as suas próprias transacções de coinjoin. As taxas de serviço variam consoante a função: os "makers" acumulam taxas pelas suas ofertas de liquidez, enquanto os "takers" pagam comissões. Este mercado funciona livremente, sem condições de utilização.

Uma das principais desvantagens do JoinMarket é a sua complexidade de utilização, que exige alguma familiaridade com os terminais para o explorar eficazmente. Embora esta complexidade não constitua um obstáculo para um utilizador experiente, pode limitar o acesso ao público em geral. No entanto, a recente introdução de uma interface web denominada JAM facilitou um pouco a sua utilização.

![BTC204](assets/fr/131.webp)

Fonte: [JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

No entanto, a barreira técnica continua a ser um grande obstáculo. No ecossistema das coinjoins, onde a confidencialidade é reforçada pelo número de participantes, qualquer limitação que reduza a acessibilidade afecta diretamente a liquidez disponível, que é um fator crucial para a eficiência da mistura. A Bitcoin, já um nicho nas transacções financeiras, vê a utilização de coinjoins como um sub-nicho, e a JoinMarket representa uma fração ainda mais especializada, limitando assim o seu potencial para aumentar os anonsets dos seus utilizadores.

Apesar do seu modelo inovador de correspondência P2P para coinjoins, o JoinMarket tem alguns inconvenientes significativos, especialmente em termos de estrutura transacional. Ao contrário de outras implementações, como a Whirlpool, a JoinMarket não garante uma igualdade perfeita entre os resultados e podem ser estabelecidas ligações determinísticas entre as entradas e as saídas. Também não dispõe de instrumentos para impedir que moedas já misturadas sejam novamente misturadas, o que poderia comprometer a confidencialidade pretendida pelos utilizadores. Por último, embora o conceito de JoinMarket seja atrativo, especialmente para os interessados num mercado de liquidez dinâmico, as suas fraquezas estruturais e a sua complexidade técnica tornam-no, na minha opinião, menos atrativo, tanto para os principiantes como para os especialistas que procuram uma implementação de coinjoin.

### Wabisabi

Wabisabi é outra implementação do coinjoin, com uma abordagem que centraliza a coordenação das transações. Este modelo foi projetado por Ádám Ficsór (nopara73), Yuval Kogman, Lucas Ontivero e István András Seres em 2021, e foi integrado ao software Wasabi 2.0 no ano seguinte. O Wabisabi representa precisamente uma evolução do modelo de coinjoin do software Wasabi lançado em 2018.

No final da década de 2010, a Wasabi adoptou uma estrutura transacional para as suas coinjoins que era radicalmente diferente da da Whirlpool. Para aumentar os anonsets dos seus participantes, a Wasabi utilizou transacções de coinjoin muito grandes que agrupavam dezenas de participantes. Em contrapartida, a Whirlpool optou por múltiplas transacções pequenas, permitindo um aumento exponencial dos anonsets em cada ciclo.

Os métodos para tratar o resto também distinguem as duas implementações. Na Whirlpool, o resto era excluído e isolado dos UTXOs antes dos ciclos de coinjoin pelo TX0, um conceito que explicarei melhor no próximo capítulo. No Wasabi, por outro lado, o resto formava uma das saídas da transação coinjoin, mantendo ligações determinísticas entre algumas entradas e saídas.

Com o Wabisabi, a versão 2.0 do Wasabi adaptou a sua abordagem aos coinjoins para se aproximar da do Whirlpool. Embora as transacções coinjoin continuem a ser muito grandes, é agora possível encadear várias rondas sucessivas, seguindo assim o modelo da Whirlpool. Foi também feito um esforço especial na gestão do troco: ao contrário do Wasabi 1.0, onde o troco estava diretamente ligado à entrada do utilizador, o Wabisabi tenta dividir o troco em várias pequenas quantias, distribuídas em denominações iguais para todos os participantes.

Vamos ilustrar isto com um exemplo simplificado que envolve apenas 2 utilizadores: Alice quer misturar 115.000 sats e Bob, 210.000 sats. Ignorando as comissões, com Wasabi 1.0, uma transação coinjoin teria gerado 3 saídas de 100.000 sats, mais 1 resto de 15.000 sats para Alice e 1 resto de 10.000 sats para Bob. Os restantes outputs estariam sempre ligados aos inputs:

Ao abrigo do Wabisabi, a mesma transação produziria 3 saídas de 100 000 sats e 5 saídas de 5 000 sats, dispersando assim o remanescente de modo a não ser diretamente rastreável a uma entrada específica:

Pessoalmente, considero que a gestão da mudança na Wabisabi apresenta vários riscos que podem comprometer a sua eficácia em termos de privacidade:


- Quando um utilizador contribui com um UTXO significativamente maior do que os dos outros participantes, acaba inevitavelmente por ter uma quantidade de mudança que será associada à sua entrada. Isto vai contra o objetivo inicial do protocolo, que visa eliminar qualquer alteração identificável;
- A multiplicação de designações com o objetivo de fragmentar as restantes pode, paradoxalmente, prejudicar a eficácia da mistura. Este processo pode levar a uma diminuição das anonsets para certas produções, uma vez que estas se tornam mais facilmente identificáveis;
- Este método também gera UTXOs de baixo valor que representam um problema de gestão para o utilizador. Estes pequenos UTXOs, se se tornarem demasiado caros para serem gastos em relação ao seu valor, podem tornar-se "pó" Este fenómeno leva o utilizador a fundir vários UTXOs de entrada nas suas transacções futuras ou a consolidá-los. Em qualquer dos casos, devido ao COH, este facto pode diminuir os anonsets obtidos ou anular completamente os benefícios de privacidade obtidos com a junção inicial de moedas.

Contrariamente à Whirlpool, que aplica o protocolo ZeroLink assegurando uma segregação rigorosa entre UTXO pré-mistura e pós-mistura, a Wabisabi não mantém esta segregação rigorosa. Além disso, alguns clientes da Wasabi tiveram problemas de reutilização de endereços, o que é obviamente muito prejudicial para o utilizador.

Na versão 2.0 do Wasabi, foi implementada uma nova política de preços de coinjoin. Agora, as taxas de coordenação são fixadas em 0,3 por cento para UTXOs maiores que 0,01 bitcoin, enquanto que para UTXOs menores, essas taxas são completamente zeradas. Além disso, os remixes para estes UTXOs mais pequenos são gratuitos, embora as taxas de mineração permaneçam para todas as transacções, incluindo os remixes.

Esta política contrasta com a da Whirlpool, onde as comissões permanecem fixas, independentemente do tamanho dos anonsets obtidos. Com o Wasabi 2.0, embora as comissões de coordenação sejam repostas a zero para pequenos UTXOs, o utilizador continua a ter de pagar comissões de mineração em todas as transacções, incluindo remixes.

No momento em que escrevo, o uso de Wabisabi tornou-se consideravelmente mais complexo como resultado de eventos recentes. De facto, após a detenção dos fundadores da Samourai Wallet, a zkSNACKs, a empresa que financia e gere o desenvolvimento da Wasabi, anunciou a cessação do seu serviço de coordenação de coinjoin a 1 de junho de 2024. Este coordenador, que foi definido como padrão para Wasabi, tinha a grande maioria da liquidez.

Com o encerramento deste coordenador principal, os utilizadores devem agora ligar-se a novos coordenadores independentes. Esta alteração suscita preocupações: por um lado, os novos coordenadores podem não ter liquidez suficiente, reduzindo assim a eficácia dos coinjoins em termos de privacidade. Por outro lado, existe o risco de se encontrar um coordenador mal-intencionado. Esta situação acrescenta novos riscos significativos para quem pretende utilizar o Wabisabi.

Para além das questões técnicas, a decisão da zkSNACKs, a empresa por detrás da Wasabi, de utilizar os serviços de uma empresa de análise de blockchain para filtrar os participantes em coinjoins levanta sérias questões éticas e estratégicas. A ideia inicial era impedir a utilização de coinjoins no Wasabi por criminosos, uma medida que pode parecer legítima. No entanto, levanta um paradoxo: pagar taxas a um coordenador, cuja principal missão é aumentar a privacidade dos utilizadores, para depois financiar uma empresa cujo objetivo é comprometer essa mesma privacidade.

Ainda mais preocupante é o princípio da filtragem, que contrasta fortemente com a filosofia do Bitcoin de fornecer um sistema financeiro aberto e sem censura. Embora possa parecer justificado querer excluir a atividade criminosa, esta filtragem pode também visar indivíduos cujas acções, embora classificadas como ilegais em alguns contextos, podem ser moralmente justificáveis ou socialmente benéficas. O exemplo de Edward Snowden ilustra na perfeição esta dicotomia: considerado criminoso por alguns governos devido às suas revelações, é visto por outros como um denunciante que agiu no interesse público. Esta complexidade sublinha o perigo potencial da filtragem, que, embora comece com uma boa intenção, pode acabar por prejudicar os direitos e a segurança dos utilizadores legítimos. Poderia também ter mencionado os activistas e jornalistas perseguidos em certos regimes autoritários. Como já devem ter adivinhado, a minha preferência vai, sem dúvida, para o modelo Whirlpool de realização de coinjoins em Bitcoin. Este sistema destaca-se pelo seu rigor e oferece garantias superiores em termos de privacidade. É também o único a propor uma mistura que é considerada perfeita num contexto matemático. Na minha opinião, este modelo representa o futuro dos coinjoins em Bitcoin. Convido-vos, portanto, a explorar este modelo em maior profundidade no próximo capítulo.

## O funcionamento da Whirlpool

<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>

A Whirlpool difere de outros métodos de coinjoin por utilizar transacções "_ZeroLink_", que asseguram que não existe tecnicamente nenhuma ligação possível entre todos os inputs e todos os outputs. Esta mistura perfeita é conseguida através de uma estrutura em que cada participante contribui com uma quantidade idêntica de entradas (com exceção das taxas de exploração mineira), gerando assim saídas de quantidades perfeitamente iguais.

Esta abordagem restritiva dos inputs confere às transacções conjuntas da Whirlpool uma caraterística única: a ausência total de ligações determinísticas entre inputs e outputs. Por outras palavras, cada output tem a mesma probabilidade de ser atribuído a qualquer participante, relativamente a todos os outros outputs da transação.

![BTC204](assets/fr/136.webp)

### O funcionamento geral da Whirlpool

Inicialmente, o número de participantes em cada coinjoin da Whirlpool era limitado a 5, com 2 novos participantes e 3 remixers (explicaremos estes conceitos mais tarde). No entanto, o aumento das taxas para transacções na cadeia observado em 2023 levou as equipas de Samourai a repensar o seu modelo para melhorar a privacidade e reduzir os custos. Assim, tendo em conta a situação do mercado de comissões e o número de participantes, o coordenador pode agora organizar coinjoins que incluem 6, 7 ou 8 participantes. Estas sessões melhoradas são designadas pelo nome de "_Surge Cycles_" É importante notar que, independentemente da configuração, há sempre apenas 2 novos participantes nos coinjoins da Whirlpool.

Assim, as transacções da Whirlpool são caracterizadas por um número idêntico de entradas e saídas, que podem ser:


- 5 entradas e 5 saídas;

![BTC204](assets/fr/137.webp)


- 6 entradas e 6 saídas;

![BTC204](assets/fr/138.webp)


- 7 entradas e 7 saídas;

![BTC204](assets/fr/139.webp)


- 8 entradas e 8 saídas.

![BTC204](assets/fr/140.webp)

O modelo proposto pela Whirlpool baseia-se, portanto, em pequenas transacções de coinjoin. Ao contrário do Wabisabi e do JoinMarket, em que a robustez dos anonsets se baseia no volume de participantes num único ciclo (ou em alguns ciclos), a Whirlpool assenta na concatenação de múltiplos pequenos ciclos. Neste modelo, os utilizadores só incorrem em custos na sua entrada inicial numa pool, o que lhes permite participar numa multiplicidade de remixes sem custos adicionais. São os novos participantes que cobrem os custos de extração dos remisturadores.

Com cada coinjoin adicional em que uma moeda participa, juntamente com os seus pares encontrados no passado, os anonsets crescerão exponencialmente. O objetivo, então, é tirar partido destas remisturas gratuitas, que, a cada ocorrência, ajudam a reforçar a densidade de anonsets associados a cada mistura de moedas.

A Whirlpool foi concebida com dois requisitos importantes em mente:


- A acessibilidade da aplicação em dispositivos móveis, uma vez que a Samourai Wallet é essencialmente uma aplicação para smartphone;
- A velocidade dos ciclos de remistura para incentivar um aumento significativo de anonsets.

Estes imperativos orientaram as escolhas dos criadores da carteira Samourai na conceção da Whirlpool, levando-os a limitar o número de participantes por ciclo. Um número demasiado reduzido de participantes teria comprometido a eficácia do coinjoin, reduzindo drasticamente os anonsets gerados em cada ciclo, enquanto um número demasiado elevado de participantes teria colocado problemas de gestão nas aplicações móveis e dificultado o fluxo dos ciclos.

Em última análise, não é necessário ter um elevado número de participantes para fazer coinjoin na Whirlpool, uma vez que os anonsets são realizados com base na acumulação de vários ciclos de coinjoin. O princípio mais importante aqui é a homogeneidade dos UTXOs de todos os participantes, uma vez que isso permite uma mistura perfeita e, assim, beneficiar plenamente dos ciclos de mistura e remistura.

### Piscinas e tarifas Coinjoin

Para que estes ciclos múltiplos aumentem efetivamente os anonsets das moedas mistas, deve ser estabelecido um quadro para limitar as quantidades de UTXO utilizadas. Por conseguinte, a Whirlpool define vários pools.

Um grupo representa um grupo de utilizadores que desejam misturar-se, que concordam com a quantidade de UTXO a ser utilizada para otimizar o processo de coinjoin, mantendo uma perfeita homogeneidade de moedas. Cada pool especifica um montante fixo de UTXO, que o utilizador deve cumprir para poder participar. Assim, para realizar coinjoins com a Whirlpool, é necessário selecionar um pool. Os pools atualmente disponíveis são os seguintes:


- 0.5 bitcoin;
- 0.05 bitcoin;
- 0.01 bitcoin;
- 0.001 bitcoin (= 100.000 sats).

Ao aderir a uma pool com os seus bitcoins, estes serão divididos para gerar UTXOs perfeitamente homogéneos com os dos outros participantes na pool. Cada pool tem um limite máximo; assim, para montantes que excedam esse limite, será obrigado a efetuar duas entradas separadas no mesmo pool ou a recorrer a outro pool com um montante superior:

| Pool (bitcoin) | Montante máximo por entrada (bitcoin)

|----------------|----------------------------------------|

| 0,5 | 35 |

| 0,05 | 3,5 |

| 0,01 | 0,7 |

| 0,001 | 0,025 |

Considera-se que um UTXO pertence a uma pool quando está pronto para ser integrado numa coinjoin. No entanto, isto não significa que o utilizador perca a posse do mesmo. Como vimos nos primeiros capítulos desta parte, através dos diferentes ciclos de mistura, o utilizador mantém o controlo total das suas chaves e, consequentemente, dos seus bitcoins. Isto é o que diferencia a técnica coinjoin de outras técnicas de mistura centralizadas.

Para aderir a um pool de moedas, devem ser pagas taxas de serviço e taxas de mineração. As taxas de serviço são fixas para cada pool e destinam-se a compensar as equipas responsáveis pelo desenvolvimento e manutenção da Whirlpool.

As taxas de serviço para utilizar a Whirlpool devem ser pagas uma única vez ao entrar na piscina. Uma vez concluída esta etapa, pode participar num número ilimitado de remixes sem taxas adicionais. Aqui estão as taxas fixas actuais para cada piscina:

| Pool (bitcoin) | Taxa de entrada (bitcoin) | Taxa de entrada (bitcoin)

| -------------- | --------------------------------- |

| 0.5 | 0.0175 |

| 0.05 | 0.00175 |

| 0,01 | 0,0005 (50.000 sats) |

| 0,001 | 0,00005 (5.000 sats) |

Estas taxas funcionam essencialmente como um bilhete de entrada para o grupo que escolher, independentemente do montante que introduzir na coinjoin. Assim, quer entre no grupo de 0,01 BTC com exatamente 0,01 BTC ou entre com 0,5 BTC, as taxas permanecerão as mesmas em valor absoluto.

Antes de prosseguir com os coinjoins da Whirlpool, o utilizador pode escolher entre 2 estratégias:


- Optar por um conjunto mais pequeno para minimizar as taxas de serviço, sabendo que receberão em troca vários UTXOs mais pequenos;
- Ou prefere um conjunto maior, aceitando pagar taxas mais elevadas para ficar com um pequeno número de UTXOs de maior valor.

Geralmente, não se recomenda a fusão de vários UTXOs mistos após ciclos de coinjoin, pois isso poderia comprometer a privacidade obtida, especialmente devido à heurística de propriedade de entrada comum (CIOH: _Common-Input-Ownership-Heuristic_). Por conseguinte, pode ser sensato escolher um conjunto maior, mesmo que isso signifique pagar mais, para evitar ter demasiados UTXOs de pequeno valor como saída. O utilizador deve avaliar estas soluções de compromisso para escolher o conjunto que prefere.

Além das taxas de serviço, as taxas de mineração inerentes a qualquer transação de Bitcoin também devem ser consideradas. Como utilizador da Whirlpool, terá de pagar as taxas de mineração para a transação de preparação (`Tx0`), bem como para a primeira junção de moedas. Todas as remisturas subsequentes serão gratuitas, devido ao modelo da Whirlpool de pagar aos novos participantes.

De facto, em cada Whirlpool coinjoin, 2 utilizadores entre os inputs são novos participantes. As outras entradas provêm de remixers. Consequentemente, as taxas de exploração mineira de todos os participantes na transação são cobertas por estes 2 novos participantes, que também beneficiarão de remisturas gratuitas:

![BTC204](assets/it/54/07.webp)

Devido a este sistema de taxas, a Whirlpool difere verdadeiramente de outras implementações de coinjoin porque os anonsets de UTXOs não são proporcionais ao preço pago pelo utilizador. Assim, níveis consideravelmente elevados de anonimato podem ser alcançados pagando apenas a taxa de entrada na pool e as taxas de mineração para 2 transacções (o `Tx0` e a mistura inicial).

É importante notar que o utilizador também terá de cobrir as taxas de mineração para retirar os seus UTXOs da pool depois de executar os seus múltiplos coinjoins, a menos que tenha selecionado a opção `mix to`, que lhe permite fornecer um endereço externo que receberá diretamente os fundos como resultado de um coinjoin, sem qualquer transação adicional.

### Contas HD Wallet

Para efetuar uma junção de moedas através da Whirlpool, a carteira deve gerar várias contas separadas. Este é o princípio do protocolo ZeroLink. Uma conta, no contexto de uma carteira HD (_Hierarchical Deterministic_), constitui uma secção completamente isolada das outras, esta separação ocorre no terceiro nível de profundidade da hierarquia da carteira, ou seja, no nível `xpub`.

![BTC204](assets/it/54/08.webp)

Uma carteira HD pode, teoricamente, derivar até `2^(32/2)` contas diferentes. A conta inicial, usada por padrão em todas as carteiras Bitcoin, corresponde ao índice `0'`.

Para as carteiras adaptadas à Whirlpool, são utilizadas 4 contas para satisfazer as exigências do processo ZeroLink:


- A **conta de depósito**, identificada pelo índice `0'`;
- A **má conta bancária** (ou "bolsa tóxica"), identificada pelo índice `2 147 483 644'`;
- A **conta pré-mistura**, identificada pelo índice `2 147 483 645'`;
- A conta **postmix**, identificada pelo índice `2 147 483 646'`.

Cada uma destas contas desempenha uma função específica no processo de coinjoin, que iremos explorar nas secções seguintes.

Todas estas contas estão ligadas a uma única semente, permitindo ao utilizador recuperar o acesso a todos os seus bitcoins utilizando a sua frase de recuperação e, se necessário, a sua frase-chave. No entanto, é necessário especificar ao software, durante esta operação de recuperação, os diferentes índices das contas que foram utilizadas.

Passemos agora a analisar as diferentes fases de uma junção da Whirlpool no âmbito destas contas.

### O TX0

O ponto de partida de qualquer coinjoin da Whirlpool é a **conta de depósito**. Esta conta é a que se utiliza automaticamente quando se cria uma nova carteira de bitcoins. Esta conta deve ser creditada com os bitcoins que pretende misturar.

O `Tx0` representa o primeiro passo no processo de mistura do Whirlpool. Tem como objetivo preparar e equalizar as UTXOs para coinjoin, dividindo-as em unidades correspondentes à quantidade do pool selecionado, para garantir a homogeneidade da mistura. Os UTXOs equalizados são então enviados para a conta **premix**. Quanto à diferença que não pode entrar no pool, ela é separada numa conta específica: o **bad bank** (ou "câmbio tóxico").

Esta transação inicial `Tx0` serve também para liquidar as taxas de serviço devidas ao coordenador da coinjoin. Ao contrário dos passos seguintes, esta transação não é colaborativa; por isso, o utilizador tem de suportar o custo total das taxas de mineração:

![BTC204](assets/it/54/09.webp)

Neste exemplo de transação `Tx0`, uma entrada de `372 000 sats` da nossa **conta de depósito** é dividida em vários UTXOs de saída, que são distribuídos da seguinte forma:


- Um montante de `5.000 sats` atribuído ao coordenador a título de taxas de serviço, correspondente à entrada na reserva de `100.000 sats`;
- 3 UTXOs preparados para mistura, redireccionados para a nossa **conta de pré-mistura** e registados no coordenador. Estes UTXOs são equiparados a `108 000 sats` cada, para cobrir as taxas de mineração para a sua futura mistura inicial;
- O excedente que não pode entrar na pool, por ser demasiado pequeno, é considerado uma troca tóxica. É enviado para a sua conta específica. Neste caso, esta troca ascende a `40 000 sats`;
- Finalmente, existem `3.000 sats` que não constituem produção, mas são as taxas de extração necessárias para confirmar `Tx0`.

Por exemplo, eis uma Whirlpool Tx0 real (não a minha):[edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/fr/145.webp)

### A mudança tóxica

O excesso que não pôde ser integrado na pool, aqui equivalente a `40.000 sats`, é redireccionado para a conta **bad bank**, também designada por "toxic exchange", para garantir uma separação rigorosa dos outros UTXOs da carteira.

Este UTXO é perigoso para a privacidade do utilizador porque não só continua ligado ao passado do utilizador e, por conseguinte, possivelmente à identidade do seu proprietário, como também está marcado como pertencendo a um utilizador que participou numa coinjoin.

![BTC204](assets/fr/146.webp)

Se este UTXO for fundido com outputs baralhados, perderá toda a privacidade obtida durante os ciclos de coinjoin, em grande parte devido à CIOH (_Common-Input-Ownership-Heuristic_). Se for fundida com outras alterações tóxicas, o utilizador arrisca-se a perder a privacidade, uma vez que irá ligar as diferentes entradas dos ciclos de coinjoin. Por conseguinte, deve ser tratada com precaução. Discutiremos a gestão destes UTXOs tóxicos com mais pormenor na última secção deste capítulo.

### A mistura inicial

Após a conclusão do `Tx0`, os UTXOs equalizados são enviados para a conta **premix** do nosso portfolio, prontos para serem introduzidos no seu primeiro ciclo de coinjoin, também chamado de "initial mix" Se, como no nosso exemplo, o `Tx0` gerar vários UTXOs destinados à mistura, cada um deles será integrado numa mistura inicial separada.

No final destas primeiras misturas, a conta **premix** estará vazia, enquanto as nossas moedas, tendo pago as taxas de mineração para esta primeira junção de moedas, serão liquidadas exatamente no montante definido pela pool escolhida. No nosso exemplo, os nossos UTXOs iniciais de `108,000 sats` terão sido reduzidos para exatamente `100,000 sats`.

![BTC204](assets/fr/147.webp)

### Os Remixes

Após a mistura inicial, os UTXOs são transferidos para a conta **postmix**. Esta conta recolhe tanto os UTXOs que já foram misturados como os que aguardam remistura. Quando o cliente Whirlpool está ativo, os UTXOs na conta **postmix** estão automaticamente disponíveis para remistura e serão escolhidos aleatoriamente para participar nestas novas rondas.

Como lembrete, as remisturas são então completamente gratuitas: não são necessárias taxas de serviço adicionais ou taxas de mineração. Manter as UTXOs na conta **postmix** mantém assim o seu valor intacto e melhora simultaneamente os seus anonsets. É por isso que é importante permitir que estas moedas participem em vários ciclos de coinjoin. Não lhe custa absolutamente nada e aumenta os seus níveis de anonset.

Quando decidir gastar UTXOs mistos, pode fazê-lo diretamente a partir desta conta **postmix**. É aconselhável manter os UTXOs mistos nesta conta para beneficiar de remisturas gratuitas e para evitar que saiam do circuito Whirlpool, o que pode diminuir a sua privacidade.

### Como gerir corretamente a sua conta postmix?

Depois de executar ciclos de coinjoin, a melhor estratégia é manter os seus UTXOs na conta **postmix**, aguardando a sua utilização futura. É mesmo aconselhável deixá-los remixar indefinidamente até precisar de os gastar.

Alguns utilizadores podem considerar a transferência dos seus bitcoins mistos para uma carteira de hardware protegida. Isso é possível, mas é importante seguir meticulosamente as recomendações da Samourai Wallet para não comprometer a confidencialidade obtida.

A combinação de UTXOs é o erro mais frequentemente cometido. É necessário evitar a combinação de UTXOs mistos com UTXOs não mistos na mesma transação para evitar a heurística Common-Input-Ownership (CIOH). Isto requer uma gestão cuidadosa dos seus UTXOs dentro da sua carteira, especialmente em termos de rotulagem.

![BTC204](assets/fr/148.webp)

Também é importante ter cuidado com a consolidação de UTXOs mistos. São concebíveis consolidações moderadas se os seus UTXOs mistos tiverem anonsets significativos, mas isso irá inevitavelmente diminuir a confidencialidade das suas moedas. Certifique-se de que as consolidações não são demasiado significativas ou realizadas após um número insuficiente de remisturas, correndo o risco de estabelecer ligações inferidas entre os seus UTXOs antes e depois dos ciclos de coinjoin. Em caso de dúvida sobre estas manipulações, a melhor prática é não consolidar os UTXOs após a remistura e transferi-los um a um para a sua carteira de hardware, gerando um novo endereço vazio de cada vez. Lembre-se ainda de etiquetar corretamente cada UTXO recebido.

Também não é recomendado transferir seus postmixes UTXO para uma carteira que use scripts incomuns. Por exemplo, se entrar na Whirlpool a partir de uma carteira multisig que use scripts `P2WSH`, há uma pequena hipótese de ser misturado com outros utilizadores que tenham o mesmo tipo de carteira originalmente. Se você retirar seus postmixes nesta mesma carteira multisig, o nível de privacidade de seus bitcoins misturados será bastante reduzido. Para além dos scripts, existem muitas outras impressões digitais de carteiras que o podem enganar.

Como em qualquer transação Bitcoin, também é importante não reutilizar endereços de receção. Cada nova transação deve ser recebida num endereço novo e vazio.

A solução mais simples e mais segura é deixar os seus UTXOs mistos repousar na sua conta **postmix**, permitindo-lhes remisturar e tocar-lhes apenas para os gastar. As carteiras Samourai e Sparrow têm protecções adicionais contra todos estes riscos de análise em cadeia. Estas protecções ajudam-no a evitar cometer erros.

### Como gerir corretamente a sua mudança tóxica?

De seguida, deve ter cuidado ao lidar com o seu troco tóxico, o troco que não pôde entrar na pool de coinjoin. Estes UTXOs tóxicos, resultantes da utilização da Whirlpool, representam um risco para a sua privacidade porque estabelecem uma ligação entre si e a utilização do coinjoin. Por conseguinte, é imperativo manuseá-los com cuidado e não os combinar com outros UTXOs, especialmente UTXOs mistos.

Eis algumas estratégias a considerar para os utilizar:


- Misture-os em piscinas mais pequenas:** Se o seu UTXO tóxico for suficientemente grande para caber sozinho numa piscina mais pequena, considere misturá-lo. Esta é geralmente a melhor opção. No entanto, não é recomendável misturar vários UTXOs tóxicos para aceder a uma piscina, pois isso pode ligar as suas diferentes entradas.
- Marcá-los como "não gastáveis":** Outra abordagem consiste em deixar de os utilizar, marcá-los como "não gastáveis" na sua conta dedicada e simplesmente guardá-los. Isto garante que não as gasta acidentalmente. Se o valor do bitcoin aumentar, podem surgir novos pools mais adequados para os seus UTXOs tóxicos;
- Fazendo doações:** Considere fazer doações, mesmo que modestas, para desenvolvedores que trabalham com Bitcoin e seu software associado. Você também pode doar para organizações que aceitam BTC. Se gerir os seus UTXOs tóxicos parecer demasiado complicado, pode simplesmente livrar-se deles fazendo uma doação.
- Comprar cartões-presente:** Plataformas como a [Bitrefill] (https://www.bitrefill.com/) permitem trocar bitcoins por cartões-presente que podem ser usados em vários estabelecimentos comerciais. Esta pode ser uma forma de se desfazer dos seus UTXOs tóxicos sem perder o valor associado.
- Consolide-os em Monero:** A Samourai Wallet oferece um serviço de troca atómica entre BTC e XMR. Isso é ideal para gerenciar UTXOs tóxicos, consolidando-os no Monero, sem comprometer sua privacidade via KYC, antes de enviá-los de volta ao Bitcoin. No entanto, esta opção pode ser dispendiosa em termos de taxas de mineração e prémios devido a restrições de liquidez.
- Enviá-los para a Lightning Network:** Transferir estes UTXOs para a Lightning Network para beneficiar de taxas de transação reduzidas é uma opção atractiva. No entanto, este método pode revelar algumas informações dependendo do uso do Lightning e, portanto, deve ser praticado com cautela.

### Como utilizar a Whirlpool?

Na sequência da detenção dos fundadores da Samourai Wallet e da apreensão dos seus servidores em 24 de abril de 2024, a ferramenta Whirlpool deixou de funcionar, mesmo para aqueles que têm o seu próprio Dojo. Anteriormente, estava disponível na Samourai Wallet e na Sparrow Wallet.

![BTC204](assets/fr/149.webp)

No entanto, continua a ser possível que este instrumento possa voltar a entrar em funcionamento nas próximas semanas, dependendo do resultado dos ensaios, ou ser relançado de uma forma diferente. Em todo o caso, acredito que o mercado de coinjoin no Bitcoin não ficará sem oferta durante muito tempo, uma vez que existe uma procura clara. Além disso, o modelo Whirlpool, sendo o mais avançado em termos de privacidade, será certamente utilizado noutras implementações no futuro.

Estamos a acompanhar de perto a evolução deste caso, bem como os desenvolvimentos relativos às ferramentas associadas. Pode ter a certeza de que actualizaremos esta formação à medida que forem disponibilizadas novas informações.

No próximo capítulo, vamos descobrir o que são "anonsets", como são calculados estes indicadores e como podem ajudar-nos a estimar a eficácia dos ciclos coinjoin.

https://planb.network/tutorials/privacy/on-chain/coinjoin-sparrow-wallet-84def86d-faf5-4589-807a-83be60720c8b
https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/tutorials/privacy/on-chain/coinjoin-dojo-c4b20263-5b30-4c74-ae59-dc8d0f8715c2
## Conjunto de anonimato

<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>

Depois de termos estudado como funcionam as junções de moedas e os desafios associados a uma mistura eficaz, vamos agora aprender a medir essa eficácia. Como determinar se um processo de coinjoin foi eficaz e qual o grau de anonimato que uma moeda adquiriu? É isto que vamos explorar neste capítulo com os conjuntos de anonimato ou "anonsets" em inglês.

### Lembrete sobre a utilidade do Coinjoin

A utilidade do CoinJoin reside na sua capacidade de produzir uma negação plausível, mergulhando a sua moeda num grupo de moedas indistinguíveis. O objetivo desta ação é quebrar as ligações de rastreabilidade, tanto do passado para o presente como do presente para o passado.

Por outras palavras, um analista que conheça a sua transação inicial (`Tx0`) à entrada dos ciclos CoinJoin não deverá ser capaz de identificar com certeza o seu UTXO à saída dos ciclos remix (análise desde a entrada no ciclo até à saída do ciclo).

![BTC204](assets/it/55/01.webp)

Em contrapartida, um analista que conheça o seu UTXO na saída dos ciclos CoinJoin não deve ser capaz de determinar a transação original na entrada dos ciclos (análise da saída do ciclo para a entrada do ciclo).

![BTC204](assets/it/55/02.webp)

Para avaliar a dificuldade de um analista em ligar o passado ao presente e vice-versa, é necessário quantificar a dimensão dos grupos homogéneos de moedas em que a sua moeda está escondida. Esta medida indica-nos o número de análises que têm uma probabilidade idêntica. Assim, se a análise correta estiver afogada entre 3 outras análises de igual probabilidade, o seu nível de ocultação é muito baixo. No entanto, se a análise correta estiver dentro de um conjunto de 20.000 análises, todas igualmente prováveis, a sua moeda está muito bem escondida. E, precisamente, a dimensão destes conjuntos representa indicadores chamados anonsets.

### Compreender os Anonsets

Os anonsets servem como indicadores para avaliar o grau de privacidade de um determinado UTXO. Mais especificamente, medem o número de UTXOs indistinguíveis dentro do conjunto que inclui a moeda que está a ser estudada. A exigência de um conjunto homogéneo de UTXOs significa que os anonsets são normalmente calculados em ciclos CoinJoin. A utilização destes indicadores é particularmente relevante para os CoinJoins da Whirlpool devido à sua uniformidade.

Os anonsets permitem, quando apropriado, avaliar a qualidade dos CoinJoins. Uma grande dimensão de anonset significa um elevado nível de anonimato, uma vez que se torna difícil distinguir um UTXO específico dentro do conjunto homogéneo.

Existem 2 tipos de anonsets:


- A perspetiva de anonset;**
- A retrospetiva anonset.**

### O futuro Anonset

O anonset prospetivo indica a dimensão do grupo entre o qual o UTXO estudado está escondido à saída do ciclo, conhecendo o UTXO à entrada, ou seja, o número de moedas indistinguíveis presentes neste grupo. Em inglês, o nome deste indicador é "forward anonset", ou "forward-looking metrics"

Este indicador fornece uma medida da resistência da privacidade da moeda em relação a uma análise do passado para o presente (input para output).

![BTC204](assets/it/55/03.webp)

Esta métrica estima até que ponto o seu UTXO está protegido contra tentativas de reconstruir o seu historial desde o seu ponto de entrada até ao seu ponto de saída no processo de coinjoin.

Por exemplo, se a sua transação participou no primeiro ciclo de junção de moedas e foram concluídos dois ciclos descendentes adicionais, o anonset prospetivo da sua moeda seria `13`:

![BTC204](assets/fr/153.webp)

Por exemplo, imaginemos que a nossa moeda, à entrada do ciclo de junção de moedas, beneficia de um anonimato prospetivo de 86 871 moedas. Na prática, isto significa que a moeda está escondida entre `86,871` moedas indistinguíveis. Para um observador externo que tivesse conhecimento desta moeda no início do ciclo de junção de moedas e tentasse seguir a sua saída, seria confrontado com `86,871` UTXOs possíveis, cada um com uma probabilidade idêntica de ser a moeda procurada.

![BTC204](assets/it/55/05.webp)

### A Anonset Retrospetiva

O anonset retrospetivo indica o número de fontes possíveis para uma determinada moeda, conhecendo o UTXO na saída do ciclo. Este indicador mede a resistência da privacidade da moeda face a uma análise do presente para o passado (saída para entrada), ou seja, a dificuldade que um analista tem em localizar a origem da sua moeda, antes dos ciclos de coinjoin. Em inglês, o nome deste indicador é "backward anonset", ou "retrospective metrics"

Conhecendo o seu UTXO à saída dos ciclos, o anonset retrospetivo determina o número de potenciais transacções Tx0 que poderiam ter constituído a sua entrada nos ciclos de coinjoin. No diagrama abaixo, isto corresponde à soma de todas as bolhas cor de laranja.

Por exemplo, imaginemos que a nossa moeda à saída do ciclo de coinjoin beneficia de um anonset retrospetivo de `42,185`. Na prática, isto significa que existem `42,185` fontes possíveis para este UTXO. Se um observador externo identificar esta moeda no final dos ciclos e tentar descobrir a sua origem, deparar-se-á com `42,185` fontes possíveis, todas com igual probabilidade de serem a origem procurada.

### Como calcular concretamente os anonsets?

Pode calcular manualmente os seus anonsets utilizando um explorador de blocos para conjuntos pequenos. No entanto, para anonsets maiores, a utilização de uma ferramenta especializada torna-se imperativa. Tanto quanto sei, o único software capaz de realizar esta tarefa é o _Whirlpool Stats Tool_, uma ferramenta Python desenvolvida pelas equipas Samourai e OXT. Infelizmente, esta ferramenta está atualmente fora de serviço após a detenção dos fundadores da Samourai e o fim da OXT, que estava a ser utilizada para extrair dados da cadeia de blocos.

Como vimos neste capítulo, os anonsets só podem ser calculados se houver alguma homogeneidade na estrutura da coinjoin. E precisamente, no próximo capítulo, vamos descobrir como quantificar essa homogeneidade numa transação de Bitcoin, seja ela uma coinjoin ou uma transação mais tradicional.

https://planb.network/tutorials/privacy/analysis/wst-anonsets-0354b793-c301-48af-af75-f87569756375
## Entropia

<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>

Como vimos nesta parte sobre coinjoins, a homogeneidade dos UTXOs nas entradas e saídas desempenha um papel importante na melhoria da confidencialidade de uma transação Bitcoin. Este parâmetro permite uma negação plausível contra a análise da cadeia. Vários métodos podem medir esta homogeneidade, mas um dos mais eficazes, na minha opinião, é a utilização de indicadores fornecidos pela ferramenta _Boltzmann_, desenvolvida pelas equipas OXT e Samourai Wallet, especificamente a entropia das transacções. É isto que vamos estudar em pormenor neste capítulo.

Ao contrário dos anonsets, que são calculados com base num conjunto de transacções, os indicadores que apresentaremos aqui centram-se exclusivamente numa única transação, quer se trate de uma coinjoin ou de uma transação mais tradicional.

### O número de interpretações

O primeiro indicador que pode ser observado numa transação de Bitcoin é o número total de interpretações possíveis aos olhos de um observador externo que analisa a transação. Tendo em consideração os valores dos UTXOs envolvidos na transação, este indicador indica o número de formas em que os inputs podem ser associados aos outputs. Por outras palavras, determina o número de interpretações possíveis que uma transação pode gerar no fluxo de bitcoin na perspetiva de um observador externo que a analisa.

Por exemplo, uma simples operação de pagamento com 1 entrada e 2 saídas terá apenas uma interpretação, nomeadamente que a entrada #0 financiou a saída #0 e a saída #1. Não existem outras interpretações possíveis:

![BTC204](assets/fr/159.webp)

Em contrapartida, um coinjoin estruturado de acordo com o modelo 5x5 da Whirlpool tem 1496 combinações possíveis:

![BTC204](assets/fr/160.webp)

Uma união de moedas Whirlpool Surge Cycle 8x8 resulta em 9.934.563$ possíveis interpretações:

![BTC204](assets/fr/161.webp)

### Entropia

A partir do número de interpretações de uma transação Bitcoin, podemos calcular a sua entropia.

No contexto geral da criptografia e da informação, a entropia é uma medida quantitativa da incerteza ou imprevisibilidade associada a uma fonte de dados ou a um processo aleatório. Por outras palavras, a entropia é uma forma de medir a dificuldade de prever ou adivinhar a informação.

No contexto específico da análise da cadeia, entropia é também o nome de um indicador, derivado da entropia de Shannon e [inventado por LaurentMT](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf), que pode ser calculado numa transação Bitcoin.

Quando uma transação tem um elevado número de interpretações possíveis, é frequentemente mais relevante referir a sua entropia. Este indicador fornece uma medida da falta de conhecimento dos analistas sobre a configuração exacta da transação. Por outras palavras, quanto maior for a entropia, mais difícil se torna para os analistas identificar os fluxos de bitcoin entre entradas e saídas.

Na prática, a entropia revela se, na perspetiva de um observador externo, uma transação tem múltiplas interpretações possíveis, com base apenas nas quantidades de entrada e saída, sem considerar outros padrões e heurísticas externos ou internos. Uma entropia elevada é, portanto, sinónimo de uma maior confidencialidade da transação.

A entropia é definida como o logaritmo binário do número de combinações possíveis. Eis a fórmula utilizada com $E$ a representar a entropia da transação e $C$ o número de interpretações possíveis:

$$
E = \log_2(C)
$$

Em matemática, o logaritmo binário (logaritmo de base 2) corresponde à operação inversa de elevar 2 a uma determinada potência. Por outras palavras, o logaritmo binário de $x$ é o expoente a que se deve elevar $2$ para obter $x$. Este indicador é assim expresso em bits.

Vejamos o exemplo do cálculo da entropia para uma transação coinjoin estruturada de acordo com o modelo Whirlpool 5x5, que, como mencionado na secção anterior, tem um número de interpretações possíveis de $1.496:

$$
\begin{align*}
C &= 1.496 \\
E &= \log_2(1.496) \\
E &= 10.5469 \text{ bit}
\end{align*}
$$

Assim, esta transação coinjoin apresenta uma entropia de $10,5469$ bits, o que é considerado muito satisfatório. Quanto mais elevado for este valor, mais interpretações diferentes a transação admite, melhorando assim o seu nível de privacidade.

Para uma transação 8x8 coinjoin que tem 9.934.563 interpretações, a entropia seria

$$
\begin{align*}
C &= 9.934.563 \\
E &= \log_2(9.934.563) \\
E &= 23,244 \text{ bit}
\end{align*}
$$

Vejamos outro exemplo com uma transação de pagamento padrão, com 1 entrada e 2 saídas: [1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/fr/162.webp)

No caso desta transação, a única interpretação possível é: `(In.0) > (Out.0 ; Out.1)`. Consequentemente, a sua entropia é definida como $0$:

$$
\begin{align*}
C &= 1 \\
E &= \log_2(1) \\
E &= 0 \text{ bit}
\end{align*}
$$

### Eficiência

A partir da entropia da transação, podemos também calcular a sua eficiência em termos de privacidade. Este indicador avalia a eficiência da transação comparando-a com a transação óptima concebível numa configuração idêntica.

Isto leva-nos a discutir o conceito de entropia máxima, que corresponde à entropia mais elevada que uma estrutura de transação específica poderia teoricamente atingir. A eficiência da transação é então calculada comparando esta entropia máxima com a entropia real da transação analisada.

A fórmula utilizada é a seguinte


- $E_R$: a entropia real da transação expressa em bits;
- $E_M$: a entropia máxima possível para uma estrutura de transação, também expressa em bits;
- $Ef$: a eficiência da transação em bits:

$$
Ef = E_R - E_M
$$

Por exemplo, para uma estrutura coinjoin do tipo Whirlpool 5x5, a entropia máxima é de $10,5469$:

$$
\begin{align*}
E_R &= 10,5469 \\
E_M &= 10,5469 \\
Ef &= E_R - E_M \\
Ef &= 10,5469 - 10,5469 \\
Ef &= 0 \text{ bit}
\end{align*}
$$

Este indicador é igualmente expresso em percentagem. A fórmula utilizada é a seguinte


- $C_R$: o número de interpretações reais possíveis;
- $C_M$: o número máximo de interpretações possíveis com a mesma estrutura;
- $Ef$: eficiência expressa em percentagem:

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1.496}{1.496} \\
E_f &= 100\%
\end{align*}
$$

Uma eficiência de $100\%$ indica, portanto, que a transação maximiza o seu potencial de privacidade com base na sua estrutura.

### A densidade de entropia

A entropia é um bom indicador para medir a privacidade de uma transação, mas depende em parte do número de entradas e saídas na transação. Para comparar a entropia de duas transacções diferentes que não tenham o mesmo número de entradas e saídas, pode ser calculada a densidade de entropia. Este indicador fornece uma perspetiva sobre a entropia relativa a cada entrada ou saída na transação. A densidade revela-se útil para avaliar e comparar a eficiência de transacções de diferentes dimensões.

Para a calcular, basta dividir a entropia total da transação pelo número total de entradas e saídas envolvidas na transação:


- $E_D$: a densidade de entropia expressa em bits;
- $E$: a entropia da transação expressa em bits;
- $T$: o número total de entradas e saídas na transação:

$$
E_D = \frac{E}{T}
$$

Tomemos o exemplo de uma junção de 5x5 da Whirlpool:

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ bit}
\end{align*}
$$

Também calculamos a densidade de entropia de uma união em redemoinho 8x8:

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
E_D &= 1.453 \text{ bit}
\end{align*}
$$

Analisando a densidade de entropia destes dois tipos de junções, torna-se evidente que, mesmo quando se normaliza a entropia pelo número de elementos, a junção "Surge Cycle 8x8" gera mais incerteza para análise.

### A pontuação de Boltzmann

Outra informação analisada numa transação é o índice de Boltzmann de cada elemento em relação a outro. Trata-se de uma tabela de probabilidades de correspondência entre inputs e outputs. Esta tabela indica, através do índice de Boltzmann, a probabilidade condicional de um determinado input estar relacionado com um determinado output. É, assim, uma medida quantitativa da probabilidade condicional de ocorrência de uma associação entre um input e um output numa transação, determinada pelo rácio entre o número de ocorrências favoráveis deste evento e o número total de ocorrências possíveis, num conjunto de interpretações.

Tomando o exemplo de um coinjoin da Whirlpool, a tabela de probabilidades condicionais destacaria as possibilidades de uma ligação entre cada entrada e saída, fornecendo uma medida quantitativa da ambiguidade das associações na transação:

| % | Saída 0 | Saída 1 | Saída 2 | Saída 3 | Saída 4 |

| ------- | -------- | -------- | -------- | -------- | -------- |

Neste caso, é evidente que cada entrada tem a mesma probabilidade de estar associada a qualquer saída, o que aumenta a confidencialidade da transação.

O cálculo da pontuação de Boltzmann consiste em dividir o número de interpretações em que um determinado evento ocorre pelo número total de interpretações disponíveis. Assim, para determinar o resultado da associação da entrada #0 com a saída #3 (um evento presente em $512$ interpretações), o processo é o seguinte:

$$
\begin{align*}
\text{Interpretazioni (IN.0 > OUT.3)} &= 512 \\
\text{Interpretazioni Totali} &= 1496 \\
\text{Punteggio} &= \frac{512}{1496} \\
\text{Punteggio} &= 34\%
\end{align*}
$$

Se reconsiderarmos o exemplo de um ciclo de co-integração Surge 8x8 Whirlpool, a tabela de Boltzmann teria o seguinte aspeto:

| | OUT.0 | OUT.1 | OUT.2 | OUT.3 | OUT.4 | OUT.5 | OUT.6 | OUT.7 | OUT.7 |

| ---- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |

| IN.0 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| IN.1 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| IN.2 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| IN.3 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| IN.4 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| IN.5 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| IN.6 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

| IN.7 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23%

No entanto, no caso de uma transação simples que envolva uma única entrada e duas saídas, a situação é diferente:

| % | Saída 0 | Saída 1 |

| ------- | -------- | -------- |

| Entrada 0 | 100% | 100% |

Aqui, observamos que a probabilidade de cada saída proveniente da entrada #0 é de 100%. Uma probabilidade mais baixa resulta, assim, numa maior privacidade ao diluir as ligações diretas entre entradas e saídas.

### Ligações determinísticas

Também é possível calcular o número de ligações determinísticas numa transação. Este indicador revela quantas ligações entre entradas e saídas na transação analisada são inquestionáveis, com 100% de probabilidade. Este indicador pode depois ser completado com o cálculo do rácio de ligações determinísticas. O rácio fornece uma perspetiva sobre o peso destas ligações determinísticas no conjunto das ligações da transação.

Por exemplo, uma transação conjunta da Whirlpool não mostra qualquer ligação determinística entre entradas e saídas, apresentando assim um indicador de 0 ligações e um rácio de 0%. Em contrapartida, na nossa segunda operação de pagamento simples examinada (com um input e 2 outputs), o indicador diz-nos que existem 2 ligações determinísticas e o rácio atinge 100%. Assim, um indicador nulo indica uma excelente privacidade devido à ausência de ligações diretas e indiscutíveis entre entradas e saídas.

### Como calcular estes indicadores?

O cálculo manual destes indicadores, utilizando as equações que forneci, é relativamente simples. A principal dificuldade reside em determinar o número de interpretações possíveis de uma transação. Para uma transação normal, este cálculo pode ser feito à mão. No entanto, para uma coinjoin, a tarefa é significativamente mais complexa.

Anteriormente, existia uma ferramenta Python chamada _Boltzmann Calculator_, desenvolvida pelas equipas da OXT e da Samourai, que permitia o cálculo automático de todos estes indicadores para uma transação Bitcoin:

![BTC204](assets/fr/163.webp)

Também foi possível utilizar o sítio Web KYCP.org para estas análises:

![BTC204](assets/fr/164.webp)

Infelizmente, na sequência da detenção dos fundadores do Samourai, estas ferramentas não estão atualmente operacionais.

Agora que já discutimos as coinjoins em detalhe, vamos explorar outras técnicas de privacidade disponíveis na Bitcoin na última secção da nossa formação. Examinaremos transacções payjoin, tipos específicos de transacções pseudo-coinjoin, protocolos de endereços estáticos, bem como medidas para melhorar a privacidade não ao nível da transação, mas ao nível da rede de nós.

https://planb.network/tutorials/privacy/analysis/boltzmann-entropy-738e45af-18a6-4ce6-af1a-1bf58e15f1fe
# Compreender os desafios de outras técnicas avançadas de privacidade

<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Transacções Payjoin

<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>

Atualmente, o coinjoin é o método mais eficaz para introduzir incerteza no rastreio de moedas durante uma análise em cadeia. Como vimos nos capítulos anteriores, para conseguir uma mistura eficaz, as entradas e saídas têm de ser tão homogéneas quanto possível. Além disso, é crucial que os coinjoins sejam integrados num grupo tão grande quanto possível para maximizar os anonsets. Assim, para que os coinjoins sejam eficazes, devem envolver um grande número de moedas uniformes. Esta multiplicidade de requisitos significa que as transacções coinjoin têm uma estrutura muito rígida: os montantes são pré-determinados e todos os participantes devem aderir aos mesmos para garantir a uniformidade do processo. Além disso, as coinjoins requerem sincronização entre todos os participantes e o coordenador durante a construção da transação.

Estes requisitos fazem com que a coinjoin não seja adequada para pagamentos diretos. Por exemplo, se possuir uma peça de 1M de sats numa pool de coinjoin, utilizá-la diretamente como pagamento seria complexo. Exigiria sincronização com outros participantes e o coordenador para construir exatamente no momento em que precisa de fazer um pagamento a transação colaborativa, e o montante da compra teria de corresponder exatamente ao valor da sua peça, o que é praticamente inviável. Por conseguinte, uma transação coinjoin é, por natureza, uma transação de limpeza colaborativa, o que significa que, geralmente, são os mesmos proprietários dos inputs que estão nos outputs.

No entanto, seria interessante dispor de estruturas de transação que permitissem pagamentos práticos, introduzindo a dúvida na análise da cadeia. É exatamente isso que vamos explorar neste capítulo e no próximo.

### O que é uma transação payjoin?

O Payjoin é uma estrutura de transação Bitcoin específica que aumenta a privacidade do utilizador durante uma despesa, colaborando com o destinatário do pagamento.

Em 2015, LaurentMT mencionou pela primeira vez este método sob o nome de "transacções esteganográficas", de acordo com um documento acessível [aqui] (https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt). Esta técnica foi posteriormente adoptada pela Samourai Wallet que, em 2018, foi o primeiro cliente a implementá-la com a ferramenta Stowaway. O conceito de payjoin encontra-se também em [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki) e [BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki). Assim, são utilizados vários termos para designar um payjoin:


- Pagar para entrar;
- Passageiro clandestino;
- P2EP (_Pay-to-End-Point_);
- Transação esteganográfica.

A singularidade do payjoin reside na sua capacidade de gerar uma transação que parece vulgar à primeira vista, mas que é, na realidade, uma mini Coinjoin entre duas pessoas. Para tal, a estrutura da transação envolve o destinatário do pagamento nas entradas juntamente com o remetente real. O destinatário inclui então um pagamento a si próprio no meio da transação que lhe permite ser pago.

Vejamos um exemplo para compreender melhor este processo. Alice compra uma baguete por 4.000 sats usando um UTXO de 10.000 sats e opta por um payjoin. O seu padeiro, Bob, acrescenta um UTXO de 15.000 sats à sua entrada, que recupera totalmente na saída, para além dos 4.000 sats da Alice.

No exemplo, Bob, o padeiro, entra com 15.000 sats e sai com 19.000 sats, a diferença é exatamente 4.000 sats, que é o preço da baguete. Por seu lado, Alice entra com 10.000 sats e acaba com 6.000 sats de saída, o que representa um saldo de -4.000 sats, que é o preço da baguete. Para simplificar o exemplo, omiti deliberadamente as taxas de mineração nesta transação.

### Qual é o objetivo do payjoin?

A transação payjoin cumpre dois objectivos que permitem aos utilizadores melhorar a privacidade dos seus pagamentos.

Em primeiro lugar, o payjoin tem como objetivo enganar um observador externo, criando um desvio na análise da cadeia. Isto é possível através da _Common Input Ownership Heuristic_ (CIOH). Como vimos na Parte 3, geralmente quando uma transação na blockchain tem várias entradas, presume-se que todas essas entradas pertencem à mesma entidade ou usuário.

Assim, quando um analista examina uma transação de junção de pagamentos, é levado a pensar que todos os dados provêm da mesma pessoa. No entanto, esta perceção é incorrecta, uma vez que o beneficiário também contribui com entradas juntamente com o pagador real. A análise em cadeia é, assim, desviada para uma interpretação que se revela falsa.

Voltemos ao nosso exemplo de uma transação payjoin para pagar uma baguete:

Ao ver esta transação na cadeia de blocos, um observador externo, seguindo as heurísticas habituais da análise da cadeia, interpretá-la-ia da seguinte forma: "Alice juntou 2 UTXOs na entrada da transação para pagar 19.000 sats ao Bob"

Esta interpretação está claramente errada; como já sabe, os dois UTXOs na entrada não pertencem à mesma pessoa. Uma é da Alice, a compradora de baguetes, e a outra é do Bob, o padeiro.

Assim, a análise do observador externo é direcionada para uma conclusão errada, o que garante a preservação da confidencialidade das partes interessadas.

### A transação esteganográfica

O segundo objetivo do payjoin é enganar um observador externo sobre o montante real do pagamento efectuado. Ao examinar a estrutura da transação, o analista pode acreditar que o pagamento é equivalente ao montante de um dos outputs.

Se pegarmos no nosso exemplo da compra de uma baguete, o analista pensará que o montante do pagamento corresponde ao UTXO de 6.000 sats ou ao UTXO de 19.000 sats. Neste caso, é mais provável que o analista pense que o montante do pagamento é de 19.000 sats porque há 2 UTXOs na saída, pelo menos um dos quais é superior a 6.000 sats (não há nenhuma razão lógica para usar 2 UTXOs para pagar 6.000 sats quando um único UTXO teria sido suficiente para este pagamento).

Mas, na realidade, esta análise é incorrecta. O montante do pagamento não corresponde a nenhuma das saídas. É, de facto, a diferença entre o UTXO do destinatário da saída e o UTXO do destinatário da entrada.

Neste caso, a transação payjoin cai no domínio da esteganografia. Permite que o montante real de uma transação seja escondido dentro de uma transação falsa que serve de desvio.

A esteganografia é uma técnica para esconder informações dentro de outros dados ou objectos, de modo a que a presença da informação escondida não seja percetível. Por exemplo, uma mensagem secreta pode ser escondida dentro de um ponto num texto não relacionado, tornando-a indetetável a olho nu (esta é a técnica do [microponto] (https://fr.wikipedia.org/wiki/Micropoint)).

Ao contrário da encriptação, que torna a informação ininteligível sem a chave de desencriptação, a esteganografia não altera a informação. Elas permanecem à vista. Pelo contrário, o seu objetivo é ocultar a própria existência da mensagem secreta, enquanto a criptografia revela claramente a presença de informação oculta, embora inacessível sem a chave. É por isso que o nome inicial do payjoin era "transacções esteganográficas"

Pode ser feita uma analogia entre a criptografia e o coinjoin, bem como entre a esteganografia e o payjoin. De facto, o coinjoin tem atributos semelhantes aos da criptografia: o método é reconhecível, mas a informação é indecifrável. Em contrapartida, o payjoin é semelhante à esteganografia: a informação é teoricamente acessível, mas como o seu método de ocultação não é reconhecível, torna-se inacessível.

### Como utilizar o payjoin?

Os softwares conhecidos que suportam payjoin incluem Sparrow Wallet, Wasabi Wallet, Mutiny, BitMask, BlueWallet e JoinMarket, bem como o processador de pagamento BTCPay.

A implementação mais avançada do payjoin era apenas o Stowaway na Samourai Wallet. No entanto, desde o encerramento dos fundadores do software, esta ferramenta agora funciona apenas parcialmente. A vantagem do Stowaway é o facto de ser um protocolo completo e muito fácil de utilizar que suporta tanto a receção como o envio de payjoins. As transacções parcialmente assinadas podem ser trocadas manualmente através da leitura de vários códigos QR ou automaticamente através do Tor via Soroban. É esta última opção de comunicação que não está atualmente em serviço.

A dificuldade em utilizar o payjoin reside na sua dependência da participação do comerciante. Enquanto cliente, a utilização de um payjoin é impossível se o comerciante não o suportar. Este facto acrescenta uma dificuldade adicional durante uma compra: não só é complicado encontrar comerciantes que aceitem bitcoin, mas se também procurar aqueles que suportam payjoins, torna-se ainda mais complicado.

Uma solução poderia ser a utilização de estruturas transaccionais que introduzam ambiguidade na análise da cadeia sem exigir a cooperação do destinatário. Isto permitir-nos-ia melhorar a privacidade dos nossos pagamentos sem depender da participação ativa dos comerciantes. É precisamente isso que estudaremos no próximo capítulo.

https://planb.network/tutorials/privacy/on-chain/payjoin-sparrow-wallet-087a0e49-61cd-41f5-8440-ac7b157bdd62
https://planb.network/tutorials/privacy/on-chain/payjoin-samourai-wallet-48a5c711-ee3d-44db-b812-c55913080eab
## Pagamento de mini-coinjoin

<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>

Quando se pretende efetuar uma transação de pagamento preservando algum grau de privacidade, o payjoin é uma boa opção. Mas, como já vimos, o payjoin requer o envolvimento do destinatário. Então, o que fazer se este último se recusar a participar num payjoin, ou se simplesmente preferir não o envolver? Uma alternativa é utilizar uma transação Stonewall ou Stonewall x2. Vamos analisar mais detalhadamente estes dois tipos de transacções.

### A transação Stonewall

Stonewall é uma forma específica de transação Bitcoin que visa aumentar a privacidade do utilizador durante uma sessão de compras, imitando uma pseudo-coinjoin entre duas pessoas, mas sem o ser na realidade. De facto, esta transação não é colaborativa. Um utilizador pode construí-la sozinho, envolvendo apenas os UTXOs que possui como entrada. Pode então criar uma transação Stonewall para qualquer ocasião, sem necessidade de sincronização com outro utilizador ou com o destinatário.

O funcionamento da transação Stonewall é o seguinte: na entrada da transação, o remetente utiliza 2 UTXOs que lhe pertencem. Na saída, a transação produz 4 UTXOs, 2 das quais terão exatamente o mesmo valor. As outras 2 UTXOs constituirão o restante. Entre as 2 saídas do mesmo montante, apenas uma irá efetivamente para o destinatário do pagamento.

Existem apenas 2 papéis numa transação Stonewall:


- O remetente, que efectua o pagamento;
- O destinatário, que pode não estar ciente da natureza específica da transação e está simplesmente à espera do pagamento do remetente.

Vejamos um exemplo para compreender esta estrutura de transação. Alice vai à padaria de Bob para comprar a sua baguete, que custa 4.000 sats. Ela quer pagar em bitcoin mantendo algum nível de privacidade sobre o seu pagamento. Por isso, decide construir uma transação Stonewall para o pagamento.

Analisando esta transação, podemos ver que Bob, o padeiro, recebeu 4.000 sats como pagamento pela baguete. Alice usou 2 UTXOs como entradas: uma de 10.000 sats e outra de 15.000 sats. Como outputs, ela recebeu 3 UTXOs: um de 4.000 sats, um de 6.000 sats e um de 11.000 sats. Assim, a Alice tem um saldo líquido de -4.000 sats nesta transação, que é exatamente o mesmo que o preço da baguete.

Neste exemplo, negligenciei intencionalmente as taxas de mineração para facilitar a compreensão. Na realidade, as taxas de transação são inteiramente suportadas pelo remetente.

### Quais são os objectivos de uma transação Stonewall?

A estrutura Stonewall acrescenta muita entropia à transação e confunde os traços da análise da cadeia. Do exterior, esta transação pode ser interpretada como uma mini-união de moedas entre duas pessoas. Mas, na realidade, trata-se de um pagamento. Assim, este método gera incertezas na análise da cadeia, ou mesmo leva a falsos traços.

Voltemos ao exemplo de Alice na casa de Bob, o padeiro. A transação na cadeia de blocos teria o seguinte aspeto:

![BTC204](assets/fr/174.webp)

Um observador externo que se baseie nas heurísticas comuns da análise em cadeia pode concluir erradamente que "_duas pessoas fizeram uma pequena coinjoin, com um UTXO cada na entrada e dois UTXOs cada na saída_" A análise desta transação a partir do exterior não leva à aplicação da Heurística da Propriedade Comum da Entrada (CIOH), porque a presença de duas saídas do mesmo montante sugere um padrão de coinjoin. De uma perspetiva externa, a CIOH não se aplica, portanto, neste caso particular.

![BTC204](assets/fr/175.webp)

Esta interpretação é incorrecta, porque, como sabe, um UTXO foi enviado para Bob the Baker, os 2 UTXOs na entrada vieram de Alice, e ela recuperou 3 saídas restantes.

![BTC204](assets/fr/176.webp)

E o que é particularmente interessante sobre a estrutura da transação da Stonewall é que, do ponto de vista de um observador externo, ela se parece exatamente com a de uma transação da Stonewall x2.

### A transação Stonewall x2

Stonewall x2 é outra forma específica de transação Bitcoin que também visa aumentar a privacidade do utilizador durante um gasto, mas desta vez colaborando com um terceiro não envolvido no gasto. Este método funciona como uma pseudo-coinjoin entre dois participantes enquanto efectuam um pagamento a um terceiro.

O funcionamento da transação Stonewall x2 é relativamente simples: utiliza-se um UTXO na nossa posse para efetuar o pagamento e recorre-se à ajuda de um terceiro que também contribui com um UTXO seu. A transação termina com quatro saídas: duas delas de montantes iguais, uma vai para o endereço do destinatário do pagamento, a outra para um endereço pertencente ao contribuidor. Um terceiro UTXO é enviado para outro endereço do contribuidor, permitindo-lhe recuperar o montante inicial (uma ação neutra para ele, menos as taxas de mineração), e um último UTXO regressa a um endereço que nos pertence, constituindo o resto do pagamento.

Assim, são definidos três papéis diferentes nas transacções Stonewall x2:


- O remetente, que efectua o pagamento efetivo;
- O destinatário, que pode não ter conhecimento da natureza específica da transação e que se limita a aguardar o pagamento do remetente;
- O colaborador, que fornece bitcoin para lançar dúvidas na análise da transação, recupera totalmente os seus fundos no final (uma ação neutra para ele, líquida das taxas de mineração).

Voltemos ao nosso exemplo com Alice, que está no Bob the Baker's para comprar a sua baguete que custa 4.000 sats. Ela quer pagar em bitcoin, mantendo algum nível de privacidade sobre o seu pagamento. Por isso, telefona ao seu amigo Charles, que a vai ajudar neste processo.

![BTC204](assets/fr/177.webp)

Analisando esta transação, podemos ver que o Bob, o padeiro, recebeu efetivamente 4.000 sats como pagamento pela baguete. A Alice utilizou 10.000 sats como entrada e recuperou 6.000 sats como saída, resultando num saldo líquido de -4.000 sats, que corresponde ao preço da baguete. Quanto ao Carlos, deu 15.000 sats como entrada e recebeu duas saídas: uma de 4.000 sats e outra de 11.000 sats, resultando num saldo de 0.

Neste exemplo, negligenciei intencionalmente as comissões para facilitar a compreensão. Na realidade, as comissões de mineração são geralmente partilhadas em partes iguais entre o emissor do pagamento e o contribuinte.

### Quais são os objectivos de uma transação Stonewall x2?

Tal como a estrutura Stonewall, a estrutura Stonewall x2 acrescenta uma quantidade significativa de entropia à transação e obscurece os vestígios da análise da cadeia. De um ponto de vista externo, esta transação poderia ser interpretada como uma pequena união de moedas entre duas pessoas. Mas, na realidade, trata-se de um pagamento. Por conseguinte, este método gera incertezas na análise da cadeia, conduzindo também a falsos vestígios.

Vejamos o exemplo de Alice, Bob, o padeiro, e Charles. A transação na cadeia de blocos teria o seguinte aspeto:

![BTC204](assets/fr/178.webp)

Um observador externo que se baseasse nas heurísticas comuns da análise em cadeia poderia concluir erroneamente que "_Alice e Charles realizaram uma pequena coinjoin, com um UTXO cada na entrada e dois UTXOs cada na saída_." Mais uma vez, analisar esta transação de fora não leva à aplicação da Heurística da Propriedade Comum de Entrada (CIOH), porque a presença de duas saídas do mesmo montante sugere um padrão de coinjoin. De uma perspetiva externa, a CIOH não se aplica, portanto, neste caso particular.

![BTC204](assets/fr/179.webp)

Esta interpretação é incorrecta porque, como sabe, um UTXO foi enviado para Bob, o padeiro, Alice tem apenas uma saída de repouso e Carlos tem duas.

![BTC204](assets/fr/180.webp)

E, mais uma vez, o que é particularmente interessante na estrutura de transação da Stonewall x2 é que, na perspetiva de um observador externo, parece exatamente a mesma de uma transação da Stonewall.

### Qual é a diferença entre Stonewall e Stonewall x2?

Uma transação StonewallX2 funciona exatamente como uma transação Stonewall, exceto que a primeira é colaborativa, enquanto a segunda não é. Como vimos, uma transação Stonewall x2 envolve a participação de um terceiro (Charles), que é externo ao pagamento, e que fornece os seus bitcoins para aumentar a confidencialidade da transação. Numa transação Stonewall clássica, o papel do contribuinte é assumido pelo remetente.

![BTC204](assets/fr/181.webp)

Por conseguinte, de um ponto de vista externo, o modelo de transação é exatamente o mesmo.

O facto de estas duas estruturas de transação partilharem exatamente o mesmo padrão implica que, mesmo que um observador externo possa identificar um padrão "Stonewall(x2)", não disporá de toda a informação. Não será capaz de determinar qual dos dois UTXOs de montantes iguais corresponde ao pagamento. Também não poderá determinar se as duas UTXOs de entrada vieram de duas pessoas diferentes (Stonewall x2) ou se pertenciam a uma única pessoa que se juntou a elas (Stonewall).

Este último ponto deve-se ao facto de as transacções da Stonewall x2 seguirem exatamente o mesmo padrão das transacções da Stonewall. Do exterior e sem informação de contexto adicional, é impossível diferenciar uma transação Stonewall de uma transação Stonewall x2. No entanto, as primeiras não são transacções de colaboração, enquanto as segundas o são. Este facto acrescenta ainda mais dúvidas à análise de uma dessas transacções.

### Quando utilizar as transacções Stonewall e Stonewall x2?

A lógica deve ser a seguinte quando se pretende utilizar uma ferramenta de privacidade para uma transação:


- Como prioridade, pode optar por efetuar um pagamento;
- Se o comerciante não suportar payjoins, pode ser efectuada uma transação de colaboração com outra pessoa fora do pagamento utilizando a estrutura x2 da Stonewall;
- Se não encontrar ninguém com quem fazer uma transação Stonewall x2, pode fazer uma transação Stonewall por si próprio, que imitará o comportamento de uma transação Stonewall x2.

### Como utilizar as transacções Stonewall e Stonewall x2?

As transacções Stonewall e Stonewall x2 estão disponíveis tanto na aplicação Samourai Wallet como no software Sparrow Wallet.

No entanto, tal como acontece com os payjoins, após a detenção dos fundadores da Samourai, as transacções Stonewall x2 só funcionam agora através da troca manual de PSBTs entre as partes envolvidas. A troca automática via Soroban não está, infelizmente, disponível de momento.

Também é possível realizar este tipo de transação manualmente a partir de qualquer software de carteira Bitcoin.

No próximo capítulo, estudaremos outra técnica de privacidade relativamente desconhecida, mas muito útil, para além das que já estudámos.

https://planb.network/tutorials/privacy/on-chain/stonewall-033daa45-d42c-40e1-9511-cea89751c3d4
https://planb.network/tutorials/privacy/on-chain/stonewall-x2-05120280-f6f9-4e14-9fb8-c9e603f73e5b
## Rebotes

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>

A utilização de estruturas de transação Bitcoin que acrescentam ambiguidade na análise da cadeia, como a coinjoin, é particularmente benéfica para a proteção da privacidade. No entanto, como discutimos no capítulo sobre payjoins, as transacções coinjoin são naturalmente identificáveis na cadeia. Lembre-se da analogia que estabelecemos entre criptografia e coinjoins: ao encriptar um ficheiro, um terceiro que descubra este ficheiro encriptado não pode aceder ao seu conteúdo, mas pode identificar claramente que houve uma modificação do ficheiro para ocultar o seu conteúdo. O mesmo se aplica aos coinjoins: quando um analista examina uma transação coinjoin, mesmo que não consiga estabelecer ligações diretas entre entradas e saídas (e vice-versa), pode reconhecer que a transação observada é um coinjoin.

Dependendo da utilização prevista para a sua moeda depois de passar por ciclos de coinjoin, o facto de ter sido submetida a este processo pode ser problemático. Por exemplo, se planear vender a sua moeda numa plataforma de troca regulamentada, mas esta tiver sido recentemente submetida a um coinjoin, a ferramenta de análise da cadeia da plataforma detectará este facto. A plataforma pode então recusar-se a aceitar o seu UTXO que sofreu um coinjoin, ou mesmo exigir-lhe explicações, com o risco de ver a sua conta suspensa ou os seus fundos congelados. Em alguns casos, a plataforma pode também denunciar o seu comportamento às autoridades públicas (por exemplo, é o que a TRACFIN exige aos Prestadores de Serviços de Activos Digitais (PSAN) em França).

O que precisamos para evitar isso é de uma ferramenta capaz de apagar os traços do passado de uma moeda Bitcoin, a fim de restaurar alguma forma de fungibilidade. Este é precisamente o objetivo do ricochete.

### O que é um ricochete?

Ricochet é uma técnica que envolve a realização de várias transacções fictícias para si próprio (sweeping) para simular uma transferência de propriedade de bitcoin. Esta ferramenta é diferente de outras estruturas de transação que discutimos porque não permite o anonimato prospetivo, mas sim uma forma de anonimato retrospetivo. De facto, o ricochete permite esbater as especificidades que poderiam comprometer a fungibilidade de uma moeda bitcoin devido ao seu passado.

Para ofuscar a marca deixada por um evento passado numa moeda, como os ciclos de junção de moedas, por exemplo, o ricochete realiza quatro transacções sucessivas em que o utilizador transfere fundos para si próprio em endereços diferentes.

Após esta sequência de transacções, a ferramenta de ricochete encaminha finalmente os bitcoins para o seu destino final, uma plataforma de troca.

O objetivo é criar uma distância que afecte a fungibilidade da moeda, como uma transação coinjoin, e o ato final de despesa que pode rejeitar esta moeda devido ao seu passado. Assim, as ferramentas de análise em cadeia podem concluir que houve provavelmente uma mudança de propriedade após o evento e considerar que esta moeda é fungível. No caso de um coinjoin, as ferramentas de análise da cadeia poderiam então assumir que não se trata da mesma pessoa que enviou as bitcoins e executou o coinjoin, pelo que é inútil iniciar acções contra o remetente.

### Porque é que funciona?

Perante este método de ricochete, poder-se-ia imaginar que o software de análise de cadeias aprofundaria o seu exame para além dos quatro saltos. No entanto, estas plataformas enfrentam um dilema na otimização do limiar de deteção. Têm de estabelecer um limite para o número de saltos após o qual admitem que provavelmente ocorreu uma mudança de propriedade e que a ligação a um evento anterior (como uma coinjoin) deve ser ignorada.

No entanto, a determinação deste limiar revela-se arriscada: cada extensão do número observado de saltos aumenta exponencialmente o volume de falsos positivos, ou seja, indivíduos incorretamente marcados como participantes num evento quando a transação foi realizada por outra pessoa. Este cenário representa um risco maior para estas empresas, uma vez que os falsos positivos conduzem à insatisfação, o que pode levar os clientes afectados a procurar os concorrentes. A longo prazo, um limiar de deteção demasiado elevado leva uma plataforma a perder mais clientes do que os seus concorrentes, o que pode ameaçar a sua sobrevivência. Por conseguinte, é complicado para estas plataformas aumentar o número de saltos observados, sendo que 4 é frequentemente um número suficiente para contrariar a sua análise.

O fenómeno aqui observado é, de certa forma, análogo à teoria dos seis graus de separação.

A teoria dos seis graus de separação sugere que qualquer pessoa na Terra está ligada a qualquer outra através de uma cadeia de conhecimento que não inclui mais do que seis intermediários. Bastaria passar por uma série de seis pessoas, cada uma conhecendo pessoalmente a seguinte, para chegar a qualquer indivíduo no mundo.

No caso das transacções Bitcoin, verifica-se um fenómeno semelhante. Ao rastrear um número suficiente de transacções Bitcoin, acaba-se inevitavelmente por encontrar uma coinjoin. O método ricochete explora este princípio utilizando mais hops do que as plataformas de troca podem razoavelmente seguir. Se as plataformas decidirem seguir mais transacções, é então possível simplesmente acrescentar um salto adicional para contornar esta medida.

### Quando e como utilizar o ricochete?

O caso de utilização mais comum para o ricochete ocorre quando é necessário ocultar a participação anterior numa coinjoin num UTXO de que é proprietário. Idealmente, é melhor evitar a transferência de bitcoins que passaram por uma coinjoin para entidades regulamentadas. No entanto, no caso de se encontrar sem outras opções, especialmente na urgência de liquidar bitcoin em moeda fiduciária, o ricochete oferece uma solução eficaz.

Este método é eficaz não só para a junção de moedas, mas também para quaisquer outras marcas que possam comprometer a fungibilidade de uma moeda.

A ideia para este método de ricochete veio originalmente das equipas da Samourai Wallet, que o integraram na sua aplicação para automatizar o processo. Há uma cobrança pelo serviço no Samourai, pois um ricochete acarreta uma taxa de serviço de 100.000 sats, além das taxas de mineração. Portanto, seu uso é bastante recomendado para transferências de valores significativos.

A aplicação Samourai propõe duas variações do ricochete:


- Ricochete avançado, ou "entrega escalonada", que tem a vantagem de repartir as taxas de serviço da Samourai por cinco transacções sucessivas. Esta opção assegura igualmente que cada transação é transmitida num momento distinto e registada num bloco diferente, o que permite imitar o mais possível o comportamento de uma mudança de propriedade. Embora mais lento, este método é preferível para quem não tem pressa, pois maximiza a eficiência do ricochete ao reforçar a sua resistência à análise da cadeia;
- O método clássico de ricochete, que se destina a realizar a operação rapidamente, transmitindo todas as transacções num curto espaço de tempo. Este método oferece, por conseguinte, menos privacidade e menos resistência à análise do que o método avançado. Deve ser utilizado apenas para envios urgentes.

Recochetar consiste simplesmente em enviar bitcoin para si próprio. É perfeitamente possível efetuar um ricochete manualmente em qualquer software de carteira, sem utilizar uma ferramenta especializada. Basta transferir a mesma moeda para si mesmo mais tarde, usando um novo endereço vazio de cada vez.

No capítulo seguinte, exploramos várias técnicas de transferência secreta de propriedade. Estes métodos diferem radicalmente dos que examinámos até agora, tanto em termos do seu funcionamento como dos seus resultados.

https://planb.network/tutorials/privacy/on-chain/ricochet-e0bb1afe-becd-44a6-a940-88a463756589
## Transferências secretas de propriedade

<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>

Entre as técnicas de privacidade da bitcoin está a transferência secreta de propriedade. Este método visa transferir a propriedade de bitcoins de uma pessoa para outra, e vice-versa, sem que esta transação seja explicitamente visível na cadeia de blocos. Vamos estudar em conjunto as diferentes técnicas disponíveis, bem como as suas vantagens e desvantagens.

### O CoinSwap

O CoinSwap baseia-se num conceito relativamente simples: utiliza contratos inteligentes para facilitar a transferência de propriedade de bitcoin entre dois utilizadores, sem necessidade de confiança e sem que esta transferência seja explicitamente visível na cadeia de blocos.

Imaginemos um exemplo simplificado com Alice e Bob. Alice possui 1 BTC protegido com uma chave privada $A$ e Bob também possui 1, protegido com uma chave privada $B$. Teoricamente, poderiam trocar as suas chaves privadas através de um canal de comunicação externo para efetuar uma transferência secreta.

No entanto, este método ingénuo apresenta um risco elevado em termos de confiança. Nada impede que Alice guarde uma cópia da chave privada $A$ após a troca e a utilize mais tarde para roubar bitcoins quando a chave estiver na posse de Bob.

Além disso, não existe qualquer garantia que impeça Alice de receber a chave privada de Bob $B$ e nunca enviar a sua chave privada $A$ em troca. Por conseguinte, esta troca baseia-se numa confiança excessiva entre as partes e revela-se ineficaz para garantir uma transferência secreta de propriedade de forma segura.

Para resolver estes problemas e permitir trocas entre partes que não confiam umas nas outras, podemos utilizar sistemas de contratos inteligentes. Um contrato inteligente é um programa que é executado automaticamente quando são cumpridas condições predefinidas, o que, no nosso caso, garante que a troca de bens ocorre automaticamente sem exigir confiança mútua.

Para o efeito, podemos utilizar HTLC (_Hash Time-Locked Contracts_) ou PTLC (_Point Time-Locked Contracts_). Estes dois protocolos funcionam de forma semelhante, utilizando um sistema de bloqueio de tempo que garante que a troca é concluída com êxito ou completamente cancelada, protegendo assim a integridade dos fundos de ambas as partes. A principal diferença entre o HTLC e o PTLC é que os HTLCs utilizam hashes e pré-imagens para proteger a transação, enquanto os PTLCs utilizam assinaturas adaptativas.

Num cenário de CoinSwap utilizando um HTLC ou um PTLC entre Alice e Bob, a troca ocorre de forma segura: ou é bem sucedida, e cada um recebe as BTC do outro, ou falha, e cada um mantém as suas próprias BTC. Por conseguinte, é impossível que uma das partes faça batota ou roube as BTC da outra.

> _Os HTLCs são também o mecanismo utilizado para encaminhar os pagamentos de forma segura através dos canais bidireccionais da Lightning Network
> A utilização de assinaturas adaptativas é particularmente interessante neste contexto, uma vez que permite contornar os scripts tradicionais (trata-se de um mecanismo por vezes designado por "_scriptless scripts_"). Esta caraterística ajuda a reduzir as taxas associadas à troca. Outra grande vantagem das assinaturas adaptativas é que não requerem a utilização de um hash comum para ambos os lados da transação, evitando assim revelar uma ligação direta entre eles em certos tipos de trocas.
### Assinaturas adaptativas

As assinaturas adaptativas são um método criptográfico que integra uma assinatura válida com uma assinatura adicional, denominada "assinatura adaptativa", para revelar um dado secreto. Este mecanismo foi concebido de forma a que o conhecimento de 2 dos 3 elementos seguintes: a assinatura válida, a assinatura adaptativa e o segredo, permita deduzir o terceiro elemento em falta. Uma propriedade interessante deste método é que, se conhecermos a assinatura adaptativa da nossa contraparte e o ponto específico da curva elíptica associado ao segredo utilizado para calcular esta assinatura adaptativa, podemos deduzir a nossa própria assinatura adaptativa que será compatível com esse mesmo segredo, sem nunca ter acesso direto ao próprio segredo.

Nas trocas de moedas, a utilização de assinaturas adaptativas permite a divulgação simultânea de duas informações sensíveis entre os participantes, evitando assim a necessidade de confiança mútua. Vejamos um exemplo para ilustrar este processo com Alice e Bob, que desejam trocar a propriedade de 1 BTC cada, mas não confiam um no outro. Utilizam as assinaturas adaptativas para eliminar a necessidade de confiança nesta troca. Eis como procedem:


- Alice inicia a troca criando uma transação $m_A$ que envia 1 BTC a Bob. Ela gera uma assinatura $s_A$, que valida esta transação, utilizando a sua chave privada $p_A$ ($P_A = p_A \cdot G$), um nonce $n_A$ ($N_A = n_A \cdot G$) e um segredo $t$ ($T = t \cdot G$):

$$s_A = n_A + t + H(N_A + T \paralelo P_A \paralelo m_A) \cdot p_A$$


- Alice calcula a assinatura adaptativa $s_A'$ subtraindo o segredo $t$ à sua assinatura verdadeira $s_A$:

$$s_A' = s_A - t$$


- Alice envia a Bob a sua assinatura adaptativa $s'_A$, a sua transação não assinada $m_A$, o ponto correspondente ao segredo ($T$) e o ponto correspondente ao nonce ($N_A$). Estes elementos constituem aquilo a que se chama um "_adapter_" É importante notar que, apenas com esta informação, Bob não pode recuperar o BTC de Alice.
- No entanto, Bob tem a capacidade de verificar que Alice não está a tentar roubá-lo. Para tal, verifica se a assinatura adaptativa de Alice $s_A'$ corresponde efetivamente à transação proposta $m_A$. Se a equação seguinte estiver correta, ele pode então ter a certeza de que a assinatura adaptativa de Alice é válida:

$$s_A' \cdot G = N_A + H(N_A + T \paralelo P_A \paralelo m_A) \cdot P_A$$


- Esta verificação dá a Bob garantias suficientes para proceder à troca de forma confiante. Em seguida, cria a sua própria transação $m_B$, destinada a enviar 1 BTC a Alice, e gera a sua assinatura adaptativa $s_B'$, que também estará ligada ao mesmo segredo $t$. Nesta altura, apenas Alice conhece o valor de $t$; Bob conhece apenas o ponto correspondente $T$ que Alice lhe transmitiu:

$$s_B' = n_B + H(N_B + T \paralelo P_B \paralelo m_B) \cdot p_B$$


- Bob transmite a Alice a sua assinatura adaptativa $s_B'$, a sua transação não assinada $m_B$, bem como o ponto correspondente ao segredo ($T$) e o ponto correspondente ao nonce ($N_B$). Alice, que conhece o segredo $t$, pode agora combinar a assinatura adaptativa de Bob $s_B'$ com este segredo para gerar uma assinatura válida $s_B$ para a transação $m_B$ que lhe transferirá as BTC de Bob:

$$s_B = s_B' + t$$

$$(s_B' + t) \cdot G = N_B + T + H(N_B + T \paralelo P_B \paralelo m_B) \cdot P_B$$


- Alice transmite esta transação assinada $m_B$ na blockchain da Bitcoin para recuperar as BTC prometidas por Bob. Quando Bob vê esta transação na cadeia de blocos, pode extrair a assinatura $s_B = s_B' + t$. Com esta informação, Bob consegue então isolar o famoso segredo $t$ de que precisava:

$$t = (s_B' + t) - s_B' = s_B - s_B'$$


- E, de facto, este segredo $t$ era o único elemento que faltava para Bob gerar a assinatura válida $s_A$ a partir da assinatura adaptadora de Alice $s_A'$. Esta assinatura permite validar a transação $m_A$ que envia um BTC da Alice para o Bob. Bob calcula então $s_A$ e, por sua vez, transmite a transação $m_A$ na cadeia de blocos:

$$s_A = s_A' + t$$

$$(s_A' + t) \cdot G = N_A + T + H(N_A + T \paralelo P_A \paralelo m_A) \cdot P_A$$

Vamos resumir como funciona um adaptador de assinatura numa troca de moedas. Inicialmente, Alice envia a Bob uma transação não assinada juntamente com um adaptador, que permite a Bob verificar se o segredo revelado posteriormente lhe dará acesso a bitcoins. Em troca, Bob envia a Alice a sua transação não assinada e o adaptador. Alice pode então finalizar a transação de Bob e recuperar os bitcoins transmitindo uma transação válida utilizando o segredo. Quando esta transação é publicada na cadeia de blocos, Bob tem a capacidade de extrair o segredo e, assim, desbloquear a transação de Alice. Consequentemente, se Alice iniciar uma transferência dos bitcoins de Bob, este pode, por sua vez, aceder aos bitcoins de Alice sem necessidade de confiança mútua.

É importante notar que a troca de moedas foi proposta pela primeira vez por [Gregory Maxwell em outubro de 2013 no BitcoinTalk] (https://bitcointalk.org/index.php?topic=321228.0).

### A Bolsa Atómica

À semelhança da troca de moedas e utilizando os mesmos tipos de contratos inteligentes, também é possível realizar trocas atómicas. Uma troca atómica permite uma troca direta de diferentes criptomoedas, como o BTC e o XMR, entre dois utilizadores sem exigir confiança ou a intervenção de um intermediário. Estas trocas são designadas por trocas "atómicas" porque têm apenas dois resultados possíveis: ou a troca é bem sucedida e ambas as partes ficam satisfeitas, ou falha e cada uma mantém as suas criptomoedas originais, eliminando assim a necessidade de confiança na outra parte.

![BTC204](assets/fr/197.webp)

O câmbio atómico e o câmbio de moedas partilham um método de funcionamento semelhante e oferecem as mesmas vantagens e desvantagens em termos de privacidade. De facto, do ponto de vista da Bitcoin, um câmbio atómico é comparável a um câmbio de moedas realizado em duas etapas. Primeiro, trocamos as nossas BTC por outra criptomoeda, e depois esta criptomoeda pode ser trocada por outras BTC. Por fim, recuperamos as BTC de outro utilizador. É por isso que, na análise das questões de privacidade, agrupo estes dois protocolos na categoria das trocas secretas de bens.

![BTC204](assets/fr/198.webp)

No entanto, ao contrário da troca de moedas, a troca atómica pode ter desequilíbrios em termos de liquidez disponível, especialmente nas trocas BTC/XMR. Geralmente, é mais fácil trocar bitcoin por altcoin porque existe uma grande procura de bitcoin, o que mantém baixos os prémios para esta direção de conversão. No entanto, a troca de altcoin para obter BTC pode ser mais complexa devido à menor procura, resultando frequentemente em prémios muito elevados.

Finalmente, quando uma troca atómica envolve bitcoin onchain e bitcoin na rede Lightning, referimo-nos a ela como uma "_troca submersível_"

### É realmente útil?

As transferências secretas de propriedade, como as trocas de moedas e as trocas atómicas, têm a vantagem de enganar a heurística de análise da cadeia. Estes métodos podem dar a impressão de que as transacções envolvem o mesmo utilizador, mesmo que a propriedade real tenha mudado de mãos. No entanto, a principal desvantagem destes métodos é o facto de serem muito arriscados sem a utilização de uma técnica adicional para perturbar o histórico da moeda.

Com efeito, quando Alice faz uma troca de moedas ou uma troca atómica com Bob, ela troca a propriedade dos seus bitcoins pelos bitcoins de Bob. No caso de uma troca atómica, a troca inclui uma altcoin, mas o princípio permanece o mesmo. Assim, Alice acaba por ficar com a moeda $B$ e Bob com a moeda $A$. Isto acrescenta dúvidas na análise da cadeia, mas o historial das moedas continua a ser rastreável. Se um analista examinar a moeda $A$, pode seguir as actividades anteriores de Alice, e vice-versa para a moeda $B$.

Do ponto de vista de Alice, o risco é que o historial da moeda $B$ possa ser considerado suspeito por certas entidades. Se, por exemplo, Bob tivesse adquirido a moeda $B$ num ato criminoso como a pirataria informática, esta moeda permaneceria ligada às suas actividades ilegais. Alice poderia então encontrar-se na posse de uma moeda que não poderia transferir para plataformas de negociação regulamentadas sem correr o risco de ver os seus fundos congelados, ou mesmo ser acusada dos crimes de Bob, embora não tivesse nada a ver com eles.

E, claro, os métodos de privacidade, como a troca de moedas ou a troca atómica, são preferidos pelos criminosos cujos fundos são monitorizados pelas autoridades. Estes protocolos dão-lhes a oportunidade de se desfazerem dos seus bitcoins monitorizados em troca de bitcoins perfeitamente fungíveis. Isto também lhes permite criar desvios, direcionando as autoridades para outros utilizadores. Existe assim uma dupla utilidade para estas pessoas.

Com o coinjoin, mesmo que a sua moeda seja misturada com bitcoins monitorizadas, o histórico da moeda é quebrado, o que proporciona uma forma de negação plausível que não existe em protocolos de transferência de propriedade secretos, como a troca de moedas ou o atomic swap.

Se a Alice quiser evitar qualquer risco, terá necessariamente de utilizar um método para perturbar o historial da moeda $B$, como por exemplo, passá-la por coinjoins. Isto levanta uma questão sobre a utilidade de combinar a transferência secreta de propriedade e o coinjoin. O coinjoin, ao interromper o historial de uma moeda, já proporciona um nível suficiente de privacidade à Alice. Assim, a minha opinião é que, se Alice pretende proteger a sua privacidade, seria mais prudente proceder diretamente a um coinjoin do que efetuar uma troca de moedas seguida de um coinjoin.

Para que os métodos de transferência secreta de propriedade sejam verdadeiramente eficazes e evitem o risco de associar a história de um utilizador $A$ a um utilizador $B$, seria paradoxalmente necessário que a sua utilização fosse amplamente conhecida. Se o câmbio de moedas for utilizado maciçamente e as autoridades tiverem conhecimento desta prática comum, então poderá ser estabelecida uma forma plausível de negação. No entanto, enquanto a utilização destas transferências for marginal, creio que estes métodos continuarão a ser demasiado arriscados para os utilizadores.

Até agora, estudámos principalmente os métodos de privacidade ao nível da própria transação. No próximo capítulo, exploraremos questões ao nível da rede e da difusão da transação.

## Privacidade na rede P2P

<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>

Na Parte 4, discutimos a importância de utilizar um nó completo para proteger a privacidade das suas transacções. No entanto, é importante compreender que o próprio nó pode estar sujeito a ataques que procuram extrair informações sobre as suas actividades. Neste capítulo, iremos, portanto, analisar diferentes medidas de proteção da privacidade, não ao nível das próprias transacções ou dos fluxos de bitcoin, mas ao nível da rede.

### Dente-de-leão

Uma maneira de evitar vários ataques de desanonimização é usar o Dandelion proposto. Esse protocolo de transmissão foi formalizado no BIP156, mas nunca foi implementado no Bitcoin. A ideia do Dandelion é melhorar a privacidade do roteamento de transações na rede Bitcoin para impedir várias formas de ataques. O seu principal objetivo é ocultar o nó de origem que transmite inicialmente uma transação na rede. A revelação deste nó poderia ligar uma transação Bitcoin a um endereço IP específico (se o nó operar na rede não encriptada), fornecendo assim um ponto de entrada para a análise da cadeia.

Esta associação entre uma atividade na Bitcoin e um endereço IP representa um risco significativo para a privacidade do utilizador. De facto, numerosas entidades podem facilmente associar um endereço IP a uma identidade pessoal. Isto inclui, nomeadamente, governos e fornecedores de serviços de Internet. Além disso, esta informação pode tornar-se acessível ao público, por exemplo, se o seu endereço IP e os seus dados pessoais forem expostos devido a uma fuga de dados durante a pirataria de uma base de dados de um sítio Web.

Na operação padrão do Bitcoin, as transacções construídas por um utilizador na sua carteira de software são transmitidas para o seu nó pessoal. Este nó transmite imediatamente a nova transação a todos os pares aos quais está ligado.

Estes pares verificam então a transação para garantir que esta cumpre as regras de consenso e as regras de normalização local. Uma vez validada, cada par, por sua vez, encaminha a transação para os seus pares, e assim sucessivamente.

A distribuição das transacções que aguardam integração num bloco ocorre de forma bastante equilibrada e estatisticamente previsível. Esta vulnerabilidade pode ser explorada por nós espiões em conluio, que colaboram para monitorizar e analisar a rede de modo a identificar o primeiro nó a transmitir uma transação. Se um observador conseguir localizar o nó de origem, pode assumir que a transação veio do operador desse nó. Este tipo de observação pode associar transacções, normalmente anónimas, a endereços IP específicos.

O objetivo da BIP156 é resolver este problema. Para tal, introduz uma fase adicional na transmissão de uma nova transação para preservar o anonimato antes da divulgação pública em grande escala. O Dandelion utiliza primeiro uma fase de "caule" em que a transação é enviada através de um caminho aleatório de nós.

A transação é então transmitida a toda a rede na fase de "fluff" (buraco).

O caule e o dente-de-leão são referências ao comportamento da propagação da transação através da rede, que se assemelha à forma de um dente-de-leão.

Assim, os nós espiões podem potencialmente rastrear a transação até ao nó que iniciou a fase de sopro (a transmissão maciça), mas este nó não é o primeiro a transmitir a transação, uma vez que a recebeu do último nó do tronco. Se os nós espiões não podem rastrear o tronco, também não podem identificar o nó de origem.

Mesmo na presença de nós espiões durante a fase de caule, a dúvida permanece sempre, porque assim que encontram um nó honesto no grafo de difusão, os espiões não conseguem determinar se esse nó é a fonte original ou simplesmente um intermediário.

Este método de encaminhamento dificulta o rastreio até ao nó de origem, tornando complicado seguir uma transação através da rede até à sua origem. O Dandelion melhora assim a privacidade, limitando a capacidade de os adversários desanonimizarem a rede. Este método é ainda mais eficaz quando a transação, durante a fase "stem", atravessa um nó que encripta as suas comunicações de rede, como acontece com o Tor ou o P2P Transport V2.

O BIP156 não foi integrado no Bitcoin Core e está atualmente classificado com o estatuto de "rejeitado" Uma grande preocupação sobre este protocolo reside no facto de, durante a fase de stem, as transacções terem de ser encaminhadas por nós intermédios antes de serem verificadas. Como vimos, no modelo normal do Bitcoin, cada nó verifica primeiro a transação antes de a encaminhar para os seus pares. Se uma transação não cumpre as regras de consenso ou de normalização local do nó, é ignorada e não é encaminhada. Este processo é importante para impedir ataques DoS, uma vez que apenas as transacções válidas são transmitidas a toda a rede. As transacções inválidas, potencialmente geradas em massa para sobrecarregar a rede, são paradas no primeiro nó encontrado e não se propagam. O principal risco do Dandelion é que este novo protocolo possa introduzir novos vectores para ataques DoS, permitindo que transacções inválidas sejam transmitidas através de parte da rede.

### Transporte P2P V2

O P2P Transport V2 é outro protocolo de rede apresentado no BIP324. É uma nova versão do protocolo de transporte P2P da Bitcoin que incorpora criptografia oportunista para melhorar a confidencialidade e a segurança das comunicações entre os nós.

Esta melhoria tem por objetivo resolver vários problemas da versão de base do protocolo P2P. Por um lado, torna os dados trocados indistinguíveis de outros tipos de dados que circulam na Internet para um observador passivo. O principal objetivo é evitar que governos, fornecedores de serviços de Internet ou fornecedores de VPN monitorizem massivamente os utilizadores de Bitcoin. Isso também complica a tarefa dessas entidades de determinar se um usuário da Internet também é um usuário de Bitcoin, ou seja, se eles estão operando um nó completo.

O P2P V2 também ajuda a reduzir os riscos de censura e ataques, detectando padrões específicos nos pacotes de dados. Complica e torna mais dispendiosa a execução de vários tipos de ataques Sybil a nível da rede. Um ataque Sybil ocorre quando um ator cria várias identidades falsas para obter vantagens indevidas. No contexto da rede Bitcoin, isto manifesta-se frequentemente quando um ator controla um grande número de nós completos e os utiliza de forma agressiva para multiplicar as ligações. Os ataques Sybil podem ser passivos, com o objetivo de recolher informações e comprometer a confidencialidade do utilizador, ou activos, sob a forma de ataques Eclipse. Estes últimos isolam um nó específico do resto da rede, permitindo-lhe censurar o utilizador ou alterar os dados que recebe. Por último, o P2P V2 torna os ataques _Man-In-The-Middle_ (MITM) mais dispendiosos e mais fáceis de detetar.

A encriptação implementada pelo P2P V2 não inclui autenticação para não acrescentar complexidade desnecessária e não comprometer a natureza sem permissões da ligação de rede. No entanto, este novo protocolo de transporte P2P proporciona uma melhor segurança contra ataques passivos e torna os ataques activos significativamente mais dispendiosos e detectáveis. A introdução de um fluxo de dados pseudo-aleatório nas mensagens da rede complica a tarefa dos atacantes que pretendem censurar ou manipular as comunicações.

O transporte P2P V2 foi incluído como uma opção (desativado por defeito) na versão 26.0 do Bitcoin Core, implementado em dezembro de 2023. Ele foi então habilitado por padrão na versão 27.0 em abril de 2024. Ele pode ser alterado com a opção `v2transport=` no arquivo de configuração.

### Tor

Uma solução relativamente simples para evitar os riscos de perda de confidencialidade para um nó a nível de rede é executá-lo inteiramente sob Tor. Tor é uma rede de servidores de retransmissão (nós) que torna anónima a origem das ligações TCP através da Internet. Funciona através do encapsulamento de dados em várias camadas de encriptação. Cada nó de retransmissão remove uma camada para revelar o endereço do nó seguinte, até que o destino final seja alcançado. A rede Tor garante o anonimato ao impedir que os nós intermédios conheçam a origem e o destino dos dados, tornando muito difícil a um observador seguir a atividade do utilizador.

Tor, portanto, não apenas criptografa os dados comunicados, mas também permite que a origem e o destino das comunicações sejam mascarados. Ao usar o Tor para as comunicações dos nós pessoais, melhoramos a privacidade das nossas transacções: o Fornecedor de Serviços de Internet (ISP) não consegue desencriptar as comunicações e os outros nós da rede Bitcoin não conseguem identificar o endereço IP do nó de origem. Além disso, Tor também esconde o uso de Bitcoin do ISP.

O principal risco associado a este método é o facto de o Tor ser um protocolo independente do Bitcoin. Se você tem um nó Bitcoin sob Tor e Tor pára de funcionar, então seu nó Bitcoin não será mais capaz de se comunicar.

Além disso, é importante notar que as comunicações no Tor são mais lentas. Essa latência é particularmente problemática durante o lançamento inicial de um nó, já que o Initial Block Download (IBD) requer muita comunicação. Como resultado, a sincronização inicial com a rede Bitcoin pode ser significativamente mais longa usando Tor. Também é possível executar o IBD na rede aberta e depois ativar o Tor mais tarde. Embora este método revele a existência do seu nó Bitcoin ao seu ISP, ele protege a sua informação pessoal de transação assim que mudar para o Tor.

Depois de ter explorado os diferentes métodos de privacidade a nível da rede, quero também apresentar nos próximos capítulos duas soluções elegantes para evitar a reutilização de endereços: BIP47 e Silent Payments.

## BIP47 e códigos de pagamento reutilizáveis

<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>

Como vimos na Parte 3, a reutilização de endereços é um sério obstáculo à privacidade do utilizador no protocolo Bitcoin. Para mitigar esses riscos, é altamente recomendável gerar um novo endereço de recebimento para cada novo pagamento recebido em uma carteira. Embora hoje a geração de um novo endereço seja simplificada pelo uso de softwares modernos e carteiras hierárquicas determinísticas, essa prática pode parecer contraintuitiva.

No sistema bancário tradicional, por exemplo, estamos habituados a partilhar o nosso IBAN, que permanece sempre o mesmo. Quando o dizemos a alguém, essa pessoa pode enviar-nos vários pagamentos sem ter de voltar a interagir connosco. Os neobancos oferecem também possibilidades mais modernas, como a utilização de endereços de correio eletrónico únicos no PayPal ou de RevTags no Revolut. Mesmo fora do domínio financeiro, os nossos identificadores diários, como o endereço postal, o número de telefone e o endereço de correio eletrónico, são únicos e permanentes. Não temos de os renovar a cada nova interação.

No entanto, o funcionamento da Bitcoin é diferente: é imperativo gerar um novo endereço de receção para cada transação recebida. Este compromisso entre facilidade de utilização e privacidade remonta às próprias origens do livro branco da Bitcoin. Desde a publicação da primeira versão do seu documento no final de 2008, Satoshi Nakamoto já nos tinha alertado para este risco:

**"_Como firewall adicional, pode ser utilizado um novo par de chaves para cada transação para as manter desvinculadas de um proprietário comum

Existem vários métodos para receber vários pagamentos num único identificador sem causar reutilização de endereços. Cada um destes métodos tem as suas próprias vantagens e desvantagens. Entre esses métodos está o BIP47, uma proposta desenvolvida por Justus Ranvier e publicada em 2015. Esta proposta visa criar códigos de pagamento reutilizáveis que permitam múltiplas transacções para a mesma pessoa, evitando a reutilização de endereços. Na sua essência, o BIP47 procura oferecer um sistema de pagamento intuitivo como identificador único, preservando a privacidade das transacções.

![BTC204](assets/fr/212.webp)

O BIP47 não melhora diretamente a privacidade do utilizador, uma vez que um pagamento BIP47 oferece o mesmo nível de privacidade que uma transação Bitcoin clássica utilizando endereços novos. No entanto, torna a utilização da Bitcoin mais cómoda e intuitiva, uma facilidade que normalmente teria de comprometer a privacidade. Graças ao BIP47, esta facilidade de utilização atinge o mesmo nível de privacidade que uma transação clássica. É por isso que o BIP47 é uma ferramenta valiosa para a preservação da privacidade.

Inicialmente, o BIP47 era uma proposta formulada para ser integrada no Bitcoin Core, mas nunca foi adoptada. No entanto, alguns softwares optaram por implementá-lo de forma independente no nível do aplicativo. Assim, as equipas da Samourai Wallet desenvolveram a sua própria implementação do BIP47 chamada "PayNym"

### Princípio geral do BIP47 e PayNym

O objetivo do BIP47 é permitir a receção de numerosos pagamentos sem provocar a reutilização de endereços. Baseia-se na utilização de um código de pagamento reutilizável, que permite a diferentes remetentes enviar vários pagamentos para um único código pertencente a outro utilizador. Assim, o destinatário não tem de fornecer um novo endereço para cada transação, o que facilita muito as suas trocas, preservando a sua privacidade.

![BTC204](assets/it/66/4.webp)

Um utilizador pode então partilhar livremente o seu código de pagamento, quer nas redes sociais quer no seu próprio sítio Web, sem correr o risco de perder a sua privacidade, ao contrário do que aconteceria com um endereço de receção ou uma chave pública clássicos.

Para realizar uma transação, ambas as partes devem ter uma carteira Bitcoin com uma implementação de BIP47, como PayNym na Samourai Wallet ou Sparrow Wallet. A utilização conjunta dos seus códigos de pagamento cria um canal secreto entre eles. Para estabelecer este canal de forma eficiente, o remetente deve realizar uma transação específica na cadeia de blocos da Bitcoin, conhecida como "transação de notificação" (fornecerei mais detalhes sobre isto mais tarde).

A combinação dos códigos de pagamento de ambos os utilizadores gera segredos partilhados, que por sua vez permitem a criação de um grande número de endereços de receção Bitcoin únicos (exatamente 2^32, ou cerca de 4 mil milhões). Assim, os pagamentos efectuados através do BIP47 não são realmente endereçados ao código de pagamento em si, mas sim a endereços de receção clássicos derivados dos códigos de pagamento dos utilizadores envolvidos.

O código de pagamento serve então como um identificador virtual derivado da semente da carteira. Na estrutura de derivação hierárquica da carteira, o código de pagamento é colocado no nível 3, ou seja, no nível da conta.

![BTC204](assets/it/66/5.webp)

O objetivo de derivação para o BIP47 é identificado pelo índice `47'` (`0x8000002F`), que se refere ao BIP47. Um exemplo de um caminho de derivação para um código de pagamento reutilizável seria o seguinte:

```plaintext
m/47'/0'/0'/
```

Para dar uma ideia de como é um código de pagamento, eis o meu:

```plaintext
M8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Este código também pode ser codificado num código QR para facilitar a comunicação, tal como um endereço de receção clássico.

Quanto aos PayNym Bots, estes robots por vezes vistos no Twitter são representações visuais de códigos de pagamento, criados pela Samourai Wallet. São gerados através de uma função de hashing, o que lhes confere um carácter quase único. Aparecem como uma pequena sequência de caracteres que começam por `+`:

```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

Estes avatares também podem ser representados como imagens:

![BTC204](assets/fr/215.webp)

Embora estes robôs não tenham uma funcionalidade técnica específica no âmbito do quadro BIP47, desempenham um papel na facilitação das interações entre os utilizadores, oferecendo uma identidade visual facilmente reconhecível.

---
*Nas secções seguintes deste capítulo dedicadas ao BIP47, examinaremos o seu funcionamento em pormenor, concentrando-nos em particular nos métodos criptográficos utilizados. Para compreender plenamente estas explicações bastante técnicas, é essencial compreender primeiro a estrutura das carteiras HD, os processos de derivação de chaves e os princípios básicos da criptografia baseada em curvas elípticas. Se quiser saber mais sobre estes conceitos, existe outro curso gratuito disponível na Plan ₿ Network:*

https://planb.network/courses/46b0ced2-9028-4a61-8fbc-3b005ee8d70f
*Recomendo vivamente que o siga, porque compreender o funcionamento técnico do BIP47 ajudá-lo-á muito mais facilmente a compreender outras propostas semelhantes que discutiremos nos próximos capítulos.*

---
### Código de pagamento reutilizável

Como mencionado anteriormente, o código de pagamento reutilizável está localizado no nível 3 da carteira HD, tornando-o comparável a um `xpub`, tanto na sua posição dentro da estrutura da carteira como na sua função.

O código de pagamento de 80 bytes divide-se da seguinte forma:


- Byte `0`: Versão**. Para a primeira versão da BIP47, este byte é definido como `0x01`;
- Byte `1`: O campo dos bits**. Este espaço é reservado para a incorporação de indicações suplementares aquando de utilizações específicas. Para utilização normal com PayNym, este byte é definido como `0x00`;
- Byte `2`: A paridade de `y`**. Este byte é `0x02` ou `0x03`, indicando se a ordenada da chave pública é par ou ímpar, uma vez que é utilizada uma chave pública comprimida;
- Do byte `3` ao byte `34`: O valor de `x`**. Estes bytes representam a abscissa da chave pública. A concatenação de `x` e a paridade de `y` formam a chave pública comprimida completa;
- Do byte `35` ao byte `66`: Código da cadeia**. Este espaço contém o código da cadeia associado à chave pública;
- Do byte `67` ao byte `79`: Preenchimento**. Este espaço é destinado a possíveis desenvolvimentos futuros. Para a versão atual, os zeros são simplesmente colocados aqui para atingir o tamanho de 80 bytes necessário para uma saída `OP_RETURN`.

Eis a representação hexadecimal do meu código de pagamento reutilizável já apresentado na secção anterior:

```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

![BTC204](assets/it/66/7.webp)

Antes de mais, é necessário acrescentar o byte de prefixo `P` no início para indicar claramente que se trata de um código de pagamento. Este byte é representado por `0x47`:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

Por último, para garantir a integridade do código de pagamento, é efectuado um cálculo da soma de controlo utilizando o `HASH256`, que consiste num duplo hash com a função `SHA256`. Os quatro primeiros bytes resultantes deste hash são depois concatenados no final do código de pagamento:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

Uma vez concluídos estes passos, o código de pagamento está pronto. O único passo que falta é convertê-lo para a base 58 para obter a sua versão final:

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Durante este processo de criação do código de pagamento, utilizamos uma chave pública comprimida e um código de cadeia. Ambos são derivados por derivação determinística e hierárquica a partir da semente da carteira. O caminho de derivação utilizado para o conseguir é:

```plaintext
m/47'/0'/0'/
```

Para gerar a chave pública comprimida e o código de cadeia associado para o código de pagamento reutilizável, começamos por calcular a chave privada principal a partir da semente da carteira. De seguida, derivamos um par de chaves filha usando o índice `47 + 2^31` (derivação reforçada). Este passo é seguido por mais duas derivações sucessivas de pares de chaves filhas, cada uma usando o índice `2^31` (derivação reforçada).

### A troca de chaves Elliptic-Curve Diffie-Hellman (ECDH)

O protocolo criptográfico que está no cerne da BIP47 é designado pelo acrónimo ECDH, que significa _Elliptic-Curve Diffie-Hellman_. Este método é uma variante do método original de troca de chaves Diffie-Hellman.

Introduzido em 1976, Diffie-Hellman é um protocolo de acordo de chaves que permite que duas partes, cada uma equipada com um par de chaves (pública e privada), cheguem a acordo sobre um segredo comum, mesmo quando comunicam exclusivamente através de um canal público e inseguro.

![BTC204](assets/it/66/10.webp)

Este segredo partilhado (neste caso, a chave azul) pode então ser utilizado para outras operações. Normalmente, este segredo partilhado pode ser utilizado para encriptar e desencriptar comunicações através de uma rede insegura:

![BTC204](assets/fr/220.webp)

Para realizar esta troca, Diffie-Hellman utiliza aritmética modular para calcular o segredo partilhado. Segue-se uma explicação simplificada do seu funcionamento:


- Alice e Bob acordam numa cor comum, neste caso o amarelo, que constitui um dado público (os atacantes conhecem esta cor);
- A Alice seleciona uma cor secreta, neste caso o vermelho, e mistura as duas para obter o laranja;
- O Bob também escolhe uma cor secreta, aqui azul, e mistura-a com amarelo para obter verde;
- Em seguida, trocam as cores obtidas, laranja e verde. Esta troca pode ter lugar numa rede insegura e observada;
- Ao misturar o verde do Bob com a sua cor secreta, a Alice produz o castanho;
- O Bob, fazendo o mesmo com o laranja da Alice e o seu azul secreto, também obtém castanho.

![BTC204](assets/it/66/12.webp)

Nesta simplificação, a cor castanha representa o segredo partilhado entre Alice e Bob. É importante compreender que, na realidade, é impossível para o atacante separar as cores laranja e verde para descobrir as cores secretas de Alice ou Bob.

Agora, vamos examinar como este protocolo funciona de facto, não com analogias de cores, mas usando números reais e aritmética modular!

Antes de discutir os mecanismos de Diffie-Hellman, permitam-me que vos recorde brevemente dois conceitos matemáticos essenciais de que necessitaremos:


- Um **número primo** é um número natural que tem apenas dois divisores: $1$ e ele próprio. Por exemplo, $7$ é um número primo porque só pode ser dividido por $1$ e $7$. Por outro lado, $8$ não é um número primo porque é divisível por $1$, $2$, $4$ e $8$. Portanto, tem quatro divisores inteiros positivos em vez de dois;
- O **mod** (denotado $mod$ ou $\%$) é uma operação matemática que, entre dois números inteiros, devolve o resto da divisão euclidiana do primeiro pelo segundo. Por exemplo, $16 \bmod 5 = 1$.

**A troca de chaves Diffie-Hellman entre Alice e Bob procede da seguinte forma:**


- Alice e Bob concordam em dois números comuns: $p$ e $g$. $p$ é um número primo, e quanto maior este número, mais seguro será o Diffie-Hellman. $g$ é uma raiz primitiva de $p$. Estes dois números podem ser comunicados abertamente através de uma rede não segura. Representam o equivalente à **cor amarela** na simplificação acima. Por isso, é importante que a Alice e o Bob utilizem exatamente os mesmos valores para $p$ e $g$.

Uma vez definidos estes parâmetros, a Alice e o Bob escolhem um número secreto aleatório. A Alice chama ao seu número secreto aleatório $a$ (equivalente à **cor vermelha**) e o Bob chama ao seu $b$ (equivalente à **cor azul**). Estes números devem permanecer estritamente confidenciais.

Em vez de trocar diretamente os números $a$ e $b$, cada lado calcula $A$ e $B$ da seguinte forma:

$A$ é igual a $g$ elevado à potência de $a$ modulo $p$:

$$
A = g^a \bmod p
$$

$B$ é igual a $g$ elevado à potência de $b$ modulo $p$:

$$
B = g^b \bmod p
$$

Os valores $A$ (equivalente a **a cor laranja**) e $B$ (equivalente a **a cor verde**) são trocados entre as duas partes. Esta troca pode ter lugar abertamente através de uma rede não segura;

A Alice, tendo recebido $B$, calcula o valor de $z$ da seguinte forma:

$z$ é igual a $B$ elevado à potência de $a$ modulo $p$:

$$
z = B^a \bmod p
$$

Recall:

$$
B = g^b \bmod p
$$

Assim, obtemos:

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

Aplicar as regras de expoentes:

$$
(x^n)^m = x^{nm}
$$

Obtém-se assim:

$$
z = g^{ba} \bmod p
$$


- Por seu lado, o Bob, tendo recebido $A$, também calcula o valor de $z$ da seguinte forma:

$z$ é igual a $A$ elevado à potência de $b$ modulo $p$:

$$
z = A^b \bmod p
$$

Assim, obtemos:

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

Devido à distributividade do operador de módulo, a Alice e o Bob obtêm exatamente o mesmo valor $z$. Este número representa o seu segredo comum, equivalente à **cor castanha** na simplificação anterior com potes de tinta. Podem agora utilizar este segredo comum para encriptar simetricamente as suas comunicações através de uma rede não segura.

Um atacante, mesmo na posse de $p$, $g$, $A$ e $B$ (os valores públicos), não será capaz de calcular $a$, $b$ ou $z$ (os valores privados). Para o fazer, seria necessário inverter a exponenciação, uma tarefa impossível sem tentar todas as possibilidades uma a uma, uma vez que é equivalente a calcular o logaritmo discreto, ou seja, a inversa da exponencial num grupo cíclico finito.

Por conseguinte, desde que os valores de $a$, $b$ e $p$ sejam suficientemente grandes, o protocolo Diffie-Hellman é seguro. Tipicamente, com parâmetros de 2048 bits (um número com 600 dígitos em decimal), testar todas as possibilidades para $a$ e $b$ seria impraticável. Até à data, com estes números, este algoritmo é considerado seguro.

É precisamente aqui que reside a principal desvantagem do protocolo Diffie-Hellman. Para ser seguro, o algoritmo tem de utilizar números grandes. É por isso que, hoje em dia, se prefere o algoritmo ECDH (_Elliptic Curve Diffie-Hellman_), uma variante do Diffie-Hellman que se baseia numa curva algébrica, mais precisamente numa curva elíptica. Esta abordagem permite trabalhar com números muito mais pequenos, mantendo uma segurança equivalente, reduzindo assim os recursos necessários para o cálculo e o armazenamento.

O princípio geral do algoritmo permanece o mesmo. No entanto, em vez de utilizarmos um número aleatório $a$ e um número $A$ calculado a partir de $a$ por exponenciação modular, utilizamos um par de chaves estabelecido numa curva elíptica. Em vez de nos basearmos na distributividade do operador de módulo, utilizamos a lei de grupo em curvas elípticas e, mais especificamente, a associatividade desta lei.

Para explicar brevemente o princípio da criptografia de curva elíptica, uma chave privada é representada por um número aleatório entre $1$ e $n-1$, em que $n$ representa a ordem da curva. A chave pública, por outro lado, é um ponto específico dessa curva, obtido a partir da chave privada por operações de adição e duplicação de pontos a partir do ponto gerador, de acordo com a equação:

$$
K = k \cdot G
$$

Nesta fórmula, $K$ representa a chave pública, $k$ a chave privada e $G$ o ponto de geração.

Uma das caraterísticas essenciais destas chaves é a facilidade de calcular $K$ a partir de $k$ e $G$, enquanto é virtualmente impossível encontrar $k$ a partir de $K$ e $G$. Esta assimetria cria uma função unidirecional. Por outras palavras, é fácil calcular a chave pública se conhecermos a chave privada, mas é impossível encontrar a chave privada a partir da chave pública. Esta segurança continua a basear-se na dificuldade computacional do logaritmo discreto.

Utilizaremos esta propriedade para adaptar o nosso algoritmo Diffie-Hellman. **O princípio de funcionamento do ECDH é o seguinte:**


- Alice e Bob chegam a acordo sobre uma curva elíptica criptograficamente segura e os seus parâmetros. Esta informação é pública;
- Alice gera um número aleatório $ka$ que será a sua chave privada. Esta chave privada deve permanecer secreta. Ela determina a sua chave pública $Ka$ através da adição e duplicação de pontos na curva elíptica escolhida:

$$
K_a = k_a \cdot G
$$


- Bob também gera um número aleatório $kb$ que será a sua chave privada. Ele calcula a chave pública associada $kb$:

$$
K_b = k_b \cdot G
$$


- Alice e Bob trocam as suas chaves públicas $Ka$ e $Kb$ numa rede pública não segura.
- Alice calcula um ponto $(x,y)$ na curva aplicando a sua chave privada $ka$ à chave pública de Bob $Kb$:

$$
(x,y) = k_a \cdot K_b
$$


- Bob calcula um ponto $(x,y)$ na curva aplicando a sua chave privada $kb$ à chave pública de Alice $Ka$:

$$
(x,y) = k_b \cdot K_a
$$


- Alice e Bob obtêm o mesmo ponto na curva elíptica. O segredo partilhado será a coordenada $x$ deste ponto.

De facto, obtêm o mesmo segredo partilhado porque:

(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a

$$
Un attaccante che osserva la rete pubblica non protetta può ottenere solo le chiavi pubbliche di ciascuna parte e i parametri della curva ellittica scelta. Come precedentemente spiegato, queste informazioni da sole non sono sufficienti per determinare le chiavi private. Pertanto, l'attaccante non può trovare il segreto condiviso tra Alice e Bob.
ECDH è quindi un algoritmo che consente lo scambio di chiavi. È spesso utilizzato in combinazione con altri metodi crittografici per stabilire un protocollo completo. Ad esempio, ECDH è integrato nel nucleo di TLS (_Transport Layer Security_), un protocollo di crittografia e autenticazione utilizzato per il livello di trasporto di Internet. TLS utilizza ECDHE per lo scambio di chiavi, una variante di ECDH dove le chiavi sono effimere, per garantire la confidenzialità persistente. Inoltre, TLS utilizza algoritmi di autenticazione come ECDSA, algoritmi di crittografia come AES e funzioni hash come SHA256.
TLS è notevolmente responsabile della `s` in `https` così come del lucchetto visibile nella barra degli indirizzi del tuo browser, simboli delle comunicazioni criptate. Seguendo questo corso, stai quindi utilizzando ECDH, ed è molto probabile che lo usi quotidianamente senza nemmeno saperlo.
### La Transazione di Notifica
Come abbiamo visto nella sezione precedente, ECDH è una variante dello scambio Diffie-Hellman che utilizza coppie di chiavi stabilite su una curva ellittica. Convenientemente, possediamo già molte coppie di chiavi aderenti a questo standard nei nostri portafogli Bitcoin! L'idea di BIP47 è di utilizzare le coppie di chiavi dei portafogli Bitcoin gerarchici deterministici di entrambe le parti per stabilire segreti condivisi ed effimeri tra di loro. Nel contesto di BIP47, viene utilizzato ECDHE (_Elliptic Curve Diffie-Hellman Ephemeral_).
ECDHE viene utilizzato per la prima volta in BIP47 per trasmettere il codice di pagamento dal mittente al destinatario. Questo è il famoso **notification transaction**. Questo passaggio è essenziale perché affinché BIP47 funzioni efficacemente, entrambe le parti coinvolte (il mittente e il destinatario) devono conoscere il codice di pagamento dell'altro. Questa conoscenza consente la derivazione di chiavi pubbliche effimere e, di conseguenza, indirizzi di ricezione vuoti associati.
Prima di questo scambio, il mittente è logicamente già a conoscenza del codice di pagamento del destinatario poiché lo ha recuperato off-chain, ad esempio, dal loro sito web, una fattura o i loro social media. Tuttavia, il destinatario potrebbe non conoscere necessariamente il codice di pagamento del mittente. Eppure, questo codice deve essere trasmesso a loro; altrimenti, non saranno in grado di derivare le chiavi effimere necessarie per identificare gli indirizzi dove sono conservati i loro bitcoin, né accedere ai loro fondi. Sebbene questa trasmissione del codice del mittente possa tecnicamente essere effettuata off-chain attraverso altri mezzi di comunicazione, ciò pone un problema se il portafoglio deve essere recuperato solo dal seme.
Infatti, a differenza degli indirizzi convenzionali, gli indirizzi BIP47 non sono derivati direttamente dal seed del destinatario—utilizzare un `xpub` sarebbe più semplice in questo caso—ma risultano da un calcolo che combina i codici di pagamento di entrambi: quello del mittente e quello del destinatario. Pertanto, se il destinatario perde il proprio portafoglio e tenta di ripristinarlo dal proprio seed, recupererà il proprio codice di pagamento, che è derivato direttamente dal loro seed. Tuttavia, per trovare gli indirizzi effimeri, sarà essenziale per loro avere anche i codici di pagamento di tutti coloro che hanno inviato loro bitcoin tramite BIP47. Da qui l'importanza della transazione di notifica, che consente di salvare queste informazioni sulla blockchain di Bitcoin, pur essendo in grado di trovarle molto facilmente senza dover cercare tra il miliardo di transazioni eseguite dal suo lancio nel 2009.
![BTC204](assets/it/66/15.webp)
Pertanto, sarebbe possibile implementare BIP47 senza ricorrere alla transazione di notifica, a condizione che ogni utente conservi un backup dei codici di pagamento dei propri pari. Tuttavia, questo metodo si rivela complesso da gestire finché non viene sviluppata una soluzione semplice, robusta ed efficiente per creare, conservare e aggiornare questi backup. Nello stato attuale delle cose, la transazione di notifica diventa quasi indispensabile.
Nei capitoli seguenti, studieremo altri protocolli con obiettivi simili a quelli di BIP47, ma che non richiedono una transazione di notifica. Queste alternative, tuttavia, introducono i propri compromessi.
Oltre al suo ruolo nel backup dei codici di pagamento, la transazione di notifica serve anche una funzione di notifica per il destinatario, come suggerisce il suo nome. Segnala al client del destinatario che è stato stabilito un nuovo canale di pagamento e suggerisce quindi di monitorare gli indirizzi effimeri risultanti.
### Il Modello di Privacy di BIP47
Prima di dettagliare il funzionamento tecnico della transazione di notifica, è importante discutere il modello di privacy associato a BIP47, che giustifica alcune misure prese durante la creazione di questa transazione iniziale.
Il codice di pagamento, di per sé, non rappresenta un rischio diretto per la privacy. A differenza del modello Bitcoin tradizionale, che mira a rompere il collegamento tra l'identità di un utente e le sue transazioni (che sono pubbliche) preservando l'anonimato di chiavi e indirizzi, il codice di pagamento può essere apertamente associato a un'identità senza rappresentare una minaccia.
Infatti, il codice di pagamento non è utilizzato per derivare direttamente gli indirizzi che ricevono pagamenti BIP47. Questi indirizzi sono invece generati attraverso l'applicazione di ECDH tra le chiavi derivate dai codici di pagamento delle due parti coinvolte.
Così, un codice di pagamento di per sé non porta direttamente a una perdita di privacy, poiché solo l'indirizzo di notifica è derivato da esso. Sebbene questo indirizzo possa rivelare alcune informazioni, normalmente non consente di scoprire le parti con cui si stanno conducendo transazioni, a meno che non si effettui un'analisi approfondita della catena. Infatti, se il mittente utilizza UTXO che possono essere collegati alla loro identità per eseguire la transazione di notifica, allora diventa possibile dedurre che la loro identità è probabilmente collegata ai pagamenti BIP47 al tuo codice di pagamento. Questo non rivelerà le transazioni sottostanti, ma indicherà la loro probabile esistenza.
Pertanto, è essenziale mantenere questa stretta separazione tra i codici di pagamento degli utenti. Verso questo obiettivo, il passo iniziale di comunicazione del codice è un momento critico per la privacy del pagamento, ma obbligatorio per il corretto funzionamento del protocollo. Se uno dei codici di pagamento può essere ottenuto pubblicamente (come su un sito web), il secondo codice, quello del mittente, non deve essere collegato al primo in nessun caso.
Prendiamo un esempio concreto: voglio fare una donazione a un movimento politico tramite BIP47:
- L'organizzazione ha reso pubblico il suo codice di pagamento sul suo sito web o tramite i suoi social network;
- Questo codice è quindi collegato al movimento politico;
- Recupero questo codice di pagamento;
- Prima di procedere con un invio, devo assicurarmi che conoscano il mio codice di pagamento, che è anche collegato alla mia identità poiché lo uso per ricevere transazioni sui miei social network.
Come trasmettere il mio codice senza rischi? L'uso di mezzi di comunicazione convenzionali potrebbe portare a una fuga di informazioni e, di conseguenza, associarmi a questo movimento politico. La transazione di notifica offre una soluzione grazie a uno strato di crittografia che impedisce precisamente questa associazione tra due codici. Sebbene questo non sia l'unico metodo per trasmettere segretamente il codice di pagamento del mittente, si dimostra molto efficace.
Nel diagramma sottostante, le linee arancioni indicano i punti in cui il flusso di informazioni deve essere interrotto, e le frecce nere mostrano le connessioni che potrebbero potenzialmente essere osservate da terze parti:
![BTC204](assets/it/66/16.webp)
In realtà, all'interno del modello tradizionale di privacy di Bitcoin, è spesso complesso dissociare completamente il flusso di informazioni tra la coppia di chiavi e l'utente, specialmente durante le transazioni a distanza. Ad esempio, nel contesto di una campagna di donazione, il destinatario deve inevitabilmente divulgare un indirizzo o una chiave pubblica tramite il loro sito web o social network. L'uso corretto di BIP47, in particolare con la transazione di notifica, permette di aggirare questo problema grazie a ECDHE e allo strato di crittografia che studieremo ulteriormente.
Ovviamente, il modello classico di privacy di Bitcoin si applica ancora alle chiavi pubbliche effimere, che sono derivate dalla combinazione dei due codici di pagamento. I due modelli sono in realtà complementari. Quello che voglio evidenziare qui è che, contrariamente all'uso abituale di una chiave pubblica per ricevere bitcoin, il codice di pagamento può essere collegato a una specifica identità, perché l'informazione "_Alice effettua una transazione con Bob_" viene interrotta in un'altra fase. Il codice di pagamento viene utilizzato per generare indirizzi di pagamento, ma basandosi unicamente sull'osservazione della blockchain, è impossibile collegare una transazione di pagamento BIP47 ai codici di pagamento utilizzati per eseguirla, a meno che gli UTXO coinvolti non fossero già collegati a un'identità precedentemente e gli utenti non abbiano associato i loro codici di pagamento alle rispettive identità.
Per riassumere, il modello di privacy offerto dai pagamenti BIP47 potrebbe essere considerato superiore a quello della base di Bitcoin, anche se non è magico in alcun modo.
### Costruzione della Transazione di Notifica
Ora, vediamo come funziona questa transazione di notifica. Immaginiamo che Alice voglia inviare fondi a Bob con BIP47. Nel mio esempio, Alice agisce come mittente e Bob come destinatario. Quest'ultimo ha pubblicato il suo codice di pagamento sul suo sito web. Pertanto, Alice è già a conoscenza del codice di pagamento di Bob.
**1- Alice calcola un segreto condiviso con ECDH:**
- Seleziona una coppia di chiavi dal suo portafoglio HD situato su un ramo diverso dal suo codice di pagamento. Nota, questa coppia non dovrebbe essere facilmente associata all'indirizzo di notifica di Alice, né all'identità di Alice (vedi sezione precedente);
- Alice seleziona la chiave privata da questa coppia. La chiamiamo $a$ (minuscolo);
$$

a

$$
```text
- Alice recupera la chiave pubblica associata all'indirizzo di notifica di Bob. Questa chiave è la prima figlia derivata dal codice di pagamento di Bob (indice $/0$). Chiamiamo questa chiave pubblica $B$ (maiuscolo). La chiave privata associata a questa chiave pubblica è chiamata $b$ (minuscolo). $B$ è determinata dall'addizione e dal raddoppio dei punti sulla curva ellittica da $G$ (il punto generatore) con $b$ (la chiave privata):
$$ B = b \cdot G $$
- Alice calcola un punto segreto $S$ (maiuscolo) sulla curva ellittica tramite l'addizione e il raddoppio dei punti applicando la sua chiave privata $a$ dalla chiave pubblica di Bob $B$.
$$ S = a \cdot B $$
- Alice calcola il fattore di oscuramento $f$ che le permetterà di criptare il suo codice di pagamento. Per fare ciò, determinerà un numero pseudo-casuale con la funzione HMAC-SHA512. Nel secondo input di questa funzione, utilizza un valore che solo Bob potrà recuperare: $x$ che è l'ascissa del punto segreto precedentemente calcolato. Il primo input è $o$ che è l'UTXO consumato in input di questa transazione (outpoint).
$$ f = \text{HMAC-SHA512}(o, x) $$
**2- Alice converte il suo codice di pagamento personale in base 2 (binario).**
**3- Utilizza questo fattore di oscuramento come chiave per eseguire la crittografia simmetrica sul payload del suo codice di pagamento.** L'algoritmo di crittografia utilizzato è semplicemente un `XOR`. L'operazione eseguita è paragonabile alla cifratura di Vernam, anche denominata "One-Time Pad".
- Alice prima divide il suo fattore di oscuramento in due: i primi 32 byte sono denominati $f1$ e gli ultimi 32 byte sono denominati $f2$. Quindi, abbiamo:
$$ f = f1 || f2 $$
- Alice calcola l'$x'$ criptato dell'ascissa della chiave pubblica $x$ del suo codice di pagamento, e il $c'$ criptato del suo codice catena $c$ separatamente. $f1$ e $f2$ agiscono rispettivamente come chiavi di crittografia. L'operazione utilizzata è il `XOR` (o esclusivo).
$$ x' = x \oplus f1 $$
$$ c' = c \oplus f2 $$
- Alice sostituisce i valori reali dell'ascissa della chiave pubblica $x$ e del codice catena $c$ nel suo codice di pagamento con i valori criptati $x'$ e $c'$.
**4-** Alice ora ha il suo codice di pagamento con un payload criptato. Costruirà e trasmetterà una transazione che coinvolge la sua chiave pubblica $A$ come input, un output all'indirizzo di notifica di Bob, e un output `OP_RETURN` contenente il suo codice di pagamento con il payload criptato. **Questa transazione è la transazione di notifica**.
Un `OP_RETURN` è un opcode che segna un output di una transazione Bitcoin come non valido. Oggi, è utilizzato per trasmettere o ancorare informazioni sulla blockchain di Bitcoin. Fino a 80 byte di dati possono essere memorizzati, che sono scritti sulla catena e quindi visibili a tutti gli altri utenti.
Come abbiamo visto nelle sezioni precedenti, ECDH è utilizzato per generare un segreto condiviso tra due utenti che comunicano su una rete non sicura, potenzialmente osservata da attaccanti. In BIP47, ECDH è utilizzato per la comunicazione sulla rete Bitcoin, che per sua natura è una rete di comunicazione trasparente osservata da molti attaccanti. Il segreto condiviso calcolato tramite lo scambio di chiavi ECDH è poi utilizzato per criptare le informazioni segrete da trasmettere: il codice di pagamento del mittente (di Alice).
Ricapitoliamo i passaggi che abbiamo appena esaminato insieme per eseguire una transazione di notifica:
- Alice recupera il codice di pagamento e l'indirizzo di notifica di Bob;
- Alice seleziona un UTXO che possiede nel suo portafoglio HD con la corrispondente coppia di chiavi;
- Calcola un punto segreto sulla curva ellittica utilizzando ECDH;
- Utilizza questo punto segreto per calcolare un HMAC, che è il fattore di oscuramento;
- Utilizza questo fattore di oscuramento per criptare il payload del suo codice di pagamento personale.
- Lei utilizza un output di transazione `OP_RETURN` per comunicare il codice di pagamento mascherato a Bob.
![BTC204](assets/it/66/17.webp)
### Transazione di Notifica: Studio Concreto
Per comprendere meglio il suo funzionamento, in particolare l'uso di `OP_RETURN`, esaminiamo insieme una vera transazione di notifica. Ho eseguito tale transazione sulla testnet, che potete trovare [cliccando qui](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e).
![BTC204](assets/fr/227.webp)
Osservando questa transazione, possiamo vedere che ha un singolo input e 4 output:
- Il primo output è l'`OP_RETURN` che contiene il mio codice di pagamento mascherato;
- Il secondo output di 546 sats punta all'indirizzo di notifica del mio destinatario;
- Il terzo output di 15.000 sats rappresenta le commissioni di servizio, poiché ho utilizzato Samourai Wallet per costruire questa transazione;
- Il quarto output di 2 milioni di sats rappresenta il resto, ovvero la differenza rimanente dal mio input che ritorna a un altro indirizzo che mi appartiene.
Il più interessante da studiare è ovviamente l'output 0 che utilizza l'`OP_RETURN`. Vediamo più da vicino cosa contiene. Ecco lo `scriptPubKey` in esadecimale:
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

```text
In questo script, possiamo sezionare diverse parti. Prima di tutto, gli opcode:
6a4c
```

```text
Tra gli opcode, possiamo riconoscere `0x6a` che designa l'`OP_RETURN` e `0x4c` che designa l'`OP_PUSHDATA1`.
Il byte seguente questo ultimo opcode indica la dimensione del payload che segue. Indica `0x50`, ovvero 80 byte:
6a4c50
```

```text
Poi, abbiamo i metadati del mio codice di pagamento in chiaro:
010002
```

```text
La coordinata x criptata della chiave pubblica del mio codice di pagamento:
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

```text
Il codice catena criptato del mio codice di pagamento:
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

```text
E infine, il padding per raggiungere 80 byte, la dimensione standard di un `OP_RETURN`:
00000000000000000000000000
```

```
Per capire meglio, ecco il mio codice di pagamento in chiaro in base 58:
````text
PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU
Quando si confronta il mio codice di pagamento in chiaro con l'`OP_RETURN`, è evidente che l'HRP (`0x47`) e il checksum (`0x8604e4db`) non vengono trasmessi. Questo è previsto, poiché queste informazioni sono destinate agli esseri umani.
Successivamente, possiamo identificare la versione (`0x01`), il campo di bit (`0x00`) e la parità della chiave pubblica (`0x02`). E, alla fine del codice di pagamento, i byte vuoti (`0x00000000000000000000000000`) sono utilizzati per riempire il codice fino a un totale di 80 byte. Tutti questi metadati vengono trasmessi in chiaro (non criptati).
Infine, si può osservare che la coordinata x della chiave pubblica (`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`) e il codice catena (`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`) sono stati criptati. Questo costituisce il payload del codice di pagamento.
### Cos'è XOR?
Nelle sezioni precedenti, abbiamo visto che il codice di pagamento è stato trasmesso criptato utilizzando l'operazione XOR. Prendiamoci un momento per capire come funziona questo operatore, poiché è ampiamente utilizzato nella crittografia.
XOR è un operatore logico bit a bit basato sull'algebra booleana. Con due operandi bit, restituisce `1` se i bit dello stesso rango sono diversi, e restituisce `0` se i bit dello stesso rango sono uguali. Ecco la tabella di verità di XOR basata sui valori degli operandi `D` e `E`:
| D   | E   | D XOR E |
| --- | --- | ------- |
| 0   | 0   | 0       |
| 0   | 1   | 1       |
| 1   | 0   | 1       |
| 1   | 1   | 0       |
Per esempio:
$$

$$
0110 \oplus 1110 = 1000
Oppure:
$$

$$
010011 \oplus 110110 = 100101
Con ECDH, l'uso di XOR come strato di crittografia è particolarmente adatto. Innanzitutto, a causa di questo operatore, la crittografia è simmetrica. Questo consente al destinatario di decifrare il codice di pagamento con la stessa chiave utilizzata per la crittografia. La chiave di crittografia e decrittografia viene calcolata dal segreto condiviso grazie a ECDH. Questa simmetria è resa possibile dalle proprietà commutativa e associativa dell'operatore XOR:
- Altre proprietà:
$$

$$
D \oplus D = 0
D ⊕ 0 = D
- Commutatività:
$$

$$
D \oplus E = E \oplus D
- Associatività:
$$

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
Se:
$$

$$
D \oplus E = L
Allora:
$$

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
Successivamente, questo metodo di cifratura assomiglia molto al cifrario di Vernam (One-Time Pad), l'unico algoritmo di cifratura conosciuto fino ad oggi che possiede sicurezza incondizionata (o assoluta). Affinché il cifrario di Vernam abbia questa caratteristica, la chiave di cifratura deve essere perfettamente casuale, deve essere della stessa dimensione del messaggio e deve essere utilizzata una sola volta. Nel metodo di cifratura utilizzato qui per BIP47, la chiave è effettivamente della stessa dimensione del messaggio, il fattore di offuscamento è esattamente della stessa dimensione della concatenazione della coordinata x della chiave pubblica con il codice catena del codice di pagamento. Questa chiave di cifratura è effettivamente utilizzata una sola volta. Tuttavia, questa chiave non è il risultato di una casualità perfetta poiché è un HMAC. È piuttosto pseudo-casuale. Pertanto, non si tratta di un cifrario di Vernam, ma il metodo è simile.
### Ricezione della Transazione di Notifica
Ora che Alice ha inviato la transazione di notifica a Bob, vediamo come lui la interpreta. Come promemoria, Bob deve essere in grado di accedere al codice di pagamento di Alice. Senza queste informazioni, come vedremo nella sezione seguente, non sarà in grado di derivare le coppie di chiavi create da Alice e, quindi, non sarà in grado di accedere ai suoi bitcoin ricevuti tramite BIP47. Per ora, il payload del codice di pagamento di Alice è criptato. Vediamo come Bob lo decifra.
**1-** Bob monitora le transazioni che creano output con il suo indirizzo di notifica.
**2-** Quando una transazione ha un output sul suo indirizzo di notifica, Bob la analizza per vedere se contiene un output OP_RETURN che segue lo standard BIP47.
**3-** Se il primo byte del payload OP_RETURN è `0x01`, Bob inizia la sua ricerca di un possibile segreto condiviso con ECDH:
- Bob seleziona la chiave pubblica nell'input della transazione. Ovvero, la chiave pubblica di Alice denominata $A$ con:
$$ A = a \cdot G $$
- Bob seleziona la chiave privata $b$ associata al suo indirizzo di notifica personale:
$$ b $$
- Bob calcola il punto segreto $S$ (segreto condiviso ECDH) sulla curva ellittica sommando e raddoppiando i punti, applicando la sua chiave privata $b$ alla chiave pubblica di Alice $A$:
$$ S = b \cdot A $$
- Bob determina il fattore di offuscamento $f$ che gli permetterà di decifrare il payload del codice di pagamento di Alice. Nello stesso modo in cui Alice aveva precedentemente calcolato, Bob troverà $f$ applicando HMAC-SHA512 su $x$ la coordinata x del punto segreto $S$, e su $o$ l'UTXO consumato come input in questa transazione di notifica:
$$ f = \text{HMAC-SHA512}(o, x) $$
**4-** Bob interpreta i dati nell'OP_RETURN della transazione di notifica come un codice di pagamento. Egli semplicemente decifra il payload di questo potenziale codice di pagamento usando il fattore di offuscamento $f$:
- Bob divide il fattore di offuscamento $f$ in 2 parti: i primi 32 byte di $f$ saranno $f1$ e gli ultimi 32 byte saranno $f2$;
- Bob decifra la coordinata x cifrata $x'$ della chiave pubblica dal codice di pagamento di Alice:
$$ x = x' \oplus f1 $$
- Bob decifra il valore del codice catena cifrato $c'$ dal codice di pagamento di Alice:
$$ c = c' \oplus f2 $$
**5-** Bob verifica se il valore della chiave pubblica dal codice di pagamento di Alice è effettivamente parte del gruppo secp256k1. Se è così, lo interpreta come un codice di pagamento valido. Altrimenti, ignora questa transazione.
Ora che Bob è a conoscenza del codice di pagamento di Alice, lei può inviargli fino a `2^32` pagamenti, senza mai dover effettuare un'altra transazione di notifica di questo tipo.
Perché funziona? Come fa Bob a determinare lo stesso fattore di offuscamento di Alice, e quindi a decifrare il suo codice di pagamento? Esaminiamo più da vicino il ruolo di ECDH in quello che abbiamo appena descritto.
Prima di tutto, stiamo trattando con la crittografia simmetrica. Questo significa che la chiave di cifratura e la chiave di decifratura sono lo stesso valore. Questa chiave nella transazione di notifica è il fattore di offuscamento:
$$ f = f1 || f2 $$
Pertanto, Alice e Bob devono ottenere lo stesso valore per $f$, senza trasmetterlo direttamente poiché un attaccante potrebbe rubarlo e decifrare le informazioni segrete. Questo fattore di offuscamento si ottiene applicando HMAC-SHA512 su 2 valori:
- la coordinata x di un punto segreto;
- e l'UTXO consumato come input nella transazione.
Bob, quindi, ha bisogno di queste due informazioni per decifrare il payload del codice di pagamento di Alice. Per l'UTXO come input, Bob può semplicemente recuperarlo osservando la transazione di notifica. Per il punto segreto, Bob dovrà usare ECDH. Come visto nella sezione precedente su Diffie-Hellman, semplicemente scambiando le rispettive chiavi pubbliche e applicando segretamente le proprie chiavi private alla chiave pubblica dell'altro, Alice e Bob possono trovare un punto specifico e segreto sulla curva ellittica. La transazione di notifica si basa su questo meccanismo:
- Coppia di chiavi di Bob:
$$ B = b \cdot G $$
- Coppia di chiavi di Alice:
$$ A = a \cdot G $$
- Per un segreto $S (x, y)$:
$$ S = a \cdot B = a \cdot (b \cdot G) = (b \cdot a) \cdot G = b \cdot A $$
Ora che Bob conosce il codice di pagamento di Alice, sarà in grado di rilevare i suoi pagamenti BIP47, e può derivare le chiavi private che bloccano i bitcoin ricevuti.
Ricapitoliamo i passaggi che abbiamo appena esaminato per ricevere e interpretare una transazione di notifica:
- Bob monitora gli output delle transazioni al suo indirizzo di notifica;
- Quando ne rileva uno, recupera le informazioni contenute nell'OP_RETURN;
- Bob seleziona la chiave pubblica in input e calcola un punto segreto usando ECDH;
- Usa questo punto segreto per calcolare un HMAC che è il fattore di offuscamento;
- Usa questo fattore di offuscamento per decifrare il payload del codice di pagamento di Alice contenuto nell'OP_RETURN.
### La Transazione di Pagamento BIP47
Studiamo ora insieme il processo di pagamento con BIP47. Per ricordarvi lo stato attuale delle cose:
- Alice conosce il codice di pagamento di Bob, che ha semplicemente recuperato dal suo sito web;
- Bob conosce il codice di pagamento di Alice grazie alla transazione di notifica;
- Alice effettuerà un primo pagamento a Bob. Potrà effettuarne molti altri allo stesso modo.
Prima di spiegare questo processo, penso sia importante ricordare gli indici su cui stiamo attualmente lavorando. Il percorso di derivazione di un codice di pagamento è descritto come segue: `m/47'/0'/0'`. La profondità successiva distribuisce gli indici in questo modo:
- La prima coppia di chiavi figlio normali (non rinforzate) è quella utilizzata per generare l'indirizzo di notifica di cui abbiamo parlato nella parte precedente: `m/47'/0'/0'/0`;
- Le coppie di chiavi figlio normali sono utilizzate all'interno di ECDH per generare indirizzi di ricezione dei pagamenti BIP47 come vedremo in questa sezione: da `m/47'/0'/0'/0` a `m/47'/0'/0'/2 147 483 647`;
- Le coppie di chiavi figlio rinforzate sono codici di pagamento effimeri: da `m/47'/0'/0'/0'` a `m/47'/0'/0'/2 147 483 647'`.
Ogni volta che Alice desidera inviare un pagamento a Bob, deriva un nuovo indirizzo vergine unico, grazie ancora al protocollo ECDH:
- Alice seleziona la prima chiave privata derivata dal suo codice di pagamento personale riutilizzabile:
$$ a $$
- Alice seleziona la prima chiave pubblica inutilizzata derivata dal codice di pagamento di Bob. Questa chiave pubblica, la chiameremo $B$. È associata alla chiave privata $b$ che solo Bob conosce:
$$ B = b \cdot G $$
- Alice calcola un punto segreto $S$ sulla curva ellittica tramite addizione e raddoppio di punti applicando la sua chiave privata $a$ alla chiave pubblica $B$ di Bob:
$$ S = a \cdot B $$
- Da questo punto segreto, Alice calcolerà il segreto condiviso $s$ (minuscolo). Per fare ciò, seleziona la coordinata x del punto segreto $S$ denominata $Sx$, e passa questo valore attraverso la funzione hash SHA256:
$$ S = (Sx, Sy) $$
$$ s = \text{SHA256}(Sx) $$
- Alice utilizza questo segreto condiviso $s$ per calcolare un indirizzo Bitcoin di ricezione dei pagamenti. Inizialmente, verifica che $s$ sia contenuto nell'ordine della curva secp256k1. In caso contrario, incrementa l'indice della chiave pubblica di Bob per derivare un altro segreto condiviso;
- In secondo luogo, calcola una chiave pubblica $K0$ aggiungendo sulla curva ellittica i punti $B$ e $s·G$. In altre parole, Alice aggiunge la chiave pubblica derivata dal codice di pagamento di Bob $B$ con un altro punto calcolato sulla curva ellittica tramite addizione e raddoppio con il segreto condiviso $s$ dal punto generatore della curva secp256k1 $G$. Questo nuovo punto rappresenta una chiave pubblica, e lo chiamiamo $K0$:
$$ K0 = B + s \cdot G $$
- Con questa chiave pubblica $K0$, Alice può derivare un indirizzo vergine standard di ricezione (per esempio, SegWit V0 in bech32).
Una volta che Alice ha ottenuto l'indirizzo di ricezione di Bob $K0$, può eseguire una transazione Bitcoin in modo standard. Per fare ciò, seleziona un UTXO di sua proprietà, assicurato da una coppia di chiavi di un ramo diverso del suo portafoglio HD, e lo spende per soddisfare un output all'indirizzo di Bob $K0$. È importante notare che questo pagamento, una volta derivato l'indirizzo, segue un processo convenzionale e non dipende più dalle chiavi associate a BIP47.
Ricapitoliamo i passaggi che abbiamo appena eseguito insieme per inviare un pagamento BIP47:
- Alice seleziona la prima chiave privata derivata dal suo codice di pagamento personale;
- Calcola un punto segreto sulla curva ellittica utilizzando ECDH dalla prima chiave pubblica derivata non utilizzata dal codice di pagamento di Bob;
- Utilizza questo punto segreto per calcolare un segreto condiviso con SHA256;
- Utilizza questo segreto condiviso per calcolare un nuovo punto segreto sulla curva ellittica;
- Aggiunge questo nuovo punto segreto alla chiave pubblica di Bob;
- Ottiene una nuova chiave pubblica effimera per la quale solo Bob ha la chiave privata associata;
- Alice può effettuare una transazione standard a Bob con l'indirizzo di ricezione effimero derivato.
![BTC204](assets/it/66/21.webp)
Se Alice desidera effettuare un secondo pagamento, seguirà gli stessi passaggi di prima, eccetto che questa volta selezionerà la seconda chiave pubblica derivata dal codice di pagamento di Bob. Specificamente, utilizzerà la prossima chiave non utilizzata. Otterrà così un nuovo indirizzo di ricezione appartenente a Bob, designato $K1$:
![BTC204](assets/it/66/22.webp)
Può continuare in questo modo e derivare fino a `2^32` indirizzi non utilizzati appartenenti a Bob.
Da un punto di vista esterno, osservando la blockchain, è teoricamente impossibile differenziare un pagamento BIP47 da un pagamento standard. Ecco un esempio di transazione di pagamento BIP47 sul Testnet:
```

94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
````
Questo sembra una transazione standard con un input consumato, un output di pagamento e un resto:
![BTC204](assets/fr/232.webp)
### Ricevere il Pagamento BIP47 e Derivare la Chiave Privata
Alice ha appena effettuato il suo primo pagamento a un nuovo indirizzo BIP47 appartenente a Bob. Ora vediamo come Bob riceve questo pagamento. Vedremo anche perché Alice non ha accesso alla chiave privata dell'indirizzo che ha appena generato da sola, e come Bob recupera questa chiave per spendere i bitcoin che ha appena ricevuto.
Non appena Bob riceve la transazione di notifica da Alice, deriva la chiave pubblica BIP47 $K0$ anche prima che lei abbia inviato qualsiasi pagamento. Poi monitora qualsiasi pagamento all'indirizzo associato. Infatti, deriva immediatamente diversi indirizzi che monitorerà ($K0$, $K1$, $K2$, $K3$...). Ecco come deriva questa chiave pubblica $K0$:
- Bob seleziona la prima chiave privata derivata dal suo codice di pagamento. Questa chiave privata è denominata $b$. È associata alla chiave pubblica $B$ con cui Alice aveva fatto i suoi calcoli nel passaggio precedente:
$$ b $$
- Bob seleziona la prima chiave pubblica di Alice derivata dal suo codice di pagamento. Questa chiave è denominata $A$. È associata alla chiave privata $a$ con cui Alice aveva fatto i suoi calcoli, e di cui solo Alice è a conoscenza. Bob può eseguire questo processo poiché è a conoscenza del codice di pagamento di Alice che le è stato trasmesso con la transazione di notifica:
$$ A = a \cdot G $$
- Bob calcola il punto segreto $S$, mediante addizione e raddoppio di punti sulla curva ellittica, applicando la sua chiave privata $b$ alla chiave pubblica di Alice $A$. Qui troviamo l'uso di ECDH che garantisce che questo punto $S$ sarà lo stesso sia per Bob che per Alice:
$$ S = b \cdot A $$
- Proprio come ha fatto Alice, Bob isola la coordinata x di questo punto $S$. Abbiamo chiamato questo valore $Sx$. Egli passa questo valore attraverso la funzione SHA256 per trovare il segreto condiviso $s$ (minuscolo):
$$ s = \text{SHA256}(Sx) $$
- Proprio come Alice, Bob calcola il punto $s·G$ sulla curva ellittica. Poi, aggiunge questo punto segreto alla sua chiave pubblica $B$. Ottiene così un nuovo punto sulla curva ellittica che interpreta come una chiave pubblica $K0$:
$$ K0 = B + s \cdot G $$
Una volta che Bob ha questa chiave pubblica $K0$, può derivare la chiave privata associata per essere in grado di spendere i suoi bitcoin. È l'unico che può generare questa chiave privata:
- Bob aggiunge la sua chiave privata figlio $b$ derivata dal suo codice di pagamento personale. È l'unico che può ottenere il valore di $b$. Poi, aggiunge $b$ con il segreto condiviso $s$ per ottenere $k0$, la chiave privata di $K0$:
$$ k0 = b + s $$
Grazie alla legge di gruppo della curva ellittica, Bob ottiene esattamente la chiave privata corrispondente alla chiave pubblica usata da Alice. Abbiamo quindi:
$$ K0 = k0 \cdot G $$
Riassumerò i passaggi che abbiamo appena esaminato insieme per ricevere un pagamento BIP47 e calcolare la chiave privata corrispondente:
- Bob seleziona la prima chiave privata figlio derivata dal suo codice di pagamento personale;
- Calcola un punto segreto sulla curva ellittica usando ECDH dalla prima chiave pubblica figlio derivata dal codice catena di Alice;
- Usa questo punto segreto per calcolare un segreto condiviso con SHA256;
- Usa questo segreto condiviso per calcolare un nuovo punto segreto sulla curva ellittica;
- Aggiunge questo nuovo punto segreto alla sua chiave pubblica personale;
- Ottiene una nuova chiave pubblica effimera, alla quale Alice invierà il suo primo pagamento;
- Bob calcola la chiave privata associata a questa chiave pubblica effimera aggiungendo la sua chiave privata figlio derivata dal suo codice di pagamento e il segreto condiviso.
![BTC204](assets/it/66/24.webp)
Poiché Alice non può ottenere $b$ (la chiave privata di Bob), lei non è in grado di determinare $k0$ (la chiave privata associata all'indirizzo di ricezione BIP47 di Bob). Schematicamente, possiamo rappresentare il calcolo del segreto condiviso $S$ così:
![BTC204](assets/it/66/19.webp)
Una volta trovato il segreto condiviso con ECDH, Alice e Bob calcolano la chiave pubblica di pagamento BIP47 $K0$, e Bob calcola anche la chiave privata associata $k0$:
![BTC204](assets/it/66/25.webp)
### Rimborsare il Pagamento BIP47
Poiché Bob è a conoscenza del codice di pagamento riutilizzabile di Alice, ha già tutte le informazioni necessarie per inviarle un rimborso. Non avrà bisogno di contattare nuovamente Alice per chiedere informazioni. Dovrà semplicemente notificarla con una transazione di notifica, specialmente affinché lei possa recuperare i suoi indirizzi BIP47 con il suo seed, e poi potrà anche inviarle fino a `2^32` pagamenti.
La funzionalità di rimborso è specifica per BIP47 ed è uno dei suoi vantaggi rispetto ad altri metodi che studieremo nei prossimi capitoli, come i Pagamenti Silenziosi.
Bob può quindi rimborsare Alice nello stesso modo in cui lei gli ha inviato i pagamenti. I ruoli si invertono:
![BTC204](assets/it/66/26.webp)
_Un grande ringraziamento a [Fanis Michalakis](https://x.com/FanisMichalakis) per la sua revisione e preziosi consigli esperti sull'articolo che ha ispirato la scrittura di questo capitolo!_
https://planb.network/tutorials/privacy/on-chain/paynym-bip47-a492a70b-50eb-4f95-a766-bae2c5535093
## Pagamenti Silenziosi
<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>
Il BIP47 è stato criticato per la sua inefficienza sulla blockchain. Come spiegato nel capitolo precedente, richiede una transazione di notifica per ogni nuovo destinatario. Questo vincolo diventa trascurabile se si prevede di stabilire un canale di pagamento duraturo con questo destinatario. Infatti, una singola transazione di notifica apre la strada a un numero quasi infinito di pagamenti BIP47 successivi.
Tuttavia, in determinate situazioni, la transazione di notifica può rappresentare un ostacolo per l'utente. Prendiamo l'esempio di una donazione una tantum a un destinatario: con un indirizzo Bitcoin classico, una singola transazione è sufficiente per effettuare la donazione. Ma con il BIP47, sono necessarie due transazioni: una per la notifica e un'altra per il pagamento effettivo. Quando la domanda di spazio nel blocco è bassa e le commissioni di transazione sono minime, questo passaggio aggiuntivo generalmente non rappresenta un problema. Tuttavia, durante i periodi di congestione, le commissioni di transazione possono diventare esorbitanti per un singolo pagamento, potenzialmente raddoppiando il costo per l'utente rispetto a una transazione Bitcoin standard, il che può essere inaccettabile per l'utente.
Per situazioni in cui l'utente prevede di effettuare solo pochi pagamenti a un identificatore statico, sono state sviluppate altre soluzioni. Tra queste ci sono i Pagamenti Silenziosi, descritti nel [BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki). Questo protocollo consente l'uso di un identificatore statico per ricevere pagamenti senza generare riutilizzo dell'indirizzo e senza richiedere l'uso di transazioni di notifica. Esaminiamo come funziona questo protocollo.
---
_Per comprendere appieno questo capitolo, è essenziale essere familiari con il funzionamento di ECDH (Elliptic Curve Diffie-Hellman) e la derivazione delle chiavi crittografiche in un portafoglio HD. Questi concetti sono stati dettagliati nel capitolo precedente sul BIP47. Non li ripeterò qui. Se non sei ancora familiare con queste nozioni, ti consiglio di consultare il capitolo precedente prima di continuare con questo. Non riprenderò nemmeno i rischi associati al riutilizzo degli indirizzi di ricezione, né l'importanza di avere un identificatore unico per ricevere pagamenti._
---
### Perché non spostare la notifica?
Come discusso nel capitolo sul BIP47, la transazione di notifica svolge principalmente due funzioni:
- Notifica il destinatario;
- Trasmette il codice di pagamento del mittente.
Si potrebbe ingenuamente pensare che questo processo di notifica potrebbe essere effettuato off-chain. In teoria, ciò è completamente fattibile: sarebbe sufficiente per il destinatario indicare un mezzo di comunicazione per ricevere i codici di pagamento BIP47 dai mittenti. Tuttavia, questo approccio presenta due problemi principali:
- Primo, ciò sposterebbe il processo di trasmissione del codice su un altro protocollo di comunicazione. Le questioni relative ai costi e alla privacy dello scambio rimarrebbero, ma sarebbero semplicemente trasferite a questo nuovo protocollo. In termini di privacy, ciò potrebbe anche creare un collegamento tra l'identità di un utente e l'attività sulla blockchain, cosa che cerchiamo di evitare eseguendo la notifica direttamente sulla blockchain. Inoltre, effettuare la notifica fuori dalla blockchain introdurrebbe rischi di censura (come il blocco dei fondi) che non esistono su Bitcoin;
Successivamente, ciò porrebbe un problema di recupero. Con BIP47, il destinatario deve assolutamente conoscere i codici di pagamento dei mittenti per accedere ai fondi. Questo è vero al momento della ricezione, ma anche in caso di recupero dei fondi tramite il seed in caso di perdita del portafoglio. Con le notifiche onchain, questo rischio viene evitato, poiché l'utente può trovare e decifrare le transazioni di notifica semplicemente conoscendo il proprio seed. Tuttavia, se la notifica viene eseguita fuori dalla blockchain, l'utente dovrebbe mantenere un backup dinamico di tutti i codici di pagamento ricevuti, il che è impraticabile per l'utente medio.
Tutti questi vincoli rendono l'uso della notifica onchain indispensabile nel contesto di BIP47. Eppure, i Pagamenti Silenziosi cercano specificamente di evitare questo passaggio di notifica onchain a causa del suo costo. Pertanto, la soluzione adottata non è spostare la notifica, ma eliminarla completamente. Per raggiungere questo obiettivo, deve essere accettato un compromesso: quello della scansione. A differenza di BIP47, dove l'utente sa esattamente dove trovare i propri fondi grazie alle transazioni di notifica, nel contesto dei Pagamenti Silenziosi, l'utente deve esaminare tutte le transazioni Bitcoin esistenti per rilevare eventuali pagamenti che potrebbero essere destinati a loro. Per ridurre questo onere operativo, la ricerca di Pagamenti Silenziosi è limitata solo alle transazioni che probabilmente contengono tali pagamenti, ovvero quelle che includono almeno un output Taproot P2TR. La scansione si concentra esclusivamente anche sulle transazioni dalla data di creazione del portafoglio (non c'è bisogno di scandire transazioni risalenti al 2009 se il portafoglio è stato creato nel 2024).
Pertanto, potete vedere perché BIP47 e Pagamenti Silenziosi, sebbene mirino a un obiettivo simile, comportano compromessi diversi e **quindi si rivolgono effettivamente a casi d'uso distinti**. Per i pagamenti una tantum, come le donazioni occasionali, i Pagamenti Silenziosi sono più appropriati a causa del loro costo inferiore. Al contrario, per le transazioni regolari allo stesso destinatario, come nel caso delle piattaforme di scambio o dei pool di mining, BIP47 potrebbe essere preferito.
Esploriamo insieme il funzionamento tecnico dei Pagamenti Silenziosi per capirne meglio le implicazioni. Per fare ciò, suggerisco di adottare lo stesso approccio del documento esplicativo di BIP352. Scomporremo gradualmente i calcoli da eseguire, elemento per elemento, giustificando ogni nuova aggiunta.
### Alcuni concetti da comprendere
Prima di iniziare, è importante chiarire che i Pagamenti Silenziosi si basano esclusivamente sull'uso di tipi di script P2TR (_Pay to Taproot_). A differenza di BIP47, non è necessario derivare gli indirizzi di ricezione dalle chiavi pubbliche figlie tramite hashing. Infatti, nello standard P2TR, la chiave pubblica modificata viene utilizzata direttamente e apertamente nell'indirizzo. Così, un indirizzo di ricezione Taproot è essenzialmente una chiave pubblica accompagnata da alcuni metadati. Questa chiave pubblica modificata è l'aggregazione di altre due chiavi pubbliche: una che consente la spesa diretta e tradizionale tramite una semplice firma, e l'altra che rappresenta la radice di Merkle del MAST, che autorizza la spesa soggetta alla soddisfazione di una delle condizioni potenzialmente iscritte nell'albero di Merkle.
![BTC204](assets/it/67/01.webp)
La decisione di limitare i Pagamenti Silenziosi esclusivamente a Taproot è motivata da due ragioni principali:
- Primo, facilita significativamente l'implementazione e gli aggiornamenti futuri nel software del portafoglio, poiché è necessario aderire a un solo standard;
- In secondo luogo, questo approccio aiuta a migliorare l'insieme di anonimato degli utenti incoraggiandoli a non disperdersi tra diversi tipi di script, che generano impronte di portafoglio distinte nell'analisi della catena (per maggiori informazioni su questo concetto, vi invito a consultare il capitolo 4 della parte 2).
### Derivazione naive di una chiave pubblica di Pagamenti Silenziosi
Iniziamo con un semplice esempio che ti aiuterà a comprendere il funzionamento di base dei Pagamenti Silenziosi (SP, Silent Payments). Prendiamo Alice e Bob, due utenti Bitcoin. Alice vuole inviare bitcoin a Bob su un nuovo indirizzo di ricezione. Tre obiettivi devono essere raggiunti in questo processo:
- Alice deve essere in grado di generare un nuovo indirizzo;
- Bob deve essere in grado di identificare un pagamento inviato a questo specifico indirizzo;
- Bob deve essere in grado di ottenere la chiave privata associata a questo indirizzo per poter spendere i suoi fondi.
Alice ha un UTXO nel suo portafoglio Bitcoin protetto con la seguente coppia di chiavi:
- $a$: la chiave privata;
- $A$: la chiave pubblica ($A = a \cdot G$)
Bob ha un indirizzo SP che ha pubblicato su internet con:
- $b$: la chiave privata;
- $B$: la chiave pubblica ($B = b \cdot G$)
Recuperando l'indirizzo di Bob, Alice è in grado di calcolare un nuovo indirizzo vuoto che appartiene a Bob usando ECDH. Chiamiamo questo indirizzo $P$:
$$ P = B + \text{hash}(a \cdot B) \cdot G $$
In questa equazione, Alice ha semplicemente calcolato il prodotto scalare della sua chiave privata $a$ e della chiave pubblica di Bob $B$. Ha passato questo risultato attraverso una funzione hash conosciuta da tutti. Il valore di output è poi moltiplicato scalarmente per il punto generatore $G$ della curva ellittica `secp256k1`. Infine, Alice aggiunge il punto ottenuto alla chiave pubblica di Bob $B$. Una volta che Alice ha questo indirizzo $P$, lo usa come output in una transazione, il che significa che invia bitcoin ad esso.
> _Nel contesto dei Pagamenti Silenziosi, la funzione "hash" corrisponde a una funzione hash SHA256 etichettata specificamente con `BIP0352/SharedSecret`, assicurando che gli hash generati siano unici per questo protocollo e non possano essere riutilizzati in altri contesti, fornendo anche una protezione aggiuntiva contro il riutilizzo di nonce nelle firme. Questo standard corrisponde a quello [specificato nel BIP340 per le firme Schnorr](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) su `secp256k1`._
Grazie alle proprietà della curva ellittica su cui si basa ECDH, sappiamo che:
$$ a \cdot B = b \cdot A $$
Bob sarà quindi in grado di calcolare l'indirizzo di ricezione su cui Alice ha inviato i bitcoin. Per fare ciò, monitora tutte le transazioni Bitcoin che soddisfano i criteri dei Pagamenti Silenziosi e applica il seguente calcolo a ciascuna di esse per vedere se il pagamento è indirizzato a lui (_scanning_):
$$ P' = B + \text{hash}(b \cdot A) \cdot G $$
Quando esamina la transazione di Alice, si rende conto che $P'$ è uguale a $P$. Sa quindi che questo pagamento è indirizzato a lui:
$$ P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P $$
Da qui, Bob sarà in grado di calcolare la chiave privata $p$ che consente di spendere l'indirizzo $P$:
$$ p = (b + \text{hash}(b \cdot A)) \bmod n $$
Come puoi vedere, per calcolare questa chiave privata $p$, è necessario avere la chiave privata $b$. Solo Bob ha questa chiave privata $b$. Sarà quindi effettivamente l'unico in grado di spendere i bitcoin inviati al suo indirizzo di Pagamenti Silenziosi.
![BTC204](assets/fr/236.webp)
_Didascalia:_
- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s$: Il segreto comune ECDH
- $P$: La chiave pubblica / indirizzo unico per il pagamento a Bob
Ecco un approccio inizialmente piuttosto ingenuo nell'uso dell'indirizzo statico di Bob, denotato $B$, per derivare un indirizzo unico $P$ per inviare bitcoin. Tuttavia, questo metodo è troppo semplicistico e presenta diversi difetti che necessitano di correzione. Il primo problema è che, in questo schema, Alice non può creare molteplici output per Bob all'interno della stessa transazione.
### Come creare molteplici output?
Nell'esempio della sezione precedente, Alice crea un singolo output che andrà a Bob al suo indirizzo unico $P$. Con lo stesso input selezionato, è impossibile per Alice creare due indirizzi vergini distinti per Bob, poiché il metodo utilizzato porterebbe sempre allo stesso risultato per $P$, quindi allo stesso indirizzo. Tuttavia, ci possono essere molte situazioni in cui Alice desidera dividere il suo pagamento a Bob in diverse piccole somme, creando così molteplici UTXO. È quindi necessario trovare un metodo che permetta di farlo.
Per raggiungere questo obiettivo, modificheremo leggermente il calcolo che Alice esegue per derivare $P$, in modo che possa generare due indirizzi distinti per Bob, ovvero $P_0$ e $P_1$.
Per modificare il calcolo e ottenere 2 indirizzi diversi, è sufficiente aggiungere un intero che modifica il risultato. Così, Alice aggiungerà $0$ nel suo calcolo per ottenere l'indirizzo $P_0$ e $1$ per ottenere l'indirizzo $P_1$. Chiamiamo questo intero $i$:
$$ P_i = B + \text{hash}(a \cdot B \text{ ‖ } i) \cdot G $$
Il processo di calcolo rimane invariato rispetto al metodo precedente, eccetto che questa volta Alice concatenerà $a \cdot B$ con $i$ prima di procedere al hash. È quindi sufficiente cambiare $i$ per avere un nuovo indirizzo appartenente a Bob. Ad esempio:
$$ P_0 = B + \text{hash}(a \cdot B \text{ ‖ } 0) \cdot G $$
$$ P_1 = B + \text{hash}(a \cdot B \text{ ‖ } 1) \cdot G $$
Quando Bob esamina la blockchain per i Pagamenti Silenziosi destinati a lui, inizia utilizzando $i = 0$ per l'indirizzo $P_0$. Se non trova nessun pagamento su $P_0$, conclude che questa transazione non contiene nessun Pagamento Silenzioso per lui e smette di analizzarla. Tuttavia, se $P_0$ è valido e contiene un pagamento per lui, procede con $P_1$ nella stessa transazione per verificare se Alice ha effettuato un secondo pagamento. Se $P_1$ risulta essere invalido, interrompe la sua ricerca per questa transazione; altrimenti, continua a testare valori successivi di $i$.
$$ P_1 = B + \text{hash}(b \cdot A \text{ ‖ } 1) \cdot G $$
Poiché Bob si ferma immediatamente a $i = 0$ se $P_0$ non produce risultati, l'uso di questo intero aggiunge quasi nessun onere operativo aggiuntivo a Bob per la fase di scansione delle transazioni.
Bob può quindi calcolare le chiavi private nello stesso modo:
$$

p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n

$$
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n
$$

_Didascalia:_


- $B$: O código público / índice estatístico publicado por Bob
- $b$: A casa privada do Bob
- $A$: O código público do UTXO de Alice utilizado como entrada para a transação
- $a$: A privacidade de Alice
- $G$: O ponto gerador da curva elíptica `secp256k1`
- $\text{SHA256}$: A função de hash SHA256 foi eliminada com `BIP0352/SharedSecret`
- $s_0$: O primeiro segredo condenado ECDH
- $s_1$: O segundo segredo condenado ECDH
- $P_0$: O primeiro código público / indicação única para o pagamento a Bob
- $P_1$: A segunda chave pública / indicação única para o pagamento a Bob

Com este método, começámos a criar um bom protocolo, mas ainda há alguns problemas a ultrapassar, em particular a prevenção da utilização excessiva de indicadores.

### Como evitar a reutilização dos índices?

Como já vimos nas secções anteriores, Alice utiliza a cópia de chaves que protegem o seu UTXO, que gasta para calcular o segredo condensado ECDH com o Bob. Este segredo permite derivar o índice único $P_0$. No entanto, a cópia de códigos ($a$, $A$) utilizada pela Alice pode proteger mais UTXO se tiver utilizado este código várias vezes. No caso em que Alice efectua dois pagamentos para o índice estático $B$ do Bob, utilizando dois UTXO protegidos pelo mesmo código $A$, isto constitui uma reutilização do índice pelo Bob.

> _A utilização de indicações é uma prática muito negativa para a privacidade dos utilizadores. Para saber porquê, recomendamos que reveja as primeiras partes desta formação._
Infatti, poiché l'indirizzo unico $P_0$ è derivato da $A$ e $B$, se Alice deriva um segundo indirizzo para um segundo pagamento a $B$, con la stessa chiave $A$, finirà per ottenere lo stesso indirizzo $P_0$. Para evitar este risco e prevenir a reutilização dos índices no interior dos Pagamenti Silenziosi, modificamos legalmente os nossos cálculos.

O que pretendemos é que cada UTXO consumido pela Alice como entrada de um pagamento tenha um índice único no registo do Bob, mesmo que mais UTXO sejam protegidos pela mesma cópia de chaves. É, portanto, suficiente acrescentar uma referência ao UTXO no cálculo do índice único $P_0$. Esta referência será simplesmente o hash do UTXO consumido como entrada:

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$

E esta referência de entrada, Alice aggiungerà nel suo calcolo dell'indirizzo unico $P_0$:

Durante a sua pesquisa, Bob pode também adicionar $\text{inputHash}$, porque tudo o que deve fazer é observar a transação para dedurar $\text{outpoint}$:

$$ P_0 = B + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0) \cdot G $$

Quando se encontra um $P_0$ válido, pode calcular-se a correspondente chave privada $p_0$:

$$
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
$$

```text
_Legenda:_
- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $H$: L'hash dell'UTXO usato come input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hash SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
Al momento, i nostri calcoli presuppongono che Alice utilizzi un singolo input per la sua transazione. Tuttavia, dovrebbe essere in grado di utilizzare più input. Di conseguenza, da parte di Bob, per ogni transazione contenente più input, teoricamente avrebbe bisogno di calcolare l'ECDH per ogni input per determinare se un pagamento è destinato a lui. Questo metodo non è soddisfacente, quindi abbiamo bisogno di trovare una soluzione per ridurre il carico di lavoro!
### Modificare le chiavi pubbliche negli input
Per risolvere questo problema, invece di utilizzare la coppia di chiavi che protegge un input specifico da parte di Alice, useremo la somma di tutte le coppie di chiavi utilizzate negli input della transazione. Questa somma sarà quindi considerata come una nuova coppia di chiavi. Questa tecnica è nota come "tweak".
Per esempio, immagina che la transazione di Alice abbia 3 input, ognuno protetto con una coppia di chiavi diversa:
- $a_0$ protegge l'input #0;
- $a_1$ protegge l'input #1;
- $a_2$ protegge l'input #2.
Seguendo il metodo descritto sopra, Alice dovrebbe scegliere una singola coppia di chiavi tra $a_0$, $a_1$ e $a_2$ per calcolare il segreto ECDH e generare l'indirizzo di pagamento unico $P$ dall'indirizzo statico $B$ di Bob. Tuttavia, questo approccio richiede a Bob di testare ogni possibilità sequenzialmente, partendo da $a_0$, poi $a_1$, e così via, fino all'identificazione di una coppia che genera un indirizzo valido $P$. Questo processo richiede che Bob esegua il calcolo ECDH su tutti gli input di tutte le transazioni, aumentando significativamente il carico di lavoro operativo di scansione.
Per evitare ciò, chiederemo ad Alice di eseguire il suo calcolo di $P$ utilizzando la somma di tutte le chiavi in input. Prendendo il nostro esempio, la chiave privata modificata $a$ sarebbe calcolata come segue:
$$ a = a_0 + a_1 + a_2 $$
Allo stesso modo, Alice e Bob saranno in grado di calcolare la chiave pubblica modificata:
$$ A = A_0 + A_1 + A_2 $$
Grazie a questo metodo, a Bob basta calcolare la somma delle chiavi pubbliche della transazione, poi calcolare il segreto ECDH da $A$ soltanto, il che riduce notevolmente il numero di calcoli da fare per la fase di scansione. Tuttavia, ricorda dalla sezione precedente. Avevamo incluso nel nostro calcolo l'hash $\text{inputHash}$ che viene usato come nonce per prevenire il riutilizzo degli indirizzi:
$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$
Ma se ci sono più input in una transazione, è necessario determinare quale $\text{outpoint}$ viene scelto in questo calcolo. Secondo il BIP352, il criterio di selezione per $\text{outpoint}$ da usare è scegliere il più piccolo lessicograficamente, il che significa selezionare l'UTXO che appare per primo in ordine alfabetico. Questo metodo standardizza l'UTXO da scegliere in ogni transazione. Ad esempio, se questo $\text{outpoint}$ più piccolo lessicograficamente è $\text{outpoint}_L$, il calcolo di $\text{inputHash}$ sarà:
$$ \text{inputHash} = \text{hash}(\text{outpoint}\_L \text{ ‖ } A) $$
I calcoli rimangono quindi identici a quelli presentati nella sezione precedente, eccetto che la chiave privata $a$ e la sua corrispondente chiave pubblica $A$ non rappresentano più una coppia che protegge un singolo input, ma ora rappresentano la modifica di tutte le coppie di chiavi negli input.
### Separare le Chiavi di Spesa e di Scansione
Finora, abbiamo discusso dell'indirizzo statico di Pagamento Silenzioso $B$ come di una chiave pubblica unica. Ricorda, è questa chiave pubblica $B$ che viene usata da Alice per creare il segreto condiviso ECDH, che a sua volta viene usato per calcolare l'indirizzo di pagamento unico $P$. Bob usa questa chiave pubblica $B$ e la corrispondente chiave privata $b$ per la fase di scansione. Ma userà anche la chiave privata $b$ per calcolare la chiave privata $p$ che consente di spendere dall'indirizzo $P$.
Lo svantaggio di questo metodo è che la chiave privata $b$, che viene usata per calcolare tutte le chiavi private per gli indirizzi che ricevono Pagamenti Silenziosi, viene anche usata da Bob per scansionare le transazioni. Questo passaggio richiede che la chiave $b$ sia disponibile su un software di portafoglio connesso a Internet, il che la espone a un rischio maggiore di furto rispetto al mantenerla su un portafoglio freddo. Idealmente, sarebbe vantaggioso poter approfittare dei Pagamenti Silenziosi mantenendo la chiave privata $b$, che controlla l'accesso a tutte le altre chiavi private, al sicuro su un portafoglio hardware. Fortunatamente, il protocollo è stato adattato per permettere esattamente questo.
Per raggiungere questo obiettivo, il BIP352 specifica che il ricevente usa 2 diverse coppie di chiavi:
- $B_{\text{spend}}$: per calcolare le chiavi private degli indirizzi di pagamento unici;
- $B_{\text{scan}}$: per trovare indirizzi di pagamento unici.
In questo modo, Bob può mantenere la chiave privata $b_{\text{spend}}$ su un portafoglio hardware e usare la chiave privata $b_{\text{scan}}$ su software online per trovare i suoi Pagamenti Silenziosi, senza rivelare $b_{\text{spend}}$. Tuttavia, le chiavi pubbliche $B_{\text{scan}}$ e $B_{\text{spend}}$ sono entrambe pubblicamente rivelate, poiché si trovano nell'indirizzo statico di Bob $B$:
Per calcolare un indirizzo di pagamento unico $P_0$ appartenente a Bob, Alice eseguirà il seguente calcolo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot a \cdot B\_{\text{scan}} \text{ ‖ } 0) \cdot G $$
Per trovare i pagamenti indirizzati a lui, Bob eseguirà il seguente calcolo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$
Come puoi vedere, fino a questo momento, Bob non ha avuto bisogno di usare $b_{\text{spend}}$ che si trova sul suo portafoglio hardware. Quando desidera spendere $P_0$, può quindi eseguire il seguente calcolo per trovare la chiave privata $p_0$:
$$ p*0 = (b*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$
_Didascalia:_
- $B_{\text{scan}}$: Chiave pubblica di scansione di Bob (indirizzo statico)
- $b_{\text{scan}}$: Chiave privata di scansione di Bob
- $B_{\text{spend}}$: Chiave pubblica di spesa di Bob (indirizzo statico)
- $b_{\text{spend}}$: Chiave privata di spesa di Bob
- $A$: La somma delle chiavi pubbliche in input (tweak)
- $a$: La chiave privata corrispondente alla chiave pubblica modificata
- $H$: L'hash dell'UTXO più piccolo (lessicograficamente) usato in input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo di pagamento unico per Bob
### Utilizzando indirizzi SP con un'etichetta
Bob ha quindi un indirizzo statico $B$ per i Pagamenti Silenziosi come segue:
$$ B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}} $$
Il problema con questo metodo è che non permette di segregare i diversi pagamenti inviati a questo indirizzo. Ad esempio, se Bob ha 2 clienti diversi per la sua attività e vuole differenziare chiaramente i pagamenti da ciascuno, avrebbe bisogno di 2 indirizzi statici diversi. Una soluzione ingenua, con l'approccio attuale, sarebbe che Bob crei due portafogli separati, ognuno con il proprio indirizzo statico, o addirittura stabilisca due indirizzi statici diversi all'interno dello stesso portafoglio. Tuttavia, questa soluzione richiede la scansione dell'intera blockchain due volte (una per ciascun indirizzo) per rilevare rispettivamente i pagamenti destinati a ciascun indirizzo. Questa doppia scansione aumenta in modo irragionevole l'onere operativo per Bob.
Per risolvere questo problema, BIP352 utilizza un sistema di etichettatura che consente di avere diversi indirizzi statici senza aumentare in modo irragionevole il carico di lavoro per trovare Pagamenti Silenziosi sulla blockchain. Per fare ciò, viene aggiunto un intero $m$ alla chiave pubblica di spesa $B_{\text{spend}}$. Questo intero può assumere il valore di $1$ per il primo indirizzo statico, poi $2$ per il secondo, e così via. Le chiavi di spesa $B_{\text{spend}}$ saranno d'ora in poi chiamate $B_m$ e saranno costruite in questo modo:
$$ B*m = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } m) \cdot G $$
Per esempio, per la prima chiave di spesa con l'etichetta $1$:
$$ B*1 = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } 1) \cdot G $$
L'indirizzo statico pubblicato da Bob consisterà ora di $B_{\text{scan}}$ e $B_m$. Per esempio, il primo indirizzo statico con l'etichetta $1$ sarà:
$$ B = B\_{\text{scan}} \text{ ‖ } B_1 $$
> _Iniziamo solo dall'etichetta 1 perché l'etichetta 0 è riservata per il resto._
Alice, da parte sua, deriverà l'indirizzo di pagamento unico $P$ nello stesso modo di prima, ma utilizzando il nuovo $B_1$ invece di $B_{\text{spend}}$.
$$ P*0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B*{\text{scan}} \text{ ‖ } 0) \cdot G $$
In realtà, Alice potrebbe non sapere nemmeno che Bob ha un indirizzo etichettato, poiché lei semplicemente utilizza la seconda parte dell'indirizzo statico che lui le ha fornito, che in questo caso, è il valore $B_1$ piuttosto che $B_{\text{spend}}$.
Per scansionare i pagamenti, Bob utilizzerà sempre il valore del suo indirizzo statico iniziale con $B_{\text{spend}}$ in questo modo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$
Poi, semplicemente sottrae il valore che trova per $P_0$ da ogni output uno per uno. Poi controlla se uno dei risultati di queste sottrazioni corrisponde al valore di una delle etichette che usa nel suo portafoglio. Se corrisponde, per esempio, per l'output #4 con l'etichetta $1$, ciò significa che questo output è un Pagamento Silenzioso associato al suo indirizzo statico etichettato $B_1$:
$$ Out*4 - P_0 = \text{hash}(b*{\text{scan}} \text{ ‖ } 1) \cdot G $$
Questo funziona perché:
$$ B*1 = B*{\text{spend}} + \text{hash}(b*{\text{scan}} \text{ ‖ } 1) \cdot G $$
Grazie a questo metodo, Bob può utilizzare una moltitudine di indirizzi statici ($B_1$, $B_2$, $B_3$...), tutti derivati dal suo indirizzo statico base ($B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}}$), al fine di separare correttamente gli usi.
Tuttavia, questa separazione degli indirizzi statici è valida solo da una prospettiva di gestione personale del portafoglio e non consente la separazione delle identità. Poiché tutti hanno lo stesso $B*{\text{scan}}$, è molto facile associare tutti gli indirizzi statici insieme e dedurre che appartengono a una singola entità.
_Didascalia:_
- $B_{\text{scan}}$: chiave pubblica di scansione di Bob (indirizzo statico)
- $b_{\text{scan}}$: chiave privata di scansione di Bob
- $B_{\text{spend}}$: chiave pubblica di spesa di Bob (indirizzo iniziale)
- $B_m$: chiave pubblica di spesa etichettata di Bob (indirizzo statico)
- $b_m$: chiave privata di spesa etichettata di Bob
- $A$: La somma delle chiavi pubbliche in input (tweak)
- $a$: La chiave privata corrispondente alla chiave pubblica modificata
- $H$: L'hash del più piccolo UTXO (lessicograficamente) utilizzato come input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
- $p_0$: La chiave privata del primo indirizzo di pagamento unico a Bob
- $X$: L'hash della chiave privata di scansione con l'etichetta
### Come Costruire un Indirizzo per Pagamenti Silenziosi?
Per costruire un indirizzo dedicato ai Pagamenti Silenziosi, è necessario prima derivare 2 coppie di chiavi nel proprio portafoglio Bitcoin HD:
- La coppia $b_{\text{scan}}$, $B_{\text{scan}}$ per cercare i pagamenti indirizzati a noi;
- La coppia $b_{\text{spend}}$, $B_{\text{spend}}$ per spendere i bitcoin che abbiamo ricevuto.
Queste coppie sono derivate seguendo questi percorsi (_Bitcoin Mainnet_):
scan: m / 352' / 0' / 0' / 1' / 0
spend: m / 352' / 0' / 0' / 0' / 0
```

```text
Una volta disponibili queste 2 coppie di chiavi, si concatenano semplicemente (una di seguito all'altra) per creare il payload dell'indirizzo statico:
$$ B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}} $$
Se si desidera utilizzare etichette, $B_{\text{spend}}$ viene sostituito con $B_m$:
$$ B = B\_{\text{scan}} \text{ ‖ } B_m $$
Con l'etichetta $m$:
$$ B*m = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } m) \cdot G $$
Una volta disponibile questo payload, si aggiunge la HRP (_Human-Readable Part_) `sp` e la versione `q` (= versione 0). Viene anche aggiunto un checksum, e l'indirizzo è formattato in bech32m.
Ad esempio, ecco il mio indirizzo statico per i Pagamenti Silenziosi:
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```