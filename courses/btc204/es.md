---
name: Privacidad en Bitcoin
goal: Comprender y dominar los principios de protección de la privacidad al utilizar Bitcoin
objectives: 

  - Definir los conceptos teóricos necesarios para comprender lo que está en juego en la protección de la intimidad
  - Saber cómo identificar y mitigar los riesgos asociados a la pérdida de privacidad de los usuarios en Bitcoin
  - Uso de métodos y herramientas para proteger su privacidad en Bitcoin
  - Comprender los métodos de análisis de la cadena y desarrollar estrategias de defensa

---
# Proteja su privacidad en bitcoin

En un mundo en el que la privacidad de las transacciones financieras se está convirtiendo poco a poco en un lujo, comprender y dominar los principios de protección de la privacidad en su uso de Bitcoin es esencial. Esta formación le proporciona todas las claves, tanto teóricas como prácticas, para lograr este objetivo por sí mismo.

Hoy en día, en Bitcoin, existen empresas especializadas en el análisis de cadenas. Su actividad principal es precisamente inmiscuirse en su vida privada para comprometer la confidencialidad de sus transacciones. De hecho, el "derecho a la privacidad" en Bitcoin no existe. Por lo tanto, le corresponde a usted, el usuario, hacer valer sus derechos naturales y proteger la confidencialidad de sus transacciones, porque nadie lo hará por usted.

Esta formación se presenta como un curso completo y generalista. Cada noción técnica está detallada y apoyada por diagramas explicativos. El objetivo es poner los conocimientos al alcance de todos. BTC204 es por tanto accesible para usuarios principiantes e intermedios. Esta formación también ofrece un valor añadido a los bitcoiners más experimentados, ya que profundizamos en algunos conceptos técnicos a menudo desconocidos.

Únase a nosotros para transformar su uso de Bitcoin y convertirse en un usuario informado, capaz de comprender las cuestiones relacionadas con la confidencialidad y proteger su privacidad.

+++
# Introducción

<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## Introducción a la formación

<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

En un mundo en el que la privacidad de las transacciones financieras se está convirtiendo poco a poco en un lujo, comprender y dominar los principios de protección de la privacidad en su uso de Bitcoin es esencial. Esta formación le proporciona todas las claves, tanto teóricas como prácticas, para lograr este objetivo por sí mismo.

Hoy en día, en el ecosistema Bitcoin, existen empresas especializadas en el análisis de blockchain. Su negocio principal es precisamente inmiscuirse en tu privacidad, comprometiendo la confidencialidad de tus transacciones. De hecho, el "derecho a la privacidad" en Bitcoin no existe. Por lo tanto, le corresponde a usted, el usuario, hacer valer sus derechos naturales y proteger la confidencialidad de sus transacciones, porque nadie lo hará por usted.

Bitcoin no sólo sirve para "subir los números" y preservar el valor de los ahorros. Por sus características únicas y su historia, es ante todo la herramienta de la economía alternativa. Gracias a este notable invento, puedes gestionar libremente tu dinero, gastarlo y acumularlo, sin que nadie pueda impedírtelo.

Bitcoin le ofrece una escapatoria pacífica del yugo de los estados, permitiéndole disfrutar plenamente de sus derechos naturales, que no pueden ser cuestionados por las leyes establecidas. Gracias al invento de Satoshi Nakamoto, usted tiene el poder de hacer valer su derecho a la propiedad privada y recuperar su libertad para contratar.

Sin embargo, Bitcoin no es anónimo por defecto, lo que puede suponer un riesgo para las personas que se dedican a la economía alternativa, especialmente en regiones bajo regímenes despóticos. Pero éste no es el único peligro. Dado que el bitcoin es un activo valioso y sin censura, podría atraer la atención de los ladrones. Por tanto, proteger su privacidad también se convierte en una cuestión de seguridad: puede ayudarle a prevenir ciberataques y agresiones físicas.

Como veremos, aunque el protocolo ofrece ciertas protecciones de privacidad inherentes, es crucial utilizar herramientas adicionales para optimizar y defender esta privacidad. Este curso está diseñado como un camino completo y generalista para entender los problemas de privacidad en Bitcoin. Cada noción técnica es discutida en detalle y apoyada por diagramas explicativos. El objetivo es hacer el conocimiento accesible a todos, incluyendo usuarios principiantes e intermedios. Para los bitcoiners más experimentados, también cubrimos conceptos muy técnicos y a veces menos conocidos durante este curso para profundizar en la comprensión de cada tema.

El objetivo de este curso no es hacerle completamente anónimo en su uso de Bitcoin, sino proporcionarle las herramientas esenciales para saber cómo proteger su privacidad de acuerdo con sus objetivos personales. Tendrá la libertad de elegir entre los conceptos y herramientas presentados para desarrollar sus propias estrategias, adaptadas a sus objetivos y necesidades específicas.

### Sección 1: Definiciones y conceptos clave

Para empezar, examinaremos juntos los fundamentos que rigen el funcionamiento de Bitcoin, para después abordar con calma las nociones relacionadas con la privacidad. Es esencial dominar algunos conceptos básicos, como UTXOs, direcciones receptoras o scripts, antes de poder comprender plenamente los conceptos que abordaremos en las siguientes secciones. También presentaremos el modelo general de privacidad de Bitcoin, tal y como lo concibió Satoshi Nakamoto, que nos permitirá comprender los problemas y riesgos asociados.

![BTC204](assets/it/11/1.webp)

### Sección 2: Comprender el análisis de la cadena y cómo protegerse

En la segunda sección, estudiamos las técnicas utilizadas por las empresas de análisis de blockchain para rastrear su actividad en Bitcoin. Comprender estos métodos es fundamental para mejorar la protección de su privacidad. Esta parte pretende examinar las estrategias de los atacantes para comprender mejor los riesgos y sentar las bases de las técnicas que estudiaremos en secciones posteriores. Analizaremos patrones de transacciones, heurísticas internas y externas, así como interpretaciones plausibles de estos patrones. Además de un componente teórico, aprenderemos a utilizar un explorador de bloques para realizar análisis de cadenas mediante ejemplos prácticos y ejercicios.

![BTC204](assets/fr/002.webp)

### Sección 3: Dominio de las mejores prácticas para proteger su intimidad

En la tercera sección de nuestro curso, llegamos al meollo de la cuestión: ¡la práctica! El objetivo es dominar todas las mejores prácticas esenciales que deberían convertirse en reflejos naturales para cualquier usuario de Bitcoin. Cubriremos el uso de direcciones frescas, etiquetado, consolidación, el uso de nodos completos, así como KYC y métodos de adquisición. El objetivo es proporcionarle una visión global de las trampas a evitar para establecer una base sólida en nuestra búsqueda de la protección de la privacidad. Para algunas de estas prácticas, se le guiará a un tutorial específico para ponerlas en práctica.

![BTC204](assets/it/11/3.webp)

### Sección 4: Entender las transacciones Coinjoin

¿Cómo podemos hablar de la privacidad de bitcoin sin hablar de coinjoin? En la sección 4, descubrirás todo lo que necesitas saber sobre este método de mezcla. Aprenderás qué es un coinjoin, su historia y objetivos, así como los diferentes tipos de coinjoins que existen. Por último, para los usuarios más experimentados, averiguaremos qué son los anonsets y la entropía, y cómo calcular estos indicadores.

![BTC204](assets/it/11/4.webp)

### Sección 5: Entender los problemas de otras técnicas avanzadas de privacidad

En la quinta sección, proporcionaremos una visión general de todas las otras técnicas existentes para proteger su privacidad en Bitcoin además de coinjoin. A lo largo de los años, los desarrolladores han mostrado una creatividad considerable a la hora de diseñar herramientas dedicadas a la privacidad. Examinaremos todos estos métodos, como payjoin, transacciones colaborativas, Coin Swap y Atomic Swap, detallando cómo funcionan, sus objetivos y debilidades potenciales.

También trataremos la privacidad a nivel de red de nodos y la difusión de transacciones. También discutiremos los diversos protocolos que se han propuesto a lo largo de los años para mejorar la privacidad del usuario en Bitcoin, incluyendo los protocolos de direcciones estáticas.

![BTC204](assets/fr/005.webp)

# Definiciones y conceptos clave

<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>

## El modelo UTXO de Bitcoin

<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>

Bitcoin es principalmente una moneda, pero ¿sabe concretamente cómo se representa BTC en el protocolo?

### UTXOs de Bitcoin: ¿Qué son?

En el protocolo Bitcoin, la gestión de las unidades monetarias se basa en el modelo UTXO, que significa "_Unspent Transaction Output_"

Este modelo es profundamente diferente de los sistemas bancarios tradicionales, que se basan en un mecanismo de cuentas y saldos para seguir los flujos financieros. De hecho, en el sistema bancario, los saldos individuales se mantienen en cuentas vinculadas a una identidad. Por ejemplo, cuando usted compra una baguette a un panadero, su banco simplemente carga el importe de la compra en su cuenta, reduciendo así su saldo, mientras que la cuenta del panadero se abona con la misma cantidad, aumentando su saldo. En este sistema, no existe ningún vínculo entre el dinero que entra en tu cuenta y el que sale de ella, aparte de los registros de las transacciones.

En Bitcoin, las cosas funcionan de otra manera. El concepto de cuenta no existe, y las unidades monetarias no se gestionan a través de saldos, sino de UTXOs. Un UTXO representa una cantidad específica de bitcoin que aún no se ha gastado, formando así una `pieza de bitcoin`, que puede ser grande o pequeña. Por ejemplo, un UTXO puede valer `500 BTC` o sólo `700 SATS`.

**> Recordatorio:** El satoshi, a menudo abreviado como sat, es la unidad más pequeña de Bitcoin, comparable a un céntimo en las monedas fiduciarias.

```plaintext
1 BTC = 100,000,000 SATS
```

Teóricamente, un UTXO puede representar cualquier valor en bitcoin, desde un sat hasta el máximo teórico de unos 21 millones de BTC. Sin embargo, es lógicamente imposible poseer los 21 millones de bitcoins, y existe un umbral económico inferior denominado "polvo", por debajo del cual un UTXO se considera económicamente antieconómico para gastar.

**>¿Sabías que?** El mayor UTXO jamás creado en Bitcoin tenía un valor de `500.000 BTC`. Fue creado por la plataforma MtGox durante una operación de consolidación en noviembre de 2011: [29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXO y condiciones de gasto

Los UTXOs son las herramientas de intercambio en Bitcoin. Cada transacción implica el consumo de UTXOs como entradas y la creación de nuevos UTXOs como salidas. Cuando se realiza una transacción, los UTXOs utilizados como entradas se consideran "gastados", y se generan nuevos UTXOs que se asignan a los destinatarios indicados en las salidas de la transacción. Así, un UTXO representa simplemente una salida de transacción no gastada y, por tanto, una cantidad de bitcoin perteneciente a un usuario en un momento dado.

![BTC204](assets/it/21/2.webp)

Todos los UTXOs están protegidos por scripts que definen las condiciones en las que se pueden gastar. Para consumir un UTXO, un usuario debe demostrar a la red que cumple las condiciones establecidas por el script que protege ese UTXO. Generalmente, los UTXO están protegidos por una clave pública (o una dirección receptora que representa esta clave pública). Para gastar un UTXO asociado a esta clave pública, el usuario debe demostrar que posee la clave privada correspondiente aportando una firma digital realizada con esta clave. Por eso se dice que tu monedero bitcoin no contiene bitcoins, sino que contiene tus claves privadas, que a su vez te dan acceso a tus UTXOs y, por extensión, a los bitcoins que representan.

![BTC204](assets/it/21/3.webp)

Dado que el concepto de cuenta está ausente en Bitcoin, el saldo de un monedero es simplemente la suma de los valores de todos los UTXOs que puede gastar. Por ejemplo, si su monedero Bitcoin puede gastar los siguientes 4 UTXOs:

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

El saldo total de tu monedero sería de `17 BTC`.

![BTC204](assets/it/21/4.webp)

## La estructura de las transacciones Bitcoin

<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>

### Las entradas y salidas de una transacción

Una transacción bitcoin es una operación registrada en la blockchain que permite transferir la propiedad de bitcoins de una persona a otra. Más concretamente, dado que estamos en un modelo UTXO y no hay cuentas, la transacción satisface las condiciones de gasto que protegían uno o varios UTXO, los consume y, de forma equivalente, crea nuevos UTXO dotados de nuevas condiciones de gasto. En resumen, una transacción traslada bitcoins de una escritura satisfecha a una nueva escritura destinada a protegerlos.

![BTC204](assets/it/22/1.webp)

Cada transacción Bitcoin está compuesta por una o más entradas y una o más salidas. Las entradas son UTXOs consumidos por la transacción para generar las salidas. Las salidas son nuevos UTXOs que podrán utilizarse como entradas para futuras transacciones.

![BTC204](assets/it/22/2.webp)

**> En teoría, una transacción bitcoin puede tener un número infinito de entradas y salidas. Sólo el tamaño máximo del bloque limita este número. Cada entrada en una transacción bitcoin se refiere a un UTXO (Unspent Transaction Output) previo no gastado. Para utilizar un UTXO como entrada, su titular debe demostrar que es el propietario legítimo validando la escritura asociada a él, es decir, satisfaciendo la condición de gasto impuesta. Generalmente, esto implica proporcionar una firma digital producida con la clave privada correspondiente a la clave pública que aseguró inicialmente ese UTXO. A continuación, el script verifica que la firma coincide con la clave pública utilizada al recibir los fondos.

Cada salida, por su parte, especifica la cantidad de bitcoin que se va a transferir, así como el destinatario. Este último se define mediante un nuevo script que generalmente bloquea el UTXO recién creado con una dirección receptora o una nueva clave pública.

Para que una transacción se considere válida según las reglas de consenso, el total de salidas debe ser menor o igual que el total de entradas. En otras palabras, la suma de nuevos UTXOs generados por la transacción no debe superar la suma de UTXOs consumidos como entradas. Este principio es lógico: si sólo tienes una cantidad de `500.000 SATS`, no puedes hacer una compra de `700.000 SATS`.

### Intercambio y consolidación en una transacción Bitcoin

La acción de una transacción Bitcoin sobre UTXOs puede compararse así a la fusión de una moneda de oro. De hecho, un UTXO no es divisible, sino sólo unificable. Esto significa que un usuario no puede simplemente dividir un UTXO que representa una cierta cantidad de bitcoin en varios UTXOs más pequeños. Debe consumirlo íntegramente en una transacción para crear uno o varios UTXO nuevos de valores arbitrarios en las salidas, que deben ser inferiores o iguales al valor inicial.

Este mecanismo es similar al de una moneda de oro. Imagine que posee una moneda de 2 onzas y quiere hacer un pago de 1 onza, suponiendo que el vendedor no pueda darle cambio. Tendría que fundir su moneda y acuñar 2 nuevas monedas de 1 onza cada una.

En bitcoin, el funcionamiento es similar. Supongamos que Alice tiene un UTXO de `10.000 SATS` y quiere comprar una baguette que cuesta `4.000 SATS`. Alice realizará una transacción con una entrada de 1 UTXO de `10.000 SATS` que consumirá en su totalidad, y en las salidas, creará 2 UTXOs valorados en `4.000 SATS` y `6.000 SATS`. El UTXO de `4.000 SATS` se enviará al panadero como pago por la baguette, mientras que el UTXO de `6.000 SATS` volverá a Alice como cambio. Este UTXO que vuelve al emisor inicial de la transacción es lo que se denomina "cambio" en la jerga de Bitcoin.

Ahora imaginemos que Alicia no dispone de un único UTXO de `10.000 SATS`, sino de dos UTXOs de `3.000 SATS` cada uno. En esta situación, ninguno de los UTXOs individuales es suficiente para cubrir los `4.000 SATS` de la baguette. Por lo tanto, Alice debe utilizar ambos UTXOs de `3.000 SATS` como entradas para su transacción simultáneamente. De este modo, el total de entradas alcanzará los 6.000 ¤, lo que le permitirá cubrir el pago de 4.000 ¤ al panadero. Este método, que consiste en agrupar varios UTXO en los insumos de una transacción, suele denominarse "consolidación".

### Tasas de transacción

Intuitivamente, se podría pensar que las comisiones de transacción también representan un resultado de una transacción. Pero en realidad no es así. Las comisiones de transacción representan la diferencia entre el total de entradas y el total de salidas. Esto significa que después de utilizar parte del valor de las entradas para cubrir las salidas deseadas en una transacción, una cierta suma de las entradas queda sin utilizar. Esta suma restante constituye las comisiones de transacción.

```plaintext
Commissioni = input totali - output totali
```

Volvamos al ejemplo de Alicia, que tiene un UTXO de 10.000 SATS y quiere comprar una baguette por 4.000 SATS. Alice crea una transacción con su UTXO de "10.000 SATS" como entrada. A continuación, genera una salida de 4.000 SATS para que el panadero pague la baguette. Para animar a los mineros a incluir su transacción en un bloque, Alice asigna 200 SATS como comisión. Al hacerlo, crea un segundo resultado, el resto, que le será devuelto y que asciende a 5.800 SATS.

Aplicando la fórmula de la comisión, vemos que quedan `200 SATS` para los mineros:

```plaintext
Commissioni = input totali - output totali
Spese = 10.000 - (4.000 + 5.800)
Spese = 10.000 - 9.800
Spese = 200
```

Cuando un minero valida con éxito un bloque, tiene derecho a cobrar estas tasas por todas las transacciones incluidas en su bloque, a través de lo que se conoce como transacción "coinbase".

### La creación de UTXO en Bitcoin

Si ha seguido atentamente los párrafos anteriores, ahora sabe que los UTXOs sólo pueden crearse consumiendo otros UTXOs existentes. Así, las monedas en Bitcoin forman una cadena continua. Sin embargo, puede que se pregunte cómo aparecieron los primeros UTXOs en esta cadena. Esto plantea un problema similar al del huevo y la gallina: ¿de dónde salieron estos UTXOs originales?

La respuesta está en la **transacción Coinbase**.

Coinbase es un tipo específico de transacción Bitcoin, única en cada bloque y siempre la primera en ellos. Permite al minero que ha encontrado una prueba de trabajo válida recibir su recompensa de bloque. Esta recompensa se compone de dos elementos: **la recompensa de bloque** y **las comisiones de transacción** comentadas en la parte anterior.

La característica única de la transacción coinbase es que es la única que puede crear bitcoins de la nada, sin necesidad de consumir inputs para generar sus outputs. Estos bitcoins recién creados constituyen lo que podría llamarse los "UTXOs originales"

Los bitcoins de la subvención en bloque son nuevos BTC creados de la nada, siguiendo un calendario de emisión predefinido en las reglas de consenso. La subvención por bloque se reduce a la mitad cada 210.000 bloques, aproximadamente cada cuatro años, en un proceso llamado "reducción a la mitad" Al principio se creaban 50 bitcoins por subvención, pero esta cantidad ha ido disminuyendo gradualmente; actualmente es de 3.125 bitcoins por bloque.

En cuanto a la parte de las tasas de transacción, aunque representa BTC de nueva creación, no deben superar la diferencia entre el total de entradas y salidas de todas las transacciones de un bloque. Hemos visto antes que estas comisiones representan la parte de las entradas que no se utiliza en las salidas de las transacciones. Esta parte se "pierde" técnicamente durante la transacción, y el minero tiene derecho a recrear este valor en forma de uno o más nuevos UTXOs. Se trata, por tanto, de una transferencia de valor del remitente de la transacción al minero que la añade a la blockchain.

**> ¿Sabías que?** Los bitcoins generados a partir de una transacción en coinbase están sujetos a un periodo de maduración de 100 bloques durante el cual no pueden ser gastados por el minero. Esta norma pretende evitar complicaciones asociadas al uso de bitcoins recién creados en una cadena que puede quedar obsoleta más adelante.

### Implicaciones del modelo UTXO

En primer lugar, el modelo UTXO afecta directamente a las tasas de transacción en Bitcoin. Dado que la capacidad de cada bloque es limitada, los mineros favorecen las transacciones que ofrecen las mejores tarifas en relación con el espacio que ocuparán en el bloque. De hecho, cuanto más UTXO incluya una transacción como entrada y salida, más pesada será y, por tanto, requerirá tarifas más altas. Esta es una de las razones por las que a menudo se intenta reducir el número de UTXO en nuestra cartera, lo que también puede afectar a la privacidad, un tema que exploraremos en detalle en la tercera parte de esta formación.

A continuación, como se ha mencionado en las partes anteriores, las monedas en Bitcoin son esencialmente una cadena de UTXOs. Así, cada transacción crea un vínculo entre un UTXO pasado y un UTXO futuro. Los UTXOs permiten así un seguimiento explícito de la trayectoria de los bitcoins desde su creación hasta su gasto actual. Esta transparencia puede considerarse positiva, ya que permite a cada usuario asegurarse de la autenticidad de los bitcoins recibidos. Sin embargo, es también en este principio de trazabilidad y auditabilidad en el que se basa el análisis de la cadena, una práctica destinada a comprometer su privacidad. Estudiaremos esta práctica en profundidad en la segunda parte de la formación.

## El modelo de privacidad de Bitcoin

<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>

### Moneda: Autenticidad, integridad y doble gasto

Una de las funciones de la moneda es resolver el problema de la doble coincidencia de necesidades. En un sistema basado en el trueque, realizar un intercambio requiere no sólo encontrar a un individuo que ofrezca un bien que satisfaga mi necesidad, sino también proporcionarle un bien de valor equivalente que satisfaga la suya. Encontrar este equilibrio resulta complejo.

Por eso se utiliza la moneda, que permite la transferencia de valor tanto en el espacio como en el tiempo.

Para que la moneda resuelva este problema, es esencial que la parte que proporciona un bien o servicio esté convencida de su capacidad para gastar esa cantidad más adelante. Por tanto, cualquier individuo racional que desee aceptar una forma de moneda, ya sea digital o física, se asegurará de que cumple dos criterios básicos:


- La moneda debe estar intacta y ser auténtica;**- **y no debe gastarse dos veces.**

Cuando se utiliza moneda física, la primera característica es la más compleja de afirmar. A lo largo de diferentes periodos históricos, la integridad de las monedas metálicas se ha visto a menudo comprometida por prácticas como el corte o el troquelado. Por ejemplo, durante la antigua Roma, era habitual que los ciudadanos rasparan los bordes de las monedas de oro para recoger parte del metal precioso y conservarlas para futuras transacciones. De este modo se reducía el valor intrínseco de la moneda, pero su valor nominal seguía siendo el mismo. Esta es, sin duda, la razón por la que posteriormente se acuñaron rayas en el canto de las monedas.

La autenticidad es también una característica difícil de verificar por medios monetarios físicos. Hoy en día, las técnicas de lucha contra la falsificación son cada vez más complejas, lo que obliga a los comerciantes a invertir en costosos sistemas de verificación.

Por otra parte, debido a su naturaleza, el doble pago no es un problema para las monedas físicas. Si te doy un billete de 10 euros, sale irrevocablemente de mi posesión para entrar en la tuya, excluyendo por supuesto cualquier posibilidad de gastar las mismas unidades monetarias varias veces. En pocas palabras, no podré volver a gastar ese billete de 10 euros.

En el caso de la moneda digital, la dificultad es diferente. Garantizar la autenticidad y la integridad de una moneda suele ser más fácil. Como vimos en la sección anterior, el modelo UTXO de Bitcoin permite rastrear una moneda hasta su origen, verificando así que efectivamente fue creada de acuerdo con las reglas de consenso por un minero.

Sin embargo, garantizar la ausencia de doble pago es más complejo, ya que cualquier bien digital es esencialmente información. A diferencia de los bienes físicos, la información no se divide durante los intercambios, sino que se propaga multiplicándose. Por ejemplo, si le envío un documento por correo electrónico, se duplica. Por su parte, usted no puede verificar con certeza que yo haya borrado el documento original.

### Evitar el doble pago en Bitcoin

La única forma de evitar la duplicación de un activo digital es estar al tanto de todos los intercambios dentro del sistema. De ese modo, se puede saber quién posee qué y actualizar la propiedad de cada uno en función de las transacciones realizadas. Esto es lo que se hace, por ejemplo, con el dinero escritural en el sistema bancario. Cuando pagas 10 euros a un comerciante con una tarjeta de crédito, el banco registra este intercambio y actualiza el libro mayor.

En Bitcoin, la prevención del doble pago se realiza de la misma manera. El objetivo es confirmar la ausencia de una transacción que ya haya gastado las monedas en cuestión. Si estas monedas nunca se han utilizado, entonces podemos estar seguros de que no se producirá un doble pago. Este principio fue descrito por Satoshi Nakamoto en el Libro Blanco con esta famosa frase:

**"_La única manera de confirmar la ausencia de una transacción es estar al tanto de todas las transacciones._"**

Sin embargo, a diferencia del modelo bancario, en Bitcoin no se desea tener que confiar en una entidad central. Es necesario que todos los usuarios puedan confirmar esta ausencia de doble pago, sin depender de un tercero. Por lo tanto, todo el mundo necesita estar al tanto de todas las transacciones de Bitcoin. Esta es la razón por la que las transacciones de Bitcoin se difunden públicamente en todos los nodos de la red y se registran en texto plano en la blockchain.

Es precisamente esta difusión pública de la información lo que complica la protección de la privacidad en Bitcoin. En el sistema bancario tradicional, en teoría, sólo la entidad financiera tiene conocimiento de las transacciones realizadas. En cambio, en Bitcoin, todos los usuarios están informados de todas las transacciones, a través de sus respectivos nodos.

### El modelo de privacidad: sistema bancario frente a Bitcoin

En el sistema tradicional, su cuenta bancaria está vinculada a su identidad. El banquero puede saber qué cliente pertenece a qué cuenta bancaria y qué transacciones están asociadas a ella. Sin embargo, este flujo de información se interrumpe entre el banco y el dominio público. En otras palabras, es imposible conocer el saldo y las transacciones de una cuenta bancaria que pertenece a otra persona. Sólo el banco tiene acceso a esta información.

Por ejemplo, su banquero sabe que usted compra cada mañana su baguette en la panadería del barrio, pero su vecino ignora esta transacción. Así, el flujo de información es accesible para las partes interesadas, en particular el banco, pero permanece inaccesible para los extraños.

Debido a la limitación de la difusión pública de las transacciones que vimos en la parte anterior, el modelo de privacidad de Bitcoin no puede seguir el modelo del sistema bancario. En el caso de Bitcoin, debido a que el flujo de información no puede interrumpirse entre las transacciones y el dominio público, **el modelo de privacidad se basa en la separación entre la identidad del usuario y las propias transacciones**.

Por ejemplo, si compras una baguette al panadero pagando en BTC, tu vecino, que posee su propio nodo completo, puede ver cómo se realiza tu transacción, igual que puede ver todas las demás transacciones del sistema. Sin embargo, si se respetan los principios de privacidad, no debería poder vincular esta transacción concreta a tu identidad.

Pero como las transacciones de Bitcoin se hacen públicas, sigue siendo posible establecer vínculos entre ellas para deducir información sobre las partes implicadas. Esta actividad constituye incluso una especialidad en sí misma llamada "análisis de cadenas" En la siguiente parte del curso, le invito a explorar los fundamentos del análisis de cadenas para comprender cómo se rastrean sus bitcoins y saber cómo defenderse mejor.

# Comprender el análisis de la cadena y cómo protegerse

<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## ¿Qué es el análisis en cadena de Bitcoin?

<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>

### Definición y funcionamiento

El análisis de cadenas es una práctica que engloba todos los métodos utilizados para rastrear el flujo de bitcoin en la blockchain. En general, el análisis de cadenas se basa en la observación de características en muestras de transacciones anteriores. A continuación, consiste en identificar estas mismas características en una transacción que se desea analizar e inferir interpretaciones plausibles. Este método de resolución de problemas desde un enfoque práctico para encontrar una solución suficientemente buena es lo que se denomina "heurística"

Para simplificar, el análisis de la cadena se realiza en tres pasos principales:

1. **Observar la cadena de bloques;**

2. **Identificar las características conocidas;**

3. **Supuestos educativos.**

El análisis de la blockchain puede realizarlo cualquiera. Basta con tener acceso a la información pública de la blockchain a través de un nodo completo para observar los movimientos de las transacciones y hacer suposiciones. También existen herramientas gratuitas que facilitan este análisis, como el sitio web [OXT.me](https://oxt.me/), que exploraremos en detalle en los dos últimos capítulos de esta parte. Sin embargo, el principal riesgo para la privacidad procede de las empresas especializadas en el análisis de cadenas. Estas empresas han llevado el análisis de cadenas a una escala industrial y venden sus servicios a instituciones financieras o gobiernos. Entre estas empresas, Chainalysis es probablemente la más conocida.

### Objetivos del análisis en cadena

Uno de los objetivos del análisis en cadena es agrupar diversas actividades en Bitcoin para determinar la unicidad del usuario que las ha realizado. A continuación, se podrá intentar vincular este conjunto de actividades a una identidad real.

Recuerde el capítulo anterior. Expliqué por qué el modelo de privacidad de Bitcoin se basaba originalmente en separar las identidades de los usuarios de sus transacciones. Por lo tanto, sería tentador pensar que el análisis on-chain es inútil, ya que incluso si se pueden agrupar las actividades onchain, no se pueden asociar con una identidad real.

Teóricamente, esta afirmación es correcta. En la primera parte de esta formación, vimos que los pares de claves criptográficas se utilizan para establecer condiciones en el UTXO. Por esencia, estos pares de claves no revelan ninguna información sobre la identidad de sus titulares. Así, aunque seamos capaces de agrupar actividades asociadas a diferentes pares de claves, esto no nos dice nada sobre la entidad que está detrás de estas actividades.

Sin embargo, la realidad práctica es mucho más compleja. Existe una multitud de comportamientos que corren el riesgo de vincular una identidad real a una actividad onchain. En análisis, esto se denomina punto de entrada, y hay muchos.

La más común, por supuesto, es KYC (_Know Your Customer_). Si retiras tus bitcoins de una plataforma regulada a una de tus direcciones de recepción personales, algunas personas pueden vincular tu identidad a esta dirección. En términos más generales, un punto de entrada puede ser cualquier forma de interacción entre tu vida real y una transacción bitcoin. Por ejemplo, si publicas una dirección de recepción en tus redes sociales, esto puede ser un punto de entrada para el análisis. Si haces un pago en bitcoin a tu panadero, éste puede asociar tu cara (que forma parte de tu identidad) con una dirección Bitcoin.

Estos puntos de entrada son casi inevitables en el uso de Bitcoin. Aunque puede intentar limitar su alcance, seguirán estando presentes. Por eso es crucial combinar métodos destinados a preservar su privacidad. Aunque mantener una separación entre su identidad real y sus transacciones es un enfoque atractivo, hoy en día sigue siendo insuficiente. En efecto, si todas tus actividades en la cadena pueden agruparse, es probable que el más mínimo punto de entrada comprometa la única capa de privacidad que habías establecido.

### Defensa contra el análisis en cadena

Por lo tanto, también es necesario poder abordar el análisis de blockchain en nuestro uso de Bitcoin. Procediendo de este modo, podemos minimizar la agregación de nuestras actividades y limitar el impacto de un punto de entrada en nuestra privacidad.

De hecho, para contrarrestar mejor el análisis de blockchain, ¿qué mejor que familiarizarse con los métodos utilizados en el análisis de blockchain? Si quiere saber cómo mejorar su privacidad en Bitcoin, necesita entender estos métodos. Esto le permitirá entender mejor técnicas como coinjoin o payjoin (técnicas que estudiaremos en las últimas partes de la formación), y reducir los errores que pueda cometer.

En este contexto, podemos hacer una analogía con la criptografía y el criptoanálisis. Un buen criptógrafo es ante todo un buen criptoanalista. Para idear un nuevo algoritmo criptográfico, necesita saber a qué ataques se enfrentará y también estudiar por qué se han pirateado algoritmos anteriores. El mismo principio se aplica a la privacidad en Bitcoin. Comprender los métodos de análisis de la blockchain es la clave para protegerse contra ella. Por eso propongo una sección entera sobre análisis de blockchain en esta formación.

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/fr/tutorials/privacy/on-chain/payjoin-848b6a23-deb2-4c5f-a27e-93e2f842140f
### Los métodos de análisis de blockchain

Es importante entender que el análisis de blockchain no es una ciencia exacta. Se basa en heurísticas derivadas de observaciones previas o interpretaciones lógicas. Estas reglas permiten obtener resultados bastante fiables, pero nunca con una precisión absoluta. En otras palabras, **el análisis de blockchain siempre implica una dimensión de probabilidad en las conclusiones emitidas**. Por ejemplo, se puede estimar con mayor o menor certeza que dos direcciones pertenecen a la misma entidad, pero la certeza total siempre estará fuera de nuestro alcance.

El principal objetivo del análisis de blockchain reside precisamente en la agregación de diversas heurísticas para minimizar el riesgo de error. Se trata, en cierto sentido, de una acumulación de pruebas que nos permite acercarnos a la realidad.

Estas famosas heurísticas pueden agruparse en varias categorías que detallaremos a continuación:


- Modelos de transacción (o modelos de transacción);**
- Heurística interna de la transacción;**
- Heurística externa a la transacción.**

### Satoshi Nakamoto y el análisis de blockchain

Cabe señalar que las dos primeras heurísticas para el análisis de cadenas fueron descubiertas por el propio Satoshi Nakamoto. Él las discute en la Parte 10 del Libro Blanco de Bitcoin. Estas son:


- la Heurística Común de Propiedades de Entrada (CIOH);
- y la reutilización de direcciones.

![BTC204](assets/fr/031.webp)

Fuente: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

En los capítulos siguientes exploraremos de qué se trata, pero ya es interesante observar que estas dos heurísticas siguen manteniendo su prominencia en el análisis de cadenas en la actualidad.

## Plantillas de transacciones

<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>

Un modelo de transacción es simplemente un patrón o estructura general de una transacción típica que puede encontrarse en la blockchain, cuya interpretación es presumiblemente conocida. Cuando estudiemos modelos, nos centraremos en una única transacción que analizaremos a alto nivel.

En otras palabras, sólo observaremos el número de UTXOs en las entradas y el número de UTXOs en las salidas, sin detenernos en los detalles más específicos o el entorno de la transacción. A partir del patrón observado, podremos interpretar la naturaleza de la transacción. A continuación, buscaremos características en su estructura e inferiremos una interpretación.

![BTC204](assets/it/32/01.webp)

En esta parte, descubriremos juntos los principales patrones de transacción que pueden encontrarse en el análisis de cadenas, y para cada patrón, le daré la interpretación probable de esta estructura, junto con un ejemplo concreto.

### Envío simple (o pago simple)

Empecemos por un modelo muy popular, ya que es el que aparece en la mayoría de los pagos con bitcoin. El modelo de pago simple se caracteriza por consumir uno o más UTXOs en las entradas y producir 2 UTXOs en las salidas. Por tanto, este modelo aparecerá así:

![BTC204](assets/it/32/02.webp)

Cuando identificamos esta estructura de transacción en la blockchain, ya podemos extraer una interpretación. Como su nombre indica, este patrón indica que estamos ante una transacción de envío o pago. El usuario ha consumido sus UTXOs en entrada para satisfacer en salida un UTXO de pago y un UTXO de cambio (dinero devuelto al mismo usuario).

Así, sabemos que el usuario observado probablemente ya no está en posesión de uno de los dos UTXO de salida (el de pago), pero sigue en posesión del otro UTXO (el de cambio).

Por el momento, nos resulta imposible especificar qué salida representa a qué UTXO, ya que no es el objetivo del estudio de los modelos. Lograremos este objetivo apoyándonos en la heurística que estudiaremos en las partes siguientes. En esta fase, nuestro objetivo se limita a identificar la naturaleza de la operación en cuestión, que en este caso es un simple envío.

Por ejemplo, he aquí una transacción Bitcoin que adopta el modelo de envío simple:

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/it/32/03.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

Después de este primer ejemplo, debería comprender mejor lo que significa estudiar un "modelo de transacción" Examinamos una transacción centrándonos únicamente en su estructura, sin tener en cuenta su entorno ni los detalles específicos de la transacción. En este primer paso sólo la examinamos globalmente.

Ahora que ya sabe lo que es un modelo, pasemos a los demás modelos existentes.

### Barriendo

Este segundo modelo se caracteriza por consumir un único UTXO como entrada y producir un único UTXO como salida.

![BTC204](assets/it/32/04.webp)

La interpretación de este modelo es que estamos ante una auto-transferencia. El usuario se ha transferido sus bitcoins a sí mismo, a otra dirección de su propiedad. Como no hay resto en la transacción, es muy poco probable que estemos ante un pago. De hecho, cuando se realiza un pago, es casi imposible que el pagador disponga de un UTXO que coincida exactamente con la cantidad solicitada por el vendedor, más los gastos de transacción. Por lo general, el pagador se ve obligado a producir una salida de remanente.

Por lo tanto, sabemos que el usuario observado probablemente sigue en posesión de este UTXO. En el contexto de un análisis en cadena, si sabemos que el UTXO utilizado como entrada en la transacción pertenece a Alice, podemos suponer que el UTXO de salida también le pertenece. Lo que será interesante más adelante es encontrar heurísticas internas a la transacción que puedan reforzar esta suposición (estudiaremos estas heurísticas en la Sección 3.3).

Por ejemplo, he aquí una transacción Bitcoin que adopta el modelo de barrido:

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/it/32/05.webp)

Fuente:[Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d) Sin embargo, este tipo de patrón también puede revelar una autotransferencia a una cuenta de una plataforma de intercambio de criptodivisas. Será el estudio de las direcciones conocidas y el contexto de la transacción lo que nos permita saber si se trata de una consolidación a un monedero propio o de una retirada a una plataforma. En efecto, las direcciones de las plataformas de intercambio suelen ser fácilmente identificables.

Volvamos al ejemplo de Alice: si la consolidación conduce a una dirección conocida de una plataforma (como Binance, por ejemplo), esto puede significar que los bitcoins fueron transferidos fuera de la posesión directa de Alice, probablemente con la intención de venderlos o almacenarlos en esta plataforma. Por otro lado, si la dirección de destino es desconocida, es razonable suponer que se trata simplemente de otro monedero que aún pertenece a Alice. Pero este tipo de estudio entra más en la categoría de la heurística y no en la del estudio de patrones.

### Consolidación

Este modelo se caracteriza por consumir varios UTXOs como entrada y producir un único UTXO como salida.

![BTC204](assets/it/32/06.webp)

La interpretación de este patrón es que estamos en presencia de una consolidación. Se trata de una práctica habitual entre los usuarios de Bitcoin que consiste en fusionar varios UTXOs en previsión de un posible aumento de las comisiones por transacción. Realizando esta operación durante un periodo en el que las tasas son bajas, es posible ahorrar en tasas futuras. Discutiremos más sobre esta práctica en el Capítulo 4.3.

Podemos deducir que el usuario detrás de este modelo de transacción probablemente estaba en posesión de todos los UTXO de entrada y todavía está en posesión del UTXO de salida. Esto es definitivamente una autotransferencia.

Al igual que la consolidación, este tipo de patrón también puede revelar una autotransferencia a una cuenta de una plataforma de intercambio. Será el estudio de las direcciones conocidas y el contexto de la transacción lo que nos permita saber si se trata de una consolidación a un monedero de autocustodia o de una retirada a una plataforma.

Por ejemplo, he aquí una transacción Bitcoin que adopta el esquema de consolidación:

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/it/32/07.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)

En el contexto de un análisis de cadena, este modelo puede revelar mucha información. Por ejemplo, si sabemos que una de las entradas pertenece a Alicia, podemos suponer que todas las demás entradas y salidas de esta transacción le pertenecen. Esta suposición nos permitiría rastrear cadenas de transacciones anteriores para descubrir y analizar otras transacciones probablemente asociadas a Alice.

![BTC204](assets/it/32/08.webp)

### Gastos agrupados

Este modelo se caracteriza por el consumo de unos pocos UTXOs como entrada (a menudo sólo uno) y la producción de numerosos UTXOs como salida.

![BTC204](assets/it/32/09.webp)

La interpretación de este patrón es que se trata de gastos agrupados. Se trata de una práctica que probablemente revele una actividad económica importante, como una plataforma de intercambio. El gasto agrupado permite a estas entidades ahorrar en comisiones al consolidar sus gastos en una única transacción.

Podemos deducir de este modelo que la entrada de UTXO procede de una empresa con una actividad económica significativa y que las salidas de UTXO se dispersarán. Muchos pertenecerán a los clientes de la empresa que retiraron bitcoin de la plataforma. Otras pueden ir a empresas asociadas. Por último, seguramente habrá uno o varios intercambios que retornen a la empresa emisora.

Por ejemplo, he aquí una transacción Bitcoin que adopta el modelo de gasto agrupado (probablemente, se trata de una transacción emitida por la plataforma Bybit):

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/it/32/10.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### Transacciones específicas de protocolo

Entre los patrones de transacción, también podemos identificar patrones que revelan el uso de un protocolo específico. Por ejemplo, las coinjoins de Whirlpool (de las que hablaremos en la Parte 5) tendrán una estructura fácilmente identificable que permite diferenciarlas de otras transacciones más tradicionales.

![BTC204](assets/it/32/11.webp)

El análisis de este patrón sugiere que probablemente estemos ante una transacción colaborativa. También es posible observar una coinjoin. Si esta última hipótesis resulta acertada, el número de salidas podría darnos una estimación aproximada del número de participantes en la coinjoin.

Por ejemplo, he aquí una transacción Bitcoin que adopta el modelo de tipo de transacción colaborativa coinjoin:

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/it/32/12.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

Existen muchos otros protocolos que tienen sus propias estructuras específicas. Así, podríamos distinguir transacciones del tipo Wabisabi, transacciones Stamps, o incluso Runes, por ejemplo.

Gracias a estos modelos de transacción, ya podemos interpretar cierta cantidad de información sobre una transacción determinada. Pero la estructura de la transacción no es la única fuente de información para el análisis. También podemos estudiar sus detalles. Estos detalles, internos a una transacción, son lo que me gusta llamar "heurística interna", y los estudiaremos en el capítulo siguiente.

## Heurística interna

<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>

Una heurística interna es una característica específica identificada dentro de la propia transacción, sin necesidad de examinar su entorno, que nos permite hacer inferencias. A diferencia de los modelos que se centran en la estructura general de la transacción a alto nivel, las heurísticas internas se basan en el conjunto de datos extraíbles. Esto incluye:


- Las cantidades de diferentes UTXOs dentro y fuera;
- Todo sobre los scripts: recepción de direcciones, versionado, tiempos de bloqueo, etc.

Generalmente, este tipo de heurística nos permitirá identificar el resto en una transacción específica. De este modo, podremos seguir el rastro de una entidad a través de múltiples transacciones. De hecho, si identificamos un UTXO perteneciente a un usuario que deseamos rastrear, es crucial determinar, cuando realiza una transacción, qué salida ha sido transferida a otro usuario y qué salida representa el resto, permaneciendo así en su posesión.

![BTC204](assets/it/33/01.webp)

Vuelvo a recordar que estas heurísticas no son en absoluto exactas. Tomados individualmente, sólo nos permiten identificar escenarios plausibles. Es la acumulación de diferentes heurísticas lo que ayuda a reducir la incertidumbre, sin llegar a eliminarla por completo.

### Similitudes internas

Esta heurística consiste en estudiar las similitudes entre las entradas y las salidas de una misma transacción. Si observamos la misma característica en las entradas y en una sola de las salidas de la transacción, es probable que esta salida constituya el resto.

La característica más obvia es la reutilización de una dirección receptora en la misma transacción.

![BTC204](assets/it/33/02.webp)

Esta heurística deja poco lugar a dudas. A menos que la clave privada haya sido pirateada, la misma dirección de recepción revela inevitablemente la actividad de un único usuario. La interpretación que sigue es que el resto de la transacción es la salida con la misma dirección que la entrada. Esto permite un seguimiento continuo del individuo basado en este resto.

Por ejemplo, he aquí una transacción en la que puede aplicarse razonablemente esta heurística:

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/fr/046.webp)

Fonte: [Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

Estas similitudes entre la entrada y la salida no se limitan a la reutilización de direcciones. Cualquier similitud en el uso de guiones puede permitir la aplicación de heurísticas. Por ejemplo, a veces puede observarse el mismo versionado entre una entrada y una de las salidas de la transacción.

![BTC204](assets/it/33/04.webp)

En este diagrama, podemos ver que la entrada nº 0 desbloquea un script P2WPKH (SegWit V0 que empieza por `bc1q`). La salida nº 0 utiliza el mismo tipo de script. Sin embargo, la salida nº 1 utiliza un script P2TR (SegWit V1 empezando por `bc1p`). La interpretación de esta característica es que es probable que la dirección con el mismo versionado que la entrada sea la dirección del resto. Por lo tanto, seguiría perteneciendo al mismo usuario.

He aquí una transacción en la que esta heurística puede aplicarse razonablemente:

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/fr/048.webp)

Fonte: [Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)

En este caso, podemos ver que la entrada nº 0 y la salida nº 1 utilizan scripts P2WPKH (SegWit V0), mientras que la salida nº 0 utiliza un tipo de script diferente, P2PKH (Legacy). A principios de la década de 2010, esta heurística basada en la versión del script era relativamente poco útil debido a la limitación de los tipos de script disponibles. Sin embargo, con el tiempo y las posteriores actualizaciones de Bitcoin, se ha introducido una creciente diversidad de tipos de script. Esta heurística es cada vez más relevante porque, con una gama más amplia de tipos de script, los usuarios se dividen en grupos más pequeños, aumentando así las posibilidades de aplicar esta heurística interna de reutilización de versiones. Por esta razón, sólo desde el punto de vista de la privacidad, es aconsejable optar por el tipo de script más común. Por ejemplo, mientras escribo estas líneas, los scripts Taproot (`bc1p`) son menos utilizados que los scripts SegWit V0 (`bc1q`). Aunque los primeros ofrecen ventajas económicas y de privacidad en ciertos contextos específicos, para usos más tradicionales de firma única, puede ser prudente quedarse con un estándar más antiguo por razones de privacidad hasta que el nuevo estándar sea adoptado más ampliamente.

### Pagos con números redondeados

Otra heurística interna que puede ayudarnos a identificar el resto es la del número redondeado. Generalmente, ante un esquema de pago simple (1 entrada y 2 salidas), si una de las salidas gasta una cantidad redondeada, entonces representa el pago.

![BTC204](assets/it/33/06.webp)

Por eliminación, si una salida representa el pago, la otra representa el cambio. Por lo tanto, se puede deducir que es probable que el usuario que introdujo la transacción aún posea la salida identificada como cambio.

Hay que señalar que esta heurística no siempre es aplicable, ya que la mayoría de los pagos se siguen realizando en unidades de moneda fiduciaria. De hecho, cuando un comerciante en Francia acepta bitcoin, generalmente no muestra precios estables en sats. Prefiere optar por una conversión entre el precio en euros y el importe en bitcoin a pagar. Por lo tanto, no debería haber un número redondeado en la salida de la transacción.

Sin embargo, un analista podría intentar realizar esta conversión teniendo en cuenta el tipo de cambio vigente en el momento en que se transmitió la transacción a través de la red. Tomemos el ejemplo de una transacción con una entrada de 97.552 sats y dos salidas, una de 31.085 sats y otra de 64.152 sats. A primera vista, esta transacción no parece implicar cantidades redondeadas. Sin embargo, aplicando el tipo de cambio de 64,339` en el momento de la transacción, obtenemos una conversión a euros que queda como sigue:


- Una aportación de 62,76 euros;
- Un rendimiento de 20 euros;
- Un rendimiento de 41,27 euros.

Una vez convertida a moneda fiduciaria, esta transacción permite aplicar la heurística de pagos con importes redondeados. La salida de 20 euros probablemente se destinó a un comerciante o cambió de propietario. Por inferencia, la salida de 41,27 euros probablemente permaneció en posesión del usuario original.

![BTC204](assets/it/33/07.webp)

Si algún día Bitcoin se convierte en la unidad de cuenta preferida en nuestras transacciones, esta heurística podría ser aún más útil para el análisis.

Por ejemplo, he aquí una transacción en la que probablemente pueda aplicarse esta heurística:

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/fr/051.webp)

Fonte: [Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)

### La mayor producción

Cuando existe una diferencia significativamente grande entre dos resultados de una transacción en un modelo de pago simple, puede estimarse que el resultado mayor es probablemente el resto.

![BTC204](assets/it/33/09.webp)

Esta heurística de mayor salida es probablemente la más imprecisa de todas. Cuando se identifica por sí sola, es bastante débil. Sin embargo, esta característica puede combinarse con otras heurísticas para reducir la incertidumbre de nuestra interpretación.

Por ejemplo, si examinamos una transacción que tiene una salida con un importe redondo y otra salida con un importe mayor, la aplicación conjunta de la heurística de pagos redondos y la heurística relacionada con la salida mayor nos permite reducir nuestro nivel de incertidumbre.

Por ejemplo, he aquí una transacción en la que probablemente pueda aplicarse esta heurística:

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/fr/053.webp)

Fonte: [Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## Heurística externa

<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>

El estudio de la heurística externa consiste en analizar las similitudes, pautas y características de determinados elementos que no son intrínsecos a la propia transacción. En otras palabras, si antes nos limitábamos a explotar elementos intrínsecos a la transacción con la heurística interna, ahora ampliamos nuestro campo de análisis al entorno de la transacción mediante la heurística externa.

### Reutilización de direcciones

Esta es una de las heurísticas más conocidas entre los entusiastas de Bitcoin. La reutilización de direcciones permite establecer una conexión entre diferentes transacciones y diferentes UTXOs. Se observa cuando una dirección receptora de Bitcoin se utiliza varias veces.

Así, es posible explotar la reutilización de direcciones dentro de la misma transacción como una heurística interna para identificar el resto (como vimos en el capítulo anterior). Sin embargo, la reutilización de direcciones también puede servir como heurístico externo para reconocer la unicidad de una entidad detrás de varias transacciones.

La interpretación de la reutilización de direcciones es que todos los UTXO bloqueados en esta dirección pertenecen (o han pertenecido) a la misma entidad. Esta heurística deja poco margen a la incertidumbre. Cuando se puede identificar, la interpretación que sigue es la que más probablemente se corresponde con la realidad. Así, permite agrupar diferentes actividades en cadena.

![BTC204](assets/it/34/01.webp)

Como se explica en la introducción de esta Parte 3, esta heurística fue descubierta por el propio Satoshi Nakamoto. En el Libro Blanco, menciona específicamente una solución para que los usuarios la eviten, que consiste simplemente en utilizar una nueva dirección para cada nueva transacción:

"_Como protección adicional, se podría utilizar un nuevo par de claves para cada transacción para evitar que se vinculen a un propietario común._"

![BTC204](assets/fr/055.webp)

Fuente: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

Por ejemplo, he aquí una dirección reutilizada en varias transacciones:

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

Fuente:[Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### Similitud de guiones y huellas dactilares de las carteras

Además de la reutilización de direcciones, existen otras heurísticas para vincular las acciones a una misma cartera o a un grupo de direcciones.

En primer lugar, un analista puede aprovechar las similitudes en el uso de scripts. Por ejemplo, ciertos scripts minoritarios como multisig pueden identificarse más fácilmente que los scripts SegWit V0. Cuanto mayor sea el grupo en el que nos escondemos, más difícil será identificarnos. Por eso, en los buenos protocolos Coinjoin, todos los participantes utilizan exactamente el mismo tipo de scripts.

En términos más generales, un analista también puede centrarse en las características de la huella digital de una cartera. Se trata de procesos específicos relacionados con el uso que uno puede tratar de identificar con el objetivo de explotarlos como heurísticos de seguimiento. En otras palabras, si se observa una acumulación de las mismas características internas en las transacciones atribuidas a la entidad rastreada, se puede intentar identificar estas mismas características en otras transacciones.

Por ejemplo, se puede identificar que el usuario rastreado envía sistemáticamente su resto a direcciones P2TR (`bc1p...`). Si este proceso se repite, puede utilizarse como heurística para la continuación de nuestro análisis. Se pueden utilizar otras huellas, como el orden de los UTXOs, la colocación del resto en las salidas, la señalización RBF (Replace-by-Fee), o incluso, el número de versión, el campo `nSequence`, y el campo `nLockTime`.

Como especifica [@LaurentMT](https://twitter.com/LaurentMT) en [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji) (un podcast francófono), la utilidad de las huellas de monedero en el análisis de cadenas aumenta considerablemente con el tiempo. De hecho, el creciente número de tipos de script y el despliegue cada vez más gradual de estas nuevas capacidades por parte del software de monedero acentúan las diferencias. Incluso puede darse el caso de que se pueda identificar con precisión el software utilizado por la entidad rastreada. Por lo tanto, es importante comprender que el estudio de la huella digital de un monedero resulta especialmente pertinente para las transacciones recientes, más que para las iniciadas a principios de la década de 2010.

En resumen, una huella digital puede ser cualquier práctica específica, realizada automáticamente por el monedero o manualmente por el usuario, que puede encontrarse en otras transacciones para ayudarnos en nuestro análisis.

### La heurística de la propiedad común de los insumos (CIOH)

CIOH, por "Common Input Ownership Heuristic" en inglés, es una heurística que establece que cuando una transacción incluye múltiples inputs, es probable que procedan de una única entidad. En consecuencia, su propiedad es común.

Para aplicar la Heurística de Propiedad Común de Entradas (CIOH), primero observamos una transacción que tiene múltiples entradas. Puede ser desde un mínimo de 2 entradas hasta un máximo de 30 entradas. Una vez identificada esta característica, comprobamos si la transacción no se ajusta a un modelo de transacción conocido. Por ejemplo, si tiene 5 entradas con cantidades aproximadamente iguales y 5 salidas con exactamente la misma cantidad, sabemos que es la estructura de una coinjoin. Por lo tanto, no podemos aplicar IOCH.

Sin embargo, si la transacción no se ajusta a ningún modelo conocido de transacción colaborativa, entonces podemos deducir que todas las entradas proceden probablemente de la misma entidad. Esto puede ser muy útil para ampliar un clúster conocido o para continuar el rastreo.

CIOH fue descubierto por Satoshi Nakamoto. Habla de ello en la parte 10 del Libro Blanco:

"_[...] la vinculación es inevitable con las transacciones de múltiples entradas, que necesariamente revelan que sus entradas pertenecían al mismo propietario. El riesgo es que si se revela el propietario de una clave, los vínculos pueden revelar otras transacciones que pertenecían al mismo propietario._"

Resulta especialmente fascinante observar que Satoshi Nakamoto, incluso antes del lanzamiento oficial de Bitcoin, ya había identificado las dos principales vulnerabilidades de privacidad para los usuarios, a saber, IOCH y la reutilización de direcciones. Tal predicción es bastante notable, ya que estas dos heurísticas siguen siendo, a día de hoy, las más útiles en el análisis de blockchain.

Por poner un ejemplo, he aquí una transacción a la que probablemente podamos aplicar IOCH:

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

Fonte: [Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### Datos fuera de cadena

Por supuesto, el análisis en cadena no se limita exclusivamente a los datos en cadena. Los datos de análisis anteriores o disponibles en Internet también pueden utilizarse para afinar un análisis.

Por ejemplo, si se observa que las transacciones rastreadas se transmiten sistemáticamente desde el mismo nodo Bitcoin y se puede identificar su dirección IP, podría ser posible identificar otras transacciones de la misma entidad, así como determinar parte de la identidad del remitente. Aunque esta práctica no es fácil de llevar a cabo, ya que requiere el funcionamiento de muchos nodos, es posible que algunas empresas especializadas en el análisis de cadenas la empleen.

El analista también tiene la opción de basarse en análisis realizados previamente en código abierto, o en sus propios análisis anteriores. Tal vez se pueda encontrar un resultado que apunte a una agrupación de direcciones ya identificada. A veces, también es posible basarse en resultados que apunten a una plataforma de intercambio, ya que las direcciones de estas empresas son generalmente conocidas.

Del mismo modo, se puede realizar un análisis por eliminación. Por ejemplo, si durante el análisis de una operación con dos salidas, una de ellas está conectada a un grupo de direcciones ya conocido pero distinto de la entidad rastreada, se puede interpretar que la otra salida probablemente representa al resto.

El análisis en cadena también incluye una parte de OSINT (_Open Source Intelligence_) que es un poco más generalista con las búsquedas en Internet. Por eso no se recomienda publicar las direcciones de recepción directamente en las redes sociales o en un sitio web, ya sea bajo seudónimo o no.

![BTC204](assets/fr/063.webp)

### Patrones temporales

Es algo que se tiene menos en cuenta, pero ciertos comportamientos humanos son reconocibles en la cadena. El más útil en el análisis podría ser su patrón de sueño Sí, cuando duerme, presumiblemente no está transmitiendo transacciones Bitcoin. Como generalmente duermes a las mismas horas, es común usar el análisis temporal en el análisis en cadena. Esto simplemente implica catalogar las horas en las que las transacciones de una entidad dada son transmitidas a la red Bitcoin. Analizar estos patrones temporales nos permite inferir mucha información.

En primer lugar, un análisis temporal permitirá a veces identificar la naturaleza de la entidad rastreada. Si se observa que las transacciones se transmiten de forma constante a lo largo de 24 horas, esto revelará una fuerte actividad económica. La entidad que está detrás de estas transacciones es probablemente una empresa, potencialmente internacional, y tal vez con procedimientos automatizados internamente.

Por ejemplo, [había reconocido este patrón hace unos meses](https://twitter.com/Loic_Pandul/status/1701127409712452072) al analizar [la transacción que había asignado por error 19 bitcoins en concepto de comisiones](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd). Un simple análisis temporal me había permitido suponer que se trataba de un servicio automatizado y, por tanto, probablemente de una gran entidad como una plataforma de intercambio.

De hecho, unos días después, se descubrió que los fondos pertenecían a PayPal, a través de la plataforma de intercambio Paxos.

Por el contrario, si vemos que el patrón temporal está bastante repartido en 16 horas muy concretas, podemos estimar que se trata de un usuario individual, o quizá de una empresa local en función de los volúmenes negociados.

Además de la naturaleza de la entidad observada, el modelo temporal también puede darnos una localización aproximada del usuario a través de las zonas horarias. A continuación, podemos vincular otras transacciones y utilizar las marcas de tiempo de éstas como heurísticas adicionales que pueden añadirse a nuestro análisis.

Por ejemplo, en la dirección reutilizada que he mencionado antes, podemos observar que las transacciones, tanto entrantes como salientes, se concentran en un intervalo de 13 horas.

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/064.webp)

Fuente: OXT.me

Esta franja corresponde probablemente a Europa, África u Oriente Medio. Por lo tanto, podemos deducir que el usuario que está detrás de estas transacciones vive allí.

En un registro diferente, también es un análisis horario de este tipo el que permitió la hipótesis de que Satoshi Nakamoto no operaba desde Japón, sino en realidad desde Estados Unidos: [_The Time Zones of Satoshi Nakamoto_](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## Aplicación práctica con un explorador de bloques

<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

En este capítulo final, aplicaremos concretamente los conceptos que hemos estudiado hasta ahora. Presentaré ejemplos de transacciones reales de Bitcoin, y tendrás que extraer la información que te pida.

Lo ideal para estos ejercicios sería utilizar una herramienta profesional de análisis de cadenas. Sin embargo, tras el cierre de los creadores de Samourai Wallet, la única herramienta de análisis gratuita OXT.me ya no está disponible. Por lo tanto, optaremos por un explorador de bloques clásico para estos ejercicios. Recomiendo usar [Mempool.space](https://mempool.space/) por sus muchas características y su gama de herramientas de análisis de cadenas, pero también puedes elegir otro explorador como [Bitcoin Explorer](https://bitcoinexplorer.org/). Para empezar, presentaré los ejercicios. Utiliza tu explorador de bloques para completarlos y escribe tus respuestas en un papel. Luego, al final de este capítulo, te proporcionaré las respuestas para que puedas comprobar y corregir tus resultados.

las operaciones seleccionadas para estos ejercicios se eligieron únicamente por sus características de forma un tanto aleatoria. Este capítulo está destinado únicamente a fines educativos e informativos. Quiero dejar claro que no defiendo ni aliento el uso de estas herramientas con fines maliciosos. El objetivo es enseñarte a protegerte del análisis en cadena, no a realizar análisis para exponer información privada de otros._

### Ejercicio 1

ID de la transacción a analizar:

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

¿Cuál es el nombre del modelo de esta transacción y qué interpretaciones plausibles pueden extraerse examinando únicamente su modelo, es decir, la estructura de la transacción?

### Ejercicio 2

ID de la transacción a analizar:

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

¿Cuál es el nombre del modelo de esta transacción y qué interpretaciones plausibles pueden extraerse examinando únicamente su modelo, es decir, la estructura de la transacción?

### Ejercicio 3

ID de la transacción a analizar:

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

¿Cuál es el patrón de esta transacción?

Tras identificar su modelo, utilizando la heurística interna de la operación, ¿qué salida es probable que represente el resto?

### Ejercicio 4

ID de la transacción a analizar:

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

¿Cuál es el patrón de esta transacción?

Tras identificar su modelo, utilizando la heurística interna de la operación, ¿qué salida es probable que represente el resto?

### Ejercicio 5

Imagina que Loïc publica una de sus direcciones Bitcoin para recibir pagos en la red social Twitter:

![BTC204](assets/fr/065.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

Utilizando **sólo la heurística de reutilización de direcciones**, ¿qué transacciones de Bitcoin podemos vincular a la identidad de Loïc?

obviamente, no soy el verdadero propietario de esta dirección de recepción y no la he publicado en las redes sociales. Es una dirección que elegí al azar de la cadena de bloques

### Ejercicio 6

Siguiendo el Ejercicio 5, utilizando la heurística de reutilización de direcciones, has podido identificar varias transacciones de Bitcoin en las que parece estar implicado Loïc. Normalmente, entre las transacciones identificadas, deberías haber identificado esta:

Esta transacción representa la primera que envía fondos a la dirección de Loïc. ¿De dónde crees que proceden los bitcoins recibidos por Loïc a través de esta transacción?

### Ejercicio 7

Siguiendo el Ejercicio 5, utilizando la heurística de reutilización de direcciones, has sido capaz de identificar varias transacciones Bitcoin en las que Loïc parece estar involucrado. Ahora desea averiguar de dónde procede Loïc. Basándose en las transacciones encontradas, realice un análisis horario para averiguar la zona horaria más probable utilizada por Loïc. A partir de esta zona horaria, determina la ubicación en la que parece vivir Loïc (país, estado/región, ciudad...).

### Ejercicio 8

He aquí la transacción Bitcoin a estudiar:

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

Si nos fijamos únicamente en esta transacción, ¿qué información podemos interpretar?

### Soluciones a los ejercicios

**_Ejercicio 1:_**

El modelo de esta transacción es el de un simple pago. Si estudiamos sólo su estructura, podemos interpretar que una salida representa un cambio y la otra un pago real. Entonces sabemos que el usuario observado probablemente ya no está en posesión de uno de los dos UTXO de las salidas (el del pago), pero sigue en posesión del otro UTXO (el del cambio).

**_Ejercicio 2:_**

El patrón de esta transacción es el del gasto por lotes. Este patrón indica probablemente una actividad económica significativa, como una plataforma de intercambio. Podemos deducir que el UTXO de entrada procede de una empresa con una actividad económica significativa y que los UTXO de salida se dispersarán. Algunos pertenecerán a los clientes de la empresa que han retirado sus bitcoins a monederos propios. Otros irán a parar a empresas asociadas. Por último, habrá sin duda un remanente que volverá a la empresa emisora.

**_Ejercicio 3:_**

El modelo de esta transacción es el de un simple pago. Por lo tanto, podemos aplicar una heurística interna a la transacción para tratar de identificar el resto.

Personalmente, he identificado al menos dos heurísticas internas que apoyan la misma hipótesis:


- La reutilización del mismo tipo de guión;
- La mayor producción.

La heurística más obvia es la reutilización del mismo tipo de script. De hecho, la salida `0` es un `P2SH`, reconocible por su dirección de recepción que empieza por `3`:

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

Mientras que la salida `1` es un `P2WPKH`, identificable por su dirección que comienza por `bc1q`:

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

El UTXO utilizado como entrada para esta operación también utiliza un script `P2WPKH`:

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

Así, podemos suponer que la salida `0` corresponde a un pago y la salida `1` es el resto de la transacción, lo que significaría que el usuario de entrada sigue siendo propietario de la salida `1`.

Para apoyar o refutar esta hipótesis, podemos buscar otros heurísticos que confirmen nuestro pensamiento o disminuyan la probabilidad de que nuestra hipótesis sea correcta.

He identificado al menos otra heurística. Es la salida más grande. La salida `0` mide `123.689 saturaciones`, mientras que la salida `1` mide `505.839 saturaciones`. Por lo tanto, hay una diferencia significativa entre estas dos salidas. La heurística de la salida más grande sugiere que la salida más voluminosa es probablemente el resto. Por tanto, esta heurística refuerza aún más nuestra hipótesis inicial.

Parece probable que el usuario que proporcionó la entrada UTXO aún mantenga la salida `1`, que parece representar el resto de la transacción.

**_Ejercicio 4:_**

El modelo de esta transacción es el de un simple pago. Por lo tanto, podemos aplicar una heurística interna a la transacción para tratar de identificar el resto.

Personalmente he identificado al menos dos heurísticas internas que apoyan la misma hipótesis:


- La reutilización del mismo tipo de guión;
- La salida de una cantidad redonda.

La heurística más obvia es la reutilización del mismo tipo de script. De hecho, la salida `0` es un `P2SH`, reconocible por su dirección de recepción que empieza por `3`:

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

Mientras que la salida `1` es un `P2WPKH`, identificable por su dirección que comienza por `bc1q`:

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

El UTXO utilizado como entrada para esta operación también utiliza un script `P2WPKH`:

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

Así, podemos suponer que la salida `0` corresponde a un pago y la salida `1` es el resto de la transacción, lo que significaría que el usuario de entrada sigue teniendo la salida `1`.

Para apoyar o refutar esta hipótesis, podemos buscar otros heurísticos que confirmen nuestro pensamiento o disminuyan la probabilidad de que nuestra hipótesis sea correcta.

He identificado al menos otra heurística. Se trata de la salida de una cantidad redonda. La salida `0` mide `70.000 sats`, mientras que la salida `1` mide `22.962 sats`. Por lo tanto, estamos ante una salida perfectamente redonda en unidades de cuenta BTC. La heurística de la salida redonda sugiere que la UTXO con una cantidad redonda es probablemente el pago, y por eliminación, la otra representa el resto. Por lo tanto, esta heurística refuerza aún más nuestra hipótesis inicial.

Sin embargo, en este ejemplo, otra heurística podría cuestionar nuestra suposición inicial. De hecho, la salida `0` es mayor que la salida `1`. Si basamos nuestro razonamiento en la heurística de que la salida mayor suele ser el resto, podríamos deducir que la salida `0` es el resto. Sin embargo, esta contrahipótesis parece poco plausible, ya que las otras dos heurísticas parecen sustancialmente más convincentes que la heurística de la salida mayor. En consecuencia, parece razonable mantener nuestra hipótesis inicial a pesar de esta aparente contradicción.

Por lo tanto, parece probable que el usuario que proporcionó el UTXO como entrada aún mantenga la salida `1`, que parece representar el resto de la transacción.

**_Ejercicio 5:_**

Podemos ver que 8 transacciones pueden asociarse a la identidad de Loïc. De ellas, 4 implican la recepción de bitcoins:

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
8b70bd322e6118b8a002dbdb731d16b59c4a729c2379af376ae230cf8cdde0dd
d5864ea93e7a8db9d3fb113651d2131567e284e868021e114a67c3f5fb616ac4
bc4dcf2200c88ac1f976b8c9018ce70f9007e949435841fc5681fd33308dd762
```

Los otros 4 se refieren al envío de bitcoin:

```plaintext
8b52fe3c2cf8bef60828399d1c776c0e9e99e7aaeeff721fff70f4b68145d540
c12499e9a865b9e920012e39b4b9867ea821e44c047d022ebb5c9113f2910ed6
a6dbebebca119af3d05c0196b76f80fdbf78f20368ebef1b7fd3476d0814517d
3aeb7ce02c35eaecccc0a97a771d92c3e65e86bedff42a8185edd12ce89d89cc
```

**_Ejercicio 6:_**

Si examinamos el patrón de esta transacción, resulta evidente que se trata de un gasto agrupado. De hecho, la transacción tiene una única entrada y 51 salidas, lo que indica una actividad económica significativa. Por tanto, podemos suponer que Loïc retiró bitcoins de una plataforma de intercambio.

Varios elementos refuerzan esta hipótesis. En primer lugar, el tipo de script utilizado para proteger el UTXO de entrada es un script P2SH multisig 2/3, lo que indica un nivel avanzado de seguridad típico de las plataformas de intercambio:

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```

Además, la dirección analizada `3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF` se reutilizó en más de 220.000 transacciones diferentes, lo que suele ser característico de plataformas de intercambio que no suelen preocuparse por su privacidad. La heurística temporal aplicada a esta dirección también muestra una dispersión regular de transacciones casi diarias a lo largo de un periodo de 3 meses, con horarios prolongados de más de 24 horas, lo que sugiere la actividad continua de una plataforma de intercambio.

Por último, los volúmenes procesados por esta entidad son enormes. De hecho, la dirección recibió y envió 44 BTC durante 222.262 transacciones entre diciembre de 2022 y marzo de 2023. Estos importantes volúmenes confirman aún más el carácter probable de la actividad de una plataforma de intercambio.

**_Ejercicio 7:_**

Analizando las horas de confirmación de las transacciones, se observan las siguientes horas UTC:

```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

Al analizar estas horas, se observa que los husos horarios UTC-7 y UTC-8 son coherentes con una serie de actividades humanas comunes (entre las 8.00 y las 23.00 horas) en la mayoría de las horas:

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7
05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

El huso horario UTC-7 es especialmente relevante en verano, ya que incluye estados y regiones como:


- California (con ciudades como Los Ángeles, San Francisco y San Diego);
- Nevada (con Las Vegas);
- Oregón (con Portland);
- Washington (con Seattle);
- La región canadiense de Columbia Británica (con ciudades como Vancouver y Victoria).

Esta información sugiere que Loïc podría residir en la costa oeste de Estados Unidos o Canadá.

**_Ejercicio 8:_**

El análisis de esta operación revela 5 entradas y una única salida, lo que parece indicar una consolidación. La aplicación de la heurística CIOH sugiere que todos los UTXO de las entradas pertenecen a una única entidad, y que el UTXO de la salida también pertenece a esta entidad. Parece que el usuario eligió consolidar varios UTXOs de su propiedad en un único UTXO en la salida, con el objetivo de consolidar sus propias monedas. Este enfoque fue probablemente motivado por el deseo de aprovechar las bajas tasas de transacción del momento para reducir las tasas futuras.

---
para la redacción de esta Parte 3 sobre el análisis de la cadena, me he basado en los siguientes recursos:_


- _La serie de cuatro artículos titulada: [Understanding Bitcoin Privacy with OXT](https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923), producida por Samourai Wallet en 2021;_
- los diversos informes de [OXT Research](https://medium.com/oxt-research), así como su herramienta gratuita de análisis de cadenas (que actualmente ya no está disponible tras la detención de los fundadores de Samourai Wallet);_
- de forma más general, mis conocimientos proceden de los diversos tweets y contenidos de [@LaurentMT](https://twitter.com/LaurentMT) y [@ErgoBTC](https://twitter.com/ErgoBTC);_
- \_El [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji) en el que participé junto con [@louneskmt](https://twitter.com/louneskmt), [@TheoPantamis](https://twitter.com/TheoPantamis), [@Sosthene_\_](https://twitter.com/Sosthene___), y [@LaurentMT](https://twitter.com/LaurentMT).\_

me gustaría dar las gracias a sus autores, desarrolladores y productores. Gracias también a los revisores que corrigieron meticulosamente el artículo que sirvió de base para esta parte 3 y me honraron con sus expertos consejos:_


- _[Gilles Cadignan](https://twitter.com/gillesCadignan);_
- _[Ludovic Lars](https://viresinnumeris.fr/)._

# Dominar las mejores prácticas para proteger su privacidad

<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## Reutilización de direcciones

<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>

Habiendo estudiado las técnicas que pueden comprometer su privacidad en Bitcoin, en esta tercera parte, examinaremos ahora las mejores prácticas que puede adoptar para protegerse. Esta parte no pretende explorar métodos para mejorar la privacidad, tema que se tratará más adelante, sino más bien entender cómo interactuar adecuadamente con Bitcoin para mantener la privacidad que ofrece de forma natural, sin recurrir a técnicas adicionales.

Por supuesto, para empezar esta tercera parte, hablaremos de la reutilización de direcciones. Este fenómeno es la principal amenaza para la privacidad de los usuarios. Por lo tanto, este capítulo es probablemente el más importante de todo el curso.

### ¿Qué es una dirección de recepción?

Una dirección de recepción de bitcoin es una cadena de caracteres o un identificador utilizado para recibir bitcoin en un monedero.

Técnicamente, una dirección receptora de bitcoins no "recibe" bitcoins en sentido literal, sino que define las condiciones en las que se pueden gastar bitcoins. Concretamente, cuando se le envía un pago, la transacción del remitente crea un nuevo UTXO destinado a usted en la salida a partir de los UTXO que consumió en las entradas. Sobre esta salida, se aplica un script que define cómo se puede gastar este UTXO posteriormente. Este script se conoce como "_ScriptPubKey_" o "_Locking Script_" Su dirección de recepción, más precisamente su carga útil, está incrustada en este script. Para simplificar, este script esencialmente dice:

> "_Para gastar este nuevo UTXO, se debe proporcionar una firma digital utilizando la clave privada asociada a esta dirección de recepción._"
![BTC204](assets/fr/067.webp)

Las direcciones Bitcoin vienen en diferentes tipos dependiendo del modelo de script utilizado. Los primeros modelos, conocidos como "_Legacy_", incluyen las direcciones `P2PKH` (_Pay-to-PubKey-Hash_) y `P2SH` (_Pay-to-Script-Hash_). Las direcciones P2PKH empiezan siempre por `1` y las P2SH por `3`. Aunque siguen siendo seguros, estos formatos han quedado obsoletos, ya que conllevan comisiones de transacción más elevadas y ofrecen menos privacidad que los nuevos estándares.

Las direcciones SegWit V0 (`P2WPKH` y `P2WSH`) y Taproot / SegWit V1 (`P2TR`) representan formatos modernos. Las direcciones SegWit empiezan por `bc1q` y las Taproot, introducidas en 2021, empiezan por `bc1p`.

Por ejemplo, aquí hay una dirección de recepción de Taproot:

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

La forma en que se construya la ScriptPubKey dependerá del estándar que esté utilizando:

| Script Template | ScriptPubKey || ---------------- | ----------------------------------------------------------- | ----------------------------------------------------------- |

| P2PKH | OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG |

| P2SH | OP_HASH160 `<scriptHash>` OP_EQUAL |

0 `<pubKeyHash>` | P2WPKH | 0 `<pubKeyHash>` |

| P2WSH 0 `<witnessScriptHash>` |

| P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL |

| P2SH - P2WSH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL |

| P2TR | 1 `<pubKey>` |

En cuanto a la construcción de las direcciones receptoras, también depende de la plantilla de script elegida:


- Para las direcciones `P2PKH` y `P2WPKH`, la carga útil, o el núcleo de la dirección, representa el hash de la clave pública;
- Para las direcciones `P2SH` y `P2WSH`, la carga útil representa el hash de un script;
- En cuanto a las direcciones `P2TR`, la carga útil es una clave pública modificada. Las salidas `P2TR` combinan aspectos de _Pay-to-PubKey_ y _Pay-to-Script_. La clave pública modificada es el resultado de añadir una clave pública de gasto clásica con una "modificación", derivada de la raíz Merkle de un conjunto de scripts que también pueden utilizarse para gastar bitcoin.

![BTC204](assets/it/67/01.webp)

Las direcciones mostradas en su software monedero también incluyen una HRP (_Human-Readable Part_), normalmente `bc` para direcciones post-SegWit, un separador `1`, y un número de versión `q` para SegWit V0 y `p` para Taproot/SegWit V1. También se añade una suma de comprobación para garantizar la integridad y validez de la dirección durante su transmisión.

Por último, las direcciones se colocan en un formato estándar:


- Base58check para direcciones Legacy antiguas;
- Bech32 para direcciones SegWit;
- Bech32m para direcciones Taproot.

Aquí está la matriz de suma para los formatos bech32 y bech32m (SegWit y Taproot) de base 10:

| + | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |



| 0 | q | p | z | r | y | 9 | x | 8 | 8

| 8 | g | f | 2 | t | v | d | w | 0 |

| 16 | s | 3 | j | n | 5 | 4 | k | h | | 24 | c | e | 6 | m | u | a | 7 | l | l

### ¿Qué es la reutilización de direcciones?

La reutilización de direcciones se refiere a la práctica de utilizar la misma dirección de recepción para bloquear varios UTXOs diferentes.

Como vimos en la sección anterior, cada UTXO tiene su propia ScriptPubKey que lo bloquea y debe ser satisfecha para que el UTXO pueda ser consumido como entrada en una nueva transacción. Es dentro de esta ScriptPubKey donde se incrustan las direcciones de recepción (cargas útiles).

Cuando varias ScriptPubKeys contienen la misma dirección receptora, esto se conoce como reutilización de direcciones. En la práctica, esto significa que un usuario ha proporcionado la misma dirección varias veces a remitentes para recibir bitcoin a través de múltiples pagos. Y efectivamente, esta práctica es catastrófica para tu privacidad.

### ¿Por qué es un problema la reutilización de direcciones?

Como la cadena de bloques es pública, es fácil ver qué direcciones bloquean qué UTXOs y cuántos bitcoins. Si se utiliza la misma dirección para varias transacciones, es posible deducir que todos los bitcoins asociados a esa dirección pertenecen a la misma persona. Esta práctica compromete la privacidad del usuario, ya que permite establecer vínculos deterministas entre distintas transacciones y rastrear bitcoins en la blockchain. El propio Satoshi Nakamoto destacó este problema en el Libro Blanco de Bitcoin:

> como cortafuegos adicional, se podría utilizar un nuevo par de claves para cada transacción con el fin de evitar que se vinculen a un propietario común
![BTC204](assets/fr/055.webp)

Fuente: S. Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

El objetivo que buscaba Satoshi con esta afirmación era crear un cortafuegos adicional en caso de asociación entre la identidad del usuario y un par de claves en Bitcoin, para evitar que toda su actividad se vinculara públicamente a su identidad. Hoy en día, con la proliferación de empresas de análisis de blockchain y la normativa KYC, el uso de direcciones únicas ya no es un "cortafuegos adicional", sino una práctica necesaria para cualquiera que desee preservar su privacidad al mínimo.

Cuando reutilizas una dirección, creas un vínculo casi indiscutible entre todas las transacciones asociadas a esa dirección. Aunque esto no pone directamente en peligro tus fondos, porque el cifrado en curvas elípticas garantiza la seguridad de tus claves privadas, facilita el control de tus actividades. De hecho, cualquiera con un nodo puede observar tus transacciones y saldos de direcciones, comprometiendo por completo tu anonimato.

![BTC204](assets/it/34/01.webp)

Para ilustrar este punto, tomemos el ejemplo de Bob, un usuario que compra regularmente bitcoins en pequeñas cantidades mediante Dollar Cost Averaging (DCA) y los envía siempre a la misma dirección. Al cabo de dos años, esta dirección contiene una cantidad considerable de bitcoins. Si Bob utiliza esta dirección para realizar un pago a un comerciante local, el comerciante podría ver todos los fondos asociados y deducir el patrimonio de Bob. Esto podría dar lugar a riesgos de seguridad personal, incluidos intentos de robo o extorsión. Si Bob hubiera utilizado una dirección nueva para recibir cada compra periódica, habría revelado infinitamente menos información al comerciante.

En el análisis de la cadena, diferenciamos entre 2 tipos de reutilización de direcciones:


- Reutilización externa;
- Reutilización interna dentro de una transacción.

La primera se observa cuando una dirección se reutiliza en varias transacciones Bitcoin diferentes. Es lo que comentábamos antes: esta heurística permite inferir que todos los UTXO que pasan por esta dirección pertenecen a una única entidad.

La reutilización de direcciones internas se observa no cuando la reutilización se produce a través de múltiples transacciones, sino cuando se produce dentro de la misma transacción. De hecho, si la misma dirección que se utilizó para bloquear una entrada se utiliza como salida en una transacción, podemos deducir que esta salida sigue perteneciendo al mismo usuario (resto), y que la segunda salida representa el pago real. Esta otra heurística permite seguir la pista de los fondos a través de múltiples transacciones.

![BTC204](assets/it/33/02.webp)

La reutilización de direcciones es una auténtica lacra en Bitcoin. Según el sitio web OXT.me (actualmente inaccesible), la tasa global de reutilización de direcciones en Bitcoin fue de alrededor del 52% en 2022:

![BTC204](assets/fr/069.webp)

Esta tasa es enorme, pero procede en su inmensa mayoría de plataformas de intercambio y no de usuarios individuales.

### ¿Cómo evitar la reutilización de direcciones?

Evitar la reutilización de direcciones es muy sencillo: **Sólo tiene que utilizar una dirección nueva para cada pago que reciba en su monedero**.

Gracias a BIP32, las carteras modernas son ahora deterministas y jerárquicas. Esto significa que un usuario puede generar un gran número de direcciones a partir de una única pieza de información inicial: la semilla. Al guardar esta única información, se pueden restaurar todas las claves privadas de la cartera, accediendo así a los fondos asegurados por las direcciones correspondientes.

![BTC204](assets/fr/070.webp)

Por eso, cuando pulsa el botón "_recibir_" en el software de su monedero, se le ofrece cada vez una dirección de recepción no utilizada. Después de recibir bitcoins en esta dirección, el software sugiere automáticamente una nueva dirección.

> _PS: Recientemente, algunos software de monedero han anunciado su intención de dejar de generar direcciones en blanco, temiendo que esto pueda ser percibido como una forma de blanqueo de dinero por las autoridades. Si su software se encuentra entre ellos, le aconsejo encarecidamente que lo sustituya inmediatamente, ya que esto no es aceptable para el usuario._
Si necesitas un identificador estático para recibir pagos, como para recibir donaciones, por ejemplo, usar una dirección Bitcoin clásica no es recomendable por el riesgo de reutilización. Prefiere utilizar una dirección Lightning, o para un identificador de pago estático onchain, puede optar por BIP47 o Silent Payments. Cómo funcionan estos protocolos se detalla en la Parte 6 de esta formación.

## Etiquetado y control de monedas

<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>

Como descubrimos en la sección sobre análisis de cadenas, existen multitud de heurísticas y patrones que pueden utilizarse para deducir información sobre una transacción. Como usuario, es importante conocer estas técnicas para protegerse mejor.

Esto implica en gran medida una gestión estricta del monedero bajo custodia personal, lo que incluye conocer el origen de los UTXOs propios, así como una selección meditada de los UTXOs que se consumirán durante los pagos. Esta gestión eficaz del monedero se basa en dos características importantes de los buenos monederos Bitcoin: el etiquetado y el control de las monedas.

En este capítulo, estudiaremos estas características y veremos cómo podría usarlas inteligentemente, sin añadir demasiada carga de trabajo, para optimizar enormemente su privacidad en Bitcoin.

### ¿Qué es el etiquetado?

El etiquetado es una práctica que consiste en asignar una anotación o etiqueta a un UTXO específico en un monedero Bitcoin. Estas anotaciones son almacenadas localmente por el software del monedero y nunca se transmiten a través de la red Bitcoin. El etiquetado es, por tanto, una herramienta de gestión personal.

Por ejemplo, si poseo un UTXO de una compra P2P en Bisq con Charles, podría asignarle la etiqueta "`Non-KYC Bisq Charles`".

El etiquetado es una buena práctica que ayuda a recordar el origen o destino previsto de un UTXO, facilitando así la gestión de los fondos y optimizando la privacidad. De hecho, es probable que su monedero Bitcoin contenga varios UTXOs. Si las fuentes de estos UTXOs son diferentes, es posible que no desee fusionar estos UTXOs en el futuro, de lo contrario podría revelar su propiedad común. Al etiquetar correctamente todas tus monedas, te aseguras de que recordarás su origen cuando las necesites, aunque no sea hasta dentro de varios años.

### ¿Qué es el control de monedas?

El uso activo del etiquetado resulta aún más atractivo si se combina con la opción de control de monedas en el software del monedero.

El control de monedas es una característica que se encuentra en un buen software de monedero Bitcoin que le da la posibilidad de seleccionar manualmente UTXOs específicos para utilizarlos como entrada para realizar una transacción. De hecho, para satisfacer un pago saliente, debe consumir un UTXO entrante a cambio. Por varias razones que veremos más adelante, es posible que desee elegir con precisión qué monedas consumir como entrada para satisfacer un pago determinado. Esto es exactamente lo que permite el control de monedas. Para darle una analogía, esta funcionalidad es similar a la acción de elegir una moneda específica en su cartera cuando usted paga por su baguette.

El uso de software de monedero controlado por monedas, combinado con el etiquetado de los UTXO, permite a los usuarios distinguir y seleccionar con precisión los UTXO para sus transacciones.

### ¿Cómo etiquetar correctamente sus UTXO?

No existe un método universal de etiquetado de UTXOs que se adapte a todo el mundo. Depende de usted definir un sistema de etiquetado para poder navegar fácilmente por su cartera. En cualquier caso, tenga en cuenta que un buen etiquetado es lo que podrá entender cuando lo necesite. Si su cartera Bitcoin es principalmente para ahorrar, puede que las etiquetas no le sean útiles hasta dentro de varias décadas. Por lo tanto, asegúrese de que sean claras, precisas e inclusivas.

Es importante que sus seres queridos puedan identificar fácilmente el origen de los fondos si, algún día, necesitan acceder a su cartera. Esto podría ayudarles tanto por motivos de privacidad como por necesidades legales, en caso de que tuvieran que justificar el origen de los fondos ante una autoridad.

El aspecto más importante del etiquetado es señalar la procedencia de la UTXO. Simplemente debe indicar cómo llegó esta moneda a su monedero. ¿Procede de una compra en una plataforma de intercambio? ¿Un pago de un cliente? ¿Un intercambio entre pares? ¿O es el resto de una compra? Así, podrías especificar:


- `Pickup Exchange.com`;
- `Cliente de pago David`;
- `Comprar P2P Charles`;
- `Retirada de la compra del sofá`

Para perfeccionar su gestión de UTXOs y adherirse a sus estrategias de segregación de fondos dentro de su cartera, podría enriquecer sus etiquetas con un marcador adicional para reflejar estas separaciones. Si su cartera contiene dos categorías de UTXOs que no desea mezclar, podría integrar un marcador en sus etiquetas para distinguir claramente estos grupos. Estos marcadores de separación dependerán de sus criterios, como distinguir entre UTXOs de un proceso de adquisición que implique KYC, o entre fondos profesionales y personales. Tomando los ejemplos de etiquetas mencionados anteriormente, esto podría traducirse en:


- `KYC - Retirada de Exchange.com`;
- `KYC - Pago del cliente David`;
- `NO KYC - Compra P2P Charles`;
- `NO KYC - Remanente de la compra del sofá`

También es aconsejable perpetuar el etiquetado de una moneda durante las transacciones. Por ejemplo, al consolidar UTXOs sin KYC, asegúrese de marcar el UTXO resultante no solo como "consolidación", sino específicamente como "consolidación sin KYC" para mantener un rastro claro del origen de la moneda.

Por último, no es obligatorio poner una fecha en una etiqueta. La mayoría de los programas de monedero ya muestran la fecha de la transacción, y siempre es posible recuperar esta información en un explorador de bloques utilizando su TXID.

### ¿Cómo elegir correctamente sus monedas?

Al realizar una transacción, el control de monedas permite elegir específicamente qué UTXOs consumir como entrada para satisfacer la salida del pago. En esta elección hay que tener en cuenta dos aspectos:


- La posibilidad de que el receptor del pago vincule una parte de su identidad a los UTXO utilizados como entrada;
- La capacidad de un observador externo para establecer conexiones entre todos los UTXO consumidos como entrada.

Para ilustrar el primer punto, pongamos un ejemplo concreto. Supongamos que compra una baguette con bitcoins a su panadero local. Utilizas uno o varios UTXO tuyos como entrada para cubrir al menos el precio de la baguette en salida, más los gastos de transacción. Su panadero podría entonces asociar su cara, o cualquier otra parte de su identidad que conozca, con las monedas utilizadas como entrada. Conociendo la existencia de este vínculo, es posible que prefieras elegir un UTXO concreto en lugar de otro a la hora de realizar el pago.

Por ejemplo, si uno de tus UTXO procede de una plataforma de intercambio y prefieres que el panadero no conozca tu cuenta en esta plataforma, evitarías utilizar este UTXO para el pago. Si tienes un UTXO de alto valor que revela una cantidad significativa de bitcoin, también podrías optar por no utilizarlo para evitar que el panadero conozca tu fortuna en BTC.

La elección de los UTXO a utilizar para este primer punto se basa, por tanto, en una decisión personal, influida por lo que estés dispuesto a revelar o no. Las etiquetas que hayas asignado a tus UTXO al recibirlos te ayudarán a seleccionar aquellos que, al gastarlos, muestren sólo la información que te sientas cómodo revelando al destinatario.

Además de la información potencialmente revelada al destinatario, tu elección de entradas también afecta a lo que revelas a todos los observadores de blockchain. De hecho, al utilizar varios UTXO como entradas en tu transacción, revelas que son propiedad de la misma entidad, según la Heurística de Propiedad Común de Entradas (CIOH).

Por lo tanto, cuando seleccione sus monedas, debe ser consciente de que la transacción que va a transmitir creará un vínculo entre todos los UTXO utilizados. Este vínculo puede ser problemático para su privacidad personal, especialmente si los UTXO proceden de diferentes fuentes.

Volviendo al ejemplo de mi UTXO sin KYC de Bisq, quiero evitar combinarlo con un UTXO de, por ejemplo, una plataforma de intercambio regulada que conozca mi identidad. De hecho, si alguna vez utilizara estos 2 UTXO como entradas en la misma transacción, la plataforma regulada podría vincular mi identidad con el UTXO que compré en Bisq, mientras que antes no estaba vinculado a mi identidad.

Por último, para elegir correctamente qué UTXOs consumir como entrada para una transacción, lo más importante es evitar el uso de múltiples UTXOs. Siempre que sea posible, seleccione una sola moneda que sea lo suficientemente grande como para cubrir su pago. De este modo, evitará por completo los riesgos asociados a COINJOIN. Sin embargo, si ningún UTXO individual es suficiente para su pago y necesita consumir varios, asegúrese de que proceden de fuentes similares para minimizar los riesgos de conexiones no deseadas. Además, tenga en cuenta que el receptor puede asociar la información que tiene sobre usted con el historial de las monedas utilizadas como entrada.

### Selección automática de monedas

En secciones anteriores, hemos hablado de la selección manual de UTXOs para una transacción. Pero, ¿qué ocurre cuando el software del monedero hace esta selección automáticamente? Existen varios métodos para determinar qué monedas consumir, y la selección de UTXOs es un verdadero campo de investigación en Bitcoin. El objetivo principal de este proceso automático suele ser minimizar las comisiones de transacción para el usuario.

Los métodos de selección UTXO como FIFO (_First In First Out_) y LIFO (_Last In First Out_) son de los más sencillos pero también de los menos eficientes. Con FIFO, se utilizan primero las monedas más antiguas de la cartera. Este enfoque suele ser ineficaz tanto para minimizar las comisiones por transacción como para preservar la privacidad, excepto en los casos en los que se utilizan calendarios relativos que deben renovarse periódicamente. Por el contrario, LIFO prioriza el uso de los UTXO más recientes. Aunque sencillos, estos dos métodos suelen resultar ineficaces.

Un método más avanzado es el _Knapsack Solver_. Este fue el método utilizado en el monedero Bitcoin Core hasta la versión 0.17. Consiste en seleccionar de forma iterativa y aleatoria UTXOs del monedero, sumarlos en subgrupos y quedarse con la solución que reduzca el peso de la transacción lo máximo posible para reducir las tasas de usuario.

El _Branch-and-Bound_ (BNB), a menudo apodado "algoritmo de Murch" en referencia a su inventor, sustituyó al _Knapsack Solver_ en Bitcoin Core a partir de la versión 0.17. Este método más avanzado pretende encontrar un conjunto de UTXOs que coincida exactamente con la cantidad necesaria para satisfacer las salidas de una transacción. El objetivo de BNB es minimizar la cantidad de remanente así como las tasas reduciendo lo que se denomina el criterio de desperdicio que tiene en cuenta tanto los costes inmediatos como los costes futuros esperados para el remanente. Este método deriva del concepto original _Branch-and-Bound_, diseñado en 1960 por Ailsa Land y Alison Harcourt, y ofrece una optimización de las comisiones más precisa que el _Knapsack Solver_.

Todos estos métodos de selección automática de UTXO pueden ser eficaces para reducir las tasas de transacción, pero suelen ser ineficaces para preservar la privacidad del usuario. De hecho, estos algoritmos pueden fusionar varios UTXOs en la entrada, revelando así una propiedad común de estos UTXOs debido a COH. Obviamente, estos métodos no pueden tener en cuenta las etiquetas adjuntas a los UTXOs, que son cruciales para elegir conscientemente qué monedas revelar al destinatario de la transacción. Actualmente, la única solución para optimizar la privacidad en la selección de monedas es hacerlo manualmente.

### Tutorial de etiquetado UTXO

Si desea saber cómo etiquetar sus UTXOs, hemos elaborado un completo tutorial sobre el principal software de monedero Bitcoin existente:

https://planb.network/tutorials/privacy/on-chain/utxo-labelling-d997f80f-8a96-45b5-8a4e-a3e1b7788c52
## CSC e identificación de claves

<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>

KYC significa "Know Your Customer" (Conozca a su cliente), que es un procedimiento reglamentario aplicado por algunas empresas que operan en el sector de Bitcoin. Este procedimiento pretende verificar y registrar la identidad de sus clientes con el objetivo declarado de combatir el blanqueo de capitales y la financiación del terrorismo.

Concretamente, KYC implica la recopilación de diversa información personal del cliente, que puede variar según la jurisdicción, pero que generalmente incluye un documento de identidad, una fotografía y una prueba de residencia. Esta información se verifica y almacena para su uso futuro.

Este procedimiento se ha convertido en obligatorio para todas las plataformas de intercambio reguladas en la mayoría de los países occidentales. Esto significa que cualquier persona que desee cambiar divisas fiduciarias por bitcoin a través de estas plataformas debe cumplir los requisitos KYC.

Este procedimiento no está exento de riesgos para la privacidad y seguridad de los usuarios. En este capítulo, examinaremos estos riesgos en detalle y analizaremos los impactos específicos de los procesos KYC y de identificación en la privacidad de los usuarios de Bitcoin.

### Facilitar el seguimiento en cadena

El primer riesgo asociado a KYC es que proporciona un punto de entrada preferente para el análisis de blockchain. Como vimos en la sección anterior, los analistas pueden agrupar y rastrear la actividad en la blockchain utilizando patrones de transacciones y heurística. Una vez que han conseguido agrupar la actividad onchain de un usuario, encontrar un único punto de entrada entre todas sus transacciones y claves es suficiente para comprometer completamente su privacidad.

![BTC204](assets/fr/078.webp)

Cuando te sometes a KYC, proporcionas un punto de entrada de muy alta calidad para el análisis de la cadena, ya que vinculas las direcciones receptoras utilizadas cuando retiras tus bitcoins de una plataforma de intercambio a tu identidad completa y verificada. En teoría, esta información sólo la conoce la empresa a la que se la has facilitado, pero, como veremos más adelante, el riesgo de pérdida de datos es real. Además, el mero hecho de que una empresa posea esta información puede ser problemático, aunque no la comparta.

Así, a menos que se tomen otras medidas para limitar la agrupación de las actividades de cada uno en la blockchain, cualquiera que conozca el punto de entrada que es KYC puede potencialmente vincular toda su actividad en Bitcoin a su identidad. Desde la perspectiva de esta empresa, el uso de Bitcoin pierde por tanto toda confidencialidad.

![BTC204](assets/fr/079.webp)

Para ilustrar esto con una comparación, es como si el banquero de uno en el _Banco X_ tuviera acceso no sólo a todas las transacciones realizadas con el _Banco X_, sino que también pudiera observar las transacciones con el _Banco Y_ y todas las transacciones en efectivo propias.

Recordemos la primera parte de esta formación: el modelo de privacidad de Bitcoin, tal y como fue diseñado por Satoshi Nakamoto, se basa en la separación entre la identidad del usuario y sus pares de claves. Aunque esta capa de privacidad ya no es suficiente hoy en día, sigue siendo prudente limitar su degradación tanto como sea posible.

### Exposición a la vigilancia estatal

El segundo gran problema de KYC es que revela al estado que uno ha poseído bitcoin en algún momento. Cuando se compran bitcoins a través de un actor regulado, es posible que el Estado conozca esta posesión. Actualmente, esto puede parecer trivial, pero es importante recordar que el futuro político y económico del país de uno no está en sus propias manos.

En primer lugar, el Estado puede adoptar rápidamente una postura autoritaria. La historia está llena de ejemplos en los que las políticas han cambiado bruscamente. Hoy, en Europa, los entusiastas de Bitcoin pueden escribir artículos sobre Bitcoin, asistir a conferencias y gestionar sus propios monederos. Pero, ¿quién puede decir lo que nos deparará el mañana? Si Bitcoin se convierte de repente en el enemigo público número uno, estar asociado a él en los registros estatales podría resultar problemático.

Más adelante, ante crisis económicas graves, el Estado podría plantearse confiscar los bitcoins en poder de los ciudadanos. Tal vez el día de mañana se considere que los bitcoiners se aprovechan de la crisis y sean gravados con impuestos excesivos por sus plusvalías ante la devaluación de la moneda fiduciaria.

Podrías pensar que esto no es un problema porque tus bitcoins se barajan y, por tanto, no se pueden rastrear. Sin embargo, la trazabilidad no es el problema aquí. El verdadero problema es que el Estado sepa que posees bitcoins. Este simple dato podría bastar para incriminarte o pedirte cuentas. Podrías intentar alegar que gastaste tus bitcoins, pero eso tendría que reflejarse en tu declaración de la renta, y te descubrirían. También podrías decir que perdiste las llaves en un accidente de barco, pero más allá de la broma de Twitter, ¿de verdad crees que eso bastaría para exculparte?

Por lo tanto, es importante tener en cuenta el riesgo asociado al simple hecho de que el Estado pueda saber que usted poseía BTC, aunque este riesgo pueda parecer lejano hoy en día.

Otra cuestión planteada por KYC en términos de supervisión estatal es la notificación obligatoria por parte de las plataformas reguladas. Aunque desconozco la normativa de otras jurisdicciones, en Francia, los _Proveedores de Servicios de Activos Digitales_ (PSAN) están obligados a informar a los supervisores financieros de cualquier movimiento de fondos que consideren sospechoso.

Así, en Francia, en 2023, los PSAN notificaron 1.449 actos sospechosos. Por ahora, la mayoría de estos actos están relacionados con la delincuencia. Sin embargo, las autoridades también están pidiendo a las plataformas reguladas que informen de cualquier transacción sospechosa de Bitcoin basándose únicamente en su estructura. Si realizas una transacción colaborativa, o incluso sólo una transacción que tiene un patrón algo atípico, y esta transacción ocurre cerca de la retirada de tus bitcoins de estas plataformas, puedes encontrarte denunciado a las autoridades. Incluso en ausencia de fechorías y en el ejercicio legítimo de sus derechos, esta denuncia podría dar lugar a un mayor escrutinio y vigilancia, inconvenientes que habría evitado sin KYC.

### Riesgo de pérdida de datos personales

Otro problema de KYC reside en el hecho de que requiere almacenar todos sus datos personales en los servidores de una empresa privada. Los últimos acontecimientos nos han recordado que nadie es inmune a los fallos, ya sean financieros o informáticos. En 2022, los clientes de Celsius sufrieron las consecuencias. A raíz de la quiebra de la empresa, la justicia estadounidense hizo públicos los nombres de los acreedores y el importe de sus activos durante un procedimiento administrativo.

Hace poco más de dos años, una entidad líder en ciberseguridad en el ámbito de las criptomonedas sufrió el robo de los datos personales de sus clientes. Aunque este incidente no estaba directamente relacionado con la compra de bitcoin, este riesgo también se mantiene para las plataformas de intercambio. Por lo tanto, existe un riesgo indudable asociado a estos datos personales.

Es cierto que ya confiamos gran parte de nuestros datos personales a empresas privadas. Sin embargo, en este caso el riesgo es doble, ya que estos datos no sólo permiten identificarte, sino que también están vinculados a la actividad en bitcoin. En efecto, cuando un pirata informático es capaz de acceder a los datos de los clientes de una plataforma de intercambio, puede suponer razonablemente que estos clientes poseen bitcoin. Este riesgo se ve así agravado por el hecho de que el bitcoin, como cualquier otro bien valioso, atrae el interés de los ladrones.

En caso de que se produzca una filtración de datos, en el mejor de los casos, podría ser objeto de intentos de suplantación de identidad. En el peor, podría encontrarse en el centro de amenazas físicas a su hogar.

Además de los riesgos específicos asociados a Bitcoin, también es necesario considerar los peligros asociados a la transmisión de documentos de identidad. En efecto, en caso de fuga de datos, es posible convertirse en víctima de una usurpación de identidad. Por tanto, lo que está en juego no se limita a la protección de la confidencialidad de las transacciones, sino que también afecta a la seguridad personal de cada individuo.

### Malentendidos comunes en relación con el CSC

Es importante disipar algunos conceptos erróneos comunes sobre KYC que se encuentran con frecuencia en Twitter o en nuestras discusiones entre bitcoiners.

En primer lugar, es erróneo pensar que proteger la privacidad de los bitcoins adquiridos a través de KYC (Know Your Customer) es inútil. Las herramientas y métodos para la privacidad en bitcoin son variados y sirven para diferentes propósitos. Utilizar las transacciones coinjoin en bitcoin de KYC, por ejemplo, no es una mala idea. Por supuesto, hay que ser prudente con las plataformas de intercambio reguladas para evitar que te congelen o bloqueen la cuenta, pero desde un punto de vista estrictamente técnico, estas prácticas no son incompatibles. Coinjoin tiene el efecto de interrumpir el historial de una moneda, lo que ayuda a contrarrestar algunos de los riesgos de análisis de la cadena asociados a KYC. Aunque no elimina todos los riesgos, ya es una ventaja significativa.

La privacidad en bitcoin no debe verse de forma binaria, como una distinción entre bitcoins "anónimos" y otros que no lo son. Poseer bitcoins adquiridos a través de KYC no significa que todo esté perdido; al contrario, el uso de herramientas de privacidad puede resultar aún más beneficioso.

Por el contrario, la adquisición de bitcoin a través de un método que no sea el CSC no garantiza una privacidad perfecta y no le exime de la necesidad de tomar otras medidas de protección. Si posees bitcoin no KYC pero reutilizas varias veces las direcciones de recepción, tus transacciones pueden ser rastreadas y agrupadas. La más mínima conexión con el mundo exterior a bitcoin podría comprometer la única capa de privacidad que tenías. Por lo tanto, es importante considerar todas las herramientas y métodos que mejoran la privacidad en Bitcoin como complementarios. Cada técnica aborda un riesgo específico y puede añadir una capa adicional de protección. Por lo tanto, poseer bitcoin no-KYC no le exime en absoluto de tomar otras precauciones.

### ¿Se puede anular el CSC?

A veces me preguntan si es posible "volver atrás" después de completar el KYC y, como puedes imaginar por los párrafos anteriores, la respuesta tiene matices. Para evitar los riesgos asociados al KYC, el método más sencillo es no utilizarlo al adquirir bitcoins. Profundizaremos en este tema en el próximo capítulo. Sin embargo, si ya se ha realizado el KYC y se han comprado bitcoins, ¿hay formas de mitigar los riesgos incurridos?

En cuanto al riesgo de rastrear sus transacciones, el uso de coinjoin es una solución. Hablaremos de este método en detalle más adelante en la formación, pero sepa que coinjoin puede interrumpir el historial de una moneda e impedir su trazabilidad pasado-presente y presente-pasado. Incluso para BTC obtenidos a través de una plataforma regulada, esta técnica puede impedir su trazabilidad.

Sin embargo, coinjoin no elimina el segundo riesgo asociado a KYC: el hecho de que el estado esté informado de tus tenencias de bitcoin. De hecho, aunque tus monedas ya no sean rastreables, el Estado, dependiendo de la jurisdicción, puede tener acceso a tus declaraciones de enajenación de criptoactivos. Dado que este riesgo no es técnico, sino administrativo, no existen soluciones específicas para bitcoin que lo eliminen, aparte de evitar inicialmente la exposición al KYC. El único enfoque legal para mitigar este riesgo es vender sus bitcoins adquiridos a través de plataformas reguladas en plataformas reguladas, y luego comprarlos de nuevo a través de medios sin KYC. Al vender y declarar la enajenación, la administración debería constatar que ya no son de su propiedad.

En cuanto al riesgo de que sus datos personales y documentos de identidad sean revelados, se trata de un peligro externo a Bitcoin, y no existe ninguna solución técnica para evitarlo. Una vez que sus datos han sido revelados, es difícil revertir esta situación. Puede intentar cerrar su cuenta en la plataforma, pero esto no garantiza la eliminación de sus datos KYC, especialmente cuando la verificación de identidad se externaliza. Verificar la eliminación completa de su información es imposible. Por lo tanto, no existe una solución para prevenir completamente este riesgo y garantizar que deje de existir.

### Diferencia entre CSC e identificación de claves

A veces, algunos bitcoiners tienden a extender el término "KYC" a cualquier intercambio de BTC que implique una transferencia o un pago con tarjeta de crédito, ya que estos medios también pueden revelar el origen del pago, al igual que lo haría KYC. Sin embargo, es importante no confundir KYC con identificación de claves. Personalmente, debo admitir que mi percepción de este tema ha evolucionado con el tiempo.

KYC se refiere específicamente a un procedimiento reglamentario aplicado por algunas empresas para verificar y registrar la identidad de sus clientes. Es una cuestión binaria: cuando adquieres tus bitcoins, o te sometes a KYC, o no. Sin embargo, la identificación clave, que consiste en vincular un aspecto de la identidad de un usuario a la actividad onchain, no es tan binaria, sino que representa más bien un continuo. De hecho, en el contexto de la compra o venta de bitcoins, esta identificación siempre es posible en diversos grados.

Por ejemplo, si compra bitcoin en una plataforma regulada en Suiza, no se exige el sistema KYC (Conozca a su cliente). Sin embargo, puede haber una identificación de sus claves ya que la compra se realizó a través de su cuenta bancaria. Aquí es donde surgen los dos primeros riesgos asociados al KYC -facilitar el rastreo onchain y la exposición a la vigilancia gubernamental-, que también pueden manifestarse en un intercambio sin KYC. Si la entidad suiza informa de transacciones sospechosas a las autoridades de su país, pueden simplemente comprobar la cuenta bancaria utilizada para la compra para descubrir su identidad. Por lo tanto, comprar sin KYC en plataformas reguladas es bastante alto en la escala de riesgo para la identificación de claves.

Sin embargo, evitar las plataformas reguladas y optar por métodos de adquisición P2P (Peer-to-Peer) no elimina por completo el riesgo de identificación de claves, sino que simplemente lo reduce. Consideremos el ejemplo de una compra en Bisq u otra plataforma P2P. Para liquidar con su contraparte, probablemente utilizará su cuenta bancaria. Si las autoridades interrogan a la persona con la que ha negociado y le piden su nombre, nos encontramos con los riesgos 1 y 2 mencionados anteriormente. Sin duda, estos riesgos son mucho menores que los de una compra sin KYC en una plataforma, e incluso menores que los de una compra con KYC, pero siguen estando presentes en menor medida.

Por último, aunque compres tus bitcoins a través de un intercambio físico de efectivo, no eres completamente anónimo. La persona con la que hiciste el negocio vio tu cara, que forma parte de tu identidad. Aunque mínima en este ejemplo, la posibilidad de una clave de identificación sigue existiendo.

En conclusión, durante un intercambio de bitcoin por otros activos, ya se trate de una compra de moneda fiduciaria o de una venta por un activo real, siempre hay una forma de identificación de claves. Dependiendo del método de intercambio elegido, esta identificación puede variar en intensidad. Es importante no confundir esta identificación con el KYC, que es un proceso reglamentario bien definido. Sin embargo, existe un vínculo entre el KYC y el espectro de identificación, ya que el KYC se sitúa en el extremo superior de este espectro, puesto que facilita sistemáticamente la identificación de las claves de usuario por parte de las autoridades.

## Métodos de venta y adquisición

<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>

Después de leer el capítulo anterior, puede que te estés preguntando cómo comprar o vender bitcoin sin tener que someterte a un proceso de verificación de identidad para evitar los riesgos asociados al KYC. Existen varios métodos para realizar intercambios.

### Intercambios P2P en efectivo

Como hemos visto, el mejor método en términos de privacidad sigue siendo el intercambio P2P (peer-to-peer) con liquidación en efectivo. Este método permite minimizar los rastros dejados y reduce significativamente la posibilidad de identificación de claves, tanto si eres comprador como vendedor.

Sin embargo, esta práctica conlleva riesgos de seguridad personal. El principal peligro reside en que, durante el intercambio, la contraparte sabrá que usted posee una cantidad importante, ya sea en efectivo o en bitcoin. Esta información puede atraer la atención de individuos malintencionados. De hecho, generalmente se aconseja mantener la discreción sobre la posesión de bitcoin. Este consejo también podría aplicarse al dinero en efectivo. Sin embargo, durante un intercambio en persona, es inevitable revelar que se posee bitcoin, lo que puede despertar la codicia.

Para limitar este riesgo, le recomiendo que dé prioridad a las transacciones en efectivo con personas de confianza, como familiares o amigos íntimos. Alternativamente, también puede considerar realizar intercambios en [reuniones locales de Bitcoin](https://btcmap.org/communities/map), después de asistir varias veces. Esto le permitirá conocer mejor a los demás participantes y no estar solo durante el intercambio físico. Sin embargo, es importante reconocer que el intercambio de efectivo P2P conlleva intrínsecamente riesgos para su seguridad personal que no existen cuando realiza compras a través de una plataforma regulada y su cuenta bancaria.

Además, dependiendo de dónde vivas, transportar y almacenar grandes sumas de dinero puede plantear riesgos, ya sea bitcoin o efectivo.

Intercambiar dinero en efectivo también puede plantear riesgos legales durante los controles policiales o de otro tipo. Aunque en la mayoría de los países no hay restricciones sobre la cantidad de efectivo que se puede llevar, las sumas excesivamente grandes pueden levantar sospechas. Por tanto, sea prudente, sobre todo si tiene que recorrer largas distancias, y evite transacciones demasiado grandes de una sola vez para no tener que justificar la posesión de sumas importantes.

Por último, otra desventaja de las compras P2P es que el precio suele ser más alto que el observado en las plataformas reguladas. Los vendedores suelen imponer un recargo que oscila entre el 1% y a veces supera el 10%. Varias razones explican esta diferencia de precios. En primer lugar, es una práctica común entre los vendedores P2P que se ha establecido con el tiempo. Además, los vendedores tienen comisiones de transacción asociadas al envío de fondos al comprador. También existe un mayor riesgo de robo en las ventas P2P que en las transacciones de plataforma, lo que justifica una comisión por el riesgo asumido. Por último, la prima puede ser relativa a la demanda y a la calidad del intercambio en términos de privacidad. Como comprador, la ganancia en privacidad está tasada en el recargo que cobra el vendedor. Algunos bitcoiners también creen que el aumento del precio de los BTC comprados en P2P refleja su verdadero valor y argumentan que los precios más bajos de las plataformas reguladas son el resultado de una compensación por la privacidad de su información personal.

### Intercambios P2P a través de una plataforma de emparejamiento

Una alternativa menos arriesgada en términos de seguridad personal es realizar intercambios P2P exclusivamente en línea, a través de métodos de pago electrónico como PayPal, transferencias bancarias o Revolut.

Este enfoque ayuda a evitar muchos riesgos asociados a las transacciones en efectivo. Sin embargo, el riesgo de que la contraparte no cumpla sus compromisos durante un intercambio en línea es mayor. De hecho, durante un intercambio físico, si entregas dinero al vendedor que no te envía bitcoins a cambio, puedes reclamárselo inmediatamente ya que está delante de ti. En cambio, en Internet a menudo es imposible encontrar a una persona que te ha robado.

Para mitigar este riesgo, se pueden utilizar plataformas especializadas de emparejamiento para los intercambios P2P. Estas plataformas utilizan mecanismos de resolución de conflictos para proteger a los usuarios perjudicados. Por lo general, ofrecen un sistema de custodia, en el que los bitcoins se mantienen hasta que el vendedor confirma el pago en moneda fiduciaria.

En términos de seguridad personal, este método de compra es significativamente más seguro que los intercambios físicos de efectivo. Sin embargo, como se ha mencionado anteriormente, los intercambios P2P en línea dejan más rastros que un intercambio físico, lo que puede ir en detrimento de la privacidad en Bitcoin. Al utilizar un método de pago fiat online como un banco, usted expone más información que podría facilitar la identificación de claves.

Una vez más, recomiendo no realizar grandes operaciones en una sola transacción en estas plataformas. Al dividir las transacciones, se distribuyen los riesgos asociados a posibles robos por parte de la contraparte.

Otra desventaja de las compras P2P es que el precio suele ser más alto que el observado en las plataformas reguladas. Los vendedores suelen imponer un recargo que oscila entre el 1% y a veces supera el 10%. Varias razones explican esta diferencia de precios. En primer lugar, es una práctica común entre los vendedores P2P que se ha establecido con el tiempo. Además, los vendedores tienen comisiones de transacción asociadas al envío de fondos al comprador. También existe un mayor riesgo de robo en las ventas P2P que en las transacciones de plataforma, lo que justifica una comisión por el riesgo asumido. Por último, la prima puede ser relativa a la demanda y a la calidad del intercambio en términos de privacidad. Como comprador, la ganancia en privacidad está tasada en el recargo que cobra el vendedor. Algunos bitcoiners también creen que el precio más alto de los BTC comprados a través de P2P refleja su verdadero valor y argumentan que los precios más bajos de las plataformas reguladas son el resultado de una compensación por la privacidad de su información personal.

En cuanto a las soluciones, personalmente siempre he utilizado [Bisq](https://bisq.network/) y estoy muy satisfecho con ellos. Su sistema está bien establecido y parece fiable. Sin embargo, Bisq sólo está disponible en PC y su interfaz puede resultar demasiado compleja para los principiantes. Otra desventaja es que Bisq opera exclusivamente con transacciones onchain, lo que puede resultar caro durante los periodos de altas tasas de transacción en Bitcoin.

-> Conozca nuestro tutorial sobre Bisq.

https://planb.network/tutorials/exchange/peer-to-peer/bisq-fe244bfa-dcc4-4522-8ec7-92223373ed04
Para una opción más sencilla, puedes probar [Peach](https://peachbitcoin.com/), una aplicación móvil que facilita la conexión entre compradores y vendedores con un sistema integrado de resolución de disputas. El proceso es más intuitivo que el de Bisq.

-> Conoce nuestro tutorial sobre Peach.

Otra opción en línea es [HodlHodl](https://hodlhodl.com/), una plataforma bien establecida que ofrece buena liquidez, aunque personalmente no la he probado.

-> Conoce nuestro tutorial sobre HodlHodl.

https://planb.network/tutorials/exchange/peer-to-peer/peach-wallet-db64fe42-17ca-4b24-abb8-e7d4c03b2028
https://planb.network/tutorials/exchange/peer-to-peer/hodlhodl-d7344cd5-6b18-40f5-8e78-2574a93a3879
Para soluciones basadas en Lightning Network, puedes probar [RoboSats](https://learn.robosats.com/) y [LNP2PBot](https://lnp2pbot.com/). RoboSats es accesible a través de un sitio web y su uso es relativamente sencillo. LNP2PBot es más atípico, ya que funciona a través de un sistema de intercambio en la aplicación de mensajería Telegram.

-> Consulta nuestro tutorial sobre RoboSats.

-> Consulta nuestro tutorial sobre LNP2PBot.

https://planb.network/tutorials/exchange/peer-to-peer/robosats-b60e4f7c-533a-4295-9f6d-5368152e8c06
https://planb.network/tutorials/exchange/peer-to-peer/lnp2pbot-v2-e6bcb210-610b-487d-970c-7cce85273e3c
### Plataformas reguladas sin CSC

Dependiendo del país en el que vivas, puedes tener acceso a plataformas reguladas que no requieren un procedimiento KYC para comprar o vender bitcoin. En Suiza, por ejemplo, puedes utilizar plataformas como [Relai](https://relai.app/) y [MtPelerin](https://www.mtpelerin.com/).

-> Conozca nuestro tutorial sobre Relai.

Como vimos en el capítulo anterior, este tipo de plataformas le ahorran los riesgos asociados a los procedimientos KYC, pero presentan un mayor nivel de riesgo para la identificación de claves. Por tanto, en términos de privacidad en Bitcoin, estas plataformas ofrecen mejor protección que los métodos de compra KYC, pero son menos atractivas que los intercambios P2P.

Sin embargo, en términos de seguridad personal, el uso de estas plataformas es mucho menos arriesgado que los intercambios P2P. También suelen ser más fáciles de usar que las plataformas que facilitan los intercambios P2P.

https://planb.network/tutorials/exchange/centralized/relai-v2-30a9671d-e407-459d-9203-4c3eae15b30e
### ATM

Otra opción para comprar o vender bitcoin sin KYC son los cajeros automáticos de criptomonedas (ATM). Personalmente, nunca he tenido la oportunidad de probar esta solución, ya que no hay ninguno en mi país. Pero este método puede ser muy interesante dependiendo de donde vivas.

El problema de los cajeros automáticos es que están prohibidos en algunos países o fuertemente regulados en otros. Si un cajero automático requiere un proceso de verificación de la identidad, entonces se enfrenta a los mismos riesgos que los inherentes a las plataformas de CSC reguladas. Sin embargo, si el cajero automático permite transacciones sin verificación de identidad para pequeñas cantidades, entonces su uso puede ofrecer un nivel de privacidad comparable al de un intercambio P2P basado en efectivo, evitando la mayoría de los riesgos asociados a este tipo de intercambio.

La principal desventaja de los cajeros automáticos radica en sus comisiones por cambio de divisas, a menudo elevadas, que oscilan entre unos pocos puntos porcentuales y a veces hasta el 15% de la cantidad cambiada.

### Tarjetas regalo

Por último, también quería presentar una solución que funciona bien para quienes desean utilizar sus bitcoins a diario para realizar compras en lugar de venderlos por monedas fiduciarias.

La mejor forma de gastar BTC es, obviamente, utilizar bitcoin directamente o la Lightning Network para comprar bienes o servicios. Sin embargo, en muchos países, el número de comercios que aceptan bitcoin sigue siendo limitado. Por ello, una alternativa práctica es el uso de tarjetas regalo.

Varias plataformas que no exigen un procedimiento KYC ofrecen la posibilidad de canjear bitcoin por tarjetas regalo que pueden utilizarse en las principales tiendas. Entre estas plataformas se encuentran [CoinsBee](https://www.coinsbee.com/), [The Bitcoin Company](https://thebitcoincompany.com/) y [Bitrefill](https://www.bitrefill.com/). Estas plataformas facilitan enormemente el uso diario de sus bitcoins al permitirle acceder a una amplia gama de productos y servicios sin tener que pasar por una conversión de moneda fiduciaria.

https://planb.network/tutorials/exchange/centralized/bitrefill-8c588412-1bfc-465b-9bca-e647a647fbc1
### Otros métodos de adquisición

Entre otros métodos de adquirir bitcoin protegiendo tu privacidad está, por supuesto, la minería. Para empezar a minar sats, no necesita revelar su identidad; basta con encontrar una prueba válida de empleo y enviarla a la red. Si opta por la minería en pool, algunos pools exigen una forma de identificación, como el KYC, mientras que otros no.

Otro método consiste en trabajar a cambio de bitcoin. Este método de adquisición puede resultar atractivo, pero el grado de identificación exigido varía mucho según las circunstancias.

\Para escribir este capítulo, he utilizado el curso BTC205 creado por [@pivi\_\_](https://x.com/pivi___) en la Red Plan ₿ (disponible sólo en francés por el momento).\_

## Consolidación, UTXO y Gestión CIOH

<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>

Uno de los aspectos más complicados de gestionar cuando tienes tu propia cartera de autoalmacenamiento es, sin duda, la consolidación. ¿Debe consolidar? ¿Cuál es el objetivo? ¿Qué tamaño de UTXO debes tratar de alcanzar? ¿Cuáles son las ventajas y desventajas para la privacidad? Eso es lo que intentaremos explorar en esta sección.

### ¿Qué es la consolidación?

El funcionamiento de Bitcoin es similar al de un mercado de subastas en el que las transacciones que ofrecen las mejores comisiones son favorecidas por los mineros. Sin embargo, cada bloque tiene un peso máximo, lo que limita el número de transacciones que pueden incluirse. Dado que se produce un bloque cada 10 minutos de media, el espacio disponible en cada bloque es un recurso escaso.

Los mineros, cuya actividad implica importantes costes de electricidad, capital y mantenimiento, buscan naturalmente maximizar su rentabilidad. Tienden a favorecer las transacciones que les ofrecen las comisiones más elevadas en relación con su peso.

De hecho, no todas las transacciones de Bitcoin pesan lo mismo. Las que tienen más entrada y salida pesarán más. Por ejemplo, considere 2 transacciones:


- La transacción A incluye 1 entrada y 1 salida. Asigna 1.994 sats de tasas y su peso es de 141 vB;
- La operación B, más compleja, con 2 entradas y 2 salidas, asigna 2.640 sats de comisiones para un peso de 220 vB.

En el ejemplo, aunque la transacción B propone una comisión total superior, los mineros favorecerán la transacción A porque ofrece una mejor relación comisión/peso. He aquí el cálculo para cada transacción, expresado en sats por byte virtual (sat/vB):

```text
TXA: 1994 / 141 = 14 sat/vB
TXB: 2640 / 220 = 12 sat / vB
```

Esto significa que, por cada unidad de peso, la transacción A ofrece más comisiones que la transacción B, aunque esta última ofrezca más comisiones en valor absoluto.

Por ello, cada vez resulta más atractivo para el usuario consumir la mínima cantidad posible de insumos en sus transacciones. Sin embargo, es necesario consumir cantidades suficientes para satisfacer el pago de salida. Por tanto, a la hora de gestionar la propia cartera, es necesario disponer de UTXO suficientemente grandes.

El principio de la consolidación es precisamente aprovechar los periodos en los que las comisiones de Bitcoin son bajas para fusionar los pequeños UTXOs de uno en un UTXO más grande. Así, cuando las tasas en Bitcoin suben, uno puede realizar transacciones con una entrada mínima, y así gastar menos en tasas absolutas. El objetivo es planificar las transacciones obligatorias a realizar durante los periodos de altas comisiones.

Además de ahorrar en tasas de transacción, consolidar UTXOs ayuda a evitar la creación de "polvo" El polvo se refiere a UTXOs cuyo valor en sats es tan bajo que no es suficiente para cubrir las tasas de transacción necesarias para gastarlos. Esto hace que el uso de estos UTXOs sea económicamente irracional mientras las tasas de transacción sigan siendo altas. Agrupando de forma proactiva tus UTXOs, evitas que se conviertan en polvo, asegurando que todos tus fondos sigan siendo utilizables.

### ¿Cuál es el tamaño mínimo de sus UTXO?

A veces me preguntan cuál es el valor mínimo recomendado para un UTXO. Por desgracia, no existe una respuesta universal, ya que depende de sus preferencias y de las condiciones del mercado para las comisiones. Sin embargo, aquí tienes una fórmula que puede ayudarte a determinar un umbral que se adapte a tus necesidades:

$$
\frac {P \times F}T = M
$$

Dónde:


- $P$ es el peso de la transacción;
- $F$ representa la tasa máxima en satoshi por vbyte (sats/vB) que está dispuesto a cubrir;
- $T$ es el porcentaje de la comisión de transacción que está dispuesto a pagar en relación con el valor total del UTXO;
- $M$ es la cantidad mínima en satoshi para cada UTXO.

Suponiendo que quieras cubrir las comisiones de una transacción SegWit estándar con 1 entrada y 2 salidas, con un peso de 141 vB. Si cubres hasta 800 sats/vB, y estás dispuesto a gastar hasta un 12% del valor UTXO en comisiones como máximo, entonces el cálculo sería:

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

En este ejemplo, sería prudente mantener un valor mínimo de 940.000 sat para UTXOs en su cartera.

### Consolidación y el COIH

Una de las heurísticas más utilizadas en el análisis de blockchain es la COIH (_Common Input Ownership Heuristic_), que permite suponer que todas las entradas de una transacción Bitcoin pertenecen a la misma entidad. Precisamente, el principio de la consolidación consiste en consumir varios UTXO como entrada y crear un único UTXO como salida. Por lo tanto, la consolidación permite la aplicación de COIH.

![BTC204](assets/fr/097.webp)

En la práctica, esto significa que un observador externo puede deducir que todos los UTXO consolidados pertenecen probablemente a la misma persona y que la única salida generada también le pertenece. Esta situación puede comprometer su privacidad al vincular diferentes historiales de transacciones. Por ejemplo, digamos que consolido 3 UTXOs adquiridos en P2P con un UTXO obtenido a través de una plataforma que requiere KYC:

![BTC204](assets/fr/098.webp)

Al hacerlo, cualquier entidad con acceso a los datos de la plataforma de intercambio, incluidas potencialmente las agencias gubernamentales, puede identificar que poseo otras cantidades en BTC. Anteriormente, estos UTXOs no estaban directamente vinculados a mi identidad; ahora sí lo están. Además, esto revela a todas las fuentes que estoy en posesión de una determinada cantidad de bitcoin.

En la gestión de los UTXO, las consideraciones económicas, que empujan a la consolidación para reducir las tasas, entran así en conflicto con las buenas prácticas en materia de privacidad, que recomendarían no fusionar nunca los UTXO. Así pues, la elección entre economía y privacidad depende de las prioridades de cada usuario.

Si puede evitar la consolidación manteniendo tamaños sustanciales de UTXOs, eso es lo ideal. Para ello, optimiza tus métodos de adquisición. Si compras tus bitcoins en DCA, intenta espaciar tus compras únicas lo máximo posible para agrupar el valor en menos UTXOs. Será más fácil gestionar una compra única de 1.000 euros cada 2 meses que una compra de 120 euros cada semana. Esto minimiza el número de UTXOs generados y simplifica la gestión de su cartera al tiempo que preserva su privacidad.

Si te ves en la necesidad de consolidar tus bitcoins, prioriza la consolidación de UTXOs de la misma fuente. Por ejemplo, fusionar 10 UTXOs de una única plataforma tendrá menos impacto en tu privacidad que mezclar 5 UTXOs de la plataforma A con 5 UTXOs de la plataforma B. Si la consolidación de varias fuentes es inevitable, intenta separarlas según sus características. Por ejemplo, agrupa los UTXOs adquiridos a través de KYC en una transacción, y los obtenidos en P2P en otra.

En cualquier caso, recuerde que toda consolidación conlleva inevitablemente una pérdida de privacidad. Por lo tanto, evalúe cuidadosamente la necesidad de hacerlo y las posibles repercusiones en su privacidad, teniendo en cuenta el riesgo.

## Otras buenas prácticas

<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>

Exploremos juntos otras buenas prácticas que pueden ayudarle a optimizar su privacidad en Bitcoin.

### El nudo completo

Tener tus bitcoins en custodia personal está bien, ¡pero usar tu propio nodo completo es mejor! Por eso, tener tu propio nodo es crucial para un uso plenamente soberano de bitcoin:


- Resistencia a la censura**: Tus transacciones no pueden ser bloqueadas por nadie;
- Independencia de terceros**: Ya no dependes de ningún servicio externo para verificar los datos de blockchain;
- Participación activa**: Tienes la posibilidad de establecer tus propias reglas de validación y participar directamente en el consenso;
- Contribución a la Red**: Al gestionar un nodo, ayudas a fortalecer y distribuir la red Bitcoin;
- Formación técnica**: Ejecutar un nodo completo es una gran manera de profundizar en sus conocimientos técnicos sobre Bitcoin.

Además de estas ventajas, el uso de un nodo completo también mejora su privacidad cuando transmite sus transacciones. Cuando emite una transacción, primero se crea y firma a través de su monedero. Para transmitirla en la red Bitcoin, debe ser conocida por al menos un nodo. Al utilizar su propio nodo, usted controla directamente esta transmisión, mejorando así su privacidad y limitando el riesgo de pérdida de datos.

![BTC204](assets/fr/099.webp)

Si no dispone de su propio nodo Bitcoin, se verá obligado a utilizar el de un tercero, como el que le ofrece su proveedor de software de monedero. Además de la transmisión de transacciones, su monedero necesita acceder a diversa información como las transacciones pendientes, los saldos asociados a sus direcciones o el número de confirmaciones de sus transacciones. Para acceder a todos estos datos, necesita consultar un nodo.

![BTC204](assets/fr/100.webp)

El principal riesgo cuando no utiliza su nodo Bitcoin es que el operador del nodo tercero pueda observar sus actividades en la blockchain, o incluso compartir esta información con otras entidades. Para limitar este riesgo, una solución intermedia es utilizar un software de monedero que le permita enmascarar sus conexiones a través de Tor. Esto puede reducir la exposición de sus datos. Sin embargo, la solución óptima sigue siendo tener su propio nodo Bitcoin y utilizarlo para transmitir sus transacciones. Por supuesto, también tendrá que asegurarse de que no se filtra información fuera de su nodo, pero ese es otro tema que exploraremos en las siguientes secciones.

Además del beneficio obvio para su privacidad, tener su propio nodo completo también garantiza la veracidad de los datos en la blockchain, protege contra la censura y le permite participar activamente en la gobernanza de Bitcoin. Al usar tu propio nodo, contribuyes con tu peso económico a la blockchain de tu elección, lo cual es importante durante los conflictos dentro de la comunidad, como durante la Guerra del Tamaño de Bloque de 2015 a 2017, por ejemplo. En caso de bifurcación, utilizar el nodo de un tercero podría llevarte a apoyar una cadena que no deseas favorecer, ya que el operador del nodo elige por ti. Como puedes entender, desde una perspectiva de privacidad y soberanía individual más general, ¡es esencial ejecutar y utilizar tu propio nodo completo!

### Heurística de análisis engañoso

En términos más generales, es importante comprender la heurística de la que hemos hablado en la sección anterior para evitarla o engañarla mejor. Adoptar una serie de buenas prácticas puede resultar beneficioso, aunque no sean esenciales. Ofrecen una capa adicional de protección que puede ser importante para mantener una buena privacidad cuando se usa Bitcoin.

El primer consejo que podría dar es mezclarse entre la multitud más densa. En Bitcoin, esto significa utilizar las plantillas de scripts más ampliamente adoptadas. Por ejemplo, los scripts P2WSH, a menudo utilizados para configuraciones multisig SegWit V0, son muy raros. No permiten esconderse en un gran conjunto de anonimato. Lo mismo ocurre con modelos más antiguos como P2PKH o P2SH. Aunque están muy presentes en el conjunto UTXO, cada vez se utilizan menos para nuevas transacciones.

En general, es más seguro avanzar hacia el último estándar de script, siempre y cuando esté suficientemente adoptado. Así, mientras que en 2022 hubiera desaconsejado el uso de P2TR (Taproot) por su escasa adopción, en 2024 recomendaría optar por este tipo de script o, en su defecto, por el script SegWit V0, ya que el número de transacciones que utilizan P2TR empieza a representar una parte muy significativa.

Fuente:[txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)

Otro consejo para preservar su privacidad es intentar eludir la heurística interna de las transacciones. Por ejemplo, cuando realizas un pago, podrías intentar evitar crear una salida con una cantidad redonda, ya que esto podría señalar que la otra salida representa cambio. Si tienes que enviar 100k satoshi a un amigo, considera transferir una cantidad ligeramente superior para escapar de esta heurística. Del mismo modo, intenta no crear salidas de resto que sean desproporcionadamente altas en comparación con el pago realizado, ya que esto también podría revelar cuál de las salidas representa el resto.

Por último, si realiza transacciones Bitcoin con regularidad, asegúrese de no transmitirlas siempre a las mismas horas. Al distribuir la transmisión de sus transacciones a lo largo del día y de la semana, evita dar a observadores externos la posibilidad de detectar un patrón horario basado en zonas horarias que podría mejorar su análisis.

Además de todas estas buenas prácticas a adoptar en el día a día, existen métodos aún más efectivos para romper por completo la trazabilidad de tus bitcoins. Entre ellos se encuentran, por supuesto, las transacciones coinjoin, que estudiaremos en profundidad en la siguiente sección.

# Transacciones Coinjoin

<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## ¿Qué es una transacción Coinjoin?

<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>

Una vez estudiados los fundamentos de la protección de la privacidad, ahora hablaremos de técnicas más sofisticadas destinadas a defender activamente tu privacidad, en particular disociando tu historial de bitcoins. En la siguiente parte, exploraremos muchas pequeñas técnicas, pero antes quiero hablarte de coinjoin.

Coinjoin se considera a menudo la forma más eficaz de proteger la privacidad de los usuarios de Bitcoin. Pero, ¿qué es exactamente una transacción coinjoin? Averigüémoslo juntos.

### Principios básicos de Coinjoin

Coinjoin es una técnica que altera el seguimiento de bitcoins en la blockchain. Se basa en una transacción colaborativa con una estructura específica del mismo nombre: la transacción coinjoin.

Como vimos en las primeras partes de esta formación, las transacciones en Bitcoin son conocidas por todos los usuarios a través de su nodo. Por lo tanto, es fácil verificar la cadena de firma electrónica de cada moneda y observar su historial. Esto significa que todos los usuarios pueden intentar analizar las transacciones de otros usuarios. Como resultado, el anonimato a nivel de transacción es imposible. Sin embargo, el anonimato se mantiene a nivel de identificación individual. A diferencia de la banca tradicional, en la que cada cuenta está vinculada a una identidad personal, en Bitcoin los fondos están asociados a pares de claves criptográficas (o scripts), ofreciendo así a los usuarios una forma de seudonimato tras los identificadores criptográficos.

![BTC204](assets/it/51/01.webp)

Así, la confidencialidad de bitcoin se ve comprometida cuando observadores externos pueden asociar UTXOs específicos con usuarios identificados. Una vez establecida esta asociación, resulta posible rastrear sus transacciones y analizar su historial de bitcoins. Coinjoin es precisamente una técnica desarrollada para interrumpir el rastreo de UTXOs con el fin de proporcionar cierto nivel de confidencialidad a los usuarios de Bitcoin a nivel de transacción.

Los Coinjoins mejoran la confidencialidad de los usuarios de Bitcoin al complicar el análisis de la cadena para observadores externos. Su estructura permite fusionar varias monedas de distintos usuarios en una única transacción, lo que ofusca los rastros y dificulta la determinación de los vínculos entre las direcciones de entrada y salida.

Es importante entender que el objetivo de una transacción coinjoin es interrumpir el historial de una moneda. Esta técnica no confiere un anonimato permanente ni detiene permanentemente la trazabilidad de los bitcoins, contrariamente a lo que podría pensarse. Coinjoin sólo pretende interrumpir la historia en el momento en que se realiza la transacción coinjoin. Sin embargo, antes y después de esta transacción, la moneda sigue estando sujeta a los mismos riesgos de privacidad.

![BTC204](assets/fr/104.webp)

### ¿Cómo funcionan las uniones conjuntas?

El principio de coinjoin se basa en un enfoque colaborativo: varios usuarios que desean mezclar sus bitcoins depositan cantidades idénticas en las entradas de la misma transacción. A continuación, estas cantidades se redistribuyen en salidas de igual valor para cada usuario.

![BTC204](assets/fr/105.webp)

Al final de la transacción, resulta imposible asociar una salida específica con una entrada de usuario conocida. No existe un vínculo directo entre entradas y salidas, lo que rompe la asociación entre los usuarios y sus UTXO, así como el historial de cada moneda.

![BTC204](assets/fr/106.webp)

Tomemos el ejemplo de Alicia. Quiere enviar unos 100.000 satoshi (sats) a su hermana Eve por su cumpleaños. Sin embargo, Alice no quiere que Eve pueda rastrear su historial de transacciones porque no quiere revelar cuántos bitcoins posee o cómo los obtuvo. Para ello, Alice decide interrumpir su historial de UTXO con una transacción coinjoin. Se pone de acuerdo con Bob, Charles, David y Frank para llevar a cabo una transacción colaborativa: Alice, Bob, Charles, David y Frank se comprometen cada uno a un UTXO de 105.000 sats (con 5.000 sats para tasas de minería) como entrada para la transacción:

![BTC204](assets/fr/107.webp)


- A cambio de utilizar estas entradas, cada uno genera una nueva dirección para crear cinco salidas idénticas de 100.000 sats cada una. Cada participante recupera una salida:

![BTC204](assets/fr/108.webp)


- Alice termina con un UTXO de 100.000 sats cuyo historial está mezclado. Utiliza este UTXO en una nueva transacción para enviar la cantidad a Eve por su cumpleaños:

![BTC204](assets/fr/109.webp)


- Si Eve intenta analizar esta transacción para extraer información, se encontrará con la transacción coinjoin en la que participan Alice, Bob, Charles, David y Frank. Como Eve no puede distinguir a quién pertenece cada entrada debido a la uniformidad de las cantidades, no puede rastrear la historia del UTXO de Alice ni determinar cuántos bitcoins posee su hermana ni cómo los adquirió:

![BTC204](assets/fr/110.webp)

En este escenario, Alice utilizó la técnica coinjoin para aumentar su privacidad contra el análisis hacia atrás. De hecho, Alice se protege contra un posible análisis por parte de Eve que partiría de una transacción específica para rastrear la historia del UTXO hacia atrás. Esta protección contra el análisis desde el presente hacia el pasado es lo que llamamos anonset retrospectivo. Exploraremos este concepto con más detalle en los últimos capítulos de esta parte.

Sin embargo, coinjoin también ofrece la posibilidad de mejorar la privacidad frente al análisis pasado-presente, lo que se denomina anonset prospectivo. Volvamos a nuestro ejemplo en el que Alicia envió 98.000 sats a Eva el día de su cumpleaños, pero invirtiendo los papeles. Imaginemos ahora que es Eva quien está preocupada por su privacidad. De hecho, Alice podría tener la tentación de seguir la moneda que envió a Eve para recabar información. Eve podría consolidar este UTXO recién recibido con todos sus otros UTXO, lo que podría revelar a Alice la cantidad de bitcoin que tiene en su cartera. Para evitar esto, Eve también puede interrumpir el historial de la moneda recién recibida.


- Eve, Grace, Mallory, Oscar y Victor ponen cada uno un UTXO de 98.000 sats como entrada en una transacción Bitcoin:

![BTC204](assets/fr/111.webp)


- A cambio de utilizar estas entradas, cada uno proporciona una nueva dirección para crear 5 salidas de 97.500 sats cada una, perfectamente iguales. Cada usuario recupera una salida:

![BTC204](assets/fr/112.webp)


- Eve tiene ahora un UTXO de 97.500 sats con un historial roto. Ella puede usarlo sin miedo para futuras transacciones. De hecho, si Alice intenta seguir los bitcoins que envió a Eve, se encontrará con una transacción coinjoin. No podrá determinar a qué salida UTXO pertenece Eve. El análisis se hace entonces imposible:

![BTC204](assets/fr/113.webp)

En el primer ejemplo, vimos cómo coinjoin puede proteger la privacidad de una moneda en relación con su pasado, y en el segundo ejemplo, cómo también puede asegurar la historia de una moneda en relación con su futuro. Por eso he mencionado que coinjoin debe considerarse como un evento único que segmenta la historia de una moneda en ambas direcciones:

![BTC204](assets/fr/104.webp)

### Mezclas, coinjoins, mixers... ¿Cuál es la diferencia?

El término "mezcla" se utiliza a veces para describir los coinjoins, un término que algunos bitcoiners rechazan porque temen confundirlo con los mezcladores de custodia. Sin embargo, creo que esta aprensión es infundada porque, en un contexto matemático, coinjoin encarna precisamente el concepto de mezcla.

En el campo general de las matemáticas, la mezcla se refiere a la propiedad de un sistema dinámico en el que, al cabo de cierto tiempo, todas las porciones del espacio inicial pueden teóricamente mezclarse con cualquier otra porción. La mezcla implica que la posición de una partícula o el estado de un sistema evoluciona de tal manera que su distribución futura es independiente de su distribución inicial, alcanzando así un estado en el que las características del estado inicial se distribuyen uniformemente en el espacio del sistema. Esto es exactamente lo que ocurre en una coinjoin con bitcoins. Así que, en mi opinión, coinjoin es realmente un método de mezcla de monedas.

![BTC204](assets/fr/114.webp)

Sin embargo, es importante distinguir los coinjoins de los mezcladores. Un mezclador es un servicio en el que los usuarios envían sus bitcoins para que sean mezclados. Estos servicios fueron populares durante la década de 2010, pero su uso ha disminuido debido a dos grandes desventajas en comparación con los coinjoin:


- Exigen a los usuarios que renuncien a la custodia de sus fondos durante el proceso de mezcla, exponiéndolos al riesgo de robo;
- No hay garantía de que el mezclador no registre los detalles de las transacciones, o incluso venda esta información a empresas de análisis de blockchain.

![BTC204](assets/fr/115.webp)

Por ello, hoy en día los usuarios prefieren coinjoin, ya que les permite mantener un control total sobre sus fondos durante todo el proceso. Los participantes en un coinjoin no corren el riesgo de que sus bitcoins sean robados por otras partes implicadas. Exploremos juntos cómo es esto posible en el próximo capítulo.

## Coincidencias entre Zerolink y Chaumian

<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>

La privacidad que proporciona un coinjoin se basa en el tamaño del grupo en el que se oculta nuestra pieza. Por lo tanto, es necesario encontrar el mayor número posible de participantes. Es totalmente posible ejecutar un coinjoin manualmente, con usuarios encontrados de forma independiente, pero este método es complejo y no permite anonsets grandes.

Esta es la razón por la que se han desarrollado coordinadores de coinjoin en Bitcoin. Su función es conectar a diferentes usuarios y transmitir la información necesaria para que la transacción colaborativa se complete con éxito.

![BTC204](assets/fr/116.webp)

Pero, ¿cómo garantizar que el coordinador nunca tenga control sobre los bitcoins de los usuarios, y aunque sea la persona que construye la transacción coinjoin, cómo garantizar que no pueda vincular las entradas y salidas de los usuarios, lo que podría suponer una pérdida de privacidad?

### Firmas ciegas de Chaum

Las implementaciones modernas de coinjoin utilizan las firmas ciegas de David Chaum para evitar la fuga de información. Estudiemos juntos rápidamente cómo funcionan estas firmas ciegas.

Las firmas ciegas Chaum son una forma de firma digital en la que el emisor de una firma desconoce el contenido del mensaje que está firmando. Sin embargo, la firma puede verificarse posteriormente con el mensaje original. Esta técnica fue desarrollada por el criptógrafo David Chaum en 1983.

Tomemos el ejemplo de una empresa que desea autenticar un documento confidencial, como un contrato, sin revelar su contenido. La empresa aplica un proceso de enmascaramiento que transforma criptográficamente el documento original de forma reversible. Este documento modificado se envía a una autoridad de certificación que aplica una firma ciega sin conocer el contenido subyacente. Tras recibir el documento firmado, la empresa elimina el enmascaramiento de la firma. El resultado es un documento original autenticado por la firma de la autoridad, sin que ésta haya visto nunca el contenido original.

Las firmas ciegas de Chaum permiten así certificar la autenticidad de un documento sin conocer su contenido, garantizando tanto la confidencialidad de los datos del usuario como la integridad del documento firmado.

### Chaumian Coinjoins

En "Chaumian CoinJoins", el uso de Tor y las firmas ciegas de David Chaum se combinan para garantizar que el coordinador no pueda saber a qué usuario pertenece cada salida. El proceso de construcción de transacciones coinjoin consta de 3 pasos principales: registro de entrada, registro de salida y firma de la transacción. Examinemos este proceso a través del ejemplo de Alice, una de las participantes en coinjoin. Todos los demás participantes siguen los mismos pasos que Alice, cada uno por su cuenta.

**Paso 1: Registro de entradas.**


- Alice envía al coordinador la UTXO que quiere utilizar como entrada para la transacción, así como la dirección receptora enmascarada que quiere utilizar como salida para recibir sus bitcoins. Por lo tanto, el coordinador no puede conocer la dirección de Alice. Sólo ve su versión enmascarada.
- El coordinador verifica la validez de las entradas y, a continuación, firma la dirección enmascarada de Alice con su clave privada. A continuación, envía a Alice la firma ciega.

**Paso 2: Grabación de salidas.**


- Alice puede ahora eliminar la máscara de su dirección firmada por la clave privada del coordinador. Establece una nueva conexión bajo una identidad Tor diferente. El coordinador no puede identificar que es Alice la que se conecta bajo esta nueva identidad.
- Alice envía la dirección y la firma no disimuladas al coordinador (que sigue sin saber que es Alice).

**Paso 3: Firmar la transacción.**


- Del mismo modo, el coordinador recupera los resultados desenmascarados de todos los participantes. Con las firmas asociadas, puede verificar que cada salida enviada de forma anónima fue realmente firmada por su clave privada previamente, garantizando su legitimidad. A continuación, está listo para construir la transacción coinjoin y la envía a los participantes para que la firmen.
- Alice, al igual que los demás participantes, verifica que su entrada y su salida están correctamente incluidas en la transacción construida por el coordinador. Si todo es satisfactorio, envía al coordinador la firma que desbloquea la escritura de su entrada.
- Tras recoger las firmas de todos los participantes en coinjoin, el coordinador puede transmitir la transacción a través de la red Bitcoin para que se añada a un bloque.

En este sistema, el coordinador no puede vincular una entrada a una salida concreta. Además, no puede apoderarse de los fondos de los participantes, ya que nunca tiene acceso a las claves privadas necesarias para desbloquear sus UTXO. Durante todo el proceso, y hasta el final del paso 3, ni siquiera tiene acceso a las firmas. Cuando Alice y los demás participantes firman la transacción global, tras verificar que todo es correcto, el coordinador ya no puede modificar esta transacción, incluidas las salidas, sin invalidarla. Así se evita el robo de bitcoins por parte del coordinador.

En última instancia, al registrar su resultado en la transacción, el usuario de coinjoin desea garantías similares a las de un ciudadano que vota en unas elecciones. Existe una dualidad entre los aspectos públicos y privados de estas acciones. Por un lado, está lo que se quiere mantener en privado: para el votante, no quiere que su papeleta se vincule a su identidad; para el usuario de coinjoin, no quiere que su salida se asocie a su entrada. De hecho, si el coordinador, o cualquier otra parte, consigue establecer un vínculo entre una entrada y una salida, coinjoin pierde todo su propósito. Como ya se ha explicado, el coinjoin debe funcionar como una pausa en la historia de una moneda. Esta pausa se produce precisamente por la incapacidad de asociar una entrada específica con una salida específica en la transacción coinjoin (anonset prospectivo) y viceversa (anonset retrospectivo).

Por otro lado, está el aspecto público: el votante quiere asegurarse de que su papeleta está incluida en la urna; del mismo modo, el usuario de coinjoin quiere asegurarse de que su resultado está incluido en la transacción coinjoin. De hecho, es absolutamente necesario que los participantes en coinjoin puedan verificar la presencia de su resultado antes de firmar la transacción, pues de lo contrario el coordinador podría robar los fondos.

Son precisamente estos 2 aspectos público y privado, posibles gracias al uso de las firmas ciegas de David Chaum, los que garantizan a los participantes de Chaumians coinjoin que sus bitcoins no serán robados y que sus fondos no podrán ser rastreados.

### ¿Quién inventó el concepto de coinjoin?

Es difícil determinar con certeza quién introdujo por primera vez la idea de coinjoin en Bitcoin, y a quién se le ocurrió utilizar las firmas ciegas de David Chaum en este contexto. Se suele pensar que fue Gregory Maxwell quien lo mencionó por primera vez en [un post en BitcoinTalk en 2013](https://bitcointalk.org/index.php?topic=279249.0):

Utilizando las firmas ciegas de Chaum: Los usuarios se conectan y proporcionan datos de entrada (y direcciones para el resto), así como una versión criptográficamente oculta de la dirección a la que desean enviar sus monedas privadas; el servidor firma las fichas y las devuelve a los usuarios. Los usuarios vuelven a conectarse de forma anónima, revelan sus direcciones de salida y las envían de nuevo al servidor. El servidor puede ver que todas las salidas han sido firmadas por él y que, en consecuencia, todas las salidas proceden de participantes válidos. Más tarde, los usuarios vuelven a conectarse y firman.

Maxwell, G. (2013, 22 de agosto). _CoinJoin: La privacidad de Bitcoin para el mundo real_. Foro BitcoinTalk. https://bitcointalk.org/index.php?topic=279249.0

Sin embargo, ha habido menciones previas de ambas firmas Chaum en el contexto de mezclas y coinjoins. [En junio de 2011, Duncan Townsend presentó en BitcoinTalk](https://bitcointalk.org/index.php?topic=12751.0) un mezclador que utiliza firmas Chaum de una manera bastante similar a los modernos coinjoins chaumianos.

En el mismo hilo, hay [un mensaje hashcoin en respuesta a Duncan Townsend](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793) para mejorar su mezclador. El proceso descrito en este mensaje representa precisamente lo más parecido a coinjoins. También se menciona un sistema similar en [un mensaje de Alex Mizrahi en 2012](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry), ya que estaba asesorando a los creadores de Tenebrix, una de las primeras altcoins que sirvió de base para la creación de Litecoin más adelante. Incluso el propio término "coinjoin" no fue inventado por Greg Maxwell, sino que surgió de una idea de Peter Todd.

![BTC204](assets/fr/125.webp)

### Zerolink

Zerolink es un protocolo de mezcla integral que integra coinjoins Chaumiani y varias estrategias para proteger el anonimato del usuario contra diversas formas de análisis de cadenas, reduciendo en gran medida los errores relacionados con la gestión de carteras. Este protocolo [fue introducido por nopara73 y TDevD en 2017](https://github.com/nopara73/ZeroLink/blob/master/README.md).

![BTC204](assets/fr/126.webp)

Como su nombre indica, el principio de Zerolink es realizar transacciones coinjoin que garanticen que los vínculos entre entradas y salidas no puedan rastrearse. Esta característica se consigue garantizando que todas las salidas tengan importes perfectamente idénticos.

![BTC204](assets/fr/127.webp)

Una importante medida preventiva de Zerolink consiste en separar completamente los UTXOs no mezclados de los UTXOs mezclados utilizando conjuntos separados de claves criptográficas, o incluso monederos separados. De este modo, el monedero "premezcla", destinado a las monedas antes de la mezcla, se diferencia del monedero "postmezcla", reservado a las monedas que se han mezclado.

![BTC204](assets/fr/128.webp)

Esta separación estricta de los UTXO sirve principalmente para evitar asociaciones accidentales entre un UTXO mezclado y otro no mezclado. De hecho, si se producen estos vínculos, la eficacia de coinjoin en el UTXO mezclado se anula sin que el usuario lo sepa, comprometiendo así la confidencialidad de un UTXO cuyo historial se creía roto. Estos enlaces pueden surgir mediante la reutilización de direcciones para asegurar un UTXO mezclado con otro no mezclado, o aplicando la Heurística de Propiedad de Entrada Común (CIOH) si el usuario consume UTXOs mezclados y no mezclados como entradas de la misma transacción. Al separar las carteras previa y posterior a la mezcla, se evitan estas asociaciones accidentales y se protege al usuario frente a errores involuntarios.

![BTC204](assets/fr/129.webp)

Esta separación también ofrece la posibilidad de aplicar reglas distintas entre las carteras premezcla y postmezcla a nivel del software de la cartera. Por ejemplo, en la cartera post-mixing, el software puede prohibir la fusión de UTXOs de entrada para evitar la aplicación de CIOH que comprometería el anonset del usuario. También es posible estandarizar el uso de scripts y opciones de transacción (como la señalización RBF, por ejemplo) para evitar la identificación por huella digital de la cartera.

Actualmente, Whirlpool es la única implementación de coinjoin que aplica estrictamente el protocolo Zerolink. En el siguiente capítulo, exploraremos las diferentes implementaciones de coinjoin existentes y las ventajas y desventajas de cada una.

## Implementaciones de Coinjoin

<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>

en 2024, estamos viendo cambios significativos en las herramientas disponibles para los usuarios que deseen ejecutar coinjoins en Bitcoin. Actualmente nos encontramos en un periodo crucial, y el mercado de coinjoins está sufriendo una importante reestructuración. Por lo tanto, es probable que este capítulo se actualice con el tiempo._

Por el momento, existen principalmente 3 implementaciones diferentes de coinjoin en Bitcoin:


- Whirlpool;
- Wabisabi;
- JoinMarket.

Cada una de estas implementaciones pretende romper el historial de UTXOs mediante transacciones coinjoin. Sin embargo, sus mecanismos varían significativamente. Por lo tanto, es esencial entender cómo funciona cada uno para elegir la opción que mejor se adapte a sus necesidades.

### JoinMarket

JoinMarket, creado en 2015 por Adam Gibson y Chris Belcher, se diferencia de otras implementaciones de coinjoin por su modelo único de intercambio entre usuarios. Este sistema se basa en un mercado de intercambio P2P en el que algunos usuarios, los "creadores", ponen sus bitcoins a disposición para mezclarlos, mientras que otros, los "tomadores", utilizan estos fondos para ejecutar coinjoins a cambio de una comisión.

![BTC204](assets/fr/130.webp)

En este modelo, los "creadores" dejan sus bitcoins a disposición de los "tomadores" y reciben comisiones a cambio de su servicio. Los "tomadores", por su parte, pagan por utilizar los bitcoins de los "creadores" para realizar sus propias transacciones coinjoin. Las tarifas de servicio varían según la función: los "makers" acumulan tarifas por sus ofertas de liquidez, mientras que los "takers" pagan comisiones. Este mercado funciona libremente sin condiciones de uso.

Una desventaja importante de JoinMarket es su complejidad de uso, que requiere cierta familiaridad con los terminales para explotarlo eficazmente. Aunque esta complejidad no supone un obstáculo para un usuario experimentado, puede limitar el acceso al público en general. No obstante, la reciente introducción de una interfaz web denominada JAM ha facilitado en cierta medida su uso.

![BTC204](assets/fr/131.webp)

Fuente: [JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

Sin embargo, la barrera técnica sigue siendo un obstáculo importante. En el ecosistema de los coinjoins, donde la confidencialidad se ve reforzada por el número de participantes, cualquier limitación que reduzca la accesibilidad afecta directamente a la liquidez disponible, que es un factor crucial para mezclar eficiencia. Bitcoin, que ya es un nicho en las transacciones financieras, considera el uso de coinjoins como un subnicho, y JoinMarket representa una fracción aún más especializada, lo que limita su potencial para aumentar el anonimato de sus usuarios.

A pesar de su innovador modelo de emparejamiento P2P para coinjoins, JoinMarket presenta algunos inconvenientes significativos, especialmente en lo que respecta a la estructura transaccional. A diferencia de otras implementaciones como Whirlpool, JoinMarket no garantiza una igualdad perfecta entre las salidas, y pueden establecerse vínculos deterministas entre las entradas y las salidas. También carece de herramientas para impedir que monedas ya mezcladas vuelvan a mezclarse, lo que podría comprometer la confidencialidad buscada por los usuarios. Por último, aunque el concepto de JoinMarket es atractivo, sobre todo para los interesados en un mercado dinámico de liquidez, sus deficiencias estructurales y su complejidad técnica lo hacen, en mi opinión, menos atractivo, tanto para los novatos como para los expertos que buscan la aplicación de coinjoin.

### Wabisabi

Wabisabi es otra implementación de coinjoin, con un enfoque que centraliza la coordinación de las transacciones. Este modelo fue diseñado por Ádám Ficsór (nopara73), Yuval Kogman, Lucas Ontivero e István András Seres en 2021, y se integró en el software Wasabi 2.0 al año siguiente. Wabisabi representa precisamente una evolución del modelo coinjoin del software Wasabi lanzado en 2018.

A finales de la década de 2010, Wasabi adoptó una estructura transaccional para sus coinjoins que era radicalmente diferente de la de Whirlpool. Para aumentar los anonimatos de sus participantes, Wasabi utilizaba transacciones coinjoin muy grandes que agrupaban a decenas de participantes. En cambio, Whirlpool optó por múltiples transacciones pequeñas, lo que permitía un aumento exponencial de los anonsets con cada ciclo.

Los métodos para tratar el resto también diferencian las dos implementaciones. Con Whirlpool, el resto se excluía y aislaba de los UTXO antes de los ciclos coinjoin mediante TX0, un concepto que explicaré con más detalle en el próximo capítulo. Con Wasabi, en cambio, el resto formaba una de las salidas de la transacción coinjoin, manteniendo vínculos deterministas entre algunas entradas y salidas.

Con Wabisabi, la versión 2.0 de Wasabi ha adaptado su enfoque de los coinjoins para aproximarse al de Whirlpool. Aunque las transacciones coinjoin siguen siendo muy grandes, ahora es posible encadenar varias rondas sucesivas, siguiendo así el modelo de Whirlpool. También se ha hecho un esfuerzo especial en la gestión del cambio: a diferencia de Wasabi 1.0, donde el cambio estaba directamente vinculado a la entrada del usuario, Wabisabi intenta dividir el cambio en varias cantidades pequeñas, distribuidas en denominaciones iguales para todos los participantes.

Lo ilustraremos con un ejemplo simplificado en el que sólo intervienen 2 usuarios: Alice quiere mezclar 115.000 sats y Bob, 210.000 sats. Ignorando las comisiones, con Wasabi 1.0, una transacción coinjoin habría generado 3 salidas de 100.000 saturaciones, más 1 resto de 15.000 saturaciones para Alice y 1 resto de 10.000 saturaciones para Bob. Las salidas restantes siempre estarían vinculadas a las entradas:

Según Wabisabi, la misma transacción produciría 3 salidas de 100.000 sats y 5 salidas de 5.000 sats, dispersando así el resto para que no sea directamente trazable a una entrada específica:

Personalmente, creo que la gestión del cambio en Wabisabi presenta varios riesgos que podrían comprometer su eficacia en términos de privacidad:


- Cuando un usuario aporta un UTXO significativamente mayor que los de otros participantes, inevitablemente acaba con una cantidad de cambio que se vinculará a su aportación. Esto va en contra del objetivo inicial del protocolo, que pretende eliminar cualquier cambio identificable;
- Multiplicar las denominaciones para fragmentar el resto puede perjudicar paradójicamente la eficacia de la mezcla. Este proceso puede conducir a una disminución de los anonsets para determinados productos, ya que se vuelven más fácilmente identificables;
- Este método también genera UTXOs de poco valor que plantean un problema de gestión para el usuario. Estos pequeños UTXOs, si se vuelven demasiado caros de gastar en relación a su valor, pueden convertirse en "polvo" Este fenómeno lleva al usuario a fusionar varios UTXO de entrada en sus futuras transacciones o a consolidarlos. En cualquier caso, debido a la COH, esto puede disminuir los anonsets obtenidos o anular por completo los beneficios de privacidad obtenidos de la coinjoin inicial.

A diferencia de Whirlpool, que aplica el protocolo ZeroLink garantizando una segregación estricta entre la premezcla y la postmezcla de UTXO, Wabisabi no mantiene esta segregación estricta. También ha habido problemas con la reutilización de direcciones por parte de algunos clientes de Wasabi, lo que obviamente es muy perjudicial para el usuario.

En la versión 2.0 de Wasabi, se ha implementado una nueva política de precios de coinjoin. Ahora, las tasas de coordinación se fijan en el 0,3 por ciento para UTXOs mayores de 0,01 bitcoin, mientras que para UTXOs más pequeños, estas tasas se eliminan por completo. Además, las remezclas de estos UTXO más pequeños son gratuitas, aunque se mantienen las tasas de minería para todas las transacciones, incluidas las remezclas.

Esta política contrasta con la de Whirlpool, donde las comisiones permanecen fijas, independientemente del tamaño de los anonsets obtenidos. Con Wasabi 2.0, aunque las comisiones de coordinador se ponen a cero para los UTXO pequeños, el usuario sigue teniendo que pagar comisiones de minería en todas las transacciones, incluidas las remezclas.

En el momento de escribir estas líneas, el uso de Wabisabi se ha complicado considerablemente a raíz de los últimos acontecimientos. En efecto, tras la detención de los fundadores de Samourai Wallet, zkSNACKs, la empresa que financia y gestiona el desarrollo de Wasabi, anunció el cese de su servicio de coordinación de coinjoin el 1 de junio de 2024. Este coordinador, que estaba configurado por defecto para Wasabi, contaba con la gran mayoría de la liquidez.

Con el cierre de este coordinador principal, los usuarios deben ahora conectarse a nuevos coordinadores independientes. Este cambio plantea problemas: por un lado, los nuevos coordinadores pueden no tener suficiente liquidez, lo que reduce la eficacia de los coinjoins en términos de privacidad. Por otro, existe el riesgo de encontrarse con un coordinador malintencionado. Esta situación añade nuevos riesgos significativos para quienes deseen utilizar Wabisabi.

Además de las cuestiones técnicas, la decisión de zkSNACKs, la empresa detrás de Wasabi, de utilizar los servicios de una empresa de análisis de blockchain para filtrar a los participantes en coinjoins plantea serias cuestiones éticas y estratégicas. La idea inicial era evitar el uso de coinjoins en Wasabi por parte de delincuentes, una medida que puede parecer legítima. Sin embargo, plantea una paradoja: pagar cuotas a un coordinador, cuya misión principal es aumentar la privacidad de los usuarios, para luego financiar a una empresa cuyo objetivo es comprometer esa misma privacidad.

Aún más preocupante es el principio de filtrado, que contrasta fuertemente con la filosofía de Bitcoin de proporcionar un sistema financiero abierto y sin censura. Aunque pueda parecer justificado querer excluir la actividad delictiva, este filtrado también podría dirigirse a individuos cuyas acciones, aunque clasificadas como ilegales en algunos contextos, podrían ser moralmente justificables o socialmente beneficiosas. El ejemplo de Edward Snowden ilustra perfectamente esta dicotomía: considerado un delincuente por algunos gobiernos por sus revelaciones, es visto por otros como un denunciante que actuó en interés público. Esta complejidad subraya el peligro potencial del filtrado, que, aunque parte de una buena intención, puede acabar perjudicando los derechos y la seguridad de los usuarios legítimos. También podría haber mencionado a los activistas y periodistas perseguidos bajo ciertos regímenes autoritarios. Como habrán adivinado, mi preferencia es sin duda por el modelo Whirlpool para realizar coinjoins en Bitcoin. Este sistema destaca por su rigor y ofrece garantías superiores en términos de privacidad. También es el único que propone una mezcla que se considera perfecta en un contexto matemático. En mi opinión, este modelo representa el futuro de los coinjoins en Bitcoin. Por lo tanto, le invito a explorar este modelo en mayor profundidad en el próximo capítulo.

## El funcionamiento de Whirlpool

<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>

Whirlpool se diferencia de otros métodos de coinjoin por el uso de transacciones "_ZeroLink_", que garantizan que no exista técnicamente ninguna conexión posible entre todas las entradas y todas las salidas. Esta mezcla perfecta se consigue mediante una estructura en la que cada participante aporta una cantidad idéntica en entrada (a excepción de las tasas de minería), generando así salidas de cantidades perfectamente iguales.

Este enfoque restrictivo de los insumos confiere a las transacciones coinjoin de Whirlpool una característica única: la ausencia total de vínculos deterministas entre insumos y productos. En otras palabras, cada resultado tiene la misma probabilidad de ser atribuido a cualquier participante, en relación con todos los demás resultados de la transacción.

![BTC204](assets/fr/136.webp)

### Funcionamiento general de Whirlpool

Inicialmente, el número de participantes en cada coinjoin de Remolino estaba limitado a 5, con 2 nuevos participantes y 3 remezcladores (explicaremos estos conceptos más adelante). Sin embargo, el aumento de las comisiones por transacciones en la cadena observado en 2023 llevó a los equipos de Samourai a replantearse su modelo para mejorar la privacidad y reducir al mismo tiempo los costes. Así, teniendo en cuenta la situación del mercado de comisiones y el número de participantes, el coordinador puede ahora organizar coinjoins que incluyan 6, 7 u 8 participantes. Estas sesiones mejoradas se designan con el nombre de "_Surge Cycles_" Es importante señalar que, independientemente de la configuración, siempre hay sólo 2 nuevos participantes en los coinjoins de Remolino.

Así, las transacciones de Whirlpool se caracterizan por un número idéntico de entradas y salidas, que pueden ser:


- 5 entradas y 5 salidas;

![BTC204](assets/fr/137.webp)


- 6 entradas y 6 salidas;

![BTC204](assets/fr/138.webp)


- 7 entradas y 7 salidas;

![BTC204](assets/fr/139.webp)


- 8 entradas y 8 salidas.

![BTC204](assets/fr/140.webp)

El modelo propuesto por Whirlpool se basa, pues, en pequeñas transacciones coinjoin. A diferencia de Wabisabi y JoinMarket, donde la solidez de los anonsets se basa en el volumen de participantes en un único ciclo (o unos pocos ciclos), Whirlpool se basa en la concatenación de múltiples ciclos pequeños. En este modelo, los usuarios sólo incurren en costes en su entrada inicial en un pool, lo que les permite participar en multitud de remezclas sin coste adicional. Son los nuevos participantes quienes cubren los costes de minería de los remezcladores.

Con cada coinjoin adicional en el que participe una moneda, junto con sus pares encontrados en el pasado, los anonsets crecerán exponencialmente. El objetivo, por tanto, es aprovechar estas remezclas gratuitas que, con cada ocurrencia, ayudan a fortalecer la densidad de anonsets asociados a cada coinjoin.

Whirlpool se diseñó teniendo en cuenta dos requisitos importantes:


- La accesibilidad de la aplicación en dispositivos móviles, ya que Samourai Wallet es principalmente una aplicación para teléfonos inteligentes;
- La velocidad de los ciclos de remezcla favorece un aumento significativo de los anonsets.

Estos imperativos guiaron las decisiones de los desarrolladores de Samourai Wallet a la hora de diseñar Whirlpool, llevándoles a limitar el número de participantes por ciclo. Muy pocos participantes habrían comprometido la eficacia de coinjoin, reduciendo drásticamente los anonsets generados en cada ciclo, mientras que demasiados participantes habrían planteado problemas de gestión en las aplicaciones móviles y obstaculizado el flujo de ciclos.

En última instancia, no es necesario tener un número elevado de participantes para coinjoin en Whirlpool, ya que los anonsets se realizan sobre la acumulación de varios ciclos de coinjoin. El principio más importante aquí es la homogeneidad de los UTXO de todos los participantes, ya que esto permite una mezcla perfecta, y así beneficiarse plenamente de los ciclos de mezcla y remezcla.

### Coinjoin piscinas y tarifas

Para que estos ciclos múltiples aumenten efectivamente los anonsets de las monedas mixtas, debe establecerse algún marco que limite las cantidades de UTXO utilizadas. Por ello, Whirlpool define varios pools.

Un pool representa a un grupo de usuarios que desean mezclarse, que acuerdan la cantidad de UTXO que se utilizará para optimizar el proceso de coinjoin manteniendo una perfecta homogeneidad de monedas. Cada pool especifica una cantidad fija de UTXO, que el usuario debe cumplir para poder participar. Por lo tanto, para realizar coinjoins con Whirlpool, debe seleccionarse un pool. Los pools disponibles actualmente son los siguientes


- 0.5 bitcoin;
- 0.05 bitcoin;
- 0.01 bitcoin;
- 0.001 bitcoin (= 100.000 sats).

Al unirte a un pool con tus bitcoins, éstos se dividirán para generar UTXOs perfectamente homogéneos con los de los demás participantes en el pool. Cada pool tiene un límite máximo; por lo tanto, para las cantidades que superen este límite, se verá obligado a realizar dos entradas separadas en el mismo pool o recurrir a otro pool con una cantidad mayor:

| Cantidad máxima por entrada (bitcoin)

|----------------|----------------------------------------|

| 0,5 | 35 |

| 0,05 | 3,5 |

| 0,01 | 0,7 |

| 0,001 | 0,025 |

Se considera que un UTXO pertenece a un pool cuando está listo para integrarse en un coinjoin. Sin embargo, esto no significa que el usuario pierda su posesión. Como vimos en los primeros capítulos de esta parte, a través de los diferentes ciclos de mezcla, el usuario conserva el control total de sus claves y, en consecuencia, de sus bitcoins. Esto es lo que diferencia a la técnica coinjoin de otras técnicas de mezcla centralizadas.

Para unirse a un pool de coinjoin, hay que pagar tasas de servicio y tasas de minería. Las cuotas de servicio son fijas para cada pool y están destinadas a compensar a los equipos responsables del desarrollo y mantenimiento de Whirlpool.

Las tasas de servicio por el uso de Whirlpool deben abonarse una sola vez al entrar en la piscina. Una vez realizado este paso, podrá participar en un número ilimitado de remezclas sin tasas adicionales. Estas son las tarifas fijas actuales para cada piscina:

| Pool (bitcoin) | Comisión de entrada (bitcoin) |

| -------------- | --------------------------------- |

| 0.5 | 0.0175 |

| 0.05 | 0.00175 |

| 0.01 | 0.0005 (50,000 sats) |

| 0.001 | 0.00005 (5,000 sats) |

Estas comisiones funcionan esencialmente como un ticket de entrada al pool que elijas, independientemente de la cantidad que ingreses en coinjoin. Así que tanto si entras en el pool de 0,01 BTC con exactamente 0,01 BTC como si entras con 0,5 BTC, las comisiones seguirán siendo las mismas en valor absoluto.

Antes de proceder a las uniones por remolino, el usuario puede elegir entre 2 estrategias:


- Optan por un fondo común más pequeño para minimizar las comisiones de servicio, sabiendo que recibirán a cambio varios UTXO más pequeños;
- O prefieren un grupo más grande, aceptando pagar comisiones más altas para acabar con un pequeño número de UTXOs de mayor valor.

Por lo general, no se recomienda fusionar varios UTXO mixtos después de ciclos coinjoin, ya que esto podría comprometer la privacidad obtenida, especialmente debido a la heurística de propiedad de entrada común (CIOH: _Common-Input-Ownership-Heuristic_). Por lo tanto, puede ser aconsejable elegir un pool más grande, aunque signifique pagar más, para evitar tener demasiados UTXOs de poco valor como salida. El usuario debe evaluar estas ventajas y desventajas para elegir el pool que prefiera.

Además de las tasas de servicio, también hay que tener en cuenta las tasas de minería inherentes a cualquier transacción de Bitcoin. Como usuario de Whirlpool, tendrás que pagar tasas de minería por la transacción de preparación (`Tx0`), así como las de la primera coinjoin. Todas las remezclas posteriores serán gratuitas, debido al modelo de Whirlpool de pagar a los nuevos participantes.

De hecho, en cada coinjoin de Remolino, 2 usuarios entre las entradas son nuevos participantes. Las demás entradas proceden de remezcladores. Como resultado, las tasas de minería de todos los participantes en la transacción son cubiertas por estos 2 nuevos participantes, que también se beneficiarán de remezclas gratuitas:

![BTC204](assets/it/54/07.webp)

Debido a este sistema de tasas, Whirlpool se diferencia realmente de otras implementaciones de coinjoin porque los anonimatos de UTXOs no son proporcionales al precio pagado por el usuario. Así, se pueden conseguir niveles considerablemente altos de anonimato pagando sólo la cuota de entrada al pool y las tasas de minado de 2 transacciones (la `Tx0` y la mezcla inicial).

Es importante tener en cuenta que el usuario también tendrá que cubrir las tasas de minería para retirar sus UTXOs del pool después de ejecutar sus múltiples coinjoins, a menos que haya seleccionado la opción `mix to`, que le permite proporcionar una dirección externa que recibirá directamente los fondos como salida de un coinjoin, sin ninguna transacción adicional.

### Cuentas HD Wallet

Para realizar un coinjoin a través de Whirlpool, el monedero debe generar varias cuentas separadas. Este es el principio del protocolo ZeroLink. Una cuenta, en el contexto de un monedero HD (_Hierarchical Deterministic_), constituye una sección completamente aislada de las demás, esta separación se produce en el tercer nivel de profundidad de la jerarquía del monedero, es decir, en el nivel `xpub`.

![BTC204](assets/it/54/08.webp)

Un monedero HD puede teóricamente derivar hasta `2^(32/2)` cuentas diferentes. La cuenta inicial, utilizada por defecto en todos los monederos Bitcoin, corresponde al índice `0'`.

Para las carteras adaptadas a Whirlpool, se utilizan 4 cuentas para cumplir los requisitos del proceso ZeroLink:


- La **cuenta de depósito**, identificada por el índice `0'`;
- La **cuenta bancaria mala** (o "bolsa tóxica"), identificada por el índice `2 147 483 644'`;
- La **cuenta premezcla**, identificada por el índice `2 147 483 645'`;
- La cuenta **postmix**, identificada por el índice `2 147 483 646'`.

Cada una de estas cuentas desempeña una función específica en el proceso de coinjoin, que exploraremos en las secciones siguientes.

Todas estas cuentas están vinculadas a una única semilla, lo que permite al usuario recuperar el acceso a todos sus bitcoins utilizando su frase de recuperación y, si es necesario, su frase de contraseña. Sin embargo, es necesario especificar al software, durante esta operación de recuperación, los diferentes índices de las cuentas que se han utilizado.

Examinemos ahora las diferentes etapas de un coinjoin Whirlpool dentro de estas cuentas.

### El TX0

El punto de partida de cualquier coinjoin de Remolino es la **cuenta de depósito**. Esta cuenta es la que se utiliza automáticamente al crear un nuevo monedero bitcoin. Esta cuenta debe estar acreditada con los bitcoins que desea mezclar.

La `Tx0` representa el primer paso en el proceso de mezcla Whirlpool. Su objetivo es preparar e igualar los UTXO para el coinjoin, dividiéndolos en unidades correspondientes a la cantidad del pool seleccionado, para garantizar la homogeneidad de la mezcla. A continuación, los UTXO igualados se envían a la **cuenta de premezcla**. En cuanto a la diferencia que no puede entrar en el pool, se separa en una cuenta específica: el **banco malo** (o "intercambio tóxico").

Esta transacción inicial `Tx0` también sirve para liquidar las tasas de servicio debidas al coordinador de coinjoin. A diferencia de los pasos posteriores, esta transacción no es colaborativa; por lo tanto, el usuario debe asumir el coste total de las tasas de minería:

![BTC204](assets/it/54/09.webp)

En este ejemplo de transacción `Tx0`, una entrada de `372 000 sats` de nuestra **cuenta de depósito** se divide en varias UTXOs de salida, que se distribuyen de la siguiente manera:


- Una cantidad de `5.000 sats` asignada al coordinador en concepto de comisiones de servicio, correspondiente a la entrada en el pool de `100.000 sats`;
- 3 UTXOs preparados para la mezcla, redirigidos a nuestra **cuenta de premezcla** y registrados con el coordinador. Estos UTXOs se igualan a `108 000 sats` cada uno, para cubrir las tasas mineras de su futura mezcla inicial;
- El excedente que no puede entrar en el pool, por ser demasiado pequeño, se considera intercambio tóxico. Se envía a su cuenta específica. En este caso, este intercambio asciende a `40 000 sats`;
- Por último, hay `3.000 sats` que no constituyen producción, sino que son los cánones mineros necesarios para confirmar `Tx0`.

Por ejemplo, aquí hay un Tx0 Whirlpool real (no es mío):[edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/fr/145.webp)

### El cambio tóxico

El exceso que no ha podido integrarse en el fondo común, aquí equivalente a `40.000 sats`, se redirige a la cuenta del **banco malo**, también denominada "intercambio tóxico", para garantizar una separación estricta de los demás UTXO de la cartera.

Este UTXO es peligroso para la privacidad del usuario porque no sólo sigue vinculado a su pasado y, por tanto, posiblemente a la identidad de su propietario, sino que también está marcado como perteneciente a un usuario que ha participado en un coinjoin.

![BTC204](assets/fr/146.webp)

Si este UTXO se fusiona con salidas barajadas, perderán toda la privacidad obtenida durante los ciclos coinjoin, debido en gran medida a CIOH (_Common-Input-Ownership-Heuristic_). Si se fusiona con otros cambios tóxicos, el usuario corre el riesgo de perder la privacidad, ya que esto vinculará las distintas entradas de los ciclos coinjoin. Por lo tanto, debe manejarse con precaución. Discutiremos la gestión de estos UTXOs tóxicos con más detalle en la última sección de este capítulo.

### La mezcla inicial

Una vez completada la `Tx0`, los UTXO ecualizados se envían a la cuenta **premix** de nuestra cartera, listos para ser introducidos en su primer ciclo de coinjoin, también llamado "mezcla inicial" Si, como en nuestro ejemplo, `Tx0` genera varios UTXO destinados a la mezcla, cada uno de ellos se integrará en una mezcla inicial independiente.

Al final de estas primeras mezclas, la cuenta **premix** estará vacía, mientras que nuestras monedas, habiendo pagado las tasas de minado de esta primera coinjoin, se liquidarán exactamente en la cantidad definida por el pool elegido. En nuestro ejemplo, nuestros UTXOs iniciales de `108.000 sats` se habrán reducido exactamente a `100.000 sats`.

![BTC204](assets/fr/147.webp)

### Las remezclas

Tras la mezcla inicial, los UTXO se transfieren a la cuenta **postmix**. Esta cuenta recoge tanto los UTXO que ya se han mezclado como los que están pendientes de remezcla. Cuando el cliente Remolino está activo, los UTXO de la cuenta **postmix** están automáticamente disponibles para remezcla y serán elegidos al azar para participar en estas nuevas rondas.

Como recordatorio, las remezclas son entonces completamente gratuitas: no se requieren cuotas adicionales de servicio ni de minería. Mantener UTXOs en la cuenta **postmix** mantiene así su valor intacto y mejora simultáneamente sus anonsets. Por eso es importante permitir que estas monedas participen en múltiples ciclos coinjoin. No te cuesta absolutamente nada y aumenta sus niveles de anonset.

Cuando decidas gastar UTXOs mixtos, puedes hacerlo directamente desde esta cuenta **postmix**. Es aconsejable guardar UTXOs mixtos en esta cuenta para beneficiarse de remezclas gratuitas y evitar que salgan del circuito de Remolino, lo que puede disminuir su privacidad.

### ¿Cómo gestionar correctamente su cuenta Postmix?

Después de ejecutar ciclos de coinjoin, la mejor estrategia es mantener tus UTXOs en la cuenta **postmix**, a la espera de su uso futuro. Incluso es aconsejable dejar que se remezclen indefinidamente hasta que necesites gastarlos.

Algunos usuarios pueden considerar transferir sus bitcoins mezclados a un monedero hardware protegido. Esto es posible, pero es importante seguir meticulosamente las recomendaciones de Samourai Wallet para no comprometer la confidencialidad obtenida.

Combinar UTXOs es el error que se comete con más frecuencia. Debe evitar combinar UTXOs mezclados con UTXOs no mezclados en la misma transacción para evitar la heurística de propiedad común de entrada (CIOH). Esto requiere una gestión cuidadosa de sus UTXOs dentro de su cartera, especialmente en términos de etiquetado.

![BTC204](assets/fr/148.webp)

También es importante ser prudente a la hora de consolidar UTXOs mixtos. Es posible realizar consolidaciones moderadas si sus UTXO mixtos tienen anonsets significativos, pero esto disminuirá inevitablemente la confidencialidad de sus monedas. Asegúrese de que las consolidaciones no sean demasiado importantes o se realicen tras un número insuficiente de remezclas, a riesgo de establecer vínculos inferidos entre sus UTXO antes y después de los ciclos de coinjoin. En caso de duda sobre estas manipulaciones, la mejor práctica es no consolidar UTXOs postmix, y transferirlos uno a uno a su monedero hardware, generando una nueva dirección vacía cada vez. Aún así, recuerda etiquetar adecuadamente cada UTXO recibido.

Tampoco se recomienda transferir tus postmixes UTXO a un monedero que utilice scripts poco comunes. Por ejemplo, si entras en Whirlpool desde un monedero multisig que utiliza scripts `P2WSH`, existe una pequeña posibilidad de que te mezcles con otros usuarios que tengan originalmente el mismo tipo de monedero. Si retiras tus postmixes en este mismo monedero multisig, el nivel de privacidad de tus bitcoins mezclados se verá muy disminuido. Además de los scripts, hay muchas otras huellas de monedero que pueden engañarte.

Como con cualquier transacción Bitcoin, también es importante no reutilizar las direcciones de recepción. Cada nueva transacción debe recibirse en una dirección nueva y vacía.

La solución más sencilla y segura es dejar que sus UTXOs mixtos descansen en su cuenta **postmix**, permitiéndoles remezclar y tocándolos sólo para gastarlos. Las carteras Samourai y Sparrow disponen de protecciones adicionales contra todos estos riesgos de análisis en cadena. Estas protecciones le ayudan a evitar cometer errores.

### ¿Cómo gestionar adecuadamente su cambio tóxico?

A continuación, debe tener cuidado al manipular su cambio tóxico, el cambio que no pudo entrar en el fondo común de coinjoin. Estos UTXO tóxicos, resultantes del uso de Whirlpool, suponen un riesgo para su privacidad porque establecen un vínculo entre usted y el uso de coinjoin. Por lo tanto, es imperativo manejarlos con precaución y no combinarlos con otros UTXOs, especialmente UTXOs mixtos.

He aquí varias estrategias a tener en cuenta para utilizarlos:


- Mézclelos en piscinas más pequeñas:** Si su UTXO tóxico es lo suficientemente grande como para caber solo en una piscina más pequeña, considere la posibilidad de mezclarlo. Esta suele ser la mejor opción. Sin embargo, no se recomienda mezclar varios UTXO tóxicos para acceder a una piscina, ya que esto podría enlazar sus diferentes entradas.
- Marcarlos como "no gastables":** Otro enfoque es dejar de usarlos, marcarlos como "no gastables" en su cuenta dedicada y simplemente hodl. Así se asegura de no gastarlos accidentalmente. Si el valor del bitcoin aumenta, pueden surgir nuevos pools más adecuados para sus UTXOs tóxicos;
- Hacer donaciones:** Considere hacer donaciones, aunque sean modestas, a los desarrolladores que trabajan en Bitcoin y su software asociado. También puedes donar a organizaciones que acepten BTC. Si gestionar tus UTXO tóxicos te parece demasiado complicado, puedes deshacerte de ellos simplemente haciendo una donación.
- Compra tarjetas regalo:** Plataformas como [Bitrefill](https://www.bitrefill.com/) te permiten intercambiar bitcoins por tarjetas regalo que puedes utilizar en varios comercios. Esta puede ser una forma de deshacerte de tus UTXO tóxicos sin perder el valor asociado.
- Consolidarlos en Monero:** Samourai Wallet ofrece un servicio de intercambio atómico entre BTC y XMR. Esto es ideal para gestionar UTXOs tóxicos consolidándolos en Monero, sin comprometer tu privacidad vía KYC, antes de enviarlos de vuelta a Bitcoin. Sin embargo, esta opción puede resultar cara en términos de tarifas mineras y primas debido a las restricciones de liquidez.
- Enviarlos a la red Lightning:** Transferir estos UTXO a la red Lightning para beneficiarse de tarifas de transacción reducidas es una opción atractiva. Sin embargo, este método puede revelar cierta información en función de su uso de Lightning, por lo que debe practicarse con precaución.

### ¿Cómo utilizar Whirlpool?

Tras la detención de los fundadores de Samourai Wallet y la incautación de sus servidores el 24 de abril de 2024, la herramienta Remolino ya no funciona, ni siquiera para aquellos que tienen su propio Dojo. Anteriormente, estaba disponible en Samourai Wallet y Sparrow Wallet.

![BTC204](assets/fr/149.webp)

Sin embargo, sigue siendo posible que este instrumento vuelva a ponerse en servicio en las próximas semanas, en función del resultado de las pruebas, o que se relance de otra forma. En cualquier caso, creo que el mercado de coinjoin en Bitcoin no permanecerá sin oferta durante mucho tiempo, ya que existe una clara demanda. Además, el modelo Whirlpool, al ser el más avanzado en términos de privacidad, seguramente se utilizará para otras implementaciones en el futuro.

Seguimos de cerca la evolución de este caso, así como la de las herramientas asociadas. Tenga la seguridad de que actualizaremos esta formación a medida que dispongamos de nueva información.

En el próximo capítulo, descubriremos qué son los "anonsets", cómo se calculan estos indicadores y cómo pueden ayudarnos a estimar la eficacia de los ciclos coinjoin.

https://planb.network/tutorials/privacy/on-chain/coinjoin-sparrow-wallet-84def86d-faf5-4589-807a-83be60720c8b
https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/tutorials/privacy/on-chain/coinjoin-dojo-c4b20263-5b30-4c74-ae59-dc8d0f8715c2
## Conjunto de anonimato

<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>

Una vez estudiado cómo funcionan las coinjoins y los retos asociados a una mezcla eficaz, ahora aprenderemos a medir esta eficacia. ¿Cómo determinar si un proceso de coinjoin ha sido eficaz y qué grado de anonimato ha adquirido una moneda? Esto es lo que exploraremos en este capítulo con los conjuntos de anonimato o "anonsets" en inglés.

### Recordatorio sobre la utilidad de Coinjoin

La utilidad de CoinJoin reside en su capacidad para producir una negación plausible al sumergir tu moneda dentro de un grupo de monedas indistinguibles. El objetivo de esta acción es romper los vínculos de trazabilidad, tanto del pasado al presente como del presente al pasado.

En otras palabras, un analista que conozca su transacción inicial (`Tx0`) a la entrada de los ciclos CoinJoin no debería ser capaz de identificar con certeza su UTXO a la salida de los ciclos remix (análisis desde la entrada al ciclo hasta la salida del ciclo).

![BTC204](assets/it/55/01.webp)

Por el contrario, un analista que conozca su UTXO a la salida de los ciclos CoinJoin no debería poder determinar la transacción original a la entrada de los ciclos (análisis de la salida del ciclo a la entrada del ciclo).

![BTC204](assets/it/55/02.webp)

Para evaluar la dificultad que tiene un analista para relacionar el pasado con el presente y viceversa, es necesario cuantificar el tamaño de los grupos homogéneos de monedas dentro de los cuales se oculta su moneda. Esta medida nos indica el número de análisis que tienen una probabilidad idéntica. Así, si el análisis correcto está ahogado entre otros 3 análisis de igual probabilidad, su nivel de ocultación es muy bajo. Sin embargo, si el análisis correcto está dentro de un conjunto de 20.000 análisis todos igual de probables, su moneda está muy bien oculta. Y precisamente, el tamaño de estos conjuntos representa indicadores llamados anonsets.

### Entender los Anonsets

Los anonsets sirven como indicadores para evaluar el grado de privacidad de un UTXO concreto. Más concretamente, miden el número de UTXO indistinguibles dentro del conjunto que incluye la moneda estudiada. El requisito de un conjunto homogéneo de UTXO hace que los anonsets se calculen normalmente en ciclos CoinJoin. El uso de estos indicadores es especialmente relevante para los CoinJoins de Remolino debido a su uniformidad.

Los anonsets permiten, en su caso, juzgar la calidad de los CoinJoins. Un tamaño de anonset grande significa un alto nivel de anonimato, ya que resulta difícil distinguir un UTXO específico dentro del conjunto homogéneo.

Hay 2 tipos de anonsets:


- El anonset prospectivo;**
- La anonset.** retrospectiva

### Anonset prospectivo

El anonset forward-looking indica el tamaño del grupo entre el que se oculta el UTXO estudiado a la salida del ciclo, conociendo el UTXO a la entrada, es decir, el número de monedas indistinguibles presentes dentro de este grupo. En inglés, el nombre de este indicador es "forward anonset" o "forward-looking metrics"

Este indicador proporciona una medida de la resistencia de la privacidad de la moneda frente a un análisis pasado-presente (input to output).

![BTC204](assets/it/55/03.webp)

Esta métrica estima el grado de protección de tu UTXO frente a los intentos de reconstruir su historia desde su punto de entrada hasta su punto de salida en el proceso de coinjoin.

Por ejemplo, si su transacción participó en su primer ciclo coinjoin y se completaron dos ciclos descendentes adicionales, el anonset prospectivo de su moneda sería `13`:

![BTC204](assets/fr/153.webp)

Por ejemplo, imaginemos que nuestra moneda a la entrada del ciclo coinjoin se beneficia de una anonset prospectiva de `86,871`. En la práctica, esto significa que está oculta entre `86.871` monedas indistinguibles. Para un observador externo que conociera esta moneda al principio de los ciclos de coinjoin e intentara rastrear su salida, se encontraría con `86.871` UTXO posibles, cada una con una probabilidad idéntica de ser la moneda buscada.

![BTC204](assets/it/55/05.webp)

### La anonset retrospectiva

La anonset retrospectiva indica el número de posibles orígenes de una moneda determinada, conociendo el UTXO a la salida del ciclo. Este indicador mide la resistencia a la privacidad de la moneda frente a un análisis de presente a pasado (de salida a entrada), es decir, lo difícil que es para un analista rastrear el origen de tu moneda, antes de los ciclos de coinjoin. En inglés, el nombre de este indicador es "backward anonset" o "métrica retrospectiva"

Conociendo su UTXO a la salida de los ciclos, la anonset retrospectiva determina el número de transacciones Tx0 potenciales que podrían haber constituido su entrada en los ciclos coinjoin. En el diagrama siguiente, esto corresponde a la suma de todas las burbujas naranjas.

Por ejemplo, imaginemos que nuestra moneda a la salida del ciclo coinjoin se beneficia de un anonset retrospectivo de `42,185`. En la práctica, esto significa que hay `42.185` fuentes posibles para este UTXO. Si un observador externo identifica esta moneda al final de los ciclos e intenta rastrear su origen, se encontrará con `42.185` fuentes posibles, todas ellas con la misma probabilidad de ser el origen buscado.

### ¿Cómo calcular concretamente los anonsets?

Puede calcular manualmente sus anonsets utilizando un explorador de bloques para conjuntos pequeños. Sin embargo, para anonsets más grandes, se hace imprescindible el uso de una herramienta especializada. Que yo sepa, el único software capaz de realizar esta tarea es _Whirlpool Stats Tool_, una herramienta Python desarrollada por los equipos Samourai y OXT. Por desgracia, esta herramienta está actualmente fuera de servicio tras la detención de los fundadores de Samourai y el cese de OXT, que se estaba utilizando para extraer datos de la blockchain.

Como hemos visto en este capítulo, los anonsets sólo pueden calcularse si existe cierta homogeneidad en la estructura del coinjoin. Y precisamente, en el próximo capítulo, descubriremos cómo cuantificar esta homogeneidad en una transacción Bitcoin, ya sea una coinjoin o una transacción más tradicional.

https://planb.network/tutorials/privacy/analysis/wst-anonsets-0354b793-c301-48af-af75-f87569756375
## Entropía

<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>

Como hemos visto en esta parte sobre coinjoins, la homogeneidad de UTXOs en entradas y salidas juega un papel importante en la mejora de la confidencialidad de una transacción Bitcoin. Este parámetro permite una negación plausible contra el análisis de la cadena. Varios métodos pueden medir esta homogeneidad, pero uno de los más eficaces, en mi opinión, es el uso de indicadores proporcionados por la herramienta _Boltzmann_, desarrollada por los equipos OXT y Samourai Wallet, concretamente la entropía de transacción. Esto es lo que estudiaremos en detalle en este capítulo.

A diferencia de los anonsets, que se calculan sobre un conjunto de transacciones, los indicadores que presentaremos aquí se centran exclusivamente en una única transacción, ya sea una coinjoin o una transacción más tradicional.

### El número de interpretaciones

El primer indicador que puede observarse en una transacción de Bitcoin es el número total de interpretaciones posibles a ojos de un observador externo que analice la transacción. Teniendo en cuenta los valores de los UTXO implicados en la transacción, este indicador indica el número de formas en que las entradas pueden asociarse con las salidas. En otras palabras, determina el número de interpretaciones posibles que una transacción puede generar en el flujo de bitcoins desde la perspectiva de un observador externo que la analice.

Por ejemplo, una operación de pago simple con 1 entrada y 2 salidas sólo tendrá una interpretación, a saber, que la entrada #0 financió la salida #0 y la salida #1. No hay otras interpretaciones posibles:

![BTC204](assets/fr/159.webp)

En cambio, un coinjoin estructurado según el modelo Whirlpool 5x5 tiene 1.496 combinaciones posibles:

![BTC204](assets/fr/160.webp)

Un coinjoin Whirlpool Surge Cycle 8x8 arroja 9.934.563 posibles interpretaciones:

![BTC204](assets/fr/161.webp)

### Entropía

A partir del número de interpretaciones de una transacción Bitcoin, podemos calcular su entropía.

En el contexto general de la criptografía y la información, la entropía es una medida cuantitativa de la incertidumbre o imprevisibilidad asociada a una fuente de datos o un proceso aleatorio. En otras palabras, la entropía es una forma de medir lo difícil que es predecir o adivinar la información.

En el contexto específico del análisis de cadenas, entropía es también el nombre de un indicador, derivado de la entropía de Shannon e [inventado por LaurentMT](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf), que puede calcularse sobre una transacción Bitcoin.

Cuando una transacción tiene un elevado número de interpretaciones posibles, suele ser más pertinente referirse a su entropía. Este indicador proporciona una medida del desconocimiento de los analistas sobre la configuración exacta de la transacción. En otras palabras, cuanto mayor es la entropía, más difícil resulta para los analistas identificar los flujos de bitcoins entre entradas y salidas.

En la práctica, la entropía revela si, desde la perspectiva de un observador externo, una transacción tiene múltiples interpretaciones posibles, basadas únicamente en las cantidades de entrada y salida, sin tener en cuenta otros patrones y heurísticos externos o internos. Por tanto, una entropía elevada es sinónimo de una mayor confidencialidad de la transacción.

La entropía se define como el logaritmo binario del número de combinaciones posibles. He aquí la fórmula utilizada con $E$ representando la entropía de la operación y $C$ el número de interpretaciones posibles:

$$
E = \log_2(C)
$$

En matemáticas, el logaritmo binario (logaritmo en base 2) corresponde a la operación inversa de elevar 2 a una determinada potencia. En otras palabras, el logaritmo binario de $x$ es el exponente al que hay que elevar $2$ para obtener $x$. Este indicador se expresa, pues, en bits.

Tomemos el ejemplo del cálculo de entropía para una transacción coinjoin estructurada según el modelo 5x5 Whirlpool, que, como se ha mencionado en la sección anterior, tiene un número de interpretaciones posibles de 1.496 $:

$$
\begin{align*}
C &= 1.496 \\
E &= \log_2(1.496) \\
E &= 10.5469 \text{ bit}
\end{align*}
$$

Así, esta transacción coinjoin muestra una entropía de 10,5469$ bits, lo que se considera muy satisfactorio. Cuanto mayor sea este valor, más interpretaciones diferentes admite la transacción, mejorando así su nivel de privacidad.

Para una transacción coinjoin 8x8 que tiene 9.934.563 interpretaciones, la entropía sería:

$$
\begin{align*}
C &= 9.934.563 \\
E &= \log_2(9.934.563) \\
E &= 23,244 \text{ bit}
\end{align*}
$$

Tomemos otro ejemplo con una operación de pago estándar, con 1 entrada y 2 salidas: [1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/fr/162.webp)

En el caso de esta transacción, la única interpretación posible es: `(In.0) > (Out.0 ; Out.1)`. En consecuencia, su entropía se fija en $0$:

$$
\begin{align*}
C &= 1 \\
E &= \log_2(1) \\
E &= 0 \text{ bit}
\end{align*}
$$

### Eficacia

A partir de la entropía de la transacción, también podemos calcular su eficacia en materia de privacidad. Este indicador evalúa la eficacia de la transacción comparándola con la transacción óptima concebible en una configuración idéntica.

Esto nos lleva a discutir el concepto de entropía máxima, que corresponde a la entropía más alta que una estructura de transacción específica podría alcanzar teóricamente. La eficiencia de la transacción se calcula entonces comparando esta entropía máxima con la entropía real de la transacción analizada.

La fórmula utilizada es la siguiente con:


- $E_R$: la entropía real de la transacción expresada en bits;
- $E_M$: la máxima entropía posible para una estructura de transacción también expresada en bits;
- $Ef$: la eficiencia de la transacción en bits:

$$
Ef = E_R - E_M
$$

Por ejemplo, para una estructura coinjoin de tipo Whirlpool 5x5, la entropía máxima es de 10,5469$:

$$
\begin{align*}
E_R &= 10,5469 \\
E_M &= 10,5469 \\
Ef &= E_R - E_M \\
Ef &= 10,5469 - 10,5469 \\
Ef &= 0 \text{ bit}
\end{align*}
$$

Este indicador también se expresa en porcentaje. La fórmula utilizada es la siguiente con:


- $C_R$: el número de interpretaciones reales posibles;
- $C_M$: el número máximo de interpretaciones posibles con la misma estructura;
- $Ef$: eficiencia expresada en porcentaje:

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1.496}{1.496} \\
E_f &= 100\%
\end{align*}
$$

Una eficiencia de $100\%$ indica, por tanto, que la transacción maximiza su potencial de privacidad en función de su estructura.

### La densidad de entropía

La entropía es un buen indicador para medir la privacidad de una transacción, pero depende en parte del número de entradas y salidas de la transacción. Para comparar la entropía de 2 transacciones diferentes que no tienen el mismo número de entradas y salidas, se puede calcular la densidad de entropía. Este indicador proporciona una perspectiva de la entropía relativa a cada entrada o salida de la transacción. La densidad resulta útil para evaluar y comparar la eficiencia de transacciones de distintos tamaños.

Para calcularla, basta con dividir la entropía total de la transacción por el número total de entradas y salidas implicadas en la transacción:


- $E_D$: la densidad de entropía expresada en bits;
- $E$: la entropía de la transacción expresada en bits;
- $T$: el número total de entradas y salidas de la transacción:

$$
E_D = \frac{E}{T}
$$

Tomemos el ejemplo de una unión por remolino de 5x5:

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ bit}
\end{align*}
$$

También calculamos la densidad de entropía de una coinjoin Whirlpool de 8x8:

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
E_D &= 1.453 \text{ bit}
\end{align*}
$$

Al analizar la densidad de entropía de estos dos tipos de coinjoins, se hace evidente que, incluso normalizando la entropía por el número de elementos, el coinjoin "Surge Cycle 8x8" genera más incertidumbre para el análisis.

### La puntuación Boltzmann

Otra información que se analiza en una operación es la puntuación de Boltzmann de cada elemento en relación con otro. Se trata de una tabla de probabilidades de correspondencia entre entradas y salidas. Esta tabla indica, a través de la puntuación de Boltzmann, la probabilidad condicional de que una entrada específica esté relacionada con una salida determinada. Se trata, pues, de una medida cuantitativa de la probabilidad condicional de que se produzca una asociación entre un input y un output en una operación, determinada en función de la relación entre el número de ocurrencias favorables de este evento y el número total de ocurrencias posibles, en un conjunto de interpretaciones.

Tomando el ejemplo de un coinjoin de Whirlpool, la tabla de probabilidades condicionales destacaría las posibilidades de enlace entre cada entrada y salida, proporcionando una medida cuantitativa de la ambigüedad de las asociaciones en la transacción:

| % | Salida 0 | Salida 1 | Salida 2 | Salida 3 | Salida 4 |

| ------- | -------- | -------- | -------- | -------- | -------- |

Aquí, está claro que cada entrada tiene la misma probabilidad de estar asociada a cualquier salida, lo que aumenta la confidencialidad de la transacción.

El cálculo de la puntuación de Boltzmann consiste en dividir el número de interpretaciones en las que se produce un determinado suceso por el número total de interpretaciones disponibles. Así, para determinar la puntuación asociando la entrada #0 con la salida #3 (un suceso presente en $512$ interpretaciones), el proceso es el siguiente:

$$
\begin{align*}
\text{Interpretazioni (IN.0 > OUT.3)} &= 512 \\
\text{Interpretazioni Totali} &= 1496 \\
\text{Punteggio} &= \frac{512}{1496} \\
\text{Punteggio} &= 34\%
\end{align*}
$$

Si reconsideramos el ejemplo de un ciclo Surge 8x8 Whirlpool coinjoin, la tabla de Boltzmann quedaría así:

| | OUT.0 | OUT.1 | OUT.2 | OUT.3 | OUT.4 | OUT.5 | OUT.6 | OUT.7 | OUT.7 |

| ---- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |

| EN.0 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| EN.1 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| EN.2 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| EN.3 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| EN.4 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| EN.5 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| EN.6 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| EN.7 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

Sin embargo, en el caso de una transacción simple con una sola entrada y 2 salidas, la situación es diferente:

| % | Salida 0 | Salida 1 |

| ------- | -------- | -------- |

| Entrada 0 | 100% | 100% |

Aquí, observamos que la probabilidad de que cada salida proceda de la entrada #0 es del 100%. Por tanto, una probabilidad más baja se traduce en una mayor privacidad al diluir los vínculos directos entre entradas y salidas.

### Enlaces deterministas

También es posible calcular el número de enlaces deterministas de una transacción. Este indicador revela cuántos enlaces entre entradas y salidas en la transacción analizada son incuestionables, con un 100% de probabilidad. Este indicador puede completarse calculando la proporción de enlaces deterministas. El ratio proporciona una perspectiva sobre el peso de estos enlaces deterministas dentro de todos los enlaces de la transacción.

Por ejemplo, una transacción de coinjoin de Whirlpool no muestra ningún vínculo determinista entre entradas y salidas, por lo que muestra un indicador de 0 vínculos y un ratio del 0%. Por el contrario, en nuestra segunda transacción de pago simple examinada (con una entrada y 2 salidas), el indicador nos dice que existen 2 vínculos deterministas y el ratio alcanza el 100%. Así pues, un indicador nulo señala una privacidad excelente debido a la ausencia de conexiones directas e indiscutibles entre entradas y salidas.

### ¿Cómo calcular estos indicadores?

Calcular manualmente estos indicadores utilizando las ecuaciones que he proporcionado es relativamente sencillo. La principal dificultad reside en determinar el número de interpretaciones posibles de una transacción. Para una transacción estándar, este cálculo puede hacerse a mano. Sin embargo, para una coinjoin, la tarea es bastante más compleja.

Anteriormente, existía una herramienta en Python llamada _Boltzmann Calculator_, desarrollada por los equipos de OXT y Samourai, que permitía calcular automáticamente todos estos indicadores para una transacción de Bitcoin:

![BTC204](assets/fr/163.webp)

También fue posible utilizar el sitio web KYCP.org para estos análisis:

![BTC204](assets/fr/164.webp)

Lamentablemente, tras la detención de los fundadores de Samourai, estas herramientas no están operativas en la actualidad.

Ahora que hemos discutido los coinjoins en detalle, exploraremos otras técnicas de privacidad disponibles en Bitcoin en la última sección de nuestra formación. Examinaremos transacciones payjoin, tipos específicos de transacciones pseudo-coinjoin, protocolos de direcciones estáticas, así como medidas para mejorar la privacidad no a nivel de transacción, sino a nivel de la red de nodos.

https://planb.network/tutorials/privacy/analysis/boltzmann-entropy-738e45af-18a6-4ce6-af1a-1bf58e15f1fe
# Comprender lo que está en juego con otras técnicas avanzadas de protección de la intimidad

<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Transacciones Payjoin

<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>

En la actualidad, coinjoin es el método más eficaz para introducir incertidumbre en el seguimiento de monedas durante un análisis en cadena. Como hemos visto en capítulos anteriores, para lograr una mezcla eficaz, las entradas y salidas deben ser lo más homogéneas posible. Además, es crucial que los coinjoins se integren en un grupo lo más grande posible para maximizar los anonsets. Así, para que las coinjoins sean eficaces, deben implicar a un gran número de monedas uniformes. Esta multitud de requisitos hace que las transacciones coinjoin tengan una estructura muy rígida: las cantidades están predeterminadas y todos los participantes deben atenerse a ellas para garantizar la uniformidad del proceso. Además, las coinjoins requieren la sincronización entre todos los participantes y el coordinador durante la construcción de la transacción.

Estos requisitos hacen que coinjoin no sea adecuado para pagos directos. Por ejemplo, si posees una pieza de 1M de sats en un pool de coinjoin, utilizarla directamente como pago sería complejo. Requeriría sincronización con otros participantes y con el coordinador para construir exactamente en el momento en que necesitas hacer un pago la transacción colaborativa, y el importe de la compra tendría que coincidir exactamente con el valor de tu pieza, lo que es prácticamente inviable. Por lo tanto, una transacción coinjoin es por naturaleza una transacción colaborativa de limpieza, lo que significa que generalmente son los mismos propietarios de las entradas los que están en las salidas.

Sin embargo, sería interesante disponer de estructuras de transacción que permitan realizar pagos prácticos introduciendo la duda en el análisis de la cadena. Esto es exactamente lo que exploraremos en este capítulo y en el siguiente.

### ¿Qué es una transacción payjoin?

Payjoin es una estructura de transacción Bitcoin específica que mejora la privacidad del usuario durante un gasto colaborando con el receptor del pago.

En 2015, LaurentMT mencionó por primera vez este método bajo el nombre de "transacciones esteganográficas", según un documento accesible [aquí](https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt). Esta técnica fue adoptada posteriormente por Samourai Wallet, que en 2018, fue el primer cliente en implementarla con la herramienta Stowaway. El concepto de payjoin también se encuentra en [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki) y [BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki). Así, se utilizan varios términos para designar un payjoin:


- Payjoin;
- Polizón;
- P2EP (_Pago por punto final_);
- Transacción esteganográfica.

La singularidad del payjoin radica en su capacidad para generar una transacción que parece ordinaria a primera vista, pero que en realidad es un mini Coinjoin entre dos personas. Para ello, la estructura de la transacción incluye al receptor del pago en las entradas junto con el emisor real. A continuación, el receptor incluye un pago a sí mismo en medio de la transacción que le permite cobrar.

Pongamos un ejemplo para entender mejor este proceso. Alice compra una baguette por 4.000 sats utilizando un UTXO de 10.000 sats y opta por un payjoin. Su panadero, Bob, añade un UTXO propio de 15.000 sats en la entrada, que recupera íntegramente en la salida, además de los 4.000 sats de Alice.

En el ejemplo, Bob el panadero entra con 15.000 sats y sale con 19.000 sats, la diferencia es exactamente de 4.000 sats, que es el precio de la baguette. Por su parte, Alice entra con 10.000 sats y sale con 6.000 sats, lo que representa un saldo de -4.000 sats, que es el precio de la baguette. Para simplificar el ejemplo, he omitido deliberadamente las tasas de minería en esta transacción.

### ¿Para qué sirve el payjoin?

La transacción payjoin cumple dos objetivos que permiten a los usuarios mejorar la privacidad de su pago.

En primer lugar, el payjoin pretende engañar a un observador externo creando una desviación en el análisis de la cadena. Esto es posible gracias a la _Heurística de Propiedad Común de Entradas_ (CIOH). Como vimos en la Parte 3, normalmente cuando una transacción en la blockchain tiene múltiples entradas, se asume que todas estas entradas pertenecen a la misma entidad o usuario.

Así, cuando un analista examina una transacción payjoin, se le hace creer que todas las entradas proceden de la misma persona. Sin embargo, esta percepción es incorrecta, ya que el beneficiario también contribuye con entradas junto con el pagador real. El análisis de la cadena se inclina así hacia una interpretación que resulta ser falsa.

Volvamos a nuestro ejemplo de una transacción payjoin para pagar una baguette:

Viendo esta transacción en la blockchain, un observador externo que siguiera la heurística habitual del análisis de cadenas la interpretaría así: "Alice unió 2 UTXOs en la entrada de transacciones para pagar 19.000 sats a Bob"

Esta interpretación es claramente errónea; como ya sabes, los dos UTXO de entrada no pertenecen a la misma persona. Uno es de Alice, la compradora de baguettes, y el otro es de Bob, el panadero.

De este modo, el análisis del observador externo se orienta hacia una conclusión errónea, lo que garantiza la preservación de la confidencialidad de las partes interesadas.

### La transacción esteganográfica

El segundo objetivo del payjoin es engañar a un observador externo sobre el importe real del pago efectuado. Examinando la estructura de la transacción, el analista podría creer que el pago equivale al importe de una de las salidas.

Si tomamos nuestro ejemplo de la compra de una baguette, el analista pensará que el importe del pago corresponde al UTXO de 6.000 sats o al UTXO de 19.000 sats. En este caso, es más probable que el analista piense que el importe del pago es de 19.000 sats porque hay 2 UTXOs en la salida, al menos uno de los cuales es superior a 6.000 sats (no hay ninguna razón lógica para utilizar 2 UTXOs para pagar 6.000 sats cuando un único UTXO habría sido suficiente para este pago).

Pero en realidad, este análisis es incorrecto. El importe del pago no coincide con ninguna de las salidas. En realidad es la diferencia entre el UTXO del beneficiario de salida y el UTXO del beneficiario de entrada.

En este sentido, la transacción payjoin entra en el ámbito de la esteganografía. Permite ocultar el importe real de una transacción dentro de una transacción falsa que sirve de distracción.

La esteganografía es una técnica para ocultar información dentro de otros datos u objetos de forma que la presencia de la información oculta no sea perceptible. Por ejemplo, se puede ocultar un mensaje secreto dentro de un punto en un texto no relacionado, haciéndolo indetectable a simple vista (es la técnica del [micropunto](https://fr.wikipedia.org/wiki/Micropoint)).

A diferencia del cifrado, que hace ininteligible la información sin la clave de descifrado, la esteganografía no altera la información. Permanece a la vista. Su objetivo es más bien ocultar la existencia misma del mensaje secreto, mientras que la criptografía revela claramente la presencia de información oculta, aunque inaccesible sin la clave. Por eso el nombre inicial de payjoin era "transacciones esteganográficas"

Se podría establecer una analogía entre la criptografía y el coinjoin, así como entre la esteganografía y el payjoin. De hecho, el coinjoin tiene atributos similares a los de la criptografía: el método es reconocible, pero la información es indescifrable. En cambio, el payjoin es similar a la esteganografía: la información es teóricamente accesible, pero como su método de ocultación no es reconocible, resulta inaccesible.

### ¿Cómo utilizar payjoin?

Entre los programas conocidos que admiten payjoin se encuentran Sparrow Wallet, Wasabi Wallet, Mutiny, BitMask, BlueWallet y JoinMarket, así como el procesador de pagos BTCPay.

La implementación más avanzada de payjoin era sólo el Stowaway en Samourai Wallet. Sin embargo, desde el cierre de los fundadores del software, esta herramienta ahora sólo funciona parcialmente. La ventaja del Stowaway es que es un protocolo completo y muy fácil de usar que soporta tanto la recepción como el envío de payjoins. Las transacciones parcialmente firmadas pueden intercambiarse manualmente escaneando varios códigos QR o automáticamente a través de Tor vía Soroban. Es esta última opción de comunicación la que no está actualmente en servicio.

La dificultad de utilizar payjoin radica en su dependencia de la participación del comerciante. Como cliente, utilizar payjoin es imposible si el comerciante no lo admite. Esto añade una dificultad adicional durante una compra: no sólo es complicado encontrar comercios que acepten bitcoin, sino que si además buscas los que admiten payjoins, la cosa se complica aún más.

Una solución podría ser el uso de estructuras transaccionales que introduzcan ambigüedad en el análisis de la cadena sin requerir la cooperación del receptor. Esto nos permitiría mejorar la privacidad de nuestros pagos sin depender de la participación activa de los comerciantes. Esto es precisamente lo que estudiaremos en el próximo capítulo.

https://planb.network/tutorials/privacy/on-chain/payjoin-sparrow-wallet-087a0e49-61cd-41f5-8440-ac7b157bdd62
https://planb.network/tutorials/privacy/on-chain/payjoin-samourai-wallet-48a5c711-ee3d-44db-b812-c55913080eab
## Pago de minicupones

<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>

Cuando se busca realizar una transacción de pago preservando cierto grado de privacidad, payjoin es una buena opción. Pero como hemos visto, payjoin requiere la participación del destinatario. Entonces, ¿qué hacer si éste se niega a participar en un payjoin, o si simplemente prefieres no involucrarle? Una alternativa es utilizar una transacción Stonewall o Stonewall x2. Echemos un vistazo más de cerca a estos dos tipos de transacciones.

### La transacción Stonewall

Stonewall es una forma específica de transacción Bitcoin destinada a aumentar la privacidad del usuario durante una compra imitando un pseudo-coinjoin entre dos personas, pero sin serlo realmente. De hecho, esta transacción no es colaborativa. Un usuario puede construirla por sí mismo, involucrando sólo los UTXOs que posee como entrada. Así, puede crear una transacción Stonewall para cualquier ocasión, sin necesidad de sincronizarse con otro usuario o con el destinatario.

El funcionamiento de la transacción Stonewall es el siguiente: en la entrada de la transacción, el emisor utiliza 2 UTXOs que le pertenecen. En la salida, la transacción produce 4 UTXOs, 2 de los cuales serán exactamente de la misma cantidad. Los otros 2 UTXOs constituirán el resto. Entre las 2 salidas del mismo importe, sólo una irá realmente al receptor del pago.

Sólo hay 2 papeles en una transacción Stonewall:


- El remitente, que efectúa el pago;
- El destinatario, que puede desconocer la naturaleza específica de la transacción y simplemente espera el pago del remitente.

Pongamos un ejemplo para entender esta estructura de transacción. Alice está en la panadería de Bob para comprar su baguette, que cuesta 4.000 sats. Quiere pagar en bitcoin manteniendo cierto nivel de privacidad sobre su pago. Por lo tanto, decide construir una transacción Stonewall para el pago.

Analizando esta transacción, podemos ver que Bob, el panadero, recibió en realidad 4.000 sats como pago por la baguette. Alice utilizó 2 UTXOs como entradas: uno de 10.000 sats y otro de 15.000 sats. En los outputs, recibió 3 UTXOs: uno de 4.000 sats, uno de 6.000 sats y uno de 11.000 sats. Alice tiene por tanto un saldo neto de -4.000 sats en esta transacción, que es exactamente igual al precio de la baguette.

En este ejemplo, he omitido intencionadamente las comisiones de minería para facilitar la comprensión. En realidad, las comisiones de transacción corren totalmente a cargo del remitente.

### ¿Cuáles son los objetivos de una transacción Stonewall?

La estructura Stonewall añade mucha entropía a la transacción y confunde los rastros del análisis de la cadena. Desde fuera, una transacción de este tipo puede interpretarse como una minicadena entre dos personas. Pero, en realidad, se trata de un pago. Así pues, este método genera incertidumbres en el análisis de la cadena, o incluso conduce a trazas falsas.

Volvamos al ejemplo de Alicia en casa de Bob el Panadero. La transacción en la cadena de bloques tendría este aspecto:

![BTC204](assets/fr/174.webp)

Un observador externo que se base en la heurística común del análisis de cadenas podría concluir erróneamente que "_dos personas hicieron un pequeño coinjoin, con un UTXO cada una en la entrada y dos UTXOs cada una en la salida_" El análisis de esta transacción desde el exterior no conduce a la aplicación de la heurística de propiedad común de entrada (CIOH), porque la presencia de dos salidas de la misma cantidad sugiere un patrón coinjoin. Por lo tanto, desde una perspectiva externa, la CIOH no se aplica en este caso concreto.

![BTC204](assets/fr/175.webp)

Esta interpretación es inexacta, porque, como usted sabe, un UTXO fue enviado a Bob el Panadero, los 2 UTXOs en entrada vinieron de Alice, y ella recuperó 3 salidas de descanso.

![BTC204](assets/fr/176.webp)

Y lo que resulta especialmente interesante de la estructura de la transacción Stonewall es que, desde la perspectiva de un observador externo, parece exactamente igual a la de una transacción Stonewall x2.

### La transacción Stonewall x2

Stonewall x2 es otra forma específica de transacción Bitcoin que también pretende aumentar la privacidad del usuario durante un gasto, pero esta vez colaborando con un tercero no implicado en el gasto. Este método funciona como un pseudo-coinjoin entre dos participantes mientras realizan un pago a un tercero.

El funcionamiento de la transacción Stonewall x2 es relativamente sencillo: uno utiliza un UTXO en su posesión para realizar el pago y consigue la ayuda de un tercero que también aporta un UTXO propio. La transacción termina con cuatro salidas: dos de ellas de igual importe, una va a la dirección del receptor del pago y la otra a una dirección perteneciente al contribuyente. Un tercer UTXO se envía a otra dirección del contribuyente, lo que le permite recuperar la cantidad inicial (una acción neutra para él, menos las tasas de minería), y un último UTXO vuelve a una dirección que nos pertenece, lo que constituye el resto del pago.

Así, en las transacciones Stonewall x2 se definen tres papeles diferentes:


- El remitente, que realiza el pago efectivo;
- El destinatario, que puede desconocer la naturaleza específica de la transacción y simplemente espera el pago del remitente;
- El colaborador, que aporta bitcoin para sembrar la duda en el análisis de la transacción, recupera íntegramente sus fondos al final (una acción neutra para él, neta de comisiones de minado).

Volvamos a nuestro ejemplo de Alicia, que está en casa de Bob el Panadero para comprar una baguette que cuesta 4.000 sats. Quiere pagar en bitcoin manteniendo cierto nivel de privacidad sobre su pago. Así que llama a su amigo Charles, que le ayudará en el proceso.

![BTC204](assets/fr/177.webp)

Analizando esta transacción, podemos ver que Bob, el panadero, recibió en realidad 4.000 sats como pago por la baguette. Alice utilizó 10.000 sats en la entrada y recuperó 6.000 sats en la salida, lo que arroja un saldo neto de -4.000 sats, que corresponde al precio de la baguette. En cuanto a Charles, proporcionó 15.000 sats de entrada y recibió dos salidas: una de 4.000 sats y otra de 11.000 sats, lo que arroja un saldo de 0.

En este ejemplo, he omitido intencionadamente las comisiones para facilitar la comprensión. En realidad, las comisiones mineras suelen repartirse a partes iguales entre el emisor del pago y el contribuyente.

### ¿Cuáles son los objetivos de una transacción Stonewall x2?

Al igual que la estructura Stonewall, la estructura Stonewall x2 añade una cantidad significativa de entropía a la transacción y oculta las huellas del análisis de la cadena. Desde un punto de vista externo, una transacción de este tipo podría interpretarse como una pequeña coinjoin entre dos personas. Pero, en realidad, se trata de un pago. Este método, por tanto, genera incertidumbres en el análisis de la cadena, lo que también conduce a trazas falsas.

Repasemos el ejemplo de Alicia, Bob el Panadero y Carlos. La transacción en la cadena de bloques tendría este aspecto:

![BTC204](assets/fr/178.webp)

Un observador externo que se basara en la heurística común del análisis en cadena podría concluir erróneamente que "_Alice y Charles realizaron un pequeño coinjoin, con un UTXO cada uno en la entrada y dos UTXOs cada uno en la salida_" De nuevo, analizar esta transacción desde fuera no conduce a la aplicación de la heurística de propiedad común de entrada (CIOH), porque la presencia de dos salidas de la misma cantidad sugiere un patrón coinjoin. Por lo tanto, desde una perspectiva externa, la CIOH no se aplica en este caso concreto.

![BTC204](assets/fr/179.webp)

Esta interpretación es inexacta porque, como sabes, se envió un UTXO a Bob el Panadero, Alicia sólo tiene una salida de descanso y Carlos tiene dos.

![BTC204](assets/fr/180.webp)

Y de nuevo, lo que es particularmente interesante con la estructura de la transacción Stonewall x2 es que desde la perspectiva de un observador externo, se ve exactamente como la de una transacción Stonewall.

### ¿Cuál es la diferencia entre Stonewall y Stonewall x2?

Una transacción StonewallX2 funciona exactamente igual que una transacción Stonewall, salvo que la primera es colaborativa, mientras que la segunda no lo es. Como hemos visto, una transacción Stonewall x2 implica la participación de un tercero (Charles), externo al pago, que aporta sus bitcoins para aumentar la confidencialidad de la transacción. En una transacción Stonewall clásica, el papel del contribuyente lo asume el remitente.

![BTC204](assets/fr/181.webp)

Desde un punto de vista externo, por tanto, el modelo de transacción es exactamente el mismo.

El hecho de que estas dos estructuras de transacciones compartan exactamente el mismo patrón implica que, aunque un observador externo pueda identificar un patrón "Stonewall(x2)", no dispondrá de toda la información. No podrá determinar cuál de los dos UTXO de los mismos importes corresponde al pago. Tampoco podrá determinar si los dos UTXO de entrada proceden de dos personas distintas (Stonewall x2) o si pertenecen a una única persona que los ha unido (Stonewall).

Esto último se debe a que las transacciones Stonewall x2 siguen exactamente el mismo patrón que las transacciones Stonewall. Desde fuera y sin información contextual adicional, es imposible diferenciar una transacción Stonewall de una transacción Stonewall x2. Sin embargo, las primeras no son transacciones en colaboración, mientras que las segundas sí lo son. Esto añade aún más dudas al análisis de una de estas transacciones.

### ¿Cuándo utilizar las transacciones Stonewall y Stonewall x2?

La lógica debería ser la siguiente cuando se desea utilizar una herramienta de privacidad para una transacción:


- Como prioridad, puede optar por hacer un payjoin;
- Si el comerciante no admite payjoins, se puede realizar una transacción colaborativa con otra persona al margen del pago utilizando la estructura Stonewall x2;
- Si no puede encontrar a nadie con quien realizar una transacción Stonewall x2, puede realizar una transacción Stonewall por su cuenta, que imitará el comportamiento de una transacción Stonewall x2.

### ¿Cómo utilizar las transacciones Stonewall y Stonewall x2?

Las transacciones Stonewall y Stonewall x2 están disponibles tanto en la aplicación Samourai Wallet como en el software Sparrow Wallet.

Sin embargo, al igual que con los payjoins, tras la detención de los fundadores de Samourai, las transacciones Stonewall x2 ahora sólo funcionan mediante el intercambio manual de PSBT entre las partes implicadas. Lamentablemente, el intercambio automático a través de Soroban no está disponible por el momento.

También puede realizar este tipo de transacción manualmente desde cualquier software de monedero Bitcoin.

En el próximo capítulo, estudiaremos otra técnica de privacidad relativamente desconocida pero muy útil, además de lo que ya hemos estudiado.

https://planb.network/tutorials/privacy/on-chain/stonewall-033daa45-d42c-40e1-9511-cea89751c3d4
https://planb.network/tutorials/privacy/on-chain/stonewall-x2-05120280-f6f9-4e14-9fb8-c9e603f73e5b
## Rebotes

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>

El uso de estructuras de transacción Bitcoin que añaden ambigüedad en el análisis de la cadena, como coinjoin, es particularmente beneficioso para la protección de la privacidad. Sin embargo, como comentamos en el capítulo sobre payjoins, las transacciones coinjoin son naturalmente identificables en la cadena. Recuerde la analogía que establecimos entre la criptografía y los coinjoins: al cifrar un archivo, un tercero que descubra este archivo cifrado no puede acceder a su contenido, pero puede identificar claramente que ha habido una modificación del archivo para ocultar su contenido. Lo mismo ocurre con las coinjoins: cuando un analista examina una transacción coinjoin, aunque no pueda establecer vínculos directos entre entradas y salidas (y viceversa), puede reconocer que la transacción observada es una coinjoin.

Dependiendo del uso previsto de su moneda después de someterse a ciclos de coinjoin, el hecho de que haya sufrido este proceso puede ser problemático. Por ejemplo, si planeas vender tu moneda en una plataforma de intercambio regulada, pero ha sufrido recientemente un coinjoin, la herramienta de análisis de la cadena de la plataforma detectará este hecho. La plataforma puede entonces negarse a aceptar su UTXO que ha sufrido un coinjoin, o incluso pedirle explicaciones, con el riesgo de que su cuenta sea suspendida o sus fondos congelados. En algunos casos, la plataforma también puede denunciar su comportamiento a las autoridades estatales (por ejemplo, esto es lo que TRACFIN exige a los Proveedores de Servicios de Activos Digitales (PSAN) en Francia).

Lo que necesitaríamos para evitar esto es una herramienta capaz de difuminar las huellas del pasado de una moneda Bitcoin con el fin de restaurar alguna forma de fungibilidad. Este es precisamente el objetivo de Ricochet.

### ¿Qué es un rebote?

Ricochet es una técnica que consiste en realizar varias transacciones ficticias a uno mismo (barrido) para simular una transferencia de propiedad de bitcoin. Esta herramienta se diferencia de otras estructuras de transacción que hemos analizado porque no permite un anonimato prospectivo, sino más bien una forma de anonimato retrospectivo. De hecho, el rebote permite difuminar las especificidades que podrían comprometer la fungibilidad de una moneda bitcoin debido a su pasado.

Para ofuscar la huella dejada por un evento pasado en una moneda, como los ciclos de coinjoin, por ejemplo, ricochet realiza cuatro transacciones sucesivas en las que el usuario se transfiere fondos a sí mismo en diferentes direcciones.

Tras esta secuencia de transacciones, la herramienta de rebote encamina finalmente los bitcoins a su destino final como plataforma de intercambio.

El objetivo es crear una distancia que afecte a la fungibilidad de la moneda, como una transacción coinjoin, y el acto final de gasto que podría rechazar esta moneda debido a su pasado. Así, las herramientas de análisis en cadena podrían llegar a la conclusión de que probablemente se produjo un cambio de titularidad después del acto, y considerar que esta moneda es fungible. En el caso de un coinjoin, las herramientas de análisis de la cadena podrían entonces asumir que no es la misma persona la que envió los bitcoins y ejecutó el coinjoin, y por lo tanto es inútil iniciar acciones contra el remitente.

### ¿Por qué funciona?

Ante este método de rebote, cabría imaginar que los programas informáticos de análisis de cadenas profundizaran en su examen más allá de los cuatro saltos. Sin embargo, estas plataformas se enfrentan a un dilema a la hora de optimizar el umbral de detección. Necesitan fijar un límite en el número de saltos a partir del cual admiten que probablemente se ha producido un cambio de propiedad y que debe ignorarse el vínculo con un evento anterior (como un coinjoin).

Sin embargo, determinar este umbral resulta arriesgado: cada ampliación del número observado de omisiones aumenta exponencialmente el volumen de falsos positivos, es decir, personas incorrectamente marcadas como participantes en un evento cuando la transacción fue realizada por otra persona. Este escenario supone un mayor riesgo para estas empresas, ya que los falsos positivos provocan insatisfacción, lo que puede llevar a los clientes afectados a la competencia. A largo plazo, un umbral de detección demasiado grande lleva a una plataforma a perder más clientes que sus competidores, lo que podría amenazar su supervivencia. Por ello, es complicado para estas plataformas aumentar el número de saltos observados, y 4 suele ser un número suficiente para contrarrestar su análisis.

El fenómeno observado aquí es en cierto modo análogo a la teoría de los seis grados de separación.

La teoría de los seis grados de separación sugiere que cualquier persona de la Tierra está conectada con cualquier otra a través de una cadena de conocimiento que no incluye más de seis intermediarios. Bastaría con pasar por una serie de seis personas, cada una de las cuales conociera personalmente a la siguiente, para llegar a cualquier individuo del mundo.

En el caso de las transacciones de Bitcoin, se da un fenómeno similar. Al rastrear un número suficiente de transacciones de Bitcoin, inevitablemente se acaba encontrando un coinjoin. El método ricochet explota este principio utilizando más saltos de los que las plataformas de intercambio pueden seguir razonablemente. Si las plataformas deciden seguir más transacciones, entonces es posible simplemente añadir un salto adicional para eludir esta medida.

### ¿Cuándo y cómo utilizar el rebote?

El caso de uso más común para el rebote se produce cuando es necesario ocultar la participación previa en un coinjoin en un UTXO que se posee. Idealmente, lo mejor es evitar transferir bitcoins que hayan sufrido un coinjoin a entidades reguladas. Sin embargo, en el caso de que uno se encuentre sin otras opciones, especialmente en la urgencia de liquidar bitcoin en moneda fiduciaria, ricochet ofrece una solución eficaz.

Este método es eficaz no sólo para las uniones de monedas, sino también para cualquier otra marca que pueda comprometer la fungibilidad de una moneda.

La idea de este método de rebote surgió originalmente de los equipos de Samourai Wallet, que lo integraron en su aplicación para automatizar el proceso. El servicio en Samourai es de pago, ya que un rebote conlleva una tasa de servicio de 100.000 sats, además de las tasas de minería. Por tanto, su uso es más bien recomendable para transferencias de importes significativos.

La aplicación Samourai ofrece dos variaciones del rebote:


- Rebote avanzado, o "entrega escalonada", que tiene la ventaja de repartir las comisiones de servicio de Samourai en cinco transacciones sucesivas. Esta opción también garantiza que cada transacción se transmita en un momento distinto y se registre en un bloque diferente, lo que permite imitar lo más fielmente posible el comportamiento de un cambio de titularidad. Aunque más lento, este método es preferible para los que no tienen prisa, ya que maximiza la eficacia del rebote reforzando su resistencia al análisis en cadena;
- El clásico rebote, que está diseñado para realizar la operación rápidamente transmitiendo todas las transacciones en un corto periodo de tiempo. Este método, por lo tanto, ofrece menos privacidad y menos resistencia al análisis que el método avanzado. Sólo debe utilizarse para envíos urgentes.

El ricochet consiste simplemente en enviarse bitcoin a uno mismo. Es totalmente posible realizar un ricochet manualmente en cualquier software de monedero, sin necesidad de utilizar una herramienta especializada. Simplemente transfiérete la misma moneda a ti mismo más tarde, utilizando una nueva dirección vacía cada vez.

En el capítulo siguiente, exploramos varias técnicas de transferencia secreta de la propiedad. Estos métodos difieren radicalmente de los que hemos examinado hasta ahora, tanto en su funcionamiento como en sus resultados.

https://planb.network/tutorials/privacy/on-chain/ricochet-e0bb1afe-becd-44a6-a940-88a463756589
## Transferencias secretas de propiedad

<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>

Entre las técnicas de privacidad en bitcoin está la transferencia secreta de propiedad. Este método tiene como objetivo transferir la propiedad de bitcoins de una persona a otra, y viceversa, sin que esta transacción sea explícitamente visible en la blockchain. Estudiemos juntos las diferentes técnicas disponibles, así como sus ventajas e inconvenientes.

### Canje de monedas

CoinSwap se basa en un concepto relativamente sencillo: utiliza contratos inteligentes para facilitar una transferencia de propiedad de bitcoins entre dos usuarios, sin necesidad de confianza y sin que esta transferencia sea explícitamente visible en la blockchain.

Imaginemos un ejemplo simplificado con Alice y Bob. Alice tiene 1 BTC asegurado con la clave privada $A$, y Bob también tiene 1, asegurado con la clave privada $B$. En teoría, podrían intercambiar sus claves privadas a través de un canal de comunicación externo para realizar una transferencia secreta.

Sin embargo, este método ingenuo presenta un alto riesgo en términos de confianza. Nada impide que Alice conserve una copia de la clave privada $A$ después del intercambio y la utilice más tarde para robar bitcoins una vez que la clave esté en posesión de Bob.

Además, no existe ninguna garantía que impida a Alice recibir la clave privada $B$ de Bob y no enviar nunca su clave privada $A$ a cambio. Este intercambio, por tanto, se basa en una confianza excesiva entre las partes y resulta ineficaz para garantizar una transferencia secreta de propiedad de forma segura.

Para resolver estos problemas y permitir intercambios entre partes que no confían entre sí, podemos utilizar en su lugar sistemas de contratos inteligentes. Un contrato inteligente es un programa que se ejecuta automáticamente cuando se cumplen unas condiciones predefinidas, lo que, en nuestro caso, garantiza que el intercambio de bienes se produzca automáticamente sin necesidad de confianza mutua.

Para ello, podemos utilizar HTLC (_Hash Time-Locked Contracts_) o PTLC (_Point Time-Locked Contracts_). Estos dos protocolos funcionan de forma similar utilizando un sistema de bloqueo temporal que garantiza que el intercambio se complete con éxito o se cancele por completo, protegiendo así la integridad de los fondos de ambas partes. La principal diferencia entre HTLC y PTLC es que los HTLC utilizan hashes y preimágenes para asegurar la transacción, mientras que los PTLC utilizan firmas adaptativas.

En un escenario CoinSwap que utilice un HTLC o un PTLC entre Alice y Bob, el intercambio se produce de forma segura: o bien tiene éxito, y cada uno recibe el BTC del otro, o bien falla, y cada uno conserva su propio BTC. Por tanto, es imposible que cualquiera de las partes haga trampas o robe el BTC de la otra.

> los HTLC son también el mecanismo utilizado para encaminar los pagos de forma segura a través de los canales bidireccionales de la Lightning Network
> El uso de firmas adaptativas es especialmente interesante en este contexto, ya que permite eludir los scripts tradicionales (se trata de un mecanismo a veces denominado "_scriptless scripts_"). Esta característica ayuda a reducir las comisiones asociadas al intercambio. Otra gran ventaja de las firmas adaptativas es que no requieren el uso de un hash común para ambas partes de la transacción, lo que evita revelar un vínculo directo entre ellas en determinados tipos de intercambios.
### Firmas adaptativas

Las firmas adaptativas son un método criptográfico que integra una firma válida con una firma adicional, denominada "firma adaptativa", para revelar un dato secreto. Este mecanismo está diseñado de tal manera que conocer 2 de los 3 elementos siguientes: la firma válida, la firma adaptativa y el secreto, permite deducir el tercer elemento que falta. Una propiedad interesante de este método es que si conocemos la firma adaptativa de nuestra contraparte y el punto específico de la curva elíptica asociado al secreto utilizado para calcular esta firma adaptativa, podemos deducir nuestra propia firma adaptativa que será compatible con ese mismo secreto, sin tener nunca acceso directo al propio secreto.

En los intercambios de monedas, el uso de Firmas Adaptativas permite la divulgación simultánea de dos piezas de información sensible entre los participantes, evitando así la necesidad de confianza mutua. Tomemos un ejemplo para ilustrar este proceso con Alice y Bob, que desean intercambiar la propiedad de 1 BTC cada uno, pero no confían el uno en el otro. Utilizan Firmas Adaptativas para eliminar la necesidad de confianza en este intercambio. Así es como proceden:


- Alice inicia el intercambio creando una transacción $m_A$ que envía 1 BTC a Bob. Ella genera una firma $s_A$, que valida esta transacción, usando su clave privada $p_A$ ($P_A = p_A \cdot G$), un nonce $n_A$ ($N_A = n_A \cdot G$), y un secreto $t$ ($T = t \cdot G$):

$$s_A = n_A + t + H(N_A + T \paralelo P_A \paralelo m_A) \cdot p_A$$


- Alice calcula la firma adaptativa $s_A'$ restando el secreto $t$ de su firma verdadera $s_A$:

$$s_A' = s_A - t$$


- Alice envía a Bob su firma adaptativa $s'_A$, su transacción sin firma $m_A$, el punto correspondiente al secreto ($T$), y el punto correspondiente al nonce ($N_A$). Estos elementos constituyen lo que se denomina un "_adaptador_" Es importante señalar que con sólo esta información, Bob no puede recuperar el BTC de Alice.
- Sin embargo, Bob tiene la capacidad de verificar que Alice no está intentando robarle. Para ello, comprueba si la firma adaptativa $s_A'$ de Alice coincide realmente con la transacción propuesta $m_A$. Si la siguiente ecuación es correcta, puede estar seguro de que la firma adaptativa de Alice es válida:

$$s_A' \cdot G = N_A + H(N_A + T \paralelo P_A \paralelo m_A) \cdot P_A$$


- Esta verificación proporciona a Bob la seguridad suficiente para proceder al intercambio con confianza. A continuación, crea su propia transacción $m_B$, destinada a enviar 1 BTC a Alice, y genera su firma adaptativa $s_B'$, que también estará vinculada al mismo secreto $t$. En este punto, sólo Alice conoce el valor de $t$; Bob sólo conoce el punto correspondiente $T$ que Alice le transmitió:

$$s_B' = n_B + H(N_B + T \paralelo P_B \paralelo m_B) \cdot p_B$$


- Bob transmite a Alice su firma adaptativa $s_B'$, su transacción sin firma $m_B$, así como el punto correspondiente al secreto ($T$) y el punto correspondiente al nonce ($N_B$). Alice, que conoce el secreto $t$, puede ahora combinar la firma adaptativa $s_B'$ de Bob con este secreto para generar una firma $s_B$ válida para la transacción $m_B$ que le transferirá el BTC de Bob:

$$s_B = s_B' + t$$

$$(s_B' + t) \cdot G = N_B + T + H(N_B + T \paralelo P_B \paralelo m_B) \cdot P_B$$


- Alice transmite esta transacción firmada $m_B$ en la blockchain de Bitcoin para recuperar los BTC prometidos por Bob. Cuando Bob ve esta transacción en la blockchain, puede extraer la firma $s_B = s_B' + t$. Con esta información, Bob puede aislar el famoso secreto $t$ que necesitaba:

$$t = (s_B' + t) - s_B' = s_B - s_B'$$


- Y de hecho, este secreto $t$ era el único elemento que le faltaba a Bob para generar la firma válida $s_A$ a partir de la firma adaptadora $s_A'$ de Alice. Esta firma permite validar la transacción $m_A$ que envía un BTC de Alice a Bob. Bob computa entonces $s_A$ y a su vez transmite la transacción $m_A$ en la blockchain:

$$s_A = s_A' + t$$

$$(s_A' + t) \cdot G = N_A + T + H(N_A + T \paralelo P_A \paralelo m_A) \cdot P_A$$

Resumamos cómo funciona un Adaptador de Firma en un intercambio de monedas. Inicialmente, Alice envía a Bob una transacción sin firmar junto con un adaptador, que permite a Bob verificar que el secreto revelado más tarde le dará acceso a bitcoins. A cambio, Bob envía a Alice su transacción sin firmar y su adaptador. Alice puede entonces finalizar la transacción de Bob y recuperar los bitcoins transmitiendo una transacción válida utilizando el secreto. Cuando esta transacción se publica en la blockchain, Bob tiene la capacidad de extraer el secreto y desbloquear así la transacción de Alice. En consecuencia, si Alice inicia una transferencia de los bitcoins de Bob, éste puede, a su vez, acceder a los bitcoins de Alice sin necesidad de confianza mutua.

Es importante señalar que las bolsas de monedas fueron propuestas por primera vez por [Gregory Maxwell en octubre de 2013 en BitcoinTalk](https://bitcointalk.org/index.php?topic=321228.0).

### La Bolsa Atómica

De forma similar al intercambio de monedas y utilizando los mismos tipos de contratos inteligentes, también es posible realizar intercambios atómicos. Un intercambio atómico permite un intercambio directo de diferentes criptomonedas, como BTC y XMR, entre dos usuarios sin requerir confianza o la intervención de un intermediario. Estos intercambios se denominan intercambios "atómicos" porque sólo tienen dos resultados posibles: o bien el intercambio tiene éxito y ambas partes quedan satisfechas, o bien fracasa y cada uno conserva sus criptodivisas originales, eliminando así la necesidad de confiar en la otra parte.

![BTC204](assets/fr/197.webp)

El intercambio atómico y el intercambio de monedas comparten un método similar de funcionamiento y ofrecen las mismas ventajas y desventajas en términos de privacidad. De hecho, desde la perspectiva de Bitcoin, un intercambio atómico es comparable a un intercambio de monedas realizado en dos pasos. En primer lugar, cambiamos nuestro BTC por otra criptodivisa, y después esta criptodivisa puede cambiarse por otros BTC. Por último, recuperamos el BTC de otro usuario. Por eso, en el análisis de los problemas de privacidad, agrupo estos dos protocolos en la categoría de intercambios secretos de propiedad.

![BTC204](assets/fr/198.webp)

Sin embargo, a diferencia del intercambio de monedas, el intercambio atómico puede tener desequilibrios en términos de liquidez disponible, especialmente en los intercambios BTC/XMR. Por lo general, es más fácil intercambiar bitcoin por altcoin porque existe una gran demanda de bitcoin, lo que mantiene bajas las primas para esta dirección de conversión. Sin embargo, intercambiar altcoin para obtener BTC puede ser más complejo debido a la menor demanda, lo que a menudo se traduce en primas muy elevadas.

Por último, cuando un intercambio atómico implica bitcoin onchain y bitcoin en la red Lightning, nos referimos a él como un "_intercambio sumergible_"

### ¿Es realmente útil?

Las transferencias secretas de propiedad, como los intercambios de monedas y los intercambios atómicos, tienen la ventaja de engañar a la heurística de análisis de cadenas. Estos métodos pueden dar la impresión de que las transacciones implican al mismo usuario, aunque la propiedad real haya cambiado de manos. Sin embargo, la principal desventaja de estos métodos es que son muy arriesgados si no se utiliza una técnica adicional para alterar el historial de monedas.

En efecto, cuando Alice realiza un intercambio de monedas o un swap atómico con Bob, intercambia la propiedad de sus bitcoins por los bitcoins de Bob. En el caso de un intercambio atómico, el intercambio incluye una altcoin, pero el principio sigue siendo el mismo. Así, Alice termina con la moneda $B$ y Bob con la moneda $A$. Esto añade dudas en el análisis de la cadena, pero la historia de las monedas sigue siendo rastreable. Si un analista examina la moneda $A$, puede rastrear las actividades previas de Alice, y viceversa para la moneda $B$.

Desde el punto de vista de Alice, el riesgo es que el historial de la moneda $B$ pueda ser considerado sospechoso por determinadas entidades. Si, por ejemplo, Bob hubiera adquirido la moneda $B$ en un acto delictivo como la piratería informática, esta moneda quedaría vinculada a sus actividades ilegales. Alice podría entonces encontrarse en posesión de una moneda que no podría transferir a plataformas de negociación reguladas sin arriesgarse a que le congelaran sus fondos, o incluso a ser acusada de los delitos de Bob, aunque ella no tuviera nada que ver con ellos.

Y, por supuesto, métodos de privacidad como el intercambio de monedas o el intercambio atómico son los preferidos por los delincuentes cuyos fondos son vigilados por las autoridades. Estos protocolos les dan la oportunidad de deshacerse de sus bitcoins vigilados a cambio de bitcoins perfectamente fungibles. Esto también les permite crear distracciones dirigiendo a las autoridades hacia otros usuarios. Existe, por tanto, una doble utilidad para estas personas.

Con coinjoin, incluso si tu moneda se mezcla con bitcoins monitorizados, el historial de la moneda se rompe, lo que proporciona una forma de negación plausible que no existe en protocolos de transferencia de propiedad secretos como el intercambio de monedas o el intercambio atómico.

Si Alice quiere evitar cualquier riesgo, debe utilizar necesariamente un método para alterar la historia de la moneda $B$, como pasarlo por coinjoins, por ejemplo. Esto plantea una cuestión sobre la utilidad de combinar la transferencia secreta de propiedad y el coinjoin. El coinjoin, al interrumpir la historia de una moneda, ya proporciona un nivel suficiente de privacidad para Alice. Así, mi opinión es que si Alice busca proteger su privacidad, sería más prudente proceder directamente con un coinjoin que realizar un intercambio de monedas seguido de un coinjoin.

Para que los métodos de transferencia secreta de la propiedad sean realmente eficaces y eviten el riesgo de vincular el historial de un usuario $A$ a otro $B$, sería paradójicamente necesario que su uso fuera ampliamente conocido. Si el intercambio de monedas se utiliza masivamente y las autoridades son conscientes de esta práctica común, entonces podría establecerse una forma plausible de negación. Sin embargo, mientras el uso de estas transferencias siga siendo marginal, creo que estos métodos seguirán siendo demasiado arriesgados para los usuarios.

Hasta ahora, hemos estudiado principalmente los métodos de privacidad a nivel de la propia transacción. En el próximo capítulo, exploraremos cuestiones a nivel de red y difusión de transacciones.

## Privacidad en la red P2P

<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>

En la Parte 4, hablamos de la importancia de utilizar un nodo completo para proteger la privacidad de tus transacciones. Sin embargo, es importante entender que tu nodo en sí mismo puede ser objeto de ataques que busquen extraer información sobre tus actividades. En este capítulo, por tanto, veremos diferentes medidas de protección de la privacidad, no a nivel de las transacciones en sí o de los flujos de bitcoin, sino a nivel de la red.

### Diente de león

Una forma de evitar varios ataques de desanonimización es utilizar la propuesta Dandelion. Este protocolo de transmisión fue formalizado en BIP156, pero nunca ha sido implementado en Bitcoin. La idea de Dandelion es mejorar la privacidad del enrutamiento de transacciones en la red Bitcoin para frustrar varias formas de ataques. Su principal objetivo es ocultar el nodo fuente que transmite inicialmente una transacción en la red. La revelación de este nodo podría vincular una transacción Bitcoin a una dirección IP específica (si el nodo opera en la red sin cifrar), proporcionando así un punto de entrada para el análisis de la cadena.

Esta asociación entre una actividad en Bitcoin y una dirección IP supone un riesgo importante para la privacidad del usuario. De hecho, numerosas entidades pueden vincular fácilmente una dirección IP a una identidad personal. Esto incluye notablemente a gobiernos y proveedores de servicios de Internet. Además, esta información puede llegar a ser públicamente accesible, por ejemplo, si su dirección IP y sus datos personales quedan expuestos debido a una filtración de datos durante el pirateo de la base de datos de un sitio web.

En el funcionamiento estándar de Bitcoin, las transacciones creadas por un usuario en su cartera de software se transmiten a su nodo personal. Este nodo transmite inmediatamente la nueva transacción a todos los pares a los que está conectado.

A continuación, estos pares verifican la transacción para asegurarse de que cumple las reglas de consenso y las reglas de estandarización local. Una vez validada, cada par reenvía a su vez la transacción a sus pares, y así sucesivamente.

La distribución de las transacciones pendientes de integración en un bloque se produce de forma bastante equilibrada y estadísticamente predecible. Esta vulnerabilidad puede ser explotada por nodos espía en connivencia, que colaboran para vigilar y analizar la red con el fin de identificar el primer nodo que transmite una transacción. Si un observador puede localizar el nodo de origen, puede suponer que la transacción procede del operador de ese nodo. Este tipo de observación puede vincular transacciones, normalmente anónimas, a direcciones IP concretas.

El objetivo de BIP156 es resolver este problema. Para ello, introduce una fase adicional en la transmisión de una nueva transacción para preservar el anonimato antes de su difusión pública a gran escala. Dandelion utiliza primero una fase "madre" en la que la transacción se envía a través de una ruta aleatoria de nodos.

A continuación, la transacción se transmite a toda la red en la etapa "fluff" (soplo).

El tallo y el diente de león son referencias al comportamiento de la propagación de la transacción a través de la red, que se asemeja a la forma de un diente de león.

Así, los nodos espía pueden rastrear potencialmente la transacción hasta el nodo que inició la fase de soplado (la transmisión masiva), pero este nodo no es el que transmitió primero la transacción, ya que la recibió del último nodo del tallo. Si los nodos espía no pueden rastrear el tallo, tampoco pueden identificar el nodo de origen.

Incluso en presencia de nodos espía durante la fase de tallo, siempre queda la duda porque en cuanto encuentran un nodo honesto en el grafo de difusión, los espías no pueden determinar si este nodo es la fuente original o simplemente un intermediario.

Este método de enrutamiento hace más difícil rastrear hasta el nodo de origen, lo que complica el seguimiento de una transacción a través de la red hasta su origen. Dandelion mejora así la privacidad al limitar la capacidad de los adversarios para desanonimizar la red. Este método es aún más eficaz cuando la transacción, durante la fase "tallo", atraviesa un nodo que encripta sus comunicaciones de red, como ocurre con Tor o P2P Transport V2.

BIP156 no ha sido integrado en Bitcoin Core y actualmente está clasificado con el estado "rechazado" Una de las principales preocupaciones sobre este protocolo reside en el hecho de que, durante la fase de vástago, las transacciones deben ser reenviadas por nodos intermedios antes de ser verificadas. Como hemos visto, en el modelo normal de Bitcoin, cada nodo verifica primero la transacción antes de reenviarla a sus pares. Si una transacción no cumple las reglas de consenso o estandarización local del nodo, es ignorada y no reenviada. Este proceso es importante para frustrar los ataques DoS, ya que sólo las transacciones válidas se transmiten a toda la red. Las transacciones no válidas, potencialmente generadas en masa para sobrecargar la red, se detienen en el primer nodo encontrado y no se propagan. El principal riesgo de Dandelion es que este nuevo protocolo podría introducir nuevos vectores de ataques DoS al permitir la transmisión de transacciones no válidas a través de parte de la red.

### Transporte P2P V2

P2P Transport V2 es otro protocolo de red presentado en BIP324. Se trata de una nueva versión del protocolo de transporte P2P de Bitcoin que incorpora criptografía oportunista para mejorar la confidencialidad y seguridad de las comunicaciones entre nodos.

Esta mejora pretende resolver varios problemas de la versión básica del protocolo P2P. Por un lado, hace que los datos intercambiados sean indistinguibles de otros tipos de datos que circulan por Internet para un observador pasivo. El objetivo principal es evitar que los gobiernos, los proveedores de servicios de Internet o los proveedores de VPN vigilen masivamente a los usuarios de Bitcoin. Esto también complica la tarea de estas entidades para determinar si un usuario de Internet es también un usuario de Bitcoin, es decir, si está operando un nodo completo.

P2P V2 también ayuda a reducir los riesgos de censura y ataques al detectar patrones específicos en los paquetes de datos. Complica y hace más costosa la ejecución de varios tipos de ataques Sybil a nivel de red. Un ataque Sybil se produce cuando un actor crea múltiples identidades falsas para obtener una ventaja indebida. En el contexto de la red Bitcoin, esto se manifiesta a menudo como un actor que controla un gran número de nodos completos y los utiliza agresivamente para multiplicar las conexiones. Los ataques sibilinos pueden ser pasivos, con el objetivo de recopilar información y comprometer la confidencialidad del usuario, o activos, en forma de ataques Eclipse. Estos últimos aíslan un nodo específico del resto de la red, permitiéndole censurar al usuario o alterar los datos que recibe. Por último, P2P V2 hace que los ataques _Man-In-The-Middle_ (MITM) sean más costosos y fáciles de detectar.

El cifrado implementado por P2P V2 no incluye autenticación para no añadir complejidad innecesaria y no comprometer la naturaleza sin permisos de la conexión de red. Sin embargo, este nuevo protocolo de transporte P2P proporciona una mayor seguridad contra los ataques pasivos y hace que los ataques activos sean mucho más costosos y detectables. La introducción de un flujo de datos pseudoaleatorio en los mensajes de red complica la tarea a los atacantes que deseen censurar o manipular las comunicaciones.

El transporte P2P V2 se incluyó como opción (desactivado por defecto) en la versión 26.0 de Bitcoin Core, desplegada en diciembre de 2023. Después se habilitó por defecto en la versión 27.0 en abril de 2024. Puede cambiarse con la opción `v2transport=` en el archivo de configuración.

### Tor

Una solución relativamente simple para evitar los riesgos de pérdida de confidencialidad para un nodo a nivel de red es ejecutarlo completamente bajo Tor. Tor es una red de servidores de retransmisión (nodos) que anonimiza el origen de las conexiones TCP en Internet. Funciona encapsulando los datos en múltiples capas de encriptación. Cada nodo de retransmisión elimina una capa para revelar la dirección del siguiente nodo, hasta llegar al destino final. La red Tor garantiza el anonimato impidiendo que los nodos intermedios conozcan tanto el origen como el destino de los datos, lo que hace muy difícil para un observador rastrear la actividad del usuario.

Por tanto, Tor no sólo encripta los datos comunicados, sino que también permite enmascarar el origen y el destino de las comunicaciones. Usando Tor para las comunicaciones del nodo personal, mejoramos la privacidad de nuestras transacciones: el Proveedor de Servicios de Internet (ISP) no puede desencriptar las comunicaciones, y otros nodos de la red Bitcoin no pueden identificar la dirección IP del nodo de origen. Además, Tor también oculta el uso de Bitcoin al ISP de uno.

El principal riesgo asociado a este método es que Tor es un protocolo independiente de Bitcoin. Si tiene un nodo Bitcoin bajo Tor y Tor deja de funcionar, entonces su nodo Bitcoin ya no podrá comunicarse.

Además, es importante tener en cuenta que las comunicaciones en Tor son más lentas. Esta latencia es particularmente problemática durante el lanzamiento inicial de un nodo, ya que la Descarga Inicial de Bloques (IBD) requiere mucha comunicación. Como resultado, la sincronización inicial con la red Bitcoin podría ser significativamente más larga usando Tor. También es posible realizar IBD en la red abierta y activar Tor más tarde. Aunque este método revela la existencia de su nodo Bitcoin a su ISP, protege su información personal de transacciones una vez que cambia a Tor.

Una vez explorados los distintos métodos de privacidad a nivel de red, también quiero presentar en los próximos capítulos dos soluciones elegantes para evitar la reutilización de direcciones: BIP47 y Silent Payments.

## BIP47 y códigos de pago reutilizables

<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>

Como vimos en la Parte 3, la reutilización de direcciones es un serio obstáculo para la privacidad del usuario en el protocolo Bitcoin. Para mitigar estos riesgos, se recomienda encarecidamente generar una nueva dirección receptora para cada nuevo pago recibido en un monedero. Aunque hoy en día la generación de una nueva dirección está simplificada por el uso de software moderno y monederos deterministas jerárquicos, esta práctica puede parecer contraintuitiva.

En el sistema bancario tradicional, por ejemplo, estamos acostumbrados a compartir nuestro IBAN, que siempre es el mismo. Una vez que se lo decimos a alguien, puede enviarnos múltiples pagos sin tener que volver a interactuar con nosotros. Los neobancos también ofrecen posibilidades más modernas, como el uso de direcciones de correo electrónico únicas en PayPal o RevTags en Revolut. Incluso fuera del ámbito financiero, nuestros identificadores cotidianos como la dirección postal, el número de teléfono y la dirección de correo electrónico son únicos y permanentes. No tenemos que renovarlos con cada nueva interacción.

Sin embargo, el funcionamiento de Bitcoin es diferente: es imprescindible generar una nueva dirección de recepción para cada transacción entrante. Esta disyuntiva entre facilidad de uso y privacidad se remonta a los orígenes mismos del libro blanco de Bitcoin. Desde la publicación de la primera versión de su documento a finales de 2008, Satoshi Nakamoto ya nos había advertido de este riesgo:

**"_Como cortafuegos adicional, se podría utilizar un nuevo par de claves para cada transacción a fin de mantenerlas desvinculadas de un propietario común._"**

Existen numerosos métodos para recibir múltiples pagos en un único identificador sin provocar la reutilización de direcciones. Cada uno de estos métodos tiene sus propias ventajas e inconvenientes. Entre estos métodos se encuentra BIP47, una propuesta desarrollada por Justus Ranvier y publicada en 2015. Esta propuesta pretende crear códigos de pago reutilizables que permitan realizar múltiples transacciones a la misma persona evitando la reutilización de direcciones. En esencia, BIP47 pretende ofrecer un sistema de pago intuitivo como identificador único preservando la privacidad de las transacciones.

![BTC204](assets/fr/212.webp)

BIP47 no mejora directamente la privacidad del usuario, ya que un pago BIP47 ofrece el mismo nivel de privacidad que una transacción Bitcoin clásica utilizando direcciones nuevas. Sin embargo, sí hace más cómodo e intuitivo el uso de Bitcoin, una facilidad que normalmente tendría que comprometer la privacidad. Gracias a BIP47, esta facilidad de uso consigue el mismo nivel de privacidad que una transacción clásica. Esta es la razón por la que BIP47 es una valiosa herramienta para la preservación de la privacidad.

Inicialmente, BIP47 fue una propuesta formulada para ser integrada en Bitcoin Core, pero nunca fue adoptada. Sin embargo, algunos programas optaron por implementarlo de forma independiente a nivel de aplicación. Así, los equipos de Samourai Wallet desarrollaron su propia implementación de BIP47 llamada "PayNym"

### Principio general del PIF47 y PayNym

El objetivo de BIP47 es permitir la recepción de numerosos pagos sin provocar la reutilización de direcciones. Se basa en el uso de un código de pago reutilizable, que permite a distintos remitentes enviar múltiples pagos a un único código perteneciente a otro usuario. Así, el destinatario no tiene que proporcionar una nueva dirección para cada transacción, lo que facilita enormemente sus intercambios al tiempo que preserva su privacidad.

![BTC204](assets/it/66/4.webp)

Un usuario puede entonces compartir libremente su código de pago, ya sea en las redes sociales o en su propio sitio web, sin riesgo de perder su privacidad, a diferencia de lo que ocurriría con una dirección de recepción o una clave pública clásicas.

Para realizar una transacción, ambas partes deben disponer de un monedero Bitcoin con una implementación de BIP47, como PayNym en Samourai Wallet o Sparrow Wallet. El uso conjunto de sus códigos de pago crea un canal secreto entre ellos. Para establecer este canal de forma eficiente, el remitente debe realizar una transacción específica en la blockchain de Bitcoin, conocida como "transacción de notificación" (daré más detalles sobre esto más adelante).

La combinación de los códigos de pago de ambos usuarios genera secretos compartidos, que a su vez permiten la creación de un gran número de direcciones receptoras Bitcoin únicas (exactamente 2^32, o unos 4.000 millones). Así, los pagos realizados a través de BIP47 no van dirigidos en realidad al código de pago en sí, sino a direcciones receptoras clásicas derivadas de los códigos de pago de los usuarios implicados.

El código de pago sirve entonces como identificador virtual derivado de la semilla de la cartera. En la estructura de derivación jerárquica de la cartera, el código de pago se sitúa en el nivel 3, es decir, en el nivel de cuenta.

![BTC204](assets/it/66/5.webp)

El objetivo de derivación para el BIP47 se identifica mediante el índice `47` (`0x8000002F`), que hace referencia al BIP47. Un ejemplo de ruta de derivación para un código de pago reutilizable sería el siguiente:

```plaintext
m/47'/0'/0'/
```

Para que se haga una idea de cómo es un código de pago, aquí tiene el mío:

```plaintext
M8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Este código también puede codificarse en un código QR para facilitar la comunicación, igual que una dirección de recepción clásica.

En cuanto a los PayNym Bots, estos robots que a veces se ven en Twitter son representaciones visuales del código de pago, creados por Samourai Wallet. Se generan mediante una función hash, lo que les confiere un carácter casi único. Aparecen como una pequeña cadena de caracteres que empieza por `+`:

```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

Estos avatares también pueden representarse como imágenes:

![BTC204](assets/fr/215.webp)

Aunque estos robots no tienen una funcionalidad técnica específica en el marco del PIF47, desempeñan un papel a la hora de facilitar las interacciones entre los usuarios al ofrecer una identidad visual fácilmente reconocible.

---
*En las siguientes secciones de este capítulo dedicadas a BIP47, examinaremos su funcionamiento en detalle, centrándonos en particular en los métodos criptográficos utilizados. Para comprender plenamente estas explicaciones más bien técnicas, es esencial entender primero la estructura de los monederos HD, los procesos de derivación de claves y los principios básicos de la criptografía basada en curvas elípticas. Si quieres aprender más sobre estos conceptos, hay otro curso gratuito disponible en Plan ₿ Network:*

https://planb.network/courses/cyp201
*Le recomiendo encarecidamente que lo siga, porque comprender el funcionamiento técnico del PIF47 le ayudará a entender mucho mejor otras propuestas similares que trataremos en los próximos capítulos.*

---
### Código de pago reutilizable

Como ya se ha mencionado, el código de pago reutilizable se encuentra en el nivel 3 del monedero HD, por lo que es comparable a un `xpub`, tanto en su posición dentro de la estructura del monedero como en su función.

El código de pago de 80 bytes se divide de la siguiente manera:


- Byte `0`: Versión**. Para la primera versión de BIP47, este byte es `0x01`;
- Byte `1`: El campo de bits**. Este espacio está reservado para incorporar indicaciones adicionales durante usos específicos. Para el uso estándar con PayNym, este byte se define como `0x00`;
- Byte `2`: La paridad de `y`**. Este byte es `0x02` o `0x03`, indicando si la ordenada de la clave pública es par o impar, ya que se utiliza una clave pública comprimida;
- Del byte `3` al byte `34`: El valor de `x`**. Estos bytes representan la abscisa de la clave pública. La concatenación de `x` y la paridad de `y` forma la clave pública comprimida completa;
- Del byte `35` al byte `66`: Código de cadena**. Este espacio contiene el código de cadena asociado a la clave pública;
- Del byte `67` al byte `79`: Relleno**. Este espacio está destinado a un posible desarrollo futuro. Para la versión actual, simplemente se colocan ceros aquí para alcanzar el tamaño de 80 bytes requerido para una salida `OP_RETURN`.

He aquí la representación hexadecimal de mi código de pago reutilizable ya presentado en la sección anterior:

```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

![BTC204](assets/it/66/7.webp)

En primer lugar, es necesario añadir el prefijo `P` al principio para indicar claramente que se trata de un código de pago. Este byte se representa por `0x47`:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

Por último, para garantizar la integridad del código de pago, se realiza un cálculo de suma de comprobación utilizando `HASH256`, que consiste en un doble hash con la función `SHA256`. Los cuatro primeros bytes resultantes de este hash se concatenan al final del código de pago:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

Una vez completados estos pasos, el código de pago está listo. El único paso que queda es convertirlo a base 58 para obtener su versión final:

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Durante este proceso de creación del código de pago, utilizamos una clave pública comprimida y un código de cadena. Ambos se obtienen por derivación determinista y jerárquica a partir de la semilla del monedero. La ruta de derivación utilizada para conseguirlo es:

```plaintext
m/47'/0'/0'/
```

Para generar la clave pública comprimida y el código de cadena asociado para el código de pago reutilizable, empezamos por calcular la clave privada principal a partir de la semilla del monedero. A continuación, derivamos un par de claves hijas utilizando el índice `47 + 2^31` (derivación reforzada). A este paso le siguen otras dos derivaciones sucesivas de pares de claves hijas, cada una de ellas utilizando el índice `2^31` (derivación reforzada).

### Intercambio de claves Diffie-Hellman de curva elíptica (ECDH)

El protocolo criptográfico en el que se basa BIP47 se conoce por las siglas ECDH, de _Elliptic-Curve Diffie-Hellman_. Este método es una variante del intercambio de claves Diffie-Hellman original.

Introducido en 1976, Diffie-Hellman es un protocolo de acuerdo de claves que permite a dos partes, cada una equipada con un par de claves (pública y privada), ponerse de acuerdo sobre un secreto común, incluso mientras se comunican exclusivamente a través de un canal público e inseguro.

![BTC204](assets/it/66/10.webp)

Este secreto compartido (en este caso, la clave azul) puede utilizarse para otras operaciones. Normalmente, este secreto compartido puede utilizarse para cifrar y descifrar comunicaciones a través de una red insegura:

![BTC204](assets/fr/220.webp)

Para realizar este intercambio, Diffie-Hellman utiliza la aritmética modular para calcular el secreto compartido. He aquí una explicación simplificada de cómo funciona:


- Alice y Bob acuerdan un color común, aquí amarillo, que constituye los datos públicos (los atacantes conocen este color);
- Alice selecciona un color secreto, en este caso el rojo, y mezcla los dos para obtener el naranja;
- Bob también elige un color secreto, en este caso el azul, y lo mezcla con el amarillo para obtener el verde;
- Luego intercambian los colores obtenidos, naranja y verde. Este intercambio puede tener lugar en una red insegura y observada;
- Al mezclar el verde de Bob con su color secreto, Alice produce marrón;
- Bob, haciendo lo mismo con el naranja de Alice y su azul secreto, también obtiene marrón.

![BTC204](assets/it/66/12.webp)

En esta simplificación, el color marrón representa el secreto compartido entre Alice y Bob. Es importante entender que, en realidad, es imposible para el atacante separar los colores naranja y verde para descubrir los colores secretos de Alice o Bob.

Examinemos ahora cómo funciona realmente este protocolo, no con analogías de colores, sino utilizando números reales y aritmética modular

Antes de hablar de los mecanismos de Diffie-Hellman, permítanme recordarles brevemente dos conceptos matemáticos esenciales que necesitaremos:


- Un **número primo** es un número natural que sólo tiene dos divisores: $1$ y él mismo. Por ejemplo, $7$ es un número primo porque sólo se puede dividir por $1$ y $7$. En cambio, $8$ no es un número primo porque es divisible por $1$, $2$, $4$ y $8$. Por lo tanto, tiene cuatro divisores enteros positivos en lugar de dos;
- El **mod** (denotado $mod$ o $\%$) es una operación matemática que, entre dos números enteros, devuelve el resto de la división euclídea del primero por el segundo. Por ejemplo, $16 \bmod 5 = 1$.

**El intercambio de claves Diffie-Hellman entre Alice y Bob procede como sigue:**


- Alice y Bob están de acuerdo en dos números comunes: $p$ y $g$. $p$ es un número primo, y cuanto mayor sea este número, más seguro será Diffie-Hellman. $g$ es una raíz primitiva de $p$. Estos dos números pueden comunicarse abiertamente a través de una red no segura. Representan el equivalente del **color amarillo** en la simplificación anterior. Por lo tanto, es importante que Alice y Bob utilicen exactamente los mismos valores para $p$ y $g$.

Una vez definidos estos parámetros, Alice y Bob eligen cada uno un número secreto aleatorio. Alice llama a su número secreto aleatorio $a$ (equivalente a **el color rojo**) y Bob llama al suyo $b$ (equivalente a **el color azul**). Estos números deben ser estrictamente confidenciales.

En lugar de intercambiar directamente los números $a$ y $b$, cada parte calcula $A$ y $B$ de la siguiente manera:

$A$ es igual a $g$ elevado a la potencia de $a$ módulo $p$:

$$
A = g^a \bmod p
$$

$B$ es igual a $g$ elevado a la potencia de $b$ módulo $p$:

$$
B = g^b \bmod p
$$

Las dos partes intercambian los valores $A$ (equivalente a **el color naranja**) y $B$ (equivalente a **el color verde**). Este intercambio puede realizarse abiertamente a través de una red no segura;

Alicia, tras recibir $B$, calcula el valor de $z$ de la siguiente manera:

$z$ es igual a $B$ elevado a la potencia de $a$ módulo $p$:

$$
z = B^a \bmod p
$$

Recuérdalo:

$$
B = g^b \bmod p
$$

Así, obtenemos:

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

Aplicar las reglas de los exponentes:

$$
(x^n)^m = x^{nm}
$$

Así obtenemos:

$$
z = g^{ba} \bmod p
$$


- Por su parte, Bob, habiendo recibido $A$, también calcula el valor de $z$ de la siguiente manera:

$z$ es igual a $A$ elevado a la potencia de $b$ módulo $p$:

$$
z = A^b \bmod p
$$

Así, obtenemos:

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

Debido a la distributividad del operador módulo, Alice y Bob obtienen exactamente el mismo valor $z$. Este número representa su secreto común, equivalente a **el color marrón** en la simplificación anterior con botes de pintura. Ahora pueden utilizar este secreto común para cifrar simétricamente sus comunicaciones a través de una red no segura.

Un atacante, incluso en posesión de $p$, $g$, $A$ y $B$ (los valores públicos), no podrá calcular $a$, $b$ o $z$ (los valores privados). Para ello sería necesario invertir la exponenciación, una tarea imposible sin probar todas las posibilidades una a una, ya que equivale a calcular el logaritmo discreto, es decir, la inversa de la exponencial en un grupo cíclico finito.

Por lo tanto, mientras los valores de $a$, $b$ y $p$ sean suficientemente grandes, el protocolo Diffie-Hellman es seguro. Normalmente, con parámetros de 2048 bits (un número con 600 dígitos en decimal), probar todas las posibilidades para $a$ y $b$ sería poco práctico. Hasta la fecha, con tales números, este algoritmo se considera seguro.

Aquí es precisamente donde radica la principal desventaja del protocolo Diffie-Hellman. Para ser seguro, el algoritmo debe utilizar números grandes. Por eso, hoy en día se prefiere el algoritmo ECDH (_Elliptic Curve Diffie-Hellman_), una variante de Diffie-Hellman que se basa en una curva algebraica, más concretamente en una curva elíptica. Este enfoque permite trabajar con números mucho más pequeños manteniendo una seguridad equivalente, lo que reduce los recursos necesarios para el cálculo y el almacenamiento.

El principio general del algoritmo sigue siendo el mismo. Sin embargo, en lugar de utilizar un número aleatorio $a$ y un número $A$ calculado a partir de $a$ mediante exponenciación modular, utilizamos un par de claves establecidas en una curva elíptica. En lugar de basarnos en la distributividad del operador módulo, utilizamos la ley de grupo en curvas elípticas, y más concretamente la asociatividad de esta ley.

Para explicar brevemente el principio de la criptografía de curva elíptica, una clave privada está representada por un número aleatorio comprendido entre $1$ y $n-1$, donde $n$ representa el orden de la curva. La clave pública, por su parte, es un punto concreto de esta curva, obtenido a partir de la clave privada mediante operaciones de suma y duplicación de puntos a partir del punto generador, según la ecuación:

$$
K = k \cdot G
$$

En esta fórmula, $K$ denota la clave pública, $k$ la clave privada y $G$ el punto generador.

Una de las características esenciales de estas claves es la facilidad para calcular $K$ a partir de $k$ y $G$, mientras que es prácticamente imposible encontrar $k$ a partir de $K$ y $G$. Esta asimetría crea una función unidireccional. En otras palabras, es fácil calcular la clave pública si se conoce la clave privada, pero encontrar la clave privada a partir de la pública es imposible. Esta seguridad sigue basándose en la dificultad computacional del logaritmo discreto.

Utilizaremos esta propiedad para adaptar nuestro algoritmo Diffie-Hellman. **El principio de funcionamiento de ECDH es el siguiente:**


- Alice y Bob acuerdan juntos una curva elíptica criptográficamente segura y sus parámetros. Esta información es pública;
- Alice genera un número aleatorio $ka$ que será su clave privada. Esta clave privada debe permanecer secreta. Determina su clave pública $Ka$ sumando y duplicando puntos en la curva elíptica elegida:

$$
K_a = k_a \cdot G
$$


- Bob también genera un número aleatorio $kb$ que será su clave privada. Calcula la clave pública asociada $kb$:

$$
K_b = k_b \cdot G
$$


- Alice y Bob intercambian sus claves públicas $Ka$ y $Kb$ en una red pública no segura.
- Alice calcula un punto $(x,y)$ en la curva aplicando su clave privada $ka$ a la clave pública de Bob $Kb$:

$$
(x,y) = k_a \cdot K_b
$$


- Bob calcula un punto $(x,y)$ en la curva aplicando su clave privada $kb$ a la clave pública $Ka$ de Alice:

$$
(x,y) = k_b \cdot K_a
$$


- Alice y Bob obtienen el mismo punto en la curva elíptica. El secreto compartido será la coordenada $x$ de este punto.

De hecho, tienen el mismo secreto compartido porque:

(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a

$$
Un attaccante che osserva la rete pubblica non protetta può ottenere solo le chiavi pubbliche di ciascuna parte e i parametri della curva ellittica scelta. Come precedentemente spiegato, queste informazioni da sole non sono sufficienti per determinare le chiavi private. Pertanto, l'attaccante non può trovare il segreto condiviso tra Alice e Bob.
ECDH è quindi un algoritmo che consente lo scambio di chiavi. È spesso utilizzato in combinazione con altri metodi crittografici per stabilire un protocollo completo. Ad esempio, ECDH è integrato nel nucleo di TLS (_Transport Layer Security_), un protocollo di crittografia e autenticazione utilizzato per il livello di trasporto di Internet. TLS utilizza ECDHE per lo scambio di chiavi, una variante di ECDH dove le chiavi sono effimere, per garantire la confidenzialità persistente. Inoltre, TLS utilizza algoritmi di autenticazione come ECDSA, algoritmi di crittografia come AES e funzioni hash come SHA256.
TLS è notevolmente responsabile della `s` in `https` così come del lucchetto visibile nella barra degli indirizzi del tuo browser, simboli delle comunicazioni criptate. Seguendo questo corso, stai quindi utilizzando ECDH, ed è molto probabile che lo usi quotidianamente senza nemmeno saperlo.
### La Transazione di Notifica
Come abbiamo visto nella sezione precedente, ECDH è una variante dello scambio Diffie-Hellman che utilizza coppie di chiavi stabilite su una curva ellittica. Convenientemente, possediamo già molte coppie di chiavi aderenti a questo standard nei nostri portafogli Bitcoin! L'idea di BIP47 è di utilizzare le coppie di chiavi dei portafogli Bitcoin gerarchici deterministici di entrambe le parti per stabilire segreti condivisi ed effimeri tra di loro. Nel contesto di BIP47, viene utilizzato ECDHE (_Elliptic Curve Diffie-Hellman Ephemeral_).
ECDHE viene utilizzato per la prima volta in BIP47 per trasmettere il codice di pagamento dal mittente al destinatario. Questo è il famoso **notification transaction**. Questo passaggio è essenziale perché affinché BIP47 funzioni efficacemente, entrambe le parti coinvolte (il mittente e il destinatario) devono conoscere il codice di pagamento dell'altro. Questa conoscenza consente la derivazione di chiavi pubbliche effimere e, di conseguenza, indirizzi di ricezione vuoti associati.
Prima di questo scambio, il mittente è logicamente già a conoscenza del codice di pagamento del destinatario poiché lo ha recuperato off-chain, ad esempio, dal loro sito web, una fattura o i loro social media. Tuttavia, il destinatario potrebbe non conoscere necessariamente il codice di pagamento del mittente. Eppure, questo codice deve essere trasmesso a loro; altrimenti, non saranno in grado di derivare le chiavi effimere necessarie per identificare gli indirizzi dove sono conservati i loro bitcoin, né accedere ai loro fondi. Sebbene questa trasmissione del codice del mittente possa tecnicamente essere effettuata off-chain attraverso altri mezzi di comunicazione, ciò pone un problema se il portafoglio deve essere recuperato solo dal seme.
Infatti, a differenza degli indirizzi convenzionali, gli indirizzi BIP47 non sono derivati direttamente dal seed del destinatario—utilizzare un `xpub` sarebbe più semplice in questo caso—ma risultano da un calcolo che combina i codici di pagamento di entrambi: quello del mittente e quello del destinatario. Pertanto, se il destinatario perde il proprio portafoglio e tenta di ripristinarlo dal proprio seed, recupererà il proprio codice di pagamento, che è derivato direttamente dal loro seed. Tuttavia, per trovare gli indirizzi effimeri, sarà essenziale per loro avere anche i codici di pagamento di tutti coloro che hanno inviato loro bitcoin tramite BIP47. Da qui l'importanza della transazione di notifica, che consente di salvare queste informazioni sulla blockchain di Bitcoin, pur essendo in grado di trovarle molto facilmente senza dover cercare tra il miliardo di transazioni eseguite dal suo lancio nel 2009.
![BTC204](assets/it/66/15.webp)
Pertanto, sarebbe possibile implementare BIP47 senza ricorrere alla transazione di notifica, a condizione che ogni utente conservi un backup dei codici di pagamento dei propri pari. Tuttavia, questo metodo si rivela complesso da gestire finché non viene sviluppata una soluzione semplice, robusta ed efficiente per creare, conservare e aggiornare questi backup. Nello stato attuale delle cose, la transazione di notifica diventa quasi indispensabile.
Nei capitoli seguenti, studieremo altri protocolli con obiettivi simili a quelli di BIP47, ma che non richiedono una transazione di notifica. Queste alternative, tuttavia, introducono i propri compromessi.
Oltre al suo ruolo nel backup dei codici di pagamento, la transazione di notifica serve anche una funzione di notifica per il destinatario, come suggerisce il suo nome. Segnala al client del destinatario che è stato stabilito un nuovo canale di pagamento e suggerisce quindi di monitorare gli indirizzi effimeri risultanti.
### Il Modello di Privacy di BIP47
Prima di dettagliare il funzionamento tecnico della transazione di notifica, è importante discutere il modello di privacy associato a BIP47, che giustifica alcune misure prese durante la creazione di questa transazione iniziale.
Il codice di pagamento, di per sé, non rappresenta un rischio diretto per la privacy. A differenza del modello Bitcoin tradizionale, che mira a rompere il collegamento tra l'identità di un utente e le sue transazioni (che sono pubbliche) preservando l'anonimato di chiavi e indirizzi, il codice di pagamento può essere apertamente associato a un'identità senza rappresentare una minaccia.
Infatti, il codice di pagamento non è utilizzato per derivare direttamente gli indirizzi che ricevono pagamenti BIP47. Questi indirizzi sono invece generati attraverso l'applicazione di ECDH tra le chiavi derivate dai codici di pagamento delle due parti coinvolte.
Così, un codice di pagamento di per sé non porta direttamente a una perdita di privacy, poiché solo l'indirizzo di notifica è derivato da esso. Sebbene questo indirizzo possa rivelare alcune informazioni, normalmente non consente di scoprire le parti con cui si stanno conducendo transazioni, a meno che non si effettui un'analisi approfondita della catena. Infatti, se il mittente utilizza UTXO che possono essere collegati alla loro identità per eseguire la transazione di notifica, allora diventa possibile dedurre che la loro identità è probabilmente collegata ai pagamenti BIP47 al tuo codice di pagamento. Questo non rivelerà le transazioni sottostanti, ma indicherà la loro probabile esistenza.
Pertanto, è essenziale mantenere questa stretta separazione tra i codici di pagamento degli utenti. Verso questo obiettivo, il passo iniziale di comunicazione del codice è un momento critico per la privacy del pagamento, ma obbligatorio per il corretto funzionamento del protocollo. Se uno dei codici di pagamento può essere ottenuto pubblicamente (come su un sito web), il secondo codice, quello del mittente, non deve essere collegato al primo in nessun caso.
Prendiamo un esempio concreto: voglio fare una donazione a un movimento politico tramite BIP47:
- L'organizzazione ha reso pubblico il suo codice di pagamento sul suo sito web o tramite i suoi social network;
- Questo codice è quindi collegato al movimento politico;
- Recupero questo codice di pagamento;
- Prima di procedere con un invio, devo assicurarmi che conoscano il mio codice di pagamento, che è anche collegato alla mia identità poiché lo uso per ricevere transazioni sui miei social network.
Come trasmettere il mio codice senza rischi? L'uso di mezzi di comunicazione convenzionali potrebbe portare a una fuga di informazioni e, di conseguenza, associarmi a questo movimento politico. La transazione di notifica offre una soluzione grazie a uno strato di crittografia che impedisce precisamente questa associazione tra due codici. Sebbene questo non sia l'unico metodo per trasmettere segretamente il codice di pagamento del mittente, si dimostra molto efficace.
Nel diagramma sottostante, le linee arancioni indicano i punti in cui il flusso di informazioni deve essere interrotto, e le frecce nere mostrano le connessioni che potrebbero potenzialmente essere osservate da terze parti:
![BTC204](assets/it/66/16.webp)
In realtà, all'interno del modello tradizionale di privacy di Bitcoin, è spesso complesso dissociare completamente il flusso di informazioni tra la coppia di chiavi e l'utente, specialmente durante le transazioni a distanza. Ad esempio, nel contesto di una campagna di donazione, il destinatario deve inevitabilmente divulgare un indirizzo o una chiave pubblica tramite il loro sito web o social network. L'uso corretto di BIP47, in particolare con la transazione di notifica, permette di aggirare questo problema grazie a ECDHE e allo strato di crittografia che studieremo ulteriormente.
Ovviamente, il modello classico di privacy di Bitcoin si applica ancora alle chiavi pubbliche effimere, che sono derivate dalla combinazione dei due codici di pagamento. I due modelli sono in realtà complementari. Quello che voglio evidenziare qui è che, contrariamente all'uso abituale di una chiave pubblica per ricevere bitcoin, il codice di pagamento può essere collegato a una specifica identità, perché l'informazione "_Alice effettua una transazione con Bob_" viene interrotta in un'altra fase. Il codice di pagamento viene utilizzato per generare indirizzi di pagamento, ma basandosi unicamente sull'osservazione della blockchain, è impossibile collegare una transazione di pagamento BIP47 ai codici di pagamento utilizzati per eseguirla, a meno che gli UTXO coinvolti non fossero già collegati a un'identità precedentemente e gli utenti non abbiano associato i loro codici di pagamento alle rispettive identità.
Per riassumere, il modello di privacy offerto dai pagamenti BIP47 potrebbe essere considerato superiore a quello della base di Bitcoin, anche se non è magico in alcun modo.
### Costruzione della Transazione di Notifica
Ora, vediamo come funziona questa transazione di notifica. Immaginiamo che Alice voglia inviare fondi a Bob con BIP47. Nel mio esempio, Alice agisce come mittente e Bob come destinatario. Quest'ultimo ha pubblicato il suo codice di pagamento sul suo sito web. Pertanto, Alice è già a conoscenza del codice di pagamento di Bob.
**1- Alice calcola un segreto condiviso con ECDH:**
- Seleziona una coppia di chiavi dal suo portafoglio HD situato su un ramo diverso dal suo codice di pagamento. Nota, questa coppia non dovrebbe essere facilmente associata all'indirizzo di notifica di Alice, né all'identità di Alice (vedi sezione precedente);
- Alice seleziona la chiave privata da questa coppia. La chiamiamo $a$ (minuscolo);
$$

a

$$
```text
- Alice recupera la chiave pubblica associata all'indirizzo di notifica di Bob. Questa chiave è la prima figlia derivata dal codice di pagamento di Bob (indice $/0$). Chiamiamo questa chiave pubblica $B$ (maiuscolo). La chiave privata associata a questa chiave pubblica è chiamata $b$ (minuscolo). $B$ è determinata dall'addizione e dal raddoppio dei punti sulla curva ellittica da $G$ (il punto generatore) con $b$ (la chiave privata):
$$ B = b \cdot G $$
- Alice calcola un punto segreto $S$ (maiuscolo) sulla curva ellittica tramite l'addizione e il raddoppio dei punti applicando la sua chiave privata $a$ dalla chiave pubblica di Bob $B$.
$$ S = a \cdot B $$
- Alice calcola il fattore di oscuramento $f$ che le permetterà di criptare il suo codice di pagamento. Per fare ciò, determinerà un numero pseudo-casuale con la funzione HMAC-SHA512. Nel secondo input di questa funzione, utilizza un valore che solo Bob potrà recuperare: $x$ che è l'ascissa del punto segreto precedentemente calcolato. Il primo input è $o$ che è l'UTXO consumato in input di questa transazione (outpoint).
$$ f = \text{HMAC-SHA512}(o, x) $$
**2- Alice converte il suo codice di pagamento personale in base 2 (binario).**
**3- Utilizza questo fattore di oscuramento come chiave per eseguire la crittografia simmetrica sul payload del suo codice di pagamento.** L'algoritmo di crittografia utilizzato è semplicemente un `XOR`. L'operazione eseguita è paragonabile alla cifratura di Vernam, anche denominata "One-Time Pad".
- Alice prima divide il suo fattore di oscuramento in due: i primi 32 byte sono denominati $f1$ e gli ultimi 32 byte sono denominati $f2$. Quindi, abbiamo:
$$ f = f1 || f2 $$
- Alice calcola l'$x'$ criptato dell'ascissa della chiave pubblica $x$ del suo codice di pagamento, e il $c'$ criptato del suo codice catena $c$ separatamente. $f1$ e $f2$ agiscono rispettivamente come chiavi di crittografia. L'operazione utilizzata è il `XOR` (o esclusivo).
$$ x' = x \oplus f1 $$
$$ c' = c \oplus f2 $$
- Alice sostituisce i valori reali dell'ascissa della chiave pubblica $x$ e del codice catena $c$ nel suo codice di pagamento con i valori criptati $x'$ e $c'$.
**4-** Alice ora ha il suo codice di pagamento con un payload criptato. Costruirà e trasmetterà una transazione che coinvolge la sua chiave pubblica $A$ come input, un output all'indirizzo di notifica di Bob, e un output `OP_RETURN` contenente il suo codice di pagamento con il payload criptato. **Questa transazione è la transazione di notifica**.
Un `OP_RETURN` è un opcode che segna un output di una transazione Bitcoin come non valido. Oggi, è utilizzato per trasmettere o ancorare informazioni sulla blockchain di Bitcoin. Fino a 80 byte di dati possono essere memorizzati, che sono scritti sulla catena e quindi visibili a tutti gli altri utenti.
Come abbiamo visto nelle sezioni precedenti, ECDH è utilizzato per generare un segreto condiviso tra due utenti che comunicano su una rete non sicura, potenzialmente osservata da attaccanti. In BIP47, ECDH è utilizzato per la comunicazione sulla rete Bitcoin, che per sua natura è una rete di comunicazione trasparente osservata da molti attaccanti. Il segreto condiviso calcolato tramite lo scambio di chiavi ECDH è poi utilizzato per criptare le informazioni segrete da trasmettere: il codice di pagamento del mittente (di Alice).
Ricapitoliamo i passaggi che abbiamo appena esaminato insieme per eseguire una transazione di notifica:
- Alice recupera il codice di pagamento e l'indirizzo di notifica di Bob;
- Alice seleziona un UTXO che possiede nel suo portafoglio HD con la corrispondente coppia di chiavi;
- Calcola un punto segreto sulla curva ellittica utilizzando ECDH;
- Utilizza questo punto segreto per calcolare un HMAC, che è il fattore di oscuramento;
- Utilizza questo fattore di oscuramento per criptare il payload del suo codice di pagamento personale.
- Lei utilizza un output di transazione `OP_RETURN` per comunicare il codice di pagamento mascherato a Bob.
![BTC204](assets/it/66/17.webp)
### Transazione di Notifica: Studio Concreto
Per comprendere meglio il suo funzionamento, in particolare l'uso di `OP_RETURN`, esaminiamo insieme una vera transazione di notifica. Ho eseguito tale transazione sulla testnet, che potete trovare [cliccando qui](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e).
![BTC204](assets/fr/227.webp)
Osservando questa transazione, possiamo vedere che ha un singolo input e 4 output:
- Il primo output è l'`OP_RETURN` che contiene il mio codice di pagamento mascherato;
- Il secondo output di 546 sats punta all'indirizzo di notifica del mio destinatario;
- Il terzo output di 15.000 sats rappresenta le commissioni di servizio, poiché ho utilizzato Samourai Wallet per costruire questa transazione;
- Il quarto output di 2 milioni di sats rappresenta il resto, ovvero la differenza rimanente dal mio input che ritorna a un altro indirizzo che mi appartiene.
Il più interessante da studiare è ovviamente l'output 0 che utilizza l'`OP_RETURN`. Vediamo più da vicino cosa contiene. Ecco lo `scriptPubKey` in esadecimale:
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

```text
In questo script, possiamo sezionare diverse parti. Prima di tutto, gli opcode:
6a4c
```

```text
Tra gli opcode, possiamo riconoscere `0x6a` che designa l'`OP_RETURN` e `0x4c` che designa l'`OP_PUSHDATA1`.
Il byte seguente questo ultimo opcode indica la dimensione del payload che segue. Indica `0x50`, ovvero 80 byte:
6a4c50
```

```text
Poi, abbiamo i metadati del mio codice di pagamento in chiaro:
010002
```

```text
La coordinata x criptata della chiave pubblica del mio codice di pagamento:
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

```text
Il codice catena criptato del mio codice di pagamento:
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

```text
E infine, il padding per raggiungere 80 byte, la dimensione standard di un `OP_RETURN`:
00000000000000000000000000
```

```
Per capire meglio, ecco il mio codice di pagamento in chiaro in base 58:
````text
PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU
Quando si confronta il mio codice di pagamento in chiaro con l'`OP_RETURN`, è evidente che l'HRP (`0x47`) e il checksum (`0x8604e4db`) non vengono trasmessi. Questo è previsto, poiché queste informazioni sono destinate agli esseri umani.
Successivamente, possiamo identificare la versione (`0x01`), il campo di bit (`0x00`) e la parità della chiave pubblica (`0x02`). E, alla fine del codice di pagamento, i byte vuoti (`0x00000000000000000000000000`) sono utilizzati per riempire il codice fino a un totale di 80 byte. Tutti questi metadati vengono trasmessi in chiaro (non criptati).
Infine, si può osservare che la coordinata x della chiave pubblica (`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`) e il codice catena (`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`) sono stati criptati. Questo costituisce il payload del codice di pagamento.
### Cos'è XOR?
Nelle sezioni precedenti, abbiamo visto che il codice di pagamento è stato trasmesso criptato utilizzando l'operazione XOR. Prendiamoci un momento per capire come funziona questo operatore, poiché è ampiamente utilizzato nella crittografia.
XOR è un operatore logico bit a bit basato sull'algebra booleana. Con due operandi bit, restituisce `1` se i bit dello stesso rango sono diversi, e restituisce `0` se i bit dello stesso rango sono uguali. Ecco la tabella di verità di XOR basata sui valori degli operandi `D` e `E`:
| D   | E   | D XOR E |
| --- | --- | ------- |
| 0   | 0   | 0       |
| 0   | 1   | 1       |
| 1   | 0   | 1       |
| 1   | 1   | 0       |
Per esempio:
$$

$$
0110 \oplus 1110 = 1000
Oppure:
$$

$$
010011 \oplus 110110 = 100101
Con ECDH, l'uso di XOR come strato di crittografia è particolarmente adatto. Innanzitutto, a causa di questo operatore, la crittografia è simmetrica. Questo consente al destinatario di decifrare il codice di pagamento con la stessa chiave utilizzata per la crittografia. La chiave di crittografia e decrittografia viene calcolata dal segreto condiviso grazie a ECDH. Questa simmetria è resa possibile dalle proprietà commutativa e associativa dell'operatore XOR:
- Altre proprietà:
$$

$$
D \oplus D = 0
D ⊕ 0 = D
- Commutatività:
$$

$$
D \oplus E = E \oplus D
- Associatività:
$$

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
Se:
$$

$$
D \oplus E = L
Allora:
$$

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
Successivamente, questo metodo di cifratura assomiglia molto al cifrario di Vernam (One-Time Pad), l'unico algoritmo di cifratura conosciuto fino ad oggi che possiede sicurezza incondizionata (o assoluta). Affinché il cifrario di Vernam abbia questa caratteristica, la chiave di cifratura deve essere perfettamente casuale, deve essere della stessa dimensione del messaggio e deve essere utilizzata una sola volta. Nel metodo di cifratura utilizzato qui per BIP47, la chiave è effettivamente della stessa dimensione del messaggio, il fattore di offuscamento è esattamente della stessa dimensione della concatenazione della coordinata x della chiave pubblica con il codice catena del codice di pagamento. Questa chiave di cifratura è effettivamente utilizzata una sola volta. Tuttavia, questa chiave non è il risultato di una casualità perfetta poiché è un HMAC. È piuttosto pseudo-casuale. Pertanto, non si tratta di un cifrario di Vernam, ma il metodo è simile.
### Ricezione della Transazione di Notifica
Ora che Alice ha inviato la transazione di notifica a Bob, vediamo come lui la interpreta. Come promemoria, Bob deve essere in grado di accedere al codice di pagamento di Alice. Senza queste informazioni, come vedremo nella sezione seguente, non sarà in grado di derivare le coppie di chiavi create da Alice e, quindi, non sarà in grado di accedere ai suoi bitcoin ricevuti tramite BIP47. Per ora, il payload del codice di pagamento di Alice è criptato. Vediamo come Bob lo decifra.
**1-** Bob monitora le transazioni che creano output con il suo indirizzo di notifica.
**2-** Quando una transazione ha un output sul suo indirizzo di notifica, Bob la analizza per vedere se contiene un output OP_RETURN che segue lo standard BIP47.
**3-** Se il primo byte del payload OP_RETURN è `0x01`, Bob inizia la sua ricerca di un possibile segreto condiviso con ECDH:
- Bob seleziona la chiave pubblica nell'input della transazione. Ovvero, la chiave pubblica di Alice denominata $A$ con:
$$ A = a \cdot G $$
- Bob seleziona la chiave privata $b$ associata al suo indirizzo di notifica personale:
$$ b $$
- Bob calcola il punto segreto $S$ (segreto condiviso ECDH) sulla curva ellittica sommando e raddoppiando i punti, applicando la sua chiave privata $b$ alla chiave pubblica di Alice $A$:
$$ S = b \cdot A $$
- Bob determina il fattore di offuscamento $f$ che gli permetterà di decifrare il payload del codice di pagamento di Alice. Nello stesso modo in cui Alice aveva precedentemente calcolato, Bob troverà $f$ applicando HMAC-SHA512 su $x$ la coordinata x del punto segreto $S$, e su $o$ l'UTXO consumato come input in questa transazione di notifica:
$$ f = \text{HMAC-SHA512}(o, x) $$
**4-** Bob interpreta i dati nell'OP_RETURN della transazione di notifica come un codice di pagamento. Egli semplicemente decifra il payload di questo potenziale codice di pagamento usando il fattore di offuscamento $f$:
- Bob divide il fattore di offuscamento $f$ in 2 parti: i primi 32 byte di $f$ saranno $f1$ e gli ultimi 32 byte saranno $f2$;
- Bob decifra la coordinata x cifrata $x'$ della chiave pubblica dal codice di pagamento di Alice:
$$ x = x' \oplus f1 $$
- Bob decifra il valore del codice catena cifrato $c'$ dal codice di pagamento di Alice:
$$ c = c' \oplus f2 $$
**5-** Bob verifica se il valore della chiave pubblica dal codice di pagamento di Alice è effettivamente parte del gruppo secp256k1. Se è così, lo interpreta come un codice di pagamento valido. Altrimenti, ignora questa transazione.
Ora che Bob è a conoscenza del codice di pagamento di Alice, lei può inviargli fino a `2^32` pagamenti, senza mai dover effettuare un'altra transazione di notifica di questo tipo.
Perché funziona? Come fa Bob a determinare lo stesso fattore di offuscamento di Alice, e quindi a decifrare il suo codice di pagamento? Esaminiamo più da vicino il ruolo di ECDH in quello che abbiamo appena descritto.
Prima di tutto, stiamo trattando con la crittografia simmetrica. Questo significa che la chiave di cifratura e la chiave di decifratura sono lo stesso valore. Questa chiave nella transazione di notifica è il fattore di offuscamento:
$$ f = f1 || f2 $$
Pertanto, Alice e Bob devono ottenere lo stesso valore per $f$, senza trasmetterlo direttamente poiché un attaccante potrebbe rubarlo e decifrare le informazioni segrete. Questo fattore di offuscamento si ottiene applicando HMAC-SHA512 su 2 valori:
- la coordinata x di un punto segreto;
- e l'UTXO consumato come input nella transazione.
Bob, quindi, ha bisogno di queste due informazioni per decifrare il payload del codice di pagamento di Alice. Per l'UTXO come input, Bob può semplicemente recuperarlo osservando la transazione di notifica. Per il punto segreto, Bob dovrà usare ECDH. Come visto nella sezione precedente su Diffie-Hellman, semplicemente scambiando le rispettive chiavi pubbliche e applicando segretamente le proprie chiavi private alla chiave pubblica dell'altro, Alice e Bob possono trovare un punto specifico e segreto sulla curva ellittica. La transazione di notifica si basa su questo meccanismo:
- Coppia di chiavi di Bob:
$$ B = b \cdot G $$
- Coppia di chiavi di Alice:
$$ A = a \cdot G $$
- Per un segreto $S (x, y)$:
$$ S = a \cdot B = a \cdot (b \cdot G) = (b \cdot a) \cdot G = b \cdot A $$
Ora che Bob conosce il codice di pagamento di Alice, sarà in grado di rilevare i suoi pagamenti BIP47, e può derivare le chiavi private che bloccano i bitcoin ricevuti.
Ricapitoliamo i passaggi che abbiamo appena esaminato per ricevere e interpretare una transazione di notifica:
- Bob monitora gli output delle transazioni al suo indirizzo di notifica;
- Quando ne rileva uno, recupera le informazioni contenute nell'OP_RETURN;
- Bob seleziona la chiave pubblica in input e calcola un punto segreto usando ECDH;
- Usa questo punto segreto per calcolare un HMAC che è il fattore di offuscamento;
- Usa questo fattore di offuscamento per decifrare il payload del codice di pagamento di Alice contenuto nell'OP_RETURN.
### La Transazione di Pagamento BIP47
Studiamo ora insieme il processo di pagamento con BIP47. Per ricordarvi lo stato attuale delle cose:
- Alice conosce il codice di pagamento di Bob, che ha semplicemente recuperato dal suo sito web;
- Bob conosce il codice di pagamento di Alice grazie alla transazione di notifica;
- Alice effettuerà un primo pagamento a Bob. Potrà effettuarne molti altri allo stesso modo.
Prima di spiegare questo processo, penso sia importante ricordare gli indici su cui stiamo attualmente lavorando. Il percorso di derivazione di un codice di pagamento è descritto come segue: `m/47'/0'/0'`. La profondità successiva distribuisce gli indici in questo modo:
- La prima coppia di chiavi figlio normali (non rinforzate) è quella utilizzata per generare l'indirizzo di notifica di cui abbiamo parlato nella parte precedente: `m/47'/0'/0'/0`;
- Le coppie di chiavi figlio normali sono utilizzate all'interno di ECDH per generare indirizzi di ricezione dei pagamenti BIP47 come vedremo in questa sezione: da `m/47'/0'/0'/0` a `m/47'/0'/0'/2 147 483 647`;
- Le coppie di chiavi figlio rinforzate sono codici di pagamento effimeri: da `m/47'/0'/0'/0'` a `m/47'/0'/0'/2 147 483 647'`.
Ogni volta che Alice desidera inviare un pagamento a Bob, deriva un nuovo indirizzo vergine unico, grazie ancora al protocollo ECDH:
- Alice seleziona la prima chiave privata derivata dal suo codice di pagamento personale riutilizzabile:
$$ a $$
- Alice seleziona la prima chiave pubblica inutilizzata derivata dal codice di pagamento di Bob. Questa chiave pubblica, la chiameremo $B$. È associata alla chiave privata $b$ che solo Bob conosce:
$$ B = b \cdot G $$
- Alice calcola un punto segreto $S$ sulla curva ellittica tramite addizione e raddoppio di punti applicando la sua chiave privata $a$ alla chiave pubblica $B$ di Bob:
$$ S = a \cdot B $$
- Da questo punto segreto, Alice calcolerà il segreto condiviso $s$ (minuscolo). Per fare ciò, seleziona la coordinata x del punto segreto $S$ denominata $Sx$, e passa questo valore attraverso la funzione hash SHA256:
$$ S = (Sx, Sy) $$
$$ s = \text{SHA256}(Sx) $$
- Alice utilizza questo segreto condiviso $s$ per calcolare un indirizzo Bitcoin di ricezione dei pagamenti. Inizialmente, verifica che $s$ sia contenuto nell'ordine della curva secp256k1. In caso contrario, incrementa l'indice della chiave pubblica di Bob per derivare un altro segreto condiviso;
- In secondo luogo, calcola una chiave pubblica $K0$ aggiungendo sulla curva ellittica i punti $B$ e $s·G$. In altre parole, Alice aggiunge la chiave pubblica derivata dal codice di pagamento di Bob $B$ con un altro punto calcolato sulla curva ellittica tramite addizione e raddoppio con il segreto condiviso $s$ dal punto generatore della curva secp256k1 $G$. Questo nuovo punto rappresenta una chiave pubblica, e lo chiamiamo $K0$:
$$ K0 = B + s \cdot G $$
- Con questa chiave pubblica $K0$, Alice può derivare un indirizzo vergine standard di ricezione (per esempio, SegWit V0 in bech32).
Una volta che Alice ha ottenuto l'indirizzo di ricezione di Bob $K0$, può eseguire una transazione Bitcoin in modo standard. Per fare ciò, seleziona un UTXO di sua proprietà, assicurato da una coppia di chiavi di un ramo diverso del suo portafoglio HD, e lo spende per soddisfare un output all'indirizzo di Bob $K0$. È importante notare che questo pagamento, una volta derivato l'indirizzo, segue un processo convenzionale e non dipende più dalle chiavi associate a BIP47.
Ricapitoliamo i passaggi che abbiamo appena eseguito insieme per inviare un pagamento BIP47:
- Alice seleziona la prima chiave privata derivata dal suo codice di pagamento personale;
- Calcola un punto segreto sulla curva ellittica utilizzando ECDH dalla prima chiave pubblica derivata non utilizzata dal codice di pagamento di Bob;
- Utilizza questo punto segreto per calcolare un segreto condiviso con SHA256;
- Utilizza questo segreto condiviso per calcolare un nuovo punto segreto sulla curva ellittica;
- Aggiunge questo nuovo punto segreto alla chiave pubblica di Bob;
- Ottiene una nuova chiave pubblica effimera per la quale solo Bob ha la chiave privata associata;
- Alice può effettuare una transazione standard a Bob con l'indirizzo di ricezione effimero derivato.
![BTC204](assets/it/66/21.webp)
Se Alice desidera effettuare un secondo pagamento, seguirà gli stessi passaggi di prima, eccetto che questa volta selezionerà la seconda chiave pubblica derivata dal codice di pagamento di Bob. Specificamente, utilizzerà la prossima chiave non utilizzata. Otterrà così un nuovo indirizzo di ricezione appartenente a Bob, designato $K1$:
![BTC204](assets/it/66/22.webp)
Può continuare in questo modo e derivare fino a `2^32` indirizzi non utilizzati appartenenti a Bob.
Da un punto di vista esterno, osservando la blockchain, è teoricamente impossibile differenziare un pagamento BIP47 da un pagamento standard. Ecco un esempio di transazione di pagamento BIP47 sul Testnet:
```

94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
````
Questo sembra una transazione standard con un input consumato, un output di pagamento e un resto:
![BTC204](assets/fr/232.webp)
### Ricevere il Pagamento BIP47 e Derivare la Chiave Privata
Alice ha appena effettuato il suo primo pagamento a un nuovo indirizzo BIP47 appartenente a Bob. Ora vediamo come Bob riceve questo pagamento. Vedremo anche perché Alice non ha accesso alla chiave privata dell'indirizzo che ha appena generato da sola, e come Bob recupera questa chiave per spendere i bitcoin che ha appena ricevuto.
Non appena Bob riceve la transazione di notifica da Alice, deriva la chiave pubblica BIP47 $K0$ anche prima che lei abbia inviato qualsiasi pagamento. Poi monitora qualsiasi pagamento all'indirizzo associato. Infatti, deriva immediatamente diversi indirizzi che monitorerà ($K0$, $K1$, $K2$, $K3$...). Ecco come deriva questa chiave pubblica $K0$:
- Bob seleziona la prima chiave privata derivata dal suo codice di pagamento. Questa chiave privata è denominata $b$. È associata alla chiave pubblica $B$ con cui Alice aveva fatto i suoi calcoli nel passaggio precedente:
$$ b $$
- Bob seleziona la prima chiave pubblica di Alice derivata dal suo codice di pagamento. Questa chiave è denominata $A$. È associata alla chiave privata $a$ con cui Alice aveva fatto i suoi calcoli, e di cui solo Alice è a conoscenza. Bob può eseguire questo processo poiché è a conoscenza del codice di pagamento di Alice che le è stato trasmesso con la transazione di notifica:
$$ A = a \cdot G $$
- Bob calcola il punto segreto $S$, mediante addizione e raddoppio di punti sulla curva ellittica, applicando la sua chiave privata $b$ alla chiave pubblica di Alice $A$. Qui troviamo l'uso di ECDH che garantisce che questo punto $S$ sarà lo stesso sia per Bob che per Alice:
$$ S = b \cdot A $$
- Proprio come ha fatto Alice, Bob isola la coordinata x di questo punto $S$. Abbiamo chiamato questo valore $Sx$. Egli passa questo valore attraverso la funzione SHA256 per trovare il segreto condiviso $s$ (minuscolo):
$$ s = \text{SHA256}(Sx) $$
- Proprio come Alice, Bob calcola il punto $s·G$ sulla curva ellittica. Poi, aggiunge questo punto segreto alla sua chiave pubblica $B$. Ottiene così un nuovo punto sulla curva ellittica che interpreta come una chiave pubblica $K0$:
$$ K0 = B + s \cdot G $$
Una volta che Bob ha questa chiave pubblica $K0$, può derivare la chiave privata associata per essere in grado di spendere i suoi bitcoin. È l'unico che può generare questa chiave privata:
- Bob aggiunge la sua chiave privata figlio $b$ derivata dal suo codice di pagamento personale. È l'unico che può ottenere il valore di $b$. Poi, aggiunge $b$ con il segreto condiviso $s$ per ottenere $k0$, la chiave privata di $K0$:
$$ k0 = b + s $$
Grazie alla legge di gruppo della curva ellittica, Bob ottiene esattamente la chiave privata corrispondente alla chiave pubblica usata da Alice. Abbiamo quindi:
$$ K0 = k0 \cdot G $$
Riassumerò i passaggi che abbiamo appena esaminato insieme per ricevere un pagamento BIP47 e calcolare la chiave privata corrispondente:
- Bob seleziona la prima chiave privata figlio derivata dal suo codice di pagamento personale;
- Calcola un punto segreto sulla curva ellittica usando ECDH dalla prima chiave pubblica figlio derivata dal codice catena di Alice;
- Usa questo punto segreto per calcolare un segreto condiviso con SHA256;
- Usa questo segreto condiviso per calcolare un nuovo punto segreto sulla curva ellittica;
- Aggiunge questo nuovo punto segreto alla sua chiave pubblica personale;
- Ottiene una nuova chiave pubblica effimera, alla quale Alice invierà il suo primo pagamento;
- Bob calcola la chiave privata associata a questa chiave pubblica effimera aggiungendo la sua chiave privata figlio derivata dal suo codice di pagamento e il segreto condiviso.
![BTC204](assets/it/66/24.webp)
Poiché Alice non può ottenere $b$ (la chiave privata di Bob), lei non è in grado di determinare $k0$ (la chiave privata associata all'indirizzo di ricezione BIP47 di Bob). Schematicamente, possiamo rappresentare il calcolo del segreto condiviso $S$ così:
![BTC204](assets/it/66/19.webp)
Una volta trovato il segreto condiviso con ECDH, Alice e Bob calcolano la chiave pubblica di pagamento BIP47 $K0$, e Bob calcola anche la chiave privata associata $k0$:
![BTC204](assets/it/66/25.webp)
### Rimborsare il Pagamento BIP47
Poiché Bob è a conoscenza del codice di pagamento riutilizzabile di Alice, ha già tutte le informazioni necessarie per inviarle un rimborso. Non avrà bisogno di contattare nuovamente Alice per chiedere informazioni. Dovrà semplicemente notificarla con una transazione di notifica, specialmente affinché lei possa recuperare i suoi indirizzi BIP47 con il suo seed, e poi potrà anche inviarle fino a `2^32` pagamenti.
La funzionalità di rimborso è specifica per BIP47 ed è uno dei suoi vantaggi rispetto ad altri metodi che studieremo nei prossimi capitoli, come i Pagamenti Silenziosi.
Bob può quindi rimborsare Alice nello stesso modo in cui lei gli ha inviato i pagamenti. I ruoli si invertono:
![BTC204](assets/it/66/26.webp)
_Un grande ringraziamento a [Fanis Michalakis](https://x.com/FanisMichalakis) per la sua revisione e preziosi consigli esperti sull'articolo che ha ispirato la scrittura di questo capitolo!_
https://planb.network/tutorials/privacy/on-chain/paynym-bip47-a492a70b-50eb-4f95-a766-bae2c5535093
## Pagamenti Silenziosi
<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>
Il BIP47 è stato criticato per la sua inefficienza sulla blockchain. Come spiegato nel capitolo precedente, richiede una transazione di notifica per ogni nuovo destinatario. Questo vincolo diventa trascurabile se si prevede di stabilire un canale di pagamento duraturo con questo destinatario. Infatti, una singola transazione di notifica apre la strada a un numero quasi infinito di pagamenti BIP47 successivi.
Tuttavia, in determinate situazioni, la transazione di notifica può rappresentare un ostacolo per l'utente. Prendiamo l'esempio di una donazione una tantum a un destinatario: con un indirizzo Bitcoin classico, una singola transazione è sufficiente per effettuare la donazione. Ma con il BIP47, sono necessarie due transazioni: una per la notifica e un'altra per il pagamento effettivo. Quando la domanda di spazio nel blocco è bassa e le commissioni di transazione sono minime, questo passaggio aggiuntivo generalmente non rappresenta un problema. Tuttavia, durante i periodi di congestione, le commissioni di transazione possono diventare esorbitanti per un singolo pagamento, potenzialmente raddoppiando il costo per l'utente rispetto a una transazione Bitcoin standard, il che può essere inaccettabile per l'utente.
Per situazioni in cui l'utente prevede di effettuare solo pochi pagamenti a un identificatore statico, sono state sviluppate altre soluzioni. Tra queste ci sono i Pagamenti Silenziosi, descritti nel [BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki). Questo protocollo consente l'uso di un identificatore statico per ricevere pagamenti senza generare riutilizzo dell'indirizzo e senza richiedere l'uso di transazioni di notifica. Esaminiamo come funziona questo protocollo.
---
_Per comprendere appieno questo capitolo, è essenziale essere familiari con il funzionamento di ECDH (Elliptic Curve Diffie-Hellman) e la derivazione delle chiavi crittografiche in un portafoglio HD. Questi concetti sono stati dettagliati nel capitolo precedente sul BIP47. Non li ripeterò qui. Se non sei ancora familiare con queste nozioni, ti consiglio di consultare il capitolo precedente prima di continuare con questo. Non riprenderò nemmeno i rischi associati al riutilizzo degli indirizzi di ricezione, né l'importanza di avere un identificatore unico per ricevere pagamenti._
---
### Perché non spostare la notifica?
Come discusso nel capitolo sul BIP47, la transazione di notifica svolge principalmente due funzioni:
- Notifica il destinatario;
- Trasmette il codice di pagamento del mittente.
Si potrebbe ingenuamente pensare che questo processo di notifica potrebbe essere effettuato off-chain. In teoria, ciò è completamente fattibile: sarebbe sufficiente per il destinatario indicare un mezzo di comunicazione per ricevere i codici di pagamento BIP47 dai mittenti. Tuttavia, questo approccio presenta due problemi principali:
- Primo, ciò sposterebbe il processo di trasmissione del codice su un altro protocollo di comunicazione. Le questioni relative ai costi e alla privacy dello scambio rimarrebbero, ma sarebbero semplicemente trasferite a questo nuovo protocollo. In termini di privacy, ciò potrebbe anche creare un collegamento tra l'identità di un utente e l'attività sulla blockchain, cosa che cerchiamo di evitare eseguendo la notifica direttamente sulla blockchain. Inoltre, effettuare la notifica fuori dalla blockchain introdurrebbe rischi di censura (come il blocco dei fondi) che non esistono su Bitcoin;
Successivamente, ciò porrebbe un problema di recupero. Con BIP47, il destinatario deve assolutamente conoscere i codici di pagamento dei mittenti per accedere ai fondi. Questo è vero al momento della ricezione, ma anche in caso di recupero dei fondi tramite il seed in caso di perdita del portafoglio. Con le notifiche onchain, questo rischio viene evitato, poiché l'utente può trovare e decifrare le transazioni di notifica semplicemente conoscendo il proprio seed. Tuttavia, se la notifica viene eseguita fuori dalla blockchain, l'utente dovrebbe mantenere un backup dinamico di tutti i codici di pagamento ricevuti, il che è impraticabile per l'utente medio.
Tutti questi vincoli rendono l'uso della notifica onchain indispensabile nel contesto di BIP47. Eppure, i Pagamenti Silenziosi cercano specificamente di evitare questo passaggio di notifica onchain a causa del suo costo. Pertanto, la soluzione adottata non è spostare la notifica, ma eliminarla completamente. Per raggiungere questo obiettivo, deve essere accettato un compromesso: quello della scansione. A differenza di BIP47, dove l'utente sa esattamente dove trovare i propri fondi grazie alle transazioni di notifica, nel contesto dei Pagamenti Silenziosi, l'utente deve esaminare tutte le transazioni Bitcoin esistenti per rilevare eventuali pagamenti che potrebbero essere destinati a loro. Per ridurre questo onere operativo, la ricerca di Pagamenti Silenziosi è limitata solo alle transazioni che probabilmente contengono tali pagamenti, ovvero quelle che includono almeno un output Taproot P2TR. La scansione si concentra esclusivamente anche sulle transazioni dalla data di creazione del portafoglio (non c'è bisogno di scandire transazioni risalenti al 2009 se il portafoglio è stato creato nel 2024).
Pertanto, potete vedere perché BIP47 e Pagamenti Silenziosi, sebbene mirino a un obiettivo simile, comportano compromessi diversi e **quindi si rivolgono effettivamente a casi d'uso distinti**. Per i pagamenti una tantum, come le donazioni occasionali, i Pagamenti Silenziosi sono più appropriati a causa del loro costo inferiore. Al contrario, per le transazioni regolari allo stesso destinatario, come nel caso delle piattaforme di scambio o dei pool di mining, BIP47 potrebbe essere preferito.
Esploriamo insieme il funzionamento tecnico dei Pagamenti Silenziosi per capirne meglio le implicazioni. Per fare ciò, suggerisco di adottare lo stesso approccio del documento esplicativo di BIP352. Scomporremo gradualmente i calcoli da eseguire, elemento per elemento, giustificando ogni nuova aggiunta.
### Alcuni concetti da comprendere
Prima di iniziare, è importante chiarire che i Pagamenti Silenziosi si basano esclusivamente sull'uso di tipi di script P2TR (_Pay to Taproot_). A differenza di BIP47, non è necessario derivare gli indirizzi di ricezione dalle chiavi pubbliche figlie tramite hashing. Infatti, nello standard P2TR, la chiave pubblica modificata viene utilizzata direttamente e apertamente nell'indirizzo. Così, un indirizzo di ricezione Taproot è essenzialmente una chiave pubblica accompagnata da alcuni metadati. Questa chiave pubblica modificata è l'aggregazione di altre due chiavi pubbliche: una che consente la spesa diretta e tradizionale tramite una semplice firma, e l'altra che rappresenta la radice di Merkle del MAST, che autorizza la spesa soggetta alla soddisfazione di una delle condizioni potenzialmente iscritte nell'albero di Merkle.
![BTC204](assets/it/67/01.webp)
La decisione di limitare i Pagamenti Silenziosi esclusivamente a Taproot è motivata da due ragioni principali:
- Primo, facilita significativamente l'implementazione e gli aggiornamenti futuri nel software del portafoglio, poiché è necessario aderire a un solo standard;
- In secondo luogo, questo approccio aiuta a migliorare l'insieme di anonimato degli utenti incoraggiandoli a non disperdersi tra diversi tipi di script, che generano impronte di portafoglio distinte nell'analisi della catena (per maggiori informazioni su questo concetto, vi invito a consultare il capitolo 4 della parte 2).
### Derivazione naive di una chiave pubblica di Pagamenti Silenziosi
Iniziamo con un semplice esempio che ti aiuterà a comprendere il funzionamento di base dei Pagamenti Silenziosi (SP, Silent Payments). Prendiamo Alice e Bob, due utenti Bitcoin. Alice vuole inviare bitcoin a Bob su un nuovo indirizzo di ricezione. Tre obiettivi devono essere raggiunti in questo processo:
- Alice deve essere in grado di generare un nuovo indirizzo;
- Bob deve essere in grado di identificare un pagamento inviato a questo specifico indirizzo;
- Bob deve essere in grado di ottenere la chiave privata associata a questo indirizzo per poter spendere i suoi fondi.
Alice ha un UTXO nel suo portafoglio Bitcoin protetto con la seguente coppia di chiavi:
- $a$: la chiave privata;
- $A$: la chiave pubblica ($A = a \cdot G$)
Bob ha un indirizzo SP che ha pubblicato su internet con:
- $b$: la chiave privata;
- $B$: la chiave pubblica ($B = b \cdot G$)
Recuperando l'indirizzo di Bob, Alice è in grado di calcolare un nuovo indirizzo vuoto che appartiene a Bob usando ECDH. Chiamiamo questo indirizzo $P$:
$$ P = B + \text{hash}(a \cdot B) \cdot G $$
In questa equazione, Alice ha semplicemente calcolato il prodotto scalare della sua chiave privata $a$ e della chiave pubblica di Bob $B$. Ha passato questo risultato attraverso una funzione hash conosciuta da tutti. Il valore di output è poi moltiplicato scalarmente per il punto generatore $G$ della curva ellittica `secp256k1`. Infine, Alice aggiunge il punto ottenuto alla chiave pubblica di Bob $B$. Una volta che Alice ha questo indirizzo $P$, lo usa come output in una transazione, il che significa che invia bitcoin ad esso.
> _Nel contesto dei Pagamenti Silenziosi, la funzione "hash" corrisponde a una funzione hash SHA256 etichettata specificamente con `BIP0352/SharedSecret`, assicurando che gli hash generati siano unici per questo protocollo e non possano essere riutilizzati in altri contesti, fornendo anche una protezione aggiuntiva contro il riutilizzo di nonce nelle firme. Questo standard corrisponde a quello [specificato nel BIP340 per le firme Schnorr](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) su `secp256k1`._
Grazie alle proprietà della curva ellittica su cui si basa ECDH, sappiamo che:
$$ a \cdot B = b \cdot A $$
Bob sarà quindi in grado di calcolare l'indirizzo di ricezione su cui Alice ha inviato i bitcoin. Per fare ciò, monitora tutte le transazioni Bitcoin che soddisfano i criteri dei Pagamenti Silenziosi e applica il seguente calcolo a ciascuna di esse per vedere se il pagamento è indirizzato a lui (_scanning_):
$$ P' = B + \text{hash}(b \cdot A) \cdot G $$
Quando esamina la transazione di Alice, si rende conto che $P'$ è uguale a $P$. Sa quindi che questo pagamento è indirizzato a lui:
$$ P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P $$
Da qui, Bob sarà in grado di calcolare la chiave privata $p$ che consente di spendere l'indirizzo $P$:
$$ p = (b + \text{hash}(b \cdot A)) \bmod n $$
Come puoi vedere, per calcolare questa chiave privata $p$, è necessario avere la chiave privata $b$. Solo Bob ha questa chiave privata $b$. Sarà quindi effettivamente l'unico in grado di spendere i bitcoin inviati al suo indirizzo di Pagamenti Silenziosi.
![BTC204](assets/fr/236.webp)
_Didascalia:_
- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s$: Il segreto comune ECDH
- $P$: La chiave pubblica / indirizzo unico per il pagamento a Bob
Ecco un approccio inizialmente piuttosto ingenuo nell'uso dell'indirizzo statico di Bob, denotato $B$, per derivare un indirizzo unico $P$ per inviare bitcoin. Tuttavia, questo metodo è troppo semplicistico e presenta diversi difetti che necessitano di correzione. Il primo problema è che, in questo schema, Alice non può creare molteplici output per Bob all'interno della stessa transazione.
### Come creare molteplici output?
Nell'esempio della sezione precedente, Alice crea un singolo output che andrà a Bob al suo indirizzo unico $P$. Con lo stesso input selezionato, è impossibile per Alice creare due indirizzi vergini distinti per Bob, poiché il metodo utilizzato porterebbe sempre allo stesso risultato per $P$, quindi allo stesso indirizzo. Tuttavia, ci possono essere molte situazioni in cui Alice desidera dividere il suo pagamento a Bob in diverse piccole somme, creando così molteplici UTXO. È quindi necessario trovare un metodo che permetta di farlo.
Per raggiungere questo obiettivo, modificheremo leggermente il calcolo che Alice esegue per derivare $P$, in modo che possa generare due indirizzi distinti per Bob, ovvero $P_0$ e $P_1$.
Per modificare il calcolo e ottenere 2 indirizzi diversi, è sufficiente aggiungere un intero che modifica il risultato. Così, Alice aggiungerà $0$ nel suo calcolo per ottenere l'indirizzo $P_0$ e $1$ per ottenere l'indirizzo $P_1$. Chiamiamo questo intero $i$:
$$ P_i = B + \text{hash}(a \cdot B \text{ ‖ } i) \cdot G $$
Il processo di calcolo rimane invariato rispetto al metodo precedente, eccetto che questa volta Alice concatenerà $a \cdot B$ con $i$ prima di procedere al hash. È quindi sufficiente cambiare $i$ per avere un nuovo indirizzo appartenente a Bob. Ad esempio:
$$ P_0 = B + \text{hash}(a \cdot B \text{ ‖ } 0) \cdot G $$
$$ P_1 = B + \text{hash}(a \cdot B \text{ ‖ } 1) \cdot G $$
Quando Bob esamina la blockchain per i Pagamenti Silenziosi destinati a lui, inizia utilizzando $i = 0$ per l'indirizzo $P_0$. Se non trova nessun pagamento su $P_0$, conclude che questa transazione non contiene nessun Pagamento Silenzioso per lui e smette di analizzarla. Tuttavia, se $P_0$ è valido e contiene un pagamento per lui, procede con $P_1$ nella stessa transazione per verificare se Alice ha effettuato un secondo pagamento. Se $P_1$ risulta essere invalido, interrompe la sua ricerca per questa transazione; altrimenti, continua a testare valori successivi di $i$.
$$ P_1 = B + \text{hash}(b \cdot A \text{ ‖ } 1) \cdot G $$
Poiché Bob si ferma immediatamente a $i = 0$ se $P_0$ non produce risultati, l'uso di questo intero aggiunge quasi nessun onere operativo aggiuntivo a Bob per la fase di scansione delle transazioni.
Bob può quindi calcolare le chiavi private nello stesso modo:
$$

p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n

$$
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n
$$

_Didascalia:_


- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La clave pública del UTXO de Alice utilizada como entrada para la transferencia
- $a$: La chiave privata di Alice
- $G$: El punto generador de la curva elíptica `secp256k1`
- $\text{SHA256}$: La funzione di hash SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: El primer secreto oculto ECDH
- $s_1$: El segundo segmento condensado ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
- $P_1$: La segunda clave pública / dirección única para el pago a Bob

Con este método, empezamos a crear un buen protocolo, pero también hay que superar algunos obstáculos, en particular la prevención de la reutilización de los indicios.

### ¿Cómo evitar el uso indebido de los indicadores?

Como hemos visto en las secciones anteriores, Alice utiliza la combinación de claves que protegen su UTXO, que gastará para calcular el segmento condividido ECDH con Bob. Este secreto le permite obtener el identificador único $P_0$. Sin embargo, la pareja de claves ($a$, $A$) utilizada por Alice puede proteger más UTXO si ha utilizado este identificador varias veces. En el caso de que Alice efectúe dos pagos al identificador estático $B$ de Bob utilizando dos UTXO protegidos por la misma clave $A$, esto supondrá un uso indebido del identificador por parte de Bob.

> el uso de identificadores es una práctica muy negativa para la privacidad de los usuarios. Para saber por qué, te recomendamos que consultes las primeras partes de este manual
Además, como el identificador único $P_0$ se deriva de $A$ y $B$, si Alice deriva un segundo identificador para un segundo pago a $B$, con la misma clave $A$, acabará obteniendo el mismo identificador $P_0$. Para evitar este riesgo y prevenir el uso indebido de los ingresos dentro de los Pagos Silenciosos, debemos modificar ligeramente nuestros cálculos.

Lo que queremos es que cada UTXO consumido por Alice como entrada de un pago tenga un identificador único de la cuenta de Bob, aunque más UTXO estén protegidos por la misma pareja de claves. Por lo tanto, basta con añadir una referencia al UTXO en el cálculo del índice único $P_0$. Esta referencia será simplemente el hash del UTXO consumido como entrada:

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$

Con esta referencia de entrada, Alice lo añadirá a su cálculo del índice único $P_0$:

Durante su exploración, Bob también puede añadir $\text{inputHash}$, ya que todo lo que debe hacer es observar la transición para deducir $\text{outpoint}$:

$$ P_0 = B + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0) \cdot G $$

Cuando se encuentra un $P_0$ válido, se puede calcular la clave privada $p_0$ correspondiente:

$$
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
$$

```text
_Legenda:_
- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $H$: L'hash dell'UTXO usato come input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hash SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
Al momento, i nostri calcoli presuppongono che Alice utilizzi un singolo input per la sua transazione. Tuttavia, dovrebbe essere in grado di utilizzare più input. Di conseguenza, da parte di Bob, per ogni transazione contenente più input, teoricamente avrebbe bisogno di calcolare l'ECDH per ogni input per determinare se un pagamento è destinato a lui. Questo metodo non è soddisfacente, quindi abbiamo bisogno di trovare una soluzione per ridurre il carico di lavoro!
### Modificare le chiavi pubbliche negli input
Per risolvere questo problema, invece di utilizzare la coppia di chiavi che protegge un input specifico da parte di Alice, useremo la somma di tutte le coppie di chiavi utilizzate negli input della transazione. Questa somma sarà quindi considerata come una nuova coppia di chiavi. Questa tecnica è nota come "tweak".
Per esempio, immagina che la transazione di Alice abbia 3 input, ognuno protetto con una coppia di chiavi diversa:
- $a_0$ protegge l'input #0;
- $a_1$ protegge l'input #1;
- $a_2$ protegge l'input #2.
Seguendo il metodo descritto sopra, Alice dovrebbe scegliere una singola coppia di chiavi tra $a_0$, $a_1$ e $a_2$ per calcolare il segreto ECDH e generare l'indirizzo di pagamento unico $P$ dall'indirizzo statico $B$ di Bob. Tuttavia, questo approccio richiede a Bob di testare ogni possibilità sequenzialmente, partendo da $a_0$, poi $a_1$, e così via, fino all'identificazione di una coppia che genera un indirizzo valido $P$. Questo processo richiede che Bob esegua il calcolo ECDH su tutti gli input di tutte le transazioni, aumentando significativamente il carico di lavoro operativo di scansione.
Per evitare ciò, chiederemo ad Alice di eseguire il suo calcolo di $P$ utilizzando la somma di tutte le chiavi in input. Prendendo il nostro esempio, la chiave privata modificata $a$ sarebbe calcolata come segue:
$$ a = a_0 + a_1 + a_2 $$
Allo stesso modo, Alice e Bob saranno in grado di calcolare la chiave pubblica modificata:
$$ A = A_0 + A_1 + A_2 $$
Grazie a questo metodo, a Bob basta calcolare la somma delle chiavi pubbliche della transazione, poi calcolare il segreto ECDH da $A$ soltanto, il che riduce notevolmente il numero di calcoli da fare per la fase di scansione. Tuttavia, ricorda dalla sezione precedente. Avevamo incluso nel nostro calcolo l'hash $\text{inputHash}$ che viene usato come nonce per prevenire il riutilizzo degli indirizzi:
$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$
Ma se ci sono più input in una transazione, è necessario determinare quale $\text{outpoint}$ viene scelto in questo calcolo. Secondo il BIP352, il criterio di selezione per $\text{outpoint}$ da usare è scegliere il più piccolo lessicograficamente, il che significa selezionare l'UTXO che appare per primo in ordine alfabetico. Questo metodo standardizza l'UTXO da scegliere in ogni transazione. Ad esempio, se questo $\text{outpoint}$ più piccolo lessicograficamente è $\text{outpoint}_L$, il calcolo di $\text{inputHash}$ sarà:
$$ \text{inputHash} = \text{hash}(\text{outpoint}\_L \text{ ‖ } A) $$
I calcoli rimangono quindi identici a quelli presentati nella sezione precedente, eccetto che la chiave privata $a$ e la sua corrispondente chiave pubblica $A$ non rappresentano più una coppia che protegge un singolo input, ma ora rappresentano la modifica di tutte le coppie di chiavi negli input.
### Separare le Chiavi di Spesa e di Scansione
Finora, abbiamo discusso dell'indirizzo statico di Pagamento Silenzioso $B$ come di una chiave pubblica unica. Ricorda, è questa chiave pubblica $B$ che viene usata da Alice per creare il segreto condiviso ECDH, che a sua volta viene usato per calcolare l'indirizzo di pagamento unico $P$. Bob usa questa chiave pubblica $B$ e la corrispondente chiave privata $b$ per la fase di scansione. Ma userà anche la chiave privata $b$ per calcolare la chiave privata $p$ che consente di spendere dall'indirizzo $P$.
Lo svantaggio di questo metodo è che la chiave privata $b$, che viene usata per calcolare tutte le chiavi private per gli indirizzi che ricevono Pagamenti Silenziosi, viene anche usata da Bob per scansionare le transazioni. Questo passaggio richiede che la chiave $b$ sia disponibile su un software di portafoglio connesso a Internet, il che la espone a un rischio maggiore di furto rispetto al mantenerla su un portafoglio freddo. Idealmente, sarebbe vantaggioso poter approfittare dei Pagamenti Silenziosi mantenendo la chiave privata $b$, che controlla l'accesso a tutte le altre chiavi private, al sicuro su un portafoglio hardware. Fortunatamente, il protocollo è stato adattato per permettere esattamente questo.
Per raggiungere questo obiettivo, il BIP352 specifica che il ricevente usa 2 diverse coppie di chiavi:
- $B_{\text{spend}}$: per calcolare le chiavi private degli indirizzi di pagamento unici;
- $B_{\text{scan}}$: per trovare indirizzi di pagamento unici.
In questo modo, Bob può mantenere la chiave privata $b_{\text{spend}}$ su un portafoglio hardware e usare la chiave privata $b_{\text{scan}}$ su software online per trovare i suoi Pagamenti Silenziosi, senza rivelare $b_{\text{spend}}$. Tuttavia, le chiavi pubbliche $B_{\text{scan}}$ e $B_{\text{spend}}$ sono entrambe pubblicamente rivelate, poiché si trovano nell'indirizzo statico di Bob $B$:
Per calcolare un indirizzo di pagamento unico $P_0$ appartenente a Bob, Alice eseguirà il seguente calcolo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot a \cdot B\_{\text{scan}} \text{ ‖ } 0) \cdot G $$
Per trovare i pagamenti indirizzati a lui, Bob eseguirà il seguente calcolo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$
Come puoi vedere, fino a questo momento, Bob non ha avuto bisogno di usare $b_{\text{spend}}$ che si trova sul suo portafoglio hardware. Quando desidera spendere $P_0$, può quindi eseguire il seguente calcolo per trovare la chiave privata $p_0$:
$$ p*0 = (b*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$
_Didascalia:_
- $B_{\text{scan}}$: Chiave pubblica di scansione di Bob (indirizzo statico)
- $b_{\text{scan}}$: Chiave privata di scansione di Bob
- $B_{\text{spend}}$: Chiave pubblica di spesa di Bob (indirizzo statico)
- $b_{\text{spend}}$: Chiave privata di spesa di Bob
- $A$: La somma delle chiavi pubbliche in input (tweak)
- $a$: La chiave privata corrispondente alla chiave pubblica modificata
- $H$: L'hash dell'UTXO più piccolo (lessicograficamente) usato in input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo di pagamento unico per Bob
### Utilizzando indirizzi SP con un'etichetta
Bob ha quindi un indirizzo statico $B$ per i Pagamenti Silenziosi come segue:
$$ B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}} $$
Il problema con questo metodo è che non permette di segregare i diversi pagamenti inviati a questo indirizzo. Ad esempio, se Bob ha 2 clienti diversi per la sua attività e vuole differenziare chiaramente i pagamenti da ciascuno, avrebbe bisogno di 2 indirizzi statici diversi. Una soluzione ingenua, con l'approccio attuale, sarebbe che Bob crei due portafogli separati, ognuno con il proprio indirizzo statico, o addirittura stabilisca due indirizzi statici diversi all'interno dello stesso portafoglio. Tuttavia, questa soluzione richiede la scansione dell'intera blockchain due volte (una per ciascun indirizzo) per rilevare rispettivamente i pagamenti destinati a ciascun indirizzo. Questa doppia scansione aumenta in modo irragionevole l'onere operativo per Bob.
Per risolvere questo problema, BIP352 utilizza un sistema di etichettatura che consente di avere diversi indirizzi statici senza aumentare in modo irragionevole il carico di lavoro per trovare Pagamenti Silenziosi sulla blockchain. Per fare ciò, viene aggiunto un intero $m$ alla chiave pubblica di spesa $B_{\text{spend}}$. Questo intero può assumere il valore di $1$ per il primo indirizzo statico, poi $2$ per il secondo, e così via. Le chiavi di spesa $B_{\text{spend}}$ saranno d'ora in poi chiamate $B_m$ e saranno costruite in questo modo:
$$ B*m = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } m) \cdot G $$
Per esempio, per la prima chiave di spesa con l'etichetta $1$:
$$ B*1 = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } 1) \cdot G $$
L'indirizzo statico pubblicato da Bob consisterà ora di $B_{\text{scan}}$ e $B_m$. Per esempio, il primo indirizzo statico con l'etichetta $1$ sarà:
$$ B = B\_{\text{scan}} \text{ ‖ } B_1 $$
> _Iniziamo solo dall'etichetta 1 perché l'etichetta 0 è riservata per il resto._
Alice, da parte sua, deriverà l'indirizzo di pagamento unico $P$ nello stesso modo di prima, ma utilizzando il nuovo $B_1$ invece di $B_{\text{spend}}$.
$$ P*0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B*{\text{scan}} \text{ ‖ } 0) \cdot G $$
In realtà, Alice potrebbe non sapere nemmeno che Bob ha un indirizzo etichettato, poiché lei semplicemente utilizza la seconda parte dell'indirizzo statico che lui le ha fornito, che in questo caso, è il valore $B_1$ piuttosto che $B_{\text{spend}}$.
Per scansionare i pagamenti, Bob utilizzerà sempre il valore del suo indirizzo statico iniziale con $B_{\text{spend}}$ in questo modo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$
Poi, semplicemente sottrae il valore che trova per $P_0$ da ogni output uno per uno. Poi controlla se uno dei risultati di queste sottrazioni corrisponde al valore di una delle etichette che usa nel suo portafoglio. Se corrisponde, per esempio, per l'output #4 con l'etichetta $1$, ciò significa che questo output è un Pagamento Silenzioso associato al suo indirizzo statico etichettato $B_1$:
$$ Out*4 - P_0 = \text{hash}(b*{\text{scan}} \text{ ‖ } 1) \cdot G $$
Questo funziona perché:
$$ B*1 = B*{\text{spend}} + \text{hash}(b*{\text{scan}} \text{ ‖ } 1) \cdot G $$
Grazie a questo metodo, Bob può utilizzare una moltitudine di indirizzi statici ($B_1$, $B_2$, $B_3$...), tutti derivati dal suo indirizzo statico base ($B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}}$), al fine di separare correttamente gli usi.
Tuttavia, questa separazione degli indirizzi statici è valida solo da una prospettiva di gestione personale del portafoglio e non consente la separazione delle identità. Poiché tutti hanno lo stesso $B*{\text{scan}}$, è molto facile associare tutti gli indirizzi statici insieme e dedurre che appartengono a una singola entità.
_Didascalia:_
- $B_{\text{scan}}$: chiave pubblica di scansione di Bob (indirizzo statico)
- $b_{\text{scan}}$: chiave privata di scansione di Bob
- $B_{\text{spend}}$: chiave pubblica di spesa di Bob (indirizzo iniziale)
- $B_m$: chiave pubblica di spesa etichettata di Bob (indirizzo statico)
- $b_m$: chiave privata di spesa etichettata di Bob
- $A$: La somma delle chiavi pubbliche in input (tweak)
- $a$: La chiave privata corrispondente alla chiave pubblica modificata
- $H$: L'hash del più piccolo UTXO (lessicograficamente) utilizzato come input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
- $p_0$: La chiave privata del primo indirizzo di pagamento unico a Bob
- $X$: L'hash della chiave privata di scansione con l'etichetta
### Come Costruire un Indirizzo per Pagamenti Silenziosi?
Per costruire un indirizzo dedicato ai Pagamenti Silenziosi, è necessario prima derivare 2 coppie di chiavi nel proprio portafoglio Bitcoin HD:
- La coppia $b_{\text{scan}}$, $B_{\text{scan}}$ per cercare i pagamenti indirizzati a noi;
- La coppia $b_{\text{spend}}$, $B_{\text{spend}}$ per spendere i bitcoin che abbiamo ricevuto.
Queste coppie sono derivate seguendo questi percorsi (_Bitcoin Mainnet_):
scan: m / 352' / 0' / 0' / 1' / 0
spend: m / 352' / 0' / 0' / 0' / 0
```

```text
Una volta disponibili queste 2 coppie di chiavi, si concatenano semplicemente (una di seguito all'altra) per creare il payload dell'indirizzo statico:
$$ B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}} $$
Se si desidera utilizzare etichette, $B_{\text{spend}}$ viene sostituito con $B_m$:
$$ B = B\_{\text{scan}} \text{ ‖ } B_m $$
Con l'etichetta $m$:
$$ B*m = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } m) \cdot G $$
Una volta disponibile questo payload, si aggiunge la HRP (_Human-Readable Part_) `sp` e la versione `q` (= versione 0). Viene anche aggiunto un checksum, e l'indirizzo è formattato in bech32m.
Ad esempio, ecco il mio indirizzo statico per i Pagamenti Silenziosi:
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```