---
name: Ochrana osobních údajů v bitcoinech
goal: Pochopení a zvládnutí zásad ochrany soukromí při používání Bitcoinu
objectives: 

  - Definovat teoretické koncepty potřebné k pochopení významu ochrany soukromí
  - Vědět, jak identifikovat a zmírnit rizika spojená se ztrátou soukromí uživatelů bitcoinů
  - Používání metod a nástrojů na ochranu soukromí na Bitcoinu
  - Porozumět metodám analýzy řetězců a vypracovat obranné strategie

---
# Chraňte své soukromí na Bitcoin

Ve světě, kde se soukromí finančních transakcí postupně stává luxusem, je pochopení a zvládnutí zásad ochrany soukromí při používání Bitcoinu nezbytné. Toto školení vám poskytne všechny klíče, teoretické i praktické, abyste tohoto cíle dosáhli sami.

V současné době existují společnosti, které se specializují na analýzu řetězce Bitcoin. Jejich hlavní činností je právě narušování vašeho soukromí s cílem ohrozit důvěrnost vašich transakcí. Ve skutečnosti "právo na soukromí" na Bitcoinu neexistuje. Je tedy na vás, uživatelích, abyste se domáhali svých přirozených práv a chránili důvěrnost svých transakcí, protože nikdo jiný to za vás neudělá.

Toto školení je prezentováno jako komplexní, všeobecný kurz. Každý technický pojem je podrobně popsán a podpořen vysvětlujícími schématy. Cílem je zpřístupnit znalosti každému. Školení BTC204 je proto přístupné začátečníkům i středně pokročilým uživatelům. Toto školení nabízí přidanou hodnotu i zkušenějším bitcoinářům, protože se v něm ponoříme do některých často neznámých technických pojmů.

Připojte se k nám, abyste změnili způsob používání bitcoinu a stali se informovanými uživateli, kteří rozumí otázkám důvěrnosti a chrání své soukromí.

+++
# Úvod

<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## Úvod do školení

<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

Ve světě, kde se soukromí finančních transakcí postupně stává luxusem, je pochopení a zvládnutí zásad ochrany soukromí při používání Bitcoinu nezbytné. Toto školení vám poskytne všechny klíče, teoretické i praktické, abyste tohoto cíle dosáhli sami.

V ekosystému bitcoinu dnes existují společnosti, které se specializují na analýzu blockchainu. Jejich hlavní činností je právě narušování vašeho soukromí a ohrožování důvěrnosti vašich transakcí. Ve skutečnosti "právo na soukromí" na Bitcoinu neexistuje. Je tedy na vás, uživatelích, abyste se domáhali svých přirozených práv a chránili důvěrnost svých transakcí, protože nikdo jiný to za vás neudělá.

Bitcoin tu není jen pro "Number Go Up" a zachování hodnoty úspor. Díky svým jedinečným vlastnostem a historii je především nástrojem alternativní ekonomiky. Díky tomuto pozoruhodnému vynálezu můžete volně nakládat se svými penězi, utrácet je a hromadit, aniž by vám v tom kdokoli mohl zabránit.

Bitcoin nabízí klidný únik z područí států a umožňuje vám plně využívat vašich přirozených práv, která nelze zpochybnit zavedenými zákony. Díky vynálezu Satoshiho Nakamota máte možnost prosadit své právo na soukromé vlastnictví a znovu získat svobodu uzavírat smlouvy.

Bitcoin však ve výchozím nastavení není anonymní, což může představovat riziko pro jednotlivce zapojené do alternativní ekonomiky, zejména v regionech s despotickými režimy. To však není jediné nebezpečí. Protože bitcoin je cenné a necenzurované aktivum, může přitahovat pozornost zlodějů. Ochrana soukromí se proto stává také otázkou bezpečnosti: může vám pomoci zabránit kybernetickým útokům a fyzickým napadením.

Jak uvidíme, ačkoli protokol nabízí určitou inherentní ochranu soukromí, je nezbytné používat další nástroje k optimalizaci a ochraně tohoto soukromí. Tento kurz je koncipován jako komplexní, všeobecná cesta k pochopení problematiky ochrany soukromí v Bitcoinu. Každý technický pojem je podrobně probrán a podpořen vysvětlujícími diagramy. Cílem je zpřístupnit znalosti všem, včetně začínajících a středně pokročilých uživatelů. Pro zkušenější bitcoináře se v průběhu tohoto kurzu věnujeme i velmi technickým a někdy méně známým pojmům, abychom prohloubili porozumění jednotlivým tématům.

Cílem tohoto kurzu není zajistit, abyste byli při používání Bitcoinu zcela anonymní, ale spíše vám poskytnout základní nástroje, abyste věděli, jak chránit své soukromí v souladu s vašimi osobními cíli. Z představených konceptů a nástrojů si budete moci svobodně vybrat vlastní strategii, přizpůsobenou vašim konkrétním cílům a potřebám.

### Oddíl 1: Definice a klíčové pojmy

Na začátku se společně podíváme na základy, kterými se řídí fungování Bitcoinu, a poté se v klidu podíváme na pojmy související s ochranou soukromí. Než plně pochopíme pojmy, kterým se budeme věnovat v následujících kapitolách, je nezbytné zvládnout některé základní pojmy, jako jsou UTXO, přijímací adresy nebo skripty. Představíme si také obecný model soukromí Bitcoinu, jak si jej představoval Satoshi Nakamoto, což nám umožní pochopit problematiku a související rizika.

![BTC204](assets/it/11/1.webp)

### Oddíl 2: Pochopení analýzy řetězce a způsob ochrany

Ve druhé části se budeme zabývat technikami, které používají společnosti zabývající se analýzou blockchainu ke sledování vaší aktivity na Bitcoinu. Pochopení těchto metod je zásadní pro zlepšení ochrany vašeho soukromí. Cílem této části je prozkoumat strategie útočníků, abychom lépe porozuměli rizikům a položili základy pro techniky, které budeme studovat v následujících částech. Budeme analyzovat vzory transakcí, interní a externí heuristiky a také pravděpodobné interpretace těchto vzorů. Kromě teoretické složky se na praktických příkladech a cvičeních naučíme používat průzkumníka bloků k provádění analýzy řetězců.

![BTC204](assets/fr/002.webp)

### Oddíl 3: Osvojení osvědčených postupů pro ochranu soukromí

Ve třetí části našeho kurzu se dostáváme k jádru věci: praxi! Cílem je osvojit si všechny základní osvědčené postupy, které by se měly stát přirozenými reflexy každého uživatele Bitcoinu. Budeme se zabývat používáním čerstvých adres, označováním, konsolidací, používáním plných uzlů a také metodami KYC a akvizice. Cílem je poskytnout vám ucelený přehled o nástrahách, kterým je třeba se vyhnout, abyste si vytvořili pevné základy v naší snaze o ochranu soukromí. U některých z těchto postupů budete odkázáni na konkrétní návod k jejich zavedení.

![BTC204](assets/it/11/3.webp)

### Oddíl 4: Porozumění transakcím Coinjoin

Jak můžeme mluvit o soukromí bitcoinu, aniž bychom diskutovali o coinjoinu? V části 4 se dozvíte vše, co potřebujete vědět o tomto způsobu míchání. Dozvíte se, co je coinjoin, jaká je jeho historie a cíle, a také o různých typech coinjoinů, které existují. Nakonec pro zkušenější uživatele zjistíme, co jsou to anonsety a entropie a jak tyto ukazatele vypočítat.

![BTC204](assets/it/11/4.webp)

### Oddíl 5: Pochopení problematiky dalších pokročilých technik ochrany soukromí

V pátém oddíle uvedeme přehled všech ostatních existujících technik ochrany soukromí v Bitcoinu kromě coinjoinu. V průběhu let projevili vývojáři značnou kreativitu při navrhování nástrojů určených k ochraně soukromí. Prozkoumáme všechny tyto metody, jako jsou payjoin, kolaborativní transakce, coin swap a atomic swap, a podrobně popíšeme jejich fungování, cíle a potenciální slabiny.

Budeme se zabývat také ochranou soukromí na úrovni sítě uzlů a šířením transakcí. Probereme také různé protokoly, které byly v průběhu let navrženy ke zlepšení soukromí uživatelů v Bitcoinu, včetně protokolů statických adres.

![BTC204](assets/fr/005.webp)

# Definice a klíčové pojmy

<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>

## Model UTXO pro Bitcoin

<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>

Bitcoin je především měna, ale víte, jak konkrétně je BTC zastoupen v protokolu?

### UTXO bitcoinu: Co jsou zač?

V protokolu Bitcoin je správa peněžních jednotek založena na modelu UTXO, což znamená "_Unspent Transaction Output_"

Tento model se zásadně liší od tradičních bankovních systémů, které se při sledování finančních toků spoléhají na mechanismus účtu a zůstatku. V bankovním systému jsou totiž jednotlivé zůstatky vedeny na účtech spojených s identitou. Když si například koupíte bagetu u pekaře, vaše banka jednoduše odečte částku nákupu z vašeho účtu, čímž se sníží váš zůstatek, zatímco na účet pekaře se připíše stejná částka, čímž se zvýší jeho zůstatek. V tomto systému neexistuje žádná jiná vazba mezi penězi, které na váš účet přicházejí, a penězi, které z něj odcházejí, než záznamy o transakcích.

U Bitcoinu to funguje jinak. Koncept účtu neexistuje a peněžní jednotky nejsou spravovány prostřednictvím zůstatků, ale prostřednictvím UTXO. UTXO představuje určité množství bitcoinů, které ještě nebylo utraceno, a tvoří tak `kus bitcoinu', který může být velký nebo malý. UTXO může mít například hodnotu `500 BTC` nebo jen `700 SATS`.

**> Připomínáme:** Satoshi, často zkracovaný na sat, je nejmenší jednotka bitcoinu, srovnatelná s pencí ve fiat měnách.

```plaintext
1 BTC = 100,000,000 SATS
```

Teoreticky může UTXO představovat jakoukoli hodnotu v bitcoinech, od jedné sedmičky až po teoretické maximum přibližně 21 milionů BTC. Je však logicky nemožné vlastnit všech 21 milionů bitcoinů a existuje spodní ekonomická hranice zvaná "prach", pod kterou je UTXO považováno za ekonomicky nevýhodné utrácet.

**>Věděli jste to?** Největší UTXO, které kdy bylo na Bitcoinu vytvořeno, mělo hodnotu `500 000 BTC`. Vytvořila ho platforma MtGox během konsolidační operace v listopadu 2011: [29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXO a podmínky výdajů

UTXO jsou nástroje pro výměnu bitcoinů. Každá transakce zahrnuje spotřebu UTXO jako vstupů a vytvoření nových UTXO jako výstupů. Když je transakce provedena, UTXO použité jako vstupy jsou považovány za "spotřebované" a nové UTXO jsou generovány a přiřazeny příjemcům uvedeným ve výstupech transakce. UTXO tedy jednoduše představuje nespotřebovaný výstup transakce, a tedy množství bitcoinů, které v daném okamžiku patří uživateli.

![BTC204](assets/it/21/2.webp)

Všechny UTXO jsou chráněny skripty, které definují podmínky, za nichž je lze použít. Aby mohl uživatel UTXO spotřebovat, musí síti prokázat, že splňuje podmínky stanovené skriptem chránícím dané UTXO. Obecně jsou UTXO chráněny veřejným klíčem (nebo přijímací adresou reprezentující tento veřejný klíč). Aby mohl uživatel utratit UTXO spojený s tímto veřejným klíčem, musí prokázat, že je držitelem odpovídajícího soukromého klíče, a to předložením digitálního podpisu vytvořeného tímto klíčem. Proto se říká, že vaše bitcoinová peněženka ve skutečnosti neobsahuje bitcoiny, ale spíše uchovává vaše soukromé klíče, které vám následně umožňují přístup k vašim UTXO a následně k bitcoinům, které představují.

![BTC204](assets/it/21/3.webp)

Protože v Bitcoinu neexistuje koncept účtu, je zůstatek peněženky jednoduše součtem hodnot všech UTXO, které může utratit. Pokud například vaše peněženka s bitcoiny může utratit následující 4 UTXO:

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

Celkový zůstatek vaší peněženky bude `17 BTC`.

![BTC204](assets/it/21/4.webp)

## Struktura transakcí Bitcoin

<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>

### Vstupy a výstupy transakce

Bitcoinová transakce je transakce zaznamenaná v blockchainu, která umožňuje převod vlastnictví bitcoinů z jedné osoby na druhou. Přesněji řečeno, protože se nacházíme v modelu UTXO a neexistují žádné účty, transakce splňuje výdajové podmínky, které chrání jedno nebo více UTXO, spotřebovává je a ekvivalentně vytváří nové UTXO vybavené novými výdajovými podmínkami. Stručně řečeno, transakce přesouvá bitcoiny ze skriptu, který je splněn, do nového skriptu určeného k jejich ochraně.

![BTC204](assets/it/22/1.webp)

Každá bitcoinová transakce se tedy skládá z jednoho nebo více vstupů a jednoho nebo více výstupů. Vstupy jsou UTXO spotřebované transakcí k vytvoření výstupů. Výstupy jsou nové UTXO, které budou použitelné jako vstupy pro budoucí transakce.

![BTC204](assets/it/22/2.webp)

**> Věděli jste to?** Teoreticky může mít bitcoinová transakce nekonečný počet vstupů a výstupů. Tento počet omezuje pouze maximální velikost bloku. Každý vstup v bitcoinové transakci odkazuje na předchozí nespotřebovaný UTXO (Unspent Transaction Output). Aby bylo možné UTXO použít jako vstup, musí jeho držitel prokázat, že je jeho oprávněným vlastníkem, a to ověřením skriptu, který je s ním spojen, tj. splněním uložené podmínky utracení. Obvykle to zahrnuje předložení digitálního podpisu vytvořeného pomocí soukromého klíče odpovídajícího veřejnému klíči, který původně zabezpečil daný UTXO. Skript pak ověří, zda podpis odpovídá veřejnému klíči použitému při přijetí prostředků.

Každý výstup naopak určuje částku bitcoinů, která má být převedena, a příjemce. Ten je definován novým skriptem, který zpravidla uzamkne nově vytvořené UTXO s adresou příjemce nebo novým veřejným klíčem.

Aby byla transakce považována za platnou podle pravidel konsensu, musí být celkový výstup menší nebo roven celkovému vstupu. Jinými slovy, součet nových UTXO vygenerovaných transakcí nesmí přesáhnout součet UTXO spotřebovaných jako vstupy. Tento princip je logický: pokud máte k dispozici pouze částku `500 000 SATS`, nemůžete provést nákup v hodnotě `700 000 SATS`.

### Výměna a konsolidace při transakci s bitcoiny

Působení transakce Bitcoin na UTXO lze tedy přirovnat k tavení zlaté mince. Ve skutečnosti není UTXO dělitelné, ale pouze sjednocené. To znamená, že uživatel nemůže jednoduše rozdělit UTXO představující určité množství bitcoinů na několik menších UTXO. Musí jej celý spotřebovat v transakci, aby na výstupu vytvořil jedno nebo více nových UTXO o libovolné hodnotě, která musí být menší nebo rovna původní hodnotě.

Tento mechanismus je podobný mechanismu zlaté mince. Představte si, že vlastníte minci o váze 2 unce a chcete zaplatit 1 unci za předpokladu, že vám prodávající nemůže vrátit drobné. Museli byste svou minci roztavit a vyrazit 2 nové mince po 1 unci.

U bitcoinu je postup podobný. Předpokládejme, že Alice má UTXO ve výši `10 000 SATS` a chce si koupit bagetu, která stojí `4 000 SATS`. Alice provede transakci se vstupem 1 UTXO v hodnotě `10 000 SATS`, který celý spotřebuje, a na výstupech vytvoří 2 UTXO v hodnotě `4 000 SATS` a `6 000 SATS`. UTXO v hodnotě `4 000 SATS` pošle pekaři jako platbu za bagetu, zatímco UTXO v hodnotě `6 000 SATS` se vrátí Alici jako drobné. Toto UTXO, které se vrací původnímu odesílateli transakce, se v bitcoinovém žargonu nazývá "drobné".

Nyní si představte, že Alice nemá jediné UTXO o kapacitě `10 000 SATS`, ale dvě UTXO po `3 000 SATS`. V této situaci žádný z jednotlivých UTXO nestačí na pokrytí `4 000 SATS` pro bagetu. Alice proto musí jako vstupy pro svou transakci použít oba UTXO po `3 000 SATS` současně. Tímto způsobem dosáhne celkového vstupu `6 000 SATS`, což jí umožní pokrýt platbu `4 000 SATS` pekaři. Tato metoda, která spočívá v seskupení několika UTXO do vstupů transakce, se často označuje jako `konsolidace`.

### Transakční poplatky

Intuitivně by se mohlo zdát, že transakční poplatky také představují výstup transakce. Ve skutečnosti tomu tak ale není. Transakční poplatky představují rozdíl mezi celkovými vstupy a celkovými výstupy. To znamená, že po použití části hodnoty vstupů na pokrytí požadovaných výstupů v transakci zůstává určitá částka vstupů nevyužita. Tato zbývající částka představuje transakční poplatky.

```plaintext
Commissioni = input totali - output totali
```

Vraťme se k příkladu Alice, která má UTXO ve výši `10 000 SATS` a chce si koupit bagetu za `4 000 SATS`. Alice vytvoří transakci, jejímž vstupem bude její UTXO ve výši `10 000 SATS`. Poté vytvoří výstup ve výši `4 000 SATS` určený pro pekaře na zaplacení bagety. Aby Alice povzbudila těžaře, aby její transakci zařadili do bloku, přidělí jim `200 SATS` jako provizi. Přitom vytvoří druhý výstup, zbytek, který jí bude vrácen, ve výši `5 800 SATS`.

Podle vzorce pro výpočet provize zjistíme, že horníkům zbývá `200 SATS`:

```plaintext
Commissioni = input totali - output totali
Spese = 10.000 - (4.000 + 5.800)
Spese = 10.000 - 9.800
Spese = 200
```

Když těžař úspěšně validuje blok, má nárok na inkaso těchto poplatků za všechny transakce zahrnuté v jeho bloku prostřednictvím takzvané transakce "coinbase".

### Vytvoření UTXO na Bitcoinu

Pokud jste pozorně sledovali předchozí odstavce, víte, že UTXO lze vytvořit pouze konzumací jiných existujících UTXO. Mince na Bitcoinu tedy tvoří souvislý řetězec. Možná vás však zajímá, jak se v tomto řetězci objevily první UTXO. Vyvstává tak problém podobný tomu o slepici a vejci: kde se vzaly tyto původní UTXO?

Odpověď se skrývá v transakci **coinbase**.

Coinbase je specifický typ transakce Bitcoinu, který je pro každý blok jedinečný a vždy první v bloku. Umožňuje těžaři, který našel platný důkaz práce, získat odměnu za svůj blok. Tato odměna se skládá ze dvou prvků: *z *dotace bloku** a **transakčních poplatků**, o nichž jsme hovořili v předchozí části.

Jedinečnou vlastností transakce coinbase je, že jako jediná dokáže vytvořit bitcoiny z ničeho, aniž by musela spotřebovávat vstupy pro generování výstupů. Tyto nově vytvořené bitcoiny představují to, co by se dalo nazvat "původní UTXO"

Bitcoiny z blokového grantu jsou nové BTC vytvořené ze vzduchu podle předem stanoveného harmonogramu vydávání v pravidlech konsensu. Blokový grant se v procesu zvaném "halving" snižuje na polovinu každých 210 000 bloků, tedy přibližně každé čtyři roky Zpočátku se na jednu dotaci vytvářelo 50 bitcoinů, ale toto množství se postupně snižovalo; v současnosti je to 3 125 bitcoinů na blok.

Co se týče transakčních poplatků, ačkoli představují nově vytvořené BTC, nesmí překročit rozdíl mezi celkovými vstupy a výstupy všech transakcí v bloku. Již dříve jsme viděli, že tyto poplatky představují část vstupů, která není použita ve výstupech transakcí. Tato část je technicky vzato "ztracena" během transakce a těžař má právo tuto hodnotu znovu vytvořit v podobě jednoho nebo více nových UTXO. Jedná se tedy o převod hodnoty od odesílatele transakce k těžaři, který ji přidává do blockchainu.

**> Věděli jste to?** Bitcoiny vygenerované z transakcí na coinbase podléhají období zrání 100 bloků, během kterého je těžař nemůže utratit. Toto pravidlo má zabránit komplikacím spojeným s používáním nově vytvořených bitcoinů v řetězci, který může být později zastaralý.

### Důsledky modelu UTXO

Za prvé, model UTXO přímo ovlivňuje transakční poplatky v bitcoinech. Protože kapacita každého bloku je omezená, těžaři upřednostňují transakce, které nabízejí nejlepší poplatky vzhledem k místu, které v bloku zaberou. Ve skutečnosti platí, že čím více UTXO transakce obsahuje jako vstup a výstup, tím je těžší, a proto vyžaduje vyšší poplatky. To je jeden z důvodů, proč je často snaha snížit počet UTXO v našem portfoliu, což může mít vliv i na soukromí, což je téma, kterému se budeme podrobně věnovat ve třetí části tohoto školení.

Dále, jak bylo zmíněno v předchozích částech, mince v Bitcoinu jsou v podstatě řetězcem UTXO. Každá transakce tak vytváří spojení mezi minulým UTXO a budoucím UTXO. UTXO tak umožňují explicitně sledovat cestu bitcoinů od jejich vzniku až po jejich aktuální utracení. Tuto transparentnost lze vnímat pozitivně, protože umožňuje každému uživateli zajistit pravost přijatých bitcoinů. Na tomto principu sledovatelnosti a auditovatelnosti je však založena i analýza řetězce, což je postup, který má ohrozit soukromí. Této praxi se budeme podrobně věnovat ve druhé části školení.

## Model soukromí bitcoinu

<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>

### Měna: Autenticita, integrita a dvojí utrácení

Jednou z funkcí měny je řešit problém dvojího souběhu potřeb. V systému založeném na barteru vyžaduje uskutečnění směny nejen najít jedince, který nabízí zboží, jež uspokojuje mou potřebu, ale také mu poskytnout zboží ekvivalentní hodnoty, které uspokojuje jeho potřebu. Nalezení této rovnováhy se ukazuje jako složité.

Proto se používá měna, která umožňuje přenos hodnoty v prostoru i čase.

Aby měna tento problém vyřešila, je nezbytné, aby strana poskytující zboží nebo službu byla přesvědčena o své schopnosti tuto částku později utratit. Proto každý racionálně uvažující jedinec, který chce přijmout nějakou formu měny, ať už digitální, nebo fyzickou, zajistí, aby splňovala dvě základní kritéria:


- Mince musí být neporušená a pravá;**- **a nesmí být vydána dvakrát.**

Při použití fyzické měny je nejsložitější prokázat první charakteristiku. V různých historických obdobích byla integrita kovových mincí často narušována praktikami, jako je stříhání nebo ražení. Například v období starověkého Říma bylo běžné, že občané oškrabávali hrany zlatých mincí, aby získali část drahého kovu a zároveň je uchovali pro budoucí transakce. Vnitřní hodnota mince se tak sice snížila, ale její nominální hodnota zůstala stejná. To je pozoruhodný důvod, proč byly později na hranu mincí vyraženy proužky.

Pravost je také obtížně ověřitelná fyzickými peněžními prostředky. Techniky boje proti padělání jsou dnes stále složitější, což nutí obchodníky investovat do nákladných ověřovacích systémů.

Na druhou stranu u fyzických měn není vzhledem k jejich povaze dvojí platba problémem. Pokud vám dám bankovku v hodnotě 10 EUR, neodvolatelně opouští mé vlastnictví a vstupuje do vašeho, což samozřejmě vylučuje jakoukoli možnost utratit tytéž peněžní jednotky vícekrát. Stručně řečeno, tuto bankovku v hodnotě 10 € nebudu moci utratit znovu.

U digitální měny je to jiné. Zajištění pravosti a integrity mince je často jednodušší. Jak jsme viděli v předchozí části, model UTXO bitcoinu umožňuje dohledat minci až k jejímu původu, a ověřit tak, že byla skutečně vytvořena v souladu s pravidly konsensu těžařem.

Zajistit, aby nedocházelo k dvojí platbě, je však složitější, protože každé digitální zboží je v podstatě informace. Na rozdíl od fyzického zboží se informace při výměně nedělí, ale šíří se násobením. Pokud vám například pošlu e-mailem dokument, dojde k jeho zdvojení. Z vaší strany nemůžete s jistotou ověřit, zda jsem původní dokument smazal.

### Zabránění dvojí platbě u Bitcoinu

Jediným způsobem, jak zabránit duplikaci digitálního aktiva, je mít přehled o všech výměnách v rámci systému. Tímto způsobem můžete vědět, kdo co vlastní, a aktualizovat vlastnictví všech na základě provedených transakcí. Takto se postupuje například u skriptových peněz v bankovním systému. Když zaplatíte 10 eur obchodníkovi kreditní kartou, banka tuto výměnu zaznamená a aktualizuje účetní knihu.

U Bitcoinu se stejným způsobem zabraňuje dvojí platbě. Cílem je potvrdit neexistenci transakce, při které již byly příslušné mince utraceny. Pokud tyto mince nebyly nikdy použity, můžeme si být jisti, že k žádné dvojí platbě nedojde. Tento princip popsal Satoshi Nakamoto v Bílé knize touto slavnou větou:

**"_Jediný způsob, jak potvrdit neexistenci transakce, je být si vědom všech transakcí._"**

Na rozdíl od bankovního modelu však u Bitcoinu není potřeba důvěřovat centrálnímu subjektu. Je nutné, aby všichni uživatelé mohli tuto absenci dvojí platby potvrdit, aniž by se museli spoléhat na třetí stranu. Proto si musí být každý vědom všech transakcí v Bitcoinu. Proto jsou transakce Bitcoinu veřejně vysílány ve všech uzlech sítě a zaznamenávány v prostém textu v blockchainu.

Právě toto veřejné šíření informací komplikuje ochranu soukromí na Bitcoinu. V tradičním bankovním systému teoreticky ví o provedených transakcích pouze finanční instituce. Naproti tomu v Bitcoinu jsou o všech transakcích informováni všichni uživatelé, a to prostřednictvím svých příslušných uzlů.

### Model ochrany soukromí: bankovní systém vs. Bitcoin

V tradičním systému je váš bankovní účet spojen s vaší identitou. Bankéř je schopen zjistit, kterému klientovi patří který bankovní účet a jaké transakce jsou s ním spojeny. Tento tok informací je však mezi bankou a veřejnou sférou přerušen. Jinými slovy, není možné znát zůstatek a transakce bankovního účtu, který patří jiné osobě. K těmto informacím má přístup pouze banka.

Váš bankéř například ví, že si každé ráno kupujete bagetu v sousední pekárně, ale váš soused o této transakci neví. Tok informací je tedy přístupný zainteresovaným stranám, zejména bance, ale zůstává nedostupný pro cizí osoby.

Vzhledem k omezení veřejného šíření transakcí, které jsme viděli v předchozí části, nemůže model soukromí Bitcoinu následovat model bankovního systému. Protože v případě Bitcoinu nelze přerušit tok informací mezi transakcemi a veřejným prostorem, je **model soukromí založen na oddělení identity uživatele a samotných transakcí**.

Pokud si například koupíte bagetu od pekaře a zaplatíte za ni v BTC, váš soused, který vlastní svůj vlastní plný uzel, může vidět, jak vaše transakce probíhá, stejně jako vidí všechny ostatní transakce v systému. Pokud jsou však dodržovány zásady ochrany soukromí, neměl by být schopen spojit tuto konkrétní transakci s vaší identitou.

Protože jsou však transakce bitcoinů zveřejňovány, je možné mezi nimi vytvořit vazby a odvodit informace o zúčastněných stranách. Tato činnost dokonce sama o sobě představuje specializaci zvanou "analýza řetězce" V další části kurzu vás zvu k prozkoumání základů analýzy řetězců, abyste pochopili, jak jsou vaše bitcoiny sledovány, a věděli, jak se lépe bránit.

# Jak rozumět analýze řetězce a jak se chránit

<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## Co je řetězová analýza bitcoinu?

<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>

### Definice a fungování

Analýza řetězce je postup, který zahrnuje všechny metody používané ke sledování toku bitcoinů v blockchainu. Obecně je analýza řetězce založena na pozorování znaků ve vzorcích předchozích transakcí. Poté zahrnuje identifikaci stejných rysů v transakci, kterou chceme analyzovat, a odvození pravděpodobných interpretací. Tento způsob řešení problému z praktického hlediska, který vede k nalezení dostatečně dobrého řešení, se nazývá "heuristika"

Pro zjednodušení se analýza řetězce provádí ve třech hlavních krocích:

1. **Sledování blockchainu;**

2. **Identifikujte známé charakteristiky;**

3. **Vzdělávací předpoklady.**

Analýzu blockchainu může provádět kdokoli. Stačí mít přístup k veřejným informacím blockchainu prostřednictvím plnohodnotného uzlu, aby bylo možné sledovat pohyby transakcí a vytvářet předpoklady. Existují také bezplatné nástroje, které tuto analýzu usnadňují, například webová stránka [OXT.me](https://oxt.me/), kterou se budeme podrobně zabývat v posledních dvou kapitolách této části. Hlavní riziko pro soukromí však představují společnosti, které se specializují na analýzu řetězců. Tyto společnosti dovedly analýzu řetězců do průmyslového měřítka a prodávají své služby finančním institucím nebo vládám. Z těchto společností je pravděpodobně nejznámější společnost Chainalysis.

### Cíle analýzy řetězce

Jedním z cílů řetězové analýzy je seskupit různé aktivity na Bitcoinu a určit tak jedinečnost uživatele, který je provedl. Dále bude možné pokusit se spojit tento soubor činností se skutečnou identitou.

Připomeňte si předchozí kapitolu. Vysvětlil jsem, proč byl model soukromí bitcoinu původně založen na oddělení identity uživatelů od jejich transakcí. Bylo by proto lákavé si myslet, že analýza on-chainu je k ničemu, protože i když lze aktivity na řetězci seskupit, nelze je spojit se skutečnou identitou.

Teoreticky je toto tvrzení přesné. V první části tohoto školení jsme viděli, že k určení podmínek na UTXO se používají páry kryptografických klíčů. Z podstaty věci tyto páry klíčů neprozrazují žádné informace o identitě svých držitelů. I když jsme tedy schopni seskupit činnosti spojené s různými páry klíčů, neříká nám to nic o subjektu, který za těmito činnostmi stojí.

Praktická realita je však mnohem složitější. Existuje množství chování, u nichž hrozí riziko propojení skutečné identity s aktivitou v řetězci. V analýze se tomu říká vstupní bod a je jich mnoho.

Nejběžnější je samozřejmě KYC (_Know Your Customer_). Pokud vybíráte bitcoiny z regulované platformy na jednu z vašich osobních přijímacích adres, někteří lidé jsou schopni spojit vaši identitu s touto adresou. Obecněji řečeno, vstupním bodem může být jakákoli forma interakce mezi vaším reálným životem a bitcoinovou transakcí. Pokud například zveřejníte přijímací adresu na svých sociálních sítích, může to být vstupní bod pro analýzu. Pokud provedete platbu bitcoiny svému pekaři, může si váš obličej (který je součástí vaší identity) spojit s bitcoinovou adresou.

Tyto vstupní body jsou při používání Bitcoinu téměř nevyhnutelné. I když se můžete pokusit omezit jejich rozsah, zůstanou přítomny. Proto je zásadní kombinovat metody zaměřené na ochranu vašeho soukromí. Přestože je zachování oddělení vaší skutečné identity od vašich transakcí lákavým přístupem, zůstává dnes nedostatečným. Pokud totiž lze všechny vaše aktivity v onchainu seskupit, pak sebemenší vstupní bod pravděpodobně ohrozí jedinou vrstvu soukromí, kterou jste si vytvořili.

### Obrana proti analýze řetězce

Proto je také nutné, abychom se při používání Bitcoinu mohli zabývat analýzou blockchainu. Tímto postupem můžeme minimalizovat agregaci našich aktivit a omezit dopad vstupního bodu na naše soukromí.

Jak lépe čelit analýze blockchainu, než se seznámit s metodami používanými při analýze blockchainu? Pokud chcete vědět, jak zlepšit své soukromí na Bitcoinu, musíte těmto metodám porozumět. To vám umožní lépe porozumět technikám, jako je coinjoin nebo payjoin (techniky, které budeme studovat v posledních částech školení), a omezit chyby, kterých se můžete dopustit.

V této souvislosti můžeme použít analogii s kryptografií a kryptoanalýzou. Dobrý kryptograf je především dobrý kryptoanalytik. Chcete-li vymyslet nový kryptografický algoritmus, musíte vědět, jakým útokům bude čelit, a také studovat, proč byly předchozí algoritmy hacknuty. Stejný princip platí i pro ochranu soukromí u Bitcoinu. Pochopení metod analýzy blockchainu je klíčem k ochraně proti němu. Proto v tomto školení navrhuji celou sekci o analýze blockchainu.

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/fr/tutorials/privacy/on-chain/payjoin-848b6a23-deb2-4c5f-a27e-93e2f842140f
### Metody analýzy blockchainu

Je důležité si uvědomit, že analýza blockchainu není exaktní věda. Spoléhá se na heuristiku odvozenou z předchozích pozorování nebo logických interpretací. Tato pravidla umožňují získat poměrně spolehlivé výsledky, nikdy však s absolutní přesností. Jinými slovy, **blockchainová analýza vždy zahrnuje pravděpodobnostní rozměr vydaných závěrů**. Lze například s větší či menší jistotou odhadnout, že dvě adresy patří stejnému subjektu, ale naprostá jistota bude vždy nedosažitelná.

Hlavní cíl analýzy blockchainu spočívá právě v agregaci různých heuristik s cílem minimalizovat riziko chyby. Jde v jistém smyslu o kumulaci důkazů, která nám umožňuje přiblížit se realitě.

Tyto známé heuristické postupy lze rozdělit do několika kategorií, které si společně podrobně popíšeme:


- Transakční modely (nebo transakční modely);**
- Interní heuristika transakce;**
- Heuristika vně transakce.**

### Satoshi Nakamoto a analýza blockchainu

Je třeba poznamenat, že první dvě heuristiky pro analýzu řetězců objevil sám Satoshi Nakamoto. Pojednává o nich v 10. části Bílé knihy o Bitcoinu. Jedná se o tyto řetězce:


- heuristika společných vstupních vlastností (CIOH);
- a opakované použití adres.

![BTC204](assets/fr/031.webp)

Zdroj: Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

V následujících kapitolách se budeme zabývat tím, o co se jedná, ale už teď je zajímavé, že tyto dvě heuristiky si dodnes udržují významnou pozici v analýze řetězců.

## Šablony transakcí

<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>

Model transakce je jednoduše obecný vzor nebo struktura typické transakce, kterou lze nalézt v blockchainu a jejíž interpretace je pravděpodobně známa. Při studiu vzorů se zaměříme na jednu transakci, kterou budeme analyzovat na vysoké úrovni.

Jinými slovy, budeme se zabývat pouze počtem UTXO na vstupech a počtem UTXO na výstupech, aniž bychom se zabývali konkrétnějšími detaily nebo prostředím transakce. Ze zjištěného vzoru budeme schopni interpretovat povahu transakce. Poté budeme hledat rysy v její struktuře a vyvozovat interpretaci.

![BTC204](assets/it/32/01.webp)

V této části společně objevíme hlavní transakční vzory, se kterými se můžeme setkat při analýze řetězců, a u každého vzoru uvedu pravděpodobný výklad této struktury spolu s konkrétním příkladem.

### Jednoduché odesílání (nebo jednoduchá platba)

Začněme velmi populárním modelem, protože právě ten se objevuje ve většině bitcoinových plateb. Jednoduchý platební model je charakterizován tím, že na vstupu spotřebovává jeden nebo více UTXO a na výstupu produkuje 2 UTXO. Tento model bude tedy vypadat následovně:

![BTC204](assets/it/32/02.webp)

Když identifikujeme tuto strukturu transakcí v blockchainu, můžeme již provést interpretaci. Jak již název napovídá, tento vzor naznačuje, že máme co do činění s transakcí typu send or pay. Uživatel spotřeboval na vstupu své UTXO, aby na výstupu uspokojil platební UTXO a směnné UTXO (peníze vrácené témuž uživateli).

Víme tedy, že sledovaný uživatel již pravděpodobně nevlastní jeden ze dvou výstupních UTXO (platební), ale stále vlastní druhý UTXO (změnový).

V současné době není možné specifikovat, který výstup představuje které UTXO, protože to není cílem studia modelů. Tohoto cíle dosáhneme tak, že se budeme spoléhat na heuristiku, kterou budeme studovat v následujících částech. V této fázi se náš cíl omezuje na určení povahy dané transakce, kterou je v tomto případě prosté odeslání.

Zde je například transakce Bitcoinu, která využívá model jednoduchého odeslání:

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/it/32/03.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

Po tomto prvním příkladu byste měli lépe pochopit, co znamená studovat "transakční model" Transakci zkoumáme tak, že se zaměřujeme pouze na její strukturu, aniž bychom brali v úvahu její prostředí nebo detaily specifické pro danou transakci. V tomto prvním kroku se na ni díváme pouze globálně.

Nyní, když jste pochopili, co je to model, přejděme k dalším existujícím modelům.

### Zametání

Tento druhý model se vyznačuje tím, že jako vstup spotřebovává jeden UTXO a jako výstup produkuje jeden UTXO.

![BTC204](assets/it/32/04.webp)

Interpretace tohoto modelu je taková, že se jedná o automatický přenos. Uživatel převedl své bitcoiny na sebe, na jinou adresu, kterou vlastní. Vzhledem k tomu, že v transakci není žádný zbytek, je velmi nepravděpodobné, že bychom měli co do činění s platbou. Ve skutečnosti je při platbě téměř nemožné, aby měl plátce UTXO, které přesně odpovídá částce požadované prodávajícím, plus transakční poplatky. Obecně je tedy plátce nucen vytvořit zbytkový výstup.

Proto víme, že sledovaný uživatel pravděpodobně stále vlastní tento UTXO. V kontextu řetězové analýzy, pokud víme, že UTXO použitý jako vstup v transakci patří Alici, můžeme předpokládat, že UTXO na výstupu jí také patří. Zajímavým se později stane hledání heuristik uvnitř transakce, které by mohly tento předpoklad posílit (tyto heuristiky budeme studovat v části 3.3).

Zde je například transakce s bitcoiny, která využívá model sweepingu:

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/it/32/05.webp)

Zdroj: [Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d) Tento typ vzoru však může odhalit i vlastní převod na účet kryptoměnové platformy. Teprve studium známých adres a kontextu transakce nám umožní zjistit, zda se jedná o konsolidaci do peněženky samoplátce, nebo o výběr na platformu. Adresy směnných platforem jsou totiž často snadno identifikovatelné.

Vraťme se k příkladu Alice: pokud konsolidace vede na známou adresu platformy (jako je například Binance), může to znamenat, že bitcoiny byly převedeny mimo přímé vlastnictví Alice, pravděpodobně s úmyslem je prodat nebo uložit na této platformě. Na druhou stranu, pokud je cílová adresa neznámá, lze předpokládat, že jde jednoduše o jinou peněženku, která stále patří Alici. Tento typ studie však spadá spíše do kategorie heuristiky, nikoliv do studia vzorců.

### Konsolidace

Tento model se vyznačuje tím, že jako vstup spotřebovává několik UTXO a jako výstup produkuje jeden UTXO.

![BTC204](assets/it/32/06.webp)

Interpretace tohoto vzoru je taková, že se nacházíme ve fázi konsolidace. Jedná se o běžnou praxi mezi uživateli bitcoinu, kdy dochází ke sloučení několika UTXO v očekávání možného zvýšení transakčních poplatků. Provedením této operace v období, kdy jsou poplatky nízké, je možné ušetřit na budoucích poplatcích. Více se této praxi budeme věnovat v kapitole 4.3.

Z toho můžeme usuzovat, že uživatel, který stojí za tímto transakčním modelem, pravděpodobně vlastnil všechny vstupní UTXO a stále vlastní výstupní UTXO. Rozhodně se jedná o automatický převod.

Stejně jako konsolidace může i tento typ vzoru odhalit vlastní převod na účet burzovní platformy. Teprve studium známých adres a kontextu transakce nám umožní zjistit, zda se jedná o konsolidaci na vlastní peněženku, nebo o výběr na platformu.

Zde je například transakce bitcoinu, která využívá konsolidační schéma:

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/it/32/07.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)

V kontextu analýzy řetězce může tento model odhalit mnoho informací. Víme-li například, že jeden ze vstupů patří Alici, můžeme předpokládat, že jí patří i všechny ostatní vstupy a výstupy této transakce. Tento předpoklad by nám pak umožnil sledovat předchozí řetězce transakcí a odhalit a analyzovat další transakce, které jsou pravděpodobně spojeny s Alicí.

![BTC204](assets/it/32/08.webp)

### Seskupené výdaje

Tento model je charakterizován spotřebou několika UTXO jako vstupu (často pouze jednoho) a výrobou mnoha UTXO jako výstupu.

![BTC204](assets/it/32/09.webp)

Interpretace tohoto vzorce je taková, že se jedná o vázané výdaje. Jedná se o praxi, která pravděpodobně odhaluje významnou ekonomickou aktivitu, například výměnnou platformu. Sdružené výdaje umožňují těmto subjektům ušetřit na poplatcích tím, že sloučí své výdaje do jediné transakce.

Z tohoto modelu můžeme vyvodit, že vstup UTXO pochází z podniku s významnou hospodářskou činností a že výstupy UTXO se rozptýlí. Mnohé z nich budou patřit zákazníkům společnosti, kteří si z platformy vybrali bitcoiny. Další mohou připadnout partnerským společnostem. A nakonec bude jistě existovat jedna nebo více směn, které se vrátí vydávající společnosti.

Zde je například transakce Bitcoin, která využívá model seskupených výdajů (pravděpodobně se jedná o transakci vydanou platformou Bybit):

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/it/32/10.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### Transakce specifické pro protokol

Mezi transakčními vzory můžeme také identifikovat vzory, které odhalují použití konkrétního protokolu. Například transakce Whirlpool coinjoins (o kterých budeme hovořit v části 5) budou mít snadno identifikovatelnou strukturu, která je umožní odlišit od ostatních tradičnějších transakcí.

![BTC204](assets/it/32/11.webp)

Analýza tohoto vzorce naznačuje, že se pravděpodobně jedná o transakci založenou na spolupráci. Je také možné pozorovat coinjoin. Pokud se druhá hypotéza ukáže jako správná, pak by nám počet výstupů mohl poskytnout hrubý odhad počtu účastníků coinjoinu.

Zde je například transakce Bitcoinu, která využívá model kolaborativní transakce typu coinjoin:

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/it/32/12.webp)

Fonte: [Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

Existuje mnoho dalších protokolů, které mají vlastní specifické struktury. Tak bychom mohli rozlišovat transakce typu Wabisabi, transakce Stamps nebo například Runes.

Díky těmto transakčním modelům již můžeme interpretovat určité množství informací o dané transakci. Struktura transakce však není jediným zdrojem informací pro analýzu. Můžeme také studovat její detaily. Tyto detaily, interní pro danou transakci, s oblibou nazývám "interní heuristika" a budeme je studovat v následující kapitole.

## Interní heuristika

<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>

Vnitřní heuristika je specifický rys identifikovaný v rámci samotné transakce, aniž by bylo nutné zkoumat její okolí, který nám umožňuje vyvozovat závěry. Na rozdíl od modelů, které se zaměřují na celkovou strukturu transakce na vysoké úrovni, je interní heuristika založena na souboru extrahovatelných dat. Mezi ně patří např:


- Množství různých vstupů a výstupů UTXO;
- Vše o skriptech: přijímání adres, verzování, doba uzamčení atd.

Obecně nám tento typ heuristiky umožní identifikovat zbytek v konkrétní transakci. Tímto způsobem pak můžeme pokračovat ve sledování subjektu v rámci více transakcí. Pokud totiž identifikujeme UTXO patřící uživateli, kterého chceme sledovat, je při jeho transakci klíčové určit, který výstup byl převeden na jiného uživatele a který výstup představuje zbytek, a zůstává tedy v jeho vlastnictví.

![BTC204](assets/it/33/01.webp)

Znovu připomínám, že tato heuristika není v žádném případě přesná. Jednotlivě nám pouze umožňují identifikovat pravděpodobné scénáře. Právě kumulace různých heuristik pomáhá snižovat nejistotu, aniž by ji kdy zcela odstranila.

### Vnitřní podobnosti

Tato heuristika zahrnuje studium podobností mezi vstupy a výstupy stejné transakce. Pokud pozorujeme stejný rys na vstupech a pouze na jednom z výstupů transakce, pak je pravděpodobné, že tento výstup tvoří zbytek.

Nejzřetelnějším rysem je opakované použití přijímací adresy ve stejné transakci.

![BTC204](assets/it/33/02.webp)

Tato heuristika ponechává jen málo prostoru pro pochybnosti. Pokud nedošlo k prolomení soukromého klíče, stejná přijímací adresa nevyhnutelně odhalí aktivitu jediného uživatele. Z toho vyplývá interpretace, že zbytek transakce je výstupem se stejnou adresou jako vstup. To umožňuje průběžné sledování jednotlivce na základě tohoto zbytku.

Zde je například transakce, na kterou lze tuto heuristiku přiměřeně použít:

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/fr/046.webp)

Fonte: [Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

Tyto podobnosti mezi vstupem a výstupem nekončí u opakovaného použití adresy. Jakákoli podobnost v použití skriptů může umožnit použití heuristiky. Někdy lze například pozorovat stejné verzování mezi vstupem a jedním z výstupů transakce.

![BTC204](assets/it/33/04.webp)

V tomto diagramu vidíme, že vstup č. 0 odemyká skript P2WPKH (SegWit V0 začínající na `bc1q`). Výstup č. 0 používá stejný typ skriptu. Výstup č. 1 však používá skript P2TR (SegWit V1 začínající na `bc1p`). Interpretace této vlastnosti je taková, že je pravděpodobné, že adresa se stejným verzováním jako vstup je adresou zbytku. Bude tedy stále patřit stejnému uživateli.

Zde je jedna transakce, na kterou lze tuto heuristiku přiměřeně použít:

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/fr/048.webp)

Fonte: [Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)

V tomto případě vidíme, že vstup č. 0 a výstup č. 1 používají skripty P2WPKH (SegWit V0), zatímco výstup č. 0 používá jiný typ skriptu, P2PKH (Legacy). Na počátku roku 2010 byla tato heuristika založená na verzi skriptu poměrně málo užitečná kvůli omezení dostupných typů skriptů. Postupem času a s následnými aktualizacemi Bitcoinu však byla zavedena stále větší rozmanitost typů skriptů. Tato heuristika se stává stále relevantnější, protože s širší nabídkou typů skriptů se uživatelé dělí do menších skupin, čímž se zvyšuje šance na uplatnění této interní heuristiky pro opětovné použití verze. Už jen z tohoto důvodu je z hlediska ochrany soukromí vhodné zvolit nejběžnější typ skriptu. Například v době, kdy píšu tyto řádky, jsou skripty Taproot (`bc1p`) používány méně často než skripty SegWit V0 (`bc1q`). Ačkoli první z nich nabízí v určitých specifických kontextech ekonomické výhody a výhody v oblasti ochrany soukromí, pro tradičnější použití s jedním podpisem může být rozumné zůstat z důvodu ochrany soukromí u staršího standardu, dokud se nový standard nerozšíří.

### Platby se zaokrouhlenými čísly

Další vnitřní heuristikou, která nám může pomoci identifikovat zbytek, je heuristika zaokrouhleného čísla. Obecně platí, že pokud se setkáme s jednoduchým platebním schématem (1 vstup a 2 výstupy), pak pokud jeden z výstupů vydá zaokrouhlenou částku, představuje platbu.

![BTC204](assets/it/33/06.webp)

Pokud jeden výstup představuje platbu, druhý představuje změnu. Lze tedy usuzovat, že uživatel, který transakci zadal, pravděpodobně stále vlastní výstup označený jako změna.

Je třeba poznamenat, že tato heuristika není vždy použitelná, protože většina plateb se stále provádí ve fiat měnových jednotkách. Pokud totiž obchodník ve Francii přijímá bitcoiny, zpravidla nezobrazuje stabilní ceny v sats. Raději zvolí přepočet mezi cenou v eurech a částkou v bitcoinech, která má být zaplacena. Proto by ve výstupu transakce nemělo být zaokrouhlené číslo.

Analytik se však může pokusit provést tento přepočet s ohledem na směnný kurz platný v době, kdy byla transakce přenesena přes síť. Vezměme si příklad transakce se vstupem `97 552 sats` a dvěma výstupy, jedním `31 085 sats` a druhým `64 152 sats`. Na první pohled se zdá, že tato transakce nezahrnuje zaokrouhlené částky. Při použití směnného kurzu `64,339 v době transakce však získáme přepočet na eura, který vypadá následovně:


- Vstupní částka 62,76 EUR;
- Výstup ve výši 20 EUR;
- Výstup 41,27 EUR.

Po přepočtu na fiat měnu umožňuje tato transakce použití heuristiky plateb se zaokrouhlenými částkami. Výstup ve výši 20 € byl pravděpodobně určen pro obchodníka nebo jinak změnil majitele. Z toho vyplývá, že výstup ve výši 41,27 € pravděpodobně zůstal v držení původního uživatele.

![BTC204](assets/it/33/07.webp)

Pokud se jednoho dne stane Bitcoin preferovanou zúčtovací jednotkou v našich transakcích, může být tato heuristika pro analýzu ještě užitečnější.

Například zde je transakce, u které lze tuto heuristiku pravděpodobně použít:

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/fr/051.webp)

Fonte: [Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)

### Největší výkon

Pokud je mezi dvěma výstupy transakce v jednoduchém platebním modelu výrazně velký rozdíl, lze odhadnout, že větší výstup bude pravděpodobně zbytek.

![BTC204](assets/it/33/09.webp)

Tato heuristika s největším výstupem je pravděpodobně nejnepřesnější ze všech. Pokud je identifikována samostatně, je poměrně slabá. Tuto vlastnost však můžeme kombinovat s dalšími heuristikami a snížit tak nejistotu naší interpretace.

Pokud například zkoumáme transakci, která má jeden výstup s kulatou částkou a druhý výstup s větší částkou, společné použití heuristiky kulatých plateb a heuristiky související s větším výstupem nám umožňuje snížit úroveň nejistoty.

Například zde je transakce, u které lze tuto heuristiku pravděpodobně použít:

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/fr/053.webp)

Fonte: [Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## Externí heuristika

<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>

Studium vnějších heuristik zahrnuje analýzu podobností, vzorců a charakteristik určitých prvků, které nejsou vlastní samotné transakci. Jinými slovy, jestliže jsme se dříve omezovali na využívání prvků vlastních transakci pomocí interních heuristik, nyní rozšiřujeme pole analýzy na prostředí transakce prostřednictvím externích heuristik.

### Opakované použití adres

Jedná se o jednu z nejznámějších heuristik mezi nadšenci Bitcoinu. Opakované použití adresy umožňuje navázat spojení mezi různými transakcemi a různými UTXO. Pozoruje se, když je adresa pro příjem Bitcoinu použita vícekrát.

Je tedy možné využít opakované použití adresy v rámci téže transakce jako interní heuristiku pro identifikaci zbytku (jak jsme viděli v předchozí kapitole). Opakované použití adresy však může sloužit také jako vnější heuristika k rozpoznání jedinečnosti entity za několika transakcemi.

Interpretace opakovaného použití adresy je taková, že všechny UTXO uzamčené na této adrese patří (nebo patřily) stejnému subjektu. Tato heuristika ponechává jen malý prostor pro nejistotu. Pokud ji lze identifikovat, následující interpretace s největší pravděpodobností odpovídá skutečnosti. Umožňuje tedy shlukování různých činností v řetězci.

![BTC204](assets/it/34/01.webp)

Jak bylo vysvětleno v úvodu této části 3, tuto heuristiku objevil sám Satoshi Nakamoto. V Bílé knize výslovně zmiňuje řešení, jak se jí uživatelé mohou vyhnout, a to jednoduše tak, že pro každou novou transakci použijí novou adresu:

"_Jako dodatečná ochrana by mohl být pro každou transakci použit nový pár klíčů, aby se zabránilo jejich propojení se společným vlastníkem._"

![BTC204](assets/fr/055.webp)

Zdroj: Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

Například zde je adresa opakovaně použitá ve více transakcích:

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

Zdroj:[Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### Podobnost skriptů a otisků peněženek

Kromě opakovaného použití adres existuje řada dalších heuristických postupů pro propojení akcií se stejným portfoliem nebo se shlukem adres.

Především může analytik využít podobnosti v používání skriptů. Například některé minoritní skripty, jako je multisig, lze identifikovat snadněji než skripty SegWit V0. Čím větší je skupina, ve které se skrýváme, tím obtížnější je nás identifikovat. Proto v dobrých protokolech Coinjoin všichni účastníci používají přesně stejný typ skriptů.

Obecněji řečeno, analytik se může zaměřit také na charakteristiku otisku prstu portfolia. Jedná se o specifické procesy související s používáním, které se lze pokusit identifikovat s cílem využít je jako sledovací heuristiku. Jinými slovy, pokud pozorujeme kumulaci stejných vnitřních charakteristik u transakcí přiřazených sledovanému subjektu, můžeme se pokusit identifikovat tytéž charakteristiky u jiných transakcí.

Lze například zjistit, že sledovaný uživatel systematicky posílá zbytek svých dat na adresy P2TR (`bc1p...`). Pokud se tento proces opakuje, lze jej použít jako heuristiku pro pokračování naší analýzy. Lze použít i další otisky, například pořadí UTXO, umístění zbytku ve výstupech, signalizaci RBF (Replace-by-Fee) nebo dokonce, číslo verze, pole `nSequence` a pole `nLockTime`.

Jak upřesňuje [@LaurentMT](https://twitter.com/LaurentMT) v [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji) (frankofonní podcast), užitečnost otisků peněženek při analýze řetězců se časem výrazně zvyšuje. Rostoucí počet typů skriptů a stále postupnější zavádění těchto nových možností softwarem peněženek totiž rozdíly zvýrazňuje. Může se dokonce stát, že lze přesně identifikovat software používaný sledovaným subjektem. Je proto důležité si uvědomit, že studium digitální stopy peněženky se ukazuje jako zvláště relevantní pro nedávné transakce, a to více než pro transakce zahájené na počátku roku 2010.

Shrneme-li to, otiskem prstu může být jakýkoli specifický postup, prováděný automaticky peněženkou nebo ručně uživatelem, který lze nalézt u jiných transakcí a který nám pomůže při analýze.

### Heuristika společného vlastnictví vstupů (CIOH)

CIOH, anglicky "Common Input Ownership Heuristic", je heuristika, která říká, že pokud transakce zahrnuje více vstupů, je pravděpodobné, že pocházejí od jednoho subjektu. V důsledku toho je jejich vlastnictví společné.

Abychom mohli použít heuristiku společného vlastnictví vstupů (CIOH), nejprve pozorujeme transakci, která má více vstupů. Může se jednat o minimálně 2 vstupy až maximálně 30 vstupů. Jakmile tuto charakteristiku identifikujeme, zkontrolujeme, zda transakce neodpovídá známému transakčnímu modelu. Pokud má například 5 vstupů s přibližně stejnou částkou a 5 výstupů s přesně stejnou částkou, víme, že se jedná o strukturu coinjoinu. Proto nemůžeme použít IOCH.

Pokud však transakce neodpovídá žádnému známému modelu kolaborativní transakce, můžeme usuzovat, že všechny vstupy pravděpodobně pocházejí od stejného subjektu. To může být velmi užitečné pro rozšíření známého shluku nebo pro další sledování.

CIOH objevil Satoshi Nakamoto. O tom hovoří v 10. části Bílé knihy:

"_[...] propojení je nevyhnutelné u transakcí s více vstupy, které nutně odhalují, že jejich vstupy vlastnil stejný vlastník. Riziko spočívá v tom, že pokud je vlastník klíče odhalen, propojení může odhalit další transakce, které patřily stejnému vlastníkovi._"

Zvláště fascinující je, že Satoshi Nakamoto ještě před oficiálním spuštěním Bitcoinu identifikoval dvě hlavní slabiny soukromí uživatelů, a to IOCH a opakované použití adresy. Taková předpověď je docela pozoruhodná, protože tyto dvě heuristiky zůstávají dodnes nejužitečnější v analýze blockchainu.

Jako příklad uvádíme transakci, na kterou můžeme pravděpodobně použít IOCH:

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

Fonte: [Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### Data mimo řetězec

Analýza on-chain se samozřejmě neomezuje výhradně na data onchain. Ke zpřesnění analýzy lze použít i údaje z předchozích analýz nebo údaje dostupné na internetu.

Například pokud se zjistí, že sledované transakce jsou systematicky přenášeny ze stejného uzlu Bitcoin a lze identifikovat jeho IP adresu, může být možné identifikovat další transakce od stejného subjektu a také částečně určit identitu odesílatele. Ačkoli tento postup není snadno proveditelný, protože vyžaduje fungování mnoha uzlů, je možné, že jej některé společnosti specializující se na analýzu řetězců budou využívat.

Analytik má také možnost vycházet z analýz, které byly dříve zveřejněny, nebo z vlastních předchozích analýz. Možná by mohl najít výstup, který by ukazoval na již dříve identifikovaný shluk adres. Někdy je také možné se spolehnout na výstup, který ukazuje na výměnnou platformu, přičemž adresy těchto společností jsou obecně známé.

Podobně lze provést analýzu vylučovací metodou. Pokud například při analýze transakce se dvěma výstupy je jeden z nich připojen k již známému shluku adres, který je však odlišný od sledované entity, pak lze interpretovat, že druhý výstup pravděpodobně představuje zbytek.

Řetězová analýza zahrnuje také část OSINT (_Open Source Intelligence_), která je poněkud obecnější a využívá vyhledávání na internetu. Proto se nedoporučuje zveřejňovat přijímací adresy přímo na sociálních sítích nebo na webových stránkách, ať už pod pseudonymem, nebo bez něj.

![BTC204](assets/fr/063.webp)

### Časové vzorce

Méně často se o tom uvažuje, ale určité lidské chování je na řetězci rozpoznatelné. Nejužitečnější při analýze může být váš spánkový vzorec! Ano, když spíte, pravděpodobně nepřenášíte transakce Bitcoinu. Protože obvykle spíte ve stejnou dobu, běžně se při analýze on-chainu používá časová analýza. Ta jednoduše spočívá v katalogizaci časů, kdy jsou transakce daného subjektu přenášeny do sítě Bitcoin. Analýza těchto časových vzorců nám umožňuje odvodit mnoho informací.

Především časová analýza někdy určí povahu sledovaného subjektu. Pokud se zjistí, že transakce jsou předávány soustavně po dobu 24 hodin, pak to odhalí silnou ekonomickou aktivitu. Subjektem, který za těmito transakcemi stojí, je pravděpodobně společnost, potenciálně mezinárodní a možná s interně automatizovanými postupy.

Například [tento vzorec jsem rozpoznal před několika měsíci](https://twitter.com/Loic_Pandul/status/1701127409712452072) analýzou [transakce, která omylem přidělila 19 bitcoinů na poplatcích](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd). Jednoduchá časová analýza mi umožnila předpokládat, že máme co do činění s automatizovanou službou, a tedy pravděpodobně s velkým subjektem, jako je výměnná platforma.

O několik dní později bylo zjištěno, že prostředky patří společnosti PayPal prostřednictvím směnárenské platformy Paxos.

Pokud naopak vidíme, že časový průběh je rozložen do 16 velmi specifických hodin, pak můžeme odhadnout, že se jedná o jednotlivého uživatele nebo možná o místní podnik v závislosti na obchodovaných objemech.

Kromě povahy sledované entity nám časový model může poskytnout také přibližnou polohu uživatele prostřednictvím časových pásem. Můžeme pak propojit další transakce a použít jejich časová razítka jako další heuristické údaje, které lze přidat do naší analýzy.

Například na opakovaně používané adrese, o které jsem se zmínil dříve, můžeme pozorovat, že transakce, příchozí i odchozí, se soustřeďují na 13hodinový interval.

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/fr/064.webp)

Zdroj: OXT.me

Tento rozsah pravděpodobně odpovídá Evropě, Africe nebo Blízkému východu. Lze tedy usuzovat, že uživatel, který za těmito transakcemi stojí, žije právě tam.

V jiném rejstříku je to také taková časová analýza, která umožnila vyslovit hypotézu, že Satoshi Nakamoto neoperoval z Japonska, ale ve skutečnosti ze Spojených států: [_The Time Zones of Satoshi Nakamoto_](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## Praktická aplikace s blokovým průzkumníkem

<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

V této závěrečné kapitole budeme konkrétně aplikovat koncepty, které jsme dosud studovali. Uvedu příklady skutečných transakcí s bitcoiny a vy budete muset získat informace, které po vás budu chtít.

V ideálním případě by pro tato cvičení bylo vhodnější použít profesionální nástroj pro analýzu řetězců. Po ukončení činnosti tvůrců peněženky Samourai však jediný bezplatný nástroj pro analýzu OXT.me již není k dispozici. Proto se pro tato cvičení rozhodneme pro klasický průzkumník bloků. Doporučuji používat [Mempool.space](https://mempool.space/) pro jeho mnoho funkcí a řadu nástrojů pro analýzu řetězců, ale můžete zvolit i jiný průzkumník, například [Bitcoin Explorer](https://bitcoinexplorer.org/). Na úvod představím cvičení. K jejich vyplnění použijte svůj průzkumník bloků a odpovědi si napište na papír. Na konci této kapitoly pak uvedu odpovědi, abyste si mohli zkontrolovat a opravit své výsledky.

_Transakce vybrané pro tato cvičení byly vybrány pouze pro své charakteristiky poněkud náhodně. Tato kapitola je určena pouze pro vzdělávací a informační účely. Chci jasně říci, že neobhajuji ani nepodporuji používání těchto nástrojů ke škodlivým účelům. Cílem je naučit vás, jak se chránit před řetězovou analýzou, nikoli provádět analýzu za účelem odhalení soukromých informací jiných osob._

### Cvičení 1

ID transakce, která má být analyzována:

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

Jaký je název modelu této transakce a jaké pravděpodobné interpretace lze vyvodit pouze na základě zkoumání jejího modelu, tj. struktury transakce?

### Cvičení 2

ID transakce, která má být analyzována:

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

Jaký je název modelu této transakce a jaké pravděpodobné interpretace lze vyvodit pouze na základě zkoumání jejího modelu, tj. struktury transakce?

### Cvičení 3

ID transakce, která má být analyzována:

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

Jaký je vzor této transakce?

Jaký výstup bude po identifikaci jeho modelu s využitím vnitřní heuristiky transakce pravděpodobně představovat zbytek?

### Cvičení 4

ID transakce, která má být analyzována:

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

Jaký je vzor této transakce?

Jaký výstup bude po identifikaci jeho modelu s využitím vnitřní heuristiky transakce pravděpodobně představovat zbytek?

### Cvičení 5

Představte si, že Loïc zveřejnil jednu ze svých adres Bitcoin pro příjem plateb na sociální síti Twitter:

![BTC204](assets/fr/065.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

Jaké transakce Bitcoinu můžeme spojit s Loïcovou identitou pomocí **pouze heuristiky opakovaného použití adresy**?

_Očividně nejsem skutečným vlastníkem této přijímací adresy a nezveřejnil jsem ji na sociálních sítích. Je to adresa, kterou jsem náhodně vybral z blockchainu._

### Cvičení 6

Po provedení cvičení 5 jste pomocí heuristiky opakovaného použití adresy dokázali identifikovat několik transakcí s bitcoiny, do kterých je Loïc zřejmě zapojen. Za normálních okolností byste mezi identifikovanými transakcemi měli identifikovat tuto:

Tato transakce představuje úplně první transakci, při které jsou na Loïcovu adresu odeslány finanční prostředky. Odkud myslíte, že pocházejí bitcoiny, které Loïc touto transakcí získal?

### Cvičení 7

Po provedení cvičení 5 jste pomocí heuristiky opakovaného použití adresy dokázali identifikovat několik transakcí Bitcoin, do kterých je Loïc zřejmě zapojen. Nyní chcete zjistit, odkud Loïc pochází. Na základě nalezených transakcí proveďte časovou analýzu a zjistěte pravděpodobné časové pásmo, které Loïc používá. Na základě tohoto časového pásma určete místo, kde Loïc zřejmě žije (země, stát/region, město...).

### Cvičení 8

Zde je transakce Bitcoin ke studiu:

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

Jaké informace můžeme interpretovat, když se podíváme pouze na tuto transakci?

### Řešení cvičení

**_Cvičení 1:_**

Model této transakce je jednoduchá platba. Pokud studujeme pouze její strukturu, můžeme interpretovat, že jeden výstup představuje změnu a druhý výstup představuje skutečnou platbu. Pak víme, že pozorovaný uživatel pravděpodobně již nevlastní jeden ze dvou UTXO ve výstupech (ten pro platbu), ale stále vlastní druhý UTXO (ten pro změnu).

**_Cvičení 2:_**

Vzor této transakce odpovídá dávkovým výdajům. Tento vzorec pravděpodobně ukazuje na významnou ekonomickou aktivitu, například výměnnou platformu. Můžeme usuzovat, že vstupní UTXO pochází od společnosti s významnou ekonomickou aktivitou a že výstupní UTXO se rozptýlí. Některé budou patřit zákazníkům společnosti, kteří si vybrali své bitcoiny do samoobslužných peněženek. Jiné mohou připadnout partnerským společnostem. A nakonec bude jistě existovat zbytek, který se vrátí vydávající společnosti.

**_Cvičení 3:_**

Model této transakce je jednoduchá platba. Proto můžeme na transakci aplikovat interní heuristiku a pokusit se identifikovat zbytek.

Osobně jsem identifikoval nejméně dvě vnitřní heuristiky, které podporují stejnou hypotézu:


- Opakované použití stejného typu skriptu;
- Největší výkon.

Nejzřetelnější heuristikou je opakované použití stejného typu skriptu. Výstup `0` je ve skutečnosti `P2SH`, který se pozná podle přijímací adresy začínající na `3`:

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

Zatímco výstup `1` je `P2WPKH`, identifikovatelný podle adresy začínající na `bc1q`:

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

UTXO použitý jako vstup pro tuto transakci také používá skript `P2WPKH`:

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

Můžeme tedy předpokládat, že výstup `0` odpovídá platbě a výstup `1` je zbytek transakce, což by znamenalo, že vstupní uživatel stále vlastní výstup `1`.

Abychom tuto hypotézu podpořili nebo vyvrátili, můžeme hledat další heuristiky, které potvrzují naši úvahu nebo snižují pravděpodobnost, že je naše hypotéza správná.

Identifikoval jsem přinejmenším jednu další heuristiku. Jedná se o největší výstup. Výstup `0` měří `123 689 sats`, zatímco výstup `1` měří `505 839 sats`. Mezi těmito dvěma výstupy je tedy významný rozdíl. Heuristika většího výstupu naznačuje, že objemnější výstup je pravděpodobně zbytek. Tato heuristika tedy dále posiluje naši původní hypotézu.

Zdá se pravděpodobné, že uživatel, který poskytl vstup UTXO, stále drží výstup `1`, který zřejmě představuje zbytek transakce.

**_Cvičení 4:_**

Model této transakce je jednoduchá platba. Proto můžeme na transakci aplikovat interní heuristiku a pokusit se identifikovat zbytek.

Osobně jsem identifikoval nejméně dvě vnitřní heuristiky, které podporují stejnou hypotézu:


- Opakované použití stejného typu skriptu;
- Výstup zaokrouhlené částky.

Nejzřetelnější heuristikou je opakované použití stejného typu skriptu. Výstup `0` je ve skutečnosti `P2SH`, který se pozná podle přijímací adresy začínající na `3`:

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

Zatímco výstup `1` je `P2WPKH`, identifikovatelný podle adresy začínající na `bc1q`:

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

UTXO použitý jako vstup pro tuto transakci také používá skript `P2WPKH`:

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

Můžeme tedy předpokládat, že výstup `0` odpovídá platbě a výstup `1` je zbytek transakce, což by znamenalo, že vstupní uživatel má stále výstup `1`.

Abychom tuto hypotézu podpořili nebo vyvrátili, můžeme hledat další heuristiky, které potvrzují naši úvahu nebo snižují pravděpodobnost, že je naše hypotéza správná.

Identifikoval jsem přinejmenším jednu další heuristiku. Jedná se o výstup kulatého množství. Výstup `0` měří `70 000 sáhů`, zatímco výstup `1` měří `22 962 sáhů`. Máme tedy co do činění s dokonale kulatým výstupem v zúčtovacích jednotkách BTC. Heuristika kulatého výstupu naznačuje, že UTXO s jednou kulatou částkou je pravděpodobně platba a vyřazením druhá představuje zbytek. Tato heuristika tedy dále posiluje naši původní hypotézu.

V tomto příkladu však může náš původní předpoklad zpochybnit jiná heuristika. Ve skutečnosti je výstup `0` větší než výstup `1`. Pokud bychom založili naši úvahu na heuristice, že největší výstup je obecně zbytek, mohli bychom odvodit, že výstup `0` je zbytek. Tato protihypotéza se však zdá být nevěrohodná, protože ostatní dvě heuristiky se zdají být podstatně přesvědčivější než heuristika největšího výstupu. V důsledku toho se zdá rozumné zachovat naši původní hypotézu i přes tento zdánlivý rozpor.

Zdá se tedy pravděpodobné, že uživatel, který poskytl UTXO jako vstup, stále drží výstup `1`, který zřejmě představuje zbytek transakce.

**_Cvičení 5:_**

Vidíme, že k Lojcově identitě lze přiřadit 8 transakcí. Z nich 4 zahrnují příjem bitcoinů:

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
8b70bd322e6118b8a002dbdb731d16b59c4a729c2379af376ae230cf8cdde0dd
d5864ea93e7a8db9d3fb113651d2131567e284e868021e114a67c3f5fb616ac4
bc4dcf2200c88ac1f976b8c9018ce70f9007e949435841fc5681fd33308dd762
```

Další 4 se týkají posílání bitcoinů:

```plaintext
8b52fe3c2cf8bef60828399d1c776c0e9e99e7aaeeff721fff70f4b68145d540
c12499e9a865b9e920012e39b4b9867ea821e44c047d022ebb5c9113f2910ed6
a6dbebebca119af3d05c0196b76f80fdbf78f20368ebef1b7fd3476d0814517d
3aeb7ce02c35eaecccc0a97a771d92c3e65e86bedff42a8185edd12ce89d89cc
```

**_Cvičení 6:_**

Prozkoumáme-li strukturu této transakce, je zřejmé, že se jedná o seskupený výdaj. Ve skutečnosti má transakce jeden vstup a 51 výstupů, což svědčí o významné ekonomické aktivitě. Můžeme tedy předpokládat, že Loïc provedl výběr bitcoinů z výměnné platformy.

Tuto hypotézu podporuje několik prvků. Zaprvé, typ skriptu použitý k ochraně vstupního UTXO je P2SH multisig 2/3 skript, což naznačuje pokročilou úroveň zabezpečení typickou pro výměnné platformy:

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```

Analyzovaná adresa `3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF` byla navíc opakovaně použita ve více než 220 000 různých transakcích, což je často charakteristické pro výměnné platformy, které obecně nedbají na své soukromí. Časová heuristika aplikovaná na tuto adresu také ukazuje pravidelné rozložení transakcí téměř denně po dobu 3 měsíců s prodlouženými hodinami přes 24 hodin, což naznačuje nepřetržitou aktivitu výměnné platformy.

A konečně, objemy zpracovávané tímto subjektem jsou obrovské. Ve skutečnosti tato adresa přijala a odeslala 44 BTC během 222 262 transakcí v období od prosince 2022 do března 2023. Tyto významné objemy dále potvrzují pravděpodobnou povahu činnosti výměnné platformy.

**_Cvičení 7:_**

Analýzou časů potvrzení transakcí lze zjistit následující časy UTC:

```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

Z analýzy těchto časů je zřejmé, že časová pásma UTC-7 a UTC-8 odpovídají ve většině případů rozsahu běžných lidských činností (mezi 8. a 23. hodinou):

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7
05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

Časové pásmo UTC-7 je důležité zejména v létě, protože zahrnuje státy a regiony, jako jsou:


- Kalifornie (s městy jako Los Angeles, San Francisco a San Diego);
- Nevada (s Las Vegas);
- Oregon (s Portlandem);
- Washington (se Seattlem);
- Kanadský region Britská Kolumbie (s městy jako Vancouver a Victoria).

Z těchto informací vyplývá, že by Loïc mohl bydlet na západním pobřeží Spojených států nebo v Kanadě.

**_Cvičení 8:_**

Analýza této transakce ukazuje 5 vstupů a jeden výstup, což zřejmě naznačuje konsolidaci. Použití heuristiky CIOH naznačuje, že všechny UTXO na vstupech jsou v držení jediného subjektu a že UTXO na výstupu patří rovněž tomuto subjektu. Zdá se, že uživatel se rozhodl konsolidovat několik jím vlastněných UTXO do jediného UTXO na výstupu s cílem konsolidovat své vlastní mince. Tento přístup byl pravděpodobně motivován snahou využít momentálně nízkých transakčních poplatků ke snížení budoucích poplatků.

---
_Při psaní této třetí části o analýze řetězců jsem vycházel z následujících zdrojů:_


- _Série čtyř článků s názvem: [Understanding Bitcoin Privacy with OXT](https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923), kterou vytvořila peněženka Samourai v roce 2021;_
- _Různé zprávy společnosti [OXT Research](https://medium.com/oxt-research), stejně jako jejich bezplatný nástroj pro analýzu řetězců (který již v současné době není k dispozici po zatčení zakladatelů společnosti Samourai Wallet);_
- _Všeobecněji řečeno, mé znalosti pocházejí z různých tweetů a obsahu [@LaurentMT](https://twitter.com/LaurentMT) a [@ErgoBTC](https://twitter.com/ErgoBTC);_
- \_Ve [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji), na kterém jsem se podílel spolu s [@louneskmt](https://twitter.com/louneskmt), [@TheoPantamis](https://twitter.com/TheoPantamis), [@Sosthene\_\_](https://twitter.com/Sosthene___) a [@LaurentMT](https://twitter.com/LaurentMT).\_

_Rád bych poděkoval jejich autorům, vývojářům a výrobcům. Děkuji také recenzentům, kteří pečlivě opravili článek, jenž posloužil jako základ pro tento třetí díl, a poctili mě svými odbornými radami:_


- _[Gilles Cadignan](https://twitter.com/gillesCadignan);_
- _[Ludovic Lars](https://viresinnumeris.fr/)._

# Osvojení osvědčených postupů pro ochranu soukromí

<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## Opakované použití adres

<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>

Po prostudování technik, které mohou ohrozit vaše soukromí na Bitcoinu, se v této třetí části budeme věnovat nejlepším postupům, které můžete použít na svou ochranu. Cílem této části není prozkoumat metody pro zlepšení soukromí, což je téma, kterému se budeme věnovat později, ale spíše pochopit, jak správně komunikovat s Bitcoinem, abyste si zachovali soukromí, které přirozeně nabízí, aniž byste se museli uchylovat k dalším technikám.

Na začátku této třetí části si samozřejmě povíme něco o opakovaném použití adresy. Tento jev je hlavní hrozbou pro soukromí uživatelů. Proto je tato kapitola pravděpodobně nejdůležitější v celém kurzu.

### Co je přijímací adresa?

Adresa pro příjem bitcoinů je řetězec znaků nebo identifikátor, který se používá pro příjem bitcoinů do peněženky.

Technicky vzato, adresa pro příjem bitcoinů "nepřijímá" bitcoiny v pravém slova smyslu, ale spíše definuje podmínky, za kterých lze bitcoiny utratit. Konkrétně, když je vám zaslána platba, transakce odesílatele vytvoří na výstupu z UTXO, které spotřebovala na vstupech, nové UTXO určené pro vás. Na tento výstup se použije skript, který definuje, jak lze toto UTXO později utratit. Tento skript se nazývá "_ScriptPubKey_" nebo "_Locking Script_" Vaše přijímací adresa, přesněji její payload, je vložena do tohoto skriptu. Zjednodušeně řečeno, tento skript v podstatě říká:

> "_Pro vydání tohoto nového UTXO je třeba zajistit digitální podpis pomocí soukromého klíče spojeného s touto přijímací adresou._"
![BTC204](assets/fr/067.webp)

Adresy bitcoinů jsou různých typů v závislosti na použitém modelu skriptu. První modely, známé jako "_Legacy_", zahrnují adresy `P2PKH` (_Pay-to-PubKey-Hash_) a `P2SH` (_Pay-to-Script-Hash_). Adresy P2PKH začínají vždy na `1` a adresy P2SH na `3`. Ačkoli jsou tyto formáty stále bezpečné, jsou nyní zastaralé, protože jsou s nimi spojeny vyšší transakční poplatky a nabízejí méně soukromí než nové standardy.

Adresy SegWit V0 (`P2WPKH` a `P2WSH`) a Taproot / SegWit V1 (`P2TR`) představují moderní formáty. Adresy SegWit začínají písmenem `bc1q` a adresy Taproot, zavedené v roce 2021, začínají písmenem `bc1p`.

Například zde je adresa pro příjem služby Taproot:

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

Způsob konstrukce klíče ScriptPubKey závisí na používaném standardu:

| Šablona skriptu | ScriptPubKey | | ---------------- | ----------------------------------------------------------- | ----------------------------------------------------------- |

| P2PKH | OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG |

| P2SH | OP_HASH160 `<scriptHash>` OP_EQUAL |

| P2WPKH | 0 `<pubKeyHash>` |

| P2WSH | 0 `<witnessScriptHash>` |

| P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL |

| P2SH - P2WSH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL |

| P2TR | 1 `<pubKey>` |

Pokud jde o konstrukci přijímacích adres, závisí také na zvolené šabloně skriptu:


- U adres `P2PKH` a `P2WPKH` představuje užitečné zatížení neboli jádro adresy hash veřejného klíče;
- U adres `P2SH` a `P2WSH` představuje užitečné zatížení hash skriptu;
- U adres `P2TR` je užitečným nákladem upravený veřejný klíč. Výstupy `P2TR` kombinují aspekty _Pay-to-PubKey_ a _Pay-to-Script_. Modifikovaný veřejný klíč je výsledkem přidání klasického výdajového veřejného klíče s "modifikací", odvozenou z Merkleho kořene sady skriptů, které lze rovněž použít k utrácení bitcoinů.

![BTC204](assets/it/67/01.webp)

Adresy zobrazené v softwaru peněženky obsahují také HRP (_Human-Readable Part_), obvykle `bc` pro adresy po SegWitu, oddělovač `1` a číslo verze `q` pro SegWit V0 a `p` pro Taproot/SegWit V1. Přidává se také kontrolní součet, který zajišťuje integritu a platnost adresy během jejího přenosu.

Nakonec jsou adresy převedeny do standardního formátu:


- Base58check pro staré adresy Legacy;
- Bech32 pro adresy SegWit;
- Bech32m pro adresy Taproot.

Zde je sčítací matice pro formáty bech32 a bech32m (SegWit a Taproot) od základu 10:

| + | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| 0 | q | p | z | r | y | 9 | x | 8 | 8

| 8 | g | f | 2 | t | v | d | w | 0 |

| 16 | s | 3 | j | n | 5 | 4 | k | h | | 24 | c | e | 6 | m | u | a | 7 | l | l

### Co je opakované použití adresy?

Opakované použití adresy označuje praxi, kdy se stejná přijímací adresa používá k blokování několika různých UTXO.

Jak jsme viděli v předchozí části, každý UTXO má svůj vlastní ScriptPubKey, který jej uzamyká a musí být splněn, aby mohl být UTXO použit jako vstup v nové transakci. Právě v tomto klíči ScriptPubKey jsou vloženy adresy pro příjem (payloads).

Pokud několik ScriptPubKeys obsahuje stejnou přijímací adresu, jedná se o tzv. opakované použití adresy. V praxi to znamená, že uživatel poskytl odesílatelům stejnou adresu vícekrát, aby mohl přijímat bitcoiny prostřednictvím více plateb. A tato praxe je skutečně katastrofální pro vaše soukromí.

### Proč je opakované použití adresy problém?

Protože je blockchain veřejný, lze snadno zjistit, které adresy blokují které UTXO a kolik bitcoinů. Pokud je stejná adresa použita pro více transakcí, je možné odvodit, že všechny bitcoiny spojené s touto adresou patří stejné osobě. Tento postup ohrožuje soukromí uživatelů tím, že umožňuje vytvářet deterministické vazby mezi různými transakcemi a sledovat bitcoiny v blockchainu. Na tento problém upozornil sám Satoshi Nakamoto v Bílé knize o Bitcoinu:

> _Jako další brána firewall by mohl být pro každou transakci použit nový pár klíčů, aby se zabránilo jejich propojení se společným vlastníkem._
![BTC204](assets/fr/055.webp)

Zdroj: Nakamoto, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

Cílem, o který Satoshi tímto prohlášením usiloval, bylo vytvořit další firewall v případě spojení mezi identitou uživatele a párem klíčů v Bitcoinu, aby se zabránilo tomu, že veškerá jeho aktivita bude veřejně spojena s jeho identitou. Dnes, s rozmachem společností zabývajících se analýzou blockchainu a regulací KYC, již používání unikátních adres není "dodatečným firewallem", ale nezbytnou praxí pro každého, kdo si chce minimálně zachovat své soukromí.

Při opakovaném použití adresy vytváříte téměř nezpochybnitelné spojení mezi všemi transakcemi spojenými s touto adresou. To sice přímo neohrožuje vaše finanční prostředky, protože šifrování na eliptických křivkách zajišťuje bezpečnost vašich soukromých klíčů, ale usnadňuje to sledování vašich aktivit. Ve skutečnosti může kdokoli s uzlem sledovat vaše transakce a zůstatky na adresách, což zcela ohrožuje vaši anonymitu.

![BTC204](assets/it/34/01.webp)

Pro ilustraci uveďme příklad Boba, uživatele, který pravidelně nakupuje bitcoiny po malých částkách prostřednictvím metody DCA (Dollar Cost Averaging) a posílá je vždy na stejnou adresu. Po dvou letech tato adresa obsahuje značné množství bitcoinů. Pokud Bob použije tuto adresu k platbě u místního obchodníka, obchodník by mohl vidět všechny související prostředky a odečíst Bobovo bohatství. To by mohlo vést k osobním bezpečnostním rizikům, včetně pokusů o krádež nebo vydírání. Pokud by Bob používal pro příjem každého pravidelného nákupu novou adresu, odhalil by obchodníkovi neskonale méně informací.

Při analýze řetězce rozlišujeme 2 typy opakovaného použití adresy:


- Externí opětovné použití;
- Interní opakované použití v rámci transakce.

První se projevuje, když je adresa opakovaně použita v několika různých transakcích Bitcoinu. To je to, o čem jsme hovořili dříve: tato heuristika nám umožňuje odvodit, že všechny UTXO, které procházejí touto adresou, patří jednomu subjektu.

Opakované použití vnitřních adres se nepozoruje, pokud k němu dochází v rámci více transakcí, ale pokud k němu dochází v rámci jedné transakce. Pokud je totiž stejná adresa, která byla použita k uzamčení vstupu, použita jako výstup v transakci, pak můžeme usuzovat, že tento výstup stále patří stejnému uživateli (zbytku) a že druhý výstup představuje skutečnou platbu. Tato další heuristika umožňuje sledovat prostředky v rámci více transakcí.

![BTC204](assets/it/33/02.webp)

Opakované použití adres je pro Bitcoin skutečnou pohromou. Podle webových stránek OXT.me (v současné době nepřístupných) činila v roce 2022 celková míra opakovaného použití adres v Bitcoinu přibližně 52 %:

![BTC204](assets/fr/069.webp)

Tato míra je obrovská, ale pochází v drtivé většině od výměnných platforem, nikoli od jednotlivých uživatelů.

### Jak zabránit opakovanému použití adresy?

Zamezit opakovanému použití adresy je poměrně jednoduché: **pro každou novou příchozí platbu v peněžence použijte novou adresu**.

Díky BIP32 jsou nyní moderní portfolia deterministická a hierarchická. To znamená, že uživatel může vygenerovat velké množství adres z jediné počáteční informace: semínka. Uložením této jediné informace lze obnovit všechny soukromé klíče v peněžence, a získat tak přístup k finančním prostředkům zajištěným příslušnými adresami.

![BTC204](assets/fr/070.webp)

Proto se vám při stisknutí tlačítka "_přijmout_" v softwaru peněženky pokaždé nabídne nepoužitá přijímací adresa. Po přijetí bitcoinů na této adrese software automaticky navrhne novou adresu.

> _PS: Nedávno některé peněženky oznámily svůj záměr přestat generovat prázdné adresy, protože se obávají, že by to úřady mohly vnímat jako formu praní špinavých peněz. Pokud je mezi nimi i váš software, důrazně vám doporučuji, abyste jej okamžitě vyměnili, protože to je pro uživatele nepřijatelné._
Pokud potřebujete statický identifikátor pro příjem plateb, například pro příjem darů, nedoporučuje se používat klasickou adresu Bitcoin kvůli riziku opakovaného použití. Raději použijte adresu Lightning nebo pro statický identifikátor platby v řetězci můžete zvolit BIP47 nebo Silent Payments. Jak tyto protokoly fungují, je podrobně popsáno v 6. části tohoto školení.

## Označování a kontrola mincí

<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>

Jak jsme zjistili v části věnované analýze řetězců, existuje množství heuristik a vzorů, které lze použít k odvození informací o transakci. Jako uživatel je důležité tyto techniky znát, abyste se mohli lépe chránit.

To do značné míry zahrnuje přísnou správu peněženky v osobní úschově, která zahrnuje znalost původu UTXO a také promyšlený výběr UTXO, které mají být spotřebovány při platbách. Tato efektivní správa peněženky se opírá o dvě důležité vlastnosti dobrých bitcoinových peněženek: označování a kontrolu mincí.

V této kapitole se budeme zabývat těmito funkcemi a zjistíme, jak je lze inteligentně využívat, aniž by se zvýšila pracovní zátěž, a jak tak výrazně optimalizovat své soukromí v systému Bitcoin.

### Co je to označování?

Označování je postup, který zahrnuje přiřazení anotace nebo štítku konkrétnímu UTXO v peněžence Bitcoin. Tyto anotace jsou ukládány lokálně softwarem peněženky a nikdy nejsou přenášeny přes síť Bitcoin. Tagování je tedy nástroj pro osobní správu.

Pokud například vlastním UTXO z nákupu P2P na Bisq s Charlesem, mohu mu přiřadit označení "`Non-KYC Bisq Charles`".

Označování je osvědčený postup, který pomáhá zapamatovat si původ nebo zamýšlené místo určení UTXO, a tím usnadňuje správu finančních prostředků a optimalizuje ochranu osobních údajů. Ve skutečnosti vaše peněženka s bitcoiny pravděpodobně obsahuje několik UTXO. Pokud se zdroje těchto UTXO liší, možná nebudete chtít tyto UTXO v budoucnu slučovat, jinak byste mohli odhalit jejich společné vlastnictví. Řádným označením všech svých mincí zajistíte, že si vzpomenete na jejich původ, až je budete potřebovat, i kdyby to mělo být až za několik let.

### Co je kontrola mincí?

Aktivní používání tagů je ještě atraktivnější v kombinaci s možností ovládání mincí v softwaru peněženky.

Kontrola mincí je funkce, kterou najdete v dobrém softwaru bitcoinové peněženky a která vám dává možnost ručně vybrat konkrétní UTXO, které chcete použít jako vstup pro provedení transakce. Ve skutečnosti, abyste uspokojili odchozí platbu, musíte na oplátku spotřebovat příchozí UTXO. Z několika důvodů, které uvidíme později, si můžete chtít přesně vybrat, které mince spotřebujete jako vstup pro uspokojení dané platby. Přesně to kontrola mincí umožňuje. Abychom vám poskytli analogii, tato funkce je podobná akci, kdy si při placení za bagetu vyberete konkrétní minci ve své peněžence.

Použití softwaru peněženky řízené mincemi v kombinaci s označením UTXO umožňuje uživatelům přesně rozlišovat a vybírat UTXO pro své transakce.

### Jak správně označit UTXO?

Neexistuje univerzální metoda označování UTXO, která by vyhovovala všem. Je na vás, abyste si definovali systém označování, který vám usnadní orientaci ve vašem portfoliu. V každém případě mějte na paměti, že dobré značení je to, čemu budete schopni porozumět, až to budete potřebovat. Pokud vaše peněženka s bitcoiny slouží především ke spoření, může se stát, že vám označení bude užitečné až za několik desítek let. Proto dbejte na to, aby byly jasné, přesné a srozumitelné.

Je důležité, aby vaši blízcí mohli snadno identifikovat zdroj finančních prostředků, pokud by jednoho dne potřebovali přístup k vašemu portfoliu. To by jim mohlo pomoci z důvodu ochrany soukromí i pro právní potřeby, pokud by potřebovali původ prostředků zdůvodnit před nějakým úřadem.

Nejdůležitějším aspektem označování je uvedení zdroje UTXO. Měli byste jednoduše uvést, jak se tato mince dostala do vaší peněženky. Pochází z nákupu na výměnné platformě? Z platby od zákazníka? Z peer-to-peer burzy? Nebo se jedná o zbytek nákupu? Mohli byste tedy uvést:


- `Pickup Exchange.com`;
- `Platební klient David`;
- `Koupit P2P Charles`;
- `Zachování z nákupu pohovky`

Chcete-li zpřesnit správu UTXO a dodržovat své strategie oddělování fondů v rámci portfolia, můžete své štítky obohatit o další značku, která bude odrážet toto oddělení. Pokud vaše portfolio obsahuje dvě kategorie UTXO, které si nepřejete míchat, mohli byste do svých štítků začlenit značku, která tyto skupiny jasně odliší. Tyto oddělovací značky budou záviset na vašich kritériích, jako je například rozlišení mezi UTXO z akvizičního procesu zahrnujícího KYC nebo mezi profesionálními a osobními fondy. Vezmeme-li v úvahu dříve uvedené příklady štítků, mohlo by se to projevit takto:


- `KYC - Exchange.com Withdrawal`;
- `KYC - Customer Payment David`;
- `NO KYC - Nákup P2P Charles`;
- `NO KYC - Zbytek z nákupu pohovky`

Při transakcích je rovněž vhodné zachovat označení mince. Například při konsolidaci UTXO bez KYC nezapomeňte výsledné UTXO označit nejen jako `konsolidaci`, ale konkrétně jako `konsolidaci bez KYC`, aby byla zachována jasná stopa původu mince.

A konečně, uvedení data na etiketě není povinné. Většina softwaru peněženek již datum transakce zobrazuje a vždy je možné tuto informaci získat v průzkumníku bloků pomocí jeho TXID.

### Jak správně vybrat mince?

Při provádění transakce vám ovládání mincí umožňuje konkrétně vybrat, které UTXO se mají spotřebovat jako vstup pro uspokojení výstupu platby. Při této volbě je třeba vzít v úvahu dva aspekty:


- Možnost příjemce platby propojit část vaší identity s UTXO použitými jako vstup;
- Schopnost vnějšího pozorovatele vytvářet spojení mezi všemi UTXO spotřebovanými jako vstup.

Pro ilustraci prvního bodu si uveďme konkrétní příklad. Předpokládejme, že si u místního pekaře koupíte bagetu za bitcoiny. Jako vstup použijete jeden nebo více vlastních UTXO, abyste pokryli alespoň cenu bagety na výstupu plus transakční poplatky. Váš pekař by pak mohl potenciálně spojit váš obličej nebo jakoukoli jinou část vaší identity, kterou zná, s mincemi použitými jako vstup. S vědomím existence tohoto propojení byste mohli při platbě upřednostnit jednu konkrétní UTXO před jinou.

Pokud například jeden z vašich UTXO pochází z burzovní platformy a vy byste si přáli, aby pekař nevěděl o vašem účtu na této platformě, vyhnuli byste se použití tohoto UTXO pro platbu. Pokud máte UTXO s vysokou hodnotou, které odhaluje značné množství bitcoinů, mohli byste se také rozhodnout jej nepoužít, aby pekař nevěděl o vašem jmění v BTC.

Výběr UTXO, které použijete pro tento první bod, je tedy založen na osobním rozhodnutí, ovlivněném tím, co jste ochotni zveřejnit, nebo ne. Štítky, které jste přiřadili svým UTXO při příjmu, vám pomohou vybrat ty, které po utracení zobrazí pouze ty informace, které jste ochotni příjemci prozradit.

Kromě informací, které mohou být odhaleny příjemci, ovlivňuje vaše volba vstupů také to, co prozradíte všem pozorovatelům blockchainu. Pokud totiž jako vstupy do transakce použijete více UTXO, prozradíte, že jsou vlastněny stejným subjektem, podle heuristiky společného vlastnictví vstupů (CIOH).

Při výběru mincí byste si proto měli uvědomit, že transakce, kterou se chystáte přenést, vytvoří spojení mezi všemi použitými UTXO. Toto propojení může být problematické pro vaše soukromí, zejména pokud UTXO pocházejí z různých zdrojů.

Vraťme se k příkladu mého UTXO bez KYC od Bisq; chci se vyhnout kombinaci s UTXO například z regulované burzovní platformy, která zná mou identitu. Pokud bych totiž někdy použil tyto 2 UTXO jako vstupy v jedné transakci, regulovaná platforma by byla schopna spojit mou identitu s UTXO, které jsem zakoupil na Bisq, zatímco dříve s mou identitou spojeno nebylo.

A konečně, pro správný výběr UTXO, které se mají použít jako vstup pro transakci, je nejdůležitější vyhnout se použití více UTXO. Kdykoli je to možné, vyberte jednu minci, která je dostatečně velká na to, aby pokryla vaši platbu. Tím se zcela vyhnete rizikům spojeným s COINJOIN. Pokud však žádné jednotlivé UTXO na vaši platbu nestačí a potřebujete jich spotřebovat několik, ujistěte se, že pocházejí z podobných zdrojů, abyste minimalizovali rizika nežádoucího propojení. Mějte také na paměti, že příjemce si může informace, které o vás má, spojit s historií mincí použitých jako vstup.

### Porozumění automatickému výběru mincí

V předchozích částech jsme se zabývali ručním výběrem UTXO pro transakci. Co se však stane, když tento výběr provede software peněženky automaticky? Existuje několik metod, jak určit, které mince se mají spotřebovat, a výběr UTXO je v Bitcoinu skutečnou oblastí výzkumu. Hlavním cílem tohoto automatického procesu je často minimalizovat transakční poplatky pro uživatele.

Metody výběru UTXO, jako je FIFO (_First In First Out_) a LIFO (_Last In First Out_), patří mezi nejjednodušší, ale také nejméně efektivní. Při FIFO se nejprve použijí nejstarší mince v portfoliu. Tento přístup je obecně neefektivní jak z hlediska minimalizace transakčních poplatků, tak z hlediska zachování soukromí, s výjimkou případů, kdy se používají relativní časové zámky, které se musí pravidelně obnovovat. Naproti tomu LIFO upřednostňuje použití nejnovějších UTXO. Ačkoli jsou tyto dvě metody jednoduché, často se ukazují jako neefektivní.

Pokročilejší metodou je _Knapsack Solver_. Tato metoda se používala v peněžence Bitcoin Core až do verze 0.17. Spočívá v iterativním a náhodném výběru UTXO z peněženky, jejich sečtení do podskupin a ponechání řešení, které co nejvíce snižuje váhu transakce, aby se snížily uživatelské poplatky.

Algoritmus _Branch-and-Bound_ (BNB), kterému se často přezdívá "Murchův algoritmus" s odkazem na jeho vynálezce, nahradil v jádře bitcoinu od verze 0.17 algoritmus _Knapsack Solver_. Cílem této pokročilejší metody je najít sadu UTXO, která přesně odpovídá částce potřebné k uspokojení výstupů transakce. Cílem BNB je minimalizovat výši zbytku i poplatků snížením tzv. kritéria odpadu, které zohledňuje jak okamžité náklady, tak očekávané budoucí náklady na zbytek. Tato metoda je odvozena z původní koncepce _Branch-and-Bound_, kterou v roce 1960 navrhly Ailsa Landová a Alison Harcourtová, a nabízí přesnější optimalizaci provizí než _Knapsack Solver_.

Všechny tyto metody automatického výběru UTXO mohou být účinné při snižování transakčních poplatků, ale často jsou neúčinné při ochraně soukromí uživatelů. Tyto algoritmy totiž mohou sloučit několik UTXO na vstupu, a tím odhalit společné vlastnictví těchto UTXO kvůli COH. Je zřejmé, že tyto metody nemohou brát v úvahu štítky připojené k UTXO, které jsou klíčové pro vědomý výběr mincí, které mají být příjemci transakce odhaleny. V současné době je jediným řešením optimalizace soukromí při výběru mincí ruční výběr.

### Výukový program označování UTXO

Pokud se chcete dozvědět, jak označit UTXO, připravili jsme pro vás komplexní návod pro hlavní existující software bitcoinových peněženek:

https://planb.network/tutorials/privacy/on-chain/utxo-labelling-d997f80f-8a96-45b5-8a4e-a3e1b7788c52
## KYC a identifikace klíčů

<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>

Zkratka KYC znamená "Poznej svého zákazníka", což je regulační postup, který uplatňují některé společnosti působící v odvětví bitcoinů. Cílem tohoto postupu je ověřit a zaznamenat totožnost jejich zákazníků s deklarovaným cílem bojovat proti praní špinavých peněz a financování terorismu.

Konkrétně KYC zahrnuje shromažďování různých osobních údajů klienta, které se mohou lišit podle jurisdikce, ale obecně zahrnují průkaz totožnosti, fotografii a doklad o bydlišti. Tyto informace jsou následně ověřeny a uloženy pro budoucí použití.

Tento postup je ve většině západních zemí povinný pro všechny regulované burzovní platformy. To znamená, že každý, kdo chce prostřednictvím těchto platforem směnit fiat měny za bitcoiny, musí splnit požadavky KYC.

Tento postup není bez rizika pro soukromí a bezpečnost uživatelů. V této kapitole se budeme těmito riziky podrobně zabývat a analyzovat konkrétní dopady procesů KYC a identifikace na soukromí uživatelů bitcoinu.

### Usnadnění sledování v řetězci

První riziko spojené s KYC spočívá v tom, že poskytuje preferovaný vstupní bod pro analýzu blockchainu. Jak jsme viděli v předchozí části, analytici mohou seskupovat a sledovat aktivity v blockchainu pomocí transakčních vzorů a heuristiky. Jakmile se jim podaří seskupit aktivitu uživatele v onchainu, stačí najít pouze jeden vstupní bod mezi všemi jeho transakcemi a klíči, aby zcela ohrozili jeho soukromí.

![BTC204](assets/fr/078.webp)

Když se podrobíte KYC, poskytujete velmi kvalitní vstupní bod pro analýzu řetězce, protože spojujete přijímací adresy používané při výběru bitcoinů z výměnné platformy s vaší úplnou, ověřenou identitou. Teoreticky jsou tyto informace známy pouze společnosti, které jste je poskytli, ale jak uvidíme později, riziko ztráty dat je reálné. Navíc už samotný fakt, že společnost tyto informace má, může být problematický, i když je nesdílí.

Pokud tedy nebudou přijata jiná opatření k omezení sdružování aktivit v blockchainu, může kdokoli, kdo si je vědom vstupního bodu, kterým je KYC, potenciálně spojit veškerou svou aktivitu v Bitcoinu se svou identitou. Z pohledu této společnosti tedy používání Bitcoinu ztrácí veškerou důvěrnost.

![BTC204](assets/fr/079.webp)

Pro ilustraci uveďme srovnání, jako kdyby bankéř v _Bance X_ měl přístup nejen ke všem transakcím provedeným s _Bankou X_, ale mohl sledovat i transakce s _Bankou Y_ a všechny vlastní hotovostní transakce.

Připomeňme si první část tohoto školení: model soukromí Bitcoinu, jak jej navrhl Satoshi Nakamoto, je založen na oddělení identity uživatele a jeho klíčových párů. Ačkoli tato vrstva soukromí dnes již není dostatečná, stále je rozumné co nejvíce omezit její degradaci.

### Vystavení státnímu dohledu

Druhým velkým problémem KYC je, že odhaluje státu, že někdo někdy vlastnil bitcoiny. Když bitcoiny nakoupíte prostřednictvím regulovaného subjektu, je možné, aby se stát o tomto vlastnictví dozvěděl. V současné době se to může zdát jako banalita, ale je důležité si uvědomit, že politickou a ekonomickou budoucnost své země nemá člověk ve svých rukou.

Především může stát rychle zaujmout autoritářský postoj. Historie je plná příkladů, kdy se politika náhle změnila. V Evropě dnes mohou nadšenci do bitcoinu psát články o bitcoinu, účastnit se konferencí a spravovat vlastní peněženky pro vlastní potřebu. Ale kdo může říci, co bude zítra? Pokud se Bitcoin náhle stane veřejným nepřítelem číslo jedna, může být spojování s ním ve státních registrech problematické.

Později, v případě vážné hospodářské krize, by stát mohl uvažovat o zabavení bitcoinů v držení občanů. Možná, že zítra budou bitcoináři považováni za ty, kteří využívají krize a budou kvůli svým kapitálovým ziskům tváří v tvář znehodnocení fiat měny nadměrně zdaněni.

Možná si myslíte, že to není problém, protože vaše bitcoiny jsou zamíchány, a proto je nelze dohledat. Dohledatelnost zde však není problémem. Skutečným problémem je, že stát ví, že jste bitcoiny vlastnili. Tato jednoduchá informace může stačit k tomu, aby vás obvinil nebo si vyžádal účet. Mohli byste se pokusit tvrdit, že jste bitcoiny utratili, ale to by se muselo projevit ve vašem daňovém přiznání a byli byste odhaleni. Mohli byste také říct, že jste ztratili klíče při nehodě na lodi, ale kromě vtipu na Twitteru si opravdu myslíte, že by to stačilo k vašemu očištění?

Proto je důležité zvážit riziko spojené s prostým faktem, že by se stát mohl dozvědět, že vlastníte BTC, i když se toto riziko dnes může zdát vzdálené.

Dalším problémem, který KYC představuje z hlediska státního dohledu, je povinné podávání zpráv regulovanými platformami. Ačkoli nejsem obeznámen s předpisy v jiných jurisdikcích, ve Francii jsou _Poskytovatelé služeb digitálních aktiv_ (PSAN) povinni hlásit orgánům finančního dohledu jakýkoli pohyb finančních prostředků, který považují za podezřelý.

Ve Francii tak bylo v roce 2023 nahlášeno 1 449 podezřelých činů ze strany PSAN. Většina těchto činů prozatím souvisí s trestnou činností. Orgány však také žádají regulované platformy, aby hlásily veškeré podezřelé transakce s bitcoiny pouze na základě jejich struktury. Pokud provedete společnou transakci nebo dokonce jen transakci, která má poněkud netypický vzorec, a tato transakce se vyskytne v blízkosti výběru vašich bitcoinů z těchto platforem, můžete se ocitnout v situaci, kdy budete nahlášeni úřadům. I v případě, že se nedopustíte žádného protiprávního jednání a jedná se o legitimní výkon vašich práv, může toto nahlášení vést ke zvýšené kontrole a dohledu, což jsou nepříjemnosti, kterým byste se bez KYC vyhnuli.

### Riziko ztráty osobních údajů

Další problém s KYC spočívá v tom, že vyžaduje uložení všech vašich osobních údajů na serverech soukromé společnosti. Nedávné události nám připomněly, že nikdo není imunní vůči selhání, ať už finančnímu nebo IT. V roce 2022 na to doplatili zákazníci společnosti Celsius. V důsledku úpadku společnosti zveřejnila americká justice během správního řízení jména věřitelů a výši jejich majetku.

Před více než dvěma lety došlo ke krádeži osobních údajů zákazníků jednoho z předních subjektů zabývajících se kybernetickou bezpečností v oblasti kryptoměn. Ačkoli tento incident přímo nesouvisel s nákupem bitcoinů, toto riziko zůstává i pro směnárenské platformy. S těmito osobními údaji je tedy spojeno určité riziko.

Je pravda, že velkou část svých osobních údajů již svěřujeme soukromým společnostem. Riziko je zde však dvojí, protože tyto údaje nejen umožňují vaši identifikaci, ale jsou také spojeny s aktivitou na bitcoinu. Pokud totiž hacker získá přístup k údajům zákazníků směnárenské platformy, může důvodně předpokládat, že tito zákazníci vlastní bitcoiny. Toto riziko je tedy ještě umocněno skutečností, že bitcoin, stejně jako jakékoli jiné cenné aktivum, přitahuje zájem zlodějů.

V případě úniku dat se můžete stát v nejlepším případě terčem cílených pokusů o phishing. V horším případě se můžete ocitnout v centru fyzického ohrožení svého domova.

Kromě specifických rizik spojených s bitcoinem je třeba vzít v úvahu také nebezpečí spojená s předáváním dokladů totožnosti. V případě úniku dat je totiž možné stát se obětí krádeže identity. Problémy, které jsou v sázce, se tedy neomezují pouze na ochranu důvěrnosti transakcí, ale dotýkají se také osobní bezpečnosti každého jednotlivce.

### Nejčastější nedorozumění týkající se KYC

Je důležité vyvrátit některé běžné mylné představy o KYC, které se často objevují na Twitteru nebo v našich diskusích mezi bitcoináři.

Především je chybné si myslet, že ochrana soukromí bitcoinů získaných prostřednictvím KYC (Know Your Customer) je zbytečná. Nástroje a metody ochrany soukromí u bitcoinů jsou různé a slouží k různým účelům. Například používání transakcí coinjoin na bitcoinech z KYC není špatný nápad. Samozřejmě je třeba být obezřetný u regulovaných směnárenských platforem, abyste se vyhnuli zmrazení nebo zákazu účtu, ale z čistě technického hlediska se tyto postupy nevylučují. Coinjoin má za následek narušení historie mince, což pomáhá čelit některým rizikům analýzy řetězce spojeným s KYC. Ačkoli to neodstraňuje všechna rizika, je to již významná výhoda.

Na soukromí bitcoinů by se nemělo nahlížet binárně, jako na rozdíl mezi "anonymními" bitcoiny a jinými, které anonymní nejsou. Vlastnictví bitcoinů získaných prostřednictvím KYC neznamená, že je vše ztraceno; naopak, používání nástrojů pro ochranu soukromí se může ukázat jako ještě přínosnější.

Naopak získání bitcoinu metodou, která není spojena s KYC, nezaručuje dokonalé soukromí a nezbavuje vás nutnosti přijmout další ochranná opatření. Pokud držíte bitcoiny způsobem non-KYC, ale opakovaně používáte přijímací adresy, mohou být vaše transakce sledovány a seskupovány. Sebemenší spojení se světem mimo bitcoin může ohrozit jedinou vrstvu soukromí, kterou jste měli. Proto je důležité považovat všechny nástroje a metody, které zlepšují soukromí v bitcoinech, za doplňkové. Každá technika řeší konkrétní riziko a může přidat další vrstvu ochrany. Vlastnictví bitcoinů, které nejsou předmětem KYC, vás tedy absolutně nezbavuje povinnosti přijmout další bezpečnostní opatření.

### Lze KYC zrušit?

Někdy se mě ptají, zda je možné se po dokončení KYC "vrátit", a jak si můžete představit z předchozích odstavců, odpověď je různorodá. Chcete-li se vyhnout rizikům spojeným s KYC, nejjednodušší metodou je nepoužívat ji při pořizování bitcoinů. Tomuto tématu se budeme podrobněji věnovat v následující kapitole. Pokud však KYC již byla provedena a bitcoiny byly nakoupeny, existují způsoby, jak vzniklá rizika zmírnit?

Pokud jde o riziko sledování vašich transakcí, jedním z řešení je použití služby coinjoin. Tuto metodu podrobně probereme později v rámci školení, ale vězte, že coinjoin může narušit historii mince a zabránit jejímu dohledání z minulosti do současnosti a z přítomnosti do minulosti. Dokonce i v případě BTC získaných prostřednictvím regulované platformy může tato technika zabránit jejich dohledatelnosti.

Služba coinjoin však neeliminuje druhé riziko spojené s KYC: skutečnost, že stát je informován o vašem držení bitcoinů. Ve skutečnosti, i když vaše mince již nejsou dohledatelné, může mít stát v závislosti na jurisdikci přístup k vašim výpisům o zcizení kryptoaktivních aktiv. Jelikož toto riziko není technické, ale administrativní, neexistují žádná specifická řešení pro bitcoin, která by ho eliminovala, kromě toho, že se zpočátku vyhnete expozici KYC. Jediným legálním přístupem ke zmírnění tohoto rizika je prodat své bitcoiny získané prostřednictvím regulovaných platforem na regulovaných platformách a poté je koupit zpět prostředky bez KYC. Prodejem a nahlášením zcizení by měla správa zaznamenat, že je již nevlastníte.

Pokud jde o riziko prozrazení vašich osobních údajů a dokladů totožnosti, jedná se o nebezpečí, které je s bitcoinem spojeno, a neexistuje žádné technické řešení, jak se mu vyhnout. Jakmile jsou vaše údaje jednou zveřejněny, je obtížné to zvrátit. Můžete se pokusit zrušit svůj účet na platformě, ale to nezaručuje odstranění vašich údajů KYC, zejména pokud je ověřování totožnosti zadáváno externím subjektům. Ověřit úplné odstranění vašich údajů je nemožné. Proto neexistuje řešení, které by tomuto riziku zcela zabránilo a zajistilo, že již nebude existovat.

### Rozdíl mezi KYC a identifikací klíčů

Někdy mají někteří bitcoináři tendenci rozšířit pojem "KYC" na jakoukoli výměnu BTC zahrnující převod nebo platbu kreditní kartou, protože tyto prostředky mohou rovněž odhalit původ platby, stejně jako KYC. Je však důležité nezaměňovat KYC s identifikací klíče. Osobně musím přiznat, že mé vnímání tohoto tématu se v průběhu času vyvíjelo.

KYC se konkrétně týká regulačního postupu, který některé společnosti uplatňují za účelem ověření a zaznamenání totožnosti svých zákazníků. Jedná se o binární záležitost: když získáte bitcoiny, buď se KYC podrobíte, nebo ne. Identifikace klíče, která spočívá v propojení určitého aspektu identity uživatele s činností v řetězci, však není tak binární, ale představuje spíše kontinuum. V kontextu nákupu nebo prodeje bitcoinů je totiž tato identifikace v různé míře možná vždy.

Pokud si například koupíte bitcoin na regulované platformě ve Švýcarsku, není vyžadováno KYC (Know Your Customer). Může však dojít k identifikaci vašich klíčů, protože nákup byl proveden prostřednictvím vašeho bankovního účtu. Zde vznikají první dvě rizika spojená s KYC - usnadnění sledování na řetězci a vystavení vládnímu dohledu - která se mohou projevit i při výměně bez KYC. Pokud švýcarský subjekt nahlásí podezřelé transakce úřadům ve vaší zemi, mohou jednoduše zkontrolovat bankovní účet použitý k nákupu a zjistit vaši totožnost. Nákup bez KYC na regulovaných platformách je tedy na stupnici rizik pro identifikaci klíče poměrně vysoko.

Vyhýbání se regulovaným platformám a volba metod P2P (Peer-to-Peer) však riziko identifikace klíče zcela neodstraňuje, ale pouze snižuje. Vezměme si příklad nákupu na platformě Bisq nebo jiné platformě P2P. K vypořádání s protistranou pravděpodobně použijete svůj bankovní účet. Pokud úřady vyslechnou osobu, se kterou jste obchodovali, a požádají o vaše jméno, narazíme na výše uvedená rizika 1 a 2. Tato rizika jsou jistě mnohem nižší než nákup bez KYC na platformě, a dokonce nižší než nákup s KYC, ale stále jsou přítomna v menší míře.

A konečně, i když si bitcoiny koupíte prostřednictvím fyzické směnárny, nejste zcela anonymní. Osoba, se kterou jste obchodovali, viděla váš obličej, který je součástí vaší identity. I když je v tomto příkladu minimální, možnost identifikačního klíče stále existuje.

Závěrem lze říci, že při výměně bitcoinů za jiná aktiva, ať už se jedná o nákup fiat měny nebo prodej za reálné aktivum, vždy existuje určitá forma identifikace klíče. V závislosti na zvoleném způsobu směny může mít tato identifikace různou intenzitu. Je důležité nezaměňovat tuto identifikaci s KYC, což je přesně definovaný regulační proces. Mezi KYC a spektrem identifikace však existuje souvislost, neboť KYC se nachází na horním konci tohoto spektra, protože systematicky usnadňuje identifikaci uživatelských klíčů ze strany orgánů.

## Metody prodeje a akvizice

<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>

Po přečtení předchozí kapitoly vás možná zajímá, jak nakupovat nebo prodávat bitcoiny, aniž byste museli procházet procesem ověřování totožnosti, abyste se vyhnuli rizikům spojeným s KYC. Existuje několik způsobů provádění směn.

### Výměny P2P v hotovosti

Jak jsme viděli, nejlepší metodou z hlediska ochrany soukromí zůstává výměna P2P (peer-to-peer) s vypořádáním v hotovosti. Tato metoda umožňuje minimalizovat zanechané stopy a výrazně snižuje možnost identifikace klíče, ať už jste kupující, nebo prodávající.

Tento postup však s sebou nese osobní bezpečnostní rizika. Hlavní nebezpečí spočívá v tom, že protistrana se během výměny dozví, že držíte značnou částku buď v hotovosti, nebo v bitcoinech. Tato informace může přilákat pozornost zlomyslných osob. Ve skutečnosti se obecně doporučuje zůstat ohledně držení bitcoinů diskrétní. Tuto radu lze uplatnit i na hotovost. Při osobní výměně je však nevyhnutelné prozradit, že vlastníte bitcoin, což může vzbudit chamtivost.

Abyste toto riziko omezili, doporučuji upřednostňovat hotovostní transakce s důvěryhodnými osobami, jako jsou členové rodiny nebo blízcí přátelé. Případně můžete také zvážit provádění výměn na [místních bitcoinových setkáních](https://btcmap.org/communities/map), poté, co se jich několikrát zúčastníte. To vám umožní lépe poznat ostatní účastníky a nebýt během fyzické výměny sami. Je však důležité si uvědomit, že P2P výměna hotovosti s sebou neodmyslitelně nese rizika pro vaši osobní bezpečnost, která neexistují při nákupu prostřednictvím regulované platformy a vašeho bankovního účtu.

V závislosti na místě, kde žijete, může také přeprava a skladování velkých částek peněz představovat riziko, ať už jde o bitcoiny nebo hotovost.

Výměna hotovosti může také představovat právní riziko při policejní nebo jiné kontrole. Ačkoli ve většině zemí není výše hotovosti, kterou můžete mít u sebe, nijak omezena, příliš vysoké částky mohou vzbudit podezření. Buďte proto obezřetní, zejména pokud musíte cestovat na delší vzdálenosti, a vyhněte se příliš velkým transakcím najednou, abyste nemuseli zdůvodňovat držení značných částek.

Další nevýhodou nákupů přes P2P je, že cena je často vyšší než na regulovaných platformách. Prodejci si často účtují přirážku v rozmezí od 1 % do někdy více než 10 %. Tento cenový rozdíl lze vysvětlit několika důvody. Zaprvé jde o běžnou praxi prodejců P2P, která se ustálila v průběhu času. Kromě toho mají prodejci transakční poplatky spojené s odesláním finančních prostředků kupujícímu. Při prodeji P2P je také vyšší riziko krádeže než při transakcích na platformě, což ospravedlňuje poplatek za podstoupené riziko. V neposlední řadě může být poplatek relativní vzhledem k poptávce a kvalitě burzy z hlediska ochrany soukromí. Jako kupující je zisk z ochrany soukromí zahrnut do příplatku účtovaného prodávajícím. Někteří bitcoináři se také domnívají, že zvýšená cena BTC nakoupených v P2P odráží jejich skutečnou hodnotu, a tvrdí, že nižší ceny na regulovaných platformách jsou výsledkem kompromisu v oblasti soukromí vašich osobních údajů.

### Výměny P2P prostřednictvím srovnávací platformy

Méně rizikovou alternativou z hlediska osobní bezpečnosti je provádět výměny P2P výhradně online prostřednictvím elektronických platebních metod, jako je PayPal, bankovní převody nebo Revolut.

Tento přístup pomáhá vyhnout se mnoha rizikům spojeným s hotovostními transakcemi. Riziko, že protistrana nedodrží své závazky při online výměně, je však vyšší. Pokud totiž během fyzické výměny předáte peníze prodávajícímu, který vám na oplátku nepošle bitcoiny, můžete ho na to okamžitě upozornit, protože stojí před vámi. Naproti tomu online je často nemožné najít osobu, která vás okradla.

Ke zmírnění tohoto rizika lze pro výměny P2P využít specializované platformy pro párování. Tyto platformy používají mechanismy řešení konfliktů, které chrání poškozené uživatele. Obecně nabízejí systém úschovy, kde jsou bitcoiny drženy do doby, než prodávající potvrdí platbu ve fiat měně.

Z hlediska osobní bezpečnosti je tento způsob nákupu výrazně bezpečnější než fyzická výměna hotovosti. Jak však bylo zmíněno dříve, online P2P výměny zanechávají více stop než fyzická výměna, což může být na úkor soukromí u Bitcoinu. Použitím online fiat platebního prostředku, jako je banka, vystavujete více informací, které by mohly usnadnit identifikaci klíče.

Opět nedoporučuji na těchto platformách provádět velké obchody v rámci jedné transakce. Rozdělením transakcí rozložíte rizika spojená s případnou krádeží protistranou.

Další nevýhodou nákupů přes P2P je, že cena je často vyšší než na regulovaných platformách. Prodejci si často účtují přirážku v rozmezí od 1 % do někdy více než 10 %. Tento cenový rozdíl lze vysvětlit několika důvody. Zaprvé jde o běžnou praxi prodejců P2P, která se ustálila v průběhu času. Kromě toho mají prodejci transakční poplatky spojené s odesláním finančních prostředků kupujícímu. Při prodeji P2P je také vyšší riziko krádeže než při transakcích na platformě, což ospravedlňuje poplatek za podstoupené riziko. V neposlední řadě může být poplatek relativní vzhledem k poptávce a kvalitě burzy z hlediska ochrany soukromí. Jako kupující je zisk z ochrany soukromí zahrnut do příplatku účtovaného prodávajícím. Někteří bitcoináři se také domnívají, že vyšší cena BTC nakoupených prostřednictvím P2P odráží jejich skutečnou hodnotu, a tvrdí, že nižší ceny na regulovaných platformách jsou výsledkem kompromisu v oblasti soukromí vašich osobních údajů.

Co se týče řešení, osobně jsem vždy používal [Bisq](https://bisq.network/) a jsem s nimi velmi spokojen. Jejich systém je dobře zavedený a zdá se být spolehlivý. Bisq je však k dispozici pouze na PC a jeho rozhraní může být pro začátečníky příliš složité. Další nevýhodou je, že Bisq pracuje výhradně s onchain transakcemi, což se může v období vysokých transakčních poplatků u Bitcoinu prodražit.

-> Seznamte se s naším výukovým programem pro společnost Bisq.

https://planb.network/tutorials/exchange/peer-to-peer/bisq-fe244bfa-dcc4-4522-8ec7-92223373ed04
Jednodušší variantou je mobilní aplikace [Peach](https://peachbitcoin.com/), která usnadňuje spojení mezi kupujícími a prodávajícími pomocí integrovaného systému řešení sporů. Proces je intuitivnější než u společnosti Bisq.

-> Přečtěte si náš výukový program o broskvi.

Další online možností je [HodlHodl](https://hodlhodl.com/), zavedená platforma, která nabízí dobrou likviditu, ačkoli jsem ji osobně netestoval.

-> Přečtěte si náš výukový program HodlHodl.

https://planb.network/tutorials/exchange/peer-to-peer/peach-wallet-db64fe42-17ca-4b24-abb8-e7d4c03b2028
https://planb.network/tutorials/exchange/peer-to-peer/hodlhodl-d7344cd5-6b18-40f5-8e78-2574a93a3879
Pro řešení založená na síti Lightning Network můžete vyzkoušet [RoboSats](https://learn.robosats.com/) a [LNP2PBot](https://lnp2pbot.com/). RoboSats je přístupný prostřednictvím webové stránky a jeho použití je poměrně jednoduché. LNP2PBot je atypičtější v tom, že funguje prostřednictvím výměnného systému v aplikaci pro zasílání zpráv Telegram.

-> Podívejte se na náš návod na RoboSaty.

-> Podívejte se na náš návod na LNP2PBot.

https://planb.network/tutorials/exchange/peer-to-peer/robosats-b60e4f7c-533a-4295-9f6d-5368152e8c06
https://planb.network/tutorials/exchange/peer-to-peer/lnp2pbot-v2-e6bcb210-610b-487d-970c-7cce85273e3c
### Regulované platformy bez KYC

V závislosti na zemi, ve které žijete, můžete mít přístup k regulovaným platformám, které pro nákup nebo prodej bitcoinů nevyžadují postup KYC. Ve Švýcarsku můžete například využít platformy, jako jsou [Relai](https://relai.app/) a [MtPelerin](https://www.mtpelerin.com/).

-> Seznamte se s naším výukovým programem Relai.

Jak jsme viděli v předchozí kapitole, tento typ platformy vám ušetří rizika spojená s postupy KYC, ale představuje vyšší úroveň rizika pro identifikaci klíčů. Z hlediska ochrany soukromí v bitcoinech proto tyto platformy nabízejí lepší ochranu než metody nákupu KYC, ale jsou méně atraktivní než P2P burzy.

Z hlediska osobní bezpečnosti je však používání těchto platforem podstatně méně rizikové než burzy P2P. Jejich používání je také často jednodušší než u platforem, které zprostředkovávají výměny P2P.

https://planb.network/tutorials/exchange/centralized/relai-v2-30a9671d-e407-459d-9203-4c3eae15b30e
### BANKOMAT

Další možností, jak koupit nebo prodat bitcoin bez KYC, jsou kryptoměnové bankomaty (ATM). Osobně jsem nikdy neměl možnost toto řešení vyzkoušet, protože v mé zemi žádné nejsou. Tento způsob však může být velmi zajímavý v závislosti na tom, kde žijete.

Problém s bankomaty spočívá v tom, že v některých zemích jsou zakázány nebo v jiných jsou přísně regulovány. Pokud bankomat vyžaduje proces ověření totožnosti, pak čelí stejným rizikům, která jsou vlastní regulovaným platformám KYC. Pokud však bankomat umožňuje transakce bez ověření totožnosti pro malé částky, pak jeho použití může nabídnout úroveň soukromí srovnatelnou s výměnou P2P založenou na hotovosti, čímž se vyhne většině rizik spojených s tímto typem výměny.

Hlavní nevýhodou bankomatů jsou často vysoké poplatky za směnu cizích měn, které se pohybují od několika procent někdy až do 15 procent směňované částky.

### Dárkové karty

Nakonec jsem chtěl také představit řešení, které dobře funguje pro ty, kteří chtějí své bitcoiny denně používat k nákupům, místo aby je prodávali za fiat měny.

Nejlepším způsobem, jak utratit BTC, je samozřejmě použít k nákupu zboží nebo služeb přímo bitcoin nebo Lightning Network. V mnoha zemích je však počet obchodníků přijímajících bitcoiny stále omezený. Praktickou alternativou je proto používání dárkových karet.

Několik platforem, které nevyžadují postup KYC, nabízí možnost směnit bitcoiny za dárkové karty, které lze použít ve velkých obchodech. Mezi tyto platformy patří [CoinsBee](https://www.coinsbee.com/), [The Bitcoin Company](https://thebitcoincompany.com/) a [Bitrefill](https://www.bitrefill.com/). Tyto platformy výrazně usnadňují každodenní používání vašich bitcoinů tím, že vám umožňují přístup k široké škále produktů a služeb, aniž byste museli procházet konverzí fiat měny.

https://planb.network/tutorials/exchange/centralized/bitrefill-8c588412-1bfc-465b-9bca-e647a647fbc1
### Další způsoby akvizice

Mezi další způsoby, jak získat bitcoin a zároveň chránit své soukromí, patří samozřejmě těžba. Chcete-li začít těžit saty, nemusíte odhalovat svou totožnost; stačí najít platný doklad o zaměstnání a předložit jej síti. Pokud se rozhodnete pro společnou těžbu, některé pooly vyžadují určitou formu identifikace, například KYC, zatímco jiné ne.

Další metodou je práce výměnou za bitcoiny. Tento způsob získání může být atraktivní, ale míra požadované identifikace se značně liší v závislosti na okolnostech.

\Pro napsání této kapitoly jsem použil kurz BTC205, který vytvořil [@pivi\_\_](https://x.com/pivi___) na síti Plan ₿ (zatím je k dispozici pouze ve francouzštině).\_

## Konsolidace, řízení UTXO a CIOH

<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>

Jedním z nejsložitějších aspektů, které je třeba zvládnout, když máte vlastní portfolio samoobslužných skladů, je bezpochyby konsolidace. Měli byste konsolidovat? Jaký je její účel? Jaké velikosti UTXO byste se měli snažit dosáhnout? Jaké jsou kompromisy v oblasti ochrany osobních údajů? To se pokusíme prozkoumat v této části.

### Co je to konsolidace?

Fungování Bitcoinu se podobá aukčnímu trhu, kde těžaři upřednostňují transakce s nejlepšími poplatky. Každý blok má však maximální váhu, která omezuje počet transakcí, jež do něj mohou být zařazeny. Vzhledem k tomu, že blok vzniká v průměru každých 10 minut, je prostor, který je v každém bloku k dispozici, vzácným zdrojem.

Těžaři, jejichž podnikání je spojeno se značnými náklady na elektřinu, kapitál a údržbu, se přirozeně snaží maximalizovat svou ziskovost. Mají tendenci upřednostňovat transakce, které jim nabízejí nejvyšší poplatky v poměru k jejich váze.

Ve skutečnosti nemají všechny transakce s bitcoiny stejnou váhu. Ty s větším počtem vstupů a výstupů budou vážit více. Vezměme si například 2 transakce:


- Transakce A obsahuje 1 vstup a 1 výstup. Přiřazuje 1 994 sátů poplatků a její váha je 141 vB;
- Složitější transakce B se 2 vstupy a 2 výstupy přiděluje 2 640 sátů provizí pro váhu 220 vB.

Přestože v příkladu transakce B nabízí vyšší celkovou provizi, těžaři upřednostní transakci A, protože nabízí lepší poměr provize a váhy. Zde je výpočet pro každou transakci vyjádřený v satech na virtuální bajt (sat/vB):

```text
TXA: 1994 / 141 = 14 sat/vB
TXB: 2640 / 220 = 12 sat / vB
```

To znamená, že za každou jednotku váhy nabízí transakce A vyšší poplatky než transakce B, i když transakce B nabízí vyšší poplatky v absolutní hodnotě.

Proto je pro uživatele stále atraktivnější, aby při svých transakcích spotřebovávali co nejmenší množství vstupů. Pro uspokojení výstupní platby je však nutné spotřebovat dostatečné množství. Při správě svého portfolia je proto nutné mít dostatečně velké UTXO.

Principem konsolidace je právě využití období, kdy jsou poplatky za bitcoiny nízké, ke sloučení svých malých UTXO do jednoho většího UTXO. Když tedy poplatky na Bitcoinu rostou, lze provádět transakce s minimálním vstupem, a tedy utratit méně v absolutních poplatcích. Cílem je naplánovat povinné transakce, které se budou provádět v obdobích vysokých poplatků.

Kromě úspory transakčních poplatků pomáhá konsolidace UTXO zabránit vzniku "prachu" Prach označuje UTXO, jejichž hodnota v satech je tak nízká, že nestačí pokrýt transakční poplatky nutné k jejich utracení. Proto je ekonomicky neracionální tyto UTXO používat, dokud jsou transakční poplatky vysoké. Aktivním seskupováním UTXO zabráníte jejich přeměně v prach, čímž zajistíte, že všechny vaše prostředky zůstanou použitelné.

### Jaká je minimální velikost vašich UTXO?

Někdy se mě ptají, jaká je minimální doporučená hodnota pro UTXO. Bohužel neexistuje univerzální odpověď, protože záleží na vašich preferencích a podmínkách na trhu s provizemi. Zde je však vzorec, který vám může pomoci určit hranici, která vyhovuje vašim potřebám:

$$
\frac {P \times F}T = M
$$

Kde:


- $P$ je váha transakce;
- $F$ představuje maximální sazbu v satoshi za vbyte (sats/vB), kterou jste ochotni pokrýt;
- $T$ je procento transakčního poplatku, které jste ochotni zaplatit vzhledem k celkové hodnotě UTXO;
- $M$ je minimální částka v satoshi pro každé UTXO.

Za předpokladu, že chcete pokrýt provize za standardní SegWit transakce s 1 vstup a 2 výstupy, vážení 141 vB. Pokud pokryjete až 800 sátů/vB a jste ochotni utratit maximálně 12 % hodnoty UTXO na provizích, pak by výpočet vypadal takto:

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

V tomto příkladu by bylo rozumné udržovat minimální hodnotu 940 000 sat pro UTXO ve vašem portfoliu.

### Konsolidace a COIH

Jednou z nejpoužívanějších heuristik v analýze blockchainu je COIH (_Common Input Ownership Heuristic_), která umožňuje předpokládat, že všechny vstupy do bitcoinové transakce patří stejnému subjektu. Přesněji řečeno, princip konsolidace spočívá v tom, že se jako vstup spotřebuje několik UTXO a jako výstup se vytvoří jeden UTXO. Proto konsolidace umožňuje použití COIH.

![BTC204](assets/fr/097.webp)

V praxi to znamená, že vnější pozorovatel může usoudit, že všechny konsolidované UTXO pravděpodobně patří stejné osobě a že jí patří i jediný vygenerovaný výstup. Tato situace může ohrozit soukromí propojením různých transakčních historií. Řekněme například, že konsoliduji 3 UTXO získané v P2P s jedním UTXO získaným prostřednictvím platformy, která vyžaduje KYC:

![BTC204](assets/fr/098.webp)

Tímto způsobem může jakýkoli subjekt s přístupem k údajům burzovní platformy, potenciálně včetně vládních agentur, zjistit, že držím další částky v BTC. Dříve tyto UTXO nebyly přímo spojeny s mou identitou, nyní již ano. Navíc se tím všem zdrojům prozradí, že vlastním určité množství bitcoinů.

Při správě UTXO se tak ekonomické důvody, které tlačí na konsolidaci za účelem snížení poplatků, dostávají do rozporu se správnými postupy ochrany osobních údajů, které doporučují nikdy neslučovat UTXO. Volba mezi ekonomikou a ochranou soukromí tedy závisí na prioritách každého uživatele.

Pokud se můžete vyhnout konsolidaci při zachování značných velikostí UTXO, je to ideální. Za tímto účelem optimalizujte metody akvizice. Pokud nakupujete bitcoiny v DCA, snažte se své jednorázové nákupy co nejvíce rozprostřít, abyste seskupili hodnotu do menšího počtu UTXO. Bude snazší zvládnout jednorázový nákup ve výši 1 000 EUR každé dva měsíce než nákup ve výši 120 EUR každý týden. Tím minimalizujete počet generovaných UTXO a zjednodušíte správu svého portfolia při zachování svého soukromí.

Pokud potřebujete konsolidovat své bitcoiny, upřednostněte konsolidaci UTXO ze stejného zdroje. Například sloučení 10 UTXO z jedné platformy bude mít menší dopad na vaše soukromí než smíchání 5 UTXO z platformy A s 5 UTXO z platformy B. Pokud je konsolidace z různých zdrojů nevyhnutelná, snažte se je rozdělit podle jejich vlastností. Například seskupte UTXO získané prostřednictvím KYC do jedné transakce a UTXO získané v P2P do jiné.

V každém případě nezapomeňte, že jakákoli konsolidace nevyhnutelně vede ke ztrátě soukromí. Proto pečlivě zhodnoťte její potřebu a potenciální dopady na vaše soukromí s ohledem na rizika.

## Další osvědčené postupy

<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>

Pojďme společně prozkoumat některé další osvědčené postupy, které vám mohou pomoci optimalizovat vaše soukromí v Bitcoinu.

### Kompletní uzel

Mít své bitcoiny v osobní úschově je dobré, ale používat vlastní plný uzel je lepší! Proto je pro zcela suverénní používání bitcoinu zásadní mít vlastní uzel:


- Odpor proti cenzuře**: Vaše transakce nemůže nikdo zablokovat;
- Nezávislost na třetích stranách**: Při ověřování dat v blockchainu již nejste závislí na žádné externí službě;
- Aktivní účast**: Máte možnost nastavit si vlastní pravidla validace a přímo se podílet na konsensu;
- Příspěvek do sítě**: Provozováním uzlu pomáháte posilovat a šířit síť Bitcoin;
- Technické vzdělávání**: Spuštění celého uzlu je skvělý způsob, jak prohloubit své technické znalosti o Bitcoinu.

Kromě těchto výhod zlepšuje používání plného uzlu také vaše soukromí při přenosu transakcí. Když vydáváte transakci, je nejprve vytvořena a podepsána prostřednictvím vaší peněženky. Aby ji bylo možné přenést v síti Bitcoin, musí ji znát alespoň jeden uzel. Používáním vlastního uzlu tento přenos přímo řídíte, čímž zlepšujete své soukromí a omezujete riziko ztráty dat.

![BTC204](assets/fr/099.webp)

Pokud nemáte vlastní uzel bitcoinu, budete nuceni použít uzel třetí strany, například uzel nabízený poskytovatelem softwaru peněženky. Kromě přenosu transakcí vyžaduje peněženka přístup k různým informacím, jako jsou nevyřízené transakce, zůstatky spojené s vašimi adresami nebo počet potvrzení vašich transakcí. Pro přístup ke všem těmto údajům je třeba se dotázat uzlu.

![BTC204](assets/fr/100.webp)

Hlavním rizikem, když nepoužíváte svůj uzel Bitcoin, je, že provozovatel uzlu třetí strany může sledovat vaše aktivity v blockchainu, nebo dokonce tyto informace sdílet s jinými subjekty. Chcete-li toto riziko omezit, je přechodným řešením použití softwaru peněženky, který umožňuje maskovat připojení prostřednictvím sítě Tor. To může snížit odhalení vašich údajů. Optimálním řešením však zůstává mít vlastní uzel Bitcoinu a používat jej k přenosu svých transakcí. Samozřejmě budete muset také zajistit, aby z vašeho uzlu neunikaly žádné informace, ale to je další téma, kterému se budeme věnovat v následujících částech.

Kromě zřejmého přínosu pro vaše soukromí vám vlastní plnohodnotný uzel také zajistí pravdivost dat v blockchainu, ochrání vás před cenzurou a umožní vám aktivně se podílet na správě Bitcoinu. Používáním vlastního uzlu přispíváte svou ekonomickou vahou do vámi zvoleného blockchainu, což je důležité během konfliktů v komunitě, jako například během války o velikost bloku v letech 2015 až 2017. V případě forku by vás používání uzlu třetí strany mohlo vést k podpoře řetězce, který nechcete upřednostňovat, protože provozovatel uzlu rozhoduje za vás. Jak jistě chápete, z hlediska ochrany soukromí a obecnější suverenity jednotlivce je nezbytné provozovat a používat svůj vlastní plnohodnotný uzel!

### Klamavé analytické heuristiky

Obecněji řečeno, je důležité porozumět heuristikám, o kterých jsme hovořili v předchozí části, abychom se jim mohli lépe vyhnout nebo je oklamat. Přijetí řady osvědčených postupů se může ukázat jako přínosné, i když nejsou nezbytné. Nabízejí další vrstvu ochrany, která může být důležitá pro zachování dobrého soukromí při používání Bitcoinu.

První rada, kterou vám mohu dát, je, abyste se vmísili do nejhustšího davu. U Bitcoinu to znamená používat nejrozšířenější šablony skriptů. Například skripty P2WSH, které se často používají pro multisig konfigurace SegWit V0, jsou velmi vzácné. Neumožňují skrýt se ve velkém souboru anonymity. Totéž platí pro starší šablony, jako jsou P2PKH nebo P2SH. Přestože jsou v sadě UTXO hojně zastoupeny, pro nové transakce se používají stále méně.

Obecně je bezpečnější přejít na nejnovější standard písma, pokud je dostatečně přijat. Zatímco tedy v roce 2022 bych nedoporučoval používat P2TR (Taproot) kvůli jeho nízkému přijetí, v roce 2024 bych doporučoval zvolit tento typ skriptu, nebo v opačném případě skript SegWit V0, protože počet transakcí využívajících P2TR začíná představovat velmi významnou část.

Zdroj: [txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)

Dalším tipem pro ochranu soukromí je pokusit se obejít interní heuristiku transakcí. Například při platbě se můžete pokusit nevytvářet výstup se zaokrouhlenou částkou, protože by to mohlo signalizovat, že jiný výstup představuje změnu. Pokud máte kamarádovi poslat 100 tisíc satoshi, zvažte převod o něco vyšší částky, abyste této heuristice unikli. Stejně tak se snažte nevytvářet výstupy se zbytkem, které jsou v porovnání s provedenou platbou neúměrně vysoké, protože by to také mohlo prozradit, který z výstupů představuje zbytek.

A konečně, pokud provádíte transakce s bitcoiny pravidelně, ujistěte se, že je nepřevádíte vždy ve stejnou dobu. Rozložením přenosu vašich transakcí v průběhu dne a týdne zabráníte tomu, aby vnější pozorovatelé měli možnost zjistit časový vzorec na základě časových pásem, který by mohl zlepšit jejich analýzu.

Kromě všech těchto osvědčených postupů, které si můžete osvojit na denní bázi, existují ještě účinnější metody, jak zcela přerušit sledovatelnost vašich bitcoinů. Mezi ně patří samozřejmě transakce coinjoin, které si podrobně prozkoumáme v následující části.

# Porozumění transakcím Coinjoin

<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## Co je to transakce Coinjoin?

<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>

Po prostudování základů ochrany soukromí si nyní probereme sofistikovanější techniky zaměřené na aktivní ochranu vašeho soukromí, zejména disasociaci vaší bitcoinové historie. V příští části se budeme zabývat mnoha drobnými technikami, ale nejprve vám chci povědět o coinjoinu.

Coinjoin je často považován za nejúčinnější způsob ochrany soukromí uživatelů bitcoinu. Ale co přesně je transakce coinjoin? Pojďme to společně zjistit.

### Základní principy funkce Coinjoin

Coinjoin je technika, která narušuje sledování bitcoinů v blockchainu. Je založena na kolaborativní transakci se specifickou strukturou stejného jména: coinjoin transakce.

Jak jsme viděli v prvních částech tohoto školení, transakce na Bitcoinu jsou všem uživatelům známy prostřednictvím jejich uzlu. Je proto snadné ověřit řetězec elektronického podpisu každé mince a sledovat její historii. To znamená, že všichni uživatelé se mohou pokusit analyzovat transakce ostatních uživatelů. V důsledku toho je anonymita na úrovni transakcí nemožná. Na úrovni individuální identifikace je však anonymita zachována. Na rozdíl od tradičního bankovnictví, kde je každý účet spojen s osobní identitou, jsou v Bitcoinu finanční prostředky spojeny s dvojicemi kryptografických klíčů (nebo skriptů), což uživatelům nabízí určitou formu pseudonymity za kryptografickými identifikátory.

![BTC204](assets/it/51/01.webp)

Důvěrnost bitcoinů je tedy ohrožena, pokud jsou vnější pozorovatelé schopni spojit konkrétní UTXO s identifikovanými uživateli. Jakmile je toto spojení vytvořeno, je možné sledovat jejich transakce a analyzovat jejich bitcoinovou historii. Coinjoin je právě technika vyvinutá k narušení sledování UTXO s cílem zajistit určitou úroveň důvěrnosti uživatelů bitcoinu na úrovni transakcí.

Coinjoiny zvyšují důvěrnost uživatelů bitcoinu tím, že komplikují analýzu řetězce pro vnější pozorovatele. Jejich struktura umožňuje sloučit několik mincí od různých uživatelů do jediné transakce, čímž zamlžuje stopy a ztěžuje určení vazeb mezi vstupními a výstupními adresami.

Je důležité si uvědomit, že cílem transakce coinjoin je narušit historii mince. Na rozdíl od toho, co by si někdo mohl myslet, tato technika neposkytuje trvalou anonymitu ani trvale nezastavuje sledovatelnost bitcoinů. Cílem transakce coinjoin je pouze přerušit historii v okamžiku, kdy je transakce coinjoin provedena. Před touto transakcí i po ní však mince zůstává vystavena stejným rizikům ohrožujícím soukromí.

![BTC204](assets/fr/104.webp)

### Jak fungují koincidenční spoje?

Princip coinjoinu je založen na kolaborativním přístupu: několik uživatelů, kteří chtějí smíchat své bitcoiny, vloží stejné částky na vstupy stejné transakce. Tyto částky jsou pak přerozděleny na výstupech ve stejných hodnotách každému uživateli.

![BTC204](assets/fr/105.webp)

Na konci transakce je nemožné přiřadit konkrétní výstup ke známému uživatelskému vstupu. Mezi vstupy a výstupy neexistuje žádná přímá vazba, čímž se přeruší spojení mezi uživateli a jejich UTXO a také historie jednotlivých mincí.

![BTC204](assets/fr/106.webp)

Vezměme si příklad Alice. Ta chce poslat své sestře Evě k narozeninám asi 100 000 satoši (sats). Alice však nechce, aby Eva mohla sledovat historii jejích transakcí, protože nechce prozradit, kolik bitcoinů vlastní a jak je získala. Za tímto účelem se Alice rozhodne narušit svou historii UTXO transakcí coinjoin. Domluví se s Bobem, Charlesem, Davidem a Frankem, že provedou společnou transakci: Alice, Bob, Charles, David a Frank se každý zavazuje, že jako vstup pro transakci poskytne UTXO ve výši 105 000 sátů (s 5 000 sáty na poplatky za těžbu):

![BTC204](assets/fr/107.webp)


- Na oplátku za použití těchto vstupů každý z nich vygeneruje novou adresu a vytvoří pět identických výstupů po 100 000 satech. Každý účastník získá jeden výstup:

![BTC204](assets/fr/108.webp)


- Alice skončí s UTXO o 100 000 satech, jejichž historie je smíšená. Toto UTXO použije v nové transakci k odeslání částky Evě k narozeninám:

![BTC204](assets/fr/109.webp)


- Pokud se Eva pokusí tuto transakci analyzovat a získat z ní informace, narazí na transakci coinjoin, které se účastní Alice, Bob, Charles, David a Frank. Protože Eva nemůže kvůli jednotnosti částek rozlišit, komu jednotlivé vstupy patří, nemůže vysledovat historii Alicina UTXO ani určit, kolik bitcoinů její sestra vlastní a jak je získala:

![BTC204](assets/fr/110.webp)

V tomto scénáři Alice použila techniku coinjoin, aby zvýšila své soukromí proti zpětné analýze. Alice se tak vlastně chrání proti možné analýze ze strany Evy, která by začala od konkrétní transakce a sledovala historii UTXO zpětně. Tuto ochranu proti analýze ze současnosti do minulosti nazýváme retrospektivní anonset. Podrobněji se tímto konceptem budeme zabývat v posledních kapitolách této části.

Coinjoin však nabízí také možnost zlepšení ochrany soukromí proti analýze z minulosti do současnosti, tzv. prospektivní anonset. Vraťme se k našemu příkladu, kdy Alice poslala 98 000 sátů Evě v den jejích narozenin, ale vyměňme role. Představme si nyní, že je to Eva, kdo má obavy o své soukromí. Ve skutečnosti by Alice mohla být v pokušení sledovat minci, kterou poslala Evě, aby získala informace. Eva by mohla konsolidovat toto nově obdržené UTXO se všemi svými ostatními UTXO, což by mohlo Alici prozradit množství bitcoinů, které má ve své peněžence. Aby se tomu zabránilo, může Eve také narušit historii nově přijaté mince.


- Eve, Grace, Mallory, Oscar a Victor vložili do transakce s bitcoiny UTXO o hodnotě 98 000 sátů:

![BTC204](assets/fr/111.webp)


- Výměnou za použití těchto vstupů poskytne každý z nich novou adresu pro vytvoření 5 výstupů po 97 500 satech, které jsou si naprosto rovny. Každý uživatel získá jeden výstup:

![BTC204](assets/fr/112.webp)


- Eva má nyní UTXO 97 500 satelitů s přerušenou historií. Může ho bez obav používat pro budoucí transakce. Pokud se totiž Alice pokusí sledovat bitcoiny, které poslala Evě, narazí na transakci coinjoin. Nebude schopna určit, ke kterému výstupu UTXO Eve patří. Analýza se pak stává nemožnou:

![BTC204](assets/fr/113.webp)

V prvním příkladu jsme viděli, jak může coinjoin chránit soukromí mince ve vztahu k její minulosti, a ve druhém příkladu, jak může také zabezpečit historii mince ve vztahu k její budoucnosti. Proto jsem zmínil, že coinjoin je třeba vnímat jako jednorázovou událost, která rozděluje historii mince oběma směry:

![BTC204](assets/fr/104.webp)

### Míchání, koincidenční spoje, mixéry... Jaký je v tom rozdíl?

Pro označení coinjoins se někdy používá termín "mixování", který někteří bitcoináři odmítají, protože se obávají záměny s custodial mixers. Domnívám se však, že tato obava je neopodstatněná, protože v matematickém kontextu coinjoin přesně ztělesňuje pojem mixování.

V obecné matematice se mícháním rozumí vlastnost dynamického systému, kdy po určité době mohou být teoreticky všechny části počátečního prostoru smíchány s jakoukoli jinou částí. Míchání znamená, že poloha částice nebo stav systému se vyvíjí tak, že jeho budoucí rozložení je nezávislé na jeho počátečním rozložení, a dosahuje tak stavu, kdy jsou vlastnosti počátečního stavu rovnoměrně rozloženy v prostoru systému. Přesně to se děje při spojení mincí s bitcoiny. Podle mého názoru je tedy coinjoin skutečně metodou míchání mincí.

![BTC204](assets/fr/114.webp)

Je však důležité rozlišovat mezi koincidenčními spoji a směšovači. Mixér je služba, kam uživatelé posílají své bitcoiny, aby byly smíchány. Tyto služby byly populární v průběhu roku 2010, ale jejich používání pokleslo kvůli dvěma hlavním nevýhodám ve srovnání s coinjoinem:


- Vyžadují, aby se uživatelé během procesu míchání vzdali úschovy svých finančních prostředků, čímž se vystavují riziku krádeže;
- Neexistuje žádná záruka, že mixér nebude zaznamenávat podrobnosti o transakcích, nebo dokonce tyto informace prodávat společnostem zabývajícím se analýzou blockchainu.

![BTC204](assets/fr/115.webp)

Uživatelé proto dnes dávají přednost coinjoinu, protože jim umožňuje zachovat si plnou kontrolu nad svými prostředky v průběhu celého procesu. Účastníci coinjoinu neriskují, že jim bitcoiny ukradnou ostatní zúčastněné strany. V následující kapitole společně prozkoumáme, jak je to možné.

## Zerolink a Chaumian Coinjoins

<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>

Soukromí, které poskytuje coinjoin, je založeno na velikosti skupiny, ve které je náš kus skrytý. Proto je nutné najít co nejvíce účastníků. Je zcela možné spustit coinjoin ručně, s nezávisle nalezenými účastníky, ale tato metoda je složitá a neumožňuje velké anonsety.

To je důvod, proč se na Bitcoinu vyvinuli koordinátoři coinjoin. Jejich úkolem je propojovat různé uživatele a předávat informace nezbytné pro úspěšné dokončení společné transakce.

![BTC204](assets/fr/116.webp)

Jak ale zajistit, aby koordinátor nikdy neměl kontrolu nad bitcoiny uživatelů, a přestože je osobou, která transakci coinjoin vytváří, jak zajistit, aby nemohl propojit vstupy a výstupy uživatelů, což by mohlo znamenat ztrátu soukromí?

### Chaumovy slepé podpisy

Moderní implementace coinjoinu používají slepé podpisy Davida Chauma, které zabraňují úniku informací. Pojďme společně rychle prostudovat, jak tyto slepé podpisy fungují.

Chaumovy slepé podpisy jsou formou digitálního podpisu, při níž vydavatel podpisu nezná obsah zprávy, kterou podepisuje. Podpis však lze později ověřit pomocí původní zprávy. Tuto techniku vyvinul v roce 1983 kryptograf David Chaum.

Vezměme si příklad společnosti, která chce ověřit důvěrný dokument, například smlouvu, aniž by prozradila jeho obsah. Společnost použije proces maskování, který kryptograficky transformuje původní dokument reverzibilním způsobem. Takto upravený dokument je zaslán certifikační autoritě, která použije slepý podpis, aniž by znala základní obsah. Po obdržení podepsaného dokumentu společnost odstraní maskování z podpisu. Výsledkem je původní dokument ověřený podpisem autority, aniž by autorita kdy viděla původní obsah.

Chaumovy slepé podpisy tak umožňují ověřit pravost dokumentu bez znalosti jeho obsahu, čímž je zajištěna jak důvěrnost dat uživatele, tak integrita podepsaného dokumentu.

### Chaumian Coinjoins

V "Chaumian CoinJoins" se kombinuje použití sítě Tor a slepých podpisů Davida Chauma, aby se zajistilo, že koordinátor nemůže vědět, kterému uživateli patří který výstup. Proces konstrukce transakcí coinjoin se skládá ze tří hlavních kroků: registrace vstupu, registrace výstupu a podepsání transakce. Prozkoumejme tento proces na příkladu Alice, jednoho z účastníků coinjoinu. Všichni ostatní účastníci postupují stejně jako Alice, každý sám za sebe.

**Krok 1: Registrace vstupů.**


- Alice pošle koordinátorovi adresu UTXO, kterou chce použít jako vstup pro transakci, a také maskovanou přijímací adresu, kterou chce použít jako výstup pro příjem svých bitcoinů. Koordinátor tedy nemůže znát Alicinu adresu. Vidí pouze její maskovanou verzi.
- Koordinátor ověří platnost vstupů a poté podepíše Alicinu maskovanou adresu jejím soukromým klíčem. Poté zašle Alici slepý podpis.

**Krok 2: Nahrávání výstupů.**


- Alice nyní může odstranit maškarádu ze své adresy podepsané soukromým klíčem koordinátora. Naváže nové spojení pod jinou identitou Tor. Koordinátor nemůže identifikovat, že se pod touto novou identitou připojuje Alice.
- Alice pošle nezakrytou adresu a podpis koordinátorovi (který stále neví, že se jedná o Alici).

**Krok 3: Podepsání transakce.**


- Koordinátor podobně získává nemaskované výstupy od všech účastníků. Pomocí přidružených podpisů může ověřit, že každý anonymně odeslaný výstup byl skutečně dříve podepsán jeho soukromým klíčem, čímž je zajištěna jeho legitimita. Poté je připraven zkonstruovat transakci coinjoin a zašle ji účastníkům k podpisu.
- Alice, stejně jako ostatní účastníci, ověřuje, zda jsou její vstup a výstup správně zahrnuty do transakce sestavené koordinátorem. Pokud je vše vyhovující, odešle koordinátorovi podpis, který odemkne skript jejího vstupu.
- Po shromáždění podpisů od všech účastníků coinjoinu může koordinátor transakci přenést přes síť Bitcoin, aby mohla být přidána do bloku.

V tomto systému není koordinátor schopen propojit vstup s konkrétním výstupem. Kromě toho se nemůže zmocnit prostředků účastníků, protože nikdy nemá přístup k soukromým klíčům potřebným k odemčení jejich UTXO. V průběhu celého procesu až do konce kroku 3 nemá ani přístup k podpisům. Když Alice a ostatní účastníci podepíší globální transakci, po ověření, že je vše v pořádku, koordinátor již nemůže tuto transakci včetně výstupů měnit, aniž by ji zneplatnil. Tím je zabráněno krádeži bitcoinů koordinátorem.

Když uživatel coinjoinu nakonec zaregistruje svůj výstup v transakci, chce mít podobné záruky jako občan hlasující ve volbách. Mezi veřejným a soukromým aspektem těchto akcí existuje dualita. Na jedné straně je to, co chcete udržet soukromé: volič nechce, aby jeho hlasovací lístek byl spojen s jeho identitou; uživatel coinjoinu nechce, aby jeho výstup byl spojen s jeho vstupem. Pokud se totiž koordinátorovi nebo jiné straně podaří vytvořit spojení mezi vstupem a výstupem, coinjoin ztrácí celý svůj smysl. Jak bylo vysvětleno dříve, coinjoin musí fungovat jako přerušení historie mince. Tato pauza nastává právě z důvodu nemožnosti spojit konkrétní vstup s konkrétním výstupem v transakci coinjoin (prospektivní anonset) a naopak (retrospektivní anonset).

Na druhé straně je tu veřejný aspekt: volič se chce ujistit, že jeho hlasovací lístek je zahrnut do volební urny; podobně uživatel coinjoinu se chce ujistit, že jeho výstup je zahrnut do transakce coinjoinu. Ve skutečnosti je naprosto nezbytné, aby účastníci coinjoinu mohli před podpisem transakce ověřit přítomnost svého výstupu, jinak by koordinátor mohl prostředky ukrást.

Právě tyto dva veřejné a soukromé aspekty, umožněné použitím slepých podpisů Davida Chauma, zajišťují účastníkům Chaumova coinjoinu, že jejich bitcoiny nebudou ukradeny a že jejich prostředky nebude možné vystopovat.

### Kdo vymyslel pojem coinjoin?

Je těžké s jistotou určit, kdo jako první představil myšlenku coinjoinu u Bitcoinu a kdo přišel s nápadem použít v této souvislosti slepé podpisy Davida Chauma. Často se má za to, že to byl Gregory Maxwell, kdo se o ní poprvé zmínil v [příspěvku na BitcoinTalk v roce 2013](https://bitcointalk.org/index.php?topic=279249.0):

Použití Chaumových slepých podpisů: Uživatelé se připojí a poskytnou vstupní údaje (a adresy pro ostatní) a kryptograficky zastřenou verzi adresy, na kterou chtějí poslat své soukromé mince; server tokeny podepíše a vrátí je uživatelům. Uživatelé se znovu anonymně připojí, odhalí své výstupní adresy a pošlou je zpět serveru. Server vidí, že všechny výstupy byly jím podepsány a že v důsledku toho jsou všechny výstupy od platných účastníků. Později se lidé znovu připojí a podepíší.

Maxwell, G. (2013, 22. srpna). _CoinJoin: Bitcoin: soukromí pro reálný svět_. Fórum BitcoinTalk. https://bitcointalk.org/index.php?topic=279249.0

Nicméně již dříve byly zmíněny obě Chaumovy signatury v kontextu míchání a koincidencí. [V červnu 2011 představil Duncan Townsend na BitcoinTalk](https://bitcointalk.org/index.php?topic=12751.0) mixér, který používá Chaumovy signatury způsobem dosti podobným moderním chaumovským coinjoins.

Ve stejném vlákně je [zpráva o hashcoinech v reakci na Duncana Townsenda](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793), která má zlepšit jeho mixér. Postup popsaný v této zprávě představuje právě to, co je coinjoins nejbližší. Podobný systém je zmíněn také ve [zprávě od Alexe Mizrahiho z roku 2012](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry), protože radil tvůrcům Tenebrixu, jednoho z prvních altcoinů, který později posloužil jako základ pro vznik Litecoinu. Ani samotný termín "coinjoin" nevymyslel Greg Maxwell, ale pochází z nápadu Petera Todda.

![BTC204](assets/fr/125.webp)

### Zerolink

Zerolink je komplexní směšovací protokol, který integruje Chaumiani coinjoins a různé strategie na ochranu anonymity uživatelů proti různým formám analýzy řetězců, čímž výrazně snižuje chyby spojené se správou peněženek. Tento protokol [představili nopara73 a TDevD v roce 2017](https://github.com/nopara73/ZeroLink/blob/master/README.md).

![BTC204](assets/fr/126.webp)

Jak už název napovídá, principem Zerolink je provádění transakcí coinjoin, které zajišťují, že vazby mezi vstupy a výstupy nelze vysledovat. Této funkce je dosaženo tím, že je zajištěno, že všechny výstupy mají naprosto identické částky.

![BTC204](assets/fr/127.webp)

Důležité preventivní opatření společnosti Zerolink spočívá v úplném oddělení nesmíšených UTXO od smíšených UTXO pomocí samostatných sad kryptografických klíčů nebo dokonce samostatných peněženek. Tímto způsobem se odlišuje peněženka "pre-mix", určená pro mince před smícháním, od peněženky "post-mix", vyhrazené pro mince, které byly smíchány.

![BTC204](assets/fr/128.webp)

Toto přísné oddělení UTXO slouží především k tomu, aby se zabránilo náhodnému spojení smíšeného a nesmíšeného UTXO. Pokud totiž k takovým spojením dojde, účinnost coinjoinu na smíšeném UTXO je bez vědomí uživatele zrušena, čímž je ohrožena důvěrnost UTXO, jehož historie byla považována za porušenou. Tyto vazby mohou vzniknout buď opětovným použitím adresy pro zabezpečení smíšeného UTXO s nesmíšeným, nebo použitím heuristiky společného vlastnictví vstupu (CIOH), pokud uživatel spotřebuje smíšené a nesmíšené UTXO jako vstupy téže transakce. Oddělením portfolií před smícháním a po smíšení se těmto náhodným asociacím zabrání a uživatel je chráněn před neúmyslnými chybami.

![BTC204](assets/fr/129.webp)

Toto oddělení také nabízí možnost uplatnit odlišná pravidla pro portfolia před smícháním a po smíšení na úrovni portfoliového softwaru. Například v postmixovém portfoliu může software zakázat slučování vstupních UTXO, aby se zabránilo použití CIOH, které by ohrozilo anonset uživatele. Je také možné standardizovat používání skriptů a transakčních možností (jako je například signalizace RBF), aby se zabránilo identifikaci pomocí otisků peněženky.

V současné době je Whirlpool jedinou implementací coinjoinu, která striktně dodržuje protokol Zerolink. V následující kapitole se budeme zabývat různými existujícími implementacemi coinjoin a výhodami a nevýhodami každé z nich.

## Implementace funkce Coinjoin

<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>

_V roce 2024 dojde k významným změnám v nástrojích, které budou mít uživatelé, kteří chtějí na Bitcoinu provozovat coinjoiny, k dispozici. V současné době se nacházíme v klíčovém období a trh s coinjoiny prochází zásadní restrukturalizací. Proto bude tato kapitola v průběhu času pravděpodobně aktualizována._

Prozatím existují hlavně 3 různé implementace coinjoinu v Bitcoinu:


- Whirlpool;
- Wabisabi;
- JoinMarket.

Cílem každé z těchto implementací je prolomit historii UTXO prostřednictvím transakcí coinjoin. Jejich mechanismy se však výrazně liší. Proto je nezbytné pochopit, jak každá z nich funguje, abyste si mohli vybrat možnost, která nejlépe vyhovuje vašim potřebám.

### JoinMarket

Služba JoinMarket, kterou v roce 2015 vytvořili Adam Gibson a Chris Belcher, se od ostatních implementací coinjoinu liší svým jedinečným modelem párování uživatelů. Tento systém je založen na výměnném trhu P2P, kde někteří uživatelé, "tvůrci", dávají k dispozici své bitcoiny k míchání, zatímco jiní, "příjemci", používají tyto prostředky k provádění coinjoinů výměnou za poplatek.

![BTC204](assets/fr/130.webp)

V tomto modelu "tvůrci" nechávají své bitcoiny k dispozici "příjemcům" a výměnou za své služby dostávají poplatky. "Takers" na druhé straně platí za použití bitcoinů "makers" k provádění vlastních transakcí coinjoin. Poplatky za služby se liší podle role: "tvůrci" kumulují poplatky za svou nabídku likvidity, zatímco "takers" platí provize. Toto tržiště funguje volně bez podmínek použití.

Hlavní nevýhodou JoinMarketu je jeho složité používání, které vyžaduje určitou znalost terminálů, aby bylo možné jej efektivně využívat. Ačkoli tato složitost není pro zkušeného uživatele překážkou, může omezit přístup široké veřejnosti. Nedávné zavedení webového rozhraní nazvaného JAM však jeho používání poněkud usnadnilo.

![BTC204](assets/fr/131.webp)

Zdroj: [JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

Hlavní překážkou však zůstává technická bariéra. V ekosystému coinjoin, kde je důvěrnost posílena počtem účastníků, má jakékoli omezení, které snižuje dostupnost, přímý vliv na dostupnou likviditu, která je rozhodujícím faktorem účinnosti míchání. Bitcoin, který již představuje niku v oblasti finančních transakcí, považuje využívání coinjoinů za dílčí nišu a JoinMarket představuje ještě specializovanější frakci, čímž omezuje svůj potenciál zvyšovat anonce svých uživatelů.

I přes svůj inovativní model P2P párování pro coinjoiny má JoinMarket některé významné nevýhody, zejména pokud jde o transakční strukturu. Na rozdíl od jiných implementací, jako je Whirlpool, JoinMarket nezaručuje dokonalou rovnost mezi výstupy a mezi vstupy a výstupy mohou být vytvořeny deterministické vazby. Chybí mu také nástroje, které by zabránily opětovnému smíchání již smíchaných mincí, což by mohlo ohrozit důvěrnost, o kterou uživatelé usilují. A konečně, ačkoli je koncept JoinMarketu atraktivní, zejména pro zájemce o dynamický trh s likviditou, jeho strukturální nedostatky a technická složitost jej podle mého názoru činí méně atraktivním, a to jak pro nováčky, tak pro odborníky, kteří hledají implementaci coinjoinu.

### Wabisabi

Wabisabi je další implementací coinjoinu s přístupem, který centralizuje koordinaci transakcí. Tento model navrhli Ádám Ficsór (nopara73), Yuval Kogman, Lucas Ontivero a István András Seres v roce 2021 a v následujícím roce byl integrován do softwaru Wasabi 2.0. Wabisabi přesně představuje evoluci modelu coinjoin softwaru Wasabi, který byl spuštěn v roce 2018.

Koncem roku 2010 přijala společnost Wasabi transakční strukturu pro svá coinjoins, která se zásadně lišila od struktury společnosti Whirlpool. Aby zvýšila počet anonsetů svých účastníků, používala společnost Wasabi velmi rozsáhlé transakce coinjoin, které sdružovaly desítky účastníků. Naproti tomu Whirlpool se rozhodl pro více malých transakcí, což umožnilo exponenciální nárůst anonsetů s každým cyklem.

Obě implementace se liší také metodami zpracování zbytku. U Whirlpoolu byl zbytek vyloučen a izolován od UTXO před cykly coinjoin pomocí TX0, což je koncept, který dále vysvětlím v další kapitole. U Wasabi naopak zbytek tvořil jeden z výstupů transakce coinjoin, čímž se zachovaly deterministické vazby mezi některými vstupy a výstupy.

Wasabi ve verzi 2.0 upravil svůj přístup ke koincidencím tak, aby se přiblížil přístupu Whirlpoolu. Přestože transakce coinjoin zůstávají velmi rozsáhlé, je nyní možné řetězit několik po sobě jdoucích kol, a tak následovat model Whirlpool. Zvláštní úsilí bylo věnováno také správě drobných: na rozdíl od verze Wasabi 1.0, kde byly drobné přímo vázány na vstup uživatele, se Wabisabi snaží rozdělit drobné na několik malých částek, které jsou rozděleny ve stejných hodnotách pro všechny účastníky.

To si ukážeme na zjednodušeném příkladu, který zahrnuje pouze 2 uživatele: Alice chce smíchat 115 000 satelitů a Bob 210 000 satelitů. Pomineme-li provize, s Wasabi 1.0 by transakce coinjoin vygenerovala 3 výstupy po 100 000 satech plus 1 zbytek po 15 000 satech pro Alici a 1 zbytek po 10 000 satech pro Boba. Zbytkové výstupy by byly vždy spojeny se vstupy:

Podle Wabisabi by stejná transakce vytvořila 3 výstupy po 100 000 satech a 5 výstupů po 5 000 satech, čímž by se zbytek rozptýlil tak, že by nebyl přímo sledovatelný s konkrétním vstupem:

Osobně se domnívám, že řízení změn ve Wabisabi představuje několik rizik, která by mohla ohrozit jeho účinnost z hlediska ochrany osobních údajů:


- Pokud uživatel přispěje UTXO výrazně větším množstvím než ostatní účastníci, nevyhnutelně skončí s množstvím změn, které bude spojeno s jeho vstupem. To je v rozporu s původním cílem protokolu, jehož cílem je eliminovat jakoukoli identifikovatelnou změnu;
- Znásobení označení za účelem fragmentace zbytku může paradoxně poškodit účinnost míchání. Tento proces může vést ke snížení počtu anonsetů pro určité výstupy, protože se stávají snadněji identifikovatelnými;
- Tato metoda také generuje UTXO s nízkou hodnotou, které pro uživatele představují problém při správě. Tyto malé UTXO, pokud se stanou příliš drahými na to, aby byly vynaloženy v poměru ke své hodnotě, se mohou stát "prachem" Tento jev přiměje uživatele, aby v budoucích transakcích sloučil několik vstupních UTXO nebo je konsolidoval. V obou případech to může vzhledem k COH snížit získané anonce nebo zcela zrušit výhody pro soukromí získané z počátečního spojení mincí.

Na rozdíl od společnosti Whirlpool, která uplatňuje protokol ZeroLink tím, že zajišťuje přísnou segregaci mezi UTXO před smícháním a po smíšení, společnost Wabisabi tuto přísnou segregaci nedodržuje. Objevily se také problémy s opakovaným používáním adres některými zákazníky společnosti Wasabi, což je samozřejmě pro uživatele velmi škodlivé.

Ve verzi 2.0 systému Wasabi byla zavedena nová cenová politika coinjoin. Nyní jsou poplatky koordinátora stanoveny na 0,3 % pro UTXO větší než 0,01 bitcoinu, zatímco pro menší UTXO jsou tyto poplatky zcela nulové. Kromě toho jsou remixy pro tyto menší UTXO zdarma, ačkoli poplatky za těžbu zůstávají pro všechny transakce, včetně remixů.

Tato politika je v kontrastu s politikou společnosti Whirlpool, kde provize zůstávají pevné bez ohledu na velikost získaných anonsetů. V případě Wasabi 2.0 jsou sice provize koordinátora u malých UTXO resetovány na nulu, ale uživatel musí stále platit těžební provize ze všech transakcí, včetně remixů.

V době psaní tohoto článku se používání Wabisabi v důsledku nedávných událostí značně zkomplikovalo. Po zatčení zakladatelů peněženky Samourai totiž společnost zkSNACKs, která financuje a řídí vývoj Wasabi, oznámila ukončení služby koordinace coinjoin k 1. červnu 2024. Tento koordinátor, který byl nastaven jako výchozí pro Wasabi, měl drtivou většinu likvidity.

Po zrušení tohoto hlavního koordinátora se nyní uživatelé musí připojit k novým nezávislým koordinátorům. Tato změna vyvolává obavy: na jedné straně noví koordinátoři nemusí mít dostatečnou likviditu, čímž se snižuje účinnost coinjoins z hlediska ochrany soukromí. Na druhé straně existuje riziko, že se setkáme se zlomyslným koordinátorem. Tato situace přináší významná nová rizika pro ty, kteří chtějí Wabisabi používat.

Kromě technických problémů vyvolává rozhodnutí společnosti zkSNACKs, která stojí za Wasabi, využít služeb blockchainové analytické společnosti k filtrování účastníků coinjoins vážné etické a strategické otázky. Původní myšlenkou bylo zabránit využívání coinjoins na Wasabi zločinci, což se může zdát jako legitimní krok. Vyvolává však paradox: platit poplatky koordinátorovi, jehož hlavním posláním je zvýšit soukromí uživatelů, jen proto, aby se následně financovala společnost, jejímž cílem je ohrozit totéž soukromí.

Ještě znepokojivější je princip filtrování, který je v příkrém rozporu s filozofií Bitcoinu, podle níž má být finanční systém otevřený a bez cenzury. Ačkoli se může zdát oprávněné chtít vyloučit trestnou činnost, toto filtrování by se mohlo zaměřit i na osoby, jejichž jednání, ačkoli je v některých souvislostech klasifikováno jako nezákonné, může být morálně ospravedlnitelné nebo společensky prospěšné. Tuto dichotomii dokonale ilustruje příklad Edwarda Snowdena: některé vlády ho za jeho odhalení považují za zločince, jiné ho vnímají jako whistleblowera, který jednal ve veřejném zájmu. Tato složitost podtrhuje potenciální nebezpečí filtrování, které sice začíná s dobrým úmyslem, ale v konečném důsledku může poškodit práva a bezpečnost legitimních uživatelů. Mohl jsem také zmínit pronásledované aktivisty a novináře v některých autoritářských režimech. Jak jste možná uhodli, nepochybně dávám přednost modelu Whirlpool pro provádění coinjoins na Bitcoinu. Tento systém vyniká svou přísností a nabízí vynikající záruky z hlediska ochrany soukromí. Je také jediným, který navrhuje směšování, jež je v matematickém kontextu považováno za dokonalé. Podle mého názoru tento model představuje budoucnost coinjoins na Bitcoinu. Vyzývám vás proto, abyste se tímto modelem podrobněji zabývali v následující kapitole.

## Provoz společnosti Whirlpool

<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>

Whirlpool se od ostatních metod coinjoin liší tím, že používá transakce "_ZeroLink_", které zajišťují, že mezi všemi vstupy a výstupy není technicky možné žádné spojení. Tohoto dokonalého promíchání je dosaženo díky struktuře, v níž každý účastník přispívá stejnou částkou na vstupu (s výjimkou poplatků za těžbu), čímž vznikají výstupy v naprosto stejné výši.

Tento omezující přístup ke vstupům dává transakcím coinjoin společnosti Whirlpool jedinečnou vlastnost: naprostou absenci deterministických vazeb mezi vstupy a výstupy. Jinými slovy, každý výstup má stejnou pravděpodobnost, že bude přiřazen kterémukoli účastníkovi, ve vztahu ke všem ostatním výstupům v transakci.

![BTC204](assets/fr/136.webp)

### Obecné fungování společnosti Whirlpool

Zpočátku byl počet účastníků v každém coinjoinu Whirlpool omezen na 5, přičemž 2 účastníci byli noví a 3 remixéři (tyto pojmy vysvětlíme později). Zvýšení poplatků za transakce v řetězci pozorované v roce 2023 však přimělo Samouraiovy týmy k přehodnocení modelu s cílem zlepšit soukromí a zároveň snížit náklady. S ohledem na situaci na trhu s provizemi a počet účastníků tak nyní koordinátor může organizovat coinjoiny, které zahrnují 6, 7 nebo 8 účastníků. Tato vylepšená sezení jsou označena názvem "_Surge Cycles_" Je důležité poznamenat, že bez ohledu na konfiguraci jsou v coinjoinech Whirlpool vždy pouze 2 noví účastníci.

Transakce Whirlpool se tedy vyznačují stejným počtem vstupů a výstupů, které mohou být:


- 5 vstupů a 5 výstupů;

![BTC204](assets/fr/137.webp)


- 6 vstupů a 6 výstupů;

![BTC204](assets/fr/138.webp)


- 7 vstupů a 7 výstupů;

![BTC204](assets/fr/139.webp)


- 8 vstupů a 8 výstupů.

![BTC204](assets/fr/140.webp)

Model navrhovaný společností Whirlpool je tedy založen na malých transakcích coinjoin. Na rozdíl od Wabisabi a JoinMarket, kde je robustnost anonsetů založena na objemu účastníků v jednom cyklu (nebo několika málo cyklech), Whirlpool spoléhá na konkatenaci více malých cyklů. V tomto modelu vznikají uživatelům náklady pouze při jejich prvním vstupu do poolu, což jim umožňuje účastnit se mnoha remixů bez dalších nákladů. Právě noví účastníci hradí náklady na těžbu remixérům.

S každým dalším coinjoinem, kterého se mince účastní spolu se svými vrstevníky, s nimiž se setkala v minulosti, bude počet anonsetů exponenciálně růst. Cílem je tedy využít těchto volných remixů, které s každým výskytem pomáhají posilovat hustotu anonsetů spojených s jednotlivými mixy mincí.

Společnost Whirlpool byla navržena s ohledem na dva důležité požadavky:


- Dostupnost implementace na mobilních zařízeních, protože Samourai Wallet je primárně aplikace pro chytré telefony;
- Rychlost remixování cyklů podporuje výrazné zvýšení počtu anonsetů.

Těmito požadavky se řídili vývojáři peněženky Samourai při navrhování programu Whirlpool, což je vedlo k omezení počtu účastníků v jednom cyklu. Příliš malý počet účastníků by ohrozil efektivitu coinjoinu a drasticky snížil počet anonsetů vygenerovaných v každém cyklu, zatímco příliš velký počet účastníků by způsobil problémy se správou mobilních aplikací a ztížil by průběh cyklů.

Nakonec není nutné mít vysoký počet účastníků pro coinjoin na Whirlpoolu, protože anonsety se realizují na základě kumulace několika coinjoin cyklů. Nejdůležitějším principem je zde homogenita UTXO všech účastníků, protože to umožňuje dokonalý mix, a tedy plně využít cyklů míchání a remixování.

### Spojení bazénů a sazeb

Aby tyto vícenásobné cykly účinně zvýšily anonce smíšených mincí, je třeba stanovit určitý rámec pro omezení množství použitého UTXO. Whirlpool proto definuje několik poolů.

Pool představuje skupinu uživatelů, kteří se chtějí smíchat a kteří se dohodnou na množství UTXO, které bude použito k optimalizaci procesu spojování mincí při zachování dokonalé homogenity mincí. Každý pool určuje pevnou částku za UTXO, kterou musí uživatel splnit, aby se mohl zúčastnit. Chcete-li tedy provádět coinjoiny s Whirlpoolem, je třeba vybrat pool. V současné době jsou k dispozici následující pooly:


- 0.5 bitcoinů;
- 0.05 bitcoin;
- 0.01 bitcoin;
- 0.001 bitcoin (= 100 000 sats).

Když se se svými bitcoiny připojíte k poolu, budou rozděleny tak, aby generovaly UTXO dokonale homogenní s UTXO ostatních účastníků poolu. Každý pool má svůj maximální limit; proto u částek, které tento limit přesahují, budete nuceni buď provést dva samostatné vstupy do téhož poolu, nebo se obrátit na jiný pool s větší částkou:

| Pool (bitcoin) | Maximální částka za položku (bitcoin) |

|----------------|----------------------------------------|

| 0,5 | 35 |

| 0,05 | 3,5 |

| 0,01 | 0,7 |

| 0,001 | 0,025 |

UTXO je považováno za součást fondu, když je připraveno k začlenění do coinjoinu. To však neznamená, že uživatel ztrácí jeho vlastnictví. Jak jsme viděli v prvních kapitolách tohoto dílu, prostřednictvím různých cyklů míchání si zachováváte plnou kontrolu nad svými klíči a následně i nad svými bitcoiny. Tím se technika coinjoin liší od ostatních centralizovaných technik míchání.

Chcete-li se připojit k poolu coinjoin, je třeba zaplatit poplatky za služby i za těžbu. Servisní poplatky jsou pro každý pool pevně stanoveny a jejich účelem je kompenzovat týmy odpovědné za vývoj a údržbu Whirlpoolu.

Poplatky za služby při použití bazénu Whirlpool se platí jednorázově při vstupu do bazénu. Po dokončení tohoto kroku máte možnost účastnit se neomezeného počtu remixů bez dalších poplatků. Zde jsou uvedeny aktuální fixní poplatky pro jednotlivé bazény:

| Pool (Bitcoin) | Vstupní poplatek (Bitcoin) |

| -------------- | --------------------------------- |

| 0.5 | 0.0175 |

| 0.05 | 0.00175 |

| 0,01 | 0,0005 (50 000 satelitů) |

| 0,001 | 0,00005 (5 000 satelitů) |

Tyto poplatky v podstatě fungují jako vstupenka do vybraného bazénu bez ohledu na částku, kterou do coinjoinu vložíte. Ať už tedy vstoupíte do poolu s 0,01 BTC přesně s 0,01 BTC, nebo vstoupíte s 0,5 BTC, poplatky zůstanou v absolutní hodnotě stejné.

Před zahájením spojování Whirlpool má uživatel na výběr ze dvou strategií:


- Zvolí si menší fond, aby minimalizovali poplatky za služby, protože vědí, že za to dostanou několik menších UTXO;
- Nebo dáte přednost většímu fondu a souhlasíte s tím, že zaplatíte vyšší poplatky, abyste nakonec získali malý počet UTXO s vyšší hodnotou.

Obecně se nedoporučuje slučovat několik smíšených UTXO po cyklech coinjoin, protože by to mohlo ohrozit získané soukromí, zejména kvůli heuristice společného vlastnictví vstupu (CIOH: _Common-Input-Ownership-Heuristic_). Proto by mohlo být rozumné zvolit větší pool, i kdyby to znamenalo zaplatit více, aby se zabránilo tomu, že na výstupu bude příliš mnoho UTXO s malou hodnotou. Uživatel musí tyto kompromisy vyhodnotit a vybrat si fond, který preferuje.

Kromě poplatků za služby je třeba vzít v úvahu také poplatky za těžbu, které jsou neodmyslitelnou součástí každé transakce s bitcoiny. Jako uživatel Whirlpool budete muset zaplatit poplatky za těžbu za přípravnou transakci (`Tx0`) i za první připojení mince. Všechna další remixování budou díky modelu Whirlpool, kdy se novým účastníkům platí, zdarma.

Ve skutečnosti jsou v každém spojení Whirlpool 2 uživatelé mezi vstupy novými účastníky. Ostatní vstupy pocházejí od remixérů. V důsledku toho jsou poplatky za těžbu pro všechny účastníky transakce hrazeny těmito 2 novými účastníky, kteří pak také budou mít prospěch z bezplatných remixů:

![BTC204](assets/it/54/07.webp)

Díky tomuto systému poplatků se Whirlpool skutečně liší od ostatních implementací coinjoinu, protože anonce UTXO nejsou úměrné ceně zaplacené uživatelem. Značně vysoké úrovně anonymity tak lze dosáhnout zaplacením pouze vstupního poplatku do poolu a poplatků za těžbu 2 transakcí (`Tx0` a počáteční mix).

Je důležité si uvědomit, že uživatel bude muset uhradit také poplatky za těžbu UTXO, které si z poolu vybere po provedení více coinjoinů, pokud si ovšem nezvolí možnost `mix to`, která mu umožní zadat externí adresu, na kterou budou prostředky přímo převedeny jako výstup z coinjoinu, bez dalších transakcí.

### Účty HD Wallet

Aby bylo možné provést spojení mincí prostřednictvím služby Whirlpool, musí peněženka vygenerovat několik samostatných účtů. To je princip protokolu ZeroLink. Účet v kontextu HD (_Hierarchical Deterministic_) peněženky představuje část zcela izolovanou od ostatních, k tomuto oddělení dochází na třetí úrovni hloubky hierarchie peněženky, tj. na úrovni `xpub`.

![BTC204](assets/it/54/08.webp)

Z peněženky HD lze teoreticky odvodit až `2^(32/2)` různých účtů. Počáteční účet, který se ve výchozím nastavení používá ve všech bitcoinových peněženkách, odpovídá indexu `0`.

U portfolií upravených pro Whirlpool se používají 4 účty, které splňují požadavky procesu ZeroLink:


- **Vkladový účet**, označený indexem `0`;
- **Špatný bankovní účet** (neboli "toxická burza"), označený indexem `2 147 483 644`;
- Účet **premix** označený indexem `2 147 483 645`;
- Účet **postmix** označený indexem `2 147 483 646`.

Každý z těchto účtů plní v procesu spojování určitou funkci, kterou se budeme zabývat v následujících částech.

Všechny tyto účty jsou propojeny s jediným seedem, což uživateli umožňuje obnovit přístup ke všem svým bitcoinům pomocí obnovovací fráze a v případě potřeby i hesla. Při této operaci obnovy je však nutné softwaru zadat různé indexy účtů, které byly použity.

Prozkoumejme nyní jednotlivé fáze spojení Whirlpool v rámci těchto účtů.

### TX0

Výchozím bodem každého připojení k mincím Whirlpool je **vkladový účet**. Tento účet automaticky použijete při vytvoření nové bitcoinové peněženky. Na tento účet musí být připsány bitcoiny, které chcete smíchat.

Hodnota `Tx0` představuje první krok v procesu míchání Whirlpool. Jeho cílem je připravit a vyrovnat UTXO pro coinjoin, rozdělit je na jednotky odpovídající množství vybraného poolu, aby byla zajištěna homogenita míchání. Vyrovnané UTXO jsou poté odeslány na účet **premix**. Co se týče rozdílu, který nemůže vstoupit do poolu, je oddělen na zvláštní účet: **bad bank** (neboli "toxická směna").

Tato počáteční transakce `Tx0` slouží také k úhradě servisních poplatků koordinátorovi spojení mincí. Na rozdíl od následujících kroků tato transakce není kooperativní, proto musí uživatel nést plné náklady na poplatky za těžbu:

![BTC204](assets/it/54/09.webp)

V tomto příkladu transakce `Tx0` je vstupní částka `372 000 satelitů` z našeho **vkladového účtu** rozdělena na několik výstupních UTXO, které jsou rozděleny takto:


- Částka 5 000 satelitů přidělená koordinátorovi na poplatky za služby, která odpovídá vstupu do fondu 100 000 satelitů;
- 3 UTXO připravené k míchání, přesměrované na náš **premix účet** a zaregistrované u koordinátora. Tyto UTXO jsou vyrovnány na `108 000 sátů` každý, aby se pokryly poplatky za těžbu pro jejich budoucí počáteční mix;
- Přebytek, který se nemůže dostat do bazénu, protože je příliš malý, se považuje za toxickou výměnu. Je odeslán na jeho specifický účet. V tomto případě činí tato výměna 40 000 satů;
- Nakonec je zde `3 000 satelitů`, které nepředstavují výstup, ale jsou to poplatky za těžbu potřebné k potvrzení `Tx0`.

Například zde je skutečný Whirlpool Tx0 (ne můj):[edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/fr/145.webp)

### Toxická změna

Přebytek, který se nepodařilo začlenit do fondu, zde odpovídající 40 000 sátů, je přesměrován na účet **špatné banky**, označovaný také jako "toxická výměna", aby bylo zajištěno přísné oddělení od ostatních UTXO v portfoliu.

Tento UTXO je nebezpečný pro soukromí uživatele, protože nejenže je stále spojen s minulostí uživatele, a tedy možná i s identitou jeho vlastníka, ale je také označen jako patřící uživateli, který se účastnil coinjoinu.

![BTC204](assets/fr/146.webp)

Pokud je tento UTXO sloučen se zamíchanými výstupy, ztratí veškeré soukromí získané během cyklů coinjoin, a to výrazně díky CIOH (_Common-Input-Ownership-Heuristic_). Pokud je sloučeno s jinými toxickými změnami, hrozí uživateli ztráta soukromí, protože se tím propojí různé vstupy z coinjoin cyklů. Proto by se s ní mělo zacházet opatrně. Podrobněji se správou těchto toxických UTXO budeme zabývat v poslední části této kapitoly.

### Počáteční směs

Po dokončení `Tx0` jsou vyrovnané UTXO odeslány na účet **premix** v našem portfoliu a jsou připraveny k zavedení do prvního cyklu spojování mincí, kterému se také říká "počáteční mix" Pokud, jako v našem příkladu, `Tx0` vygeneruje několik UTXO určených ke smíchání, každý z nich bude začleněn do samostatného počátečního mixu.

Na konci těchto prvních mixů bude účet **premix** prázdný, zatímco naše mince, které zaplatily poplatky za těžbu za toto první spojení mincí, budou vypořádány přesně ve výši definované zvoleným poolem. V našem příkladu se naše počáteční UTXO ve výši `108 000 sátů` sníží přesně na `100 000 sátů`.

![BTC204](assets/fr/147.webp)

### Remixy

Po počátečním smíchání jsou prostředky UTXO převedeny na účet **postmix**. Tento účet shromažďuje jak UTXO, které již byly smíchány, tak ty, které čekají na remix. Když je klient Whirlpool aktivní, UTXO na účtu **postmix** jsou automaticky k dispozici pro remix a budou náhodně vybrány pro účast v těchto nových kolech.

Připomínáme, že remixy jsou pak zcela zdarma: nejsou vyžadovány žádné další poplatky za služby ani za těžbu. Ponechání UTXO na účtu **postmix** tak zachovává jejich hodnotu a zároveň zlepšuje jejich anonce. Proto je důležité umožnit těmto mincím účastnit se více cyklů coinjoin. Nestojí vás to vůbec nic a zvyšuje to jejich anonsetovou úroveň.

Pokud se rozhodnete utratit smíšené jednotky UTXO, můžete tak učinit přímo z tohoto účtu **postmix**. Doporučuje se ponechat smíšené UTXO na tomto účtu, abyste mohli využívat bezplatných remixů a abyste zabránili jejich opuštění okruhu Whirlpool, což může snížit jejich soukromí.

### Jak správně spravovat účet postmix?

Po spuštění cyklů coinjoin je nejlepší strategií ponechat si UTXO na účtu **postmix** a čekat na jejich budoucí použití. Dokonce je vhodné nechat je remixovat po neomezenou dobu, dokud je nebudete potřebovat utratit.

Někteří uživatelé mohou zvážit převod svých smíšených bitcoinů do chráněné hardwarové peněženky. To je možné, ale je důležité pečlivě dodržovat doporučení Samourai Wallet, aby nedošlo k ohrožení získané důvěrnosti.

Nejčastější chybou je kombinace UTXO. Je třeba se vyvarovat kombinování smíšených UTXO s nesmíšenými UTXO ve stejné transakci, abyste se vyhnuli heuristice společného vlastnictví vstupů (CIOH). To vyžaduje pečlivou správu UTXO v rámci vašeho portfolia, zejména pokud jde o označování.

![BTC204](assets/fr/148.webp)

Je také důležité být opatrný při konsolidaci smíšených UTXO dohromady. Mírné konsolidace jsou myslitelné, pokud vaše smíšené UTXO mají významné anonce, ale to nevyhnutelně sníží důvěrnost vašich mincí. Dbejte na to, aby konsolidace nebyly příliš výrazné nebo aby byly prováděny po nedostatečném počtu remixů, a to s rizikem vytvoření odvozených vazeb mezi vašimi UTXO před a po cyklech spojování mincí. V případě pochybností o těchto manipulacích je nejlepším postupem nekonsolidovat UTXO po smíchání a převádět je po jednom do hardwarové peněženky a pokaždé vygenerovat novou prázdnou adresu. Přesto nezapomeňte každé přijaté UTXO řádně označit.

Rovněž se nedoporučuje přenášet postmixy UTXO do peněženky, která používá neobvyklé skripty. Pokud například vstoupíte do Whirlpoolu z multisig peněženky, která používá skripty `P2WSH`, existuje malá šance, že budete smícháni s ostatními uživateli, kteří mají původně stejný typ peněženky. Pokud si v této stejné multisig peněžence vyberete své postmixy, úroveň soukromí vašich smíšených bitcoinů se značně sníží. Kromě skriptů existuje mnoho dalších otisků peněženek, které vás mohou oklamat.

Stejně jako u každé transakce s bitcoiny je také důležité, abyste znovu nepoužívali přijímací adresy. Každá nová transakce by měla být přijata na nové, prázdné adrese.

Nejjednodušším a nejbezpečnějším řešením je nechat smíšené UTXO odpočívat na jejich **postmixovém** účtu a umožnit jim remixovat a dotýkat se jich pouze za účelem jejich utracení. Portfolia Samourai a Sparrow mají další ochranu proti všem těmto rizikům analýzy řetězce. Tyto ochrany vám pomohou vyhnout se chybám.

### Jak správně zvládnout toxickou změnu?

Dále musíte být opatrní při nakládání s toxickými drobnými, tedy s drobnými, které se nemohly dostat do fondu coinjoin. Tyto toxické UTXO, které jsou výsledkem používání Whirlpoolu, představují riziko pro vaše soukromí, protože vytvářejí spojení mezi vámi a používáním coinjoinu. Proto je nutné s nimi zacházet opatrně a nekombinovat je s jinými UTXO, zejména se smíšenými UTXO.

Zde je několik strategií, jak je využít:


- Smíchejte je v menších bazénech:** Pokud je váš toxický UTXO dostatečně velký na to, aby se sám vešel do menšího bazénu, zvažte jeho smíchání. To je často nejlepší volba. Smíchání několika toxických UTXO dohromady pro přístup do bazénu se však nedoporučuje, protože by to mohlo propojit vaše různé vchody.
- Označte je jako "neutratitelné":** Dalším přístupem je přestat je používat, označit je na vyhrazeném účtu jako "neutratitelné" a jednoduše je hodit. Tím zajistíte, že je omylem neutratíte. Pokud se hodnota bitcoinu zvýší, mohou se objevit nové pooly vhodnější pro vaše toxické UTXO;
- Poskytování darů:** Zvažte poskytnutí darů, i skromných, vývojářům pracujícím na Bitcoinu a souvisejícím softwaru. Můžete také přispět organizacím, které přijímají BTC. Pokud se vám zdá správa toxických UTXO příliš složitá, můžete se jich jednoduše zbavit poskytnutím daru.
- Nákup dárkových karet:** Platformy jako [Bitrefill](https://www.bitrefill.com/) umožňují směnit bitcoiny za dárkové karty, které lze použít u různých obchodníků. To může být způsob, jak se zbavit toxických UTXO, aniž byste přišli o související hodnotu.
- Konsolidace na Monero:** Peněženka Samourai nabízí službu atomické výměny mezi BTC a XMR. To je ideální pro správu toxických UTXO jejich konsolidací na Monero, aniž byste ohrozili své soukromí prostřednictvím KYC, před jejich odesláním zpět na Bitcoin. Tato možnost však může být drahá z hlediska poplatků za těžbu a prémií kvůli omezení likvidity.
- Poslat je do Lightning Network:** Přesun těchto UTXO do Lightning Network a využití snížených transakčních poplatků je atraktivní možností. Tato metoda však může odhalit některé informace v závislosti na používání Lightning, a proto by se měla praktikovat s opatrností.

### Jak používat Whirlpool?

Po zatčení zakladatelů peněženky Samourai a zabavení jejich serverů 24. dubna 2024 nástroj Whirlpool přestal fungovat, a to i pro ty, kteří mají vlastní Dojo. Dříve byl k dispozici v peněženkách Samourai Wallet a Sparrow Wallet.

![BTC204](assets/fr/149.webp)

Je však možné, že tento přístroj bude v následujících týdnech znovu uveden do provozu v závislosti na výsledcích zkoušek nebo bude znovu spuštěn jiným způsobem. V každém případě se domnívám, že trh s coinjoin na Bitcoinu nezůstane dlouho bez nabídky, protože je po něm jasná poptávka. Navíc model Whirlpool, který je z hlediska ochrany soukromí nejpokročilejší, bude jistě v budoucnu využit i pro další implementace.

Pozorně sledujeme vývoj tohoto případu i vývoj souvisejících nástrojů. Ujišťujeme vás, že toto školení budeme aktualizovat, jakmile budou k dispozici nové informace.

V příští kapitole se dozvíme, co jsou to "anonsety", jak se tyto ukazatele počítají a jak nám mohou pomoci odhadnout účinnost cyklů coinjoin.

https://planb.network/tutorials/privacy/on-chain/coinjoin-sparrow-wallet-84def86d-faf5-4589-807a-83be60720c8b
https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/tutorials/privacy/on-chain/coinjoin-dojo-c4b20263-5b30-4c74-ae59-dc8d0f8715c2
## Sada anonymity

<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>

Poté, co jsme se seznámili s tím, jak coinjoiny fungují, a s problémy spojenými s efektivním prolínáním, se nyní naučíme, jak tuto efektivitu měřit. Jak zjistit, zda byl proces coinjoinu účinný a jaký stupeň anonymity mince získala? To budeme v této kapitole zkoumat pomocí souborů anonymity neboli anglicky "anonsets".

### Připomenutí užitečnosti služby Coinjoin

Užitečnost funkce CoinJoin spočívá v tom, že dokáže vytvořit věrohodnou popíratelnost tím, že vaši minci ponoří do skupiny nerozlišitelných mincí. Cílem této akce je přerušit vazby sledovatelnosti, a to jak z minulosti do současnosti, tak ze současnosti do minulosti.

Jinými slovy, analytik, který zná vaši počáteční transakci (`Tx0`) na vstupu do cyklů CoinJoin, by neměl být schopen s jistotou identifikovat vaše UTXO na výstupu z remixových cyklů (analýza od vstupu do cyklu po výstup z cyklu).

![BTC204](assets/it/55/01.webp)

Naproti tomu analytik, který zná vaše UTXO na výstupu cyklů CoinJoin, by neměl být schopen určit původní transakci na vstupu cyklů (analýza z výstupu cyklu na vstup cyklu).

![BTC204](assets/it/55/02.webp)

Aby bylo možné posoudit, jak obtížné je pro analytika propojit minulost se současností a naopak, je třeba kvantifikovat velikost homogenních skupin mincí, v nichž se vaše mince skrývá. Tato míra nám říká, jaký je počet analýz, které mají shodnou pravděpodobnost. Pokud je tedy správná analýza utopena mezi 3 jinými analýzami se stejnou pravděpodobností, je úroveň vašeho utajení velmi nízká. Pokud se však správná analýza nachází v souboru 20 000 analýz se stejnou pravděpodobností, je vaše mince velmi dobře ukrytá. A právě velikost těchto množin představují ukazatele zvané anonce.

### Porozumění anonsetům

Anonymy slouží jako indikátory pro posouzení stupně soukromí konkrétního UTXO. Přesněji řečeno, měří počet nerozlišitelných UTXO v souboru, který zahrnuje zkoumanou minci. Požadavek na homogenní soubor UTXO znamená, že anonsety se obvykle počítají na cyklech CoinJoin. Použití těchto ukazatelů je zvláště důležité pro Whirlpool CoinJoiny kvůli jejich homogenitě.

Anonsety umožňují v případě potřeby posoudit kvalitu CoinJoins. Velká velikost anonsetu znamená vysokou úroveň anonymity, protože v homogenním souboru je obtížné rozlišit konkrétní UTXO.

Existují 2 typy anonsetů:


- Výhledový anonset;**
- Retrospektivní anonset.**

### Perspektivní anonset

Výhledový anonset udává velikost skupiny, mezi níž je zkoumaný UTXO skryt na výstupu z cyklu, při znalosti UTXO na vstupu, tj. počet nerozlišitelných mincí přítomných v této skupině. V angličtině je název tohoto ukazatele "forward anonset" nebo "forward-looking metrics"

Tento ukazatel poskytuje měřítko odolnosti měnového soukromí vůči analýze minulého období (od vstupu k výstupu).

![BTC204](assets/it/55/03.webp)

Tato metrika odhaduje míru ochrany UTXO proti pokusům o rekonstrukci jeho historie od vstupního bodu po výstupní bod v procesu spojování mincí.

Například pokud se vaše transakce zúčastnila prvního cyklu spojení mincí a byly dokončeny dva další sestupné cykly, budoucí anonset vaší mince bude `13`:

![BTC204](assets/fr/153.webp)

Představme si například, že naše mince na vstupu do cyklu spojování mincí těží z perspektivního anonsetu `86,871`. Prakticky to znamená, že je ukryta mezi `86 871` nerozlišitelnými mincemi. Pro vnějšího pozorovatele, který si je vědom této mince na začátku cyklu coinjoin a snaží se sledovat její výstup, by se setkal s `86 871` možnými UTXO, z nichž každá má stejnou pravděpodobnost, že je hledanou mincí.

![BTC204](assets/it/55/05.webp)

### Retrospektivní anonset

Retrospektivní anonset udává počet možných zdrojů pro danou minci při znalosti UTXO na výstupu z cyklu. Tento ukazatel měří odolnost mince vůči soukromí při analýze z přítomnosti do minulosti (od výstupu ke vstupu), tj. jak obtížné je pro analytika vystopovat původ vaší mince, před cykly coinjoin. V angličtině se tento ukazatel jmenuje "backward anonset" neboli "retrospektivní metrika"

Při znalosti vašeho UTXO na výstupu z cyklů určí retrospektivní anonset počet potenciálních transakcí Tx0, které mohly představovat váš vstup do cyklů spojení mincí. V níže uvedeném diagramu to odpovídá součtu všech oranžových bublin.

Představme si například, že naše mince na výstupu z cyklu spojování mincí využívá retrospektivní anonset ve výši `42 185`. Prakticky to znamená, že pro toto UTXO existuje `42 185` možných zdrojů. Pokud vnější pozorovatel identifikuje tuto minci na konci cyklů a pokusí se vystopovat její původ, bude čelit `42 185` možným zdrojům, přičemž všechny mají stejnou pravděpodobnost, že jsou hledaným původem.

### Jak konkrétně vypočítat anonsety?

Pro malé sady můžete anonsety vypočítat ručně pomocí průzkumníka bloků. Pro větší anonsety je však nutné použít specializovaný nástroj. Pokud je mi známo, jediným softwarem, který je schopen tento úkol provést, je _Whirlpool Stats Tool_, nástroj v jazyce Python vyvinutý týmy Samourai a OXT. Tento nástroj je bohužel v současné době mimo provoz v důsledku zatčení zakladatelů Samourai a ukončení činnosti OXT, který byl používán k získávání dat z blockchainu.

Jak jsme viděli v této kapitole, anonsety lze vypočítat pouze v případě, že existuje určitá homogenita ve struktuře coinjoin. A právě v příští kapitole zjistíme, jak tuto homogenitu v bitcoinové transakci kvantifikovat, ať už se jedná o coinjoin, nebo tradičnější transakci.

https://planb.network/tutorials/privacy/analysis/wst-anonsets-0354b793-c301-48af-af75-f87569756375
## Entropie

<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>

Jak jsme viděli v této části o spojování mincí, homogenita UTXO na vstupech a výstupech hraje důležitou roli při zvyšování důvěrnosti bitcoinové transakce. Tento parametr umožňuje věrohodné popření proti analýze řetězce. Tuto homogenitu lze měřit několika metodami, ale jednou z nejefektivnějších je podle mého názoru použití ukazatelů poskytovaných nástrojem _Boltzmann_, který vyvinuly týmy OXT a Samourai Wallet, konkrétně entropie transakcí. Právě tu budeme v této kapitole podrobně studovat.

Na rozdíl od anonsetů, které se počítají na základě souboru transakcí, se ukazatele, které zde představíme, zaměřují výhradně na jednu transakci, ať už se jedná o coinjoin nebo tradičnější transakci.

### Počet interpretací

Prvním ukazatelem, který lze u transakce bitcoinu pozorovat, je celkový počet možných interpretací v očích vnějšího pozorovatele, který transakci analyzuje. S přihlédnutím k hodnotám UTXO zapojených do transakce tento ukazatel udává počet způsobů, jakými lze vstupy přiřadit k výstupům. Jinými slovy, určuje počet možných interpretací, které může transakce v bitcoinovém toku z pohledu vnějšího pozorovatele, který ji analyzuje, vyvolat.

Například jednoduchá platební transakce s 1 vstupem a 2 výstupy bude mít pouze jednu interpretaci, a to že vstup #0 financoval výstup #0 a výstup #1. Žádné jiné interpretace nejsou možné:

![BTC204](assets/fr/159.webp)

Naproti tomu spojení mincí strukturované podle modelu Whirlpool 5x5 má 1496 možných kombinací:

![BTC204](assets/fr/160.webp)

Spojení Whirlpool Surge Cycle 8x8 přinese 9 934 563 dolarů možných interpretací:

![BTC204](assets/fr/161.webp)

### Entropie

Z počtu interpretací transakce bitcoinu můžeme vypočítat její entropii.

V obecném kontextu kryptografie a informací je entropie kvantitativní mírou nejistoty nebo nepředvídatelnosti spojené se zdrojem dat nebo náhodným procesem. Jinými slovy, entropie je způsob, jak měřit, jak obtížné je předvídat nebo odhadnout informaci.

V konkrétním kontextu analýzy řetězce je entropie také název ukazatele, odvozeného od Shannonovy entropie a [vynalezeného LaurentemMT](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf), který lze vypočítat na transakci Bitcoin.

Pokud má transakce vysoký počet možných interpretací, je často relevantnější odkazovat na její entropii. Tento ukazatel poskytuje míru nedostatečné znalosti analytiků o přesné konfiguraci transakce. Jinými slovy, čím vyšší je entropie, tím obtížnější je pro analytiky identifikovat toky bitcoinů mezi vstupy a výstupy.

V praxi entropie odhaluje, zda má transakce z pohledu vnějšího pozorovatele více možných interpretací, a to pouze na základě vstupních a výstupních veličin, aniž by byly zohledněny další vnější nebo vnitřní zákonitosti a heuristiky. Vysoká entropie je tedy synonymem vyšší důvěrnosti transakce.

Entropie je definována jako binární logaritmus počtu možných kombinací. Zde je použit vzorec, kde $E$ představuje entropii transakce a $C$ počet možných interpretací:

$$
E = \log_2(C)
$$

V matematice odpovídá binární logaritmus (logaritmus do základu 2) inverzní operaci zvýšení 2 na určitou mocninu. Jinými slovy, binární logaritmus $x$ je exponent, na který je třeba zvýšit $2$, abychom získali $x$. Tento ukazatel je tedy vyjádřen v bitech.

Vezměme si příklad výpočtu entropie pro transakci coinjoin strukturovanou podle modelu 5x5 Whirlpool, která, jak bylo uvedeno v předchozí části, má počet možných interpretací 1 496 USD:

$$
\begin{align*}
C &= 1.496 \\
E &= \log_2(1.496) \\
E &= 10.5469 \text{ bit}
\end{align*}
$$

Tato transakce coinjoin tedy vykazuje entropii 10,5469$ bitů, což je považováno za velmi uspokojivé. Čím vyšší je tato hodnota, tím více různých interpretací transakce připouští, čímž se zvyšuje její úroveň soukromí.

Pro transakci 8x8 coinjoin, která má 9 934 563 USD interpretací, by entropie byla:

$$
\begin{align*}
C &= 9.934.563 \\
E &= \log_2(9.934.563) \\
E &= 23,244 \text{ bit}
\end{align*}
$$

Uveďme další příklad standardní platební transakce s 1 vstupem a 2 výstupy: [1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/fr/162.webp)

V případě této transakce je jediná možná interpretace: `(In.0) > (Out.0 ; Out.1)`. Proto je její entropie nastavena na $0$:

$$
\begin{align*}
C &= 1 \\
E &= \log_2(1) \\
E &= 0 \text{ bit}
\end{align*}
$$

### Efektivita

Z entropie transakce můžeme také vypočítat její účinnost ochrany soukromí. Tento ukazatel hodnotí účinnost transakce porovnáním s optimální transakcí myslitelnou v identické konfiguraci.

To nás vede k diskusi o pojmu maximální entropie, který odpovídá nejvyšší entropii, jíž by určitá struktura transakcí mohla teoreticky dosáhnout. Účinnost transakce se pak vypočítá porovnáním této maximální entropie se skutečnou entropií analyzované transakce.

Používá se následující vzorec s:


- $E_R$: skutečná entropie transakce vyjádřená v bitech;
- $E_M$: maximální možná entropie pro strukturu transakce vyjádřená rovněž v bitech;
- $Ef$: efektivita transakce v bitech:

$$
Ef = E_R - E_M
$$

Například pro strukturu coinjoin typu Whirlpool 5x5 je maximální entropie $10,5469$:

$$
\begin{align*}
E_R &= 10,5469 \\
E_M &= 10,5469 \\
Ef &= E_R - E_M \\
Ef &= 10,5469 - 10,5469 \\
Ef &= 0 \text{ bit}
\end{align*}
$$

Tento ukazatel je rovněž vyjádřen v procentech. Používá se následující vzorec:


- $C_R$: počet možných reálných interpretací;
- $C_M$: maximální počet možných interpretací se stejnou strukturou;
- $Ef$: účinnost vyjádřená v procentech:

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1.496}{1.496} \\
E_f &= 100\%
\end{align*}
$$

Efektivita 100 %$ tedy znamená, že transakce na základě své struktury maximalizuje svůj potenciál soukromí.

### Hustota entropie

Entropie je dobrým ukazatelem pro měření soukromí transakce, ale částečně závisí na počtu vstupů a výstupů v transakci. Pro porovnání entropie dvou různých transakcí, které nemají stejný počet vstupů a výstupů, lze vypočítat hustotu entropie. Tento ukazatel poskytuje pohled na entropii vzhledem ke každému vstupu nebo výstupu v transakci. Hustota se ukazuje jako užitečná při hodnocení a porovnávání efektivity transakcí různých velikostí.

Pro její výpočet stačí vydělit celkovou entropii transakce celkovým počtem vstupů a výstupů zapojených do transakce:


- $E_D$: hustota entropie vyjádřená v bitech;
- $E$: entropie transakce vyjádřená v bitech;
- $T$: celkový počet vstupů a výstupů v transakci:

$$
E_D = \frac{E}{T}
$$

Vezměme si příklad spojení 5x5 Whirlpool:

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ bit}
\end{align*}
$$

Vypočítáme také hustotu entropie pro spojení 8x8 Whirlpool:

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
E_D &= 1.453 \text{ bit}
\end{align*}
$$

Při analýze hustoty entropie těchto dvou typů koincidencí je zřejmé, že i při normalizaci entropie na počet prvků generuje koincidenční spojení "Surge Cycle 8x8" větší nejistotu pro analýzu.

### Boltzmannovo skóre

Další informací analyzovanou v transakci je Boltzmannovo skóre každého prvku vůči jinému. Jedná se o tabulku pravděpodobnosti shody mezi vstupy a výstupy. Tato tabulka udává prostřednictvím Boltzmannova skóre podmíněnou pravděpodobnost, že určitý vstup souvisí s daným výstupem. Jedná se tedy o kvantitativní míru podmíněné pravděpodobnosti, že dojde k asociaci mezi vstupem a výstupem v transakci, určenou na základě poměru počtu příznivých výskytů této události k celkovému počtu možných výskytů, v souboru interpretací.

Vezmeme-li si příklad spojení Whirlpool, tabulka podmíněných pravděpodobností by zvýraznila možnosti spojení mezi každým vstupem a výstupem a poskytla by kvantitativní míru nejednoznačnosti spojení v transakci:

| % | Výstup 0 | Výstup 1 | Výstup 2 | Výstup 3 | Výstup 4 |

| ------- | -------- | -------- | -------- | -------- | -------- |

Zde je zřejmé, že každý vstup má stejnou pravděpodobnost přiřazení k jakémukoli výstupu, což zvyšuje důvěrnost transakce.

Výpočet Boltzmannova skóre spočívá ve vydělení počtu interpretací, v nichž se určitá událost vyskytne, celkovým počtem dostupných interpretací. Chceme-li tedy určit skóre přiřazením vstupu #0 k výstupu #3 (událost vyskytující se v 512$ interpretacích), postupujeme následovně:

$$
\begin{align*}
\text{Interpretazioni (IN.0 > OUT.3)} &= 512 \\
\text{Interpretazioni Totali} &= 1496 \\
\text{Punteggio} &= \frac{512}{1496} \\
\text{Punteggio} &= 34\%
\end{align*}
$$

Pokud bychom znovu uvažovali o příkladu cyklu Surge 8x8 Whirlpool coinjoin, vypadala by Boltzmannova tabulka takto:

| OUT.0 | OUT.1 | OUT.2 | OUT.3 | OUT.4 | OUT.5 | OUT.6 | OUT.7 | OUT.7 | OUT.7 |

| ---- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |

| IN.0 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| IN.1 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| IN.2 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| IN.3 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| IN.4 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| IN.5 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| IN.6 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

| IN.7 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% |

V případě jednoduché transakce zahrnující jeden vstup a dva výstupy je však situace jiná:

| % | Výstup 0 | Výstup 1 |

| ------- | -------- | -------- |

| Vstup 0 | 100% | 100% |

Zde vidíme, že pravděpodobnost každého výstupu ze vstupu č. 0 je 100 %. Nižší pravděpodobnost tedy vede k většímu soukromí tím, že rozmělňuje přímé vazby mezi vstupy a výstupy.

### Deterministické odkazy

Je také možné vypočítat počet deterministických spojení v transakci. Tento ukazatel ukazuje, kolik vazeb mezi vstupy a výstupy v analyzované transakci je nezpochybnitelných, se 100% pravděpodobností. Tento ukazatel pak lze doplnit výpočtem poměru deterministických vazeb. Poměr poskytuje pohled na váhu těchto deterministických vazeb v rámci všech vazeb v transakci.

Například transakce Whirlpool coinjoin nevykazuje žádnou deterministickou vazbu mezi vstupy a výstupy, a proto vykazuje ukazatel 0 vazeb a poměr 0 %. Naproti tomu v naší druhé zkoumané jednoduché platební transakci (s jedním vstupem a 2 výstupy) nám ukazatel říká, že existují 2 deterministické vazby a poměr dosahuje 100 %. Nulový ukazatel tedy signalizuje vynikající soukromí, protože neexistují přímé a nesporné vazby mezi vstupy a výstupy.

### Jak tyto ukazatele vypočítat?

Ruční výpočet těchto ukazatelů pomocí rovnic, které jsem uvedl, je poměrně jednoduchý. Hlavní potíž spočívá ve stanovení počtu možných interpretací transakce. U standardní transakce lze tento výpočet provést ručně. Pro coinjoin je však tento úkol podstatně složitější.

Dříve existoval nástroj v jazyce Python s názvem _Boltzmann Calculator_, vyvinutý týmy OXT a Samourai, který umožňoval automatický výpočet všech těchto ukazatelů pro bitcoinovou transakci:

![BTC204](assets/fr/163.webp)

Pro tyto analýzy bylo možné využít také webové stránky KYCP.org:

![BTC204](assets/fr/164.webp)

Bohužel po zatčení zakladatelů společnosti Samourai nejsou tyto nástroje v současné době funkční.

Nyní, když jsme podrobně probrali coinjoiny, se v poslední části našeho školení budeme věnovat dalším technikám ochrany soukromí, které jsou v Bitcoinu k dispozici. Prozkoumáme payjoin transakce, specifické typy pseudo-coinjoin transakcí, protokoly statických adres a také opatření ke zlepšení soukromí nikoli na úrovni transakcí, ale na úrovni sítě uzlů.

https://planb.network/tutorials/privacy/analysis/boltzmann-entropy-738e45af-18a6-4ce6-af1a-1bf58e15f1fe
# Pochopení významu dalších pokročilých technik ochrany soukromí

<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Transakce Payjoin

<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>

V současné době je coinjoin nejefektivnější metodou pro zavedení nejistoty do sledování mincí při analýze řetězce. Jak jsme viděli v předchozích kapitolách, k dosažení účinného míchání je třeba, aby vstupy a výstupy byly co nejhomogennější. Kromě toho je zásadní, aby coinjoiny byly integrovány do co největší skupiny, aby se maximalizovaly anonsety. Aby tedy bylo coinjoins efektivní, musí zahrnovat velký počet stejnorodých mincí. Toto množství požadavků znamená, že transakce coinjoin mají velmi pevnou strukturu: částky jsou předem stanoveny a všichni účastníci je musí dodržovat, aby byla zajištěna jednotnost procesu. Kromě toho coinjoiny vyžadují synchronizaci mezi všemi účastníky a koordinátorem během konstrukce transakce.

Kvůli těmto požadavkům je coinjoin pro přímé platby nevhodný. Pokud například vlastníte 1M sats v poolu coinjoin, bylo by jeho přímé použití jako platby složité. Vyžadovalo by to synchronizaci s ostatními účastníky a koordinátor by musel přesně v době, kdy potřebujete provést platbu, sestavit kolaborativní transakci a částka nákupu by musela přesně odpovídat hodnotě vašeho kusu, což je prakticky neproveditelné. Proto je coinjoin transakce ze své podstaty kolaborativní úklidovou transakcí, což znamená, že obecně platí, že ve výstupech jsou stejní vlastníci vstupů.

Bylo by však zajímavé mít transakční struktury, které umožňují praktické platby tím, že do analýzy řetězce vnesou pochybnosti. Právě to budeme zkoumat v této a následující kapitole.

### Co je to transakce payjoin?

Payjoin je specifická struktura transakce Bitcoin, která zvyšuje soukromí uživatele během útraty tím, že spolupracuje s příjemcem platby.

V roce 2015 se o této metodě poprvé zmínil LaurentMT pod názvem "steganografické transakce", podle dostupného článku [zde](https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt). Tuto techniku později převzala peněženka Samourai, která ji v roce 2018 jako první klient implementovala pomocí nástroje Stowaway. Koncept payjoin lze nalézt také v publikacích [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki) a [BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki). Pro označení payjoinu se tedy používá několik termínů:


- Payjoin;
- Černý pasažér;
- P2EP (_Pay-to-End-Point_);
- Steganografická transakce.

Jedinečnost payjoinu spočívá v tom, že dokáže vygenerovat transakci, která se na první pohled zdá být obyčejná, ale ve skutečnosti se jedná o mini coinjoin mezi dvěma lidmi. Za tímto účelem je do struktury transakce zapojen příjemce platby na vstupech spolu se skutečným odesílatelem. Příjemce pak doprostřed transakce zahrne platbu sobě samému, která mu umožní, aby mu bylo zaplaceno.

Pro lepší pochopení tohoto procesu si uveďme příklad. Alice si koupí bagetu za 4 000 sátů s využitím UTXO 10 000 sátů a rozhodne se pro payjoin. Její pekař Bob přidá na vstupu vlastní UTXO ve výši 15 000 sats, které se mu zcela vrátí na výstupu, navíc k Aliciným 4 000 sats.

V příkladu Bob pekař vloží 15 000 sáčků a vyjde mu 19 000 sáčků, rozdíl je přesně 4 000 sáčků, což je cena bagety. Alice zase zadá 10 000 satů a na výstupu skončí s 6 000 satů, což představuje zůstatek -4 000 satů, což je cena bagety. Pro zjednodušení příkladu jsem v této transakci záměrně vynechal poplatky za těžbu.

### K čemu slouží payjoin?

Transakce payjoin splňuje dva cíle, které uživatelům umožňují zlepšit soukromí jejich plateb.

Za prvé, cílem payjoinu je oklamat vnějšího pozorovatele tím, že vytvoří odklon v analýze řetězce. To je umožněno pomocí heuristické metody _Common Input Ownership Heuristic_ (CIOH). Jak jsme viděli v části 3, obvykle když má transakce v blockchainu více vstupů, předpokládá se, že všechny tyto vstupy patří stejnému subjektu nebo uživateli.

Když tedy analytik zkoumá transakci payjoin, je přesvědčen, že všechny vstupy pocházejí od stejné osoby. Tento dojem je však nesprávný, protože spolu se skutečným plátcem přispívá svými vstupy i příjemce. Řetězová analýza je tak vychýlena směrem k interpretaci, která se ukáže jako nesprávná.

Vraťme se k našemu příkladu transakce payjoin pro zaplacení bagety:

Při pohledu na tuto transakci v blockchainu by ji vnější pozorovatel, který by se řídil obvyklou heuristikou analýzy řetězce, interpretoval takto: "Alice připojila 2 UTXO na vstupu transakce, aby zaplatila 19 000 sátů Bobovi."

Tato interpretace je zjevně chybná; jak již víte, oba UTXO na vstupu nepatří stejné osobě. Jeden je od Alice, kupující bagety, a druhý od Boba, pekaře.

Analýza externího pozorovatele tak směřuje k chybnému závěru, což zajišťuje zachování důvěrnosti zúčastněných stran.

### Steganografická transakce

Druhým cílem payjoinu je oklamat vnějšího pozorovatele ohledně skutečné výše provedené platby. Při zkoumání struktury transakce by se analytik mohl domnívat, že platba odpovídá částce jednoho z výstupů.

Vezmeme-li si náš příklad nákupu bagety, bude si analytik myslet, že částka platby odpovídá buď UTXO 6 000 sátů, nebo UTXO 19 000 sátů. V tomto případě je pravděpodobnější, že si analytik bude myslet, že částka platby je 19 000 sats, protože ve výstupu jsou 2 UTXO, z nichž alespoň jedno je větší než 6 000 sats (není žádný logický důvod používat 2 UTXO k platbě 6 000 sats, když by k této platbě stačilo jediné UTXO).

Ve skutečnosti je však tato analýza nesprávná. Výše platby neodpovídá žádnému z výstupů. Ve skutečnosti se jedná o rozdíl mezi UTXO příjemce výstupu a UTXO příjemce vstupu.

Transakce payjoin tak spadá do oblasti steganografie. Umožňuje skrýt skutečnou částku transakce v rámci falešné transakce, která slouží k odvedení pozornosti.

Steganografie je technika skrývání informací v jiných datech nebo objektech tak, aby přítomnost skrytých informací nebyla patrná. Tajnou zprávu lze například skrýt v bodě v nesouvisejícím textu, takže ji pouhým okem nelze odhalit (jedná se o techniku [micropoint](https://fr.wikipedia.org/wiki/Micropoint)).

Na rozdíl od šifrování, které bez dešifrovacího klíče činí informace nesrozumitelnými, steganografie informace nemění. Zůstávají viditelné. Jejím cílem je spíše skrýt samotnou existenci tajné zprávy, zatímco kryptografie jasně odhaluje přítomnost skryté informace, i když je bez klíče nedostupná. Proto byl původní název pro payjoin "steganografické transakce"

Analogicky by se dalo hovořit o kryptografii a coinjoinu, stejně jako o steganografii a payjoinu. Ve skutečnosti má coinjoin podobné atributy jako kryptografie: metoda je rozpoznatelná, ale informace jsou nerozluštitelné. Naproti tomu payjoin se podobá steganografii: informace je teoreticky přístupná, ale protože metoda jejího ukrytí není rozpoznatelná, stává se nepřístupnou.

### Jak používat payjoin?

Mezi známé softwary, které podporují payjoin, patří Sparrow Wallet, Wasabi Wallet, Mutiny, BitMask, BlueWallet a JoinMarket, stejně jako platební procesor BTCPay.

Nejpokročilejší implementací payjoin byl pouze Stowaway na Samourai Wallet. Od ukončení činnosti zakladatelů softwaru však tento nástroj nyní funguje jen částečně. Výhodou Stowaway je, že se jedná o kompletní a velmi snadno použitelný protokol, který podporuje příjem i odesílání payjoinů. Částečně podepsané transakce lze vyměňovat ručně naskenováním několika QR kódů nebo automaticky prostřednictvím Toru přes Soroban. Právě druhá možnost komunikace není v současné době v provozu.

Potíž při používání služby payjoin spočívá v její závislosti na účasti obchodníků. Jako zákazník nemůžete payjoin používat, pokud jej obchodník nepodporuje. To přidává další obtíže při nákupu: nejenže je složité najít obchodníky, kteří přijímají bitcoiny, ale pokud hledáte i ty, kteří payjoin podporují, je to ještě složitější.

Jedním z řešení by mohlo být použití transakčních struktur, které do analýzy řetězce vnášejí nejednoznačnost, aniž by vyžadovaly spolupráci příjemce. To by nám umožnilo zlepšit soukromí našich plateb bez závislosti na aktivní účasti obchodníků. Právě to budeme studovat v následující kapitole.

https://planb.network/tutorials/privacy/on-chain/payjoin-sparrow-wallet-087a0e49-61cd-41f5-8440-ac7b157bdd62
https://planb.network/tutorials/privacy/on-chain/payjoin-samourai-wallet-48a5c711-ee3d-44db-b812-c55913080eab
## Platba za připojení mincí

<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>

Pokud chcete provést platební transakci a zároveň si zachovat určitou míru soukromí, je payjoin dobrou volbou. Jak jsme však viděli, payjoin vyžaduje zapojení příjemce. Co tedy dělat, když se ten odmítne payjoinu zúčastnit, nebo když ho prostě raději nezapojíte? Jednou z alternativ je použití transakce Stonewall nebo Stonewall x2. Podívejme se na tyto dva typy transakcí blíže.

### Transakce Stonewall

Stonewall je specifická forma transakce s bitcoiny, jejímž cílem je zvýšit soukromí uživatelů během nakupování tím, že napodobuje pseudo-coinový spoj mezi dvěma lidmi, ale ve skutečnosti jím není. Ve skutečnosti tato transakce není společná. Uživatel si ji může sestavit sám, přičemž jako vstupní údaje použije pouze UTXO, které vlastní. Můžete tak vytvořit Stonewall transakci pro jakoukoli příležitost, aniž byste se museli synchronizovat s jiným uživatelem nebo příjemcem.

Fungování transakce Stonewall je následující: na vstupu transakce odesílatel použije 2 UTXO, které mu patří. Na výstupu transakce vzniknou 4 UTXO, z nichž 2 budou přesně ve stejné výši. Zbývající 2 UTXO budou tvořit zbytek. Ze 2 výstupů o stejné částce půjde příjemci platby skutečně pouze jeden.

V transakci Stonewall jsou pouze 2 role:


- Odesílatel, který provádí platbu;
- Příjemce, který si nemusí být vědom konkrétní povahy transakce a jednoduše čeká na platbu od odesílatele.

Podívejme se na příklad, abychom tuto strukturu transakce pochopili. Alice je u pekaře Boba, aby si koupila bagetu, která stojí 4 000 satů. Chce zaplatit v bitcoinech a zároveň si zachovat určitou úroveň soukromí o své platbě. Proto se rozhodne pro platbu zkonstruovat transakci Stonewall.

Analýzou této transakce zjistíme, že pekař Bob ve skutečnosti obdržel za bagetu 4 000 satů. Alice použila jako vstupy 2 UTXO: jeden o hodnotě 10 000 sátů a druhý o hodnotě 15 000 sátů. Na výstupech obdržela 3 UTXO: jeden o hodnotě 4 000 sats, jeden o hodnotě 6 000 sats a jeden o hodnotě 11 000 sats. Alice má tedy z této transakce čistý zůstatek -4 000 sátů, což je přesně stejná částka jako cena bagety.

V tomto příkladu jsem záměrně vynechal poplatky za těžbu pro snadnější pochopení. Ve skutečnosti poplatky za transakce hradí výhradně odesílatel.

### Jaké jsou cíle transakce Stonewall?

Struktura Stonewall přidává do transakce mnoho entropie a mate stopy řetězové analýzy. Z vnějšího pohledu lze takovou transakci interpretovat jako minipřipojení mincí mezi dvěma osobami. Ve skutečnosti se však jedná o platbu. Tato metoda tedy vytváří nejistoty v analýze řetězce, nebo dokonce vede k falešným stopám.

Vraťme se k příkladu Alice u pekaře Boba. Transakce v blockchainu by vypadala takto:

![BTC204](assets/fr/174.webp)

Vnější pozorovatel, který se spoléhá na běžnou heuristiku řetězové analýzy, by mohl mylně dojít k závěru, že "_dva lidé vytvořili malý coinjoin, každý s jedním UTXO na vstupu a dvěma UTXO na výstupu_" Analýza této transakce zvenčí nevede k uplatnění společné heuristiky vlastnictví vstupu (CIOH), protože přítomnost dvou výstupů ve stejné výši naznačuje vzor coinjoin. Z vnějšího pohledu se tedy CIOH v tomto konkrétním případě neuplatní.

![BTC204](assets/fr/175.webp)

Tato interpretace je nepřesná, protože, jak víte, jedno UTXO bylo posláno Bobovi pekaři, 2 UTXO na vstupu pocházely od Alice a ta získala 3 zbylé výstupy.

![BTC204](assets/fr/176.webp)

Na struktuře transakce Stonewall je zajímavé zejména to, že z pohledu vnějšího pozorovatele vypadá přesně jako transakce Stonewall x2.

### Transakce Stonewall x2

Stonewall x2 je další specifická forma transakce s bitcoiny, která má rovněž za cíl zvýšit soukromí uživatele během útraty, tentokrát však ve spolupráci s třetí stranou, která se na útratě nepodílí. Tato metoda funguje jako pseudo-coinjoin mezi dvěma účastníky při provádění platby třetí straně.

Fungování transakce Stonewall x2 je poměrně jednoduché: člověk použije UTXO, které má v držení, k provedení platby a požádá o pomoc třetí stranu, která rovněž přispěje svým UTXO. Transakce končí čtyřmi výstupy: dva ze stejných částek, z nichž jeden jde na adresu příjemce platby, druhý na adresu patřící přispěvateli. Třetí UTXO je odesláno na jinou adresu přispěvatele, což mu umožní získat zpět počáteční částku (pro něj neutrální akce po odečtení poplatků za těžbu), a poslední UTXO se vrací na adresu patřící nám, což představuje zbytek platby.

V transakcích Stonewall x2 jsou tedy definovány tři různé role:


- Odesílatel, který provádí skutečnou platbu;
- Příjemce, který si nemusí být vědom konkrétní povahy transakce a jednoduše čeká na platbu od odesílatele;
- Spolupracovník, který poskytuje bitcoiny, aby zpochybnil analýzu transakcí, na konci plně získá zpět své prostředky (neutrální akce pro něj, po odečtení poplatků za těžbu).

Vraťme se k našemu příkladu s Alicí, která si u pekaře Boba koupila bagetu za 4000 satů. Chce platit v bitcoinech a zároveň si zachovat určitou úroveň soukromí o své platbě. Zavolá tedy svému příteli Charlesovi, který jí v tomto procesu pomůže.

![BTC204](assets/fr/177.webp)

Analýzou této transakce zjistíme, že pekař Bob ve skutečnosti obdržel za bagetu 4 000 satů. Alice použila 10 000 satů na vstupu a získala zpět 6 000 satů na výstupu, takže čistá bilance činí -4 000 satů, což odpovídá ceně bagety. Co se týče Charlese, ten poskytl 15 000 satů na vstupu a získal dva výstupy: jeden ve výši 4 000 satů a druhý ve výši 11 000 satů, což vedlo k zůstatku 0.

V tomto příkladu jsem záměrně vynechal provize, abych usnadnil porozumění. Ve skutečnosti se poplatky za těžbu obecně dělí rovným dílem mezi vydavatele platby a přispěvatele.

### Jaké jsou cíle transakce Stonewall x2?

Stejně jako struktura Stonewall přidává struktura Stonewall x2 do transakce značné množství entropie a zastírá stopy řetězové analýzy. Z vnějšího pohledu by taková transakce mohla být interpretována jako malý coinjoin mezi dvěma osobami. Ve skutečnosti se však jedná o platbu. Tato metoda tedy vytváří nejistoty v analýze řetězce, což vede i k falešným stopám.

Podívejme se na příklad Alice, pekaře Boba a Charlese. Transakce v blockchainu by vypadala takto:

![BTC204](assets/fr/178.webp)

Vnější pozorovatel, který se spoléhá na běžnou heuristiku řetězové analýzy, by mohl mylně dojít k závěru, že "_Alice a Charles provedli malé spojení, přičemž každý z nich měl na vstupu jedno UTXO a na výstupu dvě UTXO_" Analýza této transakce zvenčí opět nevede k použití společné heuristiky vlastnictví na vstupu (CIOH), protože přítomnost dvou výstupů ve stejné výši naznačuje vzor coinjoin. Z vnějšího pohledu se tedy CIOH v tomto konkrétním případě neuplatní.

![BTC204](assets/fr/179.webp)

Tato interpretace je nepřesná, protože, jak víte, Bobovi pekaři bylo posláno jedno UTXO, Alice má pouze jeden klidový výstup a Charles má dva.

![BTC204](assets/fr/180.webp)

A opět, na struktuře transakce Stonewall x2 je zajímavé zejména to, že z pohledu vnějšího pozorovatele vypadá přesně jako transakce Stonewall.

### Jaký je rozdíl mezi Stonewall a Stonewall x2?

Transakce StonewallX2 funguje úplně stejně jako transakce Stonewall s tím rozdílem, že první z nich je kolaborativní, zatímco druhá nikoli. Jak jsme viděli, transakce StonewallX2 zahrnuje účast třetí strany (Charles), která je vůči platbě externí a která poskytuje své bitcoiny, aby zvýšila důvěrnost transakce. V klasické Stonewall transakci přebírá roli přispěvatele odesílatel.

![BTC204](assets/fr/181.webp)

Z vnějšího pohledu je tedy transakční model naprosto stejný.

Skutečnost, že tyto dvě transakční struktury mají přesně stejný vzor, znamená, že i když vnější pozorovatel dokáže identifikovat vzor "Stonewall(x2)", nebude mít k dispozici všechny informace. Nebude schopen určit, kterému ze dvou UTXO stejných částek odpovídá platba. Nebude také schopen určit, zda obě vstupní UTXO pocházejí od dvou různých osob (Stonewall x2), nebo zda patří jedné osobě, která se k nim připojila (Stonewall).

Tento poslední bod je způsoben skutečností, že transakce Stonewall x2 probíhají přesně podle stejného schématu jako transakce Stonewall. Zvenčí a bez dalších kontextových informací není možné odlišit transakci Stonewall od transakce Stonewall x2. První z nich však nejsou transakcemi spolupráce, zatímco druhé ano. To přidává analýze jedné takové transakce ještě více pochybností.

### Kdy použít transakce Stonewall a Stonewall x2?

Pokud chcete pro transakci použít nástroj pro ochranu osobních údajů, měla by být logika následující:


- Přednostně můžete zvolit možnost payjoin;
- Pokud obchodník nepodporuje payjoins, lze provést transakci ve spolupráci s jinou osobou mimo platbu pomocí struktury Stonewall x2;
- Pokud nemůžete najít nikoho, s kým byste mohli provést transakci Stonewall x2, můžete provést transakci Stonewall sami, která bude napodobovat chování transakce Stonewall x2.

### Jak používat transakce Stonewall a Stonewall x2?

Transakce Stonewall a Stonewall x2 jsou dostupné v aplikaci Samourai Wallet i v softwaru Sparrow Wallet.

Stejně jako v případě payjoins však po zatčení zakladatelů společnosti Samourai fungují transakce Stonewall x2 nyní pouze na základě ruční výměny PSBT mezi zúčastněnými stranami. Automatická výměna prostřednictvím Sorobanu bohužel v současné době není k dispozici.

Tento typ transakce můžete provést také ručně z libovolného softwaru bitcoinové peněženky.

V příští kapitole se budeme zabývat další relativně neznámou, ale velmi užitečnou technikou ochrany soukromí, která doplňuje již probrané.

https://planb.network/tutorials/privacy/on-chain/stonewall-033daa45-d42c-40e1-9511-cea89751c3d4
https://planb.network/tutorials/privacy/on-chain/stonewall-x2-05120280-f6f9-4e14-9fb8-c9e603f73e5b
## Odrazy

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>

Pro ochranu soukromí je obzvláště výhodné použití transakčních struktur bitcoinů, které přidávají nejednoznačnost při analýze řetězce, jako je například coinjoin. Jak jsme však uvedli v kapitole o payjoin, transakce coinjoin jsou v řetězci přirozeně identifikovatelné. Vzpomeňte si na analogii, kterou jsme zavedli mezi kryptografií a coinjoiny: při zašifrování souboru se třetí strana, která tento zašifrovaný soubor objeví, nemůže dostat k jeho obsahu, ale může jasně identifikovat, že došlo k úpravě souboru za účelem skrytí jeho obsahu. Totéž platí pro coinjoiny: když analytik zkoumá transakci coinjoinu, i když nemůže zjistit přímé vazby mezi vstupy a výstupy (a naopak), stále může rozpoznat, že pozorovaná transakce je coinjoin.

V závislosti na zamýšleném použití vaší mince po absolvování cyklů spojování mincí může být skutečnost, že mince prošla tímto procesem, problematická. Pokud například plánujete prodat svou minci na regulované burzovní platformě, ale ta nedávno prošla coinjoinem, nástroj pro analýzu řetězce platformy tuto skutečnost zjistí. Platforma pak může odmítnout přijmout váš UTXO, který prošel coinjoinem, nebo po vás dokonce může požadovat vysvětlení, přičemž hrozí, že vám bude účet pozastaven nebo že vám budou zmrazeny finanční prostředky. V některých případech může platforma vaše chování také nahlásit státním orgánům (například ve Francii to po poskytovatelích služeb digitálních aktiv (PSAN) požaduje TRACFIN).

Abychom tomu zabránili, potřebovali bychom nástroj, který by dokázal zahladit stopy minulosti bitcoinové mince a obnovit tak určitou formu zastupitelnosti. Právě to je cílem ricochetu.

### Co je to ricochet?

Ricochet je technika, která spočívá v provedení několika fiktivních transakcí vůči sobě (sweeping), aby se simuloval převod vlastnictví bitcoinů. Tento nástroj se liší od ostatních transakčních struktur, o kterých jsme hovořili, protože neumožňuje prospektivní anonymitu, ale spíše formu retrospektivní anonymity. Ricochet totiž umožňuje rozmazat specifika, která by mohla ohrozit zaměnitelnost bitcoinové mince kvůli její minulosti.

Aby se zamaskoval otisk, který na minci zanechala minulá událost, jako jsou například cykly spojování mincí, provede ricochet čtyři po sobě jdoucí transakce, při nichž si uživatel převede finanční prostředky na různé adresy.

Po této sekvenci transakcí nástroj ricochet nakonec směruje bitcoiny do jejich konečného cíle jako směnné platformy.

Cílem je vytvořit odstup, který ovlivní zaměnitelnost mince, například transakci coinjoin, a konečný akt utrácení, který by mohl tuto minci odmítnout kvůli její minulosti. Nástroje řetězové analýzy by tak mohly dojít k závěru, že po této události pravděpodobně došlo ke změně vlastníka, a považovat tuto minci za zaměnitelnou. V případě transakce coinjoin by pak nástroje analýzy řetězce mohly předpokládat, že se nejedná o stejnou osobu, která bitcoiny odeslala a provedla coinjoin, a je tedy zbytečné zahajovat kroky proti odesílateli.

### Proč to funguje?

Tváří v tvář této metodě ricochetu si lze představit, že software pro analýzu řetězců prohloubí své zkoumání nad rámec čtyř skoků. Tyto platformy však čelí dilematu při optimalizaci detekčního prahu. Potřebují stanovit hranici počtu skoků, po jejímž překročení připustí, že pravděpodobně došlo ke změně vlastníka a že by spojení s předchozí událostí (např. coinjoin) mělo být ignorováno.

Stanovení tohoto prahu se však ukazuje jako riskantní: každé rozšíření sledovaného počtu přeskočení exponenciálně zvyšuje objem falešně pozitivních výsledků, tj. osob nesprávně označených jako účastníci události, ačkoli transakci provedl někdo jiný. Tento scénář představuje pro tyto společnosti větší riziko, protože falešně pozitivní výsledky vedou k nespokojenosti, která může postižené zákazníky přivést ke konkurenci. Z dlouhodobého hlediska vede příliš vysoký práh detekce k tomu, že platforma ztrácí více zákazníků než její konkurenti, což může ohrozit její přežití. Proto je pro tyto platformy komplikované zvyšovat počet pozorovaných skoků a 4 je často dostatečný počet pro jejich analýzu.

Pozorovaný jev je do jisté míry analogický teorii šesti stupňů odloučení.

Teorie šesti stupňů oddělenosti předpokládá, že každý člověk na Zemi je spojen s každým jiným prostřednictvím řetězce poznání, který zahrnuje nejvýše šest prostředníků. Stačilo by projít řadou šesti lidí, z nichž každý by osobně znal dalšího, abychom se dostali ke kterémukoli člověku na světě.

U transakcí s bitcoiny se setkáváme s podobným jevem. Při zpětném sledování dostatečného počtu transakcí s bitcoiny nevyhnutelně narazíme na coinjoin. Metoda ricochet využívá tohoto principu tím, že používá více skoků, než mohou směnné platformy rozumně sledovat. Pokud se platformy rozhodnou sledovat více transakcí, je pak možné jednoduše přidat další hop a toto opatření obejít.

### Kdy a jak používat ricochet?

Nejběžnější případ použití ricochetu nastává, když je třeba skrýt předchozí účast v coinjoinu na UTXO, které vlastníte. V ideálním případě je nejlepší vyhnout se převodu bitcoinů, které prošly coinjoinem, na regulované subjekty. Nicméně v případě, že se člověk ocitne bez jiných možností, zejména při naléhavé potřebě likvidace bitcoinů do fiat měny, nabízí ricochet účinné řešení.

Tato metoda je účinná nejen u spojů mincí, ale i u jiných značek, které by mohly ohrozit zaměnitelnost mince.

S nápadem na tuto metodu ricochet původně přišly týmy společnosti Samourai Wallet, které ji integrovaly do své aplikace, aby proces automatizovaly. Služba je na Samourai zpoplatněna, protože za ricochet se kromě poplatků za těžbu platí také poplatek za službu ve výši 100 000 sátů. Proto se její použití doporučuje spíše pro převody významných částek.

Aplikace Samourai nabízí dvě varianty ricochetu:


- Pokročilý ricochet neboli "rozložené doručení", jehož výhodou je rozložení poplatků za služby společnosti Samourai na pět po sobě jdoucích transakcí. Tato možnost také zajišťuje, že každá transakce je přenesena v samostatném čase a zaznamenána v jiném bloku, což umožňuje co nejvěrněji napodobit chování při změně vlastníka. Ačkoli je tento způsob pomalejší, je vhodnější pro ty, kteří nespěchají, protože maximalizuje účinnost ricochetu posílením jeho odolnosti vůči analýze řetězce;
- Klasický ricochet, který je určen k rychlému provedení operace přenosem všech transakcí v krátkém časovém úseku. Tato metoda proto nabízí méně soukromí a menší odolnost proti analýze než pokročilá metoda. Měla by se používat pouze pro naléhavá podání.

Recochet spočívá v jednoduchém zasílání bitcoinů sobě samému. Je zcela možné provést ricochet ručně v jakémkoli softwaru peněženky, aniž by bylo nutné použít specializovaný nástroj. Stačí si později převést stejnou minci, pokaždé s použitím nové prázdné adresy.

V následující kapitole prozkoumáme několik technik tajných převodů majetku. Tyto metody se zásadně liší od těch, které jsme zkoumali doposud, a to jak z hlediska způsobu fungování, tak z hlediska jejich výsledků.

https://planb.network/tutorials/privacy/on-chain/ricochet-e0bb1afe-becd-44a6-a940-88a463756589
## Tajné převody majetku

<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>

Mezi techniky ochrany soukromí v bitcoinech patří tajný převod vlastnictví. Cílem této metody je převést vlastnictví bitcoinů z jedné osoby na druhou a naopak, aniž by tato transakce byla explicitně viditelná v blockchainu. Pojďme si společně prostudovat různé dostupné techniky a jejich výhody a nevýhody.

### Výměna mincí

CoinSwap je založen na poměrně jednoduchém konceptu: využívá chytré smlouvy k usnadnění převodu vlastnictví bitcoinů mezi dvěma uživateli, aniž by byla nutná důvěra a aniž by tento převod byl explicitně viditelný v blockchainu.

Představme si zjednodušený příklad s Alicí a Bobem. Alice má 1 BTC zabezpečený soukromým klíčem $A$ a Bob má také 1 BTC zabezpečený soukromým klíčem $B$. Teoreticky by si mohli vyměnit své soukromé klíče prostřednictvím externího komunikačního kanálu a provést tajný převod.

Tato naivní metoda však představuje vysoké riziko z hlediska důvěryhodnosti. Nic nebrání tomu, aby si Alice po výměně ponechala kopii soukromého klíče $A$ a později ji použila ke krádeži bitcoinů, jakmile bude klíč v Bobově držení.

Navíc neexistuje žádná záruka, která by Alici zabránila přijmout Bobův soukromý klíč $B$ a nikdy na oplátku neposlat svůj soukromý klíč $A$. Tato výměna tedy závisí na přílišné důvěře mezi stranami a ukazuje se jako neúčinná při zajišťování tajného převodu vlastnictví bezpečným způsobem.

Abychom tyto problémy vyřešili a umožnili výměnu mezi stranami, které si navzájem nedůvěřují, můžeme místo toho použít systémy chytrých smluv. Inteligentní smlouva je program, který se spouští automaticky při splnění předem definovaných podmínek, což v našem případě zajišťuje, že výměna majetku probíhá automaticky, aniž by byla vyžadována vzájemná důvěra.

K tomu můžeme použít HTLC (_Hash Time-Locked Contracts_) nebo PTLC (_Point Time-Locked Contracts_). Tyto dva protokoly fungují podobně a využívají systém časového zámku, který zajišťuje úspěšné dokončení nebo úplné zrušení výměny, čímž chrání integritu prostředků obou stran. Hlavní rozdíl mezi HTLC a PTLC spočívá v tom, že HTLC používají k zabezpečení transakce hashe a předobrazy, zatímco PTLC používají adaptivní podpisy.

Ve scénáři výměny mincí pomocí HTLC nebo PTLC mezi Alicí a Bobem probíhá výměna bezpečným způsobem: buď se podaří a každý z nich obdrží BTC toho druhého, nebo se nepodaří a každý si ponechá své vlastní BTC. Není tedy možné, aby některá ze stran podváděla nebo ukradla BTC té druhé.

> hTLC jsou také mechanismem, který slouží k bezpečnému směrování plateb prostřednictvím obousměrných kanálů sítě Lightning Network._
> Použití adaptivních podpisů je v této souvislosti obzvláště zajímavé, protože umožňuje obejít tradiční skripty (tento mechanismus se někdy označuje jako "_scriptless scripts_"). Tato funkce pomáhá snížit poplatky spojené s výměnou. Další významnou výhodou adaptivních podpisů je, že nevyžadují použití společného hashe pro obě strany transakce, čímž se u některých typů výměn zamezí odhalení přímého spojení mezi nimi.
### Adaptivní podpisy

Adaptivní podpisy jsou kryptografickou metodou, která spojuje platný podpis s dalším podpisem, tzv. "adaptivním podpisem", a odhaluje tak tajnou část dat. Tento mechanismus je navržen tak, že znalost dvou z následujících tří prvků: platného podpisu, adaptivního podpisu a tajného údaje umožňuje odvodit třetí chybějící prvek. Zajímavou vlastností této metody je, že pokud známe adaptivní podpis našeho protějšku a konkrétní bod na eliptické křivce spojený s tajemstvím použitým k výpočtu tohoto adaptivního podpisu, můžeme odvodit náš vlastní adaptivní podpis, který bude kompatibilní s týmž tajemstvím, aniž bychom měli přímý přístup k samotnému tajemství.

Při výměně mincí umožňuje použití adaptivních podpisů současné zveřejnění dvou citlivých informací mezi účastníky, čímž odpadá nutnost vzájemné důvěry. Uveďme příklad, který tento proces ilustruje na příkladu Alice a Boba, kteří si chtějí vyměnit vlastnictví 1 BTC každý, ale navzájem si nedůvěřují. K eliminaci potřeby důvěry při této výměně použijí adaptivní podpisy. Zde je uveden jejich postup:


- Alice zahájí výměnu vytvořením transakce $m_A$, která odešle Bobovi 1 BTC. Pomocí svého soukromého klíče $p_A$ ($P_A = p_A \cdot G$), nonce $n_A$ ($N_A = n_A \cdot G$) a tajemství $t$ ($T = t \cdot G$) vygeneruje podpis $s_A$, kterým tuto transakci potvrdí:

$$s_A = n_A + t + H(N_A + T \paralelní P_A \paralelní m_A) \cdot p_A$$


- Alice vypočítá adaptivní podpis $s_A'$ odečtením tajemství $t$ od svého pravého podpisu $s_A$:

$$s_A' = s_A - t$$


- Alice pošle Bobovi svůj adaptivní podpis $s'_A$, svou nepodepsanou transakci $m_A$, bod odpovídající tajemství ($T$) a bod odpovídající nonce ($N_A$). Tyto prvky tvoří to, čemu se říká "_adaptér_" Je důležité poznamenat, že pouze s těmito informacemi nemůže Bob získat Alicin BTC.
- Bob má však možnost ověřit, že se ho Alice nesnaží okrást. Za tímto účelem zkontroluje, zda Alicin adaptivní podpis $s_A'$ skutečně odpovídá navrhované transakci $m_A$. Pokud je následující rovnice správná, může si být jistý, že Alicin adaptivní podpis je platný:

$$s_A' \cdot G = N_A + H(N_A + T \paralelní P_A \paralelní m_A) \cdot P_A$$


- Toto ověření poskytuje Bobovi dostatečnou jistotu, aby mohl s jistotou pokračovat ve výměně. Poté vytvoří vlastní transakci $m_B$, jejímž cílem je poslat Alici 1 BTC, a vygeneruje svůj adaptivní podpis $s_B'$, který bude rovněž spojen se stejným tajemstvím $t$. V tomto okamžiku zná hodnotu $t$ pouze Alice, Bob zná pouze odpovídající bod $T$, který mu Alice předala:

$$s_B' = n_B + H(N_B + T \paralelní P_B \paralelní m_B) \cdot p_B$$


- Bob předá Alici svůj adaptivní podpis $s_B'$, svou nepodepsanou transakci $m_B$, jakož i bod odpovídající tajemství ($T$) a bod odpovídající nonce ($N_B$). Alice, která zná tajemství $t$, může nyní zkombinovat Bobův adaptivní podpis $s_B'$ s tímto tajemstvím a vygenerovat platný podpis $s_B$ pro transakci $m_B$, která jí převede Bobovy BTC:

$$s_B = s_B' + t$$

$$(s_B' + t) \cdot G = N_B + T + H(N_B + T \paralelní P_B \paralelní m_B) \cdot P_B$$


- Alice přenese tuto podepsanou transakci $m_B$ do blockchainu Bitcoinu, aby získala BTC slíbené Bobem. Když Bob uvidí tuto transakci v blockchainu, může z ní vyčíst podpis $s_B = s_B' + t$. S touto informací je pak Bob schopen izolovat slavné tajemství $t$, které potřeboval:

$$t = (s_B' + t) - s_B' = s_B - s_B'$$


- A toto tajemství $t$ bylo ve skutečnosti jediným chybějícím prvkem, který Bobovi umožnil vygenerovat platný podpis $s_A$ z Alicina adaptérového podpisu $s_A'$. Tento podpis umožňuje ověřit platnost transakce $m_A$, která posílá BTC od Alice Bobovi. Bob poté vypočítá $s_A$ a následně transakci $m_A$ odešle do blockchainu:

$$s_A = s_A' + t$$

$$(s_A' + t) \cdot G = N_A + T + H(N_A + T \paralelní P_A \paralelní m_A) \cdot P_A$$

Shrňme si, jak funguje podpisový adaptér ve směnárně mincí. Na začátku Alice pošle Bobovi nepodepsanou transakci spolu s adaptérem, který Bobovi umožní ověřit, že později odhalené tajemství mu umožní přístup k bitcoinům. Bob na oplátku pošle Alici svou nepodepsanou transakci a adaptér. Alice pak může dokončit Bobovu transakci a získat zpět bitcoiny odesláním platné transakce s použitím tajemství. Když je tato transakce zveřejněna v blockchainu, Bob má možnost získat tajemství, a tím odemknout Alicinu transakci. V důsledku toho, pokud Alice iniciuje převod Bobových bitcoinů, může naopak on získat přístup k Aliciným bitcoinům, aniž by byla vyžadována vzájemná důvěra.

Je důležité poznamenat, že výměnu mincí poprvé navrhl [Gregory Maxwell v říjnu 2013 na BitcoinTalk](https://bitcointalk.org/index.php?topic=321228.0).

### Atomová burza

Podobně jako u výměny mincí a s využitím stejných typů chytrých smluv je možné provádět i atomické výměny. Atomická výměna umožňuje přímou výměnu různých kryptoměn, například BTC a XMR, mezi dvěma uživateli bez nutnosti důvěry nebo zásahu zprostředkovatele. Tyto výměny se nazývají "atomické", protože mají pouze dva možné výsledky: buď se výměna podaří a obě strany jsou spokojené, nebo se nezdaří a každá si ponechá své původní kryptoměny, čímž odpadá potřeba důvěry v druhou stranu.

![BTC204](assets/fr/197.webp)

Atomová směnárna a směnárna mincí mají podobný způsob fungování a nabízejí stejné výhody i nevýhody z hlediska ochrany soukromí. Z pohledu Bitcoinu je atomová výměna ve skutečnosti srovnatelná s výměnou mincí prováděnou ve dvou krocích. Nejprve vyměníme svůj BTC za jinou kryptoměnu a poté lze tuto kryptoměnu směnit za jiné BTC. Nakonec získáme BTC jiného uživatele. Proto v analýze otázek ochrany soukromí řadím tyto dva protokoly do kategorie tajných výměn majetku.

![BTC204](assets/fr/198.webp)

Na rozdíl od burzy mincí však může u atomové burzy docházet k nerovnováze, pokud jde o dostupnou likviditu, zejména u burz BTC/XMR. Obecně je snazší vyměnit bitcoin za altcoin, protože existuje velká poptávka po bitcoinu, což udržuje prémie za tento směr konverze nízké. Výměna altcoinů za BTC však může být kvůli nižší poptávce složitější, což často vede k velmi vysokým prémiím.

A konečně, pokud atomická výměna zahrnuje bitcoiny v řetězci a bitcoiny v síti Lightning, označujeme ji jako "ponornou výměnu"

### Je to opravdu užitečné?

Tajné převody vlastnictví, jako jsou výměny mincí a atomové výměny, mají tu výhodu, že obelstí heuristiku analýzy řetězce. Tyto metody mohou vyvolat dojem, že se transakce týkají stejného uživatele, i když skutečné vlastnictví změnilo majitele. Hlavní nevýhodou těchto metod však je, že jsou bez použití další techniky k narušení historie mincí velmi riskantní.

Když Alice s Bobem provede výměnu mincí nebo atomickou výměnu, vymění si vlastnické právo ke svým bitcoinům za Bobovy bitcoiny. V případě atomického swapu výměna zahrnuje altcoin, ale princip zůstává stejný. Alice tedy skončí s mincí $B$ a Bob s mincí $A$. To přidává pochybnosti v analýze řetězce, ale historie mincí zůstává dohledatelná. Pokud analytik zkoumá minci $A$, může dohledat předchozí aktivity Alice a naopak u mince $B$.

Z pohledu Alice hrozí, že historie mince $B$ může být některými subjekty považována za podezřelou. Pokud by například Bob získal minci $B$ při trestné činnosti, například při hackerském útoku, zůstala by tato mince spojena s jeho nezákonnou činností. Alice by se pak mohla ocitnout v držení mince, kterou by nemohla převést na regulované obchodní platformy, aniž by riskovala zmrazení svých prostředků, nebo by dokonce mohla být obviněna z Bobových trestných činů, ačkoli s nimi nemá nic společného.

A samozřejmě metody ochrany soukromí, jako je výměna mincí nebo výměna atomů, mají v oblibě zločinci, jejichž finanční prostředky jsou monitorovány úřady. Tyto protokoly jim dávají možnost zbavit se svých monitorovaných bitcoinů výměnou za dokonale zaměnitelné bitcoiny. To jim také umožňuje vytvářet diverzi tím, že úřady nasměrují na jiné uživatele. Pro tyto lidi tak existuje dvojí užitečnost.

V případě coinjoin je historie mince přerušena i v případě, že je vaše mince smíchána s monitorovanými bitcoiny, což poskytuje formu věrohodného popření, která neexistuje v tajných protokolech pro převod majetku, jako je výměna mincí nebo atomová výměna.

Pokud se chce Alice vyhnout jakémukoli riziku, musí nutně použít metodu, která naruší historii mince $B$, například ji prověří pomocí coinjoins. To vyvolává otázku o užitečnosti kombinace tajného převodu vlastnictví a coinjoinu. Coinjoin tím, že přeruší historii mince, již Alici poskytuje dostatečnou úroveň soukromí. Můj názor je tedy takový, že pokud Alice usiluje o ochranu svého soukromí, bylo by rozumnější přistoupit přímo k coinjoinu než se zapojit do výměny mincí, po níž následuje coinjoin.

Aby byly metody tajného převodu vlastnictví skutečně účinné a zamezily riziku propojení historie uživatele $A$ s uživatelem $B$, bylo by paradoxně nutné, aby jejich použití bylo všeobecně známé. Pokud je výměna mincí masově využívána a úřady o této běžné praxi vědí, pak by bylo možné vytvořit věrohodnou formu popření. Dokud však bude používání těchto převodů okrajové, domnívám se, že tyto metody budou pro uživatele i nadále příliš rizikové.

Dosud jsme se zabývali především metodami ochrany soukromí na úrovni samotných transakcí. V příští kapitole se budeme zabývat otázkami na úrovni sítě a šířením transakcí.

## Ochrana soukromí v síti P2P

<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>

Ve 4. části jsme se zabývali důležitostí používání úplného uzlu pro ochranu soukromí vašich transakcí. Je však důležité si uvědomit, že samotný uzel může být předmětem útoků, které se snaží získat informace o vašich aktivitách. V této kapitole se proto budeme zabývat různými opatřeními na ochranu soukromí, a to nikoli na úrovni samotných transakcí nebo toků bitcoinů, ale na úrovni sítě.

### Pampeliška

Jedním ze způsobů, jak se vyhnout různým deanonymizačním útokům, je použití navrženého systému Dandelion. Tento přenosový protokol byl formalizován v BIP156, ale nikdy nebyl implementován na Bitcoinu. Myšlenkou Dandelionu je zlepšit soukromí směrování transakcí v síti Bitcoin a zmařit tak různé formy útoků. Jeho hlavním cílem je skrýt zdrojový uzel, který transakci v síti původně přenáší. Odhalení tohoto uzlu by mohlo spojit transakci v Bitcoinech s konkrétní IP adresou (pokud uzel funguje v nešifrované síti), a poskytnout tak vstupní bod pro analýzu řetězce.

Toto spojení mezi aktivitou na Bitcoinu a IP adresou představuje významné riziko pro soukromí uživatelů. Řada subjektů totiž může snadno propojit IP adresu s osobní identitou. Mezi ně pozoruhodně patří vlády a poskytovatelé internetových služeb. Tyto informace se navíc mohou stát veřejně přístupnými, například pokud jsou IP adresa a osobní údaje odhaleny v důsledku úniku dat při nabourání se do databáze webových stránek.

Při standardním fungování Bitcoinu se transakce vytvořené uživatelem v jeho softwarové peněžence přenášejí do jeho osobního uzlu. Tento uzel okamžitě předá novou transakci všem peerům, ke kterým je připojen.

Tito kolegové pak transakci ověří, aby se ujistili, že splňuje pravidla konsensu a místní pravidla standardizace. Po ověření každý peer zase předá transakci svým peerům a tak dále.

Rozložení transakcí čekajících na začlenění do bloku probíhá poměrně vyváženě a statisticky předvídatelně. Tato zranitelnost může být zneužita koluzními špionážními uzly, které spolupracují na monitorování a analýze sítě s cílem určit první uzel, který transakci přenese. Pokud pozorovatel dokáže lokalizovat zdrojový uzel, může předpokládat, že transakce pochází od provozovatele tohoto uzlu. Tento typ pozorování může spojit transakce, obvykle anonymní, s konkrétními IP adresami.

Cílem BIP156 je tento problém řešit. Za tímto účelem zavádí další fázi přenosu nové transakce, která má zachovat anonymitu před rozsáhlým veřejným šířením. Pampeliška nejprve používá "kmenovou" fázi, kdy je transakce odeslána náhodnou cestou uzlů.

Transakce je poté přenesena do celé sítě ve fázi "fluff" (blowhole).

Stonek a pampeliška odkazují na chování při šíření transakce v síti, které připomíná tvar pampelišky.

Špehovací uzly tak mohou potenciálně vysledovat transakci zpět k uzlu, který zahájil fázi vyfukování (masivní přenos), ale tento uzel není tím, který transakci přenesl jako první, protože ji přijal od posledního uzlu v kmeni. Pokud špionážní uzly nemohou vystopovat kmen, nemohou identifikovat ani zdrojový uzel.

Dokonce i v přítomnosti špionážních uzlů ve fázi kmene vždy zůstávají pochybnosti, protože jakmile se v difuzním grafu setkají s poctivým uzlem, nemohou špioni určit, zda je tento uzel původním zdrojem, nebo pouze prostředníkem.

Tento způsob směrování ztěžuje zpětné dohledání zdrojového uzlu, což komplikuje dohledání transakce v síti až k jejímu původu. Dandelion tak zlepšuje soukromí tím, že omezuje schopnost protivníků deanonymizovat síť. Tato metoda je ještě účinnější, pokud transakce během fáze "stem" prochází uzlem, který šifruje svou síťovou komunikaci, jako je tomu u Tor nebo P2P Transport V2.

BIP156 nebyl integrován do jádra bitcoinu a v současné době je klasifikován jako "zamítnutý" Hlavní obavy ohledně tohoto protokolu spočívají v tom, že během kmenové fáze musí být transakce před verifikací předány zprostředkujícími uzly. Jak jsme viděli, v běžném modelu Bitcoinu každý uzel nejprve transakci ověří a teprve poté ji předá svým kolegům. Pokud transakce nesplňuje pravidla konsensu nebo lokální standardizace uzlu, je ignorována a není předána. Tento proces je důležitý pro zmaření DoS útoků, protože do celé sítě jsou předávány pouze platné transakce. Neplatné transakce, potenciálně hromadně generované za účelem přetížení sítě, jsou zastaveny v prvním uzlu, na který narazí, a dále se nešíří. Hlavním rizikem protokolu Dandelion je, že by tento nový protokol mohl zavést nové vektory pro útoky DoS tím, že by umožnil přenos neplatných transakcí přes část sítě.

### P2P Transport V2

P2P Transport V2 je další síťový protokol představený v BIP324. Jedná se o novou verzi transportního protokolu P2P Bitcoinu, která obsahuje oportunistickou kryptografii pro zlepšení důvěrnosti a bezpečnosti komunikace mezi uzly.

Cílem tohoto vylepšení je vyřešit několik problémů základní verze protokolu P2P. Zaprvé činí vyměňovaná data pro pasivního pozorovatele nerozeznatelnými od jiných typů dat kolujících po internetu. Hlavním cílem je zabránit vládám, poskytovatelům internetových služeb nebo poskytovatelům VPN v masivním sledování uživatelů Bitcoinu. Těmto subjektům to také komplikuje úkol zjistit, zda je uživatel internetu zároveň uživatelem Bitcoinu, tj. zda provozuje plnohodnotný uzel.

P2P V2 také pomáhá snižovat rizika cenzury a útoků tím, že detekuje specifické vzory v datových paketech. To komplikuje a prodražuje provádění různých typů Sybilových útoků na úrovni sítě. K útoku Sybil dochází, když aktér vytvoří více falešných identit, aby získal neoprávněnou výhodu. V kontextu sítě Bitcoin se to často projevuje tak, že aktér ovládá velký počet kompletních uzlů a agresivně je využívá k násobení spojení. Sybilovy útoky mohou být pasivní, jejichž cílem je shromažďovat informace a ohrozit důvěrnost uživatelů, nebo aktivní, v podobě útoků typu Eclipse. Ty izolují konkrétní uzel od zbytku sítě a umožňují mu cenzurovat uživatele nebo měnit přijímaná data. V neposlední řadě P2P V2 zdražuje a usnadňuje odhalování útoků _Man-In-The-Middle_ (MITM).

Šifrování implementované P2P V2 nezahrnuje ověřování, aby nepřidávalo zbytečnou složitost a neohrožovalo bezpříznakovou povahu síťového připojení. Tento nový transportní protokol P2P však poskytuje lepší zabezpečení proti pasivním útokům a výrazně prodražuje a znemožňuje odhalení aktivních útoků. Zavedení pseudonáhodného datového toku do síťových zpráv komplikuje úlohu útočníkům, kteří chtějí cenzurovat nebo manipulovat s komunikací.

Transport P2P V2 byl zahrnut jako volitelná možnost (ve výchozím nastavení vypnutá) do verze 26.0 jádra bitcoinu, která byla nasazena v prosinci 2023. Ve výchozím nastavení pak byl povolen ve verzi 27.0 v dubnu 2024. Lze ji změnit pomocí volby `v2transport=` v konfiguračním souboru.

### Tor

Poměrně jednoduchým řešením, jak se vyhnout riziku ztráty důvěrnosti pro uzel na úrovni sítě, je spustit jej celý pod Tor. Tor je síť relay serverů (uzlů), která anonymizuje původ TCP spojení přes internet. Funguje tak, že data zapouzdřuje do několika vrstev šifrování. Každý relay uzel odstraní jednu vrstvu, aby odhalil adresu dalšího uzlu, dokud není dosaženo konečného cíle. Síť Tor zajišťuje anonymitu tím, že zprostředkujícím uzlům znemožňuje znát původ i cíl dat, což pozorovateli velmi ztěžuje sledování činnosti uživatele.

Tor tedy nejen šifruje komunikovaná data, ale také umožňuje maskovat původ a cíl komunikace. Používáním Toru pro komunikaci s osobními uzly zlepšujeme soukromí našich transakcí: poskytovatel internetových služeb (ISP) nemůže komunikaci dešifrovat a ostatní uzly v síti Bitcoin nemohou identifikovat IP adresu zdrojového uzlu. Kromě toho Tor také skrývá používání Bitcoinu před poskytovatelem internetového připojení.

Hlavní riziko spojené s touto metodou spočívá v tom, že Tor je protokol nezávislý na Bitcoinu. Pokud máte uzel Bitcoinu pod protokolem Tor a Tor přestane fungovat, váš uzel Bitcoinu již nebude schopen komunikovat.

Je také důležité si uvědomit, že komunikace v síti Tor je pomalejší. Tato latence je nepříjemná zejména při počátečním spuštění uzlu, protože stahování počátečních bloků (IBD) vyžaduje hodně komunikace. V důsledku toho může být počáteční synchronizace se sítí Bitcoin při použití Toru výrazně delší. Je také možné provést IBD v otevřené síti a aktivovat Tor později. Tato metoda sice prozradí vašemu poskytovateli internetových služeb existenci vašeho uzlu Bitcoin, ale po přepnutí na Tor chrání vaše osobní informace o transakcích.

Poté, co jsem prozkoumal různé metody ochrany soukromí na síťové úrovni, chci v dalších kapitolách představit dvě elegantní řešení, jak zabránit opakovanému použití adres: BIP47 a tiché platby.

## BIP47 a opakovaně použitelné platební kódy

<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>

Jak jsme viděli v části 3, opakované použití adres je vážnou překážkou pro soukromí uživatelů v protokolu Bitcoin. Pro zmírnění těchto rizik se důrazně doporučuje generovat novou přijímací adresu pro každou novou platbu přijatou do peněženky. Ačkoli je dnes generování nové adresy zjednodušeno používáním moderního softwaru a hierarchických deterministických peněženek, může se tento postup zdát neintuitivní.

V tradičním bankovním systému jsme například zvyklí sdílet svůj IBAN, který zůstává stále stejný. Jakmile ho někomu sdělíme, může nám poslat více plateb, aniž by s námi musel znovu komunikovat. Neobanky nabízejí i modernější možnosti, jako je používání unikátních e-mailových adres u služby PayPal nebo RevTags u služby Revolut. I mimo finanční oblast jsou naše každodenní identifikátory, jako je poštovní adresa, telefonní číslo a e-mailová adresa, jedinečné a trvalé. Nemusíme je obnovovat při každé nové interakci.

Bitcoin však funguje jinak: pro každou příchozí transakci je nutné vygenerovat novou přijímací adresu. Tento kompromis mezi snadností použití a soukromím sahá až k samotným počátkům bílé knihy Bitcoinu. Již od zveřejnění první verze svého dokumentu na konci roku 2008 nás Satoshi Nakamoto na toto riziko upozorňoval:

**"_Jako další firewall by se pro každou transakci mohl použít nový pár klíčů, aby nebyly spojeny se společným vlastníkem._"**

Existuje řada metod, jak přijímat více plateb na jeden identifikátor, aniž by došlo k opakovanému použití adresy. Každá z těchto metod má své vlastní kompromisy a nevýhody. Mezi tyto metody patří BIP47, návrh vyvinutý Justusem Ranvierem a zveřejněný v roce 2015. Cílem tohoto návrhu je vytvořit opakovaně použitelné platební kódy, které umožňují více transakcí stejné osobě a zároveň zabraňují opakovanému použití adresy. BIP47 se v podstatě snaží nabídnout intuitivní platební systém jako jedinečný identifikátor a zároveň zachovat soukromí transakcí.

![BTC204](assets/fr/212.webp)

BIP47 přímo nezlepšuje soukromí uživatelů, protože platba BIP47 nabízí stejnou úroveň soukromí jako klasická transakce Bitcoin s použitím nových adres. Umožňuje však pohodlnější a intuitivnější používání Bitcoinu, což je snadnost, která by za normálních okolností musela ohrozit soukromí. Díky BIP47 dosahuje toto snadné používání stejné úrovně soukromí jako klasická transakce. Proto je BIP47 cenným nástrojem pro zachování soukromí.

Původně byl BIP47 návrhem, který měl být integrován do jádra Bitcoinu, ale nikdy nebyl přijat. Některý software se však rozhodl implementovat jej nezávisle na aplikační úrovni. Týmy peněženky Samourai tak vyvinuly vlastní implementaci BIP47 nazvanou "PayNym"

### Obecná zásada BIP47 a PayNym

Cílem BIP47 je umožnit přijímání četných plateb, aniž by došlo k opakovanému použití adresy. Je založen na použití opakovaně použitelného platebního kódu, který umožňuje různým odesílatelům odeslat více plateb na jeden kód patřící jinému uživateli. Příjemce tak nemusí pro každou transakci uvádět novou adresu, což výrazně usnadňuje jejich výměnu a zároveň zachovává jejich soukromí.

![BTC204](assets/it/66/4.webp)

Uživatel pak může svůj platební kód volně sdílet na sociálních sítích nebo na svých webových stránkách, aniž by riskoval ztrátu soukromí, na rozdíl od klasické přijímací adresy nebo veřejného klíče.

K provedení transakce musí mít obě strany peněženku Bitcoin s implementací BIP47, například PayNym na Samourai Wallet nebo Sparrow Wallet. Společné použití jejich platebních kódů mezi nimi vytvoří tajný kanál. Aby se tento kanál efektivně vytvořil, musí odesílatel provést specifickou transakci v bitcoinovém blockchainu, známou jako "notifikační transakce" (podrobněji se jí budu věnovat později).

Kombinace platebních kódů obou uživatelů vytváří sdílené tajemství, které následně umožňuje vytvoření velkého počtu jedinečných adres pro příjem bitcoinů (přesně 2^32, tedy asi 4 miliardy). Platby prováděné prostřednictvím BIP47 tedy ve skutečnosti nejsou adresovány na samotný platební kód, ale na klasické přijímací adresy odvozené z platebních kódů zúčastněných uživatelů.

Platební kód pak slouží jako virtuální identifikátor odvozený od seedu peněženky. V hierarchické odvozovací struktuře portfolia je platební kód umístěn na úrovni 3, tj. na úrovni účtu.

![BTC204](assets/it/66/5.webp)

Cíl odvození pro BIP47 je identifikován indexem `47` (`0x8000002F`), který odkazuje na BIP47. Příklad odvozovací cesty pro opakovaně použitelný platební kód je následující:

```plaintext
m/47'/0'/0'/
```

Abyste si mohli udělat představu o tom, jak vypadá kód platby, zde je můj kód:

```plaintext
M8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Tento kód lze také zakódovat do QR kódu pro snadnou komunikaci, stejně jako klasickou přijímací adresu.

Pokud jde o PayNym Bots, tito roboti, kteří se někdy objevují na Twitteru, jsou vizuální reprezentací platebního kódu vytvořeného společností Samourai Wallet. Jsou generovány pomocí hashovací funkce, která jim dodává téměř jedinečnost. Zobrazují se jako malý řetězec znaků začínající na `+`:

```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

Tyto avatary lze také znázornit jako obrázky:

![BTC204](assets/fr/215.webp)

Ačkoli tito roboti nemají v rámci BIP47 specifickou technickou funkci, hrají roli při usnadňování interakce mezi uživateli tím, že nabízejí snadno rozpoznatelnou vizuální identitu.

---
*V následujících částech této kapitoly věnovaných protokolu BIP47 se budeme podrobně zabývat jeho fungováním a zaměříme se zejména na použité kryptografické metody. Pro úplné pochopení těchto spíše technických výkladů je nejprve nezbytné porozumět struktuře peněženek HD, procesům odvozování klíčů a základním principům kryptografie založené na eliptických křivkách. Pokud se chcete o těchto pojmech dozvědět více, je k dispozici další bezplatný kurz sítě Plan ₿:*

https://planb.network/courses/46b0ced2-9028-4a61-8fbc-3b005ee8d70f
*Vřele vám doporučuji, abyste se jím řídili, protože pochopení technického fungování BIP47 vám pomůže mnohem lépe porozumět dalším podobným návrhům, které budeme probírat v následujících kapitolách.*

---
### Opakovaně použitelný platební kód

Jak již bylo zmíněno, opakovaně použitelný platební kód se nachází na 3. úrovni peněženky HD, takže je srovnatelný s `xpubem`, a to jak svou pozicí ve struktuře peněženky, tak svou rolí.

80bajtový kód platby je rozdělen takto:


- Byte `0`: Verze**. Pro první verzi BIP47 je tento bajt nastaven na `0x01`;
- Byte `1`: Bitové pole**. Tento prostor je vyhrazen pro vložení dalších údajů při specifickém použití. Pro standardní použití s PayNym je tento bajt definován jako `0x00`;
- Byte `2`: Parita `y`**. Tento bajt je `0x02` nebo `0x03`, což udává, zda je pořadí veřejného klíče sudé nebo liché, protože se používá komprimovaný veřejný klíč;
- Od bajtu `3` do bajtu `34`: Hodnota `x`**. Tyto bajty představují absenci veřejného klíče. Konkatenace `x` a parity `y` tvoří kompletní komprimovaný veřejný klíč;
- Od bajtu `35` do bajtu `66`: Řetězový kód**. Tento prostor obsahuje řetězový kód spojený s veřejným klíčem;
- Od bajtu `67` do bajtu `79`: Plnění**. Tento prostor je určen pro možný budoucí vývoj. V současné verzi jsou zde jednoduše umístěny nuly, aby bylo dosaženo velikosti 80 bajtů požadované pro výstup `OP_RETURN`.

Zde je hexadecimální reprezentace mého opakovaně použitelného platebního kódu, který jsem již uvedl v předchozí části:

```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

![BTC204](assets/it/66/7.webp)

Především je nutné přidat na začátek předponu `P`, aby bylo zřejmé, že se jedná o kód platby. Tento bajt je reprezentován znakem `0x47`:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

Nakonec se pro zajištění integrity platebního kódu provede výpočet kontrolního součtu pomocí funkce `HASH256`, která spočívá v dvojitém hašování pomocí funkce `SHA256`. První čtyři bajty, které jsou výsledkem tohoto hashování, se pak spojí na konci platebního kódu:

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

Po dokončení těchto kroků je platební kód připraven. Jediným zbývajícím krokem je jeho převod do základu 58, abyste získali jeho konečnou verzi:

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Během tohoto procesu vytváření platebního kódu používáme komprimovaný veřejný klíč a řetězový kód. Oba jsou odvozeny deterministickou a hierarchickou derivací ze semínka peněženky. Odvozovací cesta, která se k tomu používá, je následující:

```plaintext
m/47'/0'/0'/
```

Při generování komprimovaného veřejného klíče a přidruženého řetězového kódu pro opakovaně použitelný platební kód začneme výpočtem hlavního soukromého klíče ze seedu peněženky. Poté přejdeme k odvození dvojice dceřiných klíčů pomocí indexu `47 + 2^31` (zesílená derivace). Po tomto kroku následují další dvě po sobě jdoucí odvození dvojic dceřiných klíčů, vždy s použitím indexu `2^31` (zesílené odvození).

### Výměna klíčů s eliptickou křivkou Diffie-Hellman (ECDH)

Kryptografický protokol, který je základem protokolu BIP47, se označuje zkratkou ECDH, což znamená _Elliptic-Curve Diffie-Hellman_. Tato metoda je variantou původní Diffie-Hellmanovy výměny klíčů.

Diffie-Hellmanův protokol byl představen v roce 1976 a umožňuje dvěma stranám, z nichž každá je vybavena párem klíčů (veřejným a soukromým), dohodnout se na společném tajemství, i když komunikují výhradně veřejným, nezabezpečeným kanálem.

![BTC204](assets/it/66/10.webp)

Toto sdílené tajemství (zde modrý klíč) lze pak použít pro další operace. Typicky lze toto sdílené tajemství použít k šifrování a dešifrování komunikace v nezabezpečené síti:

![BTC204](assets/fr/220.webp)

Diffie-Hellman používá k výpočtu sdíleného tajemství modulární aritmetiku. Zde je zjednodušené vysvětlení, jak to funguje:


- Alice a Bob se dohodnou na společné barvě, zde žluté, která představuje veřejný údaj (útočníci tuto barvu znají);
- Alice si vybere tajnou barvu, zde červenou, a smíchá je, aby získala oranžovou;
- Bob si také vybere tajnou barvu, zde modrou, a smíchá ji se žlutou, aby získal zelenou;
- Poté si vymění získané barvy, oranžovou a zelenou. Tato výměna může probíhat v nezabezpečené, pozorované síti;
- Smícháním Bobovy zelené barvy s jeho tajnou barvou získá Alice hnědou;
- Bob, který udělá totéž s Alicinou oranžovou a její tajnou modrou, získá také hnědou.

![BTC204](assets/it/66/12.webp)

V tomto zjednodušení představuje hnědá barva tajemství sdílené mezi Alicí a Bobem. Je důležité si uvědomit, že ve skutečnosti je pro útočníka nemožné oddělit oranžovou a zelenou barvu a zjistit tak tajné barvy Alice nebo Boba.

Nyní prozkoumejme, jak tento protokol ve skutečnosti funguje, a to nikoli pomocí analogií s barvami, ale pomocí reálných čísel a modulární aritmetiky!

Než se začneme zabývat Diffieho-Hellmanovými mechanismy, dovolte mi, abych vám stručně připomněl dva základní matematické pojmy, které budeme potřebovat:


- **Prvočíslo** je přirozené číslo, které má pouze dva dělitele: $1$ a sebe sama. Například $7$ je prvočíslo, protože je dělitelné pouze čísly $1$ a $7$. Na druhou stranu $8$ není prvočíslo, protože je dělitelné $1$, $2$, $4$ a $8$. Má tedy čtyři kladné celočíselné dělitele místo dvou;
- **mod** (označovaný $mod$ nebo $\%$) je matematická operace, která mezi dvěma celými čísly vrací zbytek euklidovského dělení prvního číslem druhým. Například $16 \bmod 5 = 1$.

**Výměna Diffieho-Hellmanova klíče mezi Alicí a Bobem probíhá takto:**


- Alice a Bob se dohodnou na dvou společných číslech: $p$ a $g$. $p$ je prvočíslo, a čím je toto číslo větší, tím je Diffie-Hellmanova šifra bezpečnější. $g$ je primitivní kořen $p$. Tato dvě čísla lze otevřeně komunikovat po nezabezpečené síti. Představují ekvivalent **žluté barvy** ve výše uvedeném zjednodušení. Je proto důležité, aby Alice a Bob používali přesně stejné hodnoty pro $p$ a $g$.

Po definování těchto parametrů si Alice a Bob zvolí náhodné tajné číslo. Alice nazve své náhodné tajné číslo $a$ (odpovídá **červené barvě**) a Bob nazve své $b$ (odpovídá **modré barvě**). Tato čísla musí zůstat přísně tajná.

Místo přímé výměny čísel $a$ a $b$ si každá strana vypočítá $A$ a $B$ takto:

$A$ se rovná $g$ zvýšenému na mocninu $a$ modulo $p$:

$$
A = g^a \bmod p
$$

$B$ se rovná $g$ zvýšenému na mocninu $b$ modulo $p$:

$$
B = g^b \bmod p
$$

Mezi oběma stranami se vymění hodnoty $A$ (odpovídající **oranžové barvě**) a $B$ (odpovídající **zelené barvě**). Tato výměna může probíhat otevřeně přes nezabezpečenou síť;

Alice po obdržení $B$ vypočítá hodnotu $z$ takto:

$z$ se rovná $B$ zvýšenému na mocninu $a$ modulo $p$:

$$
z = B^a \bmod p
$$

Připomeňme si:

$$
B = g^b \bmod p
$$

Dostáváme tedy:

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

Použití pravidel pro exponenty:

$$
(x^n)^m = x^{nm}
$$

Získáme tedy:

$$
z = g^{ba} \bmod p
$$


- Na své straně Bob, který obdržel $A$, také vypočítá hodnotu $z$ následujícím způsobem:

$z$ se rovná $A$ zvýšenému na mocninu $b$ modulo $p$:

$$
z = A^b \bmod p
$$

Dostáváme tedy:

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

Díky distributivitě operátoru modulo dostanou Alice a Bob přesně stejnou hodnotu $z$. Toto číslo představuje jejich společné tajemství, ekvivalentní **hnědé barvě** v předchozím zjednodušení s hrnci s barvou. Toto společné tajemství nyní mohou použít k symetrickému šifrování své komunikace v nezabezpečené síti.

Útočník, i když bude mít k dispozici $p$, $g$, $A$ a $B$ (veřejné hodnoty), nebude schopen vypočítat $a$, $b$ nebo $z$ (soukromé hodnoty). K tomu by bylo třeba invertovat exponenciálu, což je nemožný úkol, aniž bychom postupně vyzkoušeli všechny možnosti, protože je to ekvivalentní výpočtu diskrétního logaritmu, tj. inverzní hodnoty exponenciály v konečné cyklické grupě.

Pokud jsou tedy hodnoty $a$, $b$ a $p$ dostatečně velké, je Diffie-Hellmanův protokol bezpečný. Typicky u 2048bitových parametrů (číslo s 600 číslicemi v desítkové soustavě) by testování všech možností pro $a$ a $b$ bylo nepraktické. K dnešnímu dni je s takovými čísly tento algoritmus považován za bezpečný.

Právě v tom spočívá hlavní nevýhoda Diffie-Hellmanova protokolu. Aby byl algoritmus bezpečný, musí používat velká čísla. Proto se dnes dává přednost algoritmu ECDH (_Elliptic Curve Diffie-Hellman_), variantě Diffie-Hellmanova protokolu, která je založena na algebraické křivce, přesněji na eliptické křivce. Tento přístup umožňuje pracovat s mnohem menšími čísly při zachování rovnocenného zabezpečení, čímž se snižují prostředky potřebné pro výpočet a ukládání.

Obecný princip algoritmu zůstává stejný. Místo náhodného čísla $a$ a čísla $A$ vypočteného z $a$ modulární exponencí však používáme dvojici klíčů vytvořenou na eliptické křivce. Namísto spoléhání na distributivitu operátoru modulo využíváme skupinový zákon na eliptických křivkách, konkrétně asociativitu tohoto zákona.

Stručně vysvětlíme princip kryptografie na eliptických křivkách: soukromý klíč je reprezentován náhodným číslem v rozsahu $1$ až $n-1$, kde $n$ představuje řád křivky. Veřejný klíč je naproti tomu konkrétní bod na této křivce, získaný ze soukromého klíče operacemi sčítání a zdvojování bodů počínaje generujícím bodem podle rovnice:

$$
K = k \cdot G
$$

V tomto vzorci $K$ označuje veřejný klíč, $k$ soukromý klíč a $G$ generující bod.

Jednou z podstatných vlastností těchto klíčů je snadnost výpočtu $K$ z $k$ a $G$, zatímco najít $k$ z $K$ a $G$ je prakticky nemožné. Tato asymetrie vytváří jednosměrnou funkci. Jinými slovy, je snadné vypočítat veřejný klíč, pokud známe soukromý klíč, ale najít soukromý klíč z veřejného klíče je nemožné. Toto zabezpečení stále závisí na výpočetní náročnosti diskrétního logaritmu.

Tuto vlastnost využijeme k úpravě našeho Diffie-Hellmanova algoritmu. **Princip fungování ECDH je následující:**


- Alice a Bob se společně dohodnou na kryptograficky bezpečné eliptické křivce a jejích parametrech. Tyto informace jsou veřejné;
- Alice vygeneruje náhodné číslo $ka$, které bude jejím soukromým klíčem. Tento soukromý klíč musí zůstat utajen. Svůj veřejný klíč $Ka$ určí sčítáním a zdvojováním bodů na zvolené eliptické křivce:

$$
K_a = k_a \cdot G
$$


- Bob také vygeneruje náhodné číslo $kb$, které bude jeho soukromým klíčem. Vypočítá související veřejný klíč $kb$:

$$
K_b = k_b \cdot G
$$


- Alice a Bob si vymění své veřejné klíče $Ka$ a $Kb$ v nezabezpečené veřejné síti.
- Alice vypočítá bod $(x,y)$ na křivce použitím svého soukromého klíče $ka$ na Bobův veřejný klíč $Kb$:

$$
(x,y) = k_a \cdot K_b
$$


- Bob vypočítá bod $(x,y)$ na křivce použitím svého soukromého klíče $kb$ na Alicin veřejný klíč $Ka$:

$$
(x,y) = k_b \cdot K_a
$$


- Alice a Bob získají stejný bod na eliptické křivce. Sdíleným tajemstvím bude souřadnice $x$ tohoto bodu.

Ve skutečnosti mají stejné sdílené tajemství, protože:

(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a

$$
Un attaccante che osserva la rete pubblica non protetta può ottenere solo le chiavi pubbliche di ciascuna parte e i parametri della curva ellittica scelta. Come precedentemente spiegato, queste informazioni da sole non sono sufficienti per determinare le chiavi private. Pertanto, l'attaccante non può trovare il segreto condiviso tra Alice e Bob.
ECDH è quindi un algoritmo che consente lo scambio di chiavi. È spesso utilizzato in combinazione con altri metodi crittografici per stabilire un protocollo completo. Ad esempio, ECDH è integrato nel nucleo di TLS (_Transport Layer Security_), un protocollo di crittografia e autenticazione utilizzato per il livello di trasporto di Internet. TLS utilizza ECDHE per lo scambio di chiavi, una variante di ECDH dove le chiavi sono effimere, per garantire la confidenzialità persistente. Inoltre, TLS utilizza algoritmi di autenticazione come ECDSA, algoritmi di crittografia come AES e funzioni hash come SHA256.
TLS è notevolmente responsabile della `s` in `https` così come del lucchetto visibile nella barra degli indirizzi del tuo browser, simboli delle comunicazioni criptate. Seguendo questo corso, stai quindi utilizzando ECDH, ed è molto probabile che lo usi quotidianamente senza nemmeno saperlo.
### La Transazione di Notifica
Come abbiamo visto nella sezione precedente, ECDH è una variante dello scambio Diffie-Hellman che utilizza coppie di chiavi stabilite su una curva ellittica. Convenientemente, possediamo già molte coppie di chiavi aderenti a questo standard nei nostri portafogli Bitcoin! L'idea di BIP47 è di utilizzare le coppie di chiavi dei portafogli Bitcoin gerarchici deterministici di entrambe le parti per stabilire segreti condivisi ed effimeri tra di loro. Nel contesto di BIP47, viene utilizzato ECDHE (_Elliptic Curve Diffie-Hellman Ephemeral_).
ECDHE viene utilizzato per la prima volta in BIP47 per trasmettere il codice di pagamento dal mittente al destinatario. Questo è il famoso **notification transaction**. Questo passaggio è essenziale perché affinché BIP47 funzioni efficacemente, entrambe le parti coinvolte (il mittente e il destinatario) devono conoscere il codice di pagamento dell'altro. Questa conoscenza consente la derivazione di chiavi pubbliche effimere e, di conseguenza, indirizzi di ricezione vuoti associati.
Prima di questo scambio, il mittente è logicamente già a conoscenza del codice di pagamento del destinatario poiché lo ha recuperato off-chain, ad esempio, dal loro sito web, una fattura o i loro social media. Tuttavia, il destinatario potrebbe non conoscere necessariamente il codice di pagamento del mittente. Eppure, questo codice deve essere trasmesso a loro; altrimenti, non saranno in grado di derivare le chiavi effimere necessarie per identificare gli indirizzi dove sono conservati i loro bitcoin, né accedere ai loro fondi. Sebbene questa trasmissione del codice del mittente possa tecnicamente essere effettuata off-chain attraverso altri mezzi di comunicazione, ciò pone un problema se il portafoglio deve essere recuperato solo dal seme.
Infatti, a differenza degli indirizzi convenzionali, gli indirizzi BIP47 non sono derivati direttamente dal seed del destinatario—utilizzare un `xpub` sarebbe più semplice in questo caso—ma risultano da un calcolo che combina i codici di pagamento di entrambi: quello del mittente e quello del destinatario. Pertanto, se il destinatario perde il proprio portafoglio e tenta di ripristinarlo dal proprio seed, recupererà il proprio codice di pagamento, che è derivato direttamente dal loro seed. Tuttavia, per trovare gli indirizzi effimeri, sarà essenziale per loro avere anche i codici di pagamento di tutti coloro che hanno inviato loro bitcoin tramite BIP47. Da qui l'importanza della transazione di notifica, che consente di salvare queste informazioni sulla blockchain di Bitcoin, pur essendo in grado di trovarle molto facilmente senza dover cercare tra il miliardo di transazioni eseguite dal suo lancio nel 2009.
![BTC204](assets/it/66/15.webp)
Pertanto, sarebbe possibile implementare BIP47 senza ricorrere alla transazione di notifica, a condizione che ogni utente conservi un backup dei codici di pagamento dei propri pari. Tuttavia, questo metodo si rivela complesso da gestire finché non viene sviluppata una soluzione semplice, robusta ed efficiente per creare, conservare e aggiornare questi backup. Nello stato attuale delle cose, la transazione di notifica diventa quasi indispensabile.
Nei capitoli seguenti, studieremo altri protocolli con obiettivi simili a quelli di BIP47, ma che non richiedono una transazione di notifica. Queste alternative, tuttavia, introducono i propri compromessi.
Oltre al suo ruolo nel backup dei codici di pagamento, la transazione di notifica serve anche una funzione di notifica per il destinatario, come suggerisce il suo nome. Segnala al client del destinatario che è stato stabilito un nuovo canale di pagamento e suggerisce quindi di monitorare gli indirizzi effimeri risultanti.
### Il Modello di Privacy di BIP47
Prima di dettagliare il funzionamento tecnico della transazione di notifica, è importante discutere il modello di privacy associato a BIP47, che giustifica alcune misure prese durante la creazione di questa transazione iniziale.
Il codice di pagamento, di per sé, non rappresenta un rischio diretto per la privacy. A differenza del modello Bitcoin tradizionale, che mira a rompere il collegamento tra l'identità di un utente e le sue transazioni (che sono pubbliche) preservando l'anonimato di chiavi e indirizzi, il codice di pagamento può essere apertamente associato a un'identità senza rappresentare una minaccia.
Infatti, il codice di pagamento non è utilizzato per derivare direttamente gli indirizzi che ricevono pagamenti BIP47. Questi indirizzi sono invece generati attraverso l'applicazione di ECDH tra le chiavi derivate dai codici di pagamento delle due parti coinvolte.
Così, un codice di pagamento di per sé non porta direttamente a una perdita di privacy, poiché solo l'indirizzo di notifica è derivato da esso. Sebbene questo indirizzo possa rivelare alcune informazioni, normalmente non consente di scoprire le parti con cui si stanno conducendo transazioni, a meno che non si effettui un'analisi approfondita della catena. Infatti, se il mittente utilizza UTXO che possono essere collegati alla loro identità per eseguire la transazione di notifica, allora diventa possibile dedurre che la loro identità è probabilmente collegata ai pagamenti BIP47 al tuo codice di pagamento. Questo non rivelerà le transazioni sottostanti, ma indicherà la loro probabile esistenza.
Pertanto, è essenziale mantenere questa stretta separazione tra i codici di pagamento degli utenti. Verso questo obiettivo, il passo iniziale di comunicazione del codice è un momento critico per la privacy del pagamento, ma obbligatorio per il corretto funzionamento del protocollo. Se uno dei codici di pagamento può essere ottenuto pubblicamente (come su un sito web), il secondo codice, quello del mittente, non deve essere collegato al primo in nessun caso.
Prendiamo un esempio concreto: voglio fare una donazione a un movimento politico tramite BIP47:
- L'organizzazione ha reso pubblico il suo codice di pagamento sul suo sito web o tramite i suoi social network;
- Questo codice è quindi collegato al movimento politico;
- Recupero questo codice di pagamento;
- Prima di procedere con un invio, devo assicurarmi che conoscano il mio codice di pagamento, che è anche collegato alla mia identità poiché lo uso per ricevere transazioni sui miei social network.
Come trasmettere il mio codice senza rischi? L'uso di mezzi di comunicazione convenzionali potrebbe portare a una fuga di informazioni e, di conseguenza, associarmi a questo movimento politico. La transazione di notifica offre una soluzione grazie a uno strato di crittografia che impedisce precisamente questa associazione tra due codici. Sebbene questo non sia l'unico metodo per trasmettere segretamente il codice di pagamento del mittente, si dimostra molto efficace.
Nel diagramma sottostante, le linee arancioni indicano i punti in cui il flusso di informazioni deve essere interrotto, e le frecce nere mostrano le connessioni che potrebbero potenzialmente essere osservate da terze parti:
![BTC204](assets/it/66/16.webp)
In realtà, all'interno del modello tradizionale di privacy di Bitcoin, è spesso complesso dissociare completamente il flusso di informazioni tra la coppia di chiavi e l'utente, specialmente durante le transazioni a distanza. Ad esempio, nel contesto di una campagna di donazione, il destinatario deve inevitabilmente divulgare un indirizzo o una chiave pubblica tramite il loro sito web o social network. L'uso corretto di BIP47, in particolare con la transazione di notifica, permette di aggirare questo problema grazie a ECDHE e allo strato di crittografia che studieremo ulteriormente.
Ovviamente, il modello classico di privacy di Bitcoin si applica ancora alle chiavi pubbliche effimere, che sono derivate dalla combinazione dei due codici di pagamento. I due modelli sono in realtà complementari. Quello che voglio evidenziare qui è che, contrariamente all'uso abituale di una chiave pubblica per ricevere bitcoin, il codice di pagamento può essere collegato a una specifica identità, perché l'informazione "_Alice effettua una transazione con Bob_" viene interrotta in un'altra fase. Il codice di pagamento viene utilizzato per generare indirizzi di pagamento, ma basandosi unicamente sull'osservazione della blockchain, è impossibile collegare una transazione di pagamento BIP47 ai codici di pagamento utilizzati per eseguirla, a meno che gli UTXO coinvolti non fossero già collegati a un'identità precedentemente e gli utenti non abbiano associato i loro codici di pagamento alle rispettive identità.
Per riassumere, il modello di privacy offerto dai pagamenti BIP47 potrebbe essere considerato superiore a quello della base di Bitcoin, anche se non è magico in alcun modo.
### Costruzione della Transazione di Notifica
Ora, vediamo come funziona questa transazione di notifica. Immaginiamo che Alice voglia inviare fondi a Bob con BIP47. Nel mio esempio, Alice agisce come mittente e Bob come destinatario. Quest'ultimo ha pubblicato il suo codice di pagamento sul suo sito web. Pertanto, Alice è già a conoscenza del codice di pagamento di Bob.
**1- Alice calcola un segreto condiviso con ECDH:**
- Seleziona una coppia di chiavi dal suo portafoglio HD situato su un ramo diverso dal suo codice di pagamento. Nota, questa coppia non dovrebbe essere facilmente associata all'indirizzo di notifica di Alice, né all'identità di Alice (vedi sezione precedente);
- Alice seleziona la chiave privata da questa coppia. La chiamiamo $a$ (minuscolo);
$$

a

$$
```text
- Alice recupera la chiave pubblica associata all'indirizzo di notifica di Bob. Questa chiave è la prima figlia derivata dal codice di pagamento di Bob (indice $/0$). Chiamiamo questa chiave pubblica $B$ (maiuscolo). La chiave privata associata a questa chiave pubblica è chiamata $b$ (minuscolo). $B$ è determinata dall'addizione e dal raddoppio dei punti sulla curva ellittica da $G$ (il punto generatore) con $b$ (la chiave privata):
$$ B = b \cdot G $$
- Alice calcola un punto segreto $S$ (maiuscolo) sulla curva ellittica tramite l'addizione e il raddoppio dei punti applicando la sua chiave privata $a$ dalla chiave pubblica di Bob $B$.
$$ S = a \cdot B $$
- Alice calcola il fattore di oscuramento $f$ che le permetterà di criptare il suo codice di pagamento. Per fare ciò, determinerà un numero pseudo-casuale con la funzione HMAC-SHA512. Nel secondo input di questa funzione, utilizza un valore che solo Bob potrà recuperare: $x$ che è l'ascissa del punto segreto precedentemente calcolato. Il primo input è $o$ che è l'UTXO consumato in input di questa transazione (outpoint).
$$ f = \text{HMAC-SHA512}(o, x) $$
**2- Alice converte il suo codice di pagamento personale in base 2 (binario).**
**3- Utilizza questo fattore di oscuramento come chiave per eseguire la crittografia simmetrica sul payload del suo codice di pagamento.** L'algoritmo di crittografia utilizzato è semplicemente un `XOR`. L'operazione eseguita è paragonabile alla cifratura di Vernam, anche denominata "One-Time Pad".
- Alice prima divide il suo fattore di oscuramento in due: i primi 32 byte sono denominati $f1$ e gli ultimi 32 byte sono denominati $f2$. Quindi, abbiamo:
$$ f = f1 || f2 $$
- Alice calcola l'$x'$ criptato dell'ascissa della chiave pubblica $x$ del suo codice di pagamento, e il $c'$ criptato del suo codice catena $c$ separatamente. $f1$ e $f2$ agiscono rispettivamente come chiavi di crittografia. L'operazione utilizzata è il `XOR` (o esclusivo).
$$ x' = x \oplus f1 $$
$$ c' = c \oplus f2 $$
- Alice sostituisce i valori reali dell'ascissa della chiave pubblica $x$ e del codice catena $c$ nel suo codice di pagamento con i valori criptati $x'$ e $c'$.
**4-** Alice ora ha il suo codice di pagamento con un payload criptato. Costruirà e trasmetterà una transazione che coinvolge la sua chiave pubblica $A$ come input, un output all'indirizzo di notifica di Bob, e un output `OP_RETURN` contenente il suo codice di pagamento con il payload criptato. **Questa transazione è la transazione di notifica**.
Un `OP_RETURN` è un opcode che segna un output di una transazione Bitcoin come non valido. Oggi, è utilizzato per trasmettere o ancorare informazioni sulla blockchain di Bitcoin. Fino a 80 byte di dati possono essere memorizzati, che sono scritti sulla catena e quindi visibili a tutti gli altri utenti.
Come abbiamo visto nelle sezioni precedenti, ECDH è utilizzato per generare un segreto condiviso tra due utenti che comunicano su una rete non sicura, potenzialmente osservata da attaccanti. In BIP47, ECDH è utilizzato per la comunicazione sulla rete Bitcoin, che per sua natura è una rete di comunicazione trasparente osservata da molti attaccanti. Il segreto condiviso calcolato tramite lo scambio di chiavi ECDH è poi utilizzato per criptare le informazioni segrete da trasmettere: il codice di pagamento del mittente (di Alice).
Ricapitoliamo i passaggi che abbiamo appena esaminato insieme per eseguire una transazione di notifica:
- Alice recupera il codice di pagamento e l'indirizzo di notifica di Bob;
- Alice seleziona un UTXO che possiede nel suo portafoglio HD con la corrispondente coppia di chiavi;
- Calcola un punto segreto sulla curva ellittica utilizzando ECDH;
- Utilizza questo punto segreto per calcolare un HMAC, che è il fattore di oscuramento;
- Utilizza questo fattore di oscuramento per criptare il payload del suo codice di pagamento personale.
- Lei utilizza un output di transazione `OP_RETURN` per comunicare il codice di pagamento mascherato a Bob.
![BTC204](assets/it/66/17.webp)
### Transazione di Notifica: Studio Concreto
Per comprendere meglio il suo funzionamento, in particolare l'uso di `OP_RETURN`, esaminiamo insieme una vera transazione di notifica. Ho eseguito tale transazione sulla testnet, che potete trovare [cliccando qui](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e).
![BTC204](assets/fr/227.webp)
Osservando questa transazione, possiamo vedere che ha un singolo input e 4 output:
- Il primo output è l'`OP_RETURN` che contiene il mio codice di pagamento mascherato;
- Il secondo output di 546 sats punta all'indirizzo di notifica del mio destinatario;
- Il terzo output di 15.000 sats rappresenta le commissioni di servizio, poiché ho utilizzato Samourai Wallet per costruire questa transazione;
- Il quarto output di 2 milioni di sats rappresenta il resto, ovvero la differenza rimanente dal mio input che ritorna a un altro indirizzo che mi appartiene.
Il più interessante da studiare è ovviamente l'output 0 che utilizza l'`OP_RETURN`. Vediamo più da vicino cosa contiene. Ecco lo `scriptPubKey` in esadecimale:
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

```text
In questo script, possiamo sezionare diverse parti. Prima di tutto, gli opcode:
6a4c
```

```text
Tra gli opcode, possiamo riconoscere `0x6a` che designa l'`OP_RETURN` e `0x4c` che designa l'`OP_PUSHDATA1`.
Il byte seguente questo ultimo opcode indica la dimensione del payload che segue. Indica `0x50`, ovvero 80 byte:
6a4c50
```

```text
Poi, abbiamo i metadati del mio codice di pagamento in chiaro:
010002
```

```text
La coordinata x criptata della chiave pubblica del mio codice di pagamento:
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

```text
Il codice catena criptato del mio codice di pagamento:
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

```text
E infine, il padding per raggiungere 80 byte, la dimensione standard di un `OP_RETURN`:
00000000000000000000000000
```

```
Per capire meglio, ecco il mio codice di pagamento in chiaro in base 58:
````text
PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU
Quando si confronta il mio codice di pagamento in chiaro con l'`OP_RETURN`, è evidente che l'HRP (`0x47`) e il checksum (`0x8604e4db`) non vengono trasmessi. Questo è previsto, poiché queste informazioni sono destinate agli esseri umani.
Successivamente, possiamo identificare la versione (`0x01`), il campo di bit (`0x00`) e la parità della chiave pubblica (`0x02`). E, alla fine del codice di pagamento, i byte vuoti (`0x00000000000000000000000000`) sono utilizzati per riempire il codice fino a un totale di 80 byte. Tutti questi metadati vengono trasmessi in chiaro (non criptati).
Infine, si può osservare che la coordinata x della chiave pubblica (`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`) e il codice catena (`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`) sono stati criptati. Questo costituisce il payload del codice di pagamento.
### Cos'è XOR?
Nelle sezioni precedenti, abbiamo visto che il codice di pagamento è stato trasmesso criptato utilizzando l'operazione XOR. Prendiamoci un momento per capire come funziona questo operatore, poiché è ampiamente utilizzato nella crittografia.
XOR è un operatore logico bit a bit basato sull'algebra booleana. Con due operandi bit, restituisce `1` se i bit dello stesso rango sono diversi, e restituisce `0` se i bit dello stesso rango sono uguali. Ecco la tabella di verità di XOR basata sui valori degli operandi `D` e `E`:
| D   | E   | D XOR E |
| --- | --- | ------- |
| 0   | 0   | 0       |
| 0   | 1   | 1       |
| 1   | 0   | 1       |
| 1   | 1   | 0       |
Per esempio:
$$

$$
0110 \oplus 1110 = 1000
Oppure:
$$

$$
010011 \oplus 110110 = 100101
Con ECDH, l'uso di XOR come strato di crittografia è particolarmente adatto. Innanzitutto, a causa di questo operatore, la crittografia è simmetrica. Questo consente al destinatario di decifrare il codice di pagamento con la stessa chiave utilizzata per la crittografia. La chiave di crittografia e decrittografia viene calcolata dal segreto condiviso grazie a ECDH. Questa simmetria è resa possibile dalle proprietà commutativa e associativa dell'operatore XOR:
- Altre proprietà:
$$

$$
D \oplus D = 0
D ⊕ 0 = D
- Commutatività:
$$

$$
D \oplus E = E \oplus D
- Associatività:
$$

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
Se:
$$

$$
D \oplus E = L
Allora:
$$

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
Successivamente, questo metodo di cifratura assomiglia molto al cifrario di Vernam (One-Time Pad), l'unico algoritmo di cifratura conosciuto fino ad oggi che possiede sicurezza incondizionata (o assoluta). Affinché il cifrario di Vernam abbia questa caratteristica, la chiave di cifratura deve essere perfettamente casuale, deve essere della stessa dimensione del messaggio e deve essere utilizzata una sola volta. Nel metodo di cifratura utilizzato qui per BIP47, la chiave è effettivamente della stessa dimensione del messaggio, il fattore di offuscamento è esattamente della stessa dimensione della concatenazione della coordinata x della chiave pubblica con il codice catena del codice di pagamento. Questa chiave di cifratura è effettivamente utilizzata una sola volta. Tuttavia, questa chiave non è il risultato di una casualità perfetta poiché è un HMAC. È piuttosto pseudo-casuale. Pertanto, non si tratta di un cifrario di Vernam, ma il metodo è simile.
### Ricezione della Transazione di Notifica
Ora che Alice ha inviato la transazione di notifica a Bob, vediamo come lui la interpreta. Come promemoria, Bob deve essere in grado di accedere al codice di pagamento di Alice. Senza queste informazioni, come vedremo nella sezione seguente, non sarà in grado di derivare le coppie di chiavi create da Alice e, quindi, non sarà in grado di accedere ai suoi bitcoin ricevuti tramite BIP47. Per ora, il payload del codice di pagamento di Alice è criptato. Vediamo come Bob lo decifra.
**1-** Bob monitora le transazioni che creano output con il suo indirizzo di notifica.
**2-** Quando una transazione ha un output sul suo indirizzo di notifica, Bob la analizza per vedere se contiene un output OP_RETURN che segue lo standard BIP47.
**3-** Se il primo byte del payload OP_RETURN è `0x01`, Bob inizia la sua ricerca di un possibile segreto condiviso con ECDH:
- Bob seleziona la chiave pubblica nell'input della transazione. Ovvero, la chiave pubblica di Alice denominata $A$ con:
$$ A = a \cdot G $$
- Bob seleziona la chiave privata $b$ associata al suo indirizzo di notifica personale:
$$ b $$
- Bob calcola il punto segreto $S$ (segreto condiviso ECDH) sulla curva ellittica sommando e raddoppiando i punti, applicando la sua chiave privata $b$ alla chiave pubblica di Alice $A$:
$$ S = b \cdot A $$
- Bob determina il fattore di offuscamento $f$ che gli permetterà di decifrare il payload del codice di pagamento di Alice. Nello stesso modo in cui Alice aveva precedentemente calcolato, Bob troverà $f$ applicando HMAC-SHA512 su $x$ la coordinata x del punto segreto $S$, e su $o$ l'UTXO consumato come input in questa transazione di notifica:
$$ f = \text{HMAC-SHA512}(o, x) $$
**4-** Bob interpreta i dati nell'OP_RETURN della transazione di notifica come un codice di pagamento. Egli semplicemente decifra il payload di questo potenziale codice di pagamento usando il fattore di offuscamento $f$:
- Bob divide il fattore di offuscamento $f$ in 2 parti: i primi 32 byte di $f$ saranno $f1$ e gli ultimi 32 byte saranno $f2$;
- Bob decifra la coordinata x cifrata $x'$ della chiave pubblica dal codice di pagamento di Alice:
$$ x = x' \oplus f1 $$
- Bob decifra il valore del codice catena cifrato $c'$ dal codice di pagamento di Alice:
$$ c = c' \oplus f2 $$
**5-** Bob verifica se il valore della chiave pubblica dal codice di pagamento di Alice è effettivamente parte del gruppo secp256k1. Se è così, lo interpreta come un codice di pagamento valido. Altrimenti, ignora questa transazione.
Ora che Bob è a conoscenza del codice di pagamento di Alice, lei può inviargli fino a `2^32` pagamenti, senza mai dover effettuare un'altra transazione di notifica di questo tipo.
Perché funziona? Come fa Bob a determinare lo stesso fattore di offuscamento di Alice, e quindi a decifrare il suo codice di pagamento? Esaminiamo più da vicino il ruolo di ECDH in quello che abbiamo appena descritto.
Prima di tutto, stiamo trattando con la crittografia simmetrica. Questo significa che la chiave di cifratura e la chiave di decifratura sono lo stesso valore. Questa chiave nella transazione di notifica è il fattore di offuscamento:
$$ f = f1 || f2 $$
Pertanto, Alice e Bob devono ottenere lo stesso valore per $f$, senza trasmetterlo direttamente poiché un attaccante potrebbe rubarlo e decifrare le informazioni segrete. Questo fattore di offuscamento si ottiene applicando HMAC-SHA512 su 2 valori:
- la coordinata x di un punto segreto;
- e l'UTXO consumato come input nella transazione.
Bob, quindi, ha bisogno di queste due informazioni per decifrare il payload del codice di pagamento di Alice. Per l'UTXO come input, Bob può semplicemente recuperarlo osservando la transazione di notifica. Per il punto segreto, Bob dovrà usare ECDH. Come visto nella sezione precedente su Diffie-Hellman, semplicemente scambiando le rispettive chiavi pubbliche e applicando segretamente le proprie chiavi private alla chiave pubblica dell'altro, Alice e Bob possono trovare un punto specifico e segreto sulla curva ellittica. La transazione di notifica si basa su questo meccanismo:
- Coppia di chiavi di Bob:
$$ B = b \cdot G $$
- Coppia di chiavi di Alice:
$$ A = a \cdot G $$
- Per un segreto $S (x, y)$:
$$ S = a \cdot B = a \cdot (b \cdot G) = (b \cdot a) \cdot G = b \cdot A $$
Ora che Bob conosce il codice di pagamento di Alice, sarà in grado di rilevare i suoi pagamenti BIP47, e può derivare le chiavi private che bloccano i bitcoin ricevuti.
Ricapitoliamo i passaggi che abbiamo appena esaminato per ricevere e interpretare una transazione di notifica:
- Bob monitora gli output delle transazioni al suo indirizzo di notifica;
- Quando ne rileva uno, recupera le informazioni contenute nell'OP_RETURN;
- Bob seleziona la chiave pubblica in input e calcola un punto segreto usando ECDH;
- Usa questo punto segreto per calcolare un HMAC che è il fattore di offuscamento;
- Usa questo fattore di offuscamento per decifrare il payload del codice di pagamento di Alice contenuto nell'OP_RETURN.
### La Transazione di Pagamento BIP47
Studiamo ora insieme il processo di pagamento con BIP47. Per ricordarvi lo stato attuale delle cose:
- Alice conosce il codice di pagamento di Bob, che ha semplicemente recuperato dal suo sito web;
- Bob conosce il codice di pagamento di Alice grazie alla transazione di notifica;
- Alice effettuerà un primo pagamento a Bob. Potrà effettuarne molti altri allo stesso modo.
Prima di spiegare questo processo, penso sia importante ricordare gli indici su cui stiamo attualmente lavorando. Il percorso di derivazione di un codice di pagamento è descritto come segue: `m/47'/0'/0'`. La profondità successiva distribuisce gli indici in questo modo:
- La prima coppia di chiavi figlio normali (non rinforzate) è quella utilizzata per generare l'indirizzo di notifica di cui abbiamo parlato nella parte precedente: `m/47'/0'/0'/0`;
- Le coppie di chiavi figlio normali sono utilizzate all'interno di ECDH per generare indirizzi di ricezione dei pagamenti BIP47 come vedremo in questa sezione: da `m/47'/0'/0'/0` a `m/47'/0'/0'/2 147 483 647`;
- Le coppie di chiavi figlio rinforzate sono codici di pagamento effimeri: da `m/47'/0'/0'/0'` a `m/47'/0'/0'/2 147 483 647'`.
Ogni volta che Alice desidera inviare un pagamento a Bob, deriva un nuovo indirizzo vergine unico, grazie ancora al protocollo ECDH:
- Alice seleziona la prima chiave privata derivata dal suo codice di pagamento personale riutilizzabile:
$$ a $$
- Alice seleziona la prima chiave pubblica inutilizzata derivata dal codice di pagamento di Bob. Questa chiave pubblica, la chiameremo $B$. È associata alla chiave privata $b$ che solo Bob conosce:
$$ B = b \cdot G $$
- Alice calcola un punto segreto $S$ sulla curva ellittica tramite addizione e raddoppio di punti applicando la sua chiave privata $a$ alla chiave pubblica $B$ di Bob:
$$ S = a \cdot B $$
- Da questo punto segreto, Alice calcolerà il segreto condiviso $s$ (minuscolo). Per fare ciò, seleziona la coordinata x del punto segreto $S$ denominata $Sx$, e passa questo valore attraverso la funzione hash SHA256:
$$ S = (Sx, Sy) $$
$$ s = \text{SHA256}(Sx) $$
- Alice utilizza questo segreto condiviso $s$ per calcolare un indirizzo Bitcoin di ricezione dei pagamenti. Inizialmente, verifica che $s$ sia contenuto nell'ordine della curva secp256k1. In caso contrario, incrementa l'indice della chiave pubblica di Bob per derivare un altro segreto condiviso;
- In secondo luogo, calcola una chiave pubblica $K0$ aggiungendo sulla curva ellittica i punti $B$ e $s·G$. In altre parole, Alice aggiunge la chiave pubblica derivata dal codice di pagamento di Bob $B$ con un altro punto calcolato sulla curva ellittica tramite addizione e raddoppio con il segreto condiviso $s$ dal punto generatore della curva secp256k1 $G$. Questo nuovo punto rappresenta una chiave pubblica, e lo chiamiamo $K0$:
$$ K0 = B + s \cdot G $$
- Con questa chiave pubblica $K0$, Alice può derivare un indirizzo vergine standard di ricezione (per esempio, SegWit V0 in bech32).
Una volta che Alice ha ottenuto l'indirizzo di ricezione di Bob $K0$, può eseguire una transazione Bitcoin in modo standard. Per fare ciò, seleziona un UTXO di sua proprietà, assicurato da una coppia di chiavi di un ramo diverso del suo portafoglio HD, e lo spende per soddisfare un output all'indirizzo di Bob $K0$. È importante notare che questo pagamento, una volta derivato l'indirizzo, segue un processo convenzionale e non dipende più dalle chiavi associate a BIP47.
Ricapitoliamo i passaggi che abbiamo appena eseguito insieme per inviare un pagamento BIP47:
- Alice seleziona la prima chiave privata derivata dal suo codice di pagamento personale;
- Calcola un punto segreto sulla curva ellittica utilizzando ECDH dalla prima chiave pubblica derivata non utilizzata dal codice di pagamento di Bob;
- Utilizza questo punto segreto per calcolare un segreto condiviso con SHA256;
- Utilizza questo segreto condiviso per calcolare un nuovo punto segreto sulla curva ellittica;
- Aggiunge questo nuovo punto segreto alla chiave pubblica di Bob;
- Ottiene una nuova chiave pubblica effimera per la quale solo Bob ha la chiave privata associata;
- Alice può effettuare una transazione standard a Bob con l'indirizzo di ricezione effimero derivato.
![BTC204](assets/it/66/21.webp)
Se Alice desidera effettuare un secondo pagamento, seguirà gli stessi passaggi di prima, eccetto che questa volta selezionerà la seconda chiave pubblica derivata dal codice di pagamento di Bob. Specificamente, utilizzerà la prossima chiave non utilizzata. Otterrà così un nuovo indirizzo di ricezione appartenente a Bob, designato $K1$:
![BTC204](assets/it/66/22.webp)
Può continuare in questo modo e derivare fino a `2^32` indirizzi non utilizzati appartenenti a Bob.
Da un punto di vista esterno, osservando la blockchain, è teoricamente impossibile differenziare un pagamento BIP47 da un pagamento standard. Ecco un esempio di transazione di pagamento BIP47 sul Testnet:
```

94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
````
Questo sembra una transazione standard con un input consumato, un output di pagamento e un resto:
![BTC204](assets/fr/232.webp)
### Ricevere il Pagamento BIP47 e Derivare la Chiave Privata
Alice ha appena effettuato il suo primo pagamento a un nuovo indirizzo BIP47 appartenente a Bob. Ora vediamo come Bob riceve questo pagamento. Vedremo anche perché Alice non ha accesso alla chiave privata dell'indirizzo che ha appena generato da sola, e come Bob recupera questa chiave per spendere i bitcoin che ha appena ricevuto.
Non appena Bob riceve la transazione di notifica da Alice, deriva la chiave pubblica BIP47 $K0$ anche prima che lei abbia inviato qualsiasi pagamento. Poi monitora qualsiasi pagamento all'indirizzo associato. Infatti, deriva immediatamente diversi indirizzi che monitorerà ($K0$, $K1$, $K2$, $K3$...). Ecco come deriva questa chiave pubblica $K0$:
- Bob seleziona la prima chiave privata derivata dal suo codice di pagamento. Questa chiave privata è denominata $b$. È associata alla chiave pubblica $B$ con cui Alice aveva fatto i suoi calcoli nel passaggio precedente:
$$ b $$
- Bob seleziona la prima chiave pubblica di Alice derivata dal suo codice di pagamento. Questa chiave è denominata $A$. È associata alla chiave privata $a$ con cui Alice aveva fatto i suoi calcoli, e di cui solo Alice è a conoscenza. Bob può eseguire questo processo poiché è a conoscenza del codice di pagamento di Alice che le è stato trasmesso con la transazione di notifica:
$$ A = a \cdot G $$
- Bob calcola il punto segreto $S$, mediante addizione e raddoppio di punti sulla curva ellittica, applicando la sua chiave privata $b$ alla chiave pubblica di Alice $A$. Qui troviamo l'uso di ECDH che garantisce che questo punto $S$ sarà lo stesso sia per Bob che per Alice:
$$ S = b \cdot A $$
- Proprio come ha fatto Alice, Bob isola la coordinata x di questo punto $S$. Abbiamo chiamato questo valore $Sx$. Egli passa questo valore attraverso la funzione SHA256 per trovare il segreto condiviso $s$ (minuscolo):
$$ s = \text{SHA256}(Sx) $$
- Proprio come Alice, Bob calcola il punto $s·G$ sulla curva ellittica. Poi, aggiunge questo punto segreto alla sua chiave pubblica $B$. Ottiene così un nuovo punto sulla curva ellittica che interpreta come una chiave pubblica $K0$:
$$ K0 = B + s \cdot G $$
Una volta che Bob ha questa chiave pubblica $K0$, può derivare la chiave privata associata per essere in grado di spendere i suoi bitcoin. È l'unico che può generare questa chiave privata:
- Bob aggiunge la sua chiave privata figlio $b$ derivata dal suo codice di pagamento personale. È l'unico che può ottenere il valore di $b$. Poi, aggiunge $b$ con il segreto condiviso $s$ per ottenere $k0$, la chiave privata di $K0$:
$$ k0 = b + s $$
Grazie alla legge di gruppo della curva ellittica, Bob ottiene esattamente la chiave privata corrispondente alla chiave pubblica usata da Alice. Abbiamo quindi:
$$ K0 = k0 \cdot G $$
Riassumerò i passaggi che abbiamo appena esaminato insieme per ricevere un pagamento BIP47 e calcolare la chiave privata corrispondente:
- Bob seleziona la prima chiave privata figlio derivata dal suo codice di pagamento personale;
- Calcola un punto segreto sulla curva ellittica usando ECDH dalla prima chiave pubblica figlio derivata dal codice catena di Alice;
- Usa questo punto segreto per calcolare un segreto condiviso con SHA256;
- Usa questo segreto condiviso per calcolare un nuovo punto segreto sulla curva ellittica;
- Aggiunge questo nuovo punto segreto alla sua chiave pubblica personale;
- Ottiene una nuova chiave pubblica effimera, alla quale Alice invierà il suo primo pagamento;
- Bob calcola la chiave privata associata a questa chiave pubblica effimera aggiungendo la sua chiave privata figlio derivata dal suo codice di pagamento e il segreto condiviso.
![BTC204](assets/it/66/24.webp)
Poiché Alice non può ottenere $b$ (la chiave privata di Bob), lei non è in grado di determinare $k0$ (la chiave privata associata all'indirizzo di ricezione BIP47 di Bob). Schematicamente, possiamo rappresentare il calcolo del segreto condiviso $S$ così:
![BTC204](assets/it/66/19.webp)
Una volta trovato il segreto condiviso con ECDH, Alice e Bob calcolano la chiave pubblica di pagamento BIP47 $K0$, e Bob calcola anche la chiave privata associata $k0$:
![BTC204](assets/it/66/25.webp)
### Rimborsare il Pagamento BIP47
Poiché Bob è a conoscenza del codice di pagamento riutilizzabile di Alice, ha già tutte le informazioni necessarie per inviarle un rimborso. Non avrà bisogno di contattare nuovamente Alice per chiedere informazioni. Dovrà semplicemente notificarla con una transazione di notifica, specialmente affinché lei possa recuperare i suoi indirizzi BIP47 con il suo seed, e poi potrà anche inviarle fino a `2^32` pagamenti.
La funzionalità di rimborso è specifica per BIP47 ed è uno dei suoi vantaggi rispetto ad altri metodi che studieremo nei prossimi capitoli, come i Pagamenti Silenziosi.
Bob può quindi rimborsare Alice nello stesso modo in cui lei gli ha inviato i pagamenti. I ruoli si invertono:
![BTC204](assets/it/66/26.webp)
_Un grande ringraziamento a [Fanis Michalakis](https://x.com/FanisMichalakis) per la sua revisione e preziosi consigli esperti sull'articolo che ha ispirato la scrittura di questo capitolo!_
https://planb.network/tutorials/privacy/on-chain/paynym-bip47-a492a70b-50eb-4f95-a766-bae2c5535093
## Pagamenti Silenziosi
<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>
Il BIP47 è stato criticato per la sua inefficienza sulla blockchain. Come spiegato nel capitolo precedente, richiede una transazione di notifica per ogni nuovo destinatario. Questo vincolo diventa trascurabile se si prevede di stabilire un canale di pagamento duraturo con questo destinatario. Infatti, una singola transazione di notifica apre la strada a un numero quasi infinito di pagamenti BIP47 successivi.
Tuttavia, in determinate situazioni, la transazione di notifica può rappresentare un ostacolo per l'utente. Prendiamo l'esempio di una donazione una tantum a un destinatario: con un indirizzo Bitcoin classico, una singola transazione è sufficiente per effettuare la donazione. Ma con il BIP47, sono necessarie due transazioni: una per la notifica e un'altra per il pagamento effettivo. Quando la domanda di spazio nel blocco è bassa e le commissioni di transazione sono minime, questo passaggio aggiuntivo generalmente non rappresenta un problema. Tuttavia, durante i periodi di congestione, le commissioni di transazione possono diventare esorbitanti per un singolo pagamento, potenzialmente raddoppiando il costo per l'utente rispetto a una transazione Bitcoin standard, il che può essere inaccettabile per l'utente.
Per situazioni in cui l'utente prevede di effettuare solo pochi pagamenti a un identificatore statico, sono state sviluppate altre soluzioni. Tra queste ci sono i Pagamenti Silenziosi, descritti nel [BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki). Questo protocollo consente l'uso di un identificatore statico per ricevere pagamenti senza generare riutilizzo dell'indirizzo e senza richiedere l'uso di transazioni di notifica. Esaminiamo come funziona questo protocollo.
---
_Per comprendere appieno questo capitolo, è essenziale essere familiari con il funzionamento di ECDH (Elliptic Curve Diffie-Hellman) e la derivazione delle chiavi crittografiche in un portafoglio HD. Questi concetti sono stati dettagliati nel capitolo precedente sul BIP47. Non li ripeterò qui. Se non sei ancora familiare con queste nozioni, ti consiglio di consultare il capitolo precedente prima di continuare con questo. Non riprenderò nemmeno i rischi associati al riutilizzo degli indirizzi di ricezione, né l'importanza di avere un identificatore unico per ricevere pagamenti._
---
### Perché non spostare la notifica?
Come discusso nel capitolo sul BIP47, la transazione di notifica svolge principalmente due funzioni:
- Notifica il destinatario;
- Trasmette il codice di pagamento del mittente.
Si potrebbe ingenuamente pensare che questo processo di notifica potrebbe essere effettuato off-chain. In teoria, ciò è completamente fattibile: sarebbe sufficiente per il destinatario indicare un mezzo di comunicazione per ricevere i codici di pagamento BIP47 dai mittenti. Tuttavia, questo approccio presenta due problemi principali:
- Primo, ciò sposterebbe il processo di trasmissione del codice su un altro protocollo di comunicazione. Le questioni relative ai costi e alla privacy dello scambio rimarrebbero, ma sarebbero semplicemente trasferite a questo nuovo protocollo. In termini di privacy, ciò potrebbe anche creare un collegamento tra l'identità di un utente e l'attività sulla blockchain, cosa che cerchiamo di evitare eseguendo la notifica direttamente sulla blockchain. Inoltre, effettuare la notifica fuori dalla blockchain introdurrebbe rischi di censura (come il blocco dei fondi) che non esistono su Bitcoin;
Successivamente, ciò porrebbe un problema di recupero. Con BIP47, il destinatario deve assolutamente conoscere i codici di pagamento dei mittenti per accedere ai fondi. Questo è vero al momento della ricezione, ma anche in caso di recupero dei fondi tramite il seed in caso di perdita del portafoglio. Con le notifiche onchain, questo rischio viene evitato, poiché l'utente può trovare e decifrare le transazioni di notifica semplicemente conoscendo il proprio seed. Tuttavia, se la notifica viene eseguita fuori dalla blockchain, l'utente dovrebbe mantenere un backup dinamico di tutti i codici di pagamento ricevuti, il che è impraticabile per l'utente medio.
Tutti questi vincoli rendono l'uso della notifica onchain indispensabile nel contesto di BIP47. Eppure, i Pagamenti Silenziosi cercano specificamente di evitare questo passaggio di notifica onchain a causa del suo costo. Pertanto, la soluzione adottata non è spostare la notifica, ma eliminarla completamente. Per raggiungere questo obiettivo, deve essere accettato un compromesso: quello della scansione. A differenza di BIP47, dove l'utente sa esattamente dove trovare i propri fondi grazie alle transazioni di notifica, nel contesto dei Pagamenti Silenziosi, l'utente deve esaminare tutte le transazioni Bitcoin esistenti per rilevare eventuali pagamenti che potrebbero essere destinati a loro. Per ridurre questo onere operativo, la ricerca di Pagamenti Silenziosi è limitata solo alle transazioni che probabilmente contengono tali pagamenti, ovvero quelle che includono almeno un output Taproot P2TR. La scansione si concentra esclusivamente anche sulle transazioni dalla data di creazione del portafoglio (non c'è bisogno di scandire transazioni risalenti al 2009 se il portafoglio è stato creato nel 2024).
Pertanto, potete vedere perché BIP47 e Pagamenti Silenziosi, sebbene mirino a un obiettivo simile, comportano compromessi diversi e **quindi si rivolgono effettivamente a casi d'uso distinti**. Per i pagamenti una tantum, come le donazioni occasionali, i Pagamenti Silenziosi sono più appropriati a causa del loro costo inferiore. Al contrario, per le transazioni regolari allo stesso destinatario, come nel caso delle piattaforme di scambio o dei pool di mining, BIP47 potrebbe essere preferito.
Esploriamo insieme il funzionamento tecnico dei Pagamenti Silenziosi per capirne meglio le implicazioni. Per fare ciò, suggerisco di adottare lo stesso approccio del documento esplicativo di BIP352. Scomporremo gradualmente i calcoli da eseguire, elemento per elemento, giustificando ogni nuova aggiunta.
### Alcuni concetti da comprendere
Prima di iniziare, è importante chiarire che i Pagamenti Silenziosi si basano esclusivamente sull'uso di tipi di script P2TR (_Pay to Taproot_). A differenza di BIP47, non è necessario derivare gli indirizzi di ricezione dalle chiavi pubbliche figlie tramite hashing. Infatti, nello standard P2TR, la chiave pubblica modificata viene utilizzata direttamente e apertamente nell'indirizzo. Così, un indirizzo di ricezione Taproot è essenzialmente una chiave pubblica accompagnata da alcuni metadati. Questa chiave pubblica modificata è l'aggregazione di altre due chiavi pubbliche: una che consente la spesa diretta e tradizionale tramite una semplice firma, e l'altra che rappresenta la radice di Merkle del MAST, che autorizza la spesa soggetta alla soddisfazione di una delle condizioni potenzialmente iscritte nell'albero di Merkle.
![BTC204](assets/it/67/01.webp)
La decisione di limitare i Pagamenti Silenziosi esclusivamente a Taproot è motivata da due ragioni principali:
- Primo, facilita significativamente l'implementazione e gli aggiornamenti futuri nel software del portafoglio, poiché è necessario aderire a un solo standard;
- In secondo luogo, questo approccio aiuta a migliorare l'insieme di anonimato degli utenti incoraggiandoli a non disperdersi tra diversi tipi di script, che generano impronte di portafoglio distinte nell'analisi della catena (per maggiori informazioni su questo concetto, vi invito a consultare il capitolo 4 della parte 2).
### Derivazione naive di una chiave pubblica di Pagamenti Silenziosi
Iniziamo con un semplice esempio che ti aiuterà a comprendere il funzionamento di base dei Pagamenti Silenziosi (SP, Silent Payments). Prendiamo Alice e Bob, due utenti Bitcoin. Alice vuole inviare bitcoin a Bob su un nuovo indirizzo di ricezione. Tre obiettivi devono essere raggiunti in questo processo:
- Alice deve essere in grado di generare un nuovo indirizzo;
- Bob deve essere in grado di identificare un pagamento inviato a questo specifico indirizzo;
- Bob deve essere in grado di ottenere la chiave privata associata a questo indirizzo per poter spendere i suoi fondi.
Alice ha un UTXO nel suo portafoglio Bitcoin protetto con la seguente coppia di chiavi:
- $a$: la chiave privata;
- $A$: la chiave pubblica ($A = a \cdot G$)
Bob ha un indirizzo SP che ha pubblicato su internet con:
- $b$: la chiave privata;
- $B$: la chiave pubblica ($B = b \cdot G$)
Recuperando l'indirizzo di Bob, Alice è in grado di calcolare un nuovo indirizzo vuoto che appartiene a Bob usando ECDH. Chiamiamo questo indirizzo $P$:
$$ P = B + \text{hash}(a \cdot B) \cdot G $$
In questa equazione, Alice ha semplicemente calcolato il prodotto scalare della sua chiave privata $a$ e della chiave pubblica di Bob $B$. Ha passato questo risultato attraverso una funzione hash conosciuta da tutti. Il valore di output è poi moltiplicato scalarmente per il punto generatore $G$ della curva ellittica `secp256k1`. Infine, Alice aggiunge il punto ottenuto alla chiave pubblica di Bob $B$. Una volta che Alice ha questo indirizzo $P$, lo usa come output in una transazione, il che significa che invia bitcoin ad esso.
> _Nel contesto dei Pagamenti Silenziosi, la funzione "hash" corrisponde a una funzione hash SHA256 etichettata specificamente con `BIP0352/SharedSecret`, assicurando che gli hash generati siano unici per questo protocollo e non possano essere riutilizzati in altri contesti, fornendo anche una protezione aggiuntiva contro il riutilizzo di nonce nelle firme. Questo standard corrisponde a quello [specificato nel BIP340 per le firme Schnorr](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) su `secp256k1`._
Grazie alle proprietà della curva ellittica su cui si basa ECDH, sappiamo che:
$$ a \cdot B = b \cdot A $$
Bob sarà quindi in grado di calcolare l'indirizzo di ricezione su cui Alice ha inviato i bitcoin. Per fare ciò, monitora tutte le transazioni Bitcoin che soddisfano i criteri dei Pagamenti Silenziosi e applica il seguente calcolo a ciascuna di esse per vedere se il pagamento è indirizzato a lui (_scanning_):
$$ P' = B + \text{hash}(b \cdot A) \cdot G $$
Quando esamina la transazione di Alice, si rende conto che $P'$ è uguale a $P$. Sa quindi che questo pagamento è indirizzato a lui:
$$ P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P $$
Da qui, Bob sarà in grado di calcolare la chiave privata $p$ che consente di spendere l'indirizzo $P$:
$$ p = (b + \text{hash}(b \cdot A)) \bmod n $$
Come puoi vedere, per calcolare questa chiave privata $p$, è necessario avere la chiave privata $b$. Solo Bob ha questa chiave privata $b$. Sarà quindi effettivamente l'unico in grado di spendere i bitcoin inviati al suo indirizzo di Pagamenti Silenziosi.
![BTC204](assets/fr/236.webp)
_Didascalia:_
- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s$: Il segreto comune ECDH
- $P$: La chiave pubblica / indirizzo unico per il pagamento a Bob
Ecco un approccio inizialmente piuttosto ingenuo nell'uso dell'indirizzo statico di Bob, denotato $B$, per derivare un indirizzo unico $P$ per inviare bitcoin. Tuttavia, questo metodo è troppo semplicistico e presenta diversi difetti che necessitano di correzione. Il primo problema è che, in questo schema, Alice non può creare molteplici output per Bob all'interno della stessa transazione.
### Come creare molteplici output?
Nell'esempio della sezione precedente, Alice crea un singolo output che andrà a Bob al suo indirizzo unico $P$. Con lo stesso input selezionato, è impossibile per Alice creare due indirizzi vergini distinti per Bob, poiché il metodo utilizzato porterebbe sempre allo stesso risultato per $P$, quindi allo stesso indirizzo. Tuttavia, ci possono essere molte situazioni in cui Alice desidera dividere il suo pagamento a Bob in diverse piccole somme, creando così molteplici UTXO. È quindi necessario trovare un metodo che permetta di farlo.
Per raggiungere questo obiettivo, modificheremo leggermente il calcolo che Alice esegue per derivare $P$, in modo che possa generare due indirizzi distinti per Bob, ovvero $P_0$ e $P_1$.
Per modificare il calcolo e ottenere 2 indirizzi diversi, è sufficiente aggiungere un intero che modifica il risultato. Così, Alice aggiungerà $0$ nel suo calcolo per ottenere l'indirizzo $P_0$ e $1$ per ottenere l'indirizzo $P_1$. Chiamiamo questo intero $i$:
$$ P_i = B + \text{hash}(a \cdot B \text{ ‖ } i) \cdot G $$
Il processo di calcolo rimane invariato rispetto al metodo precedente, eccetto che questa volta Alice concatenerà $a \cdot B$ con $i$ prima di procedere al hash. È quindi sufficiente cambiare $i$ per avere un nuovo indirizzo appartenente a Bob. Ad esempio:
$$ P_0 = B + \text{hash}(a \cdot B \text{ ‖ } 0) \cdot G $$
$$ P_1 = B + \text{hash}(a \cdot B \text{ ‖ } 1) \cdot G $$
Quando Bob esamina la blockchain per i Pagamenti Silenziosi destinati a lui, inizia utilizzando $i = 0$ per l'indirizzo $P_0$. Se non trova nessun pagamento su $P_0$, conclude che questa transazione non contiene nessun Pagamento Silenzioso per lui e smette di analizzarla. Tuttavia, se $P_0$ è valido e contiene un pagamento per lui, procede con $P_1$ nella stessa transazione per verificare se Alice ha effettuato un secondo pagamento. Se $P_1$ risulta essere invalido, interrompe la sua ricerca per questa transazione; altrimenti, continua a testare valori successivi di $i$.
$$ P_1 = B + \text{hash}(b \cdot A \text{ ‖ } 1) \cdot G $$
Poiché Bob si ferma immediatamente a $i = 0$ se $P_0$ non produce risultati, l'uso di questo intero aggiunge quasi nessun onere operativo aggiuntivo a Bob per la fase di scansione delle transazioni.
Bob può quindi calcolare le chiavi private nello stesso modo:
$$

p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n

$$
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n
$$

_Didascalia:_


- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: Soukromá chiave Boba
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $G$: Generátor elitární křivky `secp256k1`
- $\text{SHA256}$: La funzione di hash SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: první segment ECDH
- $s_1$: Druhý segment condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
- $P_1$: La seconda chiave pubblica / indirizzo unico per il pagamento a Bob

Con questo metodo, iniziamo ad avere un bel protocollo, ma ci sono ancora alcune sfide da superare, in particolare la prevenzione del riutilizzo degli indirizzi.

### Come evitare il riutilizzo degli indirizzi?

Come abbiamo visto nelle sezioni precedenti, Alice utilizza la coppia di chiavi cheeggono il suo UTXO, che spenderà per calcolare il segreto condiviso ECDH con Bob. Questo segreto le permette di derivare l'indirizzo unico $P_0$. Tuttavia, la coppia di chiavi ($a$, $A$) usata da Alice può proteggere più UTXO se ha riutilizzato questo indirizzo diverse volte. Nel caso in cui Alice effettui due pagamenti all'indirizzo statico $B$ di Bob utilizzando due UTXO protetti dalla stessa chiave $A$, ciò comporterebbe un riutilizzo dell'indirizzo per Bob.

> _Il riutilizzo degli indirizzi è una pratica molto negativa per la privacy degli utenti. Per capire perché, vi consiglio di rivedere le prime parti di questa formazione._
Infatti, poiché l'indirizzo unico $P_0$ è derivato da $A$ e $B$, se Alice deriva un secondo indirizzo per un secondo pagamento a $B$, con la stessa chiave $A$, finirà per ottenere lo stesso indirizzo $P_0$. Abychom se vyhnuli tomuto riziku a zabránili riutilizzo degli indirizzi all'interno dei Pagamenti Silenziosi, dobbiamo modificare leggermente i nostri calcoli.

Quello che vogliamo è che ogni UTXO consumato da Alice come input di un pagamento dia un indirizzo unico dal lato di Bob, anche se più UTXO sono protetti dalla stessa coppia di chiavi. È quindi sufficiente aggiungere un riferimento all'UTXO nel calcolo dell'indirizzo unico $P_0$. Questo riferimento sarà semplicemente l'hash dell'UTXO consumato come input:

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$

E questo riferimento di input, Alice lo aggiungerà nel suo calcolo dell'indirizzo unico $P_0$:

Během skenování může Bob také přidat $\text{inputHash}$, protože to, co musí udělat, je zajistit převod pro získání $\text{outpoint}$:

$$ P_0 = B + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0) \cdot G $$

Když najdete platný $P_0$, můžete vypočítat odpovídající soukromý kód $p_0$:

$$
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
$$

```text
_Legenda:_
- $B$: La chiave pubblica / indirizzo statico pubblicato da Bob
- $b$: La chiave privata di Bob
- $A$: La chiave pubblica dell'UTXO di Alice usata come input per la transazione
- $a$: La chiave privata di Alice
- $H$: L'hash dell'UTXO usato come input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hash SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
Al momento, i nostri calcoli presuppongono che Alice utilizzi un singolo input per la sua transazione. Tuttavia, dovrebbe essere in grado di utilizzare più input. Di conseguenza, da parte di Bob, per ogni transazione contenente più input, teoricamente avrebbe bisogno di calcolare l'ECDH per ogni input per determinare se un pagamento è destinato a lui. Questo metodo non è soddisfacente, quindi abbiamo bisogno di trovare una soluzione per ridurre il carico di lavoro!
### Modificare le chiavi pubbliche negli input
Per risolvere questo problema, invece di utilizzare la coppia di chiavi che protegge un input specifico da parte di Alice, useremo la somma di tutte le coppie di chiavi utilizzate negli input della transazione. Questa somma sarà quindi considerata come una nuova coppia di chiavi. Questa tecnica è nota come "tweak".
Per esempio, immagina che la transazione di Alice abbia 3 input, ognuno protetto con una coppia di chiavi diversa:
- $a_0$ protegge l'input #0;
- $a_1$ protegge l'input #1;
- $a_2$ protegge l'input #2.
Seguendo il metodo descritto sopra, Alice dovrebbe scegliere una singola coppia di chiavi tra $a_0$, $a_1$ e $a_2$ per calcolare il segreto ECDH e generare l'indirizzo di pagamento unico $P$ dall'indirizzo statico $B$ di Bob. Tuttavia, questo approccio richiede a Bob di testare ogni possibilità sequenzialmente, partendo da $a_0$, poi $a_1$, e così via, fino all'identificazione di una coppia che genera un indirizzo valido $P$. Questo processo richiede che Bob esegua il calcolo ECDH su tutti gli input di tutte le transazioni, aumentando significativamente il carico di lavoro operativo di scansione.
Per evitare ciò, chiederemo ad Alice di eseguire il suo calcolo di $P$ utilizzando la somma di tutte le chiavi in input. Prendendo il nostro esempio, la chiave privata modificata $a$ sarebbe calcolata come segue:
$$ a = a_0 + a_1 + a_2 $$
Allo stesso modo, Alice e Bob saranno in grado di calcolare la chiave pubblica modificata:
$$ A = A_0 + A_1 + A_2 $$
Grazie a questo metodo, a Bob basta calcolare la somma delle chiavi pubbliche della transazione, poi calcolare il segreto ECDH da $A$ soltanto, il che riduce notevolmente il numero di calcoli da fare per la fase di scansione. Tuttavia, ricorda dalla sezione precedente. Avevamo incluso nel nostro calcolo l'hash $\text{inputHash}$ che viene usato come nonce per prevenire il riutilizzo degli indirizzi:
$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$
Ma se ci sono più input in una transazione, è necessario determinare quale $\text{outpoint}$ viene scelto in questo calcolo. Secondo il BIP352, il criterio di selezione per $\text{outpoint}$ da usare è scegliere il più piccolo lessicograficamente, il che significa selezionare l'UTXO che appare per primo in ordine alfabetico. Questo metodo standardizza l'UTXO da scegliere in ogni transazione. Ad esempio, se questo $\text{outpoint}$ più piccolo lessicograficamente è $\text{outpoint}_L$, il calcolo di $\text{inputHash}$ sarà:
$$ \text{inputHash} = \text{hash}(\text{outpoint}\_L \text{ ‖ } A) $$
I calcoli rimangono quindi identici a quelli presentati nella sezione precedente, eccetto che la chiave privata $a$ e la sua corrispondente chiave pubblica $A$ non rappresentano più una coppia che protegge un singolo input, ma ora rappresentano la modifica di tutte le coppie di chiavi negli input.
### Separare le Chiavi di Spesa e di Scansione
Finora, abbiamo discusso dell'indirizzo statico di Pagamento Silenzioso $B$ come di una chiave pubblica unica. Ricorda, è questa chiave pubblica $B$ che viene usata da Alice per creare il segreto condiviso ECDH, che a sua volta viene usato per calcolare l'indirizzo di pagamento unico $P$. Bob usa questa chiave pubblica $B$ e la corrispondente chiave privata $b$ per la fase di scansione. Ma userà anche la chiave privata $b$ per calcolare la chiave privata $p$ che consente di spendere dall'indirizzo $P$.
Lo svantaggio di questo metodo è che la chiave privata $b$, che viene usata per calcolare tutte le chiavi private per gli indirizzi che ricevono Pagamenti Silenziosi, viene anche usata da Bob per scansionare le transazioni. Questo passaggio richiede che la chiave $b$ sia disponibile su un software di portafoglio connesso a Internet, il che la espone a un rischio maggiore di furto rispetto al mantenerla su un portafoglio freddo. Idealmente, sarebbe vantaggioso poter approfittare dei Pagamenti Silenziosi mantenendo la chiave privata $b$, che controlla l'accesso a tutte le altre chiavi private, al sicuro su un portafoglio hardware. Fortunatamente, il protocollo è stato adattato per permettere esattamente questo.
Per raggiungere questo obiettivo, il BIP352 specifica che il ricevente usa 2 diverse coppie di chiavi:
- $B_{\text{spend}}$: per calcolare le chiavi private degli indirizzi di pagamento unici;
- $B_{\text{scan}}$: per trovare indirizzi di pagamento unici.
In questo modo, Bob può mantenere la chiave privata $b_{\text{spend}}$ su un portafoglio hardware e usare la chiave privata $b_{\text{scan}}$ su software online per trovare i suoi Pagamenti Silenziosi, senza rivelare $b_{\text{spend}}$. Tuttavia, le chiavi pubbliche $B_{\text{scan}}$ e $B_{\text{spend}}$ sono entrambe pubblicamente rivelate, poiché si trovano nell'indirizzo statico di Bob $B$:
Per calcolare un indirizzo di pagamento unico $P_0$ appartenente a Bob, Alice eseguirà il seguente calcolo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot a \cdot B\_{\text{scan}} \text{ ‖ } 0) \cdot G $$
Per trovare i pagamenti indirizzati a lui, Bob eseguirà il seguente calcolo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$
Come puoi vedere, fino a questo momento, Bob non ha avuto bisogno di usare $b_{\text{spend}}$ che si trova sul suo portafoglio hardware. Quando desidera spendere $P_0$, può quindi eseguire il seguente calcolo per trovare la chiave privata $p_0$:
$$ p*0 = (b*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$
_Didascalia:_
- $B_{\text{scan}}$: Chiave pubblica di scansione di Bob (indirizzo statico)
- $b_{\text{scan}}$: Chiave privata di scansione di Bob
- $B_{\text{spend}}$: Chiave pubblica di spesa di Bob (indirizzo statico)
- $b_{\text{spend}}$: Chiave privata di spesa di Bob
- $A$: La somma delle chiavi pubbliche in input (tweak)
- $a$: La chiave privata corrispondente alla chiave pubblica modificata
- $H$: L'hash dell'UTXO più piccolo (lessicograficamente) usato in input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo di pagamento unico per Bob
### Utilizzando indirizzi SP con un'etichetta
Bob ha quindi un indirizzo statico $B$ per i Pagamenti Silenziosi come segue:
$$ B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}} $$
Il problema con questo metodo è che non permette di segregare i diversi pagamenti inviati a questo indirizzo. Ad esempio, se Bob ha 2 clienti diversi per la sua attività e vuole differenziare chiaramente i pagamenti da ciascuno, avrebbe bisogno di 2 indirizzi statici diversi. Una soluzione ingenua, con l'approccio attuale, sarebbe che Bob crei due portafogli separati, ognuno con il proprio indirizzo statico, o addirittura stabilisca due indirizzi statici diversi all'interno dello stesso portafoglio. Tuttavia, questa soluzione richiede la scansione dell'intera blockchain due volte (una per ciascun indirizzo) per rilevare rispettivamente i pagamenti destinati a ciascun indirizzo. Questa doppia scansione aumenta in modo irragionevole l'onere operativo per Bob.
Per risolvere questo problema, BIP352 utilizza un sistema di etichettatura che consente di avere diversi indirizzi statici senza aumentare in modo irragionevole il carico di lavoro per trovare Pagamenti Silenziosi sulla blockchain. Per fare ciò, viene aggiunto un intero $m$ alla chiave pubblica di spesa $B_{\text{spend}}$. Questo intero può assumere il valore di $1$ per il primo indirizzo statico, poi $2$ per il secondo, e così via. Le chiavi di spesa $B_{\text{spend}}$ saranno d'ora in poi chiamate $B_m$ e saranno costruite in questo modo:
$$ B*m = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } m) \cdot G $$
Per esempio, per la prima chiave di spesa con l'etichetta $1$:
$$ B*1 = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } 1) \cdot G $$
L'indirizzo statico pubblicato da Bob consisterà ora di $B_{\text{scan}}$ e $B_m$. Per esempio, il primo indirizzo statico con l'etichetta $1$ sarà:
$$ B = B\_{\text{scan}} \text{ ‖ } B_1 $$
> _Iniziamo solo dall'etichetta 1 perché l'etichetta 0 è riservata per il resto._
Alice, da parte sua, deriverà l'indirizzo di pagamento unico $P$ nello stesso modo di prima, ma utilizzando il nuovo $B_1$ invece di $B_{\text{spend}}$.
$$ P*0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B*{\text{scan}} \text{ ‖ } 0) \cdot G $$
In realtà, Alice potrebbe non sapere nemmeno che Bob ha un indirizzo etichettato, poiché lei semplicemente utilizza la seconda parte dell'indirizzo statico che lui le ha fornito, che in questo caso, è il valore $B_1$ piuttosto che $B_{\text{spend}}$.
Per scansionare i pagamenti, Bob utilizzerà sempre il valore del suo indirizzo statico iniziale con $B_{\text{spend}}$ in questo modo:
$$ P*0 = B*{\text{spend}} + \text{hash}(\text{inputHash} \cdot b\_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$
Poi, semplicemente sottrae il valore che trova per $P_0$ da ogni output uno per uno. Poi controlla se uno dei risultati di queste sottrazioni corrisponde al valore di una delle etichette che usa nel suo portafoglio. Se corrisponde, per esempio, per l'output #4 con l'etichetta $1$, ciò significa che questo output è un Pagamento Silenzioso associato al suo indirizzo statico etichettato $B_1$:
$$ Out*4 - P_0 = \text{hash}(b*{\text{scan}} \text{ ‖ } 1) \cdot G $$
Questo funziona perché:
$$ B*1 = B*{\text{spend}} + \text{hash}(b*{\text{scan}} \text{ ‖ } 1) \cdot G $$
Grazie a questo metodo, Bob può utilizzare una moltitudine di indirizzi statici ($B_1$, $B_2$, $B_3$...), tutti derivati dal suo indirizzo statico base ($B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}}$), al fine di separare correttamente gli usi.
Tuttavia, questa separazione degli indirizzi statici è valida solo da una prospettiva di gestione personale del portafoglio e non consente la separazione delle identità. Poiché tutti hanno lo stesso $B*{\text{scan}}$, è molto facile associare tutti gli indirizzi statici insieme e dedurre che appartengono a una singola entità.
_Didascalia:_
- $B_{\text{scan}}$: chiave pubblica di scansione di Bob (indirizzo statico)
- $b_{\text{scan}}$: chiave privata di scansione di Bob
- $B_{\text{spend}}$: chiave pubblica di spesa di Bob (indirizzo iniziale)
- $B_m$: chiave pubblica di spesa etichettata di Bob (indirizzo statico)
- $b_m$: chiave privata di spesa etichettata di Bob
- $A$: La somma delle chiavi pubbliche in input (tweak)
- $a$: La chiave privata corrispondente alla chiave pubblica modificata
- $H$: L'hash del più piccolo UTXO (lessicograficamente) utilizzato come input
- $G$: Il punto generatore della curva ellittica `secp256k1`
- $\text{SHA256}$: La funzione di hashing SHA256 etichettata con `BIP0352/SharedSecret`
- $s_0$: Il primo segreto condiviso ECDH
- $P_0$: La prima chiave pubblica / indirizzo unico per il pagamento a Bob
- $p_0$: La chiave privata del primo indirizzo di pagamento unico a Bob
- $X$: L'hash della chiave privata di scansione con l'etichetta
### Come Costruire un Indirizzo per Pagamenti Silenziosi?
Per costruire un indirizzo dedicato ai Pagamenti Silenziosi, è necessario prima derivare 2 coppie di chiavi nel proprio portafoglio Bitcoin HD:
- La coppia $b_{\text{scan}}$, $B_{\text{scan}}$ per cercare i pagamenti indirizzati a noi;
- La coppia $b_{\text{spend}}$, $B_{\text{spend}}$ per spendere i bitcoin che abbiamo ricevuto.
Queste coppie sono derivate seguendo questi percorsi (_Bitcoin Mainnet_):
scan: m / 352' / 0' / 0' / 1' / 0
spend: m / 352' / 0' / 0' / 0' / 0
```

```text
Una volta disponibili queste 2 coppie di chiavi, si concatenano semplicemente (una di seguito all'altra) per creare il payload dell'indirizzo statico:
$$ B = B*{\text{scan}} \text{ ‖ } B*{\text{spend}} $$
Se si desidera utilizzare etichette, $B_{\text{spend}}$ viene sostituito con $B_m$:
$$ B = B\_{\text{scan}} \text{ ‖ } B_m $$
Con l'etichetta $m$:
$$ B*m = B*{\text{spend}} + \text{hash}(b\_{\text{scan}} \text{ ‖ } m) \cdot G $$
Una volta disponibile questo payload, si aggiunge la HRP (_Human-Readable Part_) `sp` e la versione `q` (= versione 0). Viene anche aggiunto un checksum, e l'indirizzo è formattato in bech32m.
Ad esempio, ecco il mio indirizzo statico per i Pagamenti Silenziosi:
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```